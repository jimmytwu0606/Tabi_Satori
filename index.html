<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—…æ‚Ÿ Tabi-Satori | V4 æ¶æ§‹é‡æ§‹ç‰ˆ</title>
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>

<style>
    /* =========================================
       0. ç‰©ç†é‡ç½® (Physical Reset) - æ ¸å¿ƒä¿®å¾©
       ========================================= */
    /* å¼·åˆ¶æ‰€æœ‰å…ƒç´ åŒ…å«é‚Šæ¡†èˆ‡å…§è·ï¼Œé˜²æ­¢å°ºå¯¸è¨ˆç®—èª¤å·®å°è‡´ç¸«éš™ */
    *, *::before, *::after {
        box-sizing: border-box;
    }

    :root {
        --header-height: 80px;      /* ç‹€æ…‹åˆ—é«˜åº¦ */
        --adventure-height: 120px;  /* å†’éšªå ´æ™¯é«˜åº¦ */
        
        /* ç¸½æ§åˆ¶å°é«˜åº¦ = 80 + 120 = 200px */

        /* ç‰©ç†å±¤ç´š (Z-Index) */
        --z-content: 1;
        --z-adventure: 900;
        --z-header: 1000;
        --z-popup: 2000;
        --z-battle: 5000;
        --z-overlay: 6000;

        /* å“ç‰Œè‰² */
        --nhk-green: #00a0e9;
        --nhk-light-green: #e6f7ff;
        --accent-orange: #f39800;
        --p-color: #f1c40f;
    }

    body {
        margin: 0;
        padding: 0;
        /* ğŸ”¥ ä¿®å¾©ï¼šç§»é™¤ padding-topï¼Œé¿å…æ¨æ“  fixed å…ƒç´  */
        padding-top: 0 !important; 
        background-color: #f4f4f4;
        font-family: "Helvetica Neue", Arial, "Hiragino Sans", "Meiryo", sans-serif;
        overflow-x: hidden; 
    }

    /* è®“æ–‡å­—èˆ‡å‡åæ’ç‰ˆæ­£ç¢º */
    ruby { ruby-position: over; ruby-align: center; }
    rt { font-size: 0.55em; color: #666; user-select: none; }
    .hide-furigana rt { display: none !important; }
    .article-body { line-height: 2.8 !important; font-size: 22px; margin-bottom: 40px; }

    /* =========================================
       1. ç¬¬ä¸€å±¤ï¼šå›ºå®šé ‚éƒ¨ (Sticky Header)
       ========================================= */
    #game-sticky-header {
        position: fixed; /* ç‰©ç†é–å®šï¼šæ°¸é ç½®é ‚ */
        top: 0;
        left: 0;
        width: 100%;
        height: var(--header-height); /* 80px */
        background: #2c3e50;
        color: white;
        z-index: var(--z-header);
        box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        display: flex;
        align-items: center;
        padding: 0 15px;
    }

    .status-bar-inner {
        width: 100%;
        max-width: 1200px;
        margin: 0 auto;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    /* =========================================
       2. ç¬¬äºŒå±¤ï¼šå†’éšªå ´æ™¯ (Sticky Adventure)
       ========================================= */
    #adventure-screen {
        position: fixed; /* ğŸ”¥ ä¿®å¾©ï¼šæ”¹ç‚º fixedï¼Œå¯¦ç¾å‡çµ */
        top: var(--header-height); /* ğŸ”¥ ä¿®å¾©ï¼šç·Šè²¼ Header (80px) ä¸‹æ–¹ï¼Œç„¡ç¸«éš™ */
        left: 0;
        width: 100%;
        height: var(--adventure-height); /* 120px */
        
        /* èƒŒæ™¯è¨­å®š */
        background: linear-gradient(to bottom, #87ceeb 0%, #e0f6ff 100%);
        border-bottom: 4px solid #444;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        
        z-index: var(--z-adventure); 
        overflow: hidden; 
        transition: background 0.5s ease;
    }

    /* å‹‡è€…èˆ‡æ€ªç‰©å®šä½ */
    #hero-sprite {
        position: absolute;
        bottom: 12px;
        left: 10%;
        font-size: 40px;
        transition: left 0.5s, transform 0.2s;
        z-index: 10;
    }
    #enemy-sprite {
        position: absolute;
        bottom: 12px;
        right: -80px;
        font-size: 26px;
        transition: 0.5s;
        z-index: 5;
    }

    /* åœ°é¢æ»¾å‹•å‹•ç•« */
    .ground-scroll {
        position: absolute;
        bottom: 0; left: 0; width: 200%; height: 12px;
        background: #7cfc00; border-top: 2px solid #55cc00;
        z-index: 1; animation: scrollGround 2s linear infinite;
    }
    @keyframes scrollGround { from { transform: translateX(0); } to { transform: translateX(-50%); } }

    /* =========================================
       3. å®¶åœ’ç³»çµ± (Home UI)
       ========================================= */
    #home-interactions {
        position: absolute;
        bottom: 0; left: 0; width: 100%; height: 100%;
        display: flex; /* Flexbox æ’åˆ— */
        justify-content: space-evenly;
        align-items: flex-end; 
        padding-bottom: 15px;
        pointer-events: none;
        z-index: 20;
    }

    .home-touch-zone {
        pointer-events: auto;
        text-align: center;
        cursor: pointer;
        transition: transform 0.2s;
        width: 60px;
        display: flex;
        flex-direction: column;
        align-items: center;
    }
    .home-touch-zone:hover { transform: scale(1.1); }
    
    .home-icon { font-size: 28px; margin-bottom: 5px; }
    .home-label { 
        font-size: 10px; background: rgba(0,0,0,0.6); color: #fff; 
        padding: 2px 6px; border-radius: 10px; white-space: nowrap;
    }

    /* =========================================
       4. ä¸»å…§å®¹å€ (Main Content) - æ²å‹•å±¤
       ========================================= */
    .main-wrapper {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 20px;
        display: grid;
        grid-template-columns: 1fr 300px;
        gap: 30px;
        
        /* ğŸ”¥ æ ¸å¿ƒä¿®å¾©ï¼šå‘ä¸‹æ¨ç§»ï¼Œéœ²å‡ºæ–‡ç«  */
        /* 80px (Header) + 120px (Adventure) + 20px (é–“è·) = 220px */
        margin-top: 220px !important; 
        
        position: relative;
        z-index: var(--z-content); /* å±¤ç´šæœ€ä½ï¼Œæœƒæ»‘å…¥ Header ä¸‹æ–¹ */
    }

    .content-card { background: #fff; padding: 40px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); min-height: 500px; }
    .article-title { font-size: 28px; font-weight: bold; border-bottom: 1px solid #eee; padding-bottom: 20px; margin-bottom: 30px; }

    /* å´é‚Šæ¬„ */
    .side-module { background: #fff; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 20px; overflow: hidden; }
    .side-header { background: var(--nhk-light-green); padding: 10px 15px; font-weight: bold; display: flex; justify-content: space-between; }
    .side-content { padding: 15px; }

    /* =========================================
       5. å¸¸ç”¨å…ƒä»¶ (Buttons & Cards)
       ========================================= */
    .game-btn, .action-btn, .btn-nhk { cursor: pointer; border-radius: 4px; border: 1px solid #ddd; transition: 0.2s; }
    .game-btn { background: #34495e; color: white; border: none; padding: 4px 10px; font-size: 12px; }
    .game-btn:hover { background: #456789; transform: translateY(-2px); }
    .action-btn { width: 100%; padding: 12px; background: var(--nhk-green); color: white; border: none; font-weight: bold; }
    .btn-nhk { padding: 8px 15px; background: #fff; color: var(--nhk-green); border-color: var(--nhk-green); font-weight: bold; }
    
    /* ç¿»ç‰Œå¡ç‰‡ */
    .flip-card { background-color: transparent; width: 100%; height: 150px; perspective: 1000px; }
    .flip-card-inner { position: relative; width: 100%; height: 100%; text-align: center; transition: transform 0.6s; transform-style: preserve-3d; cursor: pointer; box-shadow: 0 4px 8px rgba(0,0,0,0.1); border-radius: 10px; }
    .flip-card-inner.flipped { transform: rotateY(180deg); }
    .flip-card-front, .flip-card-back { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 15px; border-radius: 10px; border: 1px solid #ddd; background-color: #fff; }
    .flip-card-back { background-color: var(--nhk-green); color: white; transform: rotateY(180deg); }

/* =========================================
           6. å½ˆçª—èˆ‡ä»‹é¢ (Popups & UI) - [æ›´æ–°ç‰ˆ]
           ========================================= */
        .game-popup {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 90%; max-width: 480px; max-height: 80vh;
            
            /* ğŸ”¥ èƒŒæ™¯èˆ‡æ–‡å­—é¡è‰²ä¿®æ­£ */
            background: rgba(20, 24, 30, 0.98); /* æ·±è‰²èƒŒæ™¯ */
            color: #eee; /* å¼·åˆ¶æ·ºè‰²å­— */
            
            border: 1px solid #444; border-top: 3px solid #f1c40f;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.8);
            z-index: 2000;
            display: none; flex-direction: column;
            backdrop-filter: blur(10px);
            animation: popupFadeIn 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes popupFadeIn { from { opacity: 0; transform: translate(-50%, -45%) scale(0.95); } to { opacity: 1; transform: translate(-50%, -50%) scale(1); } }

        /* Header ä¿®æ­£ */
        .popup-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.15);
            background: rgba(255, 255, 255, 0.05);
        }
        .popup-header h3 { margin: 0; color: #f1c40f; font-size: 16px; letter-spacing: 1px; }
        .popup-header button { background: none; border: none; color: #888; font-size: 20px; cursor: pointer; }
        .popup-header button:hover { color: #fff; }

        /* å…§å®¹æ²å‹•å€ */
        .popup-content-scroll { flex: 1; overflow-y: auto; padding: 15px; }
        .popup-content-scroll::-webkit-scrollbar { width: 6px; }
        .popup-content-scroll::-webkit-scrollbar-track { background: rgba(0,0,0,0.3); }
        .popup-content-scroll::-webkit-scrollbar-thumb { background: #555; border-radius: 3px; }

        /* --- å…§éƒ¨å…ƒä»¶æ¨£å¼ (å¼·åˆ¶ç™½å­—) --- */
        
        /* 1. åˆ†é¡æ¨™é¡Œ */
        .inventory-section { margin-bottom: 20px; }
        .section-title {
            font-size: 12px; color: #f1c40f; /* é‡‘è‰²æ¨™é¡Œ */
            border-bottom: 1px solid #444;
            padding-bottom: 5px; margin-bottom: 10px;
            font-weight: bold; letter-spacing: 1px;
        }

        /* 2. ç‰©å“å¡ç‰‡ (èƒŒåŒ…/åœ–é‘‘) */
        .item-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 8px; }
        
        .inv-item-card, .collect-item {
            background: rgba(255, 255, 255, 0.08); /* ç¨å¾®äº®ä¸€é»çš„èƒŒæ™¯ */
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 8px; padding: 10px;
            text-align: center; position: relative;
            color: #fff !important; /* ğŸ”¥ å¼·åˆ¶å…§å®¹ç™½å­— */
            transition: 0.2s;
        }
        .inv-item-card:hover, .collect-item:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: #aaa; transform: translateY(-2px);
        }
        /* å¼·åˆ¶å…§éƒ¨ div æ–‡å­—é¡è‰² */
        .inv-item-card div, .collect-item div { color: #eee !important; }

        .item-count-badge { position: absolute; top: -5px; right: -5px; background: #e74c3c; color: #fff !important; font-size: 10px; padding: 1px 6px; border-radius: 10px; }
        
        /* åœ–é‘‘æœªè§£é– */
        .collect-item { filter: grayscale(1); opacity: 0.5; }
        .collect-item.unlocked { filter: grayscale(0); opacity: 1; border-color: #f1c40f; background: rgba(241, 196, 15, 0.1); }

        /* 3. å‚³é€é–€å¡ç‰‡ (Map) */
        .portal-card {
            display: flex; align-items: center;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.15);
            padding: 12px 15px; margin-bottom: 8px;
            border-radius: 8px; cursor: pointer; transition: 0.2s;
        }
        .portal-card:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--p-color, #ccc); transform: translateX(5px);
        }
        .portal-icon { font-size: 24px; margin-right: 15px; }
        .portal-title { font-size: 14px; font-weight: bold; color: #fff !important; } /* ç™½æ¨™é¡Œ */
        .portal-desc { font-size: 10px; color: #aaa !important; margin-top: 2px; } /* ç°æè¿° */
        .portal-tag { font-size: 9px; padding: 2px 6px; border-radius: 4px; border: 1px solid #555; color: #ccc; }

/* =========================================
   ğŸ”® éŠé‡‘çˆä»‹é¢å„ªåŒ– (Alchemy UI Enhanced)
   ========================================= */

/* 1. ç´ æç¶²æ ¼å®¹å™¨ */
.alchemy-grid {
    display: grid;
    /* è‡ªå‹•å¡«æ»¿ï¼Œæœ€å°å¯¬åº¦ 80pxï¼Œç¢ºä¿æ‰‹æ©Ÿç‰ˆä¹Ÿä¸æœƒæ“ çˆ† */
    grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
    gap: 10px;
    padding: 10px;
    max-height: 250px;
    overflow-y: auto;
    /* ç¾åŒ–å…§éƒ¨æ²è»¸ */
    scrollbar-width: thin;
}
.alchemy-grid::-webkit-scrollbar { width: 4px; }
.alchemy-grid::-webkit-scrollbar-thumb { background: #555; border-radius: 2px; }

/* 2. ç´ æå¡ç‰‡ (æœªé¸ä¸­) */
.alchemy-item-card {
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    padding: 10px 5px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s ease;
    position: relative;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}

/* æ‡¸åœæ•ˆæœ */
.alchemy-item-card:hover {
    background: rgba(255, 255, 255, 0.15);
    border-color: #f1c40f;
    transform: translateY(-2px);
    box-shadow: 0 4px 10px rgba(0,0,0,0.3);
}

/* é»æ“Šç¬é–“ */
.alchemy-item-card:active {
    transform: scale(0.95);
}

/* å¡ç‰‡å…§å®¹ */
.al-icon { font-size: 24px; margin-bottom: 5px; }
.al-name { font-size: 10px; color: #ccc; line-height: 1.2; word-break: break-all; }

/* 3. ç©ºç‹€æ…‹æç¤º */
.alchemy-empty {
    grid-column: 1 / -1; /* è·¨è¶Šæ‰€æœ‰æ¬„ä½ */
    text-align: center;
    color: #666;
    padding: 20px;
    font-size: 12px;
    border: 1px dashed #444;
    border-radius: 8px;
}

        /* 5. æ—¥èªŒ (Log) */
        .log-entry { padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.1); color: #ddd; font-family: monospace; font-size: 12px; }
        .log-time { color: #888; margin-right: 8px; }
    
    /* =========================================
       7. æˆ°é¬¥å ´æ™¯èˆ‡ç‰¹æ•ˆ (Battle & VFX)
       ========================================= */
    #battle-scene {
        position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
        background: rgba(0,0,0,0.95);
        z-index: var(--z-battle);
        display: none; flex-direction: column; align-items: center; justify-content: center;
        color: white;
    }
    
    .battle-shake { animation: dqShake 0.3s; }
    @keyframes dqShake { 0%, 100% { transform: translate(0,0); } 25% { transform: translate(5px, 5px); } 50% { transform: translate(-5px, -5px); } 75% { transform: translate(5px, -5px); } }

    #victory-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 9999; color: white; display: none; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
    .phantom-victory-glow { box-shadow: 0 0 30px rgba(155, 89, 182, 0.8); border-color: #9b59b6; }
    .legendary-glow { animation: legendGlow 2s infinite; text-shadow: 0 0 10px gold; }
    @keyframes legendGlow { from { transform: scale(1); opacity: 0.8; } to { transform: scale(1.2); opacity: 1; } }

    .danger-vignette { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: var(--z-overlay); box-shadow: inset 0 0 100px rgba(255, 0, 0, 0); transition: box-shadow 0.5s ease; }
    .danger-active { animation: dangerPulse 1.5s infinite alternate; }
    @keyframes dangerPulse { 0% { box-shadow: inset 0 0 50px rgba(255, 0, 0, 0.2); } 100% { box-shadow: inset 0 0 150px rgba(255, 0, 0, 0.7); } }

    .flame-effect { width: 30px; height: 30px; background: radial-gradient(circle, #ff9d00 0%, transparent 70%); filter: blur(2px); position: absolute; bottom: 0; opacity: 0.8; }
    .save-spinner { position: absolute; bottom: -5px; right: -5px; font-size: 10px; animation: spin 1s infinite linear; display: none; }
    .save-active { display: block; }
    @keyframes spin { 100% { transform: rotate(360deg); } }
    
    .walking { animation: heroWalk 0.4s infinite alternate ease-in-out; }
    @keyframes heroWalk { from { bottom: 5px; } to { bottom: 12px; } }

/* =========================================
       8. ç‰¹æ•ˆå¾©åˆ» (VFX Restoration)
       ========================================= */
       
    /* ğŸ”¥ ç«ç„°ç‰¹æ•ˆ (é è¨­æ¨¡ç³Šå…‰æšˆ) */
    .flame-effect {
        position: absolute; 
        bottom: -5px; 
        width: 40px; 
        height: 40px;
        border-radius: 50%; 
        filter: blur(4px); 
        opacity: 0.6;
        z-index: 1;
        transition: 0.3s;
    }
    /* ä¸åŒé€£å‹éšæ®µçš„ç«å…‰ */
    .flame-low { background: radial-gradient(circle, #ff9d00 20%, transparent 70%); }
    .flame-mid { background: radial-gradient(circle, #ff4500 30%, transparent 70%); animation: pulse 1s infinite; }
    .flame-high { background: radial-gradient(circle, #00d4ff 40%, transparent 70%); animation: pulse 0.5s infinite; filter: hue-rotate(0deg) brightness(1.5); }

    @keyframes pulse {
        0% { transform: scale(1); opacity: 0.6; }
        50% { transform: scale(1.2); opacity: 0.9; }
        100% { transform: scale(1); opacity: 0.6; }
    }

    /* ğŸ’¾ å­˜æª”æŒ‡ç¤ºç‡ˆ (ä¿®æ­£ï¼šå¹³æ™‚éš±è—ï¼Œè§¸ç™¼æ™‚æ‰é–ƒçˆ) */
    .save-spinner {
        position: absolute;
        bottom: -5px;
        right: -5px;
        background: #27ae60;
        color: white;
        font-size: 10px;
        width: 18px;
        height: 18px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 1px solid white;
        
        /* é—œéµï¼šé è¨­é€æ˜åº¦ç‚º 0ï¼Œé˜²æ­¢ä¸€ç›´é¡¯ç¤º */
        opacity: 0; 
        transition: opacity 0.3s;
        z-index: 100;
        pointer-events: none;
    }

    /* åªæœ‰åŠ ä¸Šé€™å€‹ class æ™‚æ‰åŸ·è¡Œèˆ‡é¡¯ç¤º */
    .save-active {
        animation: savePulse 1.5s ease-out;
    }

    @keyframes savePulse {
        0% { opacity: 0; transform: scale(0.5); }
        20% { opacity: 1; transform: scale(1.2); }
        80% { opacity: 1; transform: scale(1); }
        100% { opacity: 0; transform: scale(0.8); }
    }

/* =========================================
   ğŸªŸ çµ±ä¸€è¦–çª—ç³»çµ± (Unified Popup System)
   ========================================= */

/* 1. è¦–çª—å®¹å™¨ï¼šæš—é»‘ç»ç’ƒè³ªæ„Ÿ */
.game-popup {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 90%;
    max-width: 480px;
    max-height: 80vh; /* é™åˆ¶é«˜åº¦ï¼Œå…§éƒ¨æ²å‹• */
    
    background: rgba(20, 24, 30, 0.95); /* æ·±è—é»‘è‰² */
    border: 1px solid #444;
    border-top: 3px solid #f1c40f; /* é‡‘è‰²é ‚é‚Šï¼Œå¼·èª¿è³ªæ„Ÿ */
    border-radius: 12px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8), 0 0 0 1px rgba(255, 255, 255, 0.1);
    
    z-index: 2000;
    display: none; /* é è¨­éš±è— */
    flex-direction: column; /* è®“ Header/Body/Footer å‚ç›´æ’åˆ— */
    backdrop-filter: blur(10px); /* èƒŒæ™¯æ¨¡ç³Š */
    color: #eee;
    font-family: 'Helvetica Neue', Arial, sans-serif;
    animation: popupFadeIn 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

@keyframes popupFadeIn {
    from { opacity: 0; transform: translate(-50%, -45%) scale(0.95); }
    to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
}

/* 2. è¦–çª—æ¨™é¡Œåˆ— */
.popup-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px 20px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    background: rgba(255, 255, 255, 0.02);
}

.popup-header h3 {
    margin: 0;
    font-size: 16px;
    color: #f1c40f;
    letter-spacing: 1px;
    text-transform: uppercase;
    display: flex;
    align-items: center;
    gap: 8px;
}

.popup-header button {
    background: none;
    border: none;
    color: #888;
    font-size: 20px;
    cursor: pointer;
    transition: 0.2s;
    line-height: 1;
}

.popup-header button:hover {
    color: #fff;
    transform: rotate(90deg);
}

/* 3. è¦–çª—å…§å®¹æ²å‹•å€ (Scroll Area) */
.popup-content-scroll {
    flex: 1; /* è‡ªå‹•å¡«æ»¿å‰©é¤˜é«˜åº¦ */
    overflow-y: auto;
    padding: 15px;
}

/* ç¾åŒ–æ²è»¸ */
.popup-content-scroll::-webkit-scrollbar { width: 6px; }
.popup-content-scroll::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); }
.popup-content-scroll::-webkit-scrollbar-thumb { background: #444; border-radius: 3px; }
.popup-content-scroll::-webkit-scrollbar-thumb:hover { background: #666; }


/* =========================================
   ğŸ“¦ èƒŒåŒ…èˆ‡åœ–é‘‘å°ˆç”¨æ¨£å¼ (Grid System)
   ========================================= */
.inventory-section { margin-bottom: 20px; }
.section-title {
    font-size: 12px;
    color: #aaa;
    border-bottom: 1px solid #333;
    padding-bottom: 5px;
    margin-bottom: 10px;
    font-weight: bold;
}

.item-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
    gap: 8px;
}

.inv-item-card, .collect-item {
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    padding: 10px;
    text-align: center;
    transition: 0.2s;
    position: relative;
}

.inv-item-card:hover, .collect-item:hover {
    background: rgba(255, 255, 255, 0.1);
    transform: translateY(-2px);
    border-color: #aaa;
}

.item-count-badge {
    position: absolute; top: -5px; right: -5px;
    background: #e74c3c; color: white;
    font-size: 10px; padding: 1px 5px; border-radius: 10px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.3);
}

/* åœ–é‘‘æœªè§£é–ç‹€æ…‹ */
.collect-item { filter: grayscale(1); opacity: 0.4; }
.collect-item.unlocked { filter: grayscale(0); opacity: 1; border-color: #f1c40f; background: rgba(241, 196, 15, 0.05); }


/* =========================================
   ğŸ”® éŠé‡‘çˆå°ˆç”¨æ¨£å¼
   ========================================= */
.alchemy-slot-container {
    display: flex;
    justify-content: space-evenly;
    background: rgba(0, 0, 0, 0.3);
    padding: 20px;
    border-radius: 10px;
    margin-bottom: 15px;
    border: 1px dashed #555;
}

.alchemy-slot {
    width: 60px; height: 60px;
    background: rgba(255, 255, 255, 0.05);
    border: 2px solid #444;
    border-radius: 8px;
    display: flex; align-items: center; justify-content: center;
    font-size: 24px; cursor: pointer;
    transition: 0.2s;
}
.alchemy-slot:hover { border-color: #aaa; background: rgba(255,255,255,0.1); }
.alchemy-slot.filled { border-color: #f1c40f; color: #f1c40f; background: rgba(241, 196, 15, 0.1); }

.mix-btn {
    width: 100%; padding: 12px;
    background: linear-gradient(45deg, #8e44ad, #9b59b6);
    border: none; color: white; border-radius: 6px;
    font-weight: bold; cursor: pointer;
    box-shadow: 0 4px 15px rgba(142, 68, 173, 0.4);
    opacity: 0.5; pointer-events: none; transition: 0.3s;
}
.mix-btn.active { opacity: 1; pointer-events: auto; }
.mix-btn:hover { transform: scale(1.02); filter: brightness(1.2); }


/* =========================================
   ğŸ—ºï¸ åœ°åœ–æŒ‰éˆ•æ¨£å¼ (Portal Cards)
   ========================================= */
.portal-card {
    display: flex; align-items: center;
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid rgba(255, 255, 255, 0.1);
    padding: 12px 15px;
    margin-bottom: 8px;
    border-radius: 8px;
    cursor: pointer;
    transition: 0.2s;
    text-align: left;
}

.portal-card:hover {
    background: rgba(255, 255, 255, 0.08);
    border-color: var(--p-color, #ccc);
    transform: translateX(5px);
}

.portal-icon { font-size: 24px; margin-right: 15px; width: 30px; text-align: center; }
.portal-info { flex: 1; }
.portal-title { font-size: 14px; font-weight: bold; color: #eee; }
.portal-desc { font-size: 10px; color: #888; margin-top: 2px; }
.portal-tag { 
    font-size: 9px; padding: 2px 6px; border-radius: 4px; 
    border: 1px solid #444; color: #666; 
}


/* =========================================
   ğŸ“œ æ—¥èªŒæ¨£å¼ (Log Terminal)
   ========================================= */
.log-entry {
    font-family: 'Consolas', monospace;
    font-size: 12px;
    padding: 8px 0;
    border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    color: #ccc;
    line-height: 1.5;
}
.log-entry:last-child { border-bottom: none; }
.log-time { color: #555; margin-right: 8px; }
.log-highlight { color: #f1c40f; font-weight: bold; }



/* =========================================
   ğŸ”® éŠé‡‘ä»‹é¢å¼·åˆ¶ä¿®å¾© (Alchemy Grid Fix)
   ========================================= */

/* 1. å¼·åˆ¶ç¶²æ ¼å®¹å™¨è¨­å®š */
.alchemy-grid {
    display: grid !important;
    /* æ ¸å¿ƒï¼šè¨­å®šæœ€å°å¯¬åº¦ 80pxï¼Œè‡ªå‹•å¡«æ»¿ä¸¦æ›è¡Œ */
    grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)) !important;
    gap: 10px !important;
    padding: 10px;
    max-height: 250px;
    overflow-y: auto;
}

/* 2. éŠé‡‘ç´ æå¡ç‰‡ (ä»¿èƒŒåŒ…é¢¨æ ¼) */
.alchemy-item-card {
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.15);
    border-radius: 8px;
    padding: 10px 5px;
    
    /* å¼·åˆ¶ Flex å‚ç›´ç½®ä¸­ */
    display: flex !important;
    flex-direction: column !important;
    align-items: center !important;
    justify-content: center !important;
    
    text-align: center;
    cursor: pointer;
    transition: all 0.2s ease;
    position: relative;
    min-height: 90px; /* å›ºå®šé«˜åº¦ï¼Œç¢ºä¿æ•´é½Š */
    box-sizing: border-box;
}

/* æ‡¸åœæ•ˆæœ */
.alchemy-item-card:hover {
    background: rgba(255, 255, 255, 0.15);
    border-color: #f1c40f;
    transform: translateY(-2px);
    box-shadow: 0 4px 10px rgba(0,0,0,0.5);
}

/* å…§å®¹æ¨£å¼å¾®èª¿ */
.al-icon { 
    font-size: 28px; 
    margin-bottom: 6px; 
}
.al-name { 
    font-size: 11px; 
    color: #eee !important; /* å¼·åˆ¶ç™½å­— */
    line-height: 1.2; 
    word-break: break-all;
}

/* æ•¸é‡æ¨™ç±¤ */
.al-count-badge {
    position: absolute;
    top: -6px;
    right: -6px;
    background: #e74c3c;
    color: white !important;
    font-size: 10px;
    font-weight: bold;
    padding: 2px 6px;
    border-radius: 10px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.5);
    z-index: 5;
}

/* åŠ è™Ÿå°æ¨™ç¤º */
.alchemy-item-card .plus-sign {
    position: absolute; 
    top: 4px; 
    left: 4px; 
    color: #2ecc71; 
    font-size: 10px; 
    opacity: 0.8;
}


/* =========================================
   âš’ï¸ éŠé‡‘æˆ¿æ“´å»ºï¼šç²¾ç…‰ç³»çµ± (Refining System)
   ========================================= */

/* 1. é ‚éƒ¨åˆ†é åˆ‡æ›å™¨ */
.alchemy-tabs {
    display: flex;
    margin-bottom: 15px;
    border-bottom: 1px solid rgba(255,255,255,0.1);
}
.al-tab-btn {
    flex: 1;
    background: none;
    border: none;
    color: #666;
    padding: 10px;
    cursor: pointer;
    font-weight: bold;
    font-size: 14px;
    transition: 0.3s;
    border-bottom: 2px solid transparent;
}
.al-tab-btn.active {
    color: #f1c40f;
    border-bottom: 2px solid #f1c40f;
    background: rgba(241, 196, 15, 0.05);
}

/* 2. ç²¾ç…‰ä¸»æ“ä½œå° */
.refine-workbench {
    background: rgba(0, 0, 0, 0.3);
    padding: 20px;
    border-radius: 10px;
    border: 1px dashed #555;
    text-align: center;
    position: relative;
    min-height: 180px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}

/* è£å‚™æ§½èˆ‡ç²¾ç…‰çŸ³æ§½ */
.refine-slot-group {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 15px;
}
.refine-slot {
    width: 70px; height: 70px;
    background: rgba(255,255,255,0.05);
    border: 2px solid #444;
    border-radius: 12px;
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    cursor: pointer;
    position: relative;
    transition: 0.3s;
}
.refine-slot.filled { border-color: #f1c40f; background: rgba(241,196,15,0.1); }
.refine-slot.material { border-color: #3498db; }
.refine-slot.material.filled { background: rgba(52, 152, 219, 0.1); }

/* æˆåŠŸç‡é è¦½ */
.refine-info {
    font-size: 12px;
    color: #aaa;
    width: 100%;
    margin-bottom: 10px;
}
.rate-bar-bg { width: 100%; height: 6px; background: #333; border-radius: 3px; overflow: hidden; margin: 5px 0; }
.rate-bar-fill { height: 100%; width: 0%; transition: width 0.5s; }

/* è£å‚™ç­‰ç´šæ¨™ç±¤ */
.refine-lv-badge {
    position: absolute; top: -8px; right: -8px;
    background: #e74c3c; color: white; font-size: 10px;
    padding: 2px 6px; border-radius: 10px; font-weight: bold;
    box-shadow: 0 2px 5px rgba(0,0,0,0.5);
}

/* éµç §å‹•ç•« */
@keyframes hammerStrike {
    0% { transform: rotate(0deg); }
    30% { transform: rotate(-45deg); }
    50% { transform: rotate(0deg) scale(0.9); }
    100% { transform: rotate(0deg) scale(1); }
}
.hammer-anim { animation: hammerStrike 0.3s ease-in-out; }

/* =========================================
   âš”ï¸ è£å‚™ç³»çµ±æ¨£å¼ (Paper Doll UI - Final Fix)
   ========================================= */

/* 1. æ•¸å€¼æ¦‚è¦½ */
.equip-stats-preview {
    display: flex; justify-content: space-around;
    background: rgba(255, 255, 255, 0.05);
    padding: 10px; margin-bottom: 20px; border-radius: 8px;
    border: 1px solid #444; font-family: monospace;
    color: #f1c40f; font-weight: bold;
    font-size: 14px;
}

/* 2. ç´™å¨ƒå¨ƒä½ˆå±€ (Grid) */
.paper-doll-grid {
    display: flex; justify-content: center; gap: 15px;
    margin-bottom: 20px; position: relative;
    padding-top: 10px;
}
.doll-col { 
    display: flex; flex-direction: column; gap: 10px; 
    align-items: center; justify-content: center; 
}

/* å·¦å³å…©æ¬„ç¨å¾®ä¸‹æ²ˆï¼Œå‘ˆç¾å±±å½¢ä½ˆå±€ */
.side-col { margin-top: 25px; } 

/* 3. æ ¼å­åŒ…è£å™¨ (ç¢ºä¿æ¨™ç±¤èˆ‡æ ¼å­å°é½Š) */
.slot-wrapper {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 2px;
}

/* ğŸ”¥ æš—é‡‘è‰²æ¨™ç±¤ (å°æ‡‰ HTML çµæ§‹) */
.slot-label {
    color: #c5a059; /* æš—é‡‘è‰² */
    font-size: 10px;
    font-weight: bold;
    text-transform: uppercase;
    letter-spacing: 1px;
    text-shadow: 0 1px 2px rgba(0,0,0,0.8);
}

/* 4. è£å‚™æ§½æœ¬é«” */
.equip-slot {
    width: 60px; height: 60px;
    background: rgba(0, 0, 0, 0.5);
    border: 2px solid #444;
    border-radius: 8px;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    cursor: pointer; transition: 0.2s;
    position: relative;
    color: #666;
}
.equip-slot:hover { border-color: #f1c40f; box-shadow: 0 0 10px rgba(241, 196, 15, 0.3); }
.equip-slot.equipped { border-color: #f1c40f; background: rgba(241, 196, 15, 0.05); color: #fff; }

/* 5. è£å‚™åœ–ç¤ºèˆ‡åç¨± */
.slot-icon { font-size: 26px; margin-bottom: 0px; filter: drop-shadow(0 2px 2px rgba(0,0,0,0.5)); }
.slot-name { font-size: 9px; text-align: center; line-height: 1.1; overflow: hidden; width: 100%; white-space: nowrap; text-overflow: ellipsis; padding: 0 2px; color: #ddd; }

/* 6. ç¬¦æ–‡å€ */
.rune-container { display: flex; justify-content: center; gap: 10px; margin-top: 10px; }
.equip-slot.rune { width: 45px; height: 45px; border-radius: 50%; border-color: #9b59b6; }
.equip-slot.rune.equipped { background: rgba(155, 89, 182, 0.2); }
.equip-slot.rune:hover { border-color: #d5a6bd; box-shadow: 0 0 10px rgba(155, 89, 182, 0.4); }

/* 7. é¸æ“‡å™¨è¦†è“‹å±¤ (Selector Overlay) */
.equip-selector-overlay {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(20, 24, 30, 0.98);
    z-index: 10; padding: 15px;
    display: flex; flex-direction: column;
}
.selector-header { display: flex; justify-content: space-between; margin-bottom: 15px; border-bottom: 1px solid #444; padding-bottom: 10px; color: #f1c40f; font-weight: bold; }



/* =========================================
   ğŸ“œ ç‰©å“è©³æƒ…è¦–çª— (Item Detail Modal)
   ========================================= */
#item-detail-modal {
    position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
    width: 300px; background: rgba(18, 18, 24, 0.98); 
    border: 1px solid #666; border-radius: 12px;
    z-index: 200000; color: #eee; font-family: 'Helvetica Neue', Arial, sans-serif;
    box-shadow: 0 0 60px rgba(0,0,0,0.9);
    display: none; flex-direction: column; overflow: hidden;
    backdrop-filter: blur(12px); animation: popIn 0.2s ease-out;
}

/* ç¨€æœ‰åº¦é‚Šæ¡†è‰² */
#item-detail-modal.rarity-common { border-color: #777; }
#item-detail-modal.rarity-rare { border-color: #3498db; box-shadow: 0 0 20px rgba(52, 152, 219, 0.2); }
#item-detail-modal.rarity-legendary { border-color: #f1c40f; box-shadow: 0 0 30px rgba(241, 196, 15, 0.3); }
#item-detail-modal.rarity-mythic { border-color: #e74c3c; box-shadow: 0 0 40px rgba(231, 76, 60, 0.4); }

.detail-header {
    padding: 20px; text-align: center; background: linear-gradient(180deg, rgba(255,255,255,0.05) 0%, rgba(0,0,0,0) 100%);
    border-bottom: 1px solid rgba(255,255,255,0.1);
}
.detail-icon { font-size: 50px; margin-bottom: 10px; filter: drop-shadow(0 4px 4px rgba(0,0,0,0.5)); }
.detail-name { font-size: 16px; font-weight: bold; margin-bottom: 5px; color: #fff; }
.detail-type { font-size: 10px; color: #888; background: #222; padding: 3px 8px; border-radius: 10px; border: 1px solid #444; }

.detail-body { padding: 15px; font-size: 12px; line-height: 1.6; color: #ccc; }

/* æ•¸å€¼å€å¡Š */
.detail-stats { 
    background: rgba(0,0,0,0.3); padding: 10px; border-radius: 6px; margin: 10px 0; 
    border: 1px solid rgba(255,255,255,0.05);
}
.stat-row { display: flex; justify-content: space-between; margin-bottom: 4px; border-bottom: 1px dashed #333; padding-bottom: 2px; }
.stat-row:last-child { border-bottom: none; }
.stat-label { color: #aaa; }
.stat-val { color: #fff; font-weight: bold; font-family: monospace; }
.refine-bonus { color: #f1c40f; font-size: 10px; margin-left: 5px; animation: pulse 2s infinite; }

.detail-desc { font-style: italic; color: #777; margin-top: 10px; font-size: 11px; }

.detail-actions { display: flex; border-top: 1px solid rgba(255,255,255,0.1); }
.detail-btn { flex: 1; padding: 15px; background: #1a1a1a; border: none; color: #fff; cursor: pointer; font-weight: bold; transition: 0.2s; font-size: 13px; }
.detail-btn:hover { background: #333; }
.detail-btn.equip { color: #2ecc71; border-right: 1px solid #333; }
.detail-btn.unequip { color: #e74c3c; border-right: 1px solid #333; }
.detail-btn.alchemy { color: #9b59b6; border-right: 1px solid #333; }

@keyframes popIn { from { opacity: 0; transform: translate(-50%, -45%) scale(0.9); } to { opacity: 1; transform: translate(-50%, -50%) scale(1); } }

/* =========================================
   ğŸ“œ ç‰©å“è©³æƒ…è¦–çª— (é«˜å°æ¯”å„ªåŒ–ç‰ˆ)
   ========================================= */
#item-detail-modal {
    position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
    width: 320px; 
    /* èƒŒæ™¯æ”¹ç‚ºæ›´æ·±é‚ƒçš„é»‘è‰²ï¼Œæå‡æ–‡å­—åç™½æ•ˆæœ */
    background: rgba(12, 12, 16, 0.98); 
    border: 1px solid #555; border-radius: 12px;
    z-index: 200000; color: #fff; font-family: 'Helvetica Neue', Arial, sans-serif;
    box-shadow: 0 0 80px rgba(0,0,0,1);
    display: none; flex-direction: column; overflow: hidden;
    backdrop-filter: blur(15px); animation: popIn 0.2s ease-out;
}

/* ç¨€æœ‰åº¦é‚Šæ¡†è‰² (å¢å¼·å…‰æšˆ) */
#item-detail-modal.rarity-common { border-color: #888; }
#item-detail-modal.rarity-rare { border-color: #3498db; box-shadow: 0 0 25px rgba(52, 152, 219, 0.3); }
#item-detail-modal.rarity-legendary { border-color: #f1c40f; box-shadow: 0 0 35px rgba(241, 196, 15, 0.4); }
#item-detail-modal.rarity-mythic { border-color: #e74c3c; box-shadow: 0 0 45px rgba(231, 76, 60, 0.5); }

.detail-header {
    padding: 25px 20px; text-align: center; 
    background: linear-gradient(180deg, rgba(255,255,255,0.08) 0%, rgba(0,0,0,0) 100%);
    border-bottom: 1px solid rgba(255,255,255,0.1);
}
.detail-icon { font-size: 56px; margin-bottom: 12px; filter: drop-shadow(0 5px 15px rgba(0,0,0,0.6)); }
.detail-name { font-size: 18px; font-weight: bold; margin-bottom: 6px; color: #fff; letter-spacing: 1px; }
.detail-type { 
    font-size: 11px; color: #bbb; background: rgba(255,255,255,0.1); 
    padding: 3px 10px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.2); 
}

.detail-body { padding: 20px; color: #eee; }

/* æ•¸å€¼å€å¡Šå„ªåŒ– */
.detail-stats { 
    background: rgba(0, 0, 0, 0.4); 
    padding: 12px; border-radius: 8px; margin-bottom: 15px; 
    border: 1px solid rgba(255, 255, 255, 0.1);
}
.stat-row { 
    display: flex; justify-content: space-between; align-items: center;
    margin-bottom: 6px; padding-bottom: 6px; 
    border-bottom: 1px dashed rgba(255, 255, 255, 0.15); 
}
.stat-row:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
.stat-label { color: #d0d0d0; font-size: 13px; } /* æ¨™ç±¤æ”¹äº® */
.stat-val { color: #fff; font-weight: bold; font-family: monospace; font-size: 14px; }
.refine-bonus { color: #f1c40f; font-size: 11px; margin-left: 6px; }

/* èªªæ˜æ–‡å­—å„ªåŒ– (é«˜äº®ç‰ˆ) */
.detail-desc { 
    font-style: italic; 
    color: #e0e0e0; /* äº®éŠ€è‰²ï¼Œç¢ºä¿æ¸…æ™° */
    margin-top: 15px; 
    font-size: 13px; 
    line-height: 1.6;
    padding: 10px;
    background: rgba(255, 255, 255, 0.05); /* å¢åŠ åº•è‰²è¥¯æ‰˜ */
    border-radius: 6px;
    border-left: 3px solid rgba(255, 255, 255, 0.3);
}

.detail-actions { display: flex; border-top: 1px solid rgba(255,255,255,0.15); }
.detail-btn { 
    flex: 1; padding: 16px; background: #1a1a1a; border: none; 
    color: #fff; cursor: pointer; font-weight: bold; font-size: 14px; 
    transition: 0.2s; 
}
.detail-btn:hover { background: #333; }
.detail-btn.equip { color: #2ecc71; border-right: 1px solid #333; background: rgba(46, 204, 113, 0.1); }
.detail-btn.unequip { color: #e74c3c; border-right: 1px solid #333; background: rgba(231, 76, 60, 0.1); }
.detail-btn.alchemy { color: #9b59b6; border-right: 1px solid #333; background: rgba(155, 89, 182, 0.1); }

@keyframes goldGlow {
        0% { box-shadow: 0 0 5px gold; border-color: gold; }
        100% { box-shadow: 0 0 20px gold; border-color: orange; }
    }
    @keyframes float {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-5px); }
    }

@keyframes radarScan {
        0% { transform: translateY(-100%); }
        100% { transform: translateY(200%); }
    }
    @keyframes alertPulse {
        0% { box-shadow: 0 0 5px #e74c3c; border-color: #e74c3c; }
        50% { box-shadow: 0 0 20px #ff0000; border-color: #ff0000; }
        100% { box-shadow: 0 0 5px #e74c3c; border-color: #e74c3c; }
    }
    @keyframes goldGlow {
        0% { box-shadow: 0 0 5px gold; border-color: gold; }
        100% { box-shadow: 0 0 20px gold; border-color: orange; }
    }

/* ğŸ“ ç•¶å‰ä½ç½®çš„é«˜äº®ç‰¹æ•ˆ */
.portal-card.active-portal {
    border: 2px solid #f1c40f !important;
    background: rgba(241, 196, 15, 0.15) !important;
    box-shadow: 0 0 15px rgba(241, 196, 15, 0.3);
    pointer-events: none; /* å·²ç¶“åœ¨è©²åœ°åœ–ï¼Œç¦æ­¢é‡è¤‡é»æ“Š */
    transform: scale(1.02);
}

/* ç•¶å‰ä½ç½®æ¨™ç±¤ */
.current-loc-tag {
    background: #f1c40f; color: #000; 
    font-size: 9px; padding: 2px 6px; 
    border-radius: 4px; font-weight: bold;
    margin-left: auto; /* æ¨åˆ°æœ€å³é‚Š */
}


/* ğŸ“ ç•¶å‰ä½ç½®çš„é«˜äº®ç‰¹æ•ˆ */
.portal-card.active-portal {
    border: 2px solid #f1c40f !important;
    background: rgba(241, 196, 15, 0.15) !important;
    box-shadow: 0 0 15px rgba(241, 196, 15, 0.3);
    pointer-events: none; /* å·²ç¶“åœ¨è©²åœ°åœ–ï¼Œç¦æ­¢é‡è¤‡é»æ“Š */
    transform: scale(1.02);
}

/* ç•¶å‰ä½ç½®æ¨™ç±¤ */
.current-loc-tag {
    background: #f1c40f; color: #000; 
    font-size: 9px; padding: 2px 6px; 
    border-radius: 4px; font-weight: bold;
    margin-left: auto; /* æ¨åˆ°æœ€å³é‚Š */
}


/* å­¸ç¿’å€å®¹å™¨ï¼šå…è¨±å‚ç›´æ»¾å‹• */
#learning-content-area {
    padding: 20px;
    overflow-y: auto; /* ğŸ”¥ å…§å®¹å¤ªé•·æ™‚è‡ªå‹•å‡ºç¾å·è»¸ */
    height: 100%;     /* å¡«æ»¿çˆ¶å®¹å™¨ */
    box-sizing: border-box;
}

/* æ¸¬é©—å¡ç‰‡ */
.quiz-card {
    background: #fff;
    padding: 15px;
    margin-bottom: 15px;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}

/* --- ğŸ¨ Tabi-Satori V4 æ ¸å¿ƒç¾å­¸ --- */
:root {
    --nhk-green: #27ae60;
    --nhk-light: #e8f5e9;
    --text-dark: #2c3e50;
    --card-shadow: 0 4px 15px rgba(0,0,0,0.05);
}

/* å…§å®¹å¡ç‰‡ä¸»é«” */
.content-card {
    background: rgba(255, 255, 255, 0.96);
    border-radius: 16px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    backdrop-filter: blur(10px);
    height: 100%;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    position: relative;
}

/* å­¸ç¿’å€å¡Šé€šç”¨æ¨£å¼ */
.learning-section {
    background: #fff;
    margin-bottom: 25px;
    padding: 20px;
    border-radius: 12px;
    border: 1px solid #eee;
    box-shadow: 0 2px 8px rgba(0,0,0,0.03);
    transition: transform 0.2s;
}

.section-title {
    font-size: 16px;
    color: var(--nhk-green);
    border-bottom: 2px solid var(--nhk-light);
    padding-bottom: 8px;
    margin-bottom: 15px;
    font-weight: bold;
    display: flex;
    align-items: center;
    gap: 8px;
}

/* ğŸ“š æ–‡ç« é–±è®€å€ */
.article-body {
    font-size: 20px;
    line-height: 2.2; /* å¢åŠ è¡Œé«˜è®“ Ruby ä¸æœƒæ“ åœ¨ä¸€èµ· */
    color: var(--text-dark);
    font-family: "Hiragino Mincho ProN", "Yu Mincho", serif; /* æ—¥æ–‡æ•™ç§‘æ›¸å­—é«” */
    text-align: justify;
}

/* å„ªåŒ– Ruby æ¨™è¨» */
ruby { ruby-align: center; }
rt { font-size: 0.5em; color: #7f8c8d; user-select: none; }


/* âš”ï¸ æ¸¬é©—å€å¡Š */
.quiz-card {
    background: #fffcf5;
    border: 1px solid #f1c40f;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 15px;
}
.quiz-question { font-weight: bold; margin-bottom: 10px; color: #2c3e50; }
.quiz-options { display: grid; gap: 8px; }
.quiz-btn {
    background: #fff; border: 1px solid #ddd; padding: 10px;
    border-radius: 6px; text-align: left; cursor: pointer; transition: 0.2s;
    font-size: 14px;
}
.quiz-btn:hover { background: #fdf2e9; border-color: #f39c12; }
.quiz-btn.correct { background: #d5f5e3; border-color: #2ecc71; color: #006400; }
.quiz-btn.wrong { background: #fadbd8; border-color: #e74c3c; color: #721c24; }


/* --- ğŸ”Š èªéŸ³äº’å‹•å¡ç‰‡ç³»çµ± --- */

/* é€šç”¨å­¸ç¿’å¡ç‰‡ (å–®å­— & ç‰‡èªå…±ç”¨) */
.learning-card {
    background: #fff;
    border-radius: 12px;
    padding: 15px;
    position: relative;
    box-shadow: 0 4px 6px rgba(0,0,0,0.02); /* è¼•å¾®é™°å½± */
    border: 1px solid #f0f0f0;
    transition: all 0.25s cubic-bezier(0.25, 0.8, 0.25, 1);
    cursor: pointer; /* è®“æ¸¸æ¨™è®Šæ‰‹å‹ï¼Œæç¤ºå¯é»æ“Š */
    display: flex;
    flex-direction: column;
    justify-content: center;
    overflow: hidden;
}

/* æ»‘é¼ æ‡¸åœç‰¹æ•ˆï¼šæµ®èµ· + åŠ æ·±é™°å½± */
.learning-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 10px 20px rgba(0,0,0,0.08);
}

/* é»æ“Šç‰¹æ•ˆï¼šè¼•å¾®ä¸‹å£“ */
.learning-card:active {
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    background: #fafafa;
}

/* ğŸ”Š å–‡å­åœ–ç¤º (é è¨­æ·¡åŒ–ï¼ŒHover æ™‚è®Šæ˜é¡¯) */
.card-speaker-icon {
    position: absolute;
    top: 10px;
    right: 10px;
    font-size: 16px;
    opacity: 0.1; /* å¹³å¸¸å¾ˆæ·¡ */
    transition: 0.3s;
    filter: grayscale(1);
}
.learning-card:hover .card-speaker-icon {
    opacity: 1; /* Hover æ™‚é¡¯ç¾ */
    filter: grayscale(0);
    transform: scale(1.1);
}

/* --- ğŸ“• å–®å­—å¡å°ˆå±¬æ¨£å¼ --- */
.vocab-card-style {
    border-left: 5px solid var(--nhk-green); /* å·¦å´ç¶ æ¢ */
}
.vocab-card-style:hover {
    border-color: #2ecc71;
    background: linear-gradient(to right, #f0f9f4, #fff);
}
.vocab-word { 
    font-size: 20px; 
    font-weight: 800; 
    color: #2c3e50; 
    margin-bottom: 2px;
}
.vocab-kana { 
    font-size: 12px; 
    color: #7f8c8d; 
    margin-bottom: 6px; 
    font-family: sans-serif;
}
.vocab-meaning { 
    font-size: 14px; 
    color: #d35400; 
    border-top: 1px dashed #eee; 
    padding-top: 6px; 
    margin-top: 2px;
}

/* --- ğŸ“˜ ç‰‡èªå¡å°ˆå±¬æ¨£å¼ --- */
.phrase-card-style {
    border-left: 5px solid #3498db; /* å·¦å´è—æ¢ */
    padding: 18px; /* ç‰‡èªé€šå¸¸è¼ƒé•·ï¼Œå¢åŠ å…§è· */
}
.phrase-card-style:hover {
    border-color: #2980b9;
    background: linear-gradient(to right, #f0f8ff, #fff);
}
.phrase-content {
    font-size: 16px;
    font-weight: bold;
    color: #2c3e50;
    line-height: 1.5;
    margin-bottom: 8px;
}
.phrase-meaning {
    font-size: 13px;
    color: #555;
    background: rgba(0,0,0,0.03);
    padding: 4px 8px;
    border-radius: 4px;
    display: inline-block;
}

/* --- âœï¸ V4 éš¨å ‚æ¸¬é©—ç¾å­¸ (äº’å‹•ä¿®å¾©ç‰ˆ) --- */

.quiz-card-v4 {
    background: #fff;
    border: 1px solid #e0e0e0;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 25px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.03);
    transition: transform 0.2s;
}

.quiz-question-v4 {
    font-size: 18px;
    font-weight: bold;
    color: #2c3e50;
    margin-bottom: 15px;
    line-height: 1.6;
    border-left: 4px solid var(--accent-orange);
    padding-left: 12px;
}

/* é¸é …æŒ‰éˆ•å®¹å™¨ */
.quiz-options-grid {
    display: grid;
    gap: 10px;
}

/* é¸é …æŒ‰éˆ•æœ¬é«” */
.quiz-opt-btn {
    width: 100%;
    text-align: left;
    background: #fcfcfc;
    border: 2px solid #eee;
    padding: 12px 15px;
    border-radius: 8px;
    font-size: 16px;
    color: #555;
    cursor: pointer;
    transition: all 0.2s ease;
    position: relative;
}

/* æ‡¸åœèˆ‡é¸ä¸­ç‰¹æ•ˆ */
.quiz-opt-btn:hover {
    background: #fff8e1;
    border-color: #f1c40f;
}

.quiz-opt-btn.selected {
    background: #fff3cd;
    border-color: #f1c40f;
    color: #856404;
    font-weight: bold;
    box-shadow: 0 0 0 2px rgba(241, 196, 15, 0.2);
}

/* âœ… æ­£ç¢ºç­”æ¡ˆæ¨£å¼ */
.quiz-opt-btn.correct {
    background: #d4edda !important;
    border-color: #28a745 !important;
    color: #155724 !important;
}
.quiz-opt-btn.correct::after {
    content: "âœ…";
    position: absolute;
    right: 15px;
}

/* âŒ éŒ¯èª¤ç­”æ¡ˆæ¨£å¼ */
.quiz-opt-btn.wrong {
    background: #f8d7da !important;
    border-color: #dc3545 !important;
    color: #721c24 !important;
    opacity: 0.7;
}
.quiz-opt-btn.wrong::after {
    content: "âŒ";
    position: absolute;
    right: 15px;
}

/* è§£æå€å¡Š */
.quiz-explain-box {
    margin-top: 15px;
    padding: 15px;
    background: #f0f7ff;
    border-left: 4px solid #3498db;
    border-radius: 4px;
    font-size: 14px;
    color: #2c3e50;
    line-height: 1.6;
    display: none; /* é è¨­éš±è— */
    animation: slideDown 0.3s ease-out;
}

@keyframes slideDown {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* å°‡åŸæœ¬çš„ .hide-furigana æ”¹ç‚º .hide-ruby */
.hide-ruby rt { 
    display: none !important; 
}

/* --- ä¿®æ­£ï¼šè¤‡ç¿’å¡ç‰‡æ¨™æº–è¦æ ¼ --- */
.flip-card {
    width: 100%;
    max-width: 280px;  /* ç‰©ç†å¯¬åº¦é–å®š */
    height: 160px;     /* ğŸ”¥ ç‰©ç†é«˜åº¦å¼·åˆ¶çµ±ä¸€ */
    perspective: 1000px;
    margin: 10px auto;
}

.flip-card-front, .flip-card-back {
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    border-radius: 12px;
    border: 1px solid #eee;
    backface-visibility: hidden;
    position: absolute;
    width: 100%;
    height: 100%;
    top: 0;
    left: 0;
}

/* ç¢ºä¿æŒ‰éˆ•ä¸æœƒè¢«æ–‡å­—æ¨æ“ ä½ç§» */
.card-audio-btn:hover {
    background: rgba(0,0,0,0.1) !important;
    transform: scale(1.1);
}

/* --- ä¿®æ­£ï¼šRuby ç‰©ç†å°é½Šå¼·åŒ– --- */
ruby {
    ruby-align: center; /* ç‰©ç†å¼·åˆ¶ï¼šè®€éŸ³ç²¾ç¢ºç½®ä¸­ */
    ruby-position: over;
    white-space: nowrap; /* é˜²æ­¢æ¼¢å­—èˆ‡å‡ååœ¨çª„å¡ç‰‡ä¸­ç‰©ç†æ–·è¡Œ */
}

rt {
    font-size: 0.55em;
    letter-spacing: 0.1em;
    padding-bottom: 0.2em;
}

/* å¼·åŒ–å¡ç‰‡å…§æ–‡é¡¯ç¤ºï¼Œé˜²æ­¢æ–‡å­—æ¨æ“ ä½ç§» */
.flip-card-front, .flip-card-back {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    overflow: hidden; /* ç‰©ç†æ””æˆªï¼šé˜²æ­¢å…§å®¹æº¢å‡ºé€ æˆé‚Šç•Œææ¯€ */
}

/* ğŸª è£œçµ¦ç«™å…¥å£å‘¼å¸ç‰¹æ•ˆ */
@keyframes portalPulse {
    0% { box-shadow: 0 0 5px rgba(155, 89, 182, 0.2); border-color: rgba(155, 89, 182, 0.5); }
    50% { box-shadow: 0 0 15px rgba(155, 89, 182, 0.5); border-color: rgba(155, 89, 182, 1); }
    100% { box-shadow: 0 0 5px rgba(155, 89, 182, 0.2); border-color: rgba(155, 89, 182, 0.5); }
}

.portal-card[onclick="openKingdomShop()"] {
    animation: portalPulse 2s infinite ease-in-out;
}

/* =========================================
   ğŸ‘¹ ç‹‚æš´é™è‡¨ï¼šè¦–è¦ºæ±¡æŸ“èˆ‡ç‰©ç†ç¢è£‚
   ========================================= */

/* 1. åœ°ç„æ¿¾é¡å¹³æ»‘éæ¸¡ */
.main-wrapper {
    transition: filter 2s cubic-bezier(0.4, 0, 0.2, 1);
}

/* 2. ç‰©ç†åœ°éœ‡ï¼šä¸­å¤®æˆ°å ´æŒçºŒæ€§æ™ƒå‹• */
.berserk-world-shake {
    animation: worldPanic 0.15s infinite alternate ease-in-out !important;
}

@keyframes worldPanic {
    0% { transform: translate(1px, 1px) rotate(0deg); }
    100% { transform: translate(-1px, -1px) rotate(0.2deg); }
}

/* 3. è™›ç©ºç¢è£‚ (Glitch Effect)ï¼šé‡å°ä¸­å¤®ç‰Œæ¡Œ */
.glitch-shatter-active {
    animation: shadowShatter 0.4s steps(2) infinite alternate !important;
    border: 3px solid #8e44ad !important;
    box-shadow: 0 0 50px rgba(142, 68, 173, 0.8), inset 0 0 20px #f00 !important;
}

@keyframes shadowShatter {
    0% { clip-path: inset(0 0 0 0); transform: skew(0deg); }
    20% { clip-path: inset(10% -10% 80% 0); transform: skew(5deg); }
    40% { clip-path: inset(80% 0 10% 0); transform: translate(5px, -5px); }
    60% { clip-path: inset(30% 0 40% 0); transform: scale(1.05); }
    100% { clip-path: inset(0 0 0 0); }
}

/* 4. å…¨å±è™›ç©ºæƒæç·š */
.void-overlay-vfx {
    position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
    background: repeating-linear-gradient(
        0deg,
        rgba(0, 0, 0, 0.15) 0px,
        rgba(0, 0, 0, 0.15) 1px,
        transparent 1px,
        transparent 2px
    );
    pointer-events: none;
    z-index: 250000;
    opacity: 0;
    transition: opacity 1.5s ease;
}

.void-active { opacity: 0.4; }




/* --- ç‰¹æ•ˆåº«ï¼šç‰©ç†æ„ŸçŸ¥ --- */
.vfx-shake { animation: bubbleImpact 0.3s infinite; }
.vfx-pulse { animation: goldBreath 2s infinite; }
.vfx-glitch { animation: voidGlitch 0.2s infinite; filter: hue-rotate(90deg); }

@keyframes bubbleImpact {
    0% { transform: translateX(-50%) translate(1px, 1px); }
    50% { transform: translateX(-50%) translate(-2px, -1px); }
    100% { transform: translateX(-50%) translate(1px, 1px); }
}

@keyframes goldBreath {
    0% { box-shadow: 0 0 5px gold; }
    50% { box-shadow: 0 0 25px gold; }
    100% { box-shadow: 0 0 5px gold; }
}

@keyframes voidGlitch {
    0% { clip-path: inset(0 0 0 0); }
    50% { clip-path: inset(10% -5% 20% 0); transform: translateX(-52%); }
    100% { clip-path: inset(0 0 0 0); }
}

/* ğŸ† çµç®—å…¨åŸŸé®ç½©ï¼šå¼·åŒ–ç‰©ç†éš”é›¢èˆ‡æ¯›ç»ç’ƒç‰¹æ•ˆ */
#victory-screen {
    position: fixed;
    top: 0; left: 0;
    width: 100vw; height: 100vh;
    background: radial-gradient(circle, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0.98) 100%) !important;
    backdrop-filter: blur(15px); /* ç‰©ç†éš”é›¢èƒŒæ™¯ */
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 200000 !important;
    pointer-events: auto !important; /* æ””æˆªæ‰€æœ‰å°åº•å±¤çš„èª¤è§¸ */
}

/* ç¢ºä¿å½ˆçª—å…§å®¹çµ•å°æ¸…æ™°ï¼Œä¸è¢«è‡ªé«”æ¿¾é¡å½±éŸ¿ */
.fade-in-popup {
    animation: victoryBounce 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
    filter: none !important;
    -webkit-filter: none !important;
}

@keyframes victoryBounce {
    0% { opacity: 0; transform: scale(0.8) translateY(30px); }
    100% { opacity: 1; transform: scale(1) translateY(0); }
}

/* å‚³å¥‡è£å‚™ç™¼å…‰ï¼šå°é½Šè·äººé­‚ */
.legendary-glow {
    animation: goldFlare 1.5s infinite alternate;
    text-shadow: 0 0 10px gold;
}

@keyframes goldFlare {
    from { box-shadow: 0 0 10px rgba(241,196,15,0.2); }
    to { box-shadow: 0 0 30px rgba(241,196,15,0.6); }
}

/* =========================================
   ğŸš¨ ç€•æ­»ç‹€æ…‹ï¼šç‰©ç†å¿ƒè·³èˆ‡è¡€ç´…æ¿¾é¡
   ========================================= */

/* 1. å…¨å±è¡€ç´…è„ˆè¡ï¼šåˆ©ç”¨é™°å½±é”æˆå…§ç¸®æ„Ÿ */
.critical-health-vignette {
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    pointer-events: none; /* ç‰©ç†ç©¿é€ï¼Œä¸å¹²æ“¾å°å±€æ“ä½œ */
    z-index: 100000;
    box-shadow: inset 0 0 0px rgba(255, 0, 0, 0);
    transition: box-shadow 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    display: block;
}

/* é»ç‡ƒè„ˆè¡å‹•ç•« */
.vignette-active {
    animation: bloodPulse 1.2s infinite alternate ease-in-out;
}

@keyframes bloodPulse {
    0% { box-shadow: inset 0 0 50px rgba(200, 0, 0, 0.2); }
    100% { box-shadow: inset 0 0 180px rgba(255, 0, 0, 0.7); }
}

/* 2. ç‰©ç†å¿ƒè·³éœ‡å‹•ï¼šé‡å°ä¸»å®¹å™¨é€²è¡Œç¸®æ”¾å¾‹å‹• */
.heartbeat-shake {
    animation: heartbeatVibration 0.6s infinite;
}

@keyframes heartbeatVibration {
    0% { transform: scale(1); }
    10% { transform: scale(1.005); }
    20% { transform: scale(1); }
    30% { transform: scale(1.01); }
    100% { transform: scale(1); }
}

/* æˆ°è¡“ HUD å½ˆå…¥å‹•ç•« */
#tactical-hud {
    animation: hudEntrance 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

@keyframes hudEntrance {
    from { opacity: 0; transform: translateX(-30px) scale(0.9); }
    to { opacity: 1; transform: translateX(0) scale(1); }
}

/* å‚ç›´è¡€æ¢çš„ç’°å¢ƒå…‰æ„Ÿ */
#poker-hp-fill-v {
    filter: drop-shadow(0 0 5px rgba(46, 204, 113, 0.5));
}

/* =========================================
   ğŸ©¸ æˆ°è¡“ HUDï¼šæš—é»‘ç”Ÿå‘½ä¹‹çƒèˆ‡ä¸‰æ ¼ç‰©å“æ¬„
   ========================================= */

/* 1. ç”Ÿå‘½ä¹‹çƒæœ¬é«” */
.hp-orb-container {
    position: relative;
    width: 90px; height: 90px;
    background: radial-gradient(circle at 30% 30%, #444, #000);
    border-radius: 50%;
    border: 3px solid #222;
    box-shadow: 0 0 25px rgba(0,0,0,0.8), inset 0 0 20px rgba(0,0,0,0.6);
    overflow: hidden;
    margin-bottom: 15px;
}

/* ç‰©ç†ç”Ÿå‘½æ¶²é«” (Diablo ç´…) */
.hp-liquid {
    position: absolute;
    bottom: 0; left: 0; width: 100%;
    background: linear-gradient(to top, #600 0%, #c0392b 70%, #ff4d4d 100%);
    transition: height 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    box-shadow: 0 0 15px rgba(255, 0, 0, 0.5);
}

/* ç»ç’ƒé«˜å…‰ */
.hp-orb-glare {
    position: absolute;
    top: 15%; left: 20%; width: 25%; height: 25%;
    background: rgba(255,255,255,0.1);
    border-radius: 50%;
    filter: blur(3px);
    pointer-events: none;
}

/* 2. ç‰©å“æ¬„ï¼šä¸‰ä½ä¸€é«”æ ¼ */
.inventory-slots {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 6px;
    margin-top: 10px;
}

.item-slot-box {
    width: 32px; height: 32px;
    background: rgba(0, 0, 0, 0.6);
    border: 1px solid #444;
    border-radius: 4px;
    display: flex; align-items: center; justify-content: center;
    position: relative;
    box-shadow: inset 0 0 8px rgba(0,0,0,1);
    transition: 0.2s;
}

.item-slot-box.has-item { border-color: #2ecc71; background: rgba(46, 204, 113, 0.05); }

.slot-badge {
    position: absolute; bottom: -2px; right: -2px;
    font-size: 9px; background: #2ecc71; color: #000;
    padding: 0 3px; border-radius: 4px; font-weight: 900;
}
/* ğŸ©¸ Diablo ç”Ÿå‘½ä¹‹çƒèˆ‡è‡ªå®šç¾©ç‰©å“æ¬„ */
.hp-orb-container {
    position: relative;
    width: 95px; height: 95px;
    background: radial-gradient(circle at 30% 30%, #444, #000);
    border-radius: 50%;
    border: 3px solid #222;
    box-shadow: 0 0 25px rgba(0,0,0,0.8), inset 0 0 20px rgba(0,0,0,0.6);
    overflow: hidden;
}

.hp-liquid {
    position: absolute; bottom: 0; left: 0; width: 100%;
    background: linear-gradient(to top, #600 0%, #c0392b 70%, #ff0000 100%);
    transition: height 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    box-shadow: 0 0 15px rgba(255, 0, 0, 0.5);
}

.hp-orb-glare {
    position: absolute; top: 15%; left: 20%; width: 25%; height: 25%;
    background: rgba(255,255,255,0.1); border-radius: 50%; filter: blur(3px); pointer-events: none;
}

.inventory-slots-v4 {
    display: grid; grid-template-columns: repeat(3, 1fr);
    gap: 6px; margin-top: 10px; padding: 5px;
    background: rgba(0,0,0,0.4); border-radius: 8px; border: 1px solid #333;
}

.item-slot-v4 {
    width: 32px; height: 32px; background: rgba(10, 10, 10, 0.9);
    border: 1.5px solid #444; border-radius: 4px;
    display: flex; align-items: center; justify-content: center;
    position: relative; cursor: pointer; transition: 0.2s; box-shadow: inset 0 0 5px #000;
}

.item-slot-v4:hover { border-color: #f1c40f; }
.item-slot-v4.has-item { border-color: #2ecc71; }

.slot-badge-v4 {
    position: absolute; bottom: -2px; right: -2px; background: #2ecc71;
    color: #000; font-size: 8px; padding: 0 3px; border-radius: 3px; font-weight: 900;
}

/* ğŸ©¸ ç”Ÿå‘½æ¶²é«”ç‰©ç†æ¨£å¼å„ªåŒ– */
.hp-liquid {
    position: absolute;
    bottom: 0; left: 0; width: 100%;
    /* ç‰©ç†éæ¸¡ï¼š1ç§’çš„æ™‚é–“å®Œç¾åŒ¹é… 1Hz çš„æ¢å¾©é »ç‡ï¼Œé”æˆç„¡ç¸«çˆ¬å‡æ„Ÿ */
    transition: height 1s linear, background 0.5s ease; 
    background: linear-gradient(to top, #500 0%, #a00 60%, #ff0000 100%);
    box-shadow: 0 0 15px rgba(255, 0, 0, 0.5);
    z-index: 1;
}

/* ğŸ§ª å†ç”Ÿç‹€æ…‹ä¸‹çš„æ¶²é«”æŸ“è‰² */
.regenerating {
    background: linear-gradient(to top, #040 0%, #0a0 60%, #2ecc71 100%) !important;
}

/* ğŸ©¸ Diablo ç”Ÿå‘½ä¹‹çƒèˆ‡è‡ªå®šç¾©ç‰©å“æ¬„ */
.hp-orb-container {
    position: relative;
    width: 90px; height: 90px;
    background: radial-gradient(circle at 30% 30%, #444, #000);
    border-radius: 50%;
    border: 3px solid #222;
    box-shadow: 0 0 25px rgba(0,0,0,0.8), inset 0 0 20px rgba(0,0,0,0.6);
    overflow: hidden;
}

.hp-liquid {
    position: absolute; bottom: 0; left: 0; width: 100%;
    background: linear-gradient(to top, #600 0%, #c0392b 70%, #ff0000 100%);
    transition: height 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    box-shadow: 0 0 15px rgba(255, 0, 0, 0.5);
}

.inventory-slots-v4 {
    display: grid; grid-template-columns: repeat(3, 1fr);
    gap: 6px; margin-top: 10px; padding: 5px;
    background: rgba(0,0,0,0.4); border-radius: 8px; border: 1px solid #333;
}

.item-slot-v4 {
    width: 32px; height: 32px; background: rgba(10, 10, 10, 0.9);
    border: 1.5px solid #444; border-radius: 4px;
    display: flex; align-items: center; justify-content: center;
    position: relative; cursor: pointer; transition: 0.2s;
}

.item-slot-v4.has-item { border-color: #2ecc71; }
.slot-badge-v4 {
    position: absolute; bottom: -2px; right: -2px; background: #2ecc71;
    color: #000; font-size: 8px; padding: 0 3px; border-radius: 3px; font-weight: 900;
}

/* ğŸ§ª ç‹€æ…‹æ„ŸçŸ¥ï¼šç•¶ç”Ÿå‘½å€¼å—åˆ°ç‰©ç†ç•°å¸¸ä¾µè•æ™‚çš„è¦–è¦ºè®Šç•° */
.status-poison-orb { filter: sepia(1) hue-rotate(60deg) saturate(3) brightness(0.8); } /* è®Šç¶  */
.status-bleed-orb { animation: bleedPulse 0.8s infinite; } /* ç´…é–ƒ */

@keyframes bleedPulse {
    0% { filter: brightness(1); }
    50% { filter: brightness(1.5) drop-shadow(0 0 15px #f00); }
    100% { filter: brightness(1); }
}

/* æˆ°å ´ä¸‹æ²‰éæ¸¡ */
#table-center {
    transition: margin-top 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

/* =========================================
   ğŸ§ª ç”Ÿå‘½ä¹‹çƒï¼šç‹€æ…‹ç•°è®Šè¦–è¦ºçŸ©é™£
   ========================================= */

/* ä¸­æ¯’ï¼šæ¶²é¢è½‰è®Šç‚ºæ·±ç¶ è‰²ï¼Œä¸¦å¸¶æœ‰å¾®å¼±æº¶è§£æ„Ÿ */
.orb-poisoned .hp-liquid {
    background: linear-gradient(to top, #040 0%, #0a0 60%, #2ecc71 100%) !important;
    filter: hue-rotate(90deg) brightness(0.8);
    box-shadow: 0 0 20px rgba(0, 255, 0, 0.4);
}

/* å‡ºè¡€ï¼šçƒé«”åŠ‡çƒˆç´…é–ƒï¼Œæ¨¡æ“¬å¤±è¡€éå¿«çš„ç‰©ç†è¡æ“Š */
.orb-bleeding {
    animation: bleedFlash 0.5s infinite alternate !important;
}
@keyframes bleedFlash {
    0% { filter: brightness(1) contrast(1); }
    100% { filter: brightness(1.8) contrast(1.2); box-shadow: 0 0 30px #f00; }
}

/* éº»ç—ºï¼šæ¶²é«”å¤±å»å…‰æ¾¤è®Šç‚ºç°ç™½è‰²ï¼Œä¸”çƒé«”ç”¢ç”Ÿç´°å¾®é¡«æŠ– */
.orb-paralyzed .hp-liquid {
    background: linear-gradient(to top, #444 0%, #888 60%, #bbb 100%) !important;
    filter: saturate(0);
}
.orb-paralyzed {
    animation: staticJitter 0.1s infinite;
}
@keyframes staticJitter {
    0% { transform: translate(1px, 0); }
    50% { transform: translate(-1px, 1px); }
    100% { transform: translate(0, -1px); }
}

/* å‡ºè¡€ï¼šçƒé«”è¦å¾‹ç´…é–ƒï¼Œæ¨¡æ“¬å‚·å£æ»²è¡€çš„ç‰©ç†è„ˆå‹• */
.orb-bleeding {
    animation: bleedPulse 0.4s 2 alternate !important; /* ç¸®çŸ­æ™‚é–“ï¼Œåƒ…åœ¨å‡ºç‰Œæ™‚é–ƒå…©ä¸‹ */
}

@keyframes bleedPulse {
    0% { filter: brightness(1) drop-shadow(0 0 5px rgba(255,0,0,0)); }
    100% { filter: brightness(1.6) drop-shadow(0 0 20px #f00); }
}

/* =========================================
   ğŸ§ª ä¸­æ¯’ç‰¹æ•ˆï¼šç²’å­æ°£æ³¡ç³»çµ±
   ========================================= */

/* æ°£æ³¡å®¹å™¨ï¼šç‰©ç†é–å®šåœ¨ç”Ÿå‘½çƒå…§éƒ¨ */
.poison-bubbles-container {
    position: absolute;
    bottom: 0; left: 0;
    width: 100%; height: 100%;
    pointer-events: none;
    z-index: 4; /* ä½æ–¼æ¶²é¢ä¹‹ä¸Šï¼Œé«˜å…‰ä¹‹ä¸‹ */
    overflow: hidden;
}

/* å–®å€‹æ°£æ³¡ç²’å­ */
.poison-bubble {
    position: absolute;
    bottom: -10px;
    background: rgba(46, 204, 113, 0.8); /* å¢¨ç¶ è‰²æ¯’ç´  */
    border-radius: 50%;
    filter: blur(1px);
    box-shadow: 0 0 5px rgba(46, 204, 113, 0.5);
    animation: poisonFloatUp 2.5s linear forwards;
}

@keyframes poisonFloatUp {
    0% {
        transform: translateY(0) translateX(0) scale(0.5);
        opacity: 0.8;
    }
    50% {
        opacity: 1;
        transform: translateY(-40px) translateX(var(--drift));
    }
    100% {
        transform: translateY(-100px) translateX(calc(var(--drift) * 1.5)) scale(1.2);
        opacity: 0;
    }
}

/* å¼·åŒ–ï¼šä¸­æ¯’æ™‚æ¶²é¢çš„ç‰©ç†æ³¢ç´‹ */
.orb-poisoned .hp-liquid::after {
    content: '';
    position: absolute;
    top: 0; left: 0; width: 100%; height: 4px;
    background: rgba(46, 204, 113, 0.4);
    filter: blur(2px);
    animation: poisonWave 1s infinite alternate;
}

@keyframes poisonWave {
    from { opacity: 0.3; transform: scaleX(1); }
    to { opacity: 0.7; transform: scaleX(1.1); }
}

/* =========================================
   âš¡ éº»ç—ºç‰¹æ•ˆï¼šç¥ç¶“å¤±èª¿ç‰©ç†æŠ–å‹•
   ========================================= */

.paralyze-jitter {
    animation: neuroSpasm 0.4s cubic-bezier(.36,.07,.19,.97) both;
    border-color: #95a5a6 !important; /* ç°ç™½è‰²ç¥ç¶“é˜»æ–·æ„Ÿ */
    box-shadow: 0 0 15px rgba(149, 165, 166, 0.6) !important;
}

@keyframes neuroSpasm {
    0%, 100% { transform: translateX(0) rotate(0deg); }
    10%, 30%, 50%, 70%, 90% { transform: translateX(-4px) rotate(-1deg); }
    20%, 40%, 60%, 80% { transform: translateX(4px) rotate(1deg); }
}

/* =========================================
   âš”ï¸ æˆ°è¡“æ•´å‚™ä»‹é¢ï¼šç‰©ç†è¦–è¦ºè¦æ ¼
   ========================================= */

#loadout-modal {
    animation: loadoutEntrance 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

@keyframes loadoutEntrance {
    from { opacity: 0; transform: translate(-50%, -45%) scale(0.9); }
    to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
}

.loadout-slot {
    flex: 1;
    background: rgba(255, 255, 255, 0.03);
    border: 2px solid #333;
    border-radius: 12px;
    padding: 15px 5px;
    text-align: center;
    cursor: pointer;
    transition: 0.3s;
    position: relative;
}

.loadout-slot.active {
    border-color: #3498db;
    background: rgba(52, 152, 219, 0.1);
    box-shadow: 0 0 15px rgba(52, 152, 219, 0.3);
}

.loadout-slot:hover {
    background: rgba(255, 255, 255, 0.08);
}

.item-picker-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
    max-height: 200px;
    overflow-y: auto;
    padding: 10px;
    background: rgba(0, 0, 0, 0.3);
    border-radius: 8px;
}

.picker-item-card {
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid #444;
    border-radius: 8px;
    padding: 10px;
    text-align: center;
    cursor: pointer;
    transition: 0.2s;
}

.picker-item-card:hover {
    border-color: #f1c40f;
    transform: translateY(-3px);
}

/* =========================================
   ğŸ’“ ç‰©ç†å°æ­£ï¼šä½è¡€é‡è·³å‹•ç‰¹æ•ˆ (é˜²ä½ç§»ç‰ˆ)
   ä¿®æ­£ Issue: è§£æ±º image_48d4ac.png é ‚éƒ¨ç©ºç™½å•é¡Œ
   ========================================= */

/* 1. ç¢ºä¿ Body èˆ‡ HTML ä¸æœƒå› ç‚ºå‹•ç•«ç”¢ç”Ÿæ»¾å‹•æ¢åç§» */
html, body {
    margin: 0;
    padding: 0;
    overflow-x: hidden;
}

/* 2. æ ¸å¿ƒä¿®æ­£ï¼šå°‡ç‰¹æ•ˆ class æ›è¼‰åœ¨ wrapper ä¸Šï¼Œä½†æ’é™¤å° Header çš„å½±éŸ¿ */
.main-wrapper.low-hp-pulsing {
    /* ç¦æ­¢ç›´æ¥åœ¨ wrapper ä½¿ç”¨ filterï¼Œé˜²æ­¢ç ´å£ sticky å®šä½ */
    filter: none !important; 
    animation: none !important;
}

/* 3. ä½¿ç”¨å½å…ƒç´ æ‰¿è¼‰ã€Œç´…å…‰é–ƒçˆã€è¦–è¦ºï¼Œä¸å½±éŸ¿ç‰©ç†ä½ˆå±€ */
.main-wrapper.low-hp-pulsing::before {
    content: "";
    position: fixed;
    top: 0; left: 0;
    width: 100vw; height: 100vh;
    border: 15px solid rgba(255, 0, 0, 0.3);
    box-sizing: border-box;
    pointer-events: none; /* ç¢ºä¿ä¸æ””æˆªé»æ“Š */
    z-index: 99999;
    box-shadow: inset 0 0 100px rgba(255, 0, 0, 0.4);
    animation: physicalHeartbeat 1.2s infinite ease-in-out;
}

/* 4. ç‰©ç†è·³å‹•å‹•ç•«ï¼šåƒ…ä½œç”¨æ–¼è¦–è¦ºå±¤ï¼Œä¸ç”¢ç”Ÿ layout åç§» */
@keyframes physicalHeartbeat {
    0% { opacity: 0.3; filter: blur(2px); }
    50% { opacity: 0.7; filter: blur(5px); }
    100% { opacity: 0.3; filter: blur(2px); }
}

/* 5. ç¢ºä¿ Sticky Header å§‹çµ‚é–å®šåœ¨ Viewport é ‚éƒ¨ */
#game-sticky-header {
    position: sticky !important;
    top: 0 !important;
    z-index: 100000; /* å¿…é ˆé«˜æ–¼è¦–è¦ºç‰¹æ•ˆå±¤ */
    background: rgba(20, 20, 20, 0.95);
    transform: none !important; /* å¼·åˆ¶ç¦æ­¢è·Ÿéš¨çˆ¶å±¤è·³å‹• */
}


/* è¼”åŠ©æŒ‰éˆ•èˆ‡æŒ‡ä»¤å€çš„ç·Šæ¹Šä½ˆå±€ */
.compact-control-panel {
    display: flex; flex-direction: column; align-items: center;
    gap: 2px !important; /* ğŸ”¥ æ¥µè‡´ç¸®çŸ­ç‰©ç†è·é›¢ */
    background: rgba(0,0,0,0.4);
    padding: 10px; border-radius: 15px;
    border: 1px solid rgba(255,255,255,0.05);
}



/* ğŸ”¥ è§£æ±ºé‡è¤‡æ¸²æŸ“çš„ç‰©ç†å®¹å™¨ */
#poker-kingdom-sidebar {
    display: flex;
    flex-direction: column;
    gap: 12px;
    padding: 5px;
}

/* =========================================
   ğŸ’¬ AI èªéŸ³æ°£æ³¡ï¼šæ–¹ä½å®šå‘é˜²ç¦¦ç‰ˆ (V5.6)
   ========================================= */
.speech-bubble {
    position: absolute;
    bottom: 50%; /* ç‰©ç†é«˜åº¦ä¸­å¿ƒå°é½Š */
    transform: translateY(50%);
    background: #ffffff !important;
    color: #1a1a1a !important;
    padding: 12px 18px !important;
    border: 3px solid #2c3e50 !important;
    font-size: 15px !important;
    font-weight: 900 !important;
    min-width: 140px;
    max-width: 220px;
    z-index: 60000 !important; /* ç‰©ç†å±¤ç´šï¼šæœ€é«˜ */
    box-shadow: 8px 8px 0px rgba(0,0,0,0.3) !important;
    pointer-events: none;
    line-height: 1.4 !important;
    display: none;
    opacity: 0;
    transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

/* â¬…ï¸ æ¨¡å¼ Aï¼šå‘å·¦å™´ç™¼ (é©ç”¨æ–¼å·¦å´èˆ‡ä¸­é–“ AI) */
.bubble-left-side {
    right: 110% !important; /* ç‰©ç†åç§»è‡³é ­åƒå·¦å´ */
    left: auto !important;
    border-radius: 18px 18px 2px 18px !important;
}
.bubble-left-side::after {
    content: ''; position: absolute; top: 50%; left: 100%;
    transform: translateY(-50%);
    border-width: 10px 0 10px 15px;
    border-style: solid; border-color: transparent transparent transparent #2c3e50;
}

/* â¡ï¸ æ¨¡å¼ Bï¼šå‘å³å™´ç™¼ (é©ç”¨æ–¼å³å´ AI) */
.bubble-right-side {
    left: 110% !important; /* ç‰©ç†åç§»è‡³é ­åƒå³å´ */
    right: auto !important;
    border-radius: 18px 18px 18px 2px !important;
}
.bubble-right-side::after {
    content: ''; position: absolute; top: 50%; right: 100%;
    transform: translateY(-50%);
    border-width: 10px 15px 10px 0;
    border-style: solid; border-color: transparent #2c3e50 transparent transparent;
}

/* ç‰©ç†å•Ÿå‹•ç‹€æ…‹ */
.speech-bubble.active {
    display: block !important;
    opacity: 1 !important;
    transform: translateY(50%) scale(1.05);
}

/* ğŸ•¹ï¸ ç‰©ç†æ§åˆ¶é›†çµå€ (Control Hub) */
.poker-control-hub {
    width: 100%;
    max-width: 1000px;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0px !important; /* ğŸ”¥ ç‰©ç†é›¶è·é›¢ */
    background: linear-gradient(180deg, transparent 0%, rgba(0,0,0,0.4) 100%);
    border-radius: 30px 30px 0 0;
    padding-top: 10px;
}

/* =========================================
   ğŸ•¹ï¸ æˆ°è¡“æŒ‡ä»¤ä¸­å¿ƒï¼šç‰©ç†ç½®é ‚èˆ‡ç‰Œå¡åŒ– (V5.5)
   ========================================= */

/* 1. æŒ‡ä»¤æŒ‰éˆ•ï¼šç‰©ç†æ¨¡ä»¿æ‰‹ç‰Œè¦æ ¼ (48x72px) */
.cmd-card-btn {
    width: 48px !important;
    height: 72px !important;
    border-radius: 6px !important;
    font-size: 14px !important;
    font-weight: 900 !important;
    display: flex !important;
    flex-direction: column !important;
    align-items: center !important;
    justify-content: center !important;
    cursor: pointer !important;
    transition: all 0.15s cubic-bezier(0.175, 0.885, 0.32, 1.275) !important;
    border: 2px solid #fff !important;
    box-shadow: 4px 4px 10px rgba(0,0,0,0.5) !important;
    text-shadow: 1px 1px 2px #000;
}

.cmd-card-btn:active { transform: scale(0.9) translateY(5px); }
.cmd-card-btn:disabled { filter: grayscale(1); opacity: 0.5; cursor: not-allowed; }

/* 2. ç½®é ‚å®¹å™¨ï¼šç¢ºä¿ HUD è“‹åœ¨ç‰Œæ¡Œä¸Š */
#hero-tactical-cluster {
    position: relative;
    z-index: 50000; /* å¼·åˆ¶ç½®é ‚ï¼Œç„¡è¦–ç‰Œæ¡Œ */
    display: flex;
    align-items: flex-end;
    gap: 12px;
    padding: 10px;
    background: radial-gradient(circle at center, rgba(255,255,255,0.05) 0%, transparent 80%);
}


/* =========================================
   ğŸ† æ ¸å¿ƒä¿®æ­£ï¼šé›™å±¤é ‚æ¬„ç‰©ç†å‡çµ (V4.7)
   ========================================= */

:root {
    --header-height: 80px;      /* ç¬¬ä¸€å±¤é«˜åº¦ */
    --adventure-height: 120px;  /* ç¬¬äºŒå±¤é«˜åº¦ */
    --total-pinned-height: 200px; /* ç¸½å‡çµé«˜åº¦ */
}

/* 1. ç¬¬ä¸€å±¤ï¼šç‹€æ…‹åˆ— (å¼·åˆ¶å›æ­¸ Fixed) */
#game-sticky-header {
    position: fixed !important; /* ç‰©ç†é–å®šï¼šç„¡è¦–çˆ¶å±¤æ²å‹• */
    top: 0 !important;
    left: 0;
    width: 100%;
    height: var(--header-height);
    z-index: var(--z-header); /* 1000 */
    background: #2c3e50;
    transform: none !important;
    filter: none !important; /* ç¦æ­¢è‡ªé«”æ¿¾é¡å°è‡´çš„åº§æ¨™ä½ç§» */
}

/* 2. ç¬¬äºŒå±¤ï¼šå†’éšªå ´æ™¯ (ç‰©ç†ç·Šè²¼ç¬¬ä¸€å±¤) */
#adventure-screen {
    position: fixed !important;
    top: var(--header-height) !important; /* ç²¾ç¢ºå°é½Š 80px è™• */
    left: 0;
    width: 100%;
    height: var(--adventure-height);
    z-index: var(--z-adventure); /* 900 */
    border-bottom: 4px solid #444;
    transform: none !important;
}

/* 3. ä¸»å…§å®¹å€ï¼šç‰©ç†é¿è®“ (ä¿®æ­£é¡¯ç¤ºæƒ¡åŒ–) */
.main-wrapper {
    /* å¿…é ˆç­‰æ–¼ 80(Header) + 120(Adventure) + 20(Gap) = 220px */
    margin-top: calc(var(--total-pinned-height) + 20px) !important;
    position: relative;
    z-index: var(--z-content); /* 1 */
}

/* 4. ğŸš€ æ ¸å¿ƒé˜²ç¦¦ï¼šé˜²æ­¢ç‰¹æ•ˆç ´å£ Fixed å®šä½ */
body.low-hp-pulsing-active,
html {
    filter: none !important; /* çµ•å°ç¦æ­¢åœ¨æ ¹ç¯€é»ä½¿ç”¨ filter */
}

/* ç‰¹æ•ˆè«‹æ”¹æ›è¼‰åœ¨ç¨ç«‹çš„ Overlay ä¸Šï¼Œä¸è¦å½±éŸ¿ Body */
.critical-health-vignette {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: var(--z-overlay); /* 6000 */
    pointer-events: none; /* ç‰©ç†ç©¿é€ */
}

</style>


</head>
<body>

<div id="game-sticky-header">
    <div class="status-bar-inner">
        
        <div style="display:flex; align-items:center; gap:15px;">
            <div id="hero-container" style="position: relative; width: 45px; height: 45px; display: flex; align-items: center; justify-content: center;">
                <div id="streak-flame" class="flame-effect"></div> 
                <div id="hero-avatar" style="font-size: 28px; z-index: 2;">ğŸ§™â€â™‚ï¸</div>
                <div id="save-indicator" class="save-spinner">ğŸ’¾</div>
            </div>
            
            <div style="flex: 1;">
                <div style="font-size:14px; font-weight:bold; display: flex; justify-content: space-between; min-width: 180px; gap: 10px;">
                    <div><span id="player-title" style="color:#f1c40f; font-size:12px;">å†’éšªè€…</span> | LV.<span id="player-lv">1</span></div>
                    <div style="font-size: 11px; color: #2ecc71; font-family: monospace;">HP <span id="hero-hp-text">50 / 50</span></div>
                </div>
                
                <div style="background:#444; width:100%; height:6px; border-radius:3px; margin-top:3px; position: relative; overflow: hidden;">
                    <div id="hero-hp-bar" style="width:100%; height:100%; background:#2ecc71; transition: width 0.5s;"></div>
                </div>
                <div style="background: #222; height: 2px; width: 100%; margin-top: 1px;">
                    <div id="exp-bar" style="width: 0%; height: 100%; background: #f1c40f;"></div>
                </div>
            </div>
        </div>

        <div style="display:flex; align-items:center; gap:10px;">
            <div style="text-align: right; color: #f1c40f; font-weight: bold; font-family: monospace; min-width: 60px;">
                ğŸ’° <span id="player-coin">0</span>
            </div>
            <div class="menu-group" style="display: flex; gap: 5px;">
                <button class="game-btn" onclick="toggleMenu('equipment')">âš”ï¸ è£å‚™</button>
                <button class="game-btn" onclick="toggleMenu('inventory')">ğŸ’ èƒŒåŒ…</button>
                <button class="game-btn" onclick="toggleMenu('collection')">ğŸ’ åœ–é‘‘</button>
                <button class="game-btn" onclick="toggleMenu('alchemy')">ğŸ”® éŠé‡‘</button>
                <button class="game-btn" onclick="toggleMenu('map')">ğŸ—ºï¸ åœ°åœ–</button>
                <button class="game-btn" onclick="toggleMenu('log')">ğŸ“œ æ—¥èªŒ</button>
            </div>
        </div>
    </div>
</div>

<div id="chain-display" style="display:none; position: fixed; top: 90px; right: 20px; z-index: 1100; color:#f1c40f; font-weight:bold; font-size:14px; text-shadow: 0 0 5px rgba(255,165,0,0.8); font-family: 'Courier New', monospace;">
    CHAIN <span id="chain-count">0</span> !!
</div>




<div id="adventure-screen">
        <div id="hero-sprite" style="position: absolute; bottom: 10px; left: 10%; width: 40px; height: 40px; z-index: 10; transition: 0.4s;">
            <div id="hero-hat" style="position: absolute; top: -20px; left: 50%; transform: translateX(-50%); font-size: 20px; display: none;">ğŸ‘‘</div>
            <div id="hero-weapon" style="position: absolute; bottom: 5px; right: -12px; font-size: 18px; display: none;">ğŸ—¡ï¸</div>
            <div id="hero-accessory" style="position: absolute; bottom: 5px; left: -10px; font-size: 16px; display: none;">ğŸ›¡ï¸</div>
            <div id="hero-body" style="font-size: 32px; text-align: center;">ğŸš¶</div>
        </div>

        <div id="enemy-sprite" style="position: absolute; bottom: 10px; right: -80px; font-size: 26px; transition: 0.5s; z-index: 5;">ğŸ‘¾</div>

        <div class="ground-scroll" style="position: absolute; bottom: 0; left: 0; width: 200%; height: 12px; background: #7cfc00; border-top: 2px solid #55cc00; z-index: 1; animation: scrollGround 2s linear infinite;"></div>

        <div id="home-interactions">
            <div class="home-touch-zone" onclick="handleHomeAction('bed')">
                <div id="bed-icon" class="home-icon">ğŸ›Œ</div>
                <div id="bed-level-tag" class="home-label">LV.1 ä¼‘æ¯</div>
            </div>
            <div class="home-touch-zone" onclick="handleHomeAction('bookshelf')">
                <div class="home-icon">ğŸ“š</div>
                <div class="home-label">åäººå ‚</div>
            </div>
            <div class="home-touch-zone" onclick="handleHomeAction('table')">
                <div class="home-icon">ğŸ”¨</div>
                <div class="home-label">æ”¹é€ </div>
            </div>
            <div class="home-touch-zone" onclick="handleHomeAction('storage')">
                <div id="vault-icon" class="home-icon">ğŸ§³</div>
                <div id="vault-level-tag" class="home-label">ä¿éšªç®±</div>
            </div>
        </div>

<div id="adventure-interactions" style="position: absolute; bottom: 0; left: 0; width: 100%; height: 100%; display: none; justify-content: space-evenly; align-items: flex-end; padding-bottom: 15px; pointer-events: none; z-index: 20;">
    
    <div class="home-touch-zone" onclick="toggleMenu('map')" style="pointer-events: auto; text-align: center; cursor: pointer; transition: transform 0.2s; width: 60px;">
        <div class="home-icon" style="font-size: 28px; margin-bottom: 5px; filter: drop-shadow(0 0 5px rgba(255,255,255,0.8));">ğŸ—ºï¸</div>
        <div class="home-label" style="font-size: 10px; background: rgba(0,0,0,0.6); color: #fff; padding: 2px 6px; border-radius: 10px; white-space: nowrap;">åˆ‡æ›å€åŸŸ</div>
    </div>
    
    <div class="home-touch-zone" onclick="checkEncounter()" style="pointer-events: auto; text-align: center; cursor: pointer; transition: transform 0.2s; width: 60px;">
        <div class="home-icon" style="font-size: 28px; margin-bottom: 5px; filter: drop-shadow(0 0 5px rgba(255,0,0,0.8));">âš”ï¸</div>
        <div class="home-label" style="font-size: 10px; background: #c0392b; color: #fff; padding: 2px 6px; border-radius: 10px; white-space: nowrap;">å°‹æ‰¾é­”ç‰©</div>
    </div>

    <div class="home-touch-zone" onclick="travelTo('Home')" style="pointer-events: auto; text-align: center; cursor: pointer; transition: transform 0.2s; width: 60px;">
        <div class="home-icon" style="font-size: 28px; margin-bottom: 5px; filter: drop-shadow(0 0 5px rgba(243, 156, 18, 0.8));">â›º</div>
        <div class="home-label" style="font-size: 10px; background: rgba(0,0,0,0.6); color: #fff; padding: 2px 6px; border-radius: 10px; white-space: nowrap;">æ’¤é€€å›ç‡Ÿ</div>
    </div>

</div>


    </div>


<div class="main-wrapper">
        <main class="content-card">
    
    <div style="padding: 20px 20px 0 20px;">
        <h1 class="article-title" id="article-title-display" style="margin: 0 0 15px 0; font-size: 24px;">æ­¡è¿ä¾†åˆ° Tabi-Satori V4</h1>
        
        <div style="display:flex; gap:10px; margin-bottom:15px; flex-wrap: wrap;">
            <button class="btn-nhk" onclick="speakTextFromId('article-view-main')">ğŸ”Š æœ—è®€æœ¬æ–‡</button>
            <button class="btn-nhk" id="toggle-ruby" onclick="document.body.classList.toggle('hide-ruby')">æ¼¢å­—ã®èª­ã¿æ–¹ã‚’æ¶ˆã™</button>
            <button class="btn-nhk" style="background: var(--nhk-green); color: white; border-color: var(--nhk-green);" onclick="openFlashcards()">ğŸ—‚ï¸ è¤‡ç¿’ä¸­å¿ƒ</button>
        </div>
    </div>

    <div style="flex: 1; overflow-y: auto; padding: 0 20px 20px 20px; scroll-behavior: smooth;">
        
        <div id="welcome-screen" style="text-align: center; padding: 40px 0;">
            <div style="font-size: 80px; margin-bottom: 20px; animation: float 3s infinite ease-in-out;">ğŸ°</div>
            <p style="color: #7f8c8d; font-size: 16px; line-height: 1.6;">
                é€™è£¡æ˜¯çŸ¥è­˜çš„èµ·é»ã€‚<br>è«‹å¾å³å´æ³¨å…¥ <b>ç‡ƒæ–™åŒ… (JSON)</b> ä»¥å±•é–‹å†’éšªã€‚
            </p>
        </div>

        <div id="learning-content-area" style="display: none;">
            </div>

    </div>

    <div id="flashcard-hub" style="display:none; position: absolute; top:0; left:0; width:100%; height:100%; background: #fff; z-index: 50; flex-direction: column;">
    <div style="padding: 15px; border-bottom: 1px solid #eee; display:flex; justify-content:space-between; align-items:center; background: #f9f9f9;">
        <h2 style="margin:0; font-size: 18px;">ğŸ—‚ï¸ æ™ºèƒ½è¤‡ç¿’ä¸­å¿ƒ</h2>
        <div style="display:flex; gap:10px; align-items:center;">
            <select id="card-mode" class="game-btn" style="background:#fff; color:#333; border:1px solid #ddd;">
                <option value="jp">æ—¥èª â†’ ä¸­æ–‡</option>
                <option value="ch">ä¸­æ–‡ â†’ æ—¥èª</option>
            </select>
            <select id="card-limit" class="game-btn" style="background:#fff; color:#333; border:1px solid #ddd;">
                <option value="10">10 å¼µ</option>
                <option value="20">20 å¼µ</option>
                <option value="0">å…¨éƒ¨</option>
            </select>
            <button onclick="loadFlashcards()" class="game-btn" style="background:var(--nhk-green); color:white;">ğŸ”„ é‡æŠ½</button>
        </div>
        <button onclick="closeFlashcards()" style="background:none; border:none; font-size: 18px; cursor:pointer;">âœ•</button>
    </div>

    <div style="padding: 10px 20px; background:#fff;">
        <div style="background:#eee; height:10px; border-radius:5px; overflow:hidden;">
            <div id="review-progress-bar" style="width:0%; height:100%; background:var(--nhk-green); transition:0.3s;"></div>
        </div>
        <div id="review-status-text" style="font-size:10px; color:#888; margin-top:5px; text-align:right;">å·²è¤‡ç¿’ï¼š0 / 0</div>
    </div>

    <div style="flex:1; overflow-y: auto; padding: 20px;">
        <div id="vocab-flashcard-container" class="vocab-grid"></div>
        <div id="phrase-flashcard-container" class="vocab-grid" style="margin-top:20px;"></div>
    </div>
</div>

</main>

        <aside>

            <div class="side-module">
                <div class="side-header">âš™ï¸ èªéŸ³é€Ÿåº¦</div>
                <div class="side-content">
                    <input type="range" id="speed-range" min="0.5" max="1.5" step="0.1" value="1.0" style="width:100%;">
                    <div id="speed-label" style="text-align:center; font-weight:bold;">1.0x</div>
                </div>
            </div>


            <div class="side-module cloud-side-box">
                <div class="side-header">
                    <span>ğŸŒ ç³»çµ±é›²ç«¯ç‹€æ…‹</span>
                    <span id="cloud-status" class="status-dot">æœªé€£ç·š</span>
                </div>
                <div class="side-content">
                    <div class="cloud-actions" style="display:flex; gap:5px; flex-wrap:wrap;">
                        <button class="action-btn auth-btn-blue" id="auth-btn" onclick="handleAuthClick()">ğŸ”‘ ç™»å…¥ Google</button>
                        <button class="action-btn sync-btn-green" id="sync-btn" onclick="syncToCloud()" style="display:none;">ğŸ”„ ç«‹å³å‚™ä»½</button>
                    </div>
                    <div id="last-sync-time" style="font-size: 10px; color: #999; margin-top: 8px; text-align: center;">è‡ªå‹•åŒæ­¥ï¼šç‰©ç†ç›£æ§ä¸­</div>
                </div>
            </div>

            <div class="side-module" id="cloud-manager" style="display:none;">
                <div class="side-header">â˜ï¸ é›²ç«¯å‚™ä»½ç®¡ç†</div>
                <div class="side-content">
                    <div id="cloud-file-list" style="max-height: 200px; overflow-y: auto;"></div>
                    <button class="action-btn" onclick="listCloudFiles()" style="background:#666; font-size:11px; margin-top:10px;">ğŸ”„ åˆ·æ–°æ¸…å–®</button>
                </div>
            </div>

            <div class="side-module">
                <div class="side-header">ğŸ“¦ é«˜éšç‡ƒæ–™åŒ…æ³¨å…¥</div>
                <div class="side-content">
                    <textarea id="fuel-input" placeholder="è²¼ä¸Š JSON å…§å®¹..." style="width:100%; height:80px; box-sizing:border-box;"></textarea>
                    <button class="action-btn" onclick="injectFuel()" style="margin-top:5px;">ç«‹å³æ³¨å…¥å­¸ç¿’</button>
                </div>
            </div>

<div id="intel-panel" class="side-module" style="border: 2px solid var(--nhk-green); box-shadow: 0 0 15px rgba(0, 160, 233, 0.2); position: relative; overflow: hidden;">
    
    <div id="radar-scan-line" style="position:absolute; top:0; left:0; width:100%; height:100%; background:linear-gradient(to bottom, transparent, rgba(0,255,0,0.1), transparent); animation: radarScan 2s infinite linear; pointer-events:none; z-index:1;"></div>

    <div class="side-header" style="background: var(--nhk-light-green); display: flex; justify-content: space-between; align-items: center; position:relative; z-index:2;">
        <span style="color: #2c3e50; font-weight:bold;">ğŸ“¡ æˆ°è¡“é›·é”</span>
        <span id="intel-diff" style="font-size: 10px; background: #555; color: #aaa; padding: 1px 6px; border-radius: 4px;">SCANNING</span>
    </div>
    
    <div class="side-content" style="text-align: center; padding-top: 15px; position:relative; z-index:2;">
        <div id="intel-sprite" style="font-size: 60px; filter: grayscale(1) opacity(0.5); transition: 0.3s;">ğŸ“¡</div>
        
        <div id="intel-name" style="font-weight: 900; font-size: 16px; margin-top: 5px; color: #999;">æ­£åœ¨æœå°‹ä¿¡è™Ÿ...</div>
        
        <div style="margin: 15px 0; font-size: 11px; display: flex; justify-content: center; gap: 8px;">
            <span id="intel-element" style="background: #eee; border: 1px solid #ddd; padding: 3px 8px; border-radius: 12px; color:#999;">
                ä¿¡è™Ÿå¾®å¼±
            </span>
            <span id="intel-hp" style="background: #eee; color: #999; border: 1px solid #ddd; padding: 3px 8px; border-radius: 12px;">
                HP: --
            </span>
        </div>

        <div style="background: rgba(0,0,0,0.03); padding: 8px; border-radius: 6px; margin-bottom: 10px; min-height: 45px; display:flex; align-items:center; justify-content:center;">
            <div id="intel-loots" style="font-size: 10px; color:#bbb;">[ ç­‰å¾…ç›®æ¨™é–å®š ]</div>
        </div>

        <button id="btn-intel-action" class="action-btn" onclick="triggerEncounterFromIntel()" disabled 
                style="background: #95a5a6; width: 100%; font-size: 14px; box-shadow: none; transition: 0.3s; cursor: not-allowed;">
            âš ï¸ å°šæœªé–å®šç›®æ¨™
        </button>
    </div>
</div>

            <div id="intel-panel" class="side-module" style="display:none; border: 2px solid var(--nhk-green);">
                <div class="side-header" style="background: var(--nhk-light-green); display: flex; justify-content: space-between;">
                    <span>ğŸ“¡ æˆ°å‰æƒ…å ±</span>
                    <span id="intel-diff" style="font-size: 10px; background: #333; color: #fff; padding: 1px 5px; border-radius: 3px;">N5</span>
                </div>
                <div class="side-content" style="text-align: center;">
                    <div id="intel-sprite" style="font-size: 50px;">ğŸ‘¾</div>
                    <div id="intel-name" style="font-weight: bold; font-size: 16px;">é­”ç‰©åç¨±</div>
                    <div style="margin: 10px 0; font-size: 11px;">
                        <span id="intel-element" style="background: #eee; padding: 2px 5px; border-radius: 4px;">å±¬æ€§ï¼šç„¡</span>
                        <span id="intel-hp" style="background: #ffebee; color: #c62828; padding: 2px 5px; border-radius: 4px;">HP: ??</span>
                    </div>
                    <div id="intel-loots" style="font-size: 18px;"></div>
                    <button class="action-btn" onclick="triggerEncounterFromIntel()" style="background: #e74c3c; margin-top: 10px;">âš”ï¸ ç«‹å³è¨ä¼</button>
                </div>
            </div>

            <div class="side-module">
                <div class="side-header">ğŸ“œ å…¬æœƒä½ˆå‘Šæ¬„</div>
                <div class="side-content">
                    <div id="quest-description" style="font-size: 12px; font-weight: bold; margin-bottom: 5px; cursor: pointer; text-decoration: underline dotted;">æ­£åœ¨è¯çµ¡å…¬æœƒ...</div>
                    <div class="progress-container" style="background:#eee; height:6px; border-radius:3px;">
                        <div id="quest-progress-bar" class="progress-fill" style="width: 0%; height:100%; background:#e67e22;"></div>
                    </div>
                    <div style="display: flex; justify-content: space-between; font-size: 10px; margin-top: 5px;">
                        <span id="quest-status">0 / 0</span>
                        <span id="quest-reward" style="color: #f1c40f; display: none;">âœ¨ EXP x2 Active</span>
                    </div>
                    <button class="game-btn" onclick="refreshDailyQuest()" style="width: 100%; margin-top: 8px; font-size: 11px;">ğŸ”„ åˆ·æ–° (300G)</button>
                </div>
            </div>


<div class="side-module">
    <div class="side-header" style="background: linear-gradient(90deg, #2c3e50, #4ca1af); color: white;">
        ğŸ“° AI æ–°èè½‰è­¯æ©Ÿ
    </div>
    <div class="side-content">
        <div style="display:flex; gap:5px; margin-bottom:5px;">
            <select id="news-level" style="flex:1; padding:5px; border:1px solid #ddd; border-radius:4px;">
                <option value="N5">N5 (å…¥é–€)</option>
                <option value="N4">N4 (åˆç´š)</option>
                <option value="N3">N3 (ä¸­ç´š)</option>
                <option value="N2">N2 (ä¸Šç´š)</option>
                <option value="N1">N1 (æ·±æ·µ)</option>
            </select>
        </div>
        <textarea id="news-input" placeholder="è«‹åœ¨æ­¤è²¼ä¸Šæ—¥æ–‡æ–°èåŸæ–‡..." style="width:100%; height:60px; box-sizing:border-box; margin-bottom:5px; font-size:11px;"></textarea>
        
        <button class="action-btn" onclick="copyNewsPrompt()" style="background: #e67e22; font-size: 12px;">
            ğŸ“‹ è¤‡è£½ AI æŒ‡ä»¤ (Copy Prompt)
        </button>
        <div style="font-size:9px; color:#999; margin-top:5px; text-align:center;">
            è¤‡è£½å¾Œè²¼çµ¦ ChatGPT/Geminiï¼Œå†å°‡ç”Ÿæˆçš„ JSON è²¼å›ä¸‹æ–¹æ³¨å…¥å€ã€‚
        </div>
    </div>
</div>


            <div class="side-module">
                <div class="side-header">ğŸ“š æˆ‘çš„æ–‡ç« åº«</div>
                <div class="side-content" id="history-list" style="max-height: 300px; overflow-y: auto;"></div>
            </div>
            
            <div style="padding: 10px;">
                <button class="game-btn" onclick="cleanUpFuelPacks()" style="width: 100%; background: #95a5a6; font-size: 11px;">ğŸ§¹ æ•´ç†é‡è¤‡ç« ç¯€</button>
            </div>
            

        </aside>



    </div>


<div id="game-popups-container">


<div id="equipment-popup" class="game-popup">
        <div class="popup-header">
            <h3>âš”ï¸ è§’è‰²è£å‚™</h3>
            <button onclick="toggleMenu('equipment')">âœ•</button>
        </div>
        <div class="popup-content-scroll">
            
            <div class="equip-stats-preview">
                <div>ğŸ’¥ ç¸½æ”»æ“Š: <span id="eq-total-atk" style="color:#e74c3c;">0</span></div>
                <div>ğŸ›¡ï¸ ç¸½é˜²ç¦¦: <span id="eq-total-def" style="color:#3498db;">0</span></div>
            </div>

            <div class="paper-doll-grid">
                
                <div class="doll-col side-col">
                    <div class="slot-wrapper">
                        <div class="slot-label">æ‰‹å¥—</div>
                        <div class="equip-slot" id="slot-gloves" onclick="openEquipSelector('gloves')"></div>
                    </div>
                    <div class="slot-wrapper">
                        <div class="slot-label">ä¸»æ‰‹æ­¦å™¨</div>
                        <div class="equip-slot" id="slot-weapon" onclick="openEquipSelector('weapon')"></div>
                    </div>
                    <div class="slot-wrapper">
                        <div class="slot-label">æˆ’æŒ‡ I</div>
                        <div class="equip-slot" id="slot-ring1" onclick="openEquipSelector('ring1', 'ring')"></div>
                    </div>
                </div>
                
                <div class="doll-col center-col">
                    <div class="slot-wrapper">
                        <div class="slot-label">é ­éƒ¨</div>
                        <div class="equip-slot" id="slot-head" onclick="openEquipSelector('head')"></div>
                    </div>
                    <div class="slot-wrapper">
                        <div class="slot-label">ç›”ç”²</div>
                        <div class="equip-slot" id="slot-body" onclick="openEquipSelector('body')"></div>
                    </div>
                    <div class="slot-wrapper">
                        <div class="slot-label">è¤²ç”²</div>
                        <div class="equip-slot" id="slot-legs" onclick="openEquipSelector('legs')"></div>
                    </div>
                    <div class="slot-wrapper">
                        <div class="slot-label">é‹å­</div>
                        <div class="equip-slot" id="slot-boots" onclick="openEquipSelector('boots')"></div>
                    </div>
                </div>

                <div class="doll-col side-col">
                    <div class="slot-wrapper">
                        <div class="slot-label">é …éŠ</div>
                        <div class="equip-slot" id="slot-necklace" onclick="openEquipSelector('necklace')"></div>
                    </div>
                    <div class="slot-wrapper">
                        <div class="slot-label">å‰¯æ‰‹</div>
                        <div class="equip-slot" id="slot-offhand" onclick="openEquipSelector('offhand')"></div>
                    </div>
                    <div class="slot-wrapper">
                        <div class="slot-label">æˆ’æŒ‡ II</div>
                        <div class="equip-slot" id="slot-ring2" onclick="openEquipSelector('ring2', 'ring')"></div>
                    </div>
                </div>

            </div>

            <div class="rune-section">
                <div class="section-title">ğŸ”® ç¬¦æ–‡å…±é³´ (Runes)</div>
                <div class="rune-container">
                    <div class="slot-wrapper"><div class="slot-label">I</div><div class="equip-slot rune" id="slot-rune1" onclick="openEquipSelector('rune1', 'rune')"></div></div>
                    <div class="slot-wrapper"><div class="slot-label">II</div><div class="equip-slot rune" id="slot-rune2" onclick="openEquipSelector('rune2', 'rune')"></div></div>
                    <div class="slot-wrapper"><div class="slot-label">III</div><div class="equip-slot rune" id="slot-rune3" onclick="openEquipSelector('rune3', 'rune')"></div></div>
                    <div class="slot-wrapper"><div class="slot-label">IV</div><div class="equip-slot rune" id="slot-rune4" onclick="openEquipSelector('rune4', 'rune')"></div></div>
                    <div class="slot-wrapper"><div class="slot-label">V</div><div class="equip-slot rune" id="slot-rune5" onclick="openEquipSelector('rune5', 'rune')"></div></div>
                </div>
            </div>

            <div id="equip-selector-panel" class="equip-selector-overlay" style="display:none;">
                <div class="selector-header">
                    <span id="selector-title">é¸æ“‡è£å‚™</span>
                    <button onclick="closeEquipSelector()">âœ•</button>
                </div>
                <div id="selector-list" class="item-grid"></div>
                <button onclick="unequipCurrentSlot()" class="game-btn" style="width:100%; margin-top:10px; background:#c0392b; border-color:#e74c3c;">å¸ä¸‹è£å‚™</button>
            </div>

        </div>
    </div>


<div id="inventory-popup" class="game-popup">
        <div class="popup-header">
            <h3>ğŸ’ å‹‡è€…çš„èƒŒåŒ…</h3>
            <button onclick="toggleMenu('inventory')">âœ•</button>
        </div>
        <div class="popup-content-scroll inventory-scroll-area">
            
            <div class="inventory-section">
                <div class="section-title">âš”ï¸ ç¥å…µåˆ©å™¨</div>
                <div id="inv-equipment-list" class="item-grid"></div>
            </div>

            <div class="inventory-section">
                <div class="section-title" style="color: #9b59b6;">ğŸ“¦ ç¥å™¨èˆ‡ç‰¹æ®Š</div>
                <div id="inv-artifact-list" class="item-grid"></div>
            </div>

            <div class="inventory-section">
                <div class="section-title">ğŸ’ å†’éšªç´ æ</div>
                <div id="inv-material-list" class="item-grid"></div>
            </div>
            
            <div class="inventory-section">
                <div class="section-title">ğŸ§ª ç…‰é‡‘è—¥æ°´</div>
                <div id="inv-potion-list" class="item-grid"></div>
            </div>

        </div>
    </div>

    <div id="collection-popup" class="game-popup">
        <div class="popup-header">
            <h3>ğŸ’ å‚³èªªè£å‚™åœ–é‘‘</h3>
            <button onclick="toggleMenu('collection')">âœ•</button>
        </div>
        <div style="background: rgba(0,0,0,0.2); padding: 8px 20px; font-size: 11px; color: #aaa; display: flex; justify-content: space-between; border-bottom: 1px solid rgba(255,255,255,0.05);">
            <span>è’é›†é€²åº¦</span>
            <span id="collect-progress" style="color: #f1c40f; font-weight: bold;">0 / 0</span>
        </div>
        <div class="popup-content-scroll">
            <div id="collection-grid" class="item-grid"></div>
        </div>
    </div>

    <div id="alchemy-popup" class="game-popup">
        <div class="popup-header">
            <h3>ğŸ”® éŠé‡‘å·¥åŠ</h3>
            <button onclick="toggleMenu('alchemy')">âœ•</button>
        </div>
        
        <div class="alchemy-tabs">
            <button class="al-tab-btn active" onclick="switchAlchemyTab('synthesis')">ğŸ§ª åˆæˆ</button>
            <button class="al-tab-btn" onclick="switchAlchemyTab('refine')">âš’ï¸ ç²¾ç…‰</button>
        </div>

        <div class="popup-content-scroll">
            
            <div id="view-synthesis">
                <div class="alchemy-slot-container">
                    <div class="alchemy-slot" id="slot-0" onclick="removeFromAlchemy(0)">?</div>
                    <div style="font-size: 20px; color: #555; align-self: center;">+</div>
                    <div class="alchemy-slot" id="slot-1" onclick="removeFromAlchemy(1)">?</div>
                    <div style="font-size: 20px; color: #555; align-self: center;">+</div>
                    <div class="alchemy-slot" id="slot-2" onclick="removeFromAlchemy(2)">?</div>
                </div>
                <button onclick="executeAlchemy()" id="mix-btn" class="mix-btn" disabled>ğŸ”¥ é–‹å§‹åˆæˆ</button>
                <div style="text-align:center; font-size:10px; color:#666; margin-top:5px;">æç¤ºï¼š3 å€‹ç¢å¡Šå¯åˆæˆ 1 å€‹å®Œæ•´ç²¾ç…‰çŸ³</div>
            </div>

            <div id="view-refine" style="display:none;">
                <div class="refine-workbench">
                    <div class="refine-slot-group">
                        <div class="refine-slot" id="refine-target-slot" onclick="clearRefineTarget()">
                            <span style="font-size:24px; opacity:0.3;">âš”ï¸</span>
                            <span style="font-size:10px; color:#666;">è£å‚™</span>
                        </div>
                        <div style="font-size:20px; color:#f1c40f;">âœ</div>
                        <div class="refine-slot material" id="refine-stone-slot" onclick="clearRefineStone()">
                            <span style="font-size:24px; opacity:0.3;">ğŸ’</span>
                            <span style="font-size:10px; color:#666;">ç²¾ç…‰çŸ³</span>
                        </div>
                    </div>

                    <div class="refine-info">
                        <div style="display:flex; justify-content:space-between; margin-bottom:2px;">
                            <span>æˆåŠŸç‡: <b id="refine-rate-text" style="color:#2ecc71;">--%</b></span>
                            <span id="refine-risk-text" style="color:#e74c3c;"></span>
                        </div>
                        <div class="rate-bar-bg"><div id="refine-rate-bar" class="rate-bar-fill" style="width:0%; background:#2ecc71;"></div></div>
                        <div id="refine-preview-text" style="margin-top:5px; color:#f1c40f; font-weight:bold;">è«‹æ”¾å…¥è£å‚™èˆ‡ç²¾ç…‰çŸ³</div>
                    </div>

                    <button onclick="executeRefine()" id="refine-btn" class="mix-btn" style="background: linear-gradient(45deg, #e67e22, #f39c12);" disabled>âš’ï¸ æ•²æ“Šç²¾ç…‰</button>
                </div>
            </div>

            <div style="margin-top: 20px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 15px;">
                <div class="section-title" id="alchemy-list-title">ğŸ“¦ å¯æŠ•å…¥çš„ç´ æ</div>
                <div id="alchemy-inventory" class="alchemy-grid"></div>
            </div>
        </div>
    </div>


<div id="adventure-map-popup" class="game-popup">
    <div class="popup-header">
        <h3>ğŸ—ºï¸ å†’éšªå‚³é€é–€</h3>
        <button onclick="toggleMenu('map')">âœ•</button>
    </div>
    
    <div style="height: 4px; background: #222; width: 100%;">
        <div id="map-hero-pos-bar" style="height: 100%; width: 0%; background: #f1c40f; transition: width 0.5s;"></div>
    </div>

    <div id="map-portal-list" class="popup-content-scroll map-content" style="padding: 15px;">
        </div>
</div>

<div id="adventure-log-popup" class="game-popup">
        <div class="popup-header">
            <h3>ğŸ“œ å†’éšªæ—¥èªŒ</h3>
            <button onclick="toggleMenu('log')">âœ•</button>
        </div>
        <div class="popup-content-scroll" id="log-list" style="font-family: 'Courier New', monospace;">
            </div>
    </div>

</div>





<div id="battle-scene" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index:5000; flex-direction:column; align-items:center; justify-content:center; color:#fff;">
        <div id="battle-monster-zone" style="text-align:center;">
            <div id="battle-monster-sprite" style="font-size:80px; transition:0.2s;">ğŸ‘¾</div>
            <div style="width:150px; height:10px; border:2px solid #fff; margin:10px auto; border-radius:5px; overflow:hidden;">
                <div id="monster-hp-bar" style="width:100%; height:100%; background:#f00; transition:0.3s;"></div>
            </div>
            <div id="monster-name-label" style="font-size:14px;">Unknown</div>
        </div>

        <div style="width:90%; max-width:500px; border:4px solid #fff; padding:15px; background:#000; margin:20px 0; min-height:80px; border-radius:8px;">
            <div id="battle-msg" style="font-size:18px; line-height:1.5;">æˆ°é¬¥é–‹å§‹ï¼</div>
        </div>

        <div style="width:90%; max-width:500px; display:grid; grid-template-columns: 120px 1fr; gap:10px;">
            <div style="border:4px solid #fff; padding:10px; background:#111; border-radius:8px;">
                <div style="font-size:12px; color:#aaa;">å‹‡è€… LV.<span id="battle-hero-lv">1</span></div>
                <div style="font-size:18px; color:#0f0; font-weight:bold;">HP <span id="hero-hp-val">100</span></div>
                <div style="width:100%; height:6px; background:#444; margin-top:5px;">
                    <div id="hero-hp-bar" style="width:100%; height:100%; background:#0f0; transition:0.3s;"></div>
                </div>
            </div>
            <div id="battle-quiz-zone" style="border:4px solid #fff; padding:10px; background:#222; border-radius:8px; overflow-y:auto; max-height:200px;">
                </div>
        </div>
    </div>

    <div id="victory-screen" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:9999; color:white; flex-direction:column; align-items:center; justify-content:center; text-align:center;">
        <h1 style="font-size: 60px; color: #f1c40f; margin-bottom: 0; text-shadow: 0 0 20px gold;">VICTORY</h1>
        <p id="vic-boss-name" style="font-size: 20px; color: #eee;"></p>
        <div style="background:rgba(255,255,255,0.1); padding:20px; border-radius:15px; min-width:300px; margin:20px 0;">
            <div style="font-size:24px; margin:10px 0;">ç²å¾— EXP +<span id="vic-exp" style="color:gold;">0</span></div>
            <div style="font-size:24px; margin:10px 0;">ç²å¾— ğŸ’° +<span id="vic-coin" style="color:gold;">0</span></div>
            <div id="vic-loot" style="font-size:18px; color:#2ecc71; margin-top:10px;"></div>
        </div>
        <button class="btn-nhk" style="background:#f1c40f; color:#000; border:none; padding:10px 40px; border-radius:30px; font-weight:bold; cursor:pointer;" onclick="closeVictory()">ç¢ºèª (OK)</button>
    </div>

    <div id="danger-overlay" class="danger-vignette" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:6000; box-shadow: inset 0 0 100px rgba(255,0,0,0);"></div>





<script>

/* --- Google Drive åŒæ­¥è¨­å®š --- */
const CLIENT_ID = '573692027983-id02l47lh4dmdvaudvqtvsh5u48bpvua.apps.googleusercontent.com'; // éœ€åœ¨ Google Cloud Console ç”³è«‹
const SCOPES = 'https://www.googleapis.com/auth/drive.file';

// 1. å…ˆå»ºç«‹ç©ºæ®¼ç‰©ä»¶ï¼Œé˜²æ­¢å¾ŒçºŒæ›è¼‰æ–¹æ³•æ™‚å™´ç™¼ "is not defined"
window.POKER_AI = {};

/**
 * ğŸƒ ç‰©ç†æ ¸å¿ƒï¼šç‰Œå±€æ•¸æ“šä¸­æ¨ (åŠ å›ºç‰ˆ)
 * ä¿®æ­£ï¼šæ–°å¢è¨˜ç‰Œå™¨ã€ç•°èƒ½ç·©è¡ã€ç™¼çƒæ¬Šæ¨™è¨˜èˆ‡åŒ…åœç¶²é–‹é—œ
 */
let pokerGame = {
    // 1. ğŸ”¥ ã€ç‰Œçµ„å¯¦é«”ã€‘
    deck: [],          // åŸå§‹æ´—ç‰Œå †
    playedCards: [],   // ç‰©ç†å›æ”¶æ¡¶ (ç”¨æ–¼æƒ…å ±åµå¯Ÿç•°èƒ½èˆ‡è¨ˆç®—å‰©é¤˜å¤§ç‰Œ)
    
    // 2. ğŸ‘¤ ã€è§’è‰²æ•¸æ“šã€‘
    players: [
        { id: "player", name: "å‹‡è€…", cards: [], rank: "citizen", score: 0, isPassed: false, lastTalk: "" },
        { id: "ai1", name: "å¢®è½è²´æ—", cards: [], rank: "noble", score: 0, isPassed: false, lastTalk: "" },
        { id: "ai2", name: "è™•åˆ‘äºº", cards: [], rank: "king", score: 0, isPassed: false, lastTalk: "" },
        { id: "ai3", name: "è¢«éºå¿˜è€…", cards: [], rank: "slave", score: 0, isPassed: false, lastTalk: "" }
    ],
    
    // 3. âš–ï¸ ã€è¦å‰‡èˆ‡æ¬Šé™ã€‘
    ranks: ["king", "noble", "citizen", "slave"],
    isFirstRound: true,   // æ˜¯å¦ç‚ºæ•´å ´éŠæˆ²çš„ç¬¬ä¸€å±€ (ç‰©ç†æ±ºå®šæ¢…èŠ± 3 ç¾©å‹™)
    gameActive: false,    // ç‰Œå±€ç‰©ç†é‹è¡Œé–‹é—œ
    
    // 4. ğŸŸï¸ ã€æˆ°å ´å³æ™‚ç‹€æ…‹ã€‘
    turn: 0,              // ç•¶å‰è¡Œå‹•è€…ç´¢å¼•
    passCount: 0,         // é€£çºŒæ£„æ¬Šè¨ˆæ•¸ (é” 3 æ¬¡å‰‡ç‰©ç†æ·¨ç©ºæˆ°å ´)
    currentTable: [],     // ç›®å‰æ¡Œé¢ä¸Šçš„å¡ç‰‡ç‰©ä»¶
    lastMoveCards: [],    // æœ€å¾Œä¸€æ‰‹çš„å¯¦é«”ç‰Œçµ„ (ç”¨æ–¼æ¸²æŸ“)
    lastMovePattern: null,// æœ€å¾Œä¸€æ‰‹çš„ç‰Œå‹ç‰©ä»¶ (åŒ…å« type, power, sub)
    lastPlayerName: "NONE", // ç‰©ç†é–å®šé ˜å…ˆè€…åç¨± (NONE ä»£è¡¨æˆ°å ´æ·¨ç©º)
    
    // 5. ğŸ­ ã€Roguelike ç•°èƒ½åœ–å±¤ã€‘
    activeBoon: null,     // å‹‡è€…æœ¬å±€é¸æ“‡çš„ç•°èƒ½ ID
    playerPot: 0,         // æœ¬å±€ç´¯ç©çæ±  (å«é–€ç¥¨èˆ‡åŠ æˆ)
    playerTotalWins: 0,   // æœ¬æ¬¡é€²å…¥ç‹åœ‹å¾Œçš„é€£å‹è¨ˆæ•¸
    isKingSiege: false,   // ğŸ”¥ åœ‹ç‹åŒ…åœç¶²ç‰©ç†é»ç«é–‹é—œ
    forceSiege: false,    // å¼·åˆ¶è§¸ç™¼åŒ…åœç¶²æ¨™è¨˜ (åµéŒ¯ç”¨)
    
    // 6. ğŸ’€ ã€ç¦å¿Œé“å…·èˆ‡è™•ç½°æ¨™è¨˜ã€‘
    nextAiMustPass: false, // è–æ—¨æ•ˆæœ
    soulPenaltyActive: false // éˆé­‚é€æ”¯è™•ç½°æ¨™è¨˜
};

// --- â˜ï¸ ç‰©ç†å…¨åŸŸç‹€æ…‹æ——æ¨™ ---
window.gapiInited = false;
window.gisInited = false;
window.tokenClient = null;
pokerGame.playedCards = []; // æ¯å±€é‡ç½®

window.selectedCards = [];      // é¸å–ç·©è¡ï¼Œç¢ºä¿æ‰‹å‹•é»é¸èˆ‡è¼”åŠ©æŒ‰éˆ•å…±ç”¨
window.isLogDrawerOpen = false; // æ—¥èªŒè¦–çª—ç‹€æ…‹ï¼Œç¢ºä¿é‡ç¹ªå¾Œä¸æœƒè‡ªå‹•é—œé–‰
window.battleLogBuffer = [];    // æ­·å²æ—¥èªŒç·©è¡ï¼Œç¢ºä¿è¨Šæ¯ä¸å› æ¸²æŸ“æ¶ˆå¤±
window.pokerAITimer = null;     // AI æ€è€ƒè¨ˆæ™‚å™¨æ§åˆ¶ï¼Œé˜²æ­¢å¤šé‡è¨ˆæ™‚å™¨ç–ŠåŠ 
window.cloudFileId = null;


/**
 * ğŸ° ç‹åœ‹æ³•å¾‹ï¼šå¤§ä¸€çµ±ç¶“æ¿Ÿå»ºè¨­èˆ‡æš´æ”¿ç³»çµ±
 * æ•´åˆé»ï¼š
 * 1. æ ¸å¿ƒç¶“æ¿ŸæŒ‡æ¨™ (è§£æ±º 1938 å ±éŒ¯)
 * 2. åœ‹ç‹ç§åæ¬Šé™ (3é€£èŠé–€æª»)
 * 3. è¨­æ–½è‡ªå‹•å‡ç´šæ•¸æ“š
 */
window.kingdomSystem = {
    // --- ğŸ’° æ ¸å¿ƒç¶“æ¿ŸæŒ‡æ¨™ (ç‰©ç†é–å®šï¼Œé˜²ç¦¦ UI å´©æ½°) ---
    playerInvestmentTotal: window.kingdomSystem?.playerInvestmentTotal || 0,
    totalDividendsIssued: window.kingdomSystem?.totalDividendsIssued || 0,
    
    // --- ğŸ›ï¸ ç‹åœ‹è³‡ç”¢èˆ‡æš´æ”¿åƒæ•¸ ---
    treasury: window.kingdomSystem?.treasury || 1000000, 
    investmentCost: 2000,
    siphonRate: 0.10,        // æ¯æ¬¡ç§å 10%
    streakThreshold: 3,      // éœ€é€£èŠ 3 æ¬¡

    // --- ğŸ—ï¸ ç¡¬é«”è¨­æ–½å‡ç´šçŸ©é™£ ---
    upgrades: window.kingdomSystem?.upgrades || {
        vault:  { name: "ä¸­å¤®é‡‘åº«", lv: 0, max: 1000 },
        mint:   { name: "çš‡å®¶é€ å¹£å» ", lv: 0, max: 1000 },
        intel:  { name: "åœ°ä¸‹æƒ…å ±å±€", lv: 0, max: 1000 },
        trade:  { name: "è¡€ç›Ÿè²¿æ˜“ç«™", lv: 0, max: 1000 },
        arena:  { name: "å¤§ç«¶æŠ€å ´", lv: 0, max: 1000 }
    },

/**
     * ğŸ©¸ ç‰©ç†æ–¹æ³•ï¼šåŸ·è¡Œæš´æ”¿ (ç§åå…¬æ¬¾)
     */
    executeSiphon: function() {
        const hero = pokerGame.players.find(p => p.id === 'player');
        const streak = player.kingStreak || 0;

        // 1. æ¬Šé™æª¢æŸ¥
        if (hero.rank !== 'king') {
            showNotification("ğŸ’€ åªæœ‰åœ‹ç‹èƒ½ç™¼å‹•æš´æ”¿ï¼");
            return;
        }
        if (streak < this.streakThreshold) {
            showNotification(`ğŸš« çµ±æ²»æœªç©©ï¼éœ€ ${this.streakThreshold} é€£èŠ (ç›®å‰: ${streak})`);
            return;
        }

        // 2. é‡‘æµè½‰æ›
        const amount = Math.floor(this.treasury * this.siphonRate);
        if (amount <= 0) {
            showNotification("ğŸšï¸ åœ‹åº«ç©ºè™›ï¼Œç„¡éŒ¢å¯æ‹¿ã€‚");
            return;
        }

        // ğŸ”¥ ã€æ ¸å¿ƒä¿®æ­£ï¼šç‰©ç†å­˜è­‰ã€‘
        // ç´€éŒ„é€™ä¸€æ¬¡ç§åçš„é‡‘é¡ï¼Œä½œç‚ºå¾ŒçºŒã€Œæ•—åŒ—è³ å„Ÿ 200%ã€çš„åŸºæº–
        this.lastSiphonedAmount = amount; 

        this.treasury -= amount;
        player.coin += amount;
        
        // 3. ç‰©ç†ä»£åƒ¹ï¼šæ°‘æ€¨æ²¸é¨°
        pokerGame.forceSiege = true; 
        
        addBattleLog(`ğŸš¨ <b style="color:#ff4d4d;">[æš´æ”¿]</b> åœ‹ç‹æŒªç”¨åœ‹åº« $${amount.toLocaleString()}Gï¼ŒåæŠ—è»æ­£åœ¨é›†çµï¼`);
        if (typeof triggerCheatShatterEffect === 'function') triggerCheatShatterEffect();
        
        // 4. åŒæ­¥èˆ‡æŒä¹…åŒ–
        if (typeof renderPokerTable === 'function') renderPokerTable(document.getElementById('poker-table'));
        if (typeof savePlayerToDB === 'function') savePlayerToDB();
        
        showNotification(`ğŸ’¸ ç§åæˆåŠŸï¼šç²å¾—äº† $${amount.toLocaleString()} Gï¼`);
    }
};


// =========================================
// âš”ï¸ è£å‚™èˆ‡ç´ è³ªä»‹é¢æ¸²æŸ“å¼•æ“ (V5.9.37 ä¿®å¾©ç‰ˆ)
// =========================================

// 1. å…¨åŸŸåˆ†é ç‹€æ…‹
let currentEquipTab = 'equip'; 

// 2. ç‰©ç†åˆ‡æ›å‡½æ•¸ (æ›è¼‰è‡³ window ä»¥ç¢ºä¿ HTML å¯å‘¼å«)
window.switchEquipTab = (tab) => { 
    currentEquipTab = tab; 
    console.log(`%cğŸ”„ [UIåˆ‡æ›] é€²å…¥ ${tab === 'equip' ? 'æ­¦è£' : 'ç´ è³ª'} æ¨¡å¼`, "color: #3498db;");
    renderEquipmentUI(); 
};



// 7. å…¨åŸŸé…é»å‡½æ•¸ (ç¢ºä¿å¯è¢« HTML å‘¼å«)
window.addStatPoint = async (key) => {
    // ç‰©ç†é‡ç®—é»æ•¸ï¼Œç¢ºä¿ä¸è¶…æ”¯
    const s = getCombatPerformance(); 
    if (s.remainingPoints <= 0) {
        showNotification("âŒ é»æ•¸ä¸è¶³ï¼è«‹å‡ç´šç²å–æ›´å¤šé»æ•¸ã€‚");
        return;
    }
    
    // åŸ·è¡ŒåŠ é»
    player.attributes[key]++;
    
    // å³æ™‚ç‰©ç†å­˜æª”èˆ‡é‡ç¹ª
    renderEquipmentUI();
    if (typeof savePlayerToDB === 'function') await savePlayerToDB();
    showNotification(`âœ¨ ${key.toUpperCase()} æå‡ï¼`);
};

// ç¢ºä¿ç›¸ä¾çš„é‹ç®—å‡½æ•¸å­˜åœ¨
if (typeof getCombatPerformance !== 'function') {
    window.getCombatPerformance = function() {
        const attr = player.attributes || { str: 0, sta: 0, agi: 0, int: 0, block: 0, eva: 0, p_eva: 0 };
        const equipDef = player.equips?.body?.stats?.def || 0; 
        const finalDefPoints = (equipDef + (attr.sta * 2)) * (1 + (attr.str * 0.005));
        const physicalResistance = finalDefPoints * 0.005;
        const evaRate = (attr.agi * 0.005) + (attr.eva * 0.01);
        const perfectDodgeRate = (attr.block * 0.015) + (evaRate * 0.2) + (attr.p_eva * 0.01);

        return {
            defPoints: finalDefPoints,
            physResist: Math.min(0.9, physicalResistance), 
            perfectDodge: Math.min(0.8, perfectDodgeRate), 
            specResist: attr.int * 5,
            // ç‰©ç†å‰©é¤˜é»æ•¸æ¼”ç®—
            remainingPoints: (player.lv * 3) - ((attr.str||0) + (attr.sta||0) + (attr.agi||0) + (attr.int||0))
        };
    };
}

/**
 * ğŸ› ï¸ ç‰©ç†è¼”åŠ©ï¼šç²å–ç‰©å“æ•¸å€¼ (å«ç²¾ç…‰åŠ æˆè¨ˆç®—)
 */
window.getItemStats = function(itemName) {
    if (!itemName) return { atk: 0, def: 0, timer: 0 };

    // 1. è§£æåç¨±èˆ‡ç­‰ç´š
    const baseName = itemName.split(' (+')[0].trim();
    const lvMatch = itemName.match(/\(\+(\d+)\)/);
    const lv = lvMatch ? parseInt(lvMatch[1]) : 0;

    // 2. å¾ä¸»è³‡æ–™åº« (MASTER_COLLECTION) æŸ¥æ‰¾åŸºç¤æ•¸å€¼
    const data = MASTER_COLLECTION.find(m => m.name === baseName);
    
    let stats = { atk: 0, def: 0, timer: 0, hp: 0 };

    if (data && data.stats) {
        let baseAtk = data.stats.atk || 0;
        let baseDef = data.stats.def || 0;
        let baseHp  = data.stats.hp || 0;
        
        // 3. ç‰©ç†ç²¾ç…‰å…¬å¼ï¼š
        // +1~+6: 10%, +7~+9: 15%, +10+: 25%
        let multiplier = 1.0;
        for(let i = 1; i <= lv; i++) {
            if (i <= 6) multiplier += 0.10;
            else if (i <= 9) multiplier += 0.15;
            else multiplier += 0.25;
        }
        
        // è¨ˆç®—æœ€çµ‚æ•¸å€¼ (ç„¡æ¢ä»¶æ¨å»)
        stats.atk = Math.floor(baseAtk * multiplier);
        stats.def = Math.floor(baseDef * multiplier);
        stats.hp  = Math.floor(baseHp * multiplier);
        // è¤‡è£½å…¶ä»–ç‰¹æ®Šå±¬æ€§
        if (data.stats.timer) stats.timer = data.stats.timer;
    }
    
    return stats;
};


/**
 * ğŸ“Š ç‰©ç†å­ç¨‹åºï¼šå…¨åŸŸæˆ°é¬¥å±¬æ€§çµç®— (V5.9.39 æˆé•·åŸºåº•ç‰ˆ)
 * ä¿®æ­£ï¼š
 * 1. åŸºç¤å±¬æ€§ = ç­‰ç´š (Level)
 * 2. æœ€çµ‚å±¬æ€§ = ç­‰ç´š + é…é»
 */
window.calculateCombatStats = function() {
    // 0. æ•¸æ“šé˜²ç¦¦
    const attr = player.attributes || { str: 0, sta: 0, agi: 0, int: 0, block: 0, eva: 0, p_eva: 0 };
    const baseVal = player.lv || 1; // ğŸ”¥ æ ¸å¿ƒï¼šæ¯ç´šçµ¦äºˆ 1 é»å…¨å±¬æ€§åŸºåº•

    // 1. è¨ˆç®—ç¸½å±¬æ€§ (Total Stats)
    const totalStr = baseVal + (attr.str || 0);
    const totalSta = baseVal + (attr.sta || 0);
    const totalAgi = baseVal + (attr.agi || 0);
    const totalInt = baseVal + (attr.int || 0);

    // 2. éæ­·è£å‚™ç´¯åŠ åŸºç¤æ•¸å€¼
    let equipBaseDef = 0;
    let equipBaseAtk = 0;
    if (player.equips) {
        Object.values(player.equips).forEach(itemName => {
            if (itemName) {
                const s = getItemStats(itemName);
                equipBaseDef += s.def;
                equipBaseAtk += s.atk;
            }
        });
    }

    // 3. ğŸ›¡ï¸ ç‰©ç†é˜²ç¦¦æ¼”ç®—
    // é«”åŠ›åŠ æˆï¼šæ¯ 1 é»é«”åŠ› +2 é˜²
    // åŠ›é‡åŠ æˆï¼šæ¯ 1 é»åŠ›é‡ +0.5% ç¸½é˜²
    const baseDefTotal = equipBaseDef + (totalSta * 2);
    const strBonus = 1 + (totalStr * 0.005); 
    const finalDefPoints = Math.floor(baseDefTotal * strBonus);

    // 4. âš”ï¸ ç‰©ç†æ”»æ“Šæ¼”ç®—
    // æ¯ 1 é»åŠ›é‡ +1% ç¸½æ”»
    const baseAtkTotal = player.lv + equipBaseAtk;
    const finalAtkPoints = Math.floor(baseAtkTotal * (1 + totalStr * 0.01));

    // 5. è¡ç”Ÿæ•¸å€¼
    const physicalResistance = finalDefPoints * 0.005; // å‚·æ¸›ç‡
    const evaRate = (totalAgi * 0.005) + (attr.eva * 0.01);
    
    // å®Œå…¨è¿´é¿ï¼šæ ¼æ“‹ + (ç¸½æ•æ·è½‰æ›) + é¡å¤–é»æ•¸
    const perfectDodgeRate = (attr.block * 0.015) + (evaRate * 0.2) + (attr.p_eva * 0.01);
    const statusResist = totalInt * 5;

    return {
        // é¡¯ç¤ºé¢æ¿ç”¨
        str: totalStr, sta: totalSta, agi: totalAgi, int: totalInt,
        
        // æˆ°é¬¥æ¼”ç®—ç”¨
        defPoints: finalDefPoints,
        atkPoints: finalAtkPoints,
        physResist: Math.min(0.9, physicalResistance), 
        perfectDodge: Math.min(0.8, perfectDodgeRate), 
        specResist: statusResist,
        
        // å‰©é¤˜é»æ•¸ï¼š(ç­‰ç´š * 3) - å·²åˆ†é… (ä¸å«åŸºåº•)
        remainingPoints: (player.lv * 3) - ((attr.str||0) + (attr.sta||0) + (attr.agi||0) + (attr.int||0))
    };
};

// ç›¸å®¹æ€§æ›è¼‰
window.getCombatPerformance = window.calculateCombatStats;

/**
 * ğŸ”„ å…¨åŸŸåŠŸèƒ½ï¼šå±¬æ€§ç‰©ç†é‡ç½®
 */
window.resetAttributes = async function() {
    const cost = 5000;
    
    // 1. ç‰©ç†æª¢æŸ¥ï¼šé¤˜é¡
    if (player.coin < cost) {
        showNotification("ğŸ’€ é‡‘å¹£ä¸è¶³ï¼é‡ç½®éœ€è¦ 5,000 Gã€‚");
        return;
    }

    if (!confirm(`ç¢ºå®šè¦èŠ±è²» ${cost} G é‡ç½®æ‰€æœ‰å±¬æ€§é»å—ï¼Ÿ\n\næ³¨æ„ï¼šé€™ä¸æœƒå½±éŸ¿ç­‰ç´šå¸¶ä¾†çš„åŸºç¤å±¬æ€§ã€‚`)) {
        return;
    }

    // 2. åŸ·è¡Œæ‰£æ¬¾èˆ‡åœ‹åº«ä¸Šç¹³
    player.coin -= cost;
    
    // ç¢ºä¿åœ‹åº«ç‰©ä»¶å­˜åœ¨
    if (!window.kingdomSystem) window.kingdomSystem = { treasury: 0 };
    window.kingdomSystem.treasury = (window.kingdomSystem.treasury || 0) + cost;

    // 3. ç‰©ç†æ­¸é›¶
    player.attributes = { 
        str: 0, sta: 0, agi: 0, int: 0, 
        block: 0, eva: 0, p_eva: 0 // ä¿ç•™ç‰¹æ®Šé»æ•¸æ¬„ä½çµæ§‹
    };

    // 4. å­˜æª”èˆ‡é‡ç¹ª
    await savePlayerToDB();
    renderEquipmentUI(); // ç«‹å³åˆ·æ–°ä»‹é¢é¡¯ç¤ºå‰©é¤˜é»æ•¸
    if (typeof updatePlayerUI === 'function') updatePlayerUI(); // åˆ·æ–°é‡‘å¹£

    showNotification("âœ¨ å±¬æ€§å·²é‡ç½®ï¼é»æ•¸å·²å…¨æ•¸æ­¸é‚„ã€‚");
    // æˆ°è¡“æ—¥èªŒ
    if (typeof addBattleLog === 'function') {
        addBattleLog(`ğŸ”„ <b style="color:#3498db;">[æ´—é»]</b> ç©å®¶é‡ç½®äº†å±¬æ€§ï¼Œåœ‹åº«å¢åŠ äº† $${cost} Gã€‚`);
    }
};



/**
 * ğŸ‘Š ç‰©ç†å‡ºç‰Œç¸½æ§ (V4.7 ç‹€æ…‹æ„ŸçŸ¥ç‰ˆ)
 * å°å…¥ï¼šéº»ç—ºæŠ½ç­‹åˆ¤å®šã€å‹‡è€…è‡ªæˆ‘æ„è­˜æ°£æ³¡ã€è¡Œå‹•æ¬Šå¼·åˆ¶å›æµ
 */
window.confirmPlayerMove = function() {
    // 1. é©—è­‰ (å›åˆæ¬Šé™èˆ‡ç’°å¢ƒæª¢æŸ¥)
    const context = PokerBattleSystem.validateContext();
    if (!context) return;

    const { hero, selectedIndices } = context;

    // 2. åˆ†æ (åˆ¤å®šé¸ä¸­çš„ç‰Œå‹æ˜¯å¦åˆæ³•ã€æ˜¯å¦èƒ½å£“åˆ¶)
    const analysis = PokerBattleSystem.analyzeMove(hero, selectedIndices);
    if (!analysis.isValid) {
        return showNotification(analysis.errorMsg);
    }

    // =========================================================
    // ğŸ”¥ğŸ”¥ğŸ”¥ ç‰©ç†æ””æˆªé»ï¼šéº»ç—ºç¥ç¶“é˜»æ–· (Paralyze Check) ğŸ”¥ğŸ”¥ğŸ”¥
    // =========================================================
    if (player.status === 'paralyze') {
        // ç‰©ç†æ©Ÿç‡ï¼š50% ç™¼ç”Ÿæ‰‹éƒ¨æŠ½ç­‹
        if (Math.random() < 0.5) {
            // A. ç‰©ç†å™´ç™¼ï¼šå‹‡è€…è‡ªæˆ‘åæ§½æ°£æ³¡
            if (typeof triggerHeroSpeech === 'function') {
                triggerHeroSpeech({ 
                    text: "å’³ï¼æ‰‹...æ‰‹çªç„¶å‹•ä¸äº†... æŠ½ç­‹äº†ï¼ï¼", 
                    vfx: "shake" 
                });
            }
            
            // B. æˆ°è¡“ç´€éŒ„èˆ‡é€šçŸ¥
            addBattleLog(`ğŸ’€ <b style="color:#95a5a6;">[éº»ç—º]</b> å‹‡è€…è©¦åœ–æ‰“å‡ºã€${analysis.pattern.label}ã€‘ï¼Œä½†å› æ‰‹éƒ¨æŠ½ç­‹å®£å‘Šå¤±æ•—ã€‚`);
            showNotification("âŒ è¡Œå‹•å¤±æ•—ï¼šéº»ç—ºæŠ½ç­‹ï¼");

            // C. ç‰©ç†æ¸…ç†ï¼šå–æ¶ˆé¸å–ä¸¦æ¸…ç©ºç·©è¡ [cite: 2026-01-21]
            window.selectedCards = [];
            renderPokerTable(document.getElementById('poker-table'));

            // D. ç‰©ç†ç½°ç«™ï¼šç›´æ¥è·³åˆ°æ­¥é©Ÿ 5 ç§»äº¤å›åˆï¼Œä¸åŸ·è¡Œ commitState (ä¸æ‰£ç‰Œ)
            return PokerBattleSystem.finalizeTurn(hero);
        }
    }
    // =========================================================

    // 3. å¯«å…¥ç‹€æ…‹ (è‹¥æ²’æŠ½ç­‹ï¼Œå‰‡æ­£å¼æ‰£é™¤æ‰‹ç‰Œ)
    PokerBattleSystem.commitState(hero, analysis);

    // 4. è§¸ç™¼ç‰¹æ•ˆ (ç‰©ç†å‚·å®³ã€è‚¡å¸‚æ³¢å‹•ã€ç•«é¢éœ‡å‹•)
    PokerBattleSystem.triggerEffects(hero, analysis);

    // 5. çµç®—/ç§»äº¤ (æª¢æŸ¥å‹è² æˆ–åˆ‡æ›è‡³ä¸‹ä¸€å€‹ AI)
    PokerBattleSystem.finalizeTurn(hero);
};

// =========================================
// ğŸ§© å‡ºç‰Œç³»çµ±æ ¸å¿ƒæ¨¡çµ„ (Poker Battle System)
// =========================================
const PokerBattleSystem = {
    /**
     * ğŸ›¡ï¸ ç’°å¢ƒé©—è­‰
     */
    validateContext: function() {
        const hero = pokerGame.players.find(p => p.id === 'player');
        const heroIdx = pokerGame.players.findIndex(p => p.id === 'player');
        const selectedIndices = window.selectedCards || [];

        if (!hero || window.isGameEnding || !pokerGame.gameActive) {
            showNotification("âš ï¸ ç‰Œå±€ç‹€æ…‹ç•°å¸¸æˆ–å·²çµæŸã€‚");
            return null;
        }
        if (selectedIndices.length === 0) {
            showNotification("âš ï¸ æç¤ºï¼šè«‹å…ˆé¸å–ç‰Œçµ„å¾Œå†è¡Œå‹•ã€‚");
            return null;
        }
        if (pokerGame.turn !== heroIdx) {
            showNotification("âš ï¸ å°šæœªè¼ªåˆ°ä½ çš„å›åˆï¼");
            return null;
        }

        return { hero, heroIdx, selectedIndices };
    },

    /**
     * ğŸ§  ç‰Œå‹åˆ†æ
     */
    analyzeMove: function(hero, selectedIndices) {
        // æ˜ å°„å¯¦é«”å¡ç‰‡
        const cardsToPlay = selectedIndices.map(idx => hero.cards[idx]).filter(c => c !== undefined);
        
        // 1. ç‰Œå‹è­˜åˆ¥
        const hasJoker = cardsToPlay.some(c => c.value === 'JOKER' || c.isPhantom);
        let pattern;

        if (hasJoker) {
            pattern = POKER_AI.solveJokers(cardsToPlay, pokerGame.lastMovePattern);
            if (!pattern) return { isValid: false, errorMsg: "âŒ ç„¡æ³•çµ„æˆæœ‰æ•ˆçš„å¹»å½±ç‰Œå‹ï¼" };
        } else {
            pattern = POKER_AI.getPattern(cardsToPlay);
        }

        // 2. åˆæ³•æ€§
        if (!pattern || pattern.type === 'none') {
            return { isValid: false, errorMsg: "âŒ ä¸åˆæ³•çš„ç‰Œå‹çµ„åˆï¼" };
        }

        // 3. é¦–å±€æ¢…èŠ± 3 ç¾©å‹™
        if (pokerGame.isFirstRound && !pokerGame.lastMovePattern) {
            const hasClub3 = cardsToPlay.some(c => c.label === 'â™£3');
            const isFlexible = (pokerGame.activeBoon === 'flexible' || pokerGame.activeBoon === 'monochrome');
            if (!hasClub3 && !hasJoker && !isFlexible) {
                return { isValid: false, errorMsg: "âŒ è¡€è…¥è¦å‰‡ï¼šé–‹å±€ç¬¬ä¸€æ‰‹å¿…é ˆåŒ…å«ã€æ¢…èŠ± 3ã€‘ï¼" };
            }
        }

        // 4. å¼·åº¦å£“åˆ¶
        if (pokerGame.lastMovePattern && pokerGame.lastPlayerName !== "NONE") {
            if (!POKER_AI.isBigger(pattern, pokerGame.lastMovePattern)) {
                return { isValid: false, errorMsg: "âŒ å¼·åº¦ä¸è¶³ï¼Œç„¡æ³•å£“åˆ¶å°æ‰‹ï¼" };
            }
        }

        return { isValid: true, cards: cardsToPlay, pattern: pattern };
    },

    /**
     * ğŸ’¾ ç‹€æ…‹å¯«å…¥ (ä¸å¯é€†)
     */
    commitState: function(hero, analysis) {
        const { cards, pattern } = analysis;
        
        pokerGame.playedCards = (pokerGame.playedCards || []).concat(cards);
        hero.cards = hero.cards.filter(c => !cards.includes(c));
        hero.lastMove = [...cards];
        
        pokerGame.players.forEach(p => { p.isPassed = false; p.lastTalk = ""; });
        
        pokerGame.lastMoveCards = [...cards];
        pokerGame.lastMovePattern = pattern;
        pokerGame.lastPlayerName = hero.name;
        pokerGame.passCount = 0; 
        pokerGame.isFirstRound = false; 
        
        window.selectedCards = []; 
    },

/**
 * ğŸ¨ å‰¯ä½œç”¨è§¸ç™¼å™¨ (V4.8 å‡ºè¡€é€£å‹•ç‰ˆ)
 * ä¿®æ­£ï¼šå¯¦è£å€‹ä½æ•¸å‡ºè¡€å‚·å®³ã€ç‹‚æš´åŠ æˆèˆ‡å‹‡è€…ç—›è¦ºæ°£æ³¡
 */
triggerEffects: function(hero, analysis) {
    const { cards, pattern } = analysis;
    
    // --- ğŸ©¸ 1. ç‰©ç†æ””æˆªï¼šå‡ºè¡€ç‹€æ…‹åˆ¤å®š (Bleed Check) ---
    if (player.status === 'bleed') {
        // A. è¨ˆç®—ç‰©ç†æå‚·ï¼šä¸€èˆ¬å€‹ä½æ•¸ (3-6 é») | ç‹‚æš´åŠ æˆ (12-18 é»)
        const isBerserk = !!pokerGame.isBerserkKingActive;
        const baseBleed = Math.floor(Math.random() * 4) + 3; 
        const bleedDmg = isBerserk ? Math.floor(baseBleed * 3) : baseBleed;

        // B. åŸ·è¡Œæ‰£è¡€èˆ‡ç”Ÿå‘½çƒé€£å‹•
        player.currentHp = Math.max(1, player.currentHp - bleedDmg);
        
        // C. ç‰©ç†å™´ç™¼ï¼šå‹‡è€…ç—›è¦ºæ°£æ³¡
        if (typeof triggerHeroSpeech === 'function') {
            const bleedLine = isBerserk ? "å‘ƒï¼é€™è‚¡å¨å£“... å‚·å£å®Œå…¨æ­¢ä¸ä½ï¼" : "å˜¶... ç”¨åŠ›éçŒ›ï¼Œå‚·å£è£‚é–‹äº†ã€‚";
            triggerHeroSpeech({ text: bleedLine, vfx: "shake" });
        }

        // D. æˆ°è¡“ç´€éŒ„
        addBattleLog(`ğŸ©¸ <b style="color:#e74c3c;">[å‡ºè¡€]</b> å‹‡è€…å› å¼·åŠ›å‡ºç‰Œå°è‡´å‚·å£æ’•è£‚ï¼Œç‰©ç†æå¤± ${bleedDmg} HPã€‚`);
        
        // è¦–è¦ºéœ‡æ’¼ï¼šç”Ÿå‘½çƒè„ˆè¡é–ƒçˆ
        const orb = document.querySelector('.hp-orb-container');
        if (orb) {
            orb.classList.add('orb-bleeding');
            setTimeout(() => orb.classList.remove('orb-bleeding'), 800);
        }
    }

    // --- 2. åŸæœ‰ç‰¹æ•ˆéˆ (ä¿æŒä¸è®Š) ---
    const cardLabels = cards.map(c => c.label).join(', ');
    const logColor = (pattern.type === 'bomb') ? '#f1c40f' : '#2ecc71';

    if (pattern.sub && pattern.sub.includes('phantom')) {
        addBattleLog(`âœ¨ <b style="color:#9b59b6;">å¹»å½±å…±é³´</b>ï¼šã€${pattern.label}ã€‘å¯¦è£ï¼`);
    }
    addBattleLog(`ğŸ‘¤ <b style="color:${logColor};">å‹‡è€…</b> ç¥­å‡ºäº†ï¼š${cardLabels} <span style="color:#666;">(${pattern.label || pattern.type})</span>`);

    // ç‰©ç†å‚·å®³
    if (typeof applyCardBattleDamage === 'function') {
        applyCardBattleDamage(hero, cards);
    }
    // è‚¡å¸‚é€£å‹•
    if (typeof updateStockMarket === 'function') {
        updateStockMarket();
    }
    // éœ‡å‹•
    if (pattern.type === 'bomb') {
        const table = document.getElementById('poker-table');
        if (table) {
            table.style.animation = "dqShake 0.4s ease-in-out";
            setTimeout(() => table.style.animation = "", 400);
        }
    }
    // æœ€çµ‚ UI é‡ç¹ª (åŒæ­¥ç”Ÿå‘½çƒæ¶²é¢èˆ‡è—¥æ°´æ•¸é‡)
    renderPokerTable(document.getElementById('poker-table'));
},

    /**
     * ğŸ çµæŸå›åˆ
     */
    finalizeTurn: function(hero) {
        if (hero.cards.length === 0) {
            addBattleLog(`ğŸŠ <b style="color:#2ecc71;">[çµ‚ç„‰] å‹‡è€…ç‡å…ˆæ¸…ç©ºæ‰‹ç‰Œï¼</b>`);
            pokerGame.playerTotalWins = (pokerGame.playerTotalWins || 0) + 1;
            if (typeof updateStockMarket === 'function') updateStockMarket();
            return finishPokerGame(hero); 
        }

        pokerGame.turn = (pokerGame.turn + 1) % 4;
        
        if (window.pokerAITimer) clearTimeout(window.pokerAITimer);
        window.pokerAITimer = setTimeout(() => {
            if (pokerGame.gameActive && !window.isGameEnding) {
                aiPlayTurn(pokerGame.turn);
            }
        }, 1500);
    }
};


/**
 * ğŸ–±ï¸ ç‰©ç†æ“ä½œï¼šæ‰‹å‹•é»é¸/å–æ¶ˆç‰Œå¡ (V5.0 éº»ç—ºæ„Ÿæ‡‰å°æ­£ç‰ˆ)
 * ä¿®æ­£ï¼šå¯¦è£ 30% æ©Ÿç‡ç¥ç¶“å¤±èª¿ã€ç‰©ç†æŠ–å‹•ç‰¹æ•ˆèˆ‡å‹‡è€…æŒ«æŠ˜æ°£æ³¡
 */
window.toggleCardSelection = function(idx) {
    // 1. ğŸ”¥ ã€æ•¸æ“šåˆå§‹åŒ–ã€‘
    if (!window.selectedCards) window.selectedCards = [];

    // =========================================================
    // ğŸ”¥ğŸ”¥ğŸ”¥ ç‰©ç†æ ¸å¿ƒï¼šéº»ç—ºç¥ç¶“é˜»æ–·åˆ¤å®š (Paralyze Interference) ğŸ”¥ğŸ”¥ğŸ”¥
    // =========================================================
    if (player.status === 'paralyze') {
        // ç‰©ç†æ©Ÿç‡ï¼š30% è§¸ç™¼æ‰‹éƒ¨æŠ½æï¼Œé¸å–å¤±æ•—
        if (Math.random() < 0.3) {
            // A. ç‰©ç†å®šä½ï¼šç²å–ç•¶å‰é»æ“Šçš„ç‰Œå¡ DOM å¯¦é«”
            // é€é ID æˆ–è·¯å¾‘å®šä½ player-hand å…§éƒ¨çš„å¡ç‰‡å…ƒç´ 
            const handContainer = document.getElementById('player-hand');
            if (handContainer) {
                const cardEls = handContainer.querySelectorAll('div[onclick]');
                const targetEl = cardEls[idx];
                
                if (targetEl) {
                    // B. é»ç‡ƒè¦–è¦ºï¼šåŸ·è¡ŒåŠ‡çƒˆç¥ç¶“æ€§æŠ–å‹•ç‰¹æ•ˆ
                    targetEl.classList.add('paralyze-jitter');
                    
                    // C. ç‰©ç†å™´ç™¼ï¼šå‹‡è€…è‡ªæˆ‘æŒ«æŠ˜æ°£æ³¡ (å»ºç«‹è§’è‰²é€£çµ)
                    if (typeof triggerHeroSpeech === 'function') {
                        const spasmLines = [
                            "å˜–... æ‰‹çªç„¶æŠ½äº†ä¸€ä¸‹ï¼",
                            "å¯æƒ¡ï¼ŒæŒ‡å°–å®Œå…¨æ²’æ„Ÿè¦º...",
                            "ç¥ç¶“éº»ç—ºäº†å—... å‹•ä¸äº†ï¼"
                        ];
                        triggerHeroSpeech({ 
                            text: spasmLines[Math.floor(Math.random() * spasmLines.length)], 
                            vfx: "shake" 
                        });
                    }

                    // D. ç‰©ç†å›æ”¶ï¼š400ms å‹•ç•«çµæŸå¾Œè‡ªå‹•ç§»é™¤ç‰¹æ•ˆ
                    setTimeout(() => {
                        targetEl.classList.remove('paralyze-jitter');
                    }, 400);
                }
            }

            // E. ç‰©ç†æ–·è·¯ï¼šå¼·è¡Œæ””æˆªé‚è¼¯ï¼Œä¸åŸ·è¡Œé¸å–èˆ‡é‡ç¹ª
            console.log("%câš¡ [ç¥ç¶“å¤±èª¿] ç‰©ç†æ””æˆªï¼šé¸å–æ“ä½œå› éº»ç—ºå¤±æ•ˆã€‚", "color: #95a5a6; font-weight: bold;");
            return; 
        }
    }
    // =========================================================

    // 2. ğŸ”¥ ã€ç‰©ç†é¸å–é‚è¼¯ã€‘(è‹¥æœªéº»ç—ºæˆ–æ©Ÿç‡é€šéå‰‡åŸ·è¡Œ)
    const currentPos = window.selectedCards.indexOf(idx);
    if (currentPos > -1) {
        window.selectedCards.splice(currentPos, 1); // ç‰Œå¡è½ä¸‹
    } else {
        window.selectedCards.push(idx); // ç‰Œå¡å½ˆèµ·
    }

    // 3. ğŸ”¥ ã€æˆ°è¡“åŒæ­¥åµæ¸¬ï¼šæ ¸å¿ƒå°æ­£é»ã€‘
    if (typeof window.updateTacticalHelper === 'function') {
        window.updateTacticalHelper(true); 
    }

    // 4. ğŸ”¥ ã€UI å–®æ¬¡é‡ç¹ªã€‘
    const tableContainer = document.getElementById('poker-table');
    if (tableContainer) {
        renderPokerTable(tableContainer);
    }
};

/**
 * ğŸ› ï¸ æˆ°å ´å°æ­£å™¨ï¼šç‰©ç†å¼·è¡Œæ¢å¾©ç©å®¶è¡Œå‹•æ¬Š
 * ç•¶ç™¼ç¾ AI å¡ä½æˆ–æŒ‰éˆ•é»ä¸å‹•æ™‚ä½¿ç”¨
 */
window.fixBattleStuck = function() {
    console.log("%cğŸ› ï¸ åŸ·è¡Œç‰©ç†ç¶­ä¿®ï¼šæ­£åœ¨å¼·è¡Œæ­¸é‚„ç™¼çƒæ¬Š...", "color: #f1c40f; font-weight: bold;");
    
    // 1. å¼·è¡Œæ ¡æº–å›åˆç´¢å¼•
    const heroIdx = pokerGame.players.findIndex(p => p.id === 'player');
    pokerGame.turn = heroIdx;
    
    // 2. è§£é™¤çµ‚å±€é–å®šæ——æ¨™
    window.isGameEnding = false;
    pokerGame.gameActive = true;
    
    // 3. ç‰©ç†é‡ç½®æ‰€æœ‰çš„ AI è¡Œå‹•è¨ˆæ™‚å™¨ (é˜²æ­¢é‡è¤‡é»ç«)
    if (window.pokerAITimer) {
        clearTimeout(window.pokerAITimer);
        window.pokerAITimer = null;
    }

    // 4. é‡å•Ÿæˆ°è¡“è¼”åŠ©å¼•æ“ (ç¢ºä¿ JOKER è®Šå¹»æŒ‰éˆ•å‡ºç¾)
    if (typeof updateTacticalHelper === 'function') {
        updateTacticalHelper();
    }

    // 5. å¼·åˆ¶åŸ·è¡Œ UI é‡ç¹ª
    renderPokerTable(document.getElementById('poker-table'));
    
    showNotification("âœ¨ ç‰©ç†ä¿®æ­£ï¼šè¡Œå‹•æ¬Šå·²å¼·åˆ¶å›æ­¸å‹‡è€…ï¼");
};

/**
 * ğŸ› ï¸ ç‰©ç†å­ç¨‹åºï¼šåˆ‡æ›æˆ°è¡“æ—¥èªŒæŠ½å±œ (çµ‚ç«¯é¢æ¿é©é…ç‰ˆ)
 * ä¿®æ­£ï¼šæ”¯æ´ Flex ä½ˆå±€é¡¯ç¤ºã€ç²¾ç¢ºé–å®šæ•¸æ“šæµæ»¾å‹•ã€ä¸¦åŒæ­¥ UI ç‹€æ…‹ç´€éŒ„
 */
window.toggleBattleLog = function() {
    const monitor = document.getElementById('battle-log-monitor');
    const stream = document.getElementById('log-content-stream');
    const hint = document.getElementById('latest-log-hint');
    
    if (!monitor) {
        console.warn("âŒ ç‰©ç†æ–·è£‚ï¼šæ‰¾ä¸åˆ° battle-log-monitor å®¹å™¨");
        return;
    }

    // 1. ğŸ”¥ ã€ç‰©ç†ç‹€æ…‹æª¢æŸ¥ã€‘è™•ç†å¤šå…ƒé¡¯ç¤ºç‹€æ…‹åˆ¤å®š
    const isCurrentlyClosed = (
        monitor.style.display === 'none' || 
        monitor.style.display === '' || 
        window.getComputedStyle(monitor).display === 'none'
    );

    // 2. ğŸ”¥ ã€ç‰©ç†åˆ‡æ›ã€‘æ”¹ç”¨ flex ä»¥ç¬¦åˆçµ‚ç«¯é¢æ¿çš„å…§éƒ¨çµæ§‹è¦æ±‚
    monitor.style.display = isCurrentlyClosed ? 'flex' : 'none';
    window.isLogDrawerOpen = isCurrentlyClosed; // å…¨åŸŸåŒæ­¥ï¼Œç¢ºä¿ renderPokerTable é‡ç¹ªå¾Œä¸æœƒè‡ªå‹•æ¶ˆå¤±

    // 3. ğŸ”¥ ã€é–‹å•Ÿæ™‚çš„ç‰©ç†è¡Œç‚ºã€‘
    if (isCurrentlyClosed) {
        // A. æ•¸æ“šæµé‚„åŸï¼šå°‡ç·©è¡å€çš„ HTML å¯«å…¥æµå®¹å™¨
        if (typeof restoreLogStream === 'function') {
            restoreLogStream();
        } else if (stream && window.battleLogBuffer) {
            stream.innerHTML = window.battleLogBuffer.join('');
        }

        // B. è¦–è¦ºæ¸…ç†ï¼šé–‹å•Ÿé¢æ¿å¾Œï¼Œå°‡æŒ‰éˆ•æ—çš„æç¤ºç‡ˆç‰©ç†æ·¡åŒ–
        if (hint) {
            hint.style.transition = "opacity 0.3s ease";
            hint.style.opacity = "0.2";
        }

        // C. ç²¾ç¢ºç½®åº•ï¼šç¢ºä¿è¦–ç·šé–å®šåœ¨æœ€æ–°æ—¥èªŒ (Q3 åµæ¸¬é»)
        // ä½¿ç”¨ requestAnimationFrame æˆ–å…©æ¬¡ setTimeout ç¢ºä¿ DOM æ¸²æŸ“å·²å®Œæˆ
        setTimeout(() => {
            if (stream) {
                stream.scrollTop = stream.scrollHeight;
                // åŠ å…¥ç‰©ç†å¾®éœ‡å‹•æ•ˆæœæç¤ºé–‹å•ŸæˆåŠŸ
                monitor.style.transform = "translateY(-5px)";
                setTimeout(() => monitor.style.transform = "translateY(0)", 100);
            }
        }, 50);
    }
};


/**
 * ğŸ§¤ ç‰©ç†å­ç¨‹åºï¼šå‹‡è€…æ£„æ¬Šåˆ¤å®š (V5.1 æ­»é–ä¿®å¾©ç‰ˆ)
 * ä¿®æ­£ï¼šè§£æ±ºç™¼çƒæ¬Šé–å®šå°è‡´æŒ‰éˆ•å¤±æ•ˆå•é¡Œï¼Œä¸¦å°å…¥è‡ªå‹•é¸ç‰Œå°å¼•
 */
window.playerPass = function() {
    const heroIdx = pokerGame.players.findIndex(p => p.id === 'player');
    const hero = pokerGame.players[heroIdx];
    
    if (!pokerGame.gameActive || window.isGameEnding) return;

    // 1. ğŸ”¥ ã€ç™¼çƒæ¬Šç‰©ç†æ ¡æº–ã€‘
    // è‹¥æ¡Œé¢ç„¡ç‰Œ (NONE) æˆ–è€…æ˜¯ä½ ä¸Šä¸€æ‰‹å‡ºç‰Œä¸”å…¨å“¡ PASS å›åˆ°ä½ ï¼Œä»£è¡¨ä½ æ“æœ‰ã€Œç™¼çƒæ¬Šã€
    const hasLeadPower = (!pokerGame.lastMovePattern || pokerGame.lastPlayerName === "NONE" || pokerGame.lastPlayerName === hero.name);

    if (hasLeadPower) {
        // ğŸš¨ å°æ­£é‚è¼¯ï¼šé ˜å…ˆè€…ç¦æ­¢ PASSï¼Œç‰©ç†éœ‡å‹•æé†’ç©å®¶é–‹ç‰Œ
        showNotification("âŒ <b>æ³•å¾‹ç¾©å‹™ï¼š</b>ä½ ç›®å‰æ“æœ‰ç™¼çƒæ¬Šï¼Œå¿…é ˆå‡ºä¸€å¼µç‰Œï¼");
        
        // ç‰©ç†è¦–è¦ºå°å¼•ï¼šè®“æ‰‹ç‰Œå€é–ƒçˆ
        const hand = document.getElementById('player-hand');
        if (hand) {
            hand.style.animation = "dqShake 0.3s ease-in-out";
            setTimeout(() => hand.style.animation = "", 300);
        }
        
        // è‹¥ç©å®¶ç›®å‰æ²’é¸ç‰Œï¼Œè‡ªå‹•å¹«ä»–é¸æœ€å°çš„ä¸€å¼µ (UX å°èˆª)
        if (window.selectedCards.length === 0 && hero.cards.length > 0) {
            console.log("ğŸ’¡ æˆ°è¡“å°èˆªï¼šè‡ªå‹•ç‚ºé ˜å…ˆè€…é¸å–æœ€å°å–®å¼µã€‚");
            window.toggleCardSelection(0); 
        }
        return;
    }

    // 2. ğŸ”¥ ã€æ­£å¸¸æ£„æ¬Šæµç¨‹ã€‘
    hero.isPassed = true; 
    pokerGame.passCount = (pokerGame.passCount || 0) + 1;
    window.selectedCards = []; // ç‰©ç†æ¸…ç©ºï¼Œç¢ºä¿è¦–è¦ºç´”æ·¨
    
    addBattleLog(`ğŸ§¤ <b style="color:#aaa;">å‹‡è€…</b> é¸æ“‡äº†è§€æœ› (Pass)`);

    // æ¸…ç†èˆŠè¨ˆæ™‚å™¨
    if (window.pokerAITimer) {
        clearTimeout(window.pokerAITimer);
        window.pokerAITimer = null;
    }

    // 3. ğŸ”¥ ã€åˆ†æµåˆ¤å®šã€‘
    if (pokerGame.passCount >= 3) {
        // å…¨å“¡ Pass -> æˆ°å ´ç‰©ç†æ·¨åŒ–
        resetTableForNewLead(); 
        showNotification("ğŸ§¤ å…¨å“¡ Passï¼æˆ°å ´å·²ç‰©ç†æ¸…ç©ºã€‚");
    } else {
        // ç§»äº¤æ¬ŠåŠ›çµ¦ä¸‹ä¸€ä½ AI
        renderPokerTable(document.getElementById('poker-table'));
        pokerGame.turn = (heroIdx + 1) % 4;
        triggerNextActor(pokerGame.turn);
    }

    /**
     * å…§éƒ¨å‡½æ•¸ï¼šç‰©ç†è¿½è¹¤ä¸‹ä¸€å€‹åˆæ³•è¡Œå‹•è€…
     */
    function triggerNextActor(idx) {
        const nextPlayer = pokerGame.players[idx];
        
        window.pokerAITimer = setTimeout(() => {
            if (!pokerGame.gameActive || window.isGameEnding) return;

            if (nextPlayer.id === 'player') {
                renderPokerTable(document.getElementById('poker-table'));
                showNotification("ğŸ‘‰ è¼ªåˆ°ä½ äº†");
            } else {
                if (!nextPlayer.isPassed) {
                    aiPlayTurn(idx);
                } else {
                    pokerGame.passCount++;
                    pokerGame.turn = (idx + 1) % 4;
                    if (pokerGame.passCount >= 3) {
                        resetTableForNewLead();
                    } else {
                        triggerNextActor(pokerGame.turn);
                    }
                }
            }
        }, 1200);
    }
};


window.triggerScoutEffect = function() {
    if (pokerGame.activeBoon !== 'scout') return;
    
    addBattleLog(`ğŸ‘“ <b style="color:#3498db;">[æƒ…å ±åµå¯Ÿ]</b> å•Ÿå‹•ï¼šåŸ·è¡Œå…¨å ´æ·±åº¦æƒæ...`);
    pokerGame.players.forEach(p => {
        if (p.id === 'player' || p.cards.length === 0) return;
        // ç‰©ç†ç¯©é¸æœ€å¼·çš„ä¸€å¼µç‰Œ
        const strongest = [...p.cards].sort((a, b) => b.power - a.power)[0];
        addBattleLog(`ğŸ“¡ <b style="color:#3498db;">${p.name}</b> å¨è„…è©•å®šï¼šæŒæœ‰ <b style="color:#f1c40f;">${strongest.label}</b>`);
    });
};

/**
 * ğŸ” æˆ°è¡“è¼”åŠ©å¼•æ“ï¼šå…¨è®Šé«”ç‰©ä»¶åŒ¹é…èˆ‡æ“ä½œå¼•åŠ›å°æ­£ç‰ˆ (V5.9.7 é˜²å´©æ½°ç‰ˆ)
 * ä¿®æ­£ï¼šå¯¦è£ window.helperLastSelectionIdx ç‰©ç†å®‰å®šå™¨ï¼Œè§£æ±º TypeError å´©æ½°å•é¡Œã€‚
 */
window.updateTacticalHelper = function(isSilent = false) {
    // 0. ğŸ”¥ ã€ç‰©ç†å®‰å®šå™¨ã€‘ç¢ºä¿å…¨åŸŸç´¢å¼•å®¹å™¨çµ•å°å­˜åœ¨
    if (!window.helperLastSelectionIdx) {
        window.helperLastSelectionIdx = {};
    }

    const helperBar = document.getElementById('poker-helper-bar');
    if (!helperBar) return;
    
    // 1. ğŸ”¥ ã€ç‰©ç†ç¯€æµã€‘
    if (!isSilent) helperBar.innerHTML = ''; 

    const hero = pokerGame.players.find(p => p.id === 'player');
    if (!hero || hero.cards.length === 0) return;

    // ğŸ”¥ ã€ç‰©ç†æ ¸å¿ƒï¼šç²å–æ¡Œé¢ç›®æ¨™ã€‘
    const isLeading = (!pokerGame.lastMovePattern || pokerGame.lastPlayerName === "NONE");
    const target = isLeading ? null : pokerGame.lastMovePattern; 
    
    // 2. ğŸ”¥ ã€Joker å…¨çµ„åˆæšèˆ‰æƒæã€‘åŸ·è¡Œ C(n,5) ç‰©ç†é‹ç®—
    const allCombos = (typeof POKER_AI.getAllPossible5CardCombos === 'function')
                      ? POKER_AI.getAllPossible5CardCombos(hero.cards, target)
                      : [];

    if (isSilent) return;

    // --- A. è™•ç†äº”å¼µç‰Œçµ„åˆ (é †ã€è˜†ã€éµã€åŒ) ---
    const configs = [
        { type: 'flush-straight', label: 'åŒèŠ±é †', icon: 'ğŸŒˆ' },
        { type: 'bomb', label: 'éµæ”¯', icon: 'ğŸ’¥' },
        { type: 'fullhouse', label: 'è‘«è˜†', icon: 'ğŸ ' },
        { type: 'straight', label: 'é †å­', icon: 'ğŸ“' }
    ];

    configs.forEach(cfg => {
        const matches = allCombos.filter(combo => {
            const p = POKER_AI.getPattern(combo);
            if (!p) return false;
            if (cfg.type === 'bomb') return p.type === 'bomb' && p.sub === 'quads';
            if (cfg.type === 'flush-straight') return p.type === 'bomb' && p.sub === 'straight-flush';
            return p.sub === cfg.type;
        });

        const btn = document.createElement('button');
        btn.className = `helper-btn ${cfg.type}`;
        const countText = matches.length > 1 ? ` (${matches.length})` : '';
        btn.innerHTML = `${cfg.icon} ${cfg.label}${countText}`;
        
        // ç‰©ç†æ¨£å¼ï¼šè·äººç´šç·Šæ¹ŠåŒ–
        btn.style = `background:#1a1a1a; color:#f1c40f; border:1px solid #f1c40f; padding:6px 12px; border-radius:6px; cursor:pointer; font-size:12px; font-weight:bold; transition:0.2s; opacity:${matches.length > 0 ? '1' : '0.2'};`;
        
        if (matches.length > 0) {
            btn.onclick = (e) => {
                e.stopPropagation();
                
                // ğŸ›‘ ã€æ ¸å¿ƒä¿®æ­£ï¼šå›èª¿å…§çš„å®‰å…¨å®ˆè¡›ã€‘
                if (!window.helperLastSelectionIdx) window.helperLastSelectionIdx = {};
                let currentIdx = window.helperLastSelectionIdx[cfg.type] || 0;
                
                let selectedCombo = matches[currentIdx % matches.length];
                
                // ğŸ”¥ ã€æ ¸å¿ƒä¿®æ­£ï¼šç‰©ç†æŒ‡æ¨™æ˜ å°„ã€‘
                // ä¸æ¯”å° label æ–‡å­—ï¼Œç›´æ¥æ¯”å°ç‰©ä»¶å¼•ç”¨ (Reference Check)ã€‚
                window.selectedCards = selectedCombo.map(targetCard => 
                    hero.cards.findIndex(c => c === targetCard)
                ).filter(idx => idx !== -1);
                
                window.helperLastSelectionIdx[cfg.type] = (currentIdx + 1) % matches.length;
                renderPokerTable(document.getElementById('poker-table'));
            };
        } else {
            btn.disabled = true;
        }
        helperBar.appendChild(btn);
    });

    // --- B. ğŸ‘¥ å°å­åµæ¸¬ (åŒæ­¥åŠ å›ºç‰ˆ) ---
    const pairs = (typeof POKER_AI.findAllSetsWithJokers === 'function') 
                ? POKER_AI.findAllSetsWithJokers(hero.cards, 2, target) 
                : [];
    
    if (pairs.length > 0 && !(target && target.type !== 'pair')) {
        const pBtn = document.createElement('button');
        pBtn.className = "helper-btn pair";
        const pCountText = pairs.length > 1 ? ` (${pairs.length})` : '';
        pBtn.innerHTML = `ğŸ‘¥ å°å­${pCountText}`;
        pBtn.style = "background:#1a1a1a; color:#f1c40f; border:1px solid #f1c40f; padding:6px 12px; border-radius:6px; cursor:pointer; font-size:12px; font-weight:bold;";
        
        pBtn.onclick = (e) => {
            e.stopPropagation();
            
            // ğŸ›‘ ã€æ ¸å¿ƒä¿®æ­£ï¼šå®‰å…¨è®€å–ã€‘
            if (!window.helperLastSelectionIdx) window.helperLastSelectionIdx = {};
            let pIdx = window.helperLastSelectionIdx['pair'] || 0;
            
            const bestPair = pairs[pIdx % pairs.length];
            
            // ğŸ”¥ åŒæ­¥ä½¿ç”¨ç‰©ç†æŒ‡æ¨™æ¯”å°
            window.selectedCards = bestPair.map(targetCard => 
                hero.cards.findIndex(c => c === targetCard)
            ).filter(idx => idx !== -1);
            
            window.helperLastSelectionIdx['pair'] = (pIdx + 1) % pairs.length;
            renderPokerTable(document.getElementById('poker-table'));
        };
        helperBar.appendChild(pBtn);
    }

    // --- C. ğŸš« å–æ¶ˆæŒ‰éˆ• (ç¶­æŒåŸæ¨£) ---
    const cancelBtn = document.createElement('button');
    cancelBtn.innerHTML = `ğŸš« å–æ¶ˆ`;
    cancelBtn.className = "helper-btn cancel";
    cancelBtn.style = "border:1px solid #e74c3c; color:#e74c3c; background:none; padding:6px 12px; border-radius:6px; cursor:pointer; font-size:12px; margin-left:10px; font-weight:bold;";

    if (window.selectedCards && window.selectedCards.length > 0) {
        cancelBtn.onclick = (e) => {
            e.stopPropagation();
            window.selectedCards = []; 
            window.helperLastSelectionIdx = {}; // ç‰©ç†é‡ç½®ç´¢å¼•
            renderPokerTable(document.getElementById('poker-table'));
        };
    } else {
        cancelBtn.style.opacity = "0.3";
        cancelBtn.disabled = true;
    }
    helperBar.appendChild(cancelBtn);
};

/**
 * ğŸš¨ ç‰©ç†æ ¸å¿ƒï¼šåœ‹ç‹åŒ…åœç¶²èˆ‡æª„æ–‡å•Ÿå‹•å¼•æ“
 * ä¿®æ­£ï¼šæ”¯æ´å…¨æ™‚æ®µè§¸ç™¼ã€èº«åˆ†æ ¡æº–ã€è‡ªå‹•ç‰©è³‡è£œçµ¦èˆ‡æª„æ–‡å®£å‘Š
 */
window.triggerKingSiegeLogic = function() {
    // 0. ğŸ”¥ ã€ç‰©ç†æ•¸æ“šæå–ã€‘
    const hero = pokerGame.players.find(p => p.id === 'player');
    
    // ç‰©ç†é˜²ç¦¦ï¼šè‹¥ç©å®¶å°è±¡éºå¤±æˆ–ç‰Œå±€å·²é—œé–‰ï¼Œç«‹å³æ””æˆª
    if (!hero || !pokerGame.gameActive) return;

    // æ•¸æ“šå°é½Šï¼šåˆä½µå¤šå€‹æ•¸æ“šæºç¢ºä¿é€£èŠæ•¸ 100% æº–ç¢º
    const actualStreak = Math.max(player.kingStreak || 0, pokerGame.playerKingStreak || 0);
    
    // ğŸ”¥ ã€ç‰©ç†æ¢ä»¶åˆ¤å®šï¼šé»ç«å¼•ä¿¡ã€‘
    // åˆ¤å®šï¼šå‹‡è€…æ˜¯åœ‹ç‹ ä¸” (é€£èŠ >= 3 å±€ æˆ– å…·å‚™æ‰‹å‹•å¼·åˆ¶æ——æ¨™)
    const isEligible = (hero.rank === 'king' && (actualStreak >= 3 || pokerGame.forceSiege));

    if (isEligible && !pokerGame.isKingSiege) {
        pokerGame.isKingSiege = true;
        pokerGame.forceSiege = false; // é»ç«å¾Œæ¸…é™¤å¼·åˆ¶æ——æ¨™

        // 1. ğŸ”¥ ã€ç‰©ç†è¦–è¦ºï¼šå…¨å±æª„æ–‡å¾è¨äº‹ä»¶ã€‘
        if (typeof triggerSiegeAnnouncement === 'function') {
            triggerSiegeAnnouncement();
        } else {
            addBattleLog(`ğŸš¨ <b style="color:#ff4d4d;">[æª„æ–‡] åœ‹ç‹åŒ…åœç¶²æˆç«‹</b>ï¼šé€£èŠ ${actualStreak} å±€ï¼ŒåæŠ—è»é›†çµï¼`);
        }

        // 2. ğŸ”¥ ã€ç‰©ç†æ•¸æ“šï¼šç›Ÿç´„ç‰©è³‡æŠ•éã€‘
        pokerGame.players.forEach(p => {
            if (p.rank !== 'king') {
                // ç‰©ç†æª¢æŸ¥ï¼šç¢ºä¿åæŠ—è»ä¸é‡è¤‡ç²å¾—åŒ…åœç¶² Joker
                const currentJokers = p.cards.filter(c => c.value === 'JOKER').length;
                if (currentJokers < 1) {
                    // å‘åæŠ—è»æŠ•éã€Œç›Ÿç´„ Jokerã€ï¼Œæ¨™è¨˜ fromSiege è§¸ç™¼ç´«è‰²ç™¼å…‰ç‰¹æ•ˆ
                    const jokerCard = { 
                        suit: 'ğŸƒ', value: 'JOKER', power: 150, 
                        label: 'JOKER', fromSiege: true,
                        isPhantom: true 
                    };
                    p.cards.push(jokerCard);
                    console.log(`ğŸ¤ [è¡€ç›Ÿ] å‘åæŠ—è» ${p.name} ç§˜å¯†æŠ•éäº†æˆ°è¡“ Jokerã€‚`);
                }
            }
        });

        // 3. ğŸ”¥ ã€ç‰©ç†é‡æ•´èˆ‡åŒæ­¥ã€‘
        // é‡æ–°é€²è¡Œæ‰‹ç‰Œæ¬Šé‡æ’åºï¼Œç¢ºä¿ Joker è¢«æ’åœ¨æœ€å³å´
        pokerGame.players.forEach(p => {
            p.cards.sort((a, b) => a.power - b.power);
        });

        // ç‰©ç†æ¸²æŸ“åˆ·æ–°
        const table = document.getElementById('poker-table');
        if (table) renderPokerTable(table);
        
        showNotification("âš–ï¸ <b style='color:#ff4d4d;'>ã€åœ‹ç‹åŒ…åœç¶²ã€‘</b> å·²æˆå½¢ï¼åæŠ—è»ç›Ÿç´„å•Ÿå‹•ï¼");
        
        // éœ‡å‹•è¦–è¦ºåé¥‹ (Roguelike éœ‡æ’¼æ„Ÿ)
        if (typeof triggerCheatShatterEffect === 'function') triggerCheatShatterEffect();
    }
};

/**
 * âš”ï¸ ç‰©ç†å­ç¨‹åºï¼šé–‹å•Ÿæˆ°è¡“æ›è¼‰ä»‹é¢ (V5.9.24 å®Œå…¨å°æ­£ç‰ˆ)
 * ä½œç”¨ï¼šå®šç¾©äººç‰©ä¸‹æ–¹ 3 å€‹ç‰©å“æ¬„çš„æ›è¼‰ç‰©è³‡ï¼Œæ”¯æ´æŒä¹…åŒ–é–å®šã€‚
 */
window.openTacticalLoadout = function() {
    const existing = document.getElementById('loadout-modal');
    if (existing) existing.remove();

    // 0. ğŸ”¥ ã€ç‰©ç†æ•¸æ“šåˆå§‹åŒ–ã€‘ç¢ºä¿æ§½ä½èˆ‡åº«å­˜çµæ§‹å®Œæ•´ [cite: 2026-01-21]
    player.tacticalSlots = player.tacticalSlots || ['hp_pot', 'antidote', 'stimulant'];
    player.items = player.items || {};
    let activeSlotIdx = 0; // é è¨­é¸ä¸­ç¬¬ä¸€å€‹æ§½ä½

    const modal = document.createElement('div');
    modal.id = 'loadout-modal';
    
    // ğŸ¨ ã€è¨­è¨ˆé­‚å°æ­£ã€‘æ¥µç°¡åœ“è§’å¡ç‰‡èˆ‡æ¯›ç»ç’ƒèƒŒæ™¯ [cite: 2026-01-19]
    modal.style = `
        position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
        width: 380px; background: rgba(15, 15, 20, 0.98); border: 2px solid #3498db;
        z-index: 130000; padding: 30px; border-radius: 28px; color: #eee;
        box-shadow: 0 40px 120px rgba(0,0,0,1); backdrop-filter: blur(30px); font-family: monospace;
        animation: popupFadeIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    `;

    // --- ğŸ—ï¸ å…§éƒ¨æ¸²æŸ“å™¨ï¼šæ›´æ–°æ§½ä½è¦–è¦º (Slot Visuals) ---
    const renderSlots = () => {
        const itemMeta = {
            'hp_pot':    { icon: 'ğŸº', name: 'å†é€ ç½' },
            'potion':    { icon: 'ğŸ§´', name: 'è—¥æ°´' },
            'antidote':  { icon: 'ğŸ§ª', name: 'è§£æ¯’' },
            'hemostat':  { icon: 'ğŸ©¹', name: 'æ­¢è¡€' },
            'stimulant': { icon: 'ğŸ’‰', name: 'èˆˆå¥®åŠ‘' },
            'none':      { icon: 'ğŸš«', name: 'ç©º' }
        };

        return player.tacticalSlots.map((id, i) => {
            const info = itemMeta[id] || itemMeta['none'];
            const isActive = (activeSlotIdx === i);
            return `
                <div class="loadout-slot" onclick="window.selectLoadoutSlot(${i})" style="
                    flex: 1; background: ${isActive ? 'rgba(52, 152, 219, 0.2)' : 'rgba(255,255,255,0.02)'};
                    border: 2px solid ${isActive ? '#3498db' : '#333'};
                    border-radius: 20px; padding: 15px 5px; text-align: center; 
                    cursor: pointer; transition: all 0.2s ease;
                    box-shadow: ${isActive ? '0 0 15px rgba(52, 152, 219, 0.3)' : 'none'};
                ">
                    <div style="font-size: 9px; color: #666; margin-bottom: 8px; letter-spacing:1px;">SLOT ${i+1}</div>
                    <div style="font-size: 32px; filter: drop-shadow(0 4px 4px rgba(0,0,0,0.5));">${info.icon}</div>
                    <div style="font-size: 11px; margin-top: 8px; color: ${isActive ? '#3498db' : '#888'}; font-weight:900;">${info.name}</div>
                </div>
            `;
        }).join('');
    };

    // --- ğŸ—ï¸ å…§éƒ¨æ¸²æŸ“å™¨ï¼šç‰©è³‡æ¸…å–® (Inventory Grid) ---
    const renderPicker = () => {
        const items = [
            { id: 'hp_pot', icon: 'ğŸº', name: 'è£œè¡€ç½' },
            { id: 'potion', icon: 'ğŸ§´', name: 'è—¥æ°´' },
            { id: 'antidote', icon: 'ğŸ§ª', name: 'è§£æ¯’è—¥' },
            { id: 'hemostat', icon: 'ğŸ©¹', name: 'æ­¢è¡€åŠ‘' },
            { id: 'stimulant', icon: 'ğŸ’‰', name: 'èˆˆå¥®åŠ‘' },
            { id: 'none', icon: 'ğŸš«', name: 'å¸ä¸‹' }
        ];

        return items.map(item => {
            const count = player.items[item.id] || 0;
            const isSelected = player.tacticalSlots.includes(item.id);
            return `
                <div class="picker-item-card" onclick="window.assignItemToSlot('${item.id}')" style="
                    background: rgba(255, 255, 255, 0.05); border: 1px solid ${isSelected ? '#3498db' : '#444'};
                    border-radius: 16px; padding: 12px; text-align: center; cursor: pointer; transition: 0.2s;
                    position: relative;
                " onmouseover="this.style.borderColor='#3498db'" onmouseout="this.style.borderColor='${isSelected ? '#3498db' : '#444'}'">
                    <div style="font-size: 24px;">${item.icon}</div>
                    <div style="font-size: 10px; margin-top: 6px; font-weight:bold; color:#fff;">${item.name}</div>
                    <div style="font-size: 9px; color: ${count > 0 ? '#2ecc71' : '#555'}; margin-top:4px;">åº«å­˜: ${count}</div>
                </div>
            `;
        }).join('');
    };

    const updateUI = () => {
        modal.innerHTML = `
            <div style="text-align:center; margin-bottom:25px;">
                <b style="color:#3498db; font-size:20px; letter-spacing:4px; text-shadow: 0 0 15px rgba(52, 152, 219, 0.3);">âš”ï¸ æˆ°è¡“æ›è¼‰æ•´å‚™</b>
                <div style="font-size:10px; color:#555; margin-top:8px; letter-spacing:2px;">- TACTICAL_LOADOUT_PROPORTION -</div>
            </div>
            
            <div style="display:flex; gap:15px; margin-bottom:35px;">
                ${renderSlots()}
            </div>

            <div style="margin-bottom:15px; font-size:11px; color:#888; font-weight:bold; letter-spacing:1px; display:flex; justify-content:space-between;">
                <span>é¸å–æ’¥ç™¼ç‰©è³‡</span>
                <span style="color:#f1c40f;">âœ¨ æŒæœ‰ç‰©å“å¯é‡è¤‡æ›è¼‰</span>
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; background: rgba(0, 0, 0, 0.3); padding: 18px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.05);">
                ${renderPicker()}
            </div>

            <div style="display:flex; gap:12px; margin-top:35px;">
                <button onclick="window.finalizeLoadout()" style="flex:2; padding:18px; background: linear-gradient(135deg, #3498db, #2980b9); color:#fff; border:none; border-radius:16px; font-weight:900; font-size:16px; cursor:pointer; box-shadow: 0 10px 25px rgba(52, 152, 219, 0.4); transition: 0.2s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                    ç‰©ç†æ€§é–å®šé…ç½®
                </button>
                <button onclick="document.getElementById('loadout-modal').remove()" style="flex:1; padding:18px; background:rgba(255,255,255,0.05); color:#888; border:1px solid #444; border-radius:16px; font-weight:bold; cursor:pointer; transition:0.2s;">
                    å–æ¶ˆ
                </button>
            </div>
        `;
    };

    // --- ğŸ­ ç‰©ç†äº’å‹•å®šç¾© ---
    window.selectLoadoutSlot = (i) => { activeSlotIdx = i; updateUI(); };
    
    window.assignItemToSlot = (id) => { 
        player.tacticalSlots[activeSlotIdx] = id; 
        updateUI(); 
    };

    window.finalizeLoadout = async () => {
        // 1. ğŸ”¥ ã€ç‰©ç†æ•¸æ“šæŒä¹…åŒ–ã€‘å°‡é…ç½®å¯«å…¥å¤§ä¸€çµ±ç‡ƒæ–™åŒ… [cite: 2026-01-21]
        if (typeof savePlayerToDB === 'function') await savePlayerToDB();
        
        showNotification("âœ¨ æˆ°è¡“é…ç½®å·²ç‰©ç†é–å®šï¼");
        
        // 2. ğŸ¬ ã€UI åŒæ­¥ã€‘è‹¥åœ¨å°å±€ä¸­ï¼ŒåŒæ­¥é‡ç¹ª HUD ç”Ÿå‘½çƒæ—çš„ç‰©å“æ¬„ [cite: 2026-02-06]
        const table = document.getElementById('poker-table');
        if (table && typeof renderPokerTable === 'function') {
            renderPokerTable(table);
        }
        
        modal.remove();
    };

    updateUI();
    document.body.appendChild(modal);
};



/**
 * ğŸ“¦ ç‰©ç†æ¡è³¼å¼•æ“ (æ‰¹é‡è³¼è²·ç‰ˆ)
 * ä½œç”¨ï¼šè™•ç†æ•¸é‡ä¹˜æ³•ã€VIP æŠ˜æ‰£ã€æ•¸æ“šç´¯åŠ ä¸¦ç«‹å³é–å®šè³‡æ–™åº«
 */
window.buyItemBatch = async function(itemId, price) {
    const qtyInput = document.getElementById(`qty-${itemId}`);
    const quantity = parseInt(qtyInput.value) || 1;
    const isVip = player.hasVipCard;
    
    // ç‰©ç†è¨ˆåƒ¹ï¼šå« VIP 8 æŠ˜å„ªæƒ 
    const finalPrice = isVip ? Math.floor(price * 0.8) : price;
    const totalCost = finalPrice * quantity;

    if (player.coin < totalCost) {
        showNotification("ğŸ’€ é‡‘å¹£ä¸è¶³ï¼ç„¡æ³•æ”¯ä»˜æ­¤æ•¸é‡çš„è»å‚™ã€‚");
        return;
    }

    // 1. åŸ·è¡Œç‰©ç†æ‰£æ¬¾
    player.coin -= totalCost;

    // 2. ç‰©ç†æ•¸æ“šç´¯åŠ ï¼šç¢ºä¿ä¸è¦†è“‹èˆŠæœ‰æ•¸é‡ï¼Œä¸¦åˆå§‹åŒ–ç‰©ä»¶é˜²æ­¢ null
    player.items = player.items || {};
    player.items[itemId] = (Number(player.items[itemId]) || 0) + quantity;

    // 3. ğŸ”¥ ã€æ ¸å¿ƒåŒæ­¥é–ã€‘ç«‹å³å¯«å…¥ IndexedDBï¼Œç¢ºä¿ Scene åˆ‡æ›æ™‚æ•¸æ“šå·²ç‰©ç†æŒä¹…åŒ–
    if (typeof savePlayerToDB === 'function') {
        await savePlayerToDB(); 
    }

    showNotification(`ğŸ›’ æˆåŠŸè³¼å…¥ ${quantity} å–®ä½ã€${itemId}ã€‘ï¼ç‰©è³‡å·²å…¥åº«ã€‚`);
    
    // 4. åŒæ­¥åˆ·æ–° UI (é‡‘å¹£é¡¯ç¤ºèˆ‡å•†åº—æ¸…å–®)
    if (typeof openKingdomShop === 'function') openKingdomShop();
    if (typeof updatePlayerUI === 'function') updatePlayerUI();
};

/**
 * ğŸ’¾ å…¨åŸŸè™•ç†ç¨‹åºï¼šå„²å­˜æ•´å‚™é…ç½®
 */
window.saveTacticalLoadout = async function() {
    for (let i = 0; i < 3; i++) {
        player.tacticalSlots[i] = document.getElementById(`slot-select-${i}`).value;
    }
    document.getElementById('loadout-modal').remove();
    if (typeof savePlayerToDB === 'function') await savePlayerToDB();
    showNotification("âš”ï¸ æˆ°è¡“æ›è¼‰å·²æ›´æ–°ã€‚");
};


// --- 1. ç‰©ç†åˆå§‹åŒ–è³‡æ–™åº« (Roguelike åäººå ‚å‡ç´šç‰ˆ) ---
const db = new Dexie("TabiSatoriV3");

// ç‰©ç†å‡ç´šè‡³ç‰ˆæœ¬ 4ï¼Œæ–°å¢åäººå ‚ç´¢å¼•
db.version(4).stores({
    fuelPacks: '++id, difficulty, name, notes, vocab, phrases',
    playerStats: 'id, lv, exp, coin, inventory, collection, streak, kingStreak',
    // ğŸ† åäººå ‚ï¼šè¨˜éŒ„æ¯ä¸€ä»£å‹‡è€…çš„çµ‚ç„‰èˆ‡æˆå°±
    hallOfFame: '++id, date, lv, totalWins, totalLoot, deathCause'
});

db.open().catch(err => {
    console.error("âŒ IndexedDB é–‹å•Ÿå¤±æ•—:", err.stack || err);
});



/**
 * ğŸ› ï¸ æ•¸æ“šä¸­æ¨ï¼šç‡ƒæ–™åŒ…å¤§ä¸€çµ±å°è£ (V5.9.42 å®Œå…¨é«”)
 * ä½œç”¨ï¼šç¢ºä¿ VIPã€åœ‹åº«ã€è‚¡å¸‚ã€è£å‚™ã€å±¬æ€§ã€æˆ°è¡“è…°å¸¶èˆ‡åäººå ‚ç‰©ç†å°é½Š
 */
const getUnifiedSavePayload = () => {
    // 1. ğŸ”¥ ç‰©ç†é˜²å‘†ï¼šè‚¡å¸‚ K ç·šä¿®å‰ª (é˜²æ­¢å–®ä¸€ JSON éå¤§å°è‡´é›²ç«¯æ‹’æ”¶)
    // åªä¿ç•™æœ€è¿‘ 80 æ ¹ K ç·š (candles) èˆ‡ 50 ç­†åƒ¹æ ¼æ­·å² (history)
    let safeStocks = [];
    if (window.kingdomStocks && Array.isArray(window.kingdomStocks)) {
        safeStocks = JSON.parse(JSON.stringify(window.kingdomStocks)).map(s => {
            if (s.candles && s.candles.length > 80) s.candles = s.candles.slice(-80);
            if (s.history && s.history.length > 50) s.history = s.history.slice(-50);
            return s;
        });
    }

    return {
        id: 'hero',
        
        // --- ğŸŸ¢ æ ¸å¿ƒé«”å¾µ (Core Stats) ---
        lv: player.lv,
        exp: player.exp,
        coin: player.coin,
        phantomDust: player.phantomDust || 0,
        currentHp: player.currentHp || 50,
        maxHp: player.maxHp || 50,
        title: player.title || "ğŸŒ± åˆç´šå†’éšªè€…",
        
        // --- ğŸ›¡ï¸ ç‰©ç†è£å‚™èˆ‡ç´ è³ª (Equips & Attributes) ---
        // æ·±åº¦æ‹·è²ï¼Œé˜²æ­¢ F5 è£¸é«”èˆ‡å±¬æ€§æ­¸é›¶ [cite: 2026-02-06]
        equips: player.equips ? JSON.parse(JSON.stringify(player.equips)) : {},
        // ğŸ”¥ æˆ°è¡“è…°å¸¶é…ç½® (Slot 1-3)
        tacticalSlots: player.tacticalSlots ? [...player.tacticalSlots] : ['hp_pot', 'antidote', 'stimulant'],
        // ğŸ”¥ æˆé•·å±¬æ€§é…é» (STR/STA/AGI/INT)
        attributes: player.attributes ? JSON.parse(JSON.stringify(player.attributes)) : { str: 0, sta: 0, agi: 0, int: 0, block: 0, eva: 0, p_eva: 0 },

        // --- ğŸ’ ç‰©è³‡èˆ‡è³‡ç”¢ (Inventory) ---
        items: player.items ? JSON.parse(JSON.stringify(player.items)) : { potion: 0, antidote: 0, hp_pot: 0 },
        inventory: Array.isArray(player.inventory) ? [...player.inventory] : [],
        collection: Array.isArray(player.collection) ? [...player.collection] : [], // åœ–é‘‘
        vault: Array.isArray(player.vault) ? [...player.vault] : [],
        vaultGold: player.vaultGold || 0,
        
        // --- ğŸ‘‘ VIP èˆ‡ ç¦å¿Œç‹€æ…‹ (Status) ---
        hasVipCard: !!player.hasVipCard,
        totalShopSpent: player.totalShopSpent || 0,
        activeForbiddenItem: player.activeForbiddenItem || null, 

        // --- ğŸ—ï¸ ç‹åœ‹ç¶“æ¿Ÿé«” (Kingdom) ---
        kingdomSystem: window.kingdomSystem ? JSON.parse(JSON.stringify(window.kingdomSystem)) : {
            treasury: 0, upgrades: {}, playerInvestmentTotal: 0, totalDividendsIssued: 0
        },
        
        // --- ğŸ“ˆ è‚¡å¸‚å…¨ç´€éŒ„ (Stock Market) ---
        kingdomStocks: safeStocks,

        // --- ğŸ“œ ç´€éŒ„èˆ‡é€²åº¦ (Progress & Logs) ---
        mapProgress: player.mapProgress || { N5:0, N4:0, N3:0, N2:0, N1:0 },
        homeUpgrades: player.homeUpgrades || { bed: 1, vault: 1, bookshelf: 1 },
        kingStreak: player.kingStreak || 0,
        maxKingStreak: player.maxKingStreak || 0,
        logs: Array.isArray(player.logs) ? JSON.parse(JSON.stringify(player.logs.slice(-50))) : [], // åªå­˜æœ€è¿‘ 50 ç­†æ—¥èªŒ
        medals: Array.isArray(player.medals) ? [...player.medals] : [],
        
        // --- ğŸ•’ æ™‚é–“æˆ³è¨˜ ---
        lastSave: Date.now()
    };
};


// =========================================
// ğŸ’ è£å‚™åœ–é‘‘ä¸»è³‡æ–™åº« (æ“´å……ç‰ˆ V2.0)
// =========================================
const MASTER_COLLECTION = [


    // --- ğŸ› ï¸ æ–°æ‰‹èˆ‡é›œé …è£œå®Œ (Starter & Misc) ---
    { id: "misc_note", type: "offhand", name: "ğŸ“” ä¹¾æ·¨çš„ç­†è¨˜æœ¬", stats: { def: 1, timer: 1 }, desc: "éš¨è™•å¯è¦‹çš„ç­†è¨˜æœ¬ï¼Œç¨å¾®èƒ½æ“‹é»å‚·å®³ã€‚" },
    { id: "misc_tape", type: "head", name: "ğŸ©¹ ç²¾ç¥è† å¸¶", stats: { def: 1, hp: 5 }, desc: "è²¼åœ¨é ­ä¸Šæ„Ÿè¦ºç²¾ç¥å¤šäº†ï¼Œé›–ç„¶å¾ˆé†œã€‚" },
    { id: "misc_wood_sword", type: "weapon", name: "ğŸ—¡ï¸ å‚³èªªçš„æœ¨åˆ€", stats: { atk: 3 }, desc: "é›–ç„¶å«å‚³èªªï¼Œä½†å…¶å¯¦åªæ˜¯æ´çˆºæ¹–è²·çš„ç´€å¿µå“ã€‚" },
    { id: "misc_old_shield", type: "offhand", name: "ğŸ›¡ï¸ ç ´èˆŠçš„ç›¾", stats: { def: 3 }, desc: "ç”šè‡³é‚„æœ‰ç ´æ´ï¼Œä½†ç¸½æ¯”æ²’æœ‰å¥½ã€‚" },
    { id: "misc_apple", type: "artifact", name: "ğŸ ç”Ÿå‘½ä¹‹æœ", stats: { hp: 20 }, desc: "é£Ÿç”¨å¾Œæ°¸ä¹…å¢åŠ ç”Ÿå‘½ä¸Šé™ (è‡ªå‹•ç”Ÿæ•ˆ)ã€‚" },

    // --- âš”ï¸ ä¸»æ‰‹æ­¦å™¨ (Weapon) ---
    { id: "pen_01", type: "weapon", name: "ğŸ–‹ï¸ æ™®é€šåŸå­ç­†", stats: { atk: 5 }, desc: "æœ€åŸºç¤çš„å¯«å­—å·¥å…·ï¼Œå‹‰å¼·èƒ½ç”¨ã€‚" },
    { id: "pen_02", type: "weapon", name: "ğŸ”¥ è–åŠï¼šæ—¥æª¢ä¸€æ–‡å­—", stats: { atk: 50, element: "fire" }, desc: "ç‡ƒç‡’è‘—å­¸ç¿’ç†±æƒ…çš„è–åŠï¼Œå°å†°ç³»é­”ç‰© 2 å€å‚·ã€‚" },
    { id: "pen_03", type: "weapon", name: "â„ï¸ é›¶åº¦åŸå­ç­†", stats: { atk: 45, element: "ice" }, desc: "æ›¸å¯«æ™‚æœƒçµéœœï¼Œå‡çµç«ç³»é­”ç‰©çš„åæ“Šé »ç‡ã€‚" },
    { id: "pen_04", type: "weapon", name: "âš¡ é–ƒé›»é‹¼ç­†", stats: { atk: 60, element: "thunder" }, desc: "ç¥é€Ÿæ€ç¶­ï¼š20% æ©Ÿç‡è§¸ç™¼é€£çºŒæ”»æ“Šã€‚" },
    { id: "pen_05", type: "weapon", name: "ğŸƒ è³­å¾’çš„éµæ¯›ç­†", stats: { atk: 30, pokerLuck: 0.1 }, desc: "æ›ç‰Œéšæ®µæ‹¿åˆ°å¤§ç‰Œæ©Ÿç‡+10%ã€‚" },
    { id: "wpn_06", type: "weapon", name: "ğŸŒ³ ä¸–ç•Œæ¨¹æ¨¹æ", stats: { atk: 25, hp: 50 }, desc: "è˜Šå«ç”Ÿå‘½åŠ›çš„æ¨¹æï¼Œæ”»æ“ŠåŠ›é›–ä½ä½†èƒ½æå‡é«”åŠ›ã€‚" },
    { id: "wpn_07", type: "weapon", name: "ğŸ—¡ï¸ é¾éª¨å¤§åŠ", stats: { atk: 85, def: -10 }, desc: "æ¥µåº¦æ²‰é‡ï¼ŒçŠ§ç‰²é˜²ç¦¦æ›å–æ¯€æ»…æ€§çš„ç ´å£åŠ›ã€‚" },
    { id: "wpn_08", type: "weapon", name: "ğŸ§› é®®è¡€åˆºé‡", stats: { atk: 40, drain: 0.05 }, desc: "æ¯æ¬¡æ”»æ“Šæ¢å¾© 5% é€ æˆå‚·å®³çš„è¡€é‡ã€‚" },
    { id: "wpn_09", type: "weapon", name: "âš–ï¸ å¯©åˆ¤ä¹‹éŒ˜", stats: { atk: 55, crit: 0.1 }, desc: "å°ç½ªäººæ¯«ä¸ç•™æƒ…ï¼Œæ“æœ‰ 10% æš´æ“Šç‡ã€‚" },
    { id: "wpn_10", type: "weapon", name: "ğŸ‘» å¹½éˆåŒ•é¦–", stats: { atk: 35, dodge: 0.05 }, desc: "ç„¡å½¢çš„åˆ€åˆƒï¼Œèƒ½ç©¿è¶Šé˜²ç¦¦ä¸¦æå‡é–ƒé¿ã€‚" },
    { id: "artifact_scepter", type: "weapon", name: "ğŸ’€ å¯©åˆ¤è€…çš„è¡€è…¥æ¬Šæ–", stats: { atk: 250, drain: 0.2 }, desc: "ç¥è©±æ­¦å™¨ï¼šæ”»æ“Šå¸è¡€ 20%ï¼Œè±¡å¾µç„¡ä¸Šçš„æ¬ŠåŠ›ã€‚" },

    // ----------------------------------------------------------------
    // âš”ï¸ ç¥å™¨ç´šæ­¦å™¨ (Artifact Weapons)
    // ----------------------------------------------------------------
    { id: "art_wpn_01", type: "weapon", name: "ğŸŒŒ è™›ç©ºä¹‹ç­†ï¼šå‰µä¸–ç´€", stats: { atk: 120, timer: 5 }, desc: "å‚³èªªä¸­ç¹ªè£½ä¸–ç•Œçš„ç­†ï¼Œæ›¸å¯«æ™‚èƒ½æš«åœæ™‚é–“çš„æµå‹•ã€‚" },
    { id: "art_wpn_02", type: "weapon", name: "ğŸ”¥ ç‚é­”çš„æ†¤æ€’", stats: { atk: 90, element: "fire", crit: 0.15 }, desc: "å°å°è‘—ç‚é­”éˆé­‚çš„é‹¼ç­†ï¼Œå¢¨æ°´å¦‚åŒå²©æ¼¿èˆ¬æ»¾ç‡™ã€‚" },
    { id: "art_wpn_03", type: "weapon", name: "â„ï¸ çµ•å°é›¶åº¦", stats: { atk: 85, element: "ice", timer: 2 }, desc: "èƒ½å‡çµæ€è€ƒçš„æ¥µå¯’ä¹‹ç­†ï¼Œè®“æ•µäººçš„å‹•ä½œè®Šå¾—é²ç·©ã€‚" },
    { id: "art_wpn_04", type: "weapon", name: "âš¡ é›·ç¥ä¹‹éŒ˜ç­†", stats: { atk: 100, element: "thunder", crit: 0.1 }, desc: "ç­†å°–é–ƒçˆè‘—é›·å…‰ï¼Œæ¯ä¸€åŠƒéƒ½ä¼´éš¨è‘—è½Ÿé³´è²ã€‚" },
    { id: "art_wpn_05", type: "weapon", name: "ğŸ² é¾ç‹é€†é±—åŠ", stats: { atk: 150, def: -20 }, desc: "ç”±å¤é¾é€†é±—æ‰“ç£¨è€Œæˆï¼Œé›–ç„¶å±éšªä½†ç ´å£åŠ›é©šäººã€‚" },
    { id: "art_wpn_06", type: "weapon", name: "ğŸ©¸ é®®è¡€ä¼¯çˆµçš„å¥‘ç´„", stats: { atk: 70, drain: 0.25 }, desc: "ç°½è¨‚å¥‘ç´„è€…å°‡ç²å¾—æ°¸ç”Ÿ...ä»¥æ•µäººçš„é®®è¡€ç‚ºä»£åƒ¹ã€‚" },
    { id: "art_wpn_07", type: "weapon", name: "âš–ï¸ çœŸç†è£æ±ºè€…", stats: { atk: 80, hintChance: 0.3 }, desc: "åªæœ‰æ›¸å¯«çœŸç†æ™‚æ‰æœƒé¡¯ç¾å¢¨æ°´ï¼Œå¤§å¹…å¢åŠ çœ‹ç ´è¬Šè¨€çš„æ©Ÿç‡ã€‚" },
    { id: "art_wpn_08", type: "weapon", name: "ğŸ° å‘½é‹çš„è¼ªç›¤", stats: { atk: 10, pokerLuck: 0.5 }, desc: "æ”»æ“ŠåŠ›é›–ä½ï¼Œä½†èƒ½æ¥µå¤§å¹…åº¦æ‰­è½‰è³­å±€çš„é‹å‹¢ã€‚" },

    // --- ğŸ›¡ï¸ å‰¯æ‰‹/ç›¾ç‰Œ (Offhand) ---
    { id: "off_01", type: "offhand", name: "ğŸ›¡ï¸ èªæ³•ä¹‹ç›¾", stats: { def: 30, block: 0.1 }, desc: "å …å›ºçš„ç›¾ç‰Œï¼Œ10% æ©Ÿç‡å®Œå…¨æ ¼æ“‹å‚·å®³ã€‚" },
    { id: "off_02", type: "offhand", name: "ğŸ“š ç ´èˆŠçš„å–®å­—æ›¸", stats: { def: 5, atk: 10 }, desc: "çŸ¥è­˜å°±æ˜¯åŠ›é‡ï¼Œå¾®å¹…æå‡æ”»æ“ŠåŠ›ã€‚" },
    { id: "off_03", type: "offhand", name: "ğŸ”® è™›ç©ºæç‡ˆ", stats: { def: 10, vision: true }, desc: "ç…§äº®ç•°ç•Œè¿·éœ§ï¼Œé™ä½é‡æ•µæ©Ÿç‡ã€‚" },
    { id: "off_04", type: "offhand", name: "ğŸªµ æœ¨æ¡¶è“‹", stats: { def: 8 }, desc: "éš¨æ‰‹æ’¿ä¾†çš„è“‹å­ï¼ŒèŠå‹æ–¼ç„¡ã€‚" },
    { id: "off_05", type: "offhand", name: "âšœï¸ é¨å£«ç´‹ç« ç›¾", stats: { def: 50 }, desc: "çš‡å®¶é¨å£«çš„åˆ¶å¼è£å‚™ï¼Œé˜²ç¦¦æ€§èƒ½å„ªç•°ã€‚" },
    { id: "off_06", type: "offhand", name: "ğŸ“œ å¤ä»£å·è»¸", stats: { atk: 20, timer: 2 }, desc: "è¨˜è¼‰è‘—å¤±è½çš„é­”æ³•ï¼Œæå‡æ”»æ“Šèˆ‡ç­”é¡Œæ™‚é–“ã€‚" },
    { id: "off_07", type: "offhand", name: "ğŸŒµ èŠæ£˜ç›¾", stats: { def: 20, reflect: 0.1 }, desc: "å—åˆ°æ”»æ“Šæ™‚ï¼Œåå½ˆ 10% å‚·å®³çµ¦æ”»æ“Šè€…ã€‚" },
    { id: "off_08", type: "offhand", name: "ğŸ’° å•†äººçš„ç®—ç›¤", stats: { coinMult: 1.1 }, desc: "ç²¾æ‰“ç´°ç®—ï¼Œé‡‘å¹£ç²å–é‡ +10%ã€‚" },
    { id: "off_09", type: "offhand", name: "ğŸ‰ é¾é±—è­·æ‰‹", stats: { def: 40, elementResist: "fire" }, desc: "å¤§å¹…é™ä½ç«å±¬æ€§å‚·å®³ã€‚" },
    { id: "off_10", type: "offhand", name: "ğŸ’€ æ­»éˆæ³•çƒ", stats: { atk: 30, hp: -20 }, desc: "å¼·å¤§çš„é»‘é­”æ³•åª’ä»‹ï¼Œä½†æœƒä¾µè•æŒæœ‰è€…çš„ç”Ÿå‘½ã€‚" },
    
    // ----------------------------------------------------------------
    // ğŸ›¡ï¸ ç¥å™¨ç´šå‰¯æ‰‹ (Artifact Offhands)
    // ----------------------------------------------------------------
    { id: "art_off_01", type: "offhand", name: "ğŸ›¡ï¸ åŸƒç™¸æ–¯ä¹‹ç›¾", stats: { def: 80, block: 0.2 }, desc: "é›…å…¸å¨œçš„ç¥ç›¾ï¼Œæ“æœ‰ 20% æ©Ÿç‡å®Œå…¨ç„¡æ•ˆåŒ–æ”»æ“Šã€‚" },
    { id: "art_off_02", type: "offhand", name: "ğŸ“š å…¨çŸ¥å…¨èƒ½ä¹‹æ›¸", stats: { atk: 30, def: 30, expMult: 1.2 }, desc: "è¨˜è¼‰è‘—ä¸–é–“ä¸€åˆ‡çŸ¥è­˜ï¼ŒæŒæœ‰è€…å°‡é£›é€Ÿæˆé•·ã€‚" },
    { id: "art_off_03", type: "offhand", name: "ğŸ”® æ™‚é–“æ²™æ¼", stats: { timer: 10 }, desc: "èƒ½å€’æµæ™‚å…‰çš„æ²™æ¼ï¼Œç­”é¡Œæ™‚é–“å¤§å¹… +10 ç§’ã€‚" },
    { id: "art_off_04", type: "offhand", name: "ğŸ‘ï¸ åƒçœ¼é­”ç‡ˆ", stats: { vision: true, hintChance: 0.2 }, desc: "ç„¡æ•¸çœ¼ç›æ³¨è¦–è‘—é»‘æš—ï¼Œå¾¹åº•ç…§äº®åœ°åœ–ä¸¦çœ‹ç©¿è¬é¡Œã€‚" },
    { id: "art_off_05", type: "offhand", name: "âš°ï¸ æ³•è€ç‹çš„çŸ³æ¿", stats: { def: 50, hp: 100 }, desc: "åˆ»æœ‰ä¸æ­»å’’æ–‡ï¼Œå¤§å¹…æå‡ç”Ÿå‘½åŠ›èˆ‡é˜²ç¦¦ã€‚" },
    { id: "art_off_06", type: "offhand", name: "ğŸª çœŸå¯¦ä¹‹é¡", stats: { reflect: 0.3 }, desc: "åå°„ 30% å—åˆ°çš„å‚·å®³çµ¦æ”»æ“Šè€…ã€‚" },

    // --- ğŸ‘‘ é ­éƒ¨ (Head) ---
    { id: "hat_01", type: "head", name: "ğŸ‘‘ è³¢è€…ä¹‹å† ", stats: { timer: 5, def: 5 }, desc: "æ€ç·’æ¸…æ™°ï¼Œç­”é¡Œæ™‚é–“ +5 ç§’ã€‚" },
    { id: "hat_02", type: "head", name: "ğŸ§ è½è§£è€³æ©Ÿ", stats: { hintChance: 0.2, def: 2 }, desc: "å°ˆæ³¨è†è½ï¼Œ20% æ©Ÿç‡æ’é™¤ä¸€å€‹éŒ¯èª¤é¸é …ã€‚" },
    { id: "hat_03", type: "head", name: "ğŸ‘“ é€è¦–çœ¼é¡", stats: { scanEnemy: true }, desc: "ç§‘æŠ€ç”¢ç‰©ï¼Œèƒ½çœ‹ç ´é­”ç‰©çš„å¼±é»å±¬æ€§ã€‚" },
    { id: "hat_04", type: "head", name: "ğŸ§¢ ç ´èˆŠçš„é´¨èˆŒå¸½", stats: { def: 3 }, desc: "é®é™½ç”¨ï¼Œé˜²ç¦¦åŠ›æ¥µä½ã€‚" },
    { id: "hat_05", type: "head", name: "ğŸª– ç¤¦å·¥å®‰å…¨å¸½", stats: { def: 15, hp: 10 }, desc: "å …å›ºè€ç”¨ï¼Œç¨å¾®æå‡é«”åŠ›ã€‚" },
    { id: "hat_06", type: "head", name: "ğŸ§™â€â™‚ï¸ å·«å¸«å°–å¸½", stats: { atk: 15, def: 5 }, desc: "å‡èšé­”åŠ›ï¼Œæå‡æ”»æ“ŠåŠ›ã€‚" },
    { id: "hat_07", type: "head", name: "ğŸ­ å°ä¸‘é¢å…·", stats: { dodge: 0.05, pokerLuck: 0.05 }, desc: "è®“äººæ‰æ‘¸ä¸å®šï¼Œå¾®å¹…æå‡é–ƒé¿èˆ‡è³­é‹ã€‚" },
    { id: "hat_08", type: "head", name: "ğŸ¦Š å¿è€…é ­å·¾", stats: { dodge: 0.1 }, desc: "è¼•ç›ˆçš„é ­å·¾ï¼Œæå‡é–ƒé¿ç‡ 10%ã€‚" },
    { id: "hat_09", type: "head", name: "ğŸ¦ ç…ç‹æˆ°ç›”", stats: { atk: 10, def: 25 }, desc: "å¨é¢¨å‡œå‡œï¼Œæ”»å®ˆå…¼å‚™ã€‚" },
    { id: "hat_10", type: "head", name: "ğŸ’ æ°´æ™¶é ­å† ", stats: { expMult: 1.1 }, desc: "æ•£ç™¼æ™ºæ…§å…‰èŠ’ï¼Œç¶“é©—ç²å– +10%ã€‚" },
    { id: "ultimate_crown", type: "head", name: "ğŸ‘‘ å§‹ç¥–ç‹çš„çœŸçš‡å† ", stats: { timer: 20, atk: 80, def: 80 }, desc: "ç¥è©±é ­ç›”ï¼šå…¨å±¬æ€§å¤§å¹…æå‡ï¼Œç‹è€…çš„è±¡å¾µã€‚" },
    // ----------------------------------------------------------------
    // ğŸ‘‘ ç¥å™¨ç´šé ­ç›” (Artifact Helms)
    // ----------------------------------------------------------------
    { id: "art_hat_01", type: "head", name: "ğŸ‘‘ æ‰€ç¾…é–€çš„æ™ºæ…§", stats: { timer: 8, hintChance: 0.25 }, desc: "è³¦äºˆæŒæœ‰è€…ç„¡ä¸Šçš„æ™ºæ…§ï¼Œèƒ½è¼•æ˜“çœ‹ç©¿è€ƒé¡Œã€‚" },
    { id: "art_hat_02", type: "head", name: "ğŸ§¢ éš±å½¢å¸½", stats: { dodge: 0.2, def: 10 }, desc: "å¸Œè‡˜ç¥è©±ä¸­çš„å¯¶ç‰©ï¼Œå¤§å¹…æå‡é–ƒé¿ç‡ã€‚" },
    { id: "art_hat_03", type: "head", name: "ğŸ¦ å°¼ç±³äºç…ç›”", stats: { def: 60, atk: 20 }, desc: "åˆ€æ§ä¸å…¥çš„ç…çš®ï¼Œæä¾›æ¥µé«˜çš„ç‰©ç†é˜²ç¦¦ã€‚" },
    { id: "art_hat_04", type: "head", name: "ğŸ¤– æˆ°è¡“åˆ†æç›®é¡", stats: { scanEnemy: true, crit: 0.1 }, desc: "è‡ªå‹•åˆ†ææ•µäººå¼±é»ï¼Œä¸¦æ¨™è¨˜è‡´å‘½éƒ¨ä½ã€‚" },
    { id: "art_hat_05", type: "head", name: "ğŸ§› é®®è¡€é¢å…·", stats: { drain: 0.1, atk: 30 }, desc: "æ¿€ç™¼å—œè¡€æœ¬èƒ½ï¼Œæå‡æ”»æ“Šèˆ‡å¸è¡€ã€‚" },

    // --- ğŸ§¥ èº«é«”ç›”ç”² (Body) ---
    { id: "armor_01", type: "body", name: "ğŸ§¥ å†’éšªè€…çš®ç”²", stats: { def: 15 }, desc: "æ¨™æº–çš„æ–°æ‰‹è£å‚™ï¼Œè¼•ä¾¿å¥½æ´»å‹•ã€‚" },
    { id: "armor_02", type: "body", name: "ğŸ§¥ æ¼†é»‘é•·è¢", stats: { def: 25, dodge: 0.15 }, desc: "èå…¥é™°å½±ï¼Œ15% æ©Ÿç‡é–ƒé¿æ”»æ“Šã€‚" },
    { id: "armor_03", type: "body", name: "ğŸ›¡ï¸ é‡å‹å­—å…¸é§ç”²", stats: { def: 100, moveSpeed: -0.2 }, desc: "æ¥µè‡´é˜²ç¦¦ï¼Œä½†è² é‡éé«˜å°è‡´é‡æ•µç‡ä¸Šå‡ã€‚" },
    { id: "armor_04", type: "body", name: "ğŸ‘• äºéº»è¥¯è¡«", stats: { def: 2 }, desc: "èˆ’é©é€æ°£ï¼Œä½†å¹¾ä¹æ²’æœ‰é˜²ç¦¦åŠ›ã€‚" },
    { id: "armor_05", type: "body", name: "ğŸ¦º é–å­ç”²", stats: { def: 40 }, desc: "ç”±é‡‘å±¬ç’°ç·¨ç¹”è€Œæˆï¼Œå°åˆ©åˆƒé˜²è­·ä½³ã€‚" },
    { id: "armor_06", type: "body", name: "ğŸ¥‹ æ­¦é“å®¶é“æœ", stats: { atk: 10, def: 10 }, desc: "é©åˆæ ¼é¬¥çš„æœè£ï¼Œæå‡å°‘è¨±æ”»æ“Šã€‚" },
    { id: "armor_07", type: "body", name: "ğŸŒ² ç²¾éˆéŠä¿ æœ", stats: { def: 20, timer: 3 }, desc: "è¼•ç›ˆä¸”é™„å¸¶é­”åŠ›ï¼Œç­”é¡Œæ™‚é–“ +3 ç§’ã€‚" },
    { id: "armor_08", type: "body", name: "ğŸ”¥ ç´…è“®æ–—ç¯·", stats: { def: 30, elementResist: "ice" }, desc: "æº«æš–çš„æ–—ç¯·ï¼Œé™ä½å†°å±¬æ€§å‚·å®³ã€‚" },
    { id: "armor_09", type: "body", name: "ğŸŒ‘ æš—å½±åˆºå®¢è£", stats: { atk: 20, crit: 0.05 }, desc: "å°ˆç‚ºæ®ºæˆ®è¨­è¨ˆï¼Œæå‡æ”»æ“Šèˆ‡æš´æ“Šã€‚" },
    { id: "armor_10", type: "body", name: "ğŸŒŸ è–é¨å£«æ¿ç”²", stats: { def: 60, hp: 50 }, desc: "å—éç¥ç¦çš„é§ç”²ï¼Œå¤§å¹…æå‡ç”Ÿå­˜èƒ½åŠ›ã€‚" },
    // ----------------------------------------------------------------
    // ğŸ§¥ ç¥å™¨ç´šç›”ç”² (Artifact Body)
    // ----------------------------------------------------------------
    { id: "art_body_01", type: "body", name: "ğŸ§¥ é‡‘ç¾Šæ¯›", stats: { def: 50, hp: 200 }, desc: "ç§‘çˆ¾åŸºæ–¯çš„ç§˜å¯¶ï¼Œæ“æœ‰å¼·å¤§çš„æ²»ç™’èˆ‡é˜²è­·åŠ›ã€‚" },
    { id: "art_body_02", type: "body", name: "ğŸ§¥ é³³å‡°ç¾½è¡£", stats: { def: 40, elementResist: "fire" }, desc: "æµ´ç«é‡ç”Ÿçš„ç¾½è¡£ï¼Œæ¥µå¤§å¹…åº¦æ¸›å…ç«å±¬æ€§å‚·å®³ã€‚" },
    { id: "art_body_03", type: "body", name: "ğŸ›¡ï¸ çµ•å°é˜²ç¦¦åŠ›å ´", stats: { def: 150, moveSpeed: -0.3 }, desc: "é«˜ç§‘æŠ€åŠ›å ´ç™¼ç”Ÿå™¨ï¼Œé˜²ç¦¦ç„¡æ•µä½†å¯¸æ­¥é›£è¡Œã€‚" },
    { id: "art_body_04", type: "body", name: "ğŸ‘» å¹½é­‚æ³•è¢", stats: { dodge: 0.25, def: 10 }, desc: "è®“èº«é«”è®Šå¾—è™›ç„¡ç¸¹ç·²ï¼Œæ¥µé›£è¢«æ“Šä¸­ã€‚" },
    { id: "art_body_05", type: "body", name: "ğŸ’ é‘½çŸ³é­”åƒèƒ¸ç”²", stats: { def: 80, reflect: 0.15 }, desc: "å …ç¡¬ç„¡æ¯”ï¼Œä¸”èƒ½åå½ˆç‰©ç†è¡æ“Šã€‚" },
    
    // --- ğŸ§¤ æ‰‹å¥— (Gloves) ---
    { id: "glove_01", type: "gloves", name: "ğŸ§¤ æŠ„å¯«æ‰‹å¥—", stats: { def: 5, atk: 5 }, desc: "å°ˆç‚ºå¤§é‡æ›¸å¯«è¨­è¨ˆï¼Œæå‡ç­”é¡Œæ•ˆç‡ã€‚" },
    { id: "glove_02", type: "gloves", name: "ğŸ§¤ åŠ›é‡è­·è…•", stats: { atk: 15 }, desc: "å¢å¼·è…•åŠ›ï¼Œç›´æ¥æå‡ç‰©ç†æ”»æ“Šã€‚" },
    { id: "glove_03", type: "gloves", name: "ğŸ§¶ æ¯›ç·šæ‰‹å¥—", stats: { def: 2 }, desc: "å¥¶å¥¶ç¹”çš„ï¼Œå¾ˆæº«æš–ä½†æ²’ä»€éº¼é˜²ç¦¦åŠ›ã€‚" },
    { id: "glove_04", type: "gloves", name: "ğŸ¦¾ é‹¼éµè­·æ‰‹", stats: { def: 20 }, desc: "å …ç¡¬çš„é‡‘å±¬è­·æ‰‹ï¼Œé˜²ç¦¦åŠ›å„ªç§€ã€‚" },
    { id: "glove_05", type: "gloves", name: "ğŸ–ï¸ ç›œè³Šæ‰‹å¥—", stats: { coinMult: 1.1 }, desc: "æ‰‹æŒ‡éˆæ´»ï¼Œé‡‘å¹£ç²å– +10%ã€‚" },
    { id: "glove_06", type: "gloves", name: "ğŸ©¸ å¸è¡€é¬¼ä¹‹è§¸", stats: { atk: 10, drain: 0.02 }, desc: "æ¥è§¸æ™‚æœƒå¸å–å¾®é‡ç”Ÿå‘½ã€‚" },
    { id: "glove_07", type: "gloves", name: "â„ï¸ å†°éœœè­·æ‰‹", stats: { def: 10, element: "ice" }, desc: "è³¦äºˆæ”»æ“Šå¾®å¼±çš„å†°å‡æ•ˆæœã€‚" },
    { id: "glove_08", type: "gloves", name: "âš¡ é›·æ“Šæ‰‹å¥—", stats: { atk: 12, crit: 0.05 }, desc: "å¸¶æœ‰éœé›»ï¼Œæ”»æ“Šæ™‚å¶çˆ¾æœƒéº»ç—ºæ•µäººã€‚" },
    { id: "glove_09", type: "gloves", name: "ğŸ’ ç å¯¶åŒ æ‰‹å¥—", stats: { dropRate: 0.1 }, desc: "æå‡ç¨€æœ‰ç‰©å“æ‰è½ç‡ 10%ã€‚" },
    { id: "glove_10", type: "gloves", name: "ğŸ² é¾çˆªæ‰‹å¥—", stats: { atk: 30, def: 10 }, desc: "ç”¨é¾é±—è£½æˆï¼Œæ“æœ‰å¼·å¤§çš„ç ´å£åŠ›ã€‚" },
    // ----------------------------------------------------------------
    // ğŸ§¤ ç¥å™¨ç´šæ‰‹å¥— (Artifact Gloves)
    // ----------------------------------------------------------------
    { id: "art_glove_01", type: "gloves", name: "ğŸ§¤ ç„¡é™æ‰‹å¥—(è´—å“)", stats: { atk: 50, def: 50 }, desc: "é›–ç„¶åªæ˜¯è¤‡è£½å“ï¼Œä½†ä¾ç„¶æ“æœ‰é©šäººçš„åŠ›é‡ã€‚" },
    { id: "art_glove_02", type: "gloves", name: "ğŸ§¤ é»é‡‘æ‰‹", stats: { coinMult: 1.5 }, desc: "ç¢°è§¸çš„ä¸€åˆ‡éƒ½å°‡è®Šæˆé‡‘å¹£ï¼Œæ”¶ç›Š +50%ã€‚" },
    { id: "art_glove_03", type: "gloves", name: "âš¡ å®™æ–¯è­·è…•", stats: { atk: 40, element: "thunder" }, desc: "æŒæ§é›·é›»ä¹‹åŠ›ï¼Œæ”»æ“Šé™„å¸¶å¼·åŠ›é›»æ“Šã€‚" },
    { id: "art_glove_04", type: "gloves", name: "ğŸ©º ç¥é†«æ‰‹å¥—", stats: { hp: 100, def: 30 }, desc: "ç²¾é€šäººé«”çµæ§‹ï¼Œå¤§å¹…æå‡ç”Ÿå­˜èƒ½åŠ›ã€‚" },
    { id: "art_glove_05", type: "gloves", name: "ğŸ–ï¸ å¹»å½±ç¥å·", stats: { dropRate: 0.2, dodge: 0.1 }, desc: "èƒ½å¾ç•°æ¬¡å…ƒç«Šå–å¯¶ç‰©ï¼Œå¤§å¹…æå‡æ‰å¯¶ç‡ã€‚" },

    // --- ğŸ‘– è¤²ç”² (Legs) ---
    { id: "leg_01", type: "legs", name: "ğŸ‘– ç‰›ä»”è¤²", stats: { def: 5 }, desc: "è€ç£¨å¥½ç©¿ï¼Œå†’éšªè€…çš„åŸºæœ¬æ¬¾ã€‚" },
    { id: "leg_02", type: "legs", name: "ğŸ‘– åˆºå®¢è…¿ç”²", stats: { def: 10, dodge: 0.05 }, desc: "è¼•ä¾¿éˆæ´»ï¼Œå¾®å¹…æå‡é–ƒé¿ç‡ã€‚" },
    { id: "leg_03", type: "legs", name: "ğŸ©³ çŸ­è¤²", stats: { def: 1 }, desc: "éå¸¸æ¶¼å¿«ï¼Œé˜²ç¦¦åŠ›è¶¨è¿‘æ–¼é›¶ã€‚" },
    { id: "leg_04", type: "legs", name: "ğŸ›¡ï¸ é‡è£è­·è…¿", stats: { def: 35, moveSpeed: -0.1 }, desc: "é˜²ç¦¦æ¥µé«˜ï¼Œä½†ç§»å‹•ç¨é¡¯ç¬¨é‡ã€‚" },
    { id: "leg_05", type: "legs", name: "ğŸŒ¿ ç²¾éˆé•·è¤²", stats: { def: 15, timer: 1 }, desc: "é™„å¸¶è¼•ç›ˆé­”æ³•ï¼Œç­”é¡Œæ™‚é–“ +1 ç§’ã€‚" },
    { id: "leg_06", type: "legs", name: "ğŸ”¥ ç†”å²©è¤²", stats: { def: 20, atk: 5 }, desc: "æ•£ç™¼ç†±æ°£ï¼Œèƒ½ç‡™å‚·æ¥è¿‘çš„æ•µäººã€‚" },
    { id: "leg_07", type: "legs", name: "ğŸ¦µ æ ¼é¬¥å®¶è­·è…¿", stats: { atk: 10, hp: 20 }, desc: "å¼·åŒ–è…¿éƒ¨åŠ›é‡ï¼Œé©åˆè¸¢æ“Šã€‚" },
    { id: "leg_08", type: "legs", name: "ğŸ§™â€â™‚ï¸ ç§˜æ³•é•·è£™", stats: { def: 10, expMult: 1.05 }, desc: "ç¹¡æœ‰ç¬¦æ–‡ï¼Œç¶“é©—ç²å– +5%ã€‚" },
    { id: "leg_09", type: "legs", name: "ğŸ¦´ éª·é«è…¿ç”²", stats: { def: 25, fear: true }, desc: "å¤–å‹é§­äººï¼Œå¯èƒ½åš‡è·‘å¼±å°çš„æ•µäººã€‚" },
    { id: "leg_10", type: "legs", name: "ğŸŒŸ å®ˆè­·è€…è­·è†", stats: { def: 45 }, desc: "è–æ®¿é¨å£«çš„æ¨™æº–é…å‚™ï¼Œå …ä¸å¯æ‘§ã€‚" },
    // ----------------------------------------------------------------
    // ğŸ‘– ç¥å™¨ç´šè¤²ç”² (Artifact Legs)
    // ----------------------------------------------------------------
    { id: "art_leg_01", type: "legs", name: "ğŸ‘– èµ«çˆ¾å¢¨æ–¯è­·è…¿", stats: { timer: 5, dodge: 0.1 }, desc: "ä¿¡ä½¿ç¥çš„è£å‚™ï¼Œèº«è¼•å¦‚ç‡•ã€‚" },
    { id: "art_leg_02", type: "legs", name: "ğŸ‘– å¤§åœ°è¡Œè€…", stats: { def: 60, hp: 50 }, desc: "åªè¦é›™è…³è‘—åœ°ï¼Œå°±èƒ½æºæºä¸çµ•ç²å¾—å¤§åœ°ä¹‹åŠ›ã€‚" },
    { id: "art_leg_03", type: "legs", name: "ğŸ‘– æ™‚ç©ºè¡Œè€…é•·è¤²", stats: { timer: 3, expMult: 1.1 }, desc: "ç©¿æ¢­æ–¼æ™‚é–“ç¸«éš™ï¼Œæå‡æ•ˆç‡èˆ‡ç¶“é©—ã€‚" },
    { id: "art_leg_04", type: "legs", name: "ğŸ‰ é¾çš®è­·è…¿", stats: { def: 45, elementResist: "fire" }, desc: "å°ç«ç„°èˆ‡ç‰©ç†æ”»æ“Šéƒ½æœ‰æ¥µä½³çš„æŠ—æ€§ã€‚" },

    // --- ğŸ‘¢ é‹å­ (Boots) ---
    { id: "boot_01", type: "boots", name: "ğŸ‘¢ çš®é©é´", stats: { def: 5 }, desc: "é©åˆé•·é€”è·‹æ¶‰çš„è€ç”¨é´å­ã€‚" },
    { id: "boot_02", type: "boots", name: "ğŸ‘¢ ç–¾é¢¨ä¹‹é´", stats: { def: 8, timer: 2 }, desc: "æ­¥ä¼è¼•ç›ˆï¼Œç­”é¡Œæ™‚é–“ +2 ç§’ã€‚" },
    { id: "boot_03", type: "boots", name: "ğŸ‘¡ è‰é‹", stats: { def: 1 }, desc: "éš¨è™•å¯è¦‹çš„è‰ç·¨é‹ã€‚" },
    { id: "boot_04", type: "boots", name: "ğŸ›¡ï¸ éµæˆ°é´", stats: { def: 25 }, desc: "è¸¢äººå¾ˆç—›ï¼Œé˜²ç¦¦åŠ›ä¹Ÿä¸éŒ¯ã€‚" },
    { id: "boot_05", type: "boots", name: "ğŸ° å…”è€³æ‹–é‹", stats: { dodge: 0.05 }, desc: "é›–ç„¶çœ‹èµ·ä¾†å¾ˆè ¢ï¼Œä½†æ„å¤–åœ°éˆæ´»ã€‚" },
    { id: "boot_06", type: "boots", name: "ğŸŒŠ è¸æµªé•·é´", stats: { def: 15, elementResist: "fire" }, desc: "èƒ½è¡Œèµ°æ–¼æ·ºæ°´ï¼Œé™ä½ç«å±¬æ€§å‚·å®³ã€‚" },
    { id: "boot_07", type: "boots", name: "ğŸ§— ç™»å±±é‹", stats: { hp: 30 }, desc: "æŠ“åœ°åŠ›å¼·ï¼Œæå‡é«”åŠ›ä¸Šé™ã€‚" },
    { id: "boot_08", type: "boots", name: "ğŸŒ‘ éœéŸ³é´", stats: { dodge: 0.08, crit: 0.02 }, desc: "èµ°è·¯ç„¡è²ï¼Œé©åˆå·è¥²ã€‚" },
    { id: "boot_09", type: "boots", name: "ğŸ©° èˆè€…ä¹‹é‹", stats: { dodge: 0.12 }, desc: "è¯éº—çš„èˆæ­¥èƒ½é–ƒé¿æ•µäººçš„æ”»æ“Šã€‚" },
    { id: "boot_10", type: "boots", name: "ğŸš€ ç«ç®­é´", stats: { timer: 5, def: 10 }, desc: "ç§‘æŠ€ç”¢ç‰©ï¼Œç­”é¡Œæ™‚é–“å¤§å¹… +5 ç§’ã€‚" },
    // ----------------------------------------------------------------
    // ğŸ‘¢ ç¥å™¨ç´šé‹å­ (Artifact Boots)
    // ----------------------------------------------------------------
    { id: "art_boot_01", type: "boots", name: "ğŸ‘¢ ä¸ƒé‡Œé´", stats: { timer: 6, dodge: 0.05 }, desc: "ä¸€æ­¥èƒ½è·¨è¶Šä¸ƒé‡Œï¼Œæ¥µå¤§å¹…åº¦çˆ­å–æ™‚é–“ã€‚" },
    { id: "art_boot_02", type: "boots", name: "ğŸ‘¢ å¤©ç©ºä¹‹é´", stats: { dodge: 0.15, def: 20 }, desc: "èƒ½è¸ç©ºè€Œè¡Œï¼Œé¿é–‹åœ°é¢çš„å±éšªã€‚" },
    { id: "art_boot_03", type: "boots", name: "ğŸ‘¢ é‡åŠ›æˆ°é´", stats: { atk: 30, def: 30 }, desc: "åˆ©ç”¨é‡åŠ›åŠ é€Ÿåº¦ï¼Œå°‡è¸¢æ“Šå¨åŠ›æœ€å¤§åŒ–ã€‚" },
    { id: "art_boot_04", type: "boots", name: "ğŸŒŠ æ»„æµ·ä¹‹å±¥", stats: { hp: 80, elementResist: "fire" }, desc: "ä¾†è‡ªæ·±æµ·çš„ç¥ç¦ï¼Œå¤§å¹…æå‡é«”åŠ›ã€‚" },

    // --- ğŸ“¿ é …éŠ (Necklace) ---
    { id: "neck_01", type: "necklace", name: "ğŸ’ éˆé­‚ç¿»è­¯æ©Ÿ", stats: { expMult: 1.5 }, desc: "ç›´æ¥è§£æéˆé­‚ä¹‹èªï¼Œç¶“é©—å€¼ +50%ã€‚" },
    { id: "neck_02", type: "necklace", name: "ğŸ“¿ å®ˆè­·è­·ç¬¦", stats: { def: 10, hp: 50 }, desc: "å—éç¥ç¦çš„è­·ç¬¦ï¼Œæœ€å¤§ HP +50ã€‚" },
    { id: "neck_03", type: "necklace", name: "ğŸ¦´ ç¸ç‰™é …éŠ", stats: { atk: 15 }, desc: "å……æ»¿é‡æ€§åŠ›é‡ï¼Œæå‡æ”»æ“Šã€‚" },
    { id: "neck_04", type: "necklace", name: "ğŸ€ å››è‘‰è‰é …éŠ", stats: { dropRate: 0.1 }, desc: "å¹¸é‹çš„è±¡å¾µï¼Œæ‰å¯¶ç‡ +10%ã€‚" },
    { id: "neck_05", type: "necklace", name: "ğŸ©¸ å¸è¡€é¬¼å¢œé£¾", stats: { drain: 0.05 }, desc: "æ”»æ“Šæ™‚å¸å– 5% ç”Ÿå‘½å€¼ã€‚" },
    { id: "neck_06", type: "necklace", name: "ğŸ§¿ çœŸè¦–è­·ç¬¦", stats: { hintChance: 0.1 }, desc: "10% æ©Ÿç‡çœ‹ç©¿æ­£ç¢ºç­”æ¡ˆã€‚" },
    { id: "neck_07", type: "necklace", name: "ğŸ”¥ ç«ç„°ä¹‹å¿ƒ", stats: { element: "fire", atk: 10 }, desc: "è³¦äºˆå¾®å¼±çš„ç«å±¬æ€§æ”»æ“ŠåŠ æˆã€‚" },
    { id: "neck_08", type: "necklace", name: "â„ï¸ å†°æ™¶åŠå¢œ", stats: { element: "ice", def: 10 }, desc: "è³¦äºˆå¾®å¼±çš„å†°å±¬æ€§é˜²ç¦¦åŠ æˆã€‚" },
    { id: "neck_09", type: "necklace", name: "ğŸ‘‘ ç‹è€…é‡‘éŠ", stats: { coinMult: 1.2, atk: 20 }, desc: "ç´”é‡‘æ‰“é€ ï¼Œè±¡å¾µè²¡å¯Œèˆ‡æ¬ŠåŠ›ã€‚" },
    { id: "neck_10", type: "necklace", name: "ğŸ’€ è©›å’’é …éŠ", stats: { atk: 50, hp: -30 }, desc: "å¼·å¤§çš„åŠ›é‡ä¼´éš¨è‘—ç”Ÿå‘½æµå¤±çš„ä»£åƒ¹ã€‚" },
    // ----------------------------------------------------------------
    // ğŸ“¿ ç¥å™¨ç´šé …éŠ (Artifact Necklaces)
    // ----------------------------------------------------------------
    { id: "art_neck_01", type: "necklace", name: "ğŸ’ è³¢è€…ä¹‹çŸ³", stats: { hp: 200, expMult: 1.5 }, desc: "éŠé‡‘è¡“çš„çµ‚æ¥µç”¢ç‰©ï¼Œè³¦äºˆå¼·å¤§çš„ç”Ÿå‘½èˆ‡æˆé•·ã€‚" },
    { id: "art_neck_02", type: "necklace", name: "ğŸ“¿ å¥§ä¸ä¹‹çœ¼", stats: { hintChance: 0.4, vision: true }, desc: "çŠ§ç‰²ä¸€çœ¼æ›å–çš„æ™ºæ…§ï¼Œèƒ½çœ‹ç©¿ä¸–é–“è¬ç‰©ã€‚" },
    { id: "art_neck_03", type: "necklace", name: "ğŸ§¿ å„é‹è­·ç¬¦", stats: { atk: 100, hp: -50 }, desc: "è©›å’’æŒæœ‰è€…ï¼Œä½†çµ¦äºˆæ¯€æ»…æ€§çš„åŠ›é‡ã€‚" },
    { id: "art_neck_04", type: "necklace", name: "ğŸ€ å‘½é‹å¥³ç¥çš„é …éŠ", stats: { dropRate: 0.25, coinMult: 1.2 }, desc: "è¢«å¹¸é‹å¥³ç¥è¦ªå»éï¼Œå¯¶ç‰©èˆ‡è²¡å¯Œæ»¾æ»¾è€Œä¾†ã€‚" },
    { id: "art_neck_05", type: "necklace", name: "ğŸ”¥ å¤ªé™½ç¥è­·ç¬¦", stats: { atk: 50, element: "fire" }, desc: "å¦‚åŒå¤ªé™½èˆ¬è€€çœ¼ï¼Œç¼ç‡’ä¸€åˆ‡é‚ªæƒ¡ã€‚" },
    { id: "art_neck_06", type: "necklace", name: "ğŸŒ™ æœˆç¥å¢œé£¾", stats: { def: 50, dodge: 0.1 }, desc: "å¦‚åŒæœˆå…‰èˆ¬æŸ”å’Œï¼Œå®ˆè­·ä½©æˆ´è€…ã€‚" },

    // --- ğŸ’ æˆ’æŒ‡ (Ring) ---
    { id: "ring_01", type: "ring", name: "ğŸ’ å®ˆè²¡å¥´çš„é‡‘å¹£æˆ’", stats: { coinMult: 1.2 }, desc: "è²ªå©ªçš„åŠ›é‡ï¼Œé‡‘å¹£ç²å– +20%ã€‚" },
    { id: "ring_02", type: "ring", name: "ğŸ’ åœ‹ç‹çš„å°ç« æˆ’æŒ‡", stats: { rankPreserve: true }, desc: "èº«åˆ†çš„è­‰æ˜ï¼Œé™ç´šæ‡²ç½°æ¸›åŠã€‚" },
    { id: "ring_03", type: "ring", name: "ğŸ’ åŠ›é‡æˆ’æŒ‡", stats: { atk: 10 }, desc: "ç°¡å–®ç²—æš´åœ°æå‡ 10 é»æ”»æ“Šã€‚" },
    { id: "ring_04", type: "ring", name: "ğŸ’ éµå£æˆ’æŒ‡", stats: { def: 10 }, desc: "ç°¡å–®ç²—æš´åœ°æå‡ 10 é»é˜²ç¦¦ã€‚" },
    { id: "ring_05", type: "ring", name: "ğŸ’ ç”Ÿå‘½æˆ’æŒ‡", stats: { hp: 30 }, desc: "è˜Šå«ç”Ÿå‘½åŠ›ï¼Œæå‡æœ€å¤§ HPã€‚" },
    { id: "ring_06", type: "ring", name: "ğŸ’ ç–¾é¢¨æˆ’æŒ‡", stats: { timer: 2 }, desc: "æ€ç·’æ•æ·ï¼Œç­”é¡Œæ™‚é–“ +2 ç§’ã€‚" },
    { id: "ring_07", type: "ring", name: "ğŸ’ æš´æ“ŠæŒ‡ç’°", stats: { crit: 0.05 }, desc: "5% æ©Ÿç‡é€ æˆé›™å€å‚·å®³ã€‚" },
    { id: "ring_08", type: "ring", name: "ğŸ’ é–ƒé¿æŒ‡ç’°", stats: { dodge: 0.05 }, desc: "5% æ©Ÿç‡å®Œå…¨é–ƒé¿æ”»æ“Šã€‚" },
    { id: "ring_09", type: "ring", name: "ğŸ’ è³¢è€…ä¹‹æˆ’", stats: { expMult: 1.1 }, desc: "ç¶“é©—å€¼ç²å– +10%ã€‚" },
    { id: "ring_10", type: "ring", name: "ğŸ’ è³­å¾’æŒ‡ç’°", stats: { pokerLuck: 0.05 }, desc: "åœ¨è¡€è…¥ç‹åœ‹ä¸­ï¼Œé‹æ°£ç¨å¾®è®Šå¥½ã€‚" },
    { id: "ring_11", type: "ring", name: "ğŸ’ é›™å­æˆ’æŒ‡(é™½)", stats: { atk: 15 }, desc: "èˆ‡(é™°)åŒæ™‚è£å‚™æ™‚æœ‰éš±è—åŠ æˆã€‚" },
    { id: "ring_12", type: "ring", name: "ğŸ’ é›™å­æˆ’æŒ‡(é™°)", stats: { def: 15 }, desc: "èˆ‡(é™½)åŒæ™‚è£å‚™æ™‚æœ‰éš±è—åŠ æˆã€‚" },
    // ----------------------------------------------------------------
    // ğŸ’ ç¥å™¨ç´šæˆ’æŒ‡ (Artifact Rings)
    // ----------------------------------------------------------------
    { id: "art_ring_01", type: "ring", name: "ğŸ’ è‡³å°Šé­”æˆ’", stats: { atk: 60, def: 60, vision: true }, desc: "çµ±å¾¡çœ¾æˆ’çš„ä¸»å®°ï¼Œè³¦äºˆå…¨æ–¹ä½çš„å¼·å¤§åŠ›é‡ã€‚" },
    { id: "art_ring_02", type: "ring", name: "ğŸ’ æ‰€ç¾…é–€æŒ‡ç’°", stats: { hintChance: 0.3 }, desc: "èƒ½è™Ÿä»¤ 72 æŸ±é­”ç¥ï¼Œå¤§å¹…æå‡è§£é¡Œç›´è¦ºã€‚" },
    { id: "art_ring_03", type: "ring", name: "ğŸ’ å°¼ä¼¯é¾æ ¹ä¹‹æˆ’", stats: { coinMult: 2.0 }, desc: "å—è©›å’’çš„é»ƒé‡‘æŒ‡ç’°ï¼Œé‡‘å¹£ç²å–é‡ç¿»å€ã€‚" },
    { id: "art_ring_04", type: "ring", name: "ğŸ’ æ™‚é–“ä¹‹å¼§", stats: { timer: 5 }, desc: "å°‡æ™‚é–“æ‰­æ›²æˆåœ“ç’°ï¼Œå»¶é•·æ€è€ƒæ™‚é–“ã€‚" },
    { id: "art_ring_05", type: "ring", name: "ğŸ’ å¸è¡€é¬¼å¤§å…¬æˆ’æŒ‡", stats: { drain: 0.1, atk: 20 }, desc: "å¸è¡€é¬¼ç‹æ—çš„ä¿¡ç‰©ï¼Œæ¸´æœ›é®®è¡€ã€‚" },
    { id: "art_ring_06", type: "ring", name: "ğŸ’ é¾ç¥æˆ’æŒ‡", stats: { atk: 40, def: 40, hp: 100 }, desc: "è˜Šå«å¤é¾ä¹‹åŠ›çš„æŒ‡ç’°ï¼Œå±¬æ€§å…¨é¢æå‡ã€‚" },

    // --- ğŸ”® ç¬¦æ–‡ (Rune) ---
    { id: "rune_01", type: "rune", name: "ğŸ”® ç«ä¹‹ç¬¦æ–‡", stats: { atk: 5 }, desc: "é‘²åµŒå¾Œå¾®å¹…æå‡æ”»æ“Šã€‚" },
    { id: "rune_02", type: "rune", name: "ğŸ”® å†°ä¹‹ç¬¦æ–‡", stats: { def: 5 }, desc: "é‘²åµŒå¾Œå¾®å¹…æå‡é˜²ç¦¦ã€‚" },
    { id: "rune_03", type: "rune", name: "ğŸ”® é›·ä¹‹ç¬¦æ–‡", stats: { crit: 0.02 }, desc: "å¾®å¹…æå‡æš´æ“Šç‡ã€‚" },
    { id: "rune_04", type: "rune", name: "ğŸ”® é¢¨ä¹‹ç¬¦æ–‡", stats: { dodge: 0.02 }, desc: "å¾®å¹…æå‡é–ƒé¿ç‡ã€‚" },
    { id: "rune_05", type: "rune", name: "ğŸ”® åœŸä¹‹ç¬¦æ–‡", stats: { hp: 10 }, desc: "å¾®å¹…æå‡ç”Ÿå‘½å€¼ã€‚" },
    { id: "rune_06", type: "rune", name: "ğŸ”® å…‰ä¹‹ç¬¦æ–‡", stats: { expMult: 0.05 }, desc: "å¾®å¹…æå‡ç¶“é©—å€¼ã€‚" },
    { id: "rune_07", type: "rune", name: "ğŸ”® æš—ä¹‹ç¬¦æ–‡", stats: { drain: 0.01 }, desc: "å¾®å¹…æå‡å¸è¡€èƒ½åŠ›ã€‚" },
    { id: "rune_08", type: "rune", name: "ğŸ”® é‡‘ä¹‹ç¬¦æ–‡", stats: { coinMult: 0.05 }, desc: "å¾®å¹…æå‡é‡‘å¹£ç²å–ã€‚" },
    { id: "rune_09", type: "rune", name: "ğŸ”® é‹ä¹‹ç¬¦æ–‡", stats: { dropRate: 0.02 }, desc: "å¾®å¹…æå‡æ‰å¯¶ç‡ã€‚" },
    { id: "rune_10", type: "rune", name: "ğŸ”® æ™‚ä¹‹ç¬¦æ–‡", stats: { timer: 1 }, desc: "ç­”é¡Œæ™‚é–“ +1 ç§’ã€‚" },
    // ----------------------------------------------------------------
    // ğŸŒŸ ç¥å™¨ç´šç¬¦æ–‡ (Artifact Runes)
    // ----------------------------------------------------------------
    { id: "art_rune_01", type: "rune", name: "ğŸ”® å¥§ä¸çš„ç¥è«­", stats: { hintChance: 0.15, timer: 3 }, rarity: "legendary", desc: "ã€ç¥å™¨ã€‘å½·å½¿èƒ½è½è¦‹çœ¾ç¥çš„ä½èªï¼Œå¤§å¹…æå‡è§£é¡Œç›´è¦ºã€‚" },
    { id: "art_rune_02", type: "rune", name: "ğŸ”® ç‹‚æˆ°å£«ä¹‹æ€’", stats: { atk: 30, hp: -20, crit: 0.05 }, rarity: "legendary", desc: "ã€ç¥å™¨ã€‘çŠ§ç‰²é«”åŠ›æ›å–æ¥µè‡´çš„ç ´å£åŠ›ã€‚" },
    { id: "art_rune_03", type: "rune", name: "ğŸ”® çµ•å°é˜²å£", stats: { def: 35, block: 0.05 }, rarity: "legendary", desc: "ã€ç¥å™¨ã€‘å½¢æˆç„¡æ³•ç©¿é€çš„åŠ›å ´ï¼Œå¶çˆ¾å®Œå…¨æŠµæ“‹å‚·å®³ã€‚" },
    { id: "art_rune_04", type: "rune", name: "ğŸ”® è²ªå©ªä¹‹ç‹", stats: { coinMult: 0.3, dropRate: 0.1 }, rarity: "legendary", desc: "ã€ç¥å™¨ã€‘å°è²¡å¯¶çš„æ¸´æœ›å…·ç¾åŒ–ï¼Œå¤§å¹…æå‡æ å¥ªæ”¶ç›Šã€‚" },
    { id: "art_rune_05", type: "rune", name: "ğŸ”® è³¢è€…çš„æ™ºæ…§", stats: { expMult: 0.25, timer: 2 }, rarity: "legendary", desc: "ã€ç¥å™¨ã€‘çŸ¥è­˜å°±æ˜¯åŠ›é‡ï¼Œç¶“é©—å€¼ç²å–é‡é¡¯è‘—æå‡ã€‚" },
    { id: "art_rune_06", type: "rune", name: "ğŸ”® è™›ç©ºè¡Œè€…", stats: { dodge: 0.08, vision: true }, rarity: "legendary", desc: "ã€ç¥å™¨ã€‘èƒ½çœ‹ç©¿è¿·éœ§ï¼Œä¸¦åœ¨æ”»æ“Šåˆ°ä¾†å‰éå…¥è™›ç©ºã€‚" },
    { id: "art_rune_07", type: "rune", name: "ğŸ”® å…ƒç´ æ´ªæµ", stats: { atk: 15, element: "thunder" }, rarity: "legendary", desc: "ã€ç¥å™¨ã€‘è®“æ”»æ“Šé™„å¸¶å¼·çƒˆçš„é›·é›»å±¬æ€§ã€‚" },
    { id: "art_rune_08", type: "rune", name: "ğŸ”® å¸è¡€é¬¼çš„æ¸´æœ›", stats: { drain: 0.03, atk: 10 }, rarity: "legendary", desc: "ã€ç¥å™¨ã€‘æ”»æ“Šæ™‚è²ªå©ªåœ°åå™¬æ•µäººçš„ç”Ÿå‘½ã€‚" },
    { id: "art_rune_09", type: "rune", name: "ğŸ”® å¹¸é‹å¥³ç¥çš„å¾®ç¬‘", stats: { pokerLuck: 0.2 }, rarity: "legendary", desc: "ã€ç¥å™¨ã€‘åœ¨å‘½é‹çš„è³­å±€ä¸­ï¼Œä½ ç¸½æ˜¯è´å®¶ã€‚" },
    { id: "art_rune_10", type: "rune", name: "ğŸ”® ä¸æœ½ä¹‹è»€", stats: { hp: 150 }, rarity: "legendary", desc: "ã€ç¥å™¨ã€‘æ¥µå¤§å¹…åº¦æå‡ç”Ÿå‘½ä¸Šé™ï¼Œå¦‚å±±å¶½èˆ¬å …éŸŒã€‚" },

    // ----------------------------------------------------------------
    // ğŸ”¥ æ¯€æ»…å°ç¬¦ (Unique Charms)
    // ----------------------------------------------------------------
    { 
        id: "charm_anni", 
        type: "rune", 
        name: "ğŸ”¥ æ¯€æ»…å°ç¬¦", 
        stats: { atk: 50, def: 50, expMult: 0.5, coinMult: 0.5 }, 
        rarity: "mythic", 
        desc: "ã€ç¥è©±ã€‘ä¾†è‡ªåœ°ç„æ·±è™•çš„ç‡ƒç‡’è­·èº«ç¬¦ã€‚å…¨èƒ½åŠ›å¤§å¹…æå‡ï¼Œå¼·è€…çš„è­‰æ˜ã€‚" 
    },
    { 
        id: "charm_hellfire", 
        type: "rune", 
        name: "ğŸ”¥ åœ°ç„ç«ç‚¬", 
        stats: { atk: 80, element: "fire", vision: true }, 
        rarity: "mythic", 
        desc: "ã€ç¥è©±ã€‘ç‡ƒç‡’è‘—æ°¸ä¸ç†„æ»…çš„é»‘ç‚ï¼Œç…§äº®é»‘æš—ä¸¦ç„šç‡’ä¸€åˆ‡æ•µäººã€‚" 
    },
    { 
        id: "charm_gheed", 
        type: "rune", 
        name: "ğŸ€ åŸºå¾·çš„é‹æ°£", 
        stats: { coinMult: 1.0, dropRate: 0.5 }, 
        rarity: "mythic", 
        desc: "ã€ç¥è©±ã€‘å‚³å¥‡å•†äººçš„è­·èº«ç¬¦ã€‚é‡‘å¹£ç²å–ç¿»å€ï¼Œæ‰å¯¶ç‡å¤§å¹…ä¸Šå‡ã€‚" 
    },
    
    // --- ğŸ“¦ ç‰¹æ®Š/ç¥å™¨ (Artifact) ---
    { id: "artifact_01", type: "artifact", name: "ğŸ‘‘ è¡€è…¥ç‹æ¬Šç¢ç‰‡", desc: "æ²¾æŸ“äº†ç˜‹ç‹ä¹‹è¡€çš„é»ƒé‡‘ç¢ç‰‡ï¼Œè§¸ç¢°æ™‚èƒ½æ„Ÿå—åˆ°çµ±æ²»è€…æ®˜æš´çš„æ„å¿—ï¼Œæ˜¯ç”¨æ–¼é‡é‘„çœŸçš‡å† çš„é—œéµã€‚", rarity: "legendary" },
    { id: "artifact_02", type: "artifact", name: "ğŸ’ åœ‹ç‹çš„è²ªå©ªä¹‹å¿ƒ", desc: "é€™ä¸åƒ…æ˜¯å¯¶çŸ³ï¼Œå®ƒéš¨è‘—å°è²¡å¯Œçš„æ¸´æœ›è€ŒåŠ‡çƒˆè·³å‹•ï¼Œå½·å½¿æ´»è‘—ä¸€èˆ¬ï¼Œèƒ½è³¦äºˆæ­¦å™¨å¸å–ç”Ÿå‘½çš„èƒ½åŠ›ã€‚", rarity: "legendary" },
    { id: "artifact_03", type: "artifact", name: "ğŸ—¡ï¸ çµ±æ²»è€…ä¹‹é‹’", desc: "å¼’å›è€…çš„å‡¶å™¨ï¼Œåˆ€é‹’ä¸Šæ°¸é æµæ·Œè‘—æ´—ä¸æ·¨çš„è©›å’’ä¹‹è¡€ï¼Œæ˜¯åˆæˆæ¯€æ»…æ€§æ­¦å™¨çš„æ ¸å¿ƒã€‚", rarity: "mythic" },
    { id: "artifact_04", type: "artifact", name: "ğŸ“œ ç¦å¿Œç¨…å¾‹å–®", desc: "è¨˜è¼‰è‘—å‰å‰Šè¬æ°‘çš„æ®˜é…·å¾‹æ³•ï¼Œç´™å¼µæœ¬èº«å°±æ•£ç™¼è‘—ä»¤äººçª’æ¯çš„å£“è¿«æ„Ÿï¼Œæ“šèªªèƒ½æ‰­æ›²è¦å‰‡ã€‚", rarity: "legendary" },
];

// --- ğŸƒ ç‰©ç†æ›´æ–°ï¼šåŠ ä¸Šç¨€æœ‰åº¦æ¨™ç±¤ ---
const RANK_BOON_DATA = {
    king: [
        { id: 'tyranny', name: 'ğŸ‘‘ æš´æ”¿ç¨…æ”¶', desc: 'æ‰‹å‹•å¾å¥´éš¸æ‰‹è£¡å¼·è¡Œå¥ªå–æœ€å¼·ç‰Œ', rarity: 'rare' },
        { id: 'absolute', name: 'âš–ï¸ çµ•å°çµ±æ²»', desc: 'ä½ çš„ 2 ç‰©ç†æ€§ç„¡è¦–ç‚¸å½ˆå£“åˆ¶', rarity: 'legend' },
        { id: 'treasury', name: 'ğŸ’° åœ‹åº«å……ç›ˆ', desc: 'æœ¬å±€ç²å‹çé‡‘ç‰©ç†ç¿»å€ (2.0x)', rarity: 'rare' },
        { id: 'guard', name: 'ğŸ›¡ï¸ çš‡å®¶ç¦è¡›', desc: 'æœ¬å±€è‹¥è¼¸ï¼Œéšç´šæ”¹ç‚ºå¹³æ°‘', rarity: 'normal' },
        { id: 'joker_king', name: 'ğŸƒ ç‹ä¹‹é¬¼ç‰Œ', desc: 'æœ¬å±€ç²å¾—ä¸€å¼µè¬ç”¨é¬¼ç‰Œ', rarity: 'legend' },
        { id: 'decree', name: 'ğŸ“œ å¾¡æ—¨ä¸‹é”', desc: 'æœ¬å±€æ‰€æœ‰ AI æ£„æ¬Šç‡æå‡', rarity: 'normal' }
    ],
    noble: [
        { id: 'tactics', name: 'âš”ï¸ æˆ°è¡“é…åˆ', desc: 'çµ„æˆé †å­æ™‚ï¼Œå¨åŠ›ç­‰åŒæ–¼ç‚¸å½ˆ', rarity: 'legend' },
        { id: 'scout', name: 'ğŸ‘“ æƒ…å ±åµå¯Ÿ', desc: 'çœ‹ç©¿æ‰€æœ‰ AI æ‰‹ä¸­å‰©é¤˜æœ€å¤§ç‰Œ', rarity: 'rare' },
        { id: 'elegant', name: 'ğŸ­ å„ªé›…æ´—ç‰Œ', desc: 'ç™¼ç‰Œå¾Œå¯é‡æŠ½èµ·æ‰‹ç‰Œ', rarity: 'rare' },
        { id: 'invest', name: 'ğŸ“ˆ æˆ°ç•¥æŠ•è³‡', desc: 'è¼¸çƒä¹Ÿèƒ½å›æ”¶é–€ç¥¨è²»', rarity: 'normal' },
        { id: 'peerage', name: 'ğŸ° è²´æ—ä¸–è¥²', desc: 'æ’ç¬¬äºŒåæ™‚ä¸‹å±€ä¿ç•™éšç´š', rarity: 'normal' },
        { id: 'tax_cut', name: 'ğŸ“‰ æ¸›ç¨…æ”¿ç­–', desc: 'æœ¬å±€çµæŸå¾Œä¸æ‰£é™¤ä»»ä½•é‡‘å¹£', rarity: 'normal' }
    ],
    citizen: [
        { id: 'flexible', name: 'ğŸ­ é€šæ‰æ€ç¶­', desc: 'åŒèŠ±é †åˆ¤å®šç‰©ç†ç„¡è¦–èŠ±è‰²', rarity: 'legend' },
        { id: 'resist', name: 'ğŸ›¡ï¸ å¹³æ°‘èµ·ç¾©', desc: 'å°å­å¯ä»¥ç‰©ç†å£“åˆ¶è‘«è˜†', rarity: 'rare' },
        { id: 'market', name: 'ğŸ”„ é»‘å¸‚äº¤æ˜“', desc: 'éš¨æ©Ÿæ›¿æ›æ‰‹ç‰Œä¸­ 3 å¼µå»¢ç‰Œ', rarity: 'rare' },
        { id: 'work', name: 'ğŸ”¨ å‹¤å¥®å‹å‹•', desc: 'å‡ºå®Œç‰Œæ™‚é¡å¤–ç²å¾— 100G', rarity: 'normal' },
        { id: 'luck', name: 'ğŸ€ å¹¸é‹è‰', desc: '30% æ©Ÿç‡é¡å¤–ç²å¾—ä¸€å¼µ 2', rarity: 'normal' },
        { id: 'debt_trap', name: 'â›“ï¸ é«˜åˆ©è²¸', desc: 'ç«‹å³ç²å¾— 300Gï¼Œä½†ä¸‹å±€è‹¥æ²’è´å‰‡é™ç´š', rarity: 'curse' }
    ],
    slave: [
        { id: 'destiny', name: 'âœ¨ å‘½é‹ç¿»è½‰', desc: 'å¥ªå† çé‡‘ 5 å€ä¸”ç›´å‡åœ‹ç‹', rarity: 'legend' },
        { id: 'revenge', name: 'â›“ï¸ çµ•å‘½å¾©ä»‡', desc: 'æ‰“å‡ºç‚¸å½ˆæ™‚ç«‹å³è™•æ±ºåœ‹ç‹', rarity: 'rare' },
        { id: 'rage', name: 'ğŸ”´ åº•å±¤å’†å“®', desc: '3 ç‰©ç†åˆ¤å®šç‚ºæœ€å¼·ç‰Œ', rarity: 'rare' },
        { id: 'hidden', name: 'ğŸƒ æ‡·ä¸­åˆ©åˆƒ', desc: 'ç›´æ¥ç²å¾—å…©å¼µé¬¼ç‰Œ', rarity: 'legend' },
        { id: 'chaos', name: 'ğŸŒ€ æ··äº‚åºå¹•', desc: 'æœ¬å±€ç„¡è¦–éšç´šç¾©å‹™ä¸”ç”±ä½ å…ˆæ‰‹', rarity: 'normal' },
        { id: 'despair', name: 'ğŸ’€ çµ•æœ›å¥‘ç´„', desc: 'æœ¬å±€ä¸èƒ½å‡º 2ï¼Œä½†é‡‘å¹£ç²å– +200%', rarity: 'curse' }
    ]
};

// --- ç‰©ç†å±¬æ€§ç›¸å‰‹è¡¨ ---
const ELEMENT_REACTIONS = {
    "fire": { weak: "ice", resist: "earth", icon: "ğŸ”¥" },
    "ice": { weak: "fire", resist: "thunder", icon: "â„ï¸" },
    "thunder": { weak: "ice", resist: "earth", icon: "âš¡" },
    "earth": { weak: "thunder", resist: "fire", icon: "â›°ï¸" }
};

let player = {
    lv: 1, exp: 0, coin: 0, title: "ğŸŒ± åˆç´šå†’éšªè€…",
    inventory: [], collection: [], logs: [], medals: [],
    streak: 0, lastQuestDate: "",
totalShopSpent: 0,    // ç‰©ç†è¨˜éŒ„åœ¨è²©è³£éƒ¨çš„ç¸½æ¶ˆè²»
    hasVipCard: false,    // é»‘å¸‚è²´è³“å¡æ¨™è¨˜
    maxKingStreak: 0,     // æ­·å²æœ€é«˜é€£èŠç´€éŒ„
    mapProgress: { N5: 0, N4: 0, N3: 0, N2: 0, N1: 0 }
};

// ç•¶å‰æ­£åœ¨æ“ä½œçš„æ§½ä½ ID (æš«å­˜ç”¨)
let currentEquipSlotId = null;
let currentEquipType = null;

// åˆå§‹å‹‡è€…æ•¸æ“šæ“´å……
const heroStats = {
    level: 1,
    maxHp: 50,
    currentHp: 50,
    exp: 0,
    phantomDust: 0, // å¹»å½±ä¹‹å¡µ
    gold: 100
};

let battleData = {
    heroHP: 100,
    monsterHP: 100,
    currentQuiz: null,
    isBattleActive: false
};

let battleChain = {
    count: 0,
    lastVictoryTime: 0,
    chainWindow: 30000 // 30ç§’å…§å¿…é ˆé‡åˆ°ä¸‹ä¸€éš»æ€ª
};


// å…¨å±€ç‹€æ…‹
let currentAlchemyTab = 'synthesis';
let refineTargetIdx = null; // è£å‚™åœ¨èƒŒåŒ…çš„ç´¢å¼•
let refineStoneIdx = null;  // çŸ³é ­åœ¨èƒŒåŒ…çš„ç´¢å¼•

// --- ğŸ“š åœ–é‘‘åˆ†é æ§åˆ¶è®Šæ•¸ ---
let currentCollectionPage = 1;
const COLLECTION_ITEMS_PER_PAGE = 10; // æ¯é é¡¯ç¤º 10 ç­†

// --- ğŸ’ èƒŒåŒ…ç³»çµ±ç‹€æ…‹ç®¡ç† ---
let currentInvTab = 'equipment'; // ç•¶å‰æ¨™ç±¤: equipment, artifact, material, potion
const INV_PER_PAGE = 10;         // æ¯é  10 ç­†

// å„åˆ†é¡ç¨ç«‹é ç¢¼è¨˜æ†¶
let invPageState = {
    equipment: 1,
    artifact: 1,
    material: 1,
    potion: 1
};

// ğŸ¨ æ³¨å…¥èƒŒåŒ…å°ˆç”¨æ¨£å¼ (é˜²æ­¢ CSS æª”æ¡ˆéå¤§ï¼Œç›´æ¥å‹•æ…‹æ³¨å…¥)
if (!document.getElementById('inv-tab-style')) {
    const style = document.createElement('style');
    style.id = 'inv-tab-style';
    style.innerHTML = `
        .inv-tabs { display: flex; gap: 5px; margin-bottom: 10px; border-bottom: 2px solid #444; padding-bottom: 5px; overflow-x: auto; }
        .inv-tab-btn { flex: 1; background: rgba(255,255,255,0.05); color: #888; border: 1px solid #444; border-bottom: none; padding: 8px 5px; cursor: pointer; font-size: 12px; font-weight: bold; border-radius: 6px 6px 0 0; transition: 0.2s; white-space: nowrap; }
        .inv-tab-btn.active { background: rgba(241, 196, 15, 0.1); color: #f1c40f; border-color: #f1c40f; border-bottom: 2px solid #f1c40f; margin-bottom: -2px; }
        .inv-pagination { display: flex; justify-content: center; align-items: center; gap: 15px; margin-top: 15px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.1); }
        .inv-empty-msg { grid-column: 1 / -1; text-align: center; color: #666; padding: 40px; font-size: 12px; border: 1px dashed #444; border-radius: 8px; }
    `;
    document.head.appendChild(style);
}


// --- ğŸ–ï¸ å‹³ç« è³‡æ–™åº«å®šç¾© ---
const MEDAL_MASTER = [
    { id: 'bounty_10', name: 'ğŸ¯ è³é‡‘çµäºº', desc: 'å®Œæˆ 10 æ¬¡è³é‡‘ä»»å‹™', bonus: 0.1 },
    { id: 'streak_7', name: 'ğŸ”¥ å‹¤å¥®å‹‡è€…', desc: 'é€£çºŒå®Œæˆä»»å‹™ 7 å¤©', bonus: 0.15 },
    { id: 'lv_50', name: 'ğŸ‘‘ å‚³å¥‡è‹±é›„', desc: 'ç­‰ç´šé”åˆ° 50', bonus: 0.25 },
    { id: 'collection_full', name: 'ğŸ’ æ”¶è—åå®¶', desc: 'è§£é–å…¨åœ–é‘‘è£å‚™', bonus: 0.3 }
];

const RANK_VOICE = {
    king: {
        play: [
            "æœ•çš„å¨åš´ï¼Œçˆ¾ç­‰è·ªä¸‹é ˜æ•™ï¼", "æ­¤ç‰Œä¸€å‡ºï¼Œç‹åœ‹ç–†åœŸç›¡æ­¸æœ•æ‰‹ã€‚", "é€™å°±æ˜¯çµ•å°å¯¦åŠ›çš„çµ±æ²»ï¼", 
            "å¦„æƒ³æŒ‘æˆ°ç‹æ¬Šï¼Ÿæ„šä¸å¯åŠï¼", "åœ¨æœ•çš„çœ¼è£¡ï¼Œä½ å€‘ä¸éæ˜¯è»èŸ»ã€‚", "æ­¤ä¹ƒå¤©å‘½ä¹‹é¸ï¼Œèª°æ•¢ä¸å¾ï¼Ÿ",
            "ç‹ä¹‹è²¡å¯¶ï¼Œè±ˆæ˜¯çˆ¾ç­‰èƒ½ç›´è¦–çš„ï¼Ÿ", "é€™å±€çµ‚ç©¶æ˜¯æœ•çš„çµå ´ã€‚", "æ„Ÿå—é€™è‚¡æ²‰é‡çš„çš‡æ¬Šå£“åŠ›å§ï¼", 
            "æœ•èªªçµæŸï¼Œæ‰æ˜¯çµæŸã€‚", "ä½ å€‘æ‰‹è£¡çš„å»¢ç´™ï¼Œé€£ç•¶æœ•çš„ç¥­å“éƒ½ä¸é…ï¼", "åœ¨ç‹åº§é¢å‰ï¼Œå‘¼å¸éƒ½æ˜¯ä¸€ç¨®å¥¢ä¾ˆã€‚",
            "çœ‹å¥½äº†ï¼Œé€™æ‰æ˜¯ç‰©ç†æ„ç¾©ä¸Šçš„é™ç¶­æ‰“æ“Šï¼", "æœ•çš„é‹æ°£ï¼Œä¹Ÿæ˜¯å¯¦åŠ›çš„ä¸€ç’°ã€‚"
        ],
        pass: [
            "å“¼ï¼Œé€™ç¨®å°æ‰“å°é¬§ï¼Œæœ•ä¸å±‘åƒèˆ‡ã€‚", "æš«ä¸”è®“ä½ å€‘é€™äº›åº¶æ°‘å–˜æ¯ç‰‡åˆ»ã€‚", "æœ•åœ¨ç­‰ä¸€å€‹å¾¹åº•æ‘§æ¯€ä½ å€‘çš„æ©Ÿæœƒã€‚", 
            "å¹³åº¸çš„ç‰Œå‹ï¼Œä¸é…è®“æœ•å‡ºæ‰‹ã€‚", "è®“ä½ å€‘å…ˆç‹‚æ­¡å§ï¼Œæœ«æ—¥å°‡è¿‘ã€‚", "æœ•çš„è€å¿ƒæ˜¯æœ‰é™åº¦çš„ã€‚",
            "å„ªé›…çš„æ—è§€ä¹Ÿæ˜¯ç‹è€…ä¹‹é“ã€‚", "æ¬ŠåŠ›éœ€è¦æ²‰æ¾±ï¼Œæœ•æš«ä¸”ä¸ç™¼ã€‚", "é ˜æ•™æœ•çš„æ…ˆæ‚²å§ã€‚", 
            "é€™é»ç¨‹åº¦ï¼Œä¸éœ€è¦æœ•å‹ç¥ã€‚", "æœ•ç´¯äº†ï¼Œå‰©ä¸‹çš„é¤˜æ…¶ç•™çµ¦ä½ å€‘è‡ªæ®˜ã€‚", "é€™ç¨®åƒåœ¾ç‰Œçµ„ï¼Œæœ•å¤šçœ‹ä¸€çœ¼éƒ½è¦ºå¾—é«’ã€‚"
        ]
    },
    noble: {
        play: [
            "å„ªé›…ï¼Œé€™å°±æ˜¯è²´æ—çš„æ ¼èª¿ã€‚", "åº¶æ°‘å€‘ï¼Œçœ‹å¥½äº†é€™è¯éº—çš„é€²æ”»ï¼", "æˆ‘çš„åœ°ä½ï¼Œä¸å®¹ç½®ç–‘ã€‚", 
            "é€™å¼µç‰Œçš„åƒ¹å€¼ï¼Œé ‚å¾—éä½ ä¸€å¹´çš„å£ç³§ã€‚", "é›–ç„¶ç¨éœæ–¼é™›ä¸‹ï¼Œä½†ç¢¾å£“ä½ ç¶½ç¶½æœ‰é¤˜ã€‚", "å„ªè³ªçš„ç‰Œçµ„ï¼Œé…ä¸Šå„ªè³ªçš„æˆ‘ã€‚",
            "åˆ¥ç”¨ä½ çš„é«’æ‰‹ç¢°æˆ‘çš„å‹åˆ©ã€‚", "é€™å ´åšå¼ˆï¼Œæœ¬å°±æ˜¯æ¬Šè²´çš„éŠæˆ²ã€‚", "é ˜æ•™ä¸€ä¸‹ä¸Šæµç¤¾æœƒçš„åˆ¶è£ã€‚", 
            "è²´æ—çš„æ„å¿—ï¼Œå¿…å°‡è²«å¾¹åˆ°åº•ã€‚", "å¦‚æœä½ è·ªåœ°æ±‚é¥’ï¼Œæˆ‘ä¹Ÿè¨±æœƒè€ƒæ…®æº«æŸ”ä¸€é»ã€‚", "å“å‘€ï¼Œä¸å°å¿ƒæ‰“å‡ºäº†ä¸€å¼µä½ é€™è¼©å­éƒ½è¦‹ä¸åˆ°çš„å¥½ç‰Œã€‚",
            "ä½ å€‘é€™äº›åº•å±¤é›œè‰ï¼Œå°±ä¹–ä¹–è¢«æˆ‘æ”¶å‰²å§ã€‚", "æˆ‘çš„ç‰Œè·Ÿæˆ‘çš„é¦™æ°´ä¸€æ¨£ï¼Œé«˜è²´è€Œè‡´å‘½ã€‚"
        ],
        pass: [
            "å˜–ï¼Œé€™æ‰‹ç‰Œæœ‰é»é«’äº†æˆ‘çš„çœ¼ã€‚", "æš«ä¸”è§€æœ›ï¼Œé€™ä¸ç¬¦åˆæˆ‘çš„ç¾å­¸ã€‚", "å…ˆè®“é‚£äº›ç²—é„™ä¹‹äººäº’ç›¸æ®˜æ®ºå§ã€‚", 
            "æˆ‘éœ€è¦ç¨å¾®æ•´ç†ä¸€ä¸‹æˆ‘çš„æƒ…ç·’ã€‚", "é€™å±€çš„æ°›åœï¼Œæˆ‘ä¸å–œæ­¡ã€‚", "è®“è·¯ï¼Œä¹Ÿæ˜¯ä¸€ç¨®ç¦®å„€ã€‚",
            "é€™ä¸å€¼å¾—æˆ‘å‹•å‹•æ‰‹æŒ‡ã€‚", "æˆ‘åœ¨ç­‰å¾…æœ€ä½³çš„ç¤¾äº¤è·é›¢ã€‚", "å“¼ï¼Œæš«ä¸”æ”¾éä½ ã€‚", 
            "ä¿å­˜é«”åŠ›ä¹Ÿæ˜¯æˆ°è¡“çš„ä¸€ç’°ã€‚", "é€™ç¨®æˆ°å±€å¤ªéé‡è »ï¼Œæˆ‘å…ˆå»å–æ¯ç´…é…’ã€‚", "ä½ å€‘ç¹¼çºŒï¼Œæˆ‘åªæ˜¯ä¸å±‘èˆ‡å¹³åº¸ç‚ºä¼ã€‚"
        ]
    },
    citizen: {
        play: [
            "æˆ‘åªæƒ³å®‰ç©©åœ°è´ä¸‹é€™å±€ã€‚", "åŠªåŠ›å·¥ä½œï¼ŒåŠªåŠ›å‡ºç‰Œï¼", "é€™æ˜¯æˆ‘ç´¯ç©å·²ä¹…çš„å¯¦åŠ›ã€‚", 
            "ç‚ºäº†ç”Ÿæ´»ï¼Œæˆ‘ä¸èƒ½è¼¸ï¼", "é€™å¼µç‰Œæ‡‰è©²èƒ½æ’ä¸€é™£å­å§ï¼Ÿ", "è…³è¸å¯¦åœ°ï¼Œç¸½æœƒæœ‰ç¿»èº«çš„ä¸€å¤©ã€‚",
            "çœ‹æˆ‘çš„å…¨åŠ›ä»¥èµ´ï¼", "é€™æ˜¯æˆ‘æœ€å¥½çš„å›æ“Šäº†ã€‚", "å¤§å®¶éƒ½æŒºä¸å®¹æ˜“çš„ï¼Œå°å§ï¼Ÿ", 
            "è‡³å°‘é€™å±€æˆ‘ä¸æƒ³æ”¾æ£„ã€‚", "è€é—†ä¸çµ¦åŠ ç­è²»ï¼Œæˆ‘åªèƒ½åœ¨ç‰Œæ¡Œä¸Šè´å›ä¾†ï¼", "é€™å°±æ˜¯æˆ‘å€‘å‹å‹•éšç´šçš„éµæ‹³ï¼",
            "åˆ¥å°çœ‹å¹³æ°‘ï¼Œæˆ‘å€‘çš„äººæ•¸å„ªå‹¢æ˜¯ç‰©ç†ç´šçš„ï¼", "æˆ¿è²¸é‚„æ²’é‚„å®Œï¼Œé€™å ´æˆ‘ä¸€å®šè¦æ‹¿çé‡‘ï¼"
        ],
        pass: [
            "å”‰ï¼Œæ—¥å­çœŸé›£éï¼Œé€™æŠŠè·Ÿä¸èµ·ã€‚", "æˆ‘é‚„æ˜¯ä¹–ä¹–å¾…è‘—æ¯”è¼ƒå®‰å…¨ã€‚", "è®“å¤§ä½¬å€‘å…ˆæ‰“ï¼Œæˆ‘è·¯éã€‚", 
            "ç”Ÿæ´»å£“åŠ›å¤§ï¼Œæ‰‹æ°£ä¹Ÿä¸å¥½ã€‚", "é€™æ¬¡å°±ç®—äº†ï¼Œä¸‹æ¬¡å†åŠªåŠ›ã€‚", "å®‰å…¨ç¬¬ä¸€ï¼Œæˆ‘ Passã€‚",
            "æ²’é—œä¿‚ï¼Œä¼‘æ¯æ˜¯ç‚ºäº†èµ°æ›´é•·çš„è·¯ã€‚", "é€™æ°´å¤ªæ·±ï¼Œæˆ‘è¸©ä¸åˆ°åº•ã€‚", "å¹³æ°‘æœ‰å¹³æ°‘çš„ç”Ÿå­˜ä¹‹é“ã€‚", 
            "æˆ‘å°±éœéœçœ‹è‘—ä¸èªªè©±ã€‚", "ç‰©åƒ¹åˆæ¼²äº†ï¼Œæˆ‘å¾—çœé»ç‰ŒåŠ›...", "æˆ‘ä¸å‡ºç‰Œï¼Œç´”ç²¹æ˜¯ç‚ºäº†ç’°ä¿ã€‚", "ä½ å€‘æ‰“ï¼Œæˆ‘è² è²¬åœ¨æ—é‚Šé ˜å¤±æ¥­è£œåŠ©ã€‚"
        ]
    },
    slave: {
        play: [
            "åæ­£å‘½ä¸€æ¢ï¼Œè¦æ®ºè¦å‰®éš¨ä¾¿ä½ ï¼", "å¥´éš¸çš„æ†¤æ€’ï¼Œä½ æ¥å¾—ä½å—ï¼Ÿ", "é€™æ˜¯æˆ‘ç”¨å°Šåš´æ›ä¾†çš„ç‰Œï¼", 
            "æˆ‘å·²ç¶“ä¸€ç„¡æ‰€æœ‰ï¼Œæ²’ä»€éº¼å¥½æ€•çš„ï¼", "åœ°ç„è£¡çš„æ™æ‰ï¼Œçœ‹æ¸…æ¥šäº†ï¼", "é©å‘½çš„ç«ç¨®ï¼Œå°±å¾é€™å¼µç‰Œé–‹å§‹ï¼",
            "åªè¦æˆ‘ä¸å€’ä¸‹ï¼Œå™©å¤¢å°±ä¸æœƒçµæŸã€‚", "å“ªæ€•æ˜¯æ­»ï¼Œæˆ‘ä¹Ÿè¦å’¬æ‰ä½ ä¸€å¡Šè‚‰ï¼", "é€™å±€æˆ‘è¦ç¿»è½‰å‘½é‹ï¼", 
            "çœ‹å¥½äº†ï¼Œé€™æ˜¯åº•å±¤çš„å’†å“®ï¼", "éµéˆé–å¾—ä½æˆ‘çš„èº«é«”ï¼Œé–ä¸ä½æˆ‘é€™æ‰‹å¥½ç‰Œï¼", "åœ¨æ³¥æ½­è£¡å¾…ä¹…äº†ï¼Œæˆ‘é€£éˆé­‚éƒ½å¸¶æ¯’ï¼",
            "ç­‰æˆ‘æˆäº†åœ‹ç‹ï¼Œç¬¬ä¸€å€‹å°±æŠŠä½ å€‘éƒ½é€å»æŒ–ç¤¦ï¼", "é€™å¼µç‰Œï¼Œæ˜¯æˆ‘åœ¨åœ°ç„è£¡ç£¨å‡ºçš„åˆ©åˆƒï¼"
        ],
        pass: [
            "åæ­£éƒ½æ˜¯è¼¸ï¼Œéš¨ä¾¿ä½ å€‘ç©å§...", "æˆ‘çš„å‘¼å¸ï¼Œå°ä½ å€‘ä¾†èªªéƒ½æ˜¯ç½ªå—ï¼Ÿ", "æ·é–å¤ªé‡ï¼Œæˆ‘å‹•å½ˆä¸å¾—ã€‚", 
            "å°±è®“æˆ‘çˆ›åœ¨åƒåœ¾å †è£¡å§...", "é€™ä¸–ç•Œæœ¬å°±ä¸å…¬å¹³ï¼ŒPassã€‚", "æˆ‘é€£å‡ºç‰Œçš„æ¬Šåˆ©éƒ½è¢«å‰å¥ªäº†å—ï¼Ÿ",
            "æ²’åŠ›æ°£äº†ï¼Œä½ å€‘æ‰“å§ã€‚", "åœ¨å¼·æ¬Šé¢å‰ï¼Œæˆ‘åªèƒ½ä½é ­ã€‚", "æ‚‰è½å°Šä¾¿ï¼Œæˆ‘æ£„æ¬Šã€‚", 
            "åœ°ç„å¾ˆå†·ï¼Œæˆ‘å·²ç¶“ç¿’æ…£äº†ã€‚", "æ—¢ç„¶æ²’æœ‰å¸Œæœ›ï¼Œé‚£æˆ‘å°±åœ¨é‚£é‚Šçœ‹è‘—ä½ å€‘æ¯€æ»…ã€‚", "æˆ‘çš„æ²ˆé»˜ï¼Œæ˜¯ä¸‹ä¸€æ¬¡é©å‘½çš„åºæ›²...", "æ²’é—œä¿‚ï¼Œæˆ‘åœ¨å¢³å¢“è£¡çµ¦ä½ å€‘ç•™äº†ä½ç½®ã€‚"
        ]
    }
};


/**
 * ğŸ‘‘ ç‹æ¬Šå‡æ ¼è¡¨ï¼šæ ¹æ“šé€£å‹æ¬¡æ•¸æ±ºå®šç‰©ç†ä½éš
 */
const KING_TITLES = [
    { streak: 100, name: "ğŸŒŒ ç™¾ä»£æ°¸æ†Â·çœŸç¥çš‡", color: "#ffffff", glow: "0 0 20px #fff, 0 0 40px #f1c40f" },
    { streak: 80,  name: "âš–ï¸ ç§©åºç¶­ç¹«è€…Â·è–çš‡", color: "#f1c40f", glow: "0 0 15px gold" },
    { streak: 50,  name: "âš”ï¸ éµè¡€å¾æœè€…Â·å¤§å¸", color: "#e74c3c", glow: "0 0 12px red" },
    { streak: 30,  name: "ğŸ’ ç’€ç’¨ç‹æ¬ŠÂ·ç››ä¸–ä¸»", color: "#3498db", glow: "0 0 10px #3498db" },
    { streak: 20,  name: "ğŸ“œ å¾‹æ³•ç·¨çº‚è€…Â·è³¢ç‹", color: "#2ecc71", glow: "0 0 8px #2ecc71" },
    { streak: 12,  name: "ğŸ° æ°¸æ†æ–°çš‡", color: "#9b59b6", glow: "0 0 5px #9b59b6" },
    { streak: 5,   name: "ğŸ· å¥¢é¡çš„çµ±æ²»è€…", color: "#ff4d4d", glow: "none" },
    { streak: 2,   name: "ğŸ£ ç¨šå«©çš„åƒ­è¶Šè€…", color: "#aaa", glow: "none" },
    { streak: 0,   name: "ğŸš¶ å‡¡äººé ˜ä¸»", color: "#fff", glow: "none" }
];

/**
 * ğŸ‘‘ ç‹å† è¦–è¦ºé€²åŒ–è¡¨ (ç‰©ç†ä»¿å¤©å ‚åŸä¸»ç³»çµ±)
 */
const CROWN_EVOLUTION = [
    { streak: 100, icon: "ğŸŒŒ", effect: "crown-god-light", desc: "ç™¾ä»£ç¥çš‡ä¹‹å·”" },
    { streak: 80,  icon: "ğŸ”±", effect: "crown-holy-flare", desc: "è–çš‡ä¹‹å¨" },
    { streak: 50,  icon: "ğŸ‘‘", effect: "crown-red-aura", desc: "éµè¡€å¸å† " },
    { streak: 30,  icon: "ğŸ‘‘", effect: "crown-golden-shine", desc: "ç››ä¸–é‡‘å† " },
    { streak: 20,  icon: "ğŸ’", effect: "crown-blue-spark", desc: "è³¢ç‹ä¹‹ç’½" },
    { streak: 12,  icon: "ğŸ¤´", effect: "crown-purple-mist", desc: "æ–°çš‡ä¹‹å…‰" },
    { streak: 5,   icon: "ğŸ’", effect: "crown-simple", desc: "çµ±æ²»è€…ä¹‹ç’°" },
    { streak: 2,   icon: "âœ¨", effect: "crown-spark", desc: "åƒ­è¶Šè€…ä¹‹èŠ’" }
];

/**
 * ğŸ›ï¸ ç‹åœ‹è‚¡å¸‚ 50 æ”¯æˆåˆ†è‚¡æ¸…å–® (åœ°è¡¨æš—é»‘è§¸ç™¼ç‰ˆ)
 * ä¿®æ­£ï¼šæ–°å¢ SOJ å–¬ä¸¹å¯¦æ¥­ï¼Œä½œç‚ºç‹‚æš´åœ‹ç‹é™è‡¨çš„å¼•ä¿¡ã€‚
 */
const STOCK_LIST = [
    // --- ğŸ’ å‚³å¥‡é€£å‹• (ç‰¹æ®Šè§¸ç™¼) ---
    { id: 'SOJ', name: 'å–¬ä¸¹å¯¦æ¥­', price: 290, category: 'å‰µæŠ•' }, // ğŸ”¥ ç‰©ç†å¼•ä¿¡

    // --- é‡‘èèˆ‡åœ°ç”¢ (é«˜æ³¢å‹•) ---
    { id: 'KGM', name: 'ç‹åœ‹é‘„å¹£å» ', price: 420, category: 'é‡‘è' },
    { id: 'VLT', name: 'éµå£ä¿éšªåº«', price: 380, category: 'é‡‘è' },
    { id: 'GBC', name: 'å“¥å¸ƒæ—é¢¨æŠ•', price: 150, category: 'é‡‘è' },
    { id: 'SLV', name: 'å¥´éš¸å‚µåˆ¸', price: 45, category: 'é‡‘è' },
    { id: 'REI', name: 'çš‡åŸæˆ¿åœ°ç”¢', price: 495, category: 'é‡‘è' },
    { id: 'TXF', name: 'é¿ç¨…å¤©å ‚é¡§å•', price: 210, category: 'é‡‘è' },
    { id: 'LND', name: 'é«˜åˆ©è²¸å·¥æœƒ', price: 88, category: 'é‡‘è' },

    // --- è»å·¥èˆ‡å¾æœ (æˆ°æ™‚æš´æ¼²) ---
    { id: 'SGE', name: 'æ”»åŸå¡”é‡å·¥', price: 320, category: 'è»å·¥' },
    { id: 'BSM', name: 'çŸ®äººé‘„åŠåŠ', price: 275, category: 'è»å·¥' },
    { id: 'AWX', name: 'é™„é­”ç®­é ­å·¥å» ', price: 190, category: 'è»å·¥' },
    { id: 'GOL', name: 'é­”åƒå‹•åŠ›è£ç”²', price: 480, category: 'è»å·¥' },
    { id: 'NRT', name: 'æ­»éˆå‚­å…µé›†åœ˜', price: 135, category: 'è»å·¥' },
    { id: 'PTR', name: 'çš‡å®¶å·¡é‚éšŠ', price: 65, category: 'è»å·¥' },
    { id: 'WSP', name: 'å¯†æ¢ç›£è½ç¶²', price: 240, category: 'è»å·¥' },

    // --- ç§‘æŠ€èˆ‡ç…‰é‡‘ (æš´åˆ©/é¢¨éšª) ---
    { id: 'ALC', name: 'çš‡å®¶ç…‰é‡‘è¡“', price: 310, category: 'ç§‘æŠ€' },
    { id: 'XTP', name: 'å‚³é€é–€ç¶­è­·', price: 440, category: 'ç§‘æŠ€' },
    { id: 'HYB', name: 'å¥‡ç¾æ‹‰åŸºå› ', price: 215, category: 'ç§‘æŠ€' },
    { id: 'CLK', name: 'ç™¼æ¢è‡ªå‹•åŒ–', price: 180, category: 'ç§‘æŠ€' },
    { id: 'MGC', name: 'æ³•åŠ›é›»æ± å„²èƒ½', price: 360, category: 'ç§‘æŠ€' },
    { id: 'SCR', name: 'ç©ºç™½å·è»¸è£½é€ ', price: 95, category: 'ç§‘æŠ€' },
    { id: 'TLP', name: 'å¿ƒéˆæ„Ÿæ‡‰é€šè¨Š', price: 285, category: 'ç§‘æŠ€' },

    // --- è³‡æºèˆ‡èƒ½æº (ç©©å®šå¢é•·) ---
    { id: 'DRG', name: 'é¾æ¯èƒ½æº', price: 410, category: 'èƒ½æº' },
    { id: 'GLD', name: 'é»ƒé‡‘ç¤¦å‘é›†çµ', price: 290, category: 'è³‡æº' },
    { id: 'LUM', name: 'ç¸äººä¼æœ¨å ´', price: 75, category: 'è³‡æº' },
    { id: 'WTR', name: 'è–æ°´æ·¨åŒ–å» ', price: 120, category: 'è³‡æº' },
    { id: 'MTR', name: 'ç§˜éŠ€æ¡æ˜æ¥­', price: 465, category: 'è³‡æº' },
    { id: 'GRN', name: 'è±æ”¶ç©€å€‰å„²', price: 55, category: 'è³‡æº' },
    { id: 'CRY', name: 'æ³•åŠ›æ°´æ™¶é–‹æ¡', price: 330, category: 'è³‡æº' },

    // --- ä¿¡ä»°èˆ‡å¨›æ¨‚ (é«˜æº¢åƒ¹) ---
    { id: 'CHU', name: 'è–å…‰å¤§æ•™å ‚', price: 390, category: 'ä¿¡ä»°' },
    { id: 'DKM', name: 'æš—å½±æš—æ®ºå·¥æœƒ', price: 165, category: 'ä¿¡ä»°' },
    { id: 'CAS', name: 'è¡€è…¥å¤§è³­å ´', price: 490, category: 'ä¿¡ä»°' },
    { id: 'TRN', name: 'è§’é¬¥å£«ç«¶æŠ€å ´', price: 220, category: 'ä¿¡ä»°' },
    { id: 'BAR', name: 'åŸéŠè©©äººå”±ç‰‡', price: 30, category: 'å¨›æ¨‚' },
    { id: 'IDL', name: 'é­…é­”å¶åƒåœ˜é«”', price: 140, category: 'å¨›æ¨‚' },
    { id: 'TAV', name: 'é€£é–å†’éšªè€…é…’é¤¨', price: 110, category: 'å¨›æ¨‚' },

    // --- è²¿æ˜“èˆ‡æ°‘ç”Ÿ (é˜²ç¦¦æ€§è‚¡) ---
    { id: 'SEA', name: 'æµ·å¦–è²¿æ˜“èˆ¹éšŠ', price: 260, category: 'è²¿æ˜“' },
    { id: 'CRT', name: 'å“¥å¸ƒæ—é‹è¼¸è»Š', price: 80, category: 'è²¿æ˜“' },
    { id: 'PST', name: 'é£›é¾å¿«é', price: 195, category: 'è²¿æ˜“' },
    { id: 'BRD', name: 'çŸ®äººé»‘å•¤é…’', price: 45, category: 'æ°‘ç”Ÿ' },
    { id: 'HLP', name: 'ç´…è—¥æ°´ç”ŸæŠ€', price: 155, category: 'æ°‘ç”Ÿ' },
    { id: 'CLO', name: 'çµ²ç¶¢èœ˜è››æœé£¾', price: 70, category: 'æ°‘ç”Ÿ' },
    { id: 'FSH', name: 'äººé­šæ°´ç”¢', price: 25, category: 'æ°‘ç”Ÿ' },

    // --- ç¨€æœ‰èˆ‡å‰µæŠ• (æœªä¸Šå¸‚æ„Ÿ) ---
    { id: 'UNI', name: 'ç¨è§’ç¸å‰µæŠ•', price: 340, category: 'å‰µæŠ•' },
    { id: 'SKL', name: 'æµ®ç©ºåŸå»ºè¨­', price: 499, category: 'å‰µæŠ•' },
    { id: 'PHX', name: 'é³³å‡°æ¶…æ§ƒå£½éšª', price: 230, category: 'å‰µæŠ•' },
    { id: 'EXP', name: 'åœ°ä¸‹åŸé–‹ç™¼', price: 185, category: 'å‰µæŠ•' },
    { id: 'KNT', name: 'é¨å£«ç²¾ç¥è£œç¿’ç­', price: 40, category: 'æ°‘ç”Ÿ' },
    { id: 'RSE', name: 'å¾©æ´»è¡“ç ”ç™¼', price: 470, category: 'ç§‘æŠ€' },
    { id: 'ECM', name: 'é»‘å¸‚é›»å•†ç¶²', price: 205, category: 'è²¿æ˜“' },
    { id: 'DMN', name: 'æƒ¡é­”å¥‘ç´„æ³•å¾‹', price: 315, category: 'é‡‘è' }
];


/**
 * ğŸ“ˆ ç‰©ç†åˆå§‹åŒ–ï¼šç‹åœ‹è‚¡å¸‚æ•¸æ“šçµæ§‹
 * ä¿®æ­£é»ï¼š
 * 1. Kç·šå°é½Šï¼šé å¡«é¦–æ ¹è Ÿç‡­ï¼Œé˜²æ­¢ drawMiniKLine å› ç©ºé™£åˆ—é–ƒé€€ã€‚
 * 2. éˆè·¯é˜²ç¦¦ï¼šé å¡«å…©ç­† history æ•¸æ“šï¼Œå¾¹åº•è§£æ±º renderStockTicker çš„ length-2 å ±éŒ¯ã€‚
 * 3. æˆæœ¬é–å®šï¼šåˆå§‹åŒ– avgCost æ¬„ä½ï¼Œç‚ºã€Œæ­¢æè­¦å ±ç·šã€é ç•™ç‰©ç†å¸­ä½ã€‚
 */
window.kingdomStocks = STOCK_LIST.map(s => {
    // ç‰©ç†é–‹ç›¤åƒ¹å¿«ç…§
    const basePrice = s.price || 100;

    return {
        ...s,
        price: basePrice,
        owned: 0,
        avgCost: 0,     // ç‰©ç†åˆå§‹åŒ–å¹³å‡æˆæœ¬
        lastChange: 0,
        
        // ğŸ”¥ ã€æ­·å²é˜²ç¦¦ã€‘é å¡«å…©ç­†æ•¸æ“šï¼Œè§£æ±ºè·‘é¦¬ç‡ˆ length-2 å ±éŒ¯
        history: [basePrice, basePrice],
        
        // ğŸ”¥ ã€ç‰©ç† K ç·šã€‘é¦–æ ¹åˆå§‹è Ÿç‡­ (é–‹ã€é«˜ã€ä½ã€æ”¶çš†ç‚ºåŸºé»)
        // æ ¼å¼ï¼š{ o:é–‹ç›¤, h:æœ€é«˜, l:æœ€ä½, c:æ”¶ç›¤, t:æ™‚é–“æˆ³ }
        candles: [{ 
            o: basePrice, 
            h: basePrice, 
            l: basePrice, 
            c: basePrice, 
            t: Date.now() 
        }]
    };
});


/**
 * ğŸ›’ ç‰©ç†å­ç¨‹åºï¼šè³¼ç‰©è»Šå‹•æ…‹æ›´æ–°å¼•æ“ (V5.6 æ¸²æŸ“å°æ­£ç‰ˆ)
 * ä½œç”¨ï¼šå³æ™‚æƒæè¼¸å…¥æ¡†ï¼ŒåŸ·è¡Œç‰©ç†é¿éšœèˆ‡é›™å¹£çµç®—é è¦½
 */
window.updateShopCart = function() {
    // å®šç¾©æ‰€æœ‰æ½›åœ¨çš„å•†å“ ID éˆè·¯ [cite: 2026-01-21]
    const itemIds = [
        'hp_pot', 'potion', 'antidote', 'hemostat', 'stimulant', 
        'scroll_king', 'scroll_noble', 'fake_decree', 'wiretap', 'soul_overdraft'
    ];
    
    // ç‰©ç†å…ƒæ•¸æ“šæ˜ å°„ (åç¨±ã€åŸºç¤é‡‘å¹£ã€åŸºç¤å¡µåŸƒ)
    const meta = {
        'hp_pot': { name: 'è£œè¡€ç½', p: 200, d: 0 }, 'potion': { name: 'è£œè¡€è—¥', p: 100, d: 0 },
        'antidote': { name: 'è§£æ¯’è—¥', p: 200, d: 0 }, 'hemostat': { name: 'æ­¢è¡€åŠ‘', p: 200, d: 0 },
        'stimulant': { name: 'èˆˆå¥®åŠ‘', p: 200, d: 0 }, 'scroll_king': { name: 'åœ‹ç‹å·è»¸', p: 1500, d: 0 },
        'scroll_noble': { name: 'è²´æ—å·è»¸', p: 800, d: 0 }, 'fake_decree': { name: 'è–æ—¨', p: 2000, d: 5 },
        'wiretap': { name: 'ç«Šè½å™¨', p: 3500, d: 10 }, 'soul_overdraft': { name: 'éˆé­‚é€æ”¯', p: 0, d: 25 }
    };

    let totalG = 0;
    let totalD = 0;
    let details = [];
    let itemCount = 0;

    // ğŸ”¥ ç‰©ç†å¾ªç’°ï¼šåŸ·è¡Œè·¨ç¯€é»æƒæèˆ‡ç©ºå€¼é¿éšœ [cite: 2026-01-21]
    for (const id of itemIds) {
        const input = document.getElementById(`qty-${id}`);
        
        // ğŸ›¡ï¸ ã€æ ¸å¿ƒä¿®æ­£ï¼šç©ºå€¼é˜²ç¦¦ã€‘
        // ç‰©ç†æ„ç¾©ï¼šè‹¥è©²å•†å“æœªåœ¨ç›®å‰ç•«é¢ä¸Šæ¸²æŸ“ï¼Œè·³éè©²ç¯€é»ï¼Œé˜²æ­¢ null.value å°è‡´å´©æ½°
        if (!input) continue; 
        
        const qty = parseInt(input.value) || 0;
        if (qty > 0) {
            // è¦å‰‡ï¼šæ™®é€šç‰©å“äº« VIP 8æŠ˜ï¼Œå¸¶æœ‰å¡µåŸƒæ¶ˆè€—çš„ç¦å¿Œç‰©å“ä¸æ‰“æŠ˜ [cite: 2026-01-28]
            const isForbidden = meta[id].d > 0;
            const price = (player.hasVipCard && !isForbidden) ? Math.floor(meta[id].p * 0.8) : meta[id].p;
            
            totalG += price * qty;
            totalD += meta[id].d * qty;
            details.push(`${meta[id].name} x${qty}`);
            itemCount += qty;
        }
    }

    // --- ğŸ¨ ç‰©ç†æ¸²æŸ“èˆ‡è¦–è¦ºåé¥‹ ---
    const listEl = document.getElementById('cart-items-list');
    const gEl = document.getElementById('cart-total-price');
    const dEl = document.getElementById('cart-total-dust');
    const btn = document.getElementById('btn-cart-checkout');
    const countEl = document.getElementById('cart-item-count');

    if (countEl) countEl.innerText = `${itemCount} é …ç›®`;
    
    if (details.length > 0) {
        // æ¸²æŸ“æ¸…å–®å­—ä¸²
        listEl.innerHTML = details.join('ã€');
        gEl.innerText = `${totalG.toLocaleString()} G`;
        dEl.innerText = totalD > 0 ? `+ âœ¨${totalD.toLocaleString()}` : '';
        
        // âš–ï¸ ç‰©ç†æ¬Šé™æ ¸å°ï¼šè²¡åŠ›èˆ‡è³‡æºæ˜¯å¦è¶³ä»¥çµç®—
        const canAfford = player.coin >= totalG && (player.phantomDust || 0) >= totalD;
        btn.disabled = !canAfford;
        
        if (canAfford) {
            btn.style.background = "linear-gradient(45deg, #1e8449, #27ae60)";
            btn.style.color = "#fff";
            btn.style.cursor = "pointer";
            btn.style.boxShadow = "0 4px 20px rgba(46, 204, 113, 0.4)";
            btn.innerText = "ç¢ºèªæ‰¹æ¬¡è³¼è²·";
        } else {
            btn.style.background = "#c0392b";
            btn.style.color = "#fff";
            btn.style.boxShadow = "none";
            btn.innerText = "è³‡æºä¸è¶³";
        }
    } else {
        // å›æ­¸ç‰©ç†ç©ºç‹€æ…‹
        listEl.innerHTML = '<span style="color:#444;">(å°šæœªé¸å–ç‰©è³‡)</span>';
        gEl.innerText = "0 G";
        dEl.innerText = "";
        btn.disabled = true;
        btn.style.background = "#333";
        btn.style.boxShadow = "none";
        btn.innerText = "ç¢ºèªæ‰¹æ¬¡è³¼è²·";
    }
};


/**
 * ğŸ’³ ç‰©ç†æ ¸å¿ƒï¼šè³¼ç‰©è»Šæ‰¹æ¬¡çµç®—å¼•æ“ (V5.6 æ•¸æ“šé–å®šç‰ˆ)
 * ä½œç”¨ï¼šåŸ·è¡Œæ‰£æ¬¾ã€ç‰©è³‡æ³¨å…¥ã€VIP æ™‰å‡åˆ¤å®šèˆ‡è³‡æ–™åº«ç‰©ç†å­˜æª”
 */
window.checkoutCart = async function() {
    // 1. ğŸ”¥ ã€ç‰©ç†æºå°é½Šã€‘å•†å“èˆ‡åƒ¹æ ¼çŸ©é™£
    const itemIds = [
        'hp_pot', 'potion', 'antidote', 'hemostat', 'stimulant', 
        'scroll_king', 'scroll_noble', 'fake_decree', 'wiretap', 'soul_overdraft'
    ];
    
    const meta = {
        'hp_pot': 200, 'potion': 100, 'antidote': 200, 'hemostat': 200, 'stimulant': 200,
        'scroll_king': 1500, 'scroll_noble': 800, 'fake_decree': 2000, 'wiretap': 3500, 'soul_overdraft': 0
    };
    
    const dustMeta = {
        'fake_decree': 5, 'wiretap': 10, 'soul_overdraft': 25
    };

    let costG = 0;
    let costD = 0;
    let purchaseBatch = {};

    // 2. ğŸ”¥ ã€ç‰©ç†æƒæèˆ‡ç©ºå€¼é¿éšœã€‘
    itemIds.forEach(id => {
        const input = document.getElementById(`qty-${id}`);
        if (!input) return; // ç‰©ç†è·³éæœªæ¸²æŸ“ç¯€é» [cite: 2026-02-06]
        
        const qty = parseInt(input.value) || 0;
        if (qty > 0) {
            const isForbidden = (dustMeta[id] > 0);
            const price = (player.hasVipCard && !isForbidden) ? Math.floor(meta[id] * 0.8) : meta[id];
            
            costG += price * qty;
            costD += (dustMeta[id] || 0) * qty;
            purchaseBatch[id] = qty;
        }
    });

    // 3. ç‰©ç†é¤˜é¡äºŒæ¬¡æª¢æŸ¥
    if (Object.keys(purchaseBatch).length === 0) return;
    if (player.coin < costG || (player.phantomDust || 0) < costD) {
        showNotification("ğŸ’€ çµç®—ä¸­æ–·ï¼šè³‡ç”¢ä¸è¶³ä»¥æ”¯ä»˜æ­¤ä»½å¥‘ç´„ã€‚");
        return;
    }

    // 4. ğŸ“‰ ã€ç‰©ç†åŸ·è¡Œæ‰£æ¬¾èˆ‡æ¶ˆè²»ç´€éŒ„ã€‘
    player.coin -= costG;
    player.phantomDust = (player.phantomDust || 0) - costD;
    // ç´¯è¨ˆæ¶ˆè²»é‡‘é¡ï¼Œç¢ºä¿ VIP é€²åº¦ä¸éºå¤± [cite: 2026-01-28]
    player.totalShopSpent = (player.totalShopSpent || 0) + costG;

    // 5. ğŸ“¦ ã€ç‰©è³‡æ³¨å…¥èˆ‡ç‹€æ…‹é–å®šã€‘
    player.items = player.items || {};
    for (const [id, qty] of Object.entries(purchaseBatch)) {
        if (id === 'scroll_king') {
            pokerGame.forceNextRank = 'king'; // å¼·åˆ¶ä½éšæ˜ å°„ [cite: 2026-02-04]
            showNotification("ğŸ“œ åœ‹ç‹å¥‘ç´„å·²ç‰©ç†ç”Ÿæ•ˆã€‚");
        } else if (id === 'scroll_noble') {
            pokerGame.forceNextRank = 'noble';
            showNotification("ğŸ“œ è²´æ—å®¶å¾½å·²å½é€ å®Œæˆã€‚");
        } else if (['fake_decree', 'wiretap', 'soul_overdraft'].includes(id)) {
            // ç¦å¿Œæ•ˆæœé–å®šï¼Œæ–¼ä¸‹å±€é»ç« [cite: 2026-02-04]
            player.activeForbiddenItem = id; 
        } else {
            // å¸¸è¦é†«ç™‚è³‡ç”¢å †ç–Š
            player.items[id] = (Number(player.items[id]) || 0) + qty;
        }
    }

    // 6. ğŸ’ ã€ç‰©ç†æ™‰å‡åˆ¤å®šã€‘
    if (!player.hasVipCard && player.totalShopSpent >= 5000) {
        player.hasVipCard = true;
        if (player.inventory && !player.inventory.includes("ğŸšï¸ é»‘å¸‚è²´è³“å¡")) {
            player.inventory.push("ğŸšï¸ é»‘å¸‚è²´è³“å¡");
        }
        showNotification("ğŸ’ æ‚¨å·²ç‰©ç†æ™‰å‡ç‚ºã€é»‘å¸‚è²´è³“ã€‘ï¼Œäº« 8 æŠ˜ç‰¹æ¬Šï¼");
    }

    // 7. ğŸ”¥ ã€é—œéµåŒæ­¥é–ã€‘ç«‹å³åŸ·è¡ŒæŒä¹…åŒ–å­˜æª”
    // ç‰©ç†æ„ç¾©ï¼šç¢ºä¿è£œçµ¦æ•¸æ“šç«‹å³å¯«å…¥å¤§ä¸€çµ±ç‡ƒæ–™åŒ…ï¼Œç„¡è¦–ä»»ä½•é‡æ•´æˆ–æ–·é›»
    if (typeof savePlayerToDB === 'function') {
        await savePlayerToDB(); 
        console.log("%cğŸ’¾ æ¡è³¼æ•¸æ“šå·²é–å®šè‡³ IndexedDBã€‚", "color: #27ae60; font-weight: bold;");
    }
    
    // 8. ğŸ¨ UI æ¸…ç†èˆ‡é‡ç¹ªå›æ­¸
    const modal = document.getElementById('kingdom-shop-modal');
    if (modal) modal.remove();
    
    // å…¨åŸŸ UI åŒæ­¥ (Header, å´é‚Šæ¬„)
    if (typeof updatePlayerUI === 'function') updatePlayerUI();
    
    // æˆ°è¡“ HUD ç‰©ç†åŒæ­¥ (è‹¥æ­£åœ¨ç‰Œæ¡Œä¸Š)
    const table = document.getElementById('poker-table');
    if (table) renderPokerTable(table);

    showNotification(`ğŸ“¦ æ¡è³¼é”æˆï¼æ”¯å‡º $${costG} G / âœ¨${costD}ã€‚`);
};


console.log("%cğŸ“ˆ ç‹åœ‹è‚¡å¸‚ç‰©ç†éˆè·¯å·²å°±ç·’ï¼š50 æ”¯æˆåˆ†è‚¡å·²è¼‰å…¥ K ç·šè»Œè·¡ä¼ºæœå™¨ã€‚", "color: #2ecc71; font-weight: bold;");


let dailyQuest = { type: "", target: "", targetCount: 5, currentCount: 0, isCompleted: false, bonusActive: false };


let currentMapDifficulty = "Home"; // é è¨­åœ¨å®¶
let encounterRate = 0; // é è¨­ 0ï¼Œç›´åˆ°ç©å®¶é¸æ“‡åœ°åœ–

// å…¨å±€è®Šæ•¸ï¼šè¨˜éŒ„ç•¶å‰æŸ¥çœ‹çš„è‚¡ç¥¨èˆ‡ K ç·šé€±æœŸ
let currentDetailStockId = null;
let currentDetailTimeframe = 20; // é è¨­ 20K


// --- ğŸ  å®¶å…·å‹•æ…‹å‡ç´šè¨ˆç®—å¼•æ“ ---
const UPGRADE_MATH = {
    maxLv: 10,
    // è¨ˆç®—æŒ‡å®šç­‰ç´šçš„æˆæœ¬ (å‚³å…¥é¡å‹èˆ‡ç›®æ¨™ç­‰ç´š)
    calculate: (type, lv) => {
        if (lv <= 1) return { coin: 0, dust: 0 };
        
        const base = {
            bed: { coin: 500, dust: 5 },
            vault: { coin: 800, dust: 8 },
            bookshelf: { coin: 600, dust: 6 }
        };

        // ç‰©ç†å…¬å¼ï¼šç­‰æ¯”ç´šæ•¸ç¿»å€
        // é‡‘å¹£æ¡ 2 å€å¢é•·ï¼Œå¡µåŸƒæ¡ 1.8 å€å¢é•· (é¿å…å¾ŒæœŸå¡µåŸƒæ•¸é‡éæ–¼å¤©æ–‡æ•¸å­—)
        const coinCost = Math.floor(base[type].coin * Math.pow(2, lv - 2));
        const dustCost = Math.floor(base[type].dust * Math.pow(1.8, lv - 2));
        
        return { coin: coinCost, dust: dustCost };
    },
    // å–å¾—å‹•æ…‹åœ–æ¨™èˆ‡æè¿°
    getInfo: (type, lv) => {
        const icons = {
            bed: ["ğŸ›Œ", "ğŸ›Œ", "ğŸ›‹ï¸", "ğŸ›‹ï¸", "ğŸ›ï¸", "ğŸ›ï¸", "ğŸ©", "ğŸ©", "ğŸ°", "ğŸ‘‘"],
            vault: ["ğŸ§³", "ğŸ§³", "ğŸ“¦", "ğŸ“¦", "ğŸ“¥", "ğŸ“¥", "ğŸ”’", "ğŸ”", "ğŸ¦", "ğŸ’"],
            bookshelf: ["ğŸ“š", "ğŸ“š", "ğŸ“‘", "ğŸ“‘", "ğŸ“–", "ğŸ“–", "ğŸ“œ", "ğŸ“œ", "ğŸ”®", "ğŸ§ "]
        };
        const effects = {
            bed: `å›è¡€é‡: ${Math.min(100, lv * 10)}%`,
            vault: `å­˜æ¬¾ç‡: ${Math.min(100, 40 + lv * 6)}%`,
            bookshelf: `é¡å¤– EXP: +${(lv - 1) * 5}%`
        };
        return { icon: icons[type][lv-1] || "â“", desc: effects[type] };
    }
};

let selectedCards = []; // ç‰©ç†è¨˜éŒ„è¢«é¸ä¸­çš„ç‰Œç´¢å¼•

POKER_AI.getValueIndex = (val) => ['3','4','5','6','7','8','9','10','J','Q','K','A','2'].indexOf(val.toString());

/**
 * ğŸƒ ç‰©ç†æ ¸å¿ƒï¼šç‰Œå‹é‘‘å®šä¸­æ¨ (å¤§è€äºŒé‚è¼¯å°é½Šç‰ˆ)
 * å°å…¥ä¿®æ­£ï¼š
 * 1. é †å­ä½éšåŒæ­¥ï¼š2-3-4-5-6 (9999) > 10-J-Q-K-A (8888) > A-2-3-4-5 (-100)ã€‚
 * 2. ç‰©ç†ç¦å¿Œå°é–ï¼šæ””æˆª J-Q-K-A-2 (11-12-13-1-2) è¼¸å‡º nullã€‚
 * 3. ç•°èƒ½é€£å‹•ï¼šæ•´åˆ [é€šæ‰æ€ç¶­]ã€[æˆ°è¡“é…åˆ] ç­‰ Roguelike ç‰©ç†åŠ æˆã€‚
 */
POKER_AI.getPattern = (cards) => {
    if (!cards || cards.length === 0) return null;
    const len = cards.length;

    // 0. ğŸ”¥ ã€ç‰©ç†åˆ†æµï¼šåµæ¸¬ Jokerã€‘
    const hasJoker = cards.some(c => c.value === 'JOKER' || c.isPhantom);
    if (hasJoker) {
        const target = (typeof pokerGame !== 'undefined' ? pokerGame.lastMovePattern : null);
        return POKER_AI.solveJokers(cards, target);
    }

    // åŸºç¤æ’åºï¼šä¾ç‰©ç†æ¬Šé‡ (3 < 4 ... < A < 2)
    const sorted = [...cards].sort((a, b) => a.power - b.power);
    const values = sorted.map(c => c.value);
    
    // è¡Œå‹•è€…æ¬Šé™åˆ¤å®š
    const currentPlayer = (typeof pokerGame !== 'undefined') ? pokerGame.players[pokerGame.turn] : null;
    const isHero = (currentPlayer && currentPlayer.id === 'player');
    const boon = isHero ? (pokerGame.activeBoon || null) : null;

    // [çµ•æœ›å¥‘ç´„] ç‰©ç†å‰¯ä½œç”¨
    if (boon === 'despair' && values.includes('2')) return null; 

    // --- A. å–®å¼µ & B. å°å­ ---
    if (len === 1) return { type: 'single', power: sorted[0].power, cardsCount: 1, label: sorted[0].label };
    if (len === 2 && values[0] === values[1]) {
        return { type: 'pair', power: sorted[1].power, cardsCount: 2, label: `${values[0]}å°` };
    }

    // --- C. äº”å¼µç‰Œçµ„ (5-CARD) & ç‚¸å½ˆ (BOMB) ---
    if (len === 5) {
        const counts = {};
        values.forEach(v => counts[v] = (counts[v] || 0) + 1);
        const valCounts = Object.values(counts).sort((a, b) => b - a);
        
        const isUniversalBoon = (boon === 'flexible' || boon === 'monochrome');
        const isNaturalFlush = sorted.every(c => c.suit === sorted[0].suit);
        
        // ==========================================
        // ğŸ¢ ç‰©ç†æ ¸å¿ƒï¼šé †å­æŒ‡ç´‹è­˜åˆ¥å¼•æ“
        // ==========================================
        const vIndices = values.map(v => POKER_AI.getValueIndex(v)).sort((a, b) => a - b);
        // ç”Ÿæˆç´”æ•¸å€¼ä¸²è¯æŒ‡ç´‹
        const vString = values.sort((a, b) => POKER_AI.getValueIndex(a) - POKER_AI.getValueIndex(b)).join(',');

        let isStraight = false;
        let straightPower = 0;
        let straightLabel = "é †å­";

        // ğŸš¨ 1. ã€ç‰©ç†ç¦å¿Œæ””æˆªã€‘å°é– J-Q-K-A-2
        if (vString === 'J,Q,K,A,2') return null; 

        // 2. ã€æŒ‡ç´‹è®Šé«”æ¯”å°ã€‘
        const isDragon = (vString === '3,4,5,6,2'); // 2-3-4-5-6
        const isRoyal  = (vString === '10,J,Q,K,A'); // 10-J-Q-K-A
        const isBaby   = (vString === '3,4,5,A,2');  // A-2-3-4-5
        
        // 3. ã€é€£çºŒæ€§åˆ¤å®šã€‘
        const isNormal = vIndices.every((v, i) => i === 0 || v === vIndices[i-1] + 1);

        if (isNormal || isDragon || isBaby || isRoyal) {
            isStraight = true;
            if (isDragon) {
                straightPower = 9999;
                straightLabel = "ğŸ”¥ å·¨é¾é †å­ (2-6)";
            } else if (isRoyal) {
                straightPower = 8888;
                straightLabel = "ğŸ‘‘ çš‡å®¶é †å­ (10-A)";
            } else if (isBaby) {
                straightPower = -100;
                straightLabel = "ğŸŒ± ç¨šå…’é †å­ (A-5)";
            } else {
                straightPower = Math.max(...vIndices); 
            }
        }

        // ==========================================
        // âš–ï¸ ç‰Œå‹æœ€çµ‚åˆ†æµ (å¤§è€äºŒç‰©ç†ä½éš)
        // ==========================================

        // 1. åŒèŠ±é † (Rank 6)
        if (isNaturalFlush && isStraight) {
            return { 
                type: 'bomb', sub: 'straight-flush', rank: 6, 
                power: straightPower, cardsCount: 5, label: `åŒèŠ±${straightLabel}`
            };
        }

        // 2. è¬è±¡åŒèŠ± (ç•°èƒ½ï¼šRank 6)
        if (isUniversalBoon && isNaturalFlush) {
            return {
                type: 'bomb', sub: 'legendary-flush', rank: 6, 
                power: sorted[4].power, cardsCount: 5, label: 'ğŸ­ è¬è±¡åŒèŠ± (BOMB)'
            };
        }

        // 3. éµæ”¯ (Rank 5)
        if (valCounts[0] === 4) {
            const quadValue = Object.keys(counts).find(v => counts[v] === 4);
            return { 
                type: 'bomb', sub: 'quads', rank: 5, 
                power: POKER_AI.getValueIndex(quadValue), 
                cardsCount: 5, label: 'éµæ”¯' 
            };
        }

        // 4. æˆ°è¡“é †å­ (ç•°èƒ½ï¼šRank 4)
        if (boon === 'tactics' && isStraight) {
            return { 
                type: 'bomb', sub: 'straight-tactic', rank: 4, 
                power: straightPower, cardsCount: 5, label: `âš”ï¸ æˆ°è¡“${straightLabel}` 
            };
        }

        // 5. ğŸ  è‘«è˜† (Rank 3)
        if (valCounts[0] === 3 && valCounts[1] === 2) {
            const tripleValue = Object.keys(counts).find(v => counts[v] === 3);
            return { 
                type: '5-card', sub: 'fullhouse', rank: 3, 
                power: POKER_AI.getValueIndex(tripleValue), 
                cardsCount: 5, label: 'è‘«è˜†' 
            };
        }

        // 6. ğŸ¢ æ™®é€šé †å­ (Rank 1)
        if (isStraight) {
            return { 
                type: '5-card', sub: 'straight', rank: 1, 
                power: straightPower, cardsCount: 5, label: straightLabel 
            };
        }
    }
    return null;
};

/**
 * ğŸƒ ç‰©ç†åµæ¸¬ï¼šå°‹æ‰¾æ‰€æœ‰å¯èƒ½çš„é›†åˆ (å°å­/ä¸‰æ¢/éµæ”¯) - å« Joker è£œä½èˆ‡å®‰å…¨æ’åºç‰ˆ
 * ä¿®æ­£ï¼šç‰©ç†æ€§é˜»æ–· null.power å ±éŒ¯ï¼Œä¸¦ç¢ºä¿å£“åˆ¶é‚è¼¯ç²¾ç¢ºã€‚
 */
POKER_AI.findAllSetsWithJokers = function(hand, targetSize, targetPattern) {
    const jokers = hand.filter(c => c.value === 'JOKER' || c.isPhantom);
    const normals = hand.filter(c => c.value !== 'JOKER' && !c.isPhantom);
    const results = [];
    
    // 1. ğŸ”¥ ã€ç‰©ç†æƒæã€‘ä»¥æ¯ä¸€ç¨®ç¾æœ‰çš„æ™®é€šç‰Œæ•¸å€¼ä½œç‚ºåŸºé»
    const groups = {};
    normals.forEach(c => {
        if (!groups[c.value]) groups[c.value] = [];
        groups[c.value].push(c);
    });

    Object.keys(groups).forEach(val => {
        const cards = groups[val];
        // æ ¸å¿ƒé‚è¼¯ï¼šæ™®é€šç‰Œä¸èƒ½è¶…éç›®æ¨™å¼µæ•¸ (ä¾‹å¦‚ï¼šæœ‰ä¸€å° 8 æƒ³çµ„å°å­ï¼Œå°±ä¸éœ€è¦è£œä½)
        // ç‰©ç†å„ªåŒ–ï¼šå¦‚æœæ‰‹ç‰ŒåŸæœ¬å°±å¤šæ–¼ targetSizeï¼Œåªå– targetSize å¼µ
        const baseCards = cards.slice(0, targetSize);
        const needed = targetSize - baseCards.length;

        // 2. ğŸ”¥ ã€ç‰©ç†è£œä½ã€‘
        if (needed >= 0 && jokers.length >= needed) {
            const combo = [...baseCards, ...jokers.slice(0, needed)];
            const pattern = POKER_AI.getPattern(combo);
            
            // ğŸ›‘ æ ¸å¿ƒä¿®æ­£ï¼šå¿…é ˆç¢ºä¿ pattern å­˜åœ¨ (ä¸ç‚º null)
            if (pattern) {
                // 3. ğŸ”¥ ã€ç‰©ç†å£“åˆ¶æª¢æŸ¥ã€‘
                if (!targetPattern || POKER_AI.isBigger(pattern, targetPattern)) {
                    results.push(combo);
                }
            }
        }
    });

    // 4. ğŸ”¥ ã€ç‰¹æ®Šç‰©ç†åˆ†æ”¯ã€‘å…¨ Joker çµ„æˆçš„é›†åˆ
    if (jokers.length >= targetSize) {
        const pureJokerCombo = jokers.slice(0, targetSize);
        const p = POKER_AI.getPattern(pureJokerCombo);
        if (p) {
            if (!targetPattern || POKER_AI.isBigger(p, targetPattern)) {
                results.push(pureJokerCombo);
            }
        }
    }

    // 5. ğŸ”¥ ã€çµ‚æ¥µé˜²ç¦¦æ’åºã€‘
    // ä¾æ“šå¼·åº¦æ’åº (ç”±å°åˆ°å¤§)ï¼Œç¢ºä¿è¼”åŠ©æŒ‰éˆ•é¸å–æœ€å°åˆæ³•çµ„åˆã€‚
    // ä½¿ç”¨å¯é¸éˆèˆ‡ä¿åº•å€¼ï¼Œå¾¹åº•çµ‚çµ Cannot read properties of null å ±éŒ¯ã€‚
    return results.sort((a, b) => {
        const pA = POKER_AI.getPattern(a);
        const pB = POKER_AI.getPattern(b);
        const powerA = pA?.power ?? 0;
        const powerB = pB?.power ?? 0;
        return powerA - powerB;
    });
};

/**
 * ğŸ¬ æ ¸å¿ƒæ¶æ§‹ï¼šå ´æ™¯ç®¡ç†å™¨ (å†’éšªäº’å‹•æŒ‰éˆ•ç‰ˆ)
 * ä¿®æ­£ï¼šåœ¨å†’éšªæ¨¡å¼ä¸‹é¡¯ç¤ºã€Œåˆ‡æ›åœ°åœ–ã€èˆ‡ã€Œå›åŸã€æŒ‰éˆ•
 */
function updateSceneMode(mode) {
    console.log(`ğŸ¬ åˆ‡æ›å ´æ™¯æ¨¡å¼: ${mode}`);
    
    // 1. å–å¾—æ‰€æœ‰åœ–å±¤
    const layers = {
        home: document.getElementById('home-interactions'),       // å®¶å…·å±¤ (å®¶)
        adventureUI: document.getElementById('adventure-interactions'), // ğŸ”¥ æ–°å¢ï¼šå†’éšªæŒ‰éˆ•å±¤
        adventure: document.getElementById('adventure-screen'),   // èƒŒæ™¯å±¤
        battle: document.getElementById('battle-scene'),
        poker: document.getElementById('poker-table'),
        hero: document.getElementById('hero-sprite')
    };

    // 2. ğŸ”¥ ã€ç‰©ç†é‡ç½®ã€‘å…ˆå…¨éƒ¨éš±è—
    if (layers.home) {
        layers.home.classList.remove('active'); 
        layers.home.style.display = 'none'; 
    }
    if (layers.adventureUI) {
        layers.adventureUI.style.display = 'none'; // é è¨­éš±è—å†’éšªæŒ‰éˆ•
    }
    if (layers.battle) layers.battle.style.display = 'none';
    if (layers.poker) layers.poker.style.display = 'none';
    
    if (layers.adventure) {
        layers.adventure.style.display = 'block';
        layers.adventure.style.animation = "none";
    }

    // 3. æ ¹æ“šæ¨¡å¼å•Ÿå‹•é‚è¼¯
    switch(mode) {
        case 'HOME': // ğŸ  åœ¨å®¶
            if(layers.home) {
                layers.home.style.display = 'flex'; // é¡¯ç¤ºå®¶å…·
                layers.home.classList.add('active');
            }
            if(layers.adventure) layers.adventure.style.background = "linear-gradient(to bottom, #ffebcd 0%, #f5deb3 100%)";
            if(layers.hero) {
                layers.hero.style.left = "50%";
                layers.hero.style.transform = "translateX(-50%)";
                layers.hero.classList.remove('walking');
            }
            break;

        case 'ADVENTURE': // âš”ï¸ å¤–å‡ºå†’éšª
            if(layers.adventureUI) {
                layers.adventureUI.style.display = 'flex'; // ğŸ”¥ é¡¯ç¤ºå†’éšªæŒ‰éˆ• (åœ°åœ–/å›åŸ)
            }
            // èƒŒæ™¯è‰²ç”± setupAdventureScene è¨­å®š
            if(layers.hero) {
                layers.hero.style.left = "10%";
                layers.hero.style.transform = "none";
                layers.hero.classList.add('walking');
            }
            break;

        case 'BATTLE': // ğŸ‘¹ æˆ°é¬¥ä¸­
            if(layers.battle) {
                layers.battle.style.display = 'flex';
                layers.battle.style.zIndex = "5000"; 
            }
            break;
            
        case 'POKER': // ğŸƒ è¡€è…¥ç‹åœ‹
            if(layers.poker) {
                layers.poker.style.display = 'flex';
                layers.poker.style.zIndex = "11000";
            }
            if(layers.adventure) layers.adventure.style.display = 'none';
            break;
    }
}

// --- ğŸ’¾ ç‰©ç†é€£å‹•ï¼šé‡ç½®ä¸¦å•Ÿå‹•å‹•ç•« ---
function triggerSaveEffect() {
    const el = document.getElementById('save-indicator');
    if (el) {
        // å¼·åˆ¶é‡è¨­å‹•ç•«ï¼šç§»é™¤ä¸¦é‡æ–°åŠ å…¥ class
        el.classList.remove('save-active');
        el.style.background = "#27ae60"; // æ¢å¾©ç¶ è‰²
        el.innerText = "ğŸ’¾";
        void el.offsetWidth; // ç‰©ç†è§¸ç™¼é‡ç¹ª (Reflow)
        el.classList.add('save-active');
    }
}

/**
 * ğŸ’¾ ç‰©ç†ä¿å­˜å‹‡è€…æ•¸æ“šåˆ° IndexedDB (V5.9.42)
 * ä½œç”¨ï¼šå‘¼å«æ‰“åŒ…å¼•æ“ä¸¦åŸ·è¡Œå¯«å…¥
 */
async function savePlayerToDB() {
    try {
        // 0. ç‰©ç†åˆ¶å‹•
        if (!player || typeof player.lv !== 'number') {
            throw new Error("å‹‡è€…æ•¸æ“šç‰©ä»¶ä¸å®Œæ•´ï¼Œå–æ¶ˆå¯«å…¥ã€‚");
        }

        // 1. ğŸ”¥ å‘¼å«å¤§ä¸€çµ±æ‰“åŒ…å¼•æ“ (ç¢ºä¿æ‰€æœ‰æ–°æ¬„ä½éƒ½è¢«ç´å…¥)
        const saveData = getUnifiedSavePayload();

        // 2. âš¡ ç‰©ç†åŸ·è¡Œ IndexedDB å¯«å…¥
        // ä½¿ç”¨ .put() ç¢ºä¿ ID ç‚º 'hero' çš„å­˜æª”åŸ·è¡Œè¦†è“‹è€Œéæ–°å¢
        await db.playerStats.put(saveData);
        
        // 3. âœ¨ è¦–è¦ºé€£å‹•ï¼šè§¸ç™¼å­˜æª”æŒ‡ç¤ºç‡ˆ
        if (typeof triggerSaveEffect === 'function') {
            triggerSaveEffect();
        }

        console.log(`%câœ… å…¨è³‡ç”¢ç‰©ç†é–å®šæˆåŠŸï¼šLV.${saveData.lv} | å±¬æ€§ã€æˆ°è¡“å¸¶èˆ‡è‚¡å¸‚å·²å…¥åº«ã€‚`, "color: #27ae60; font-weight: bold;");
        return true;

    } catch (e) { 
        console.error("âŒ ç‰©ç†å­˜æª”å¤±æ•—ï¼šæ•¸æ“šéˆè·¯æ–·è£‚", e); 
        // å ±è­¦è¦–è¦ºé€£å‹•
        const indicator = document.getElementById('save-indicator');
        if (indicator) {
            indicator.style.background = "#e74c3c";
            indicator.innerText = "âš ï¸";
        }
        return false;
    }
}

/**
 * ğŸ› ï¸ ç‰©ç†ç¨‹åºï¼šå¾ IndexedDB æ¢å¾©å‹‡è€…é­‚ (V5.9.43 å®Œå…¨é«”)
 * ä½œç”¨ï¼š
 * 1. æ·±åº¦é‚„åŸï¼šåŒ…å«å±¬æ€§ã€æˆ°è¡“å¸¶ã€è‚¡å¸‚èˆ‡ç‹åœ‹ç¶“æ¿Ÿæ•¸æ“šã€‚
 * 2. çµæ§‹è£œå®Œï¼šè‡ªå‹•ä¿®å¾©ç¼ºå¤±çš„æ–°æ¬„ä½ï¼Œè§£æ±º undefined å´©æ½°ã€‚ [cite: 2026-02-06]
 * 3. è¦–è¦ºåŒæ­¥ï¼šç¢ºä¿é‚„åŸå¾Œ UI èˆ‡æˆ°é¬¥æ•¸å€¼ 100% å°é½Šã€‚
 */
async function loadPlayerFromDB() {
    try {
        console.log("%cğŸ” æ­£åœ¨æª¢ç´¢å…¨åŸŸè³‡ç”¢ç‡ƒæ–™åŒ…...", "color: #3498db; font-weight: bold;");
        
        const data = await db.playerStats.get('hero');
        
        if (data) {
            // 1. ğŸ”¥ ã€æ•¸æ“šç‰©ç†èåˆã€‘å°‡å¿«ç…§è³‡æ–™é‚„åŸè‡³è¨˜æ†¶é«”
            player = {
                ...player,
                ...data
            };

            // 2. ğŸ›¡ï¸ ã€Schema ç‰©ç†é·ç§»ã€‘è£œå®Œè¿‘æœŸå°å…¥çš„æ–°æ©Ÿåˆ¶æ¬„ä½ [cite: 2026-02-06]
            // A. æˆ°è¡“è…°å¸¶ (Tactical Loadout)
            if (!player.tacticalSlots || !Array.isArray(player.tacticalSlots)) {
                player.tacticalSlots = ['hp_pot', 'antidote', 'stimulant'];
            }
            
            // B. æˆé•·å±¬æ€§ (Attributes)
            if (!player.attributes) {
                player.attributes = { str: 0, sta: 0, agi: 0, int: 0, block: 0, eva: 0, p_eva: 0 };
            }
            
            // C. è£å‚™æ§½ä½çµæ§‹åŠ å›º (é˜²æ­¢è®€å– offhand ç­‰æ–°æ§½ä½æ™‚å ±éŒ¯)
            if (!player.equips) player.equips = {};
            const defaultSlots = ['head','body','legs','boots','gloves','necklace','weapon','offhand','ring1','ring2','rune1','rune2','rune3','rune4','rune5'];
            defaultSlots.forEach(slot => {
                if (typeof player.equips[slot] === 'undefined') player.equips[slot] = null;
            });

            // 3. ğŸ° ã€ç‹åœ‹å»ºè¨­å¯¦é«”å›å¡«ã€‘
            if (data.kingdomSystem) {
                // æ·±åº¦æ‹·è²é˜²æ­¢å‚³å€æ±¡æŸ“ [cite: 2026-01-21]
                window.kingdomSystem = JSON.parse(JSON.stringify(data.kingdomSystem));
                console.log("âœ… è¨­æ–½ç­‰ç´šèˆ‡åœ‹åº«æ•¸æ“šå·²ç‰©ç†æ¢å¾©ã€‚");
            }

            // 4. ğŸ“ˆ ã€è‚¡å¸‚ K ç·šéˆè·¯é‚„åŸã€‘
            const savedStocks = data.kingdomStocks || data.stockSystem;
            if (savedStocks && Array.isArray(savedStocks)) {
                window.kingdomStocks = JSON.parse(JSON.stringify(savedStocks));
                console.log("âœ… è‚¡å¸‚æ­·å²è»Œè·¡èˆ‡ K ç·šå·²ç‰©ç†é‡æ§‹ã€‚");
            }

            // 5. ğŸ©¸ ã€ç”Ÿå­˜é«”å¾µç‰©ç†æ ¡æº–ã€‘
            // åŸºç¤è¡€é‡æˆé•·ï¼š50 + LV*10 [cite: 2026-01-21]
            player.maxHp = 50 + (player.lv * 10);
            
            // ğŸ”¥ ã€æ ¸å¿ƒä¿®æ­£ã€‘æª¢æŸ¥ä¸¦å°æ­£ç•¶å‰è¡€é‡ï¼Œé˜²æ­¢å›  NaN å°è‡´ UI æ¶ˆå¤±
            if (typeof player.currentHp !== 'number' || isNaN(player.currentHp)) {
                player.currentHp = player.maxHp;
            } else if (player.currentHp > player.maxHp) {
                player.currentHp = player.maxHp;
            }

            // 6. ğŸ¨ ã€å…¨ç’°å¢ƒ UI é»ç«ã€‘
            // A. åˆ·æ–°å´é‚Šæ¬„ï¼ˆå»ºè¨­ã€è‚¡å¸‚ï¼‰èˆ‡ç‹€æ…‹åˆ— [cite: 2026-01-19]
            if (typeof renderSidebarModules === 'function') renderSidebarModules();
            if (typeof updatePlayerUI === 'function') updatePlayerUI();
            
            // B. ğŸ”¥ ã€è¦–åœ–é€£å‹•ã€‘è‹¥è£å‚™åˆ†é é–‹å•Ÿä¸­ï¼ŒåŸ·è¡ŒäºŒæ¬¡æ¸²æŸ“ä»¥é¡¯ç¤ºæœ€æ–°å±¬æ€§ [cite: 2026-02-06]
            const equipPopup = document.getElementById('equipment-popup');
            if (equipPopup && equipPopup.style.display === 'flex') {
                if (typeof renderEquipmentUI === 'function') renderEquipmentUI();
            }

            console.log(`%cğŸ›¡ï¸ å­˜æª”å›æ­¸æˆåŠŸï¼šLV.${player.lv} | VIP: ${player.hasVipCard ? 'ğŸ‘‘' : 'âŒ'} | ğŸ’° ${player.coin} G`, "color: #2980b9; font-weight: bold;");
            return true;

        } else {
            console.log("%cğŸ†• æ‰¾ä¸åˆ°ç¾æœ‰ç‡ƒæ–™åŒ…ï¼Œå‹‡è€…å°‡å¾ LV.1 å±•é–‹å‚³å¥‡å†’éšªã€‚", "color: #8e44ad;");
            // åˆå§‹å±¬æ€§è³¦å€¼
            player.attributes = { str: 0, sta: 0, agi: 0, int: 0, block: 0, eva: 0, p_eva: 0 };
            player.tacticalSlots = ['hp_pot', 'antidote', 'stimulant'];
        }
    } catch (e) { 
        console.error("âŒ IndexedDB è®€å–å¤±æ•—ï¼ˆæ•¸æ“šéˆè·¯ä¸­æ–·ï¼‰:", e); 
    }
    return false;
}


/**
 * ğŸƒ ç‰©ç†æ•´åˆï¼šæ‰‹ç‰Œ 5 å¼µçµ„åˆå…¨é‡æƒæå¼•æ“ (Joker æ™ºæ…§è®Šå¹»å¼·åŒ–ç‰ˆ)
 * ä¿®æ­£ï¼šç§»é™¤ã€ŒåŒèŠ±ã€å¹²æ“¾ã€å¼·åŒ– Power æ’åºé˜²ç¦¦ã€è§£æ±ºé †å­åµæ¸¬å¤±æ•ˆ
 * ç¢ºä¿ï¼šç•¶ target ç‚ºç©ºæ™‚ï¼Œä¹Ÿèƒ½æšèˆ‰å‡ºæ‰€æœ‰åˆæ³•çš„è®Šå¹»çµ„åˆ
 */
POKER_AI.getAllPossible5CardCombos = function(hand, targetPattern) {
    const combos = [];
    const n = hand.length;
    
    // 0. ğŸ”¥ ã€ç‰©ç†æ””æˆªã€‘æ‰‹ç‰Œä¸è¶³ 5 å¼µç›´æ¥åˆ‡æ–·é‹ç®—
    if (n < 5) return [];

    // 1. ğŸ”¥ ã€ç‰©ç†æƒæã€‘åŸ·è¡Œ C(n, 5) çµ„åˆæšèˆ‰ (1287 çµ„)
    for (let i = 0; i < n; i++) {
        for (let j = i + 1; j < n; j++) {
            for (let k = j + 1; k < n; k++) {
                for (let l = k + 1; l < n; l++) {
                    for (let m = l + 1; m < n; m++) {
                        const subset = [hand[i], hand[j], hand[k], hand[l], hand[m]];
                        
                        // 2. ğŸ”¥ ã€è®Šå¹»åˆ¤å®šã€‘
                        // æ­¤è™•èª¿ç”¨ solveJokersï¼Œå®ƒå…§éƒ¨æœƒè™•ç† canFormStraight é‚è¼¯
                        const p = POKER_AI.solveJokers(subset, targetPattern);
                        
                        // 3. ğŸ”¥ ã€ç‰©ç†éæ¿¾ã€‘
                        if (p && p.type !== 'none') {
                            // ç‰©ç†è¦å‰‡ï¼šæ’é™¤æ™®é€šåŒèŠ± Flush (é™¤éæ˜¯ç‚¸å½ˆç´šåˆ¥çš„åŒèŠ±é †)
                            if (p.sub === 'flush' && p.type !== 'bomb') continue;

                            // 4. ğŸ”¥ ã€å¼·åº¦æª¢æŸ¥ã€‘
                            // åªè¦æ˜¯ç™¼çƒæ¬Š (target ç‚ºç©º) æˆ– å¼·åº¦è¶³ä»¥å£“åˆ¶ï¼Œå³è¦–ç‚ºå€™é¸çµ„åˆ
                            if (!targetPattern || POKER_AI.isBigger(p, targetPattern)) {
                                combos.push(subset);
                            }
                        }
                    }
                }
            }
        }
    }

    // 5. ğŸ”¥ ã€æˆ°è¡“æ’åºï¼šæœ€å°æ¶ˆè€—åŸå‰‡ã€‘
    // ä¾æ“šè®Šå¹»å¾Œçš„ Power ç”±å°åˆ°å¤§æ’åºï¼Œç¢ºä¿å¾ªç’°åˆ‡æ›æ™‚å„ªå…ˆå½ˆèµ·ã€Œæœ€å°åˆæ³•ç‰Œã€
    return combos.sort((a, b) => {
        // é‡è¦ï¼šæ’åºæ™‚å¿…é ˆå†æ¬¡é€²è¡Œæ¨¡æ“¬è®Šå¹»ä»¥å–å¾—çœŸå¯¦æ¬Šé‡
        const pA = POKER_AI.solveJokers(a, targetPattern);
        const pB = POKER_AI.solveJokers(b, targetPattern);
        
        // è³¦äºˆæ¥µå¤§å€¼ä¿åº•ï¼Œé˜²æ­¢ null æˆ–ç•°å¸¸æ•¸æ“šç ´å£æ’åº
        const powerA = (pA && pA.power !== undefined) ? pA.power : 999999;
        const powerB = (pB && pB.power !== undefined) ? pB.power : 999999;
        
        return powerA - powerB;
    });
};

/**
 * âš–ï¸ ç‰©ç†æ¯”ç‰Œå¼•æ“ï¼šå¤§è€äºŒçµ•å°é‚è¼¯ (V5.9.8 ç´”æ·¨å°æ­£ç‰ˆ)
 * ä¿®æ­£ï¼šç§»é™¤æ‰€æœ‰ addBattleLog å‰¯ä½œç”¨ï¼Œé˜²æ­¢çª®èˆ‰è¨ˆç®—æ™‚ç”¢ç”Ÿçš„æ—¥èªŒæ´—é »ã€‚
 */
POKER_AI.isBigger = (movePattern, targetPattern) => {
    const currentPlayer = pokerGame.players[pokerGame.turn];
    const lastPlayerName = pokerGame.lastPlayerName;

    // --- 0. ğŸ”¥ ã€ç‰©ç†ç™¼çƒæ¬Šèˆ‡å›æµé–å®šã€‘ ---
    // åˆ¤å®šï¼šç„¡ç›®æ¨™ã€æˆ°å ´æ·¨ç©ºã€æˆ–å…¨å“¡ PASS å›æ­¸ç™¼çƒæ¬Š
    if (!targetPattern || 
        typeof targetPattern !== 'object' || 
        lastPlayerName === "NONE" ||
        (currentPlayer && lastPlayerName === currentPlayer.name)) {
        return true; 
    }

    const m = movePattern;   
    const t = targetPattern; 
    if (!m || !m.type || !t.type) return false;

    // --- 1. ğŸ’¥ ã€ç‰©ç†ç‚¸å½ˆå¨æ¬Šå±¤ã€‘ ---
    if (m.type === 'bomb') {
        // è‹¥å°æ–¹ä¸æ˜¯ç‚¸å½ˆï¼Œç‰©ç†ç›´æ¥ç¢¾å£“
        if (t.type !== 'bomb') return true;
        
        // è‹¥é›™æ–¹çš†ç‚ºç‚¸å½ˆï¼Œæ¯”å°ä½éš (Rank: 6.åŒèŠ±é † > 5.éµæ”¯ > 4.æˆ°è¡“é †å­)
        if (m.rank !== t.rank) return Number(m.rank) > Number(t.rank);
        
        // ä½éšç›¸åŒæ¯”å°ç‰©ç† Power
        return Number(m.power) > Number(t.power);
    }
    
    // è‹¥å°æ–¹æ˜¯ç‚¸å½ˆï¼Œä¸€èˆ¬ç‰Œå‹ç‰©ç†ç„¡æ³•å£“åˆ¶
    if (t.type === 'bomb') return false; 

    // --- 2. ğŸ­ ã€Roguelike ç•°èƒ½èˆ‡è¡€ç›Ÿç‰©ç†å±¤ã€‘ ---
    const boon = pokerGame.activeBoon;
    const lastActor = pokerGame.players.find(p => p.name === lastPlayerName);

    // åœ‹ç‹åŒ…åœç¶²ï¼šéåœ‹ç‹æˆå“¡ï¼ˆåæŠ—è»ï¼‰ä¹‹é–“ä¸é€²è¡Œå¤§ç‰Œå£“åˆ¶ï¼Œä¿ç•™å¯¦åŠ›å°ä»˜åœ‹ç‹
    if (pokerGame.isKingSiege && currentPlayer.rank !== 'king' && lastActor && lastActor.rank !== 'king') {
        if (Number(t.power) > 100 && currentPlayer.id !== 'player') return false;
    }

    // [Rage] åº•å±¤å’†å“®ï¼šæ¢…èŠ± 3 ç‰©ç†å£“åˆ¶æœ€å¼·å–®å¼µ (Joker / 2)
    if (boon === 'rage' && m.type === 'single' && t.type === 'single') {
        const has3 = (pokerGame.lastMoveCards || []).some(c => c.value === '3');
        if (has3 && Number(t.power) >= 120) return true;
    }

    // [Resist] å¹³æ°‘èµ·ç¾©ï¼šå°å­ç‰©ç†å£“åˆ¶è‘«è˜† (å¤§è€äºŒç‰¹æ®Šç•°èƒ½ç‰©ç†åŒ–)
    if (boon === 'resist' && m.type === 'pair' && t.type === '5-card' && t.sub?.includes('fullhouse')) {
        return true;
    }

    // --- 3. âš–ï¸ ã€åŒå‹ç‰Œå°æ¯”ï¼šç‰©ç†éš”é›¢æ ¸å¿ƒã€‘ ---
    if (m.type === t.type) {
        // A. ã€äº”å¼µç‰Œçµ„éš”é›¢ã€‘
        if (m.type === '5-card') {
            // ğŸš¨ ç‰©ç†æ””æˆªï¼šç¦æ­¢è·¨ç‰Œå‹å°æ±ºï¼ˆä¾‹å¦‚é †å­ä¸èƒ½å£“è‘«è˜†ï¼‰
            if (m.sub !== t.sub) return false; 

            // ğŸ¢ ã€é †å­å…§éƒ¨æ¬Šä½å°æ±ºã€‘
            if (m.sub === 'straight') {
                const getStraightWeight = (p) => {
                    const label = String(p.label || "");
                    const val = Number(p.power);
                    // å·¨é¾é †å­ (2-3-4-5-6) > çš‡å®¶é †å­ (10-J-Q-K-A) > ç¨šå…’é †å­ (A-2-3-4-5)
                    if (label.includes("å·¨é¾") || val === 9999) return 9999;
                    if (label.includes("çš‡å®¶") || val === 8888) return 8888;
                    if (label.includes("ç¨šå…’") || val === -100) return -100;
                    return val;
                };
                return getStraightWeight(m) > getStraightWeight(t);
            }
        }

        // B. ã€å¼µæ•¸å°é½Šã€‘ç‰©ç†æª¢æŸ¥
        if (m.cardsCount !== t.cardsCount) return false;

        // C. ã€é¡¯æ€§æ•¸å€¼æ¯”å°ã€‘
        return Number(m.power) > Number(t.power);
    }

    return false;
};



/**
 * ğŸƒ ç‰©ç† AI æœå°‹ï¼šå¤§è€äºŒé«˜ç´šç­–ç•¥å¼•æ“ (æœ€å°ä»£åƒ¹èˆ‡æˆ°è¡“ä¿ç•™ç‰ˆ)
 * ä¿®æ­£ï¼š
 * 1. å°å…¥æœ€å°å£“åˆ¶é‚è¼¯ï¼šæ‰¾å‰›å¥½èƒ½è´çš„çµ„åˆï¼Œä¿ç•™æœ€å¼·ç‰Œã€‚
 * 2. é †å­å°ˆé …å„ªåŒ–ï¼šå„ªå…ˆä½¿ç”¨ä¸€èˆ¬é †å­ï¼Œä¿ç•™å·¨é¾é †å­ã€‚
 */
POKER_AI.findMove = (hand, targetPattern) => {
    const sortedHand = [...hand].sort((a, b) => a.power - b.power);
    
    // --- ğŸŸ¢ åˆ†æ”¯ä¸€ï¼šã€ç™¼çƒæ¬Šæ¨¡å¼ã€‘ ---
    if (!targetPattern || pokerGame.lastPlayerName === "NONE") {
        // ç™¼çƒç­–ç•¥ï¼šç”±å¤§åˆ°å°æ‰¾ 5 å¼µç‰Œçµ„ (è‘«è˜† > é †å­)
        // ğŸš¨ ä¿®æ­£ï¼šsearchBest5Card ç¾åœ¨æœƒå›å‚³ã€Œæœ€å¼±çš„åˆæ³• 5 å¼µçµ„ã€ä»¥ç¯€çœæˆ°åŠ›
        const best5 = POKER_AI.searchBest5Card(sortedHand);
        if (best5) return best5;

        const pair = POKER_AI.searchPair(sortedHand); 
        if (pair) return pair;

        return [sortedHand[0]]; // å‡ºæœ€å°å–®å¼µ
    }

    // --- ğŸ”´ åˆ†æ”¯äºŒï¼šã€è¢«å‹•é˜²å®ˆæ¨¡å¼ã€‘ ---
    const me = pokerGame.players[pokerGame.turn];
    
    // A. é‡å°å–®å¼µï¼šæ‰¾ã€Œå‰›å¥½å¤§æ–¼ç›®æ¨™ã€çš„æœ€å°å–®å¼µ
    if (targetPattern.type === 'single') {
        const validSingles = sortedHand.filter(c => POKER_AI.isBigger(POKER_AI.getPattern([c]), targetPattern));
        return validSingles.length > 0 ? [validSingles[0]] : null;
    }

    // B. é‡å°å°å­ï¼šæ‰¾æœ€å°åˆæ³•å°å­
    if (targetPattern.type === 'pair') {
        const allPairs = POKER_AI.findAllSetsWithJokers(sortedHand, 2, targetPattern);
        // findAllSetsWithJokers å…§éƒ¨å·²æ’åºï¼Œç›´æ¥å–é¦–ä½
        return allPairs.length > 0 ? allPairs[0] : null;
    }

    // C. é‡å°äº”å¼µç‰Œçµ„ (å¤§è€äºŒéš”é›¢è¦å‰‡)
    if (targetPattern.type === '5-card') {
        const all5CardCombos = POKER_AI.getAllPossible5CardCombos(sortedHand, targetPattern);
        if (all5CardCombos.length > 0) {
            // æˆ°è¡“ä¿ç•™ï¼šå¦‚æœæ‰‹ä¸­æœ‰å·¨é¾é †å­(9999)ä¸”æ™®é€šé †å­ä¹Ÿèƒ½è´ï¼Œå„ªå…ˆå‡ºæ™®é€šé †å­
            return all5CardCombos[0]; 
        }

        // è¢«å‹•åæ“Šï¼šè‹¥æ‰‹ä¸­ç‰Œå‰©ä¸å¤šï¼Œè€ƒæ…®ç”¨ç‚¸å½ˆç‰©ç†æ‘§æ¯€
        if (hand.length <= 6) {
            const bomb = POKER_AI.searchBomb(sortedHand, targetPattern);
            if (bomb) return bomb;
        }
    }

    // D. é‡å°ç‚¸å½ˆï¼šåªèƒ½ç”¨æ›´å¤§çš„ç‚¸å½ˆç¡¬ç¢°ç¡¬
    if (targetPattern.type === 'bomb') {
        const biggerBomb = POKER_AI.searchBomb(sortedHand, targetPattern);
        return biggerBomb;
    }

    return null; 
};

/**
 * ğŸ’¥ æœå°‹ç‚¸å½ˆï¼šæˆ°è¡“ç²¾ç¢ºç‰ˆ
 * ä¿®æ­£ï¼šæ”¯æ´ targetPattern å°æ¯”ï¼Œç¢ºä¿ä¸æœƒéš¨ä¾¿æµªè²»é«˜éšç‚¸å½ˆ
 */
POKER_AI.searchBomb = (hand, targetPattern = null) => {
    const combos = POKER_AI.getAllPossible5CardCombos(hand, null);
    
    // 1. ç¯©é¸å‡ºæ‰€æœ‰ç‚¸å½ˆ (éµæ”¯ã€åŒèŠ±é †ã€äº”é¬¼)
    const bombs = combos.map(c => POKER_AI.getPattern(c))
                       .filter(p => p && p.type === 'bomb');

    // 2. åŸ·è¡Œå£“åˆ¶éæ¿¾
    const validBombs = targetPattern ? 
        bombs.filter(p => POKER_AI.isBigger(p, targetPattern)) : bombs;

    if (validBombs.length === 0) return null;

    // 3. æ’åºä¸¦å–æœ€å°ä»£åƒ¹ç‚¸å½ˆ
    validBombs.sort((a, b) => {
        if (a.rank !== b.rank) return a.rank - b.rank;
        return Number(a.power) - Number(b.power);
    });

    // 4. å›åŸå¯¦é«”ç‰Œçµ„ (é€™è£¡éœ€è¦å†æ¬¡å°æ˜ )
    const bestBombPattern = validBombs[0];
    const finalCombo = combos.find(c => {
        const p = POKER_AI.getPattern(c);
        return p && p.rank === bestBombPattern.rank && p.power === bestBombPattern.power;
    });

    return finalCombo;
};

/**
 * ğŸƒ æœå°‹ç™¼çƒç”¨äº”å¼µç‰Œçµ„ï¼šæˆ°ç•¥è„«å‡ºåŸå‰‡
 * ä¿®æ­£ï¼šå„ªå…ˆå‡ºæ‰ã€Œä¸€èˆ¬é †å­ã€ä»¥æ±‚è„«æ‰‹ï¼Œä¿ç•™ã€Œé«˜ä½éšé †å­ã€æˆ–ã€Œè‘«è˜†ã€é€²è¡Œé˜²å®ˆã€‚
 */
POKER_AI.searchBest5Card = (hand) => {
    // 1. ğŸ”¥ ã€ç‰©ç†æšèˆ‰ã€‘ç²å–æ‰€æœ‰åˆæ³•çµ„åˆ
    const combos = POKER_AI.getAllPossible5CardCombos(hand, null);
    if (combos.length === 0) return null;

    // 2. ğŸ”¥ ã€ç‰©ç†è©•åˆ†çŸ©é™£ã€‘
    // è©•åˆ†è¶Šä½ä»£è¡¨ã€Œè¶Šå€¼å¾—åœ¨ç™¼çƒæ¬Šæ™‚ä¸Ÿæ‰ã€
    const getLeadPriority = (combo) => {
        const p = POKER_AI.getPattern(combo);
        if (!p) return 99999;
        
        const power = Number(p.power);
        
        // å„ªå…ˆåº¦ A: ä¸€èˆ¬é †å­ (Power åœ¨ 0~12 ä¹‹é–“) -> æœ€æƒ³ä¸Ÿæ‰
        if (p.sub === 'straight' && power < 8000 && power > -1) return 10 + power;
        
        // å„ªå…ˆåº¦ B: ç¨šå…’é †å­ (-100) -> è¶ç™¼çƒæ¬Šè¶•å¿«è„«æ‰‹
        if (p.sub === 'straight' && power === -100) return 20;

        // å„ªå…ˆåº¦ C: æœ€å°çš„è‘«è˜† -> ä¸­ç­‰å„ªå…ˆ
        if (p.sub === 'fullhouse') return 100 + power;

        // å„ªå…ˆåº¦ D: çš‡å®¶é †å­èˆ‡å·¨é¾é †å­ -> é€™æ˜¯é˜²å®ˆç¥ç‰Œï¼Œä¸è¼•æ˜“ä¸»å‹•ç™¼çƒ
        if (p.sub === 'straight' && power >= 8888) return 500 + (10000 - power);

        return 1000;
    };

    // 3. æ’åºï¼šå–è©•åˆ†æœ€ä½ï¼ˆæœ€å„ªå…ˆè„«æ‰‹ï¼‰çš„çµ„åˆ
    combos.sort((a, b) => getLeadPriority(a) - getLeadPriority(b));

    return combos[0];
};

/**
 * ğŸ•µï¸ ç‰©ç†æ„Ÿå®˜ï¼šå…¨é‡é›†åˆæœå°‹ (æ”¯æ´ Joker)
 * ä¿®æ­£ï¼šåŸ findAllSets ç„¡æ³•è­˜åˆ¥é¬¼ç‰Œè®Šå¹»ï¼Œæ”¹ç‚ºèª¿ç”¨ findAllSetsWithJokers
 */
POKER_AI.findAllSets = (hand, count) => {
    // ç‰©ç†éˆè·¯é‡å°å‘ï¼šä½¿ç”¨æˆ‘å€‘ä¹‹å‰å®šç¾©éçš„æ›´å¼·å¤§çš„ Joker æœç´¢å™¨
    return POKER_AI.findAllSetsWithJokers(hand, count, null);
};

/**
 * ğŸ” æœå°‹æœ€å¼±å°å­
 * ä¿®æ­£ï¼šç¢ºä¿åœ¨ç™¼çƒæ¬Šæ™‚ï¼Œå„ªå…ˆå‡ºæ‰ã€Œæœ€å°ã€çš„å°å­
 */
POKER_AI.searchPair = (hand) => {
    const pairs = POKER_AI.findAllSets(hand, 2);
    if (pairs.length === 0) return null;
    
    // findAllSetsWithJokers å…§éƒ¨å·²ç”±å°åˆ°å¤§æ’åºï¼Œç›´æ¥å–é¦–ä½
    return pairs[0];
};

/**
 * ğŸ¢ ç‰©ç†æš´åŠ›æƒæï¼šå…¨é‡çµ„åˆæšèˆ‰å™¨
 * ä¿®æ­£ï¼šåŸæœ¬çš„ slice(i, i+5) åªèƒ½æ‰¾ã€Œé€£çºŒã€çš„ç‰Œï¼Œæœƒæ¼æ‰ã€Œ1,3,5,7,9ã€é€™ç¨®æ•£äº‚ä½†åˆæ³•çš„çµ„åˆã€‚
 * æ”¹ç”¨ POKER_AI.getAllPossible5CardCombos ä½œç‚ºç‰©ç†å¼•æ“ã€‚
 */
POKER_AI.getAll5CardCombos = (hand) => {
    // ç›´æ¥éˆè·¯é‡å®šå‘åˆ°æˆ‘å€‘å…·å‚™ C(n,5) æšèˆ‰èƒ½åŠ›çš„å¼•æ“
    return POKER_AI.getAllPossible5CardCombos(hand, null);
};


/**
 * ğŸƒ é¬¼ç‰Œç‰©ç†åŒ–å¼•æ“ï¼šè®Šå¹»çŸ©é™£èˆ‡å¹»å½±ç´„æŸåŠ å›ºç‰ˆ
 * ä¿®æ­£ï¼š
 * 1. åš´æ ¼åŸ·è¡Œ phantomValue ç‰©ç†ç´„æŸï¼Œé˜²æ­¢é»‘å¸‚é¬¼ç‰Œé‚è¼¯ç©¿é€ã€‚
 * 2. å¼·åŒ–ç™¼çƒæ¬Šæ¨¡å¼ä¸‹çš„ã€Œæœ€å„ªè·¯å¾‘ã€è‡ªå‹•é¸å–ã€‚
 * 3. æ•´åˆå¤§è€äºŒéš”é›¢è¦å‰‡èˆ‡ç‰¹æ®Šé †å­æ¬Šä½ã€‚
 */
POKER_AI.solveJokers = (selectedCards, targetPattern) => {
    const jokers = selectedCards.filter(c => c.value === 'JOKER' || c.isPhantom);
    const normals = selectedCards.filter(c => c.value !== 'JOKER' && !c.isPhantom);
    const totalCount = selectedCards.length;
    
    const isHero = (typeof pokerGame !== 'undefined' && pokerGame.players[pokerGame.turn].id === 'player');
    const boon = isHero ? pokerGame.activeBoon : null;
    const hasFlexible = (boon === 'flexible' || boon === 'monochrome');

    // ==========================================
    // --- A. å–®å¼µåˆ¤å®š (1å¼µ) ---
    // ==========================================
    if (totalCount === 1 && jokers.length === 1) {
        const j = jokers[0];
        // ç´„æŸ 1ï¼šé»‘å¸‚é»æ•¸é–å®š
        if (j.phantomValue && j.phantomValue !== 'JOKER') {
            const vIdx = POKER_AI.getValueIndex(j.phantomValue);
            return { type: 'single', power: vIdx * 10 + 3, label: `ğŸƒ(${j.phantomValue})`, cardsCount: 1 };
        }
        // ç´„æŸ 2ï¼šèŠ±è‰²é–å®š (é è¨­è®Šå¹»ç‚ºè©²èŠ±è‰²çš„ 2)
        if (j.suit && j.suit !== 'ğŸƒ') {
            const sIdx = ['â™£','â™¦','â™¥','â™ '].indexOf(j.suit);
            return { type: 'single', power: 120 + sIdx, label: `ğŸƒ(${j.suit}2)`, cardsCount: 1 };
        }
        // ç„¡ç´„æŸï¼šæœ€å¼·å–®å¼µ
        return { type: 'single', power: 123, label: 'ğŸƒ(â™ 2)', cardsCount: 1 };
    }

    // ==========================================
    // --- B. å°å­åˆ¤å®š (2å¼µ) ---
    // ==========================================
    if (totalCount === 2 && jokers.length >= 1) {
        if (normals.length === 0) return { type: 'pair', power: 123, label: 'ğŸƒ(2å°)', cardsCount: 2 };

        const j = jokers[0];
        const base = normals[0];

        // ğŸš¨ ç‰©ç†è¡çªæ””æˆªï¼šè‹¥ Joker é–å®šçš„æ•¸å­—èˆ‡æ™®é€šç‰Œä¸ç¬¦ï¼Œåˆ¤å®šç‚ºéæ³•
        if (j.phantomValue && j.phantomValue !== 'JOKER' && j.phantomValue !== base.value) return null;

        const vIdx = POKER_AI.getValueIndex(base.value);
        return { type: 'pair', power: vIdx * 10 + 3, label: `ğŸƒ(${base.value}å°)`, cardsCount: 2 };
    }

    // ==========================================
    // --- C. äº”å¼µç‰Œçµ„åˆ¤å®š (5å¼µ) ---
    // ==========================================
    if (totalCount === 5 && jokers.length >= 1) {
        // 1. ğŸ”¥ ã€ç‰©ç†èŠ±è‰²ä¸€è‡´æ€§æª¢æŸ¥ã€‘
        // é™¤éæœ‰ã€Œé€šæ‰æ€ç¶­ã€ï¼Œå¦å‰‡å¦‚æœ Joker é–å®šäº†èŠ±è‰²ï¼Œæ™®é€šç‰Œå¿…é ˆåŒ¹é…
        const lockedSuitJoker = jokers.find(j => j.suit && j.suit !== 'ğŸƒ');
        if (lockedSuitJoker && !hasFlexible && normals.length > 0) {
            if (normals.some(n => n.suit !== lockedSuitJoker.suit)) return null;
        }

        // 2. ğŸ”¥ ã€é»æ•¸ç´„æŸé è™•ç†ã€‘
        // æª¢æŸ¥æ‰€æœ‰ Joker é–å®šçš„é»æ•¸æ˜¯å¦è¡çª (ä¾‹å¦‚å…©å¼µ Joker åˆ†åˆ¥é–å®šç‚º 3 å’Œ 4)
        const lockedValues = jokers.map(j => j.phantomValue).filter(v => v && v !== 'JOKER');
        if (new Set(lockedValues).size > jokers.length) return null;

        // 3. ğŸ”¥ ã€åŸ·è¡ŒçŸ©é™£è®Šå¹»ã€‘
        // å‘¼å«æˆ‘å€‘å…ˆå‰ä¿®æ­£å¥½çš„ solveFiveCardJoker é€²è¡Œä½éšå°é½Š (9999/8888/-100)
        let result = POKER_AI.solveFiveCardJoker(normals, jokers, targetPattern, hasFlexible);
        
        // 4. ğŸš¨ ã€ç™¼çƒæ¬Šä¿åº•è£œå¼·ã€‘
        if (!result && (!targetPattern || pokerGame.lastPlayerName === "NONE")) {
            if (POKER_AI.canFormStraight(normals, jokers.length)) {
                // é è¨­ç™¼çƒæœ€å°é †å­ (ç”± solveFiveCardJoker è™•ç†ç´°ç¯€ï¼Œæ­¤è™•ç‚ºå‚™æ´)
                result = { type: '5-card', sub: 'straight', rank: 1, power: 10, label: 'ğŸƒ(é †å­)', cardsCount: 5 };
            }
        }

        return result;
    }

    return null; 
};


/**
 * ğŸ¢ ç‰©ç†å­ç¨‹åºï¼šäº”å¼µé¬¼ç‰Œè®Šå¹»çŸ©é™£ (ä½éšå¸¸æ•¸åŒæ­¥ç‰ˆ)
 */
POKER_AI.solveFiveCardJoker = (normals, jokers, target, canUseBoon) => {
    const jokerCount = jokers.length;

    // --- ğŸ‘‘ 1. çµ‚æ¥µç‰¹ä¾‹ï¼šäº”é¬¼é™è‡¨ (æœ€é«˜éšç‚¸å½ˆ) ---
    if (jokerCount === 5) {
        return { 
            type: 'bomb', sub: 'straight-flush', rank: 6, 
            power: 30000, cardsCount: 5, label: 'ğŸŒŒ äº”é¬¼(çµ‚æ¥µåŒèŠ±é †)' 
        };
    }

    const valCounts = {};
    normals.forEach(c => valCounts[c.value] = (valCounts[c.value] || 0) + 1);
    const uniqueVals = Object.keys(valCounts);
    const maxSame = uniqueVals.length > 0 ? Math.max(...Object.values(valCounts)) : 0;
    const isNaturalFlush = normals.length > 0 && normals.every(c => c.suit === normals[0].suit);
    
    // æª¢æŸ¥æ˜¯å¦èƒ½çµ„æˆé †å­
    const isPossibleStraight = POKER_AI.canFormStraight(normals, jokerCount);

    // ==========================================
    // ğŸ’¥ STEP 1: ç‰©ç†ç‚¸å½ˆå±¤ (Rank 6 ~ 5)
    // ==========================================
    
    // 1. åŒèŠ±é †
    if (isNaturalFlush && isPossibleStraight) {
        return { 
            type: 'bomb', sub: 'straight-flush', rank: 6, 
            power: 20000 + jokerCount, 
            cardsCount: 5, label: 'ğŸƒ(åŒèŠ±é †)' 
        };
    }

    // 2. éµæ”¯
    if (maxSame + jokerCount >= 4) {
        const potentialQuads = uniqueVals.filter(v => valCounts[v] + jokerCount >= 4)
                                         .sort((a,b) => POKER_AI.getValueIndex(b) - POKER_AI.getValueIndex(a));
        const quadValue = potentialQuads[0] || '2';
        return { 
            type: 'bomb', sub: 'quads', rank: 5, 
            power: POKER_AI.getValueIndex(quadValue), 
            cardsCount: 5, label: 'ğŸƒ(éµæ”¯)' 
        };
    }

    // ==========================================
    // âš–ï¸ STEP 2: æ™®é€šç‰Œå‹å±¤ (Rank 3 ~ 1)
    // ==========================================

    // 3. è‘«è˜†
    if (!target || (target.type === '5-card' && target.sub === 'fullhouse') || target.type !== 'bomb') {
        if (uniqueVals.length <= 2 && (maxSame + jokerCount >= 3)) {
            const sortedVals = uniqueVals.sort((a, b) => POKER_AI.getValueIndex(b) - POKER_AI.getValueIndex(a));
            let bestTriple = sortedVals[0] || '2';
            
            if (target && target.sub === 'fullhouse') {
                const winnerVal = sortedVals.find(v => POKER_AI.getValueIndex(v) > target.power);
                if (winnerVal) bestTriple = winnerVal;
                else return null; 
            }
            return { type: '5-card', sub: 'fullhouse', rank: 3, power: POKER_AI.getValueIndex(bestTriple), cardsCount: 5, label: 'ğŸƒ(è‘«è˜†)' };
        }
    }

    // 4. é †å­ (æ ¸å¿ƒä½éšå°é½Š)
    if (isPossibleStraight) {
        const getLogicPower = () => {
            const isDragon = POKER_AI.canFormSpecificStraight(normals, jokerCount, '3,4,5,6,2');
            const isRoyal = POKER_AI.canFormSpecificStraight(normals, jokerCount, '10,J,Q,K,A');
            const isBaby = POKER_AI.canFormSpecificStraight(normals, jokerCount, '3,4,5,A,2');

            if (isDragon) return 9999; // ç‰©ç†å·”å³°
            if (isRoyal) return 8888;  // æ¬¡å¼·
            if (isBaby) return -100;   // å¢Šåº•
            
            // ä¸€èˆ¬é †å­ï¼šå–ç¾æœ‰ç‰Œä¸­ç´¢å¼•æœ€å¤§è€…ä½œç‚ºåŸºç¤ power
            const vIndices = normals.map(c => POKER_AI.getValueIndex(c.value));
            return vIndices.length > 0 ? Math.max(...vIndices) : 10;
        };

        const currentPower = getLogicPower();

        // âš–ï¸ é †å­å…§éƒ¨éš”é›¢å£“åˆ¶æª¢æŸ¥
        if (target && target.sub === 'straight') {
            if (currentPower <= Number(target.power)) return null; 
        }

        let finalLabel = 'ğŸƒ(é †å­)';
        if (currentPower === 9999) finalLabel = 'ğŸƒ(ğŸ”¥å·¨é¾é †å­)';
        if (currentPower === 8888) finalLabel = 'ğŸƒ(ğŸ‘‘çš‡å®¶é †å­)';
        if (currentPower === -100) finalLabel = 'ğŸƒ(ğŸŒ±ç¨šå…’é †å­)';

        return { 
            type: '5-card', sub: 'straight', rank: 1, 
            power: currentPower, 
            cardsCount: 5, label: finalLabel 
        };
    }

    return null; 
};



/**
 * ğŸ› ï¸ ç‰©ç†è¼”åŠ©ï¼šåˆ¤å®šæ˜¯å¦èƒ½æ¹Šæˆç‰¹å®šçš„æŒ‡ç´‹çµ„åˆ
 */
POKER_AI.canFormSpecificStraight = (normals, jokerCount, fingerPrint) => {
    const required = fingerPrint.split(',');
    let missing = 0;
    const normalVals = normals.map(c => c.value);
    
    for (let val of required) {
        if (!normalVals.includes(val)) missing++;
    }
    return missing <= jokerCount;
};

/**
 * ğŸ¢ ç‰©ç†è¼”åŠ©ï¼šåˆ¤å®šæ•¸å€¼æ˜¯å¦èƒ½ç”±é¬¼ç‰Œå¡«è£œæˆé †å­ (å¤§è€äºŒåº§æ¨™å°é½Šç‰ˆ)
 * ä¿®æ­£ï¼š
 * 1. ç¨šå…’é †å­ (A-2-3-4-5)ï¼šå°‡ A,2 æ˜ å°„ç‚º -2, -1ã€‚
 * 2. å·¨é¾é †å­ (2-3-4-5-6)ï¼šå°‡ 2 æ˜ å°„ç‚º -1ã€‚
 */
POKER_AI.canFormStraight = (normals, jokerCount) => {
    if (normals.length + jokerCount < 5) return false;

    // å–å¾—åŸºç¤æ¬ŠåŠ›ç´¢å¼• (3=0, 4=1 ... A=11, 2=12)
    const indices = normals.map(c => POKER_AI.getValueIndex(c.value)).sort((a,b) => a-b);
    
    // 1. ğŸ”¥ ã€ç‰©ç†ç¦å¿Œã€‘é †å­ä¸­æ•¸å€¼ä¸å¯é‡è¤‡
    if (new Set(indices).size !== normals.length) return false;

    /**
     * å…§éƒ¨å­ç¨‹åºï¼šè¦–çª—è·¨åº¦æª¢æŸ¥
     */
    const checkWindow = (sortedIndices) => {
        if (sortedIndices.length === 0) return jokerCount >= 5;
        const min = sortedIndices[0];
        const max = sortedIndices[sortedIndices.length - 1];
        
        // 5å¼µé †å­çš„æœ€å¤§è·¨åº¦ç‰©ç†é™åˆ¶ç‚º 4 (ä¾‹å¦‚ -2, -1, 0, 1, 2)
        if (max - min > 4) return false;
        
        // è¨ˆç®—å¡«æ»¿ç›®å‰ normals å€é–“æ‰€éœ€çš„é¬¼ç‰Œæ•¸
        const gaps = (max - min + 1) - sortedIndices.length;
        
        // åˆ¤å®šï¼šé¬¼ç‰Œè¶³ä»¥å¡«è£œç©ºç¼º
        return (gaps <= jokerCount);
    };

    // --- è®Šé«” A: æ¨™æº–è·¯å¾‘ (3, 4, 5 ... J, Q, K, A) ---
    // æ­¤è·¯å¾‘ä¸åŒ…å« '2'ï¼Œå› ç‚º 2 åœ¨å¤§è€äºŒä¸­å¿…é ˆæ”¾åœ¨å…©ç«¯æˆ–ç‰¹å®šè®Šé«”
    const standardIndices = indices.filter(idx => idx !== 12); 
    if (standardIndices.length === indices.length) {
        if (checkWindow(indices)) return true;
    }

    // --- è®Šé«” B: ç¨šå…’é †å­ (A-2-3-4-5) ---
    // æ˜ å°„æ–¹æ¡ˆï¼šA(11)->-2, 2(12)->-1, 3(0)->0, 4(1)->1, 5(2)->2
    const altIndicesB = indices.map(idx => {
        if (idx === 11) return -2; // A
        if (idx === 12) return -1; // 2
        return idx;
    }).sort((a,b) => a-b);
    if (checkWindow(altIndicesB)) return true;

    // --- è®Šé«” C: å·¨é¾é †å­ (2-3-4-5-6) ---
    // æ˜ å°„æ–¹æ¡ˆï¼š2(12)->-1, 3(0)->0, 4(1)->1, 5(2)->2, 6(3)->3
    const altIndicesC = indices.map(idx => {
        if (idx === 12) return -1; // 2
        return idx;
    }).sort((a,b) => a-b);
    if (checkWindow(altIndicesC)) return true;

    return false;
};


// åŸ·è¡Œè£å‚™å‹•ä½œ
function equipFromCollection(itemId) {
    const item = MASTER_COLLECTION.find(i => i.id === itemId);
    if (!item) return;

    // æ ¹æ“š type è‡ªå‹•æ‰¾åˆ°ç‰©ç†æ§½ä½
    player.equips[item.type] = item;
    
    showNotification(`âœ¨ å·²è£å‚™ï¼š${item.name}`);
    
    // ç‰©ç†åŒæ­¥æ›´æ–°
    updatePlayerUI();
    if (battleData.isBattleActive) updateBattleUI();
}

function getFinalBattleStats() {
    let totalAtk = player.lv; // åŸºç¤æ”»æ“Š
    let totalDef = 0;
    let timeBonus = 0;

    // ç‰©ç†éæ­·æ‰€æœ‰è£å‚™æ§½ï¼ŒåŠ ç¸½æ•¸å€¼
    Object.values(player.equips).forEach(item => {
        if (!item) return;
        if (item.stats.atk) totalAtk += item.stats.atk;
        if (item.stats.def) totalDef += item.stats.def;
        if (item.stats.timer) timeBonus += item.stats.timer;
    });

    return { totalAtk, totalDef, timeBonus };
}

// ä¿®æ­£å¾Œçš„å‚·å®³è¨ˆç®—ï¼šåŠ å…¥å±¬æ€§åˆ¤å®š
function calculateDamage(examElement, enemyAppearance) {
    let baseDamage = 20 + (player.lv * 2);
    let multiplier = 1.0;

    // å–å¾—é­”ç‰©ä¸»å±¬æ€§ (æ ¹æ“š appearance åˆ¤å®š)
    const enemyElement = getElementByIcon(enemyAppearance);

    // ç‰©ç†ç›¸å‰‹åˆ¤å®š
    if (ELEMENT_REACTIONS[enemyElement]?.weak === examElement) {
        multiplier = 2.0; // é›™å€å‚·å®³ï¼
        showNotification("âœ¨ å±¬æ€§å‰‹åˆ¶ï¼é€ æˆäº†æ¯€æ»…æ€§å‚·å®³ï¼");
    } else if (ELEMENT_REACTIONS[enemyElement]?.resist === examElement) {
        multiplier = 0.5; // æ¸›åŠå‚·å®³
        showNotification("ğŸ›¡ï¸ å±¬æ€§æŠ—æ€§... å‚·å®³è¢«æŠµéŠ·äº†ã€‚");
    }

    // è£å‚™ç‰©ç†åŠ æˆ (ä¾‹å¦‚ï¼šç«ä¹‹åŠå¢åŠ ç«ç³» 20% å‚·å®³)
    if (player.equips?.weapon?.element === examElement) multiplier *= 1.2;

    return Math.floor(baseDamage * multiplier);
}

// --- é­”ç‰©æ”»æ“Šå¼•æ“ ---
function enemyTurn() {
    if (battleData.monsterHP <= 0) return;

    // 1. ç‰©ç†è¨ˆç®—å‚·å®³ (é›£åº¦è¶Šé«˜å‚·å®³è¶Šé‡)
    const difficultyMultiplier = { "N5": 5, "N4": 10, "N3": 20, "N2": 35, "N1": 50, "N0": 80 };
    let enemyAtk = difficultyMultiplier[currentMapDifficulty] || 10;
    
    // 2. è£å‚™é˜²ç¦¦ç‰©ç†æŠµæ‰£
    let defense = player.equips?.armor?.def || 0;
    let finalDamage = Math.max(1, enemyAtk - defense);

    // 3. åŸ·è¡Œæ‰£è¡€
    player.currentHp -= finalDamage;
    
    // 4. ç‰©ç†ç‰¹æ•ˆï¼šç•«é¢éœ‡å‹•èˆ‡ç´…é–ƒ
    const scene = document.getElementById('battle-scene');
    scene.style.animation = "shake 0.3s";
    setTimeout(() => scene.style.animation = "", 300);

    showNotification(`ğŸ’¢ é­”ç‰©åæ“Šï¼å—åˆ°äº† ${finalDamage} é»å‚·å®³ï¼`);

    // 5. åˆ¤å®šå‹‡è€…æ˜¯å¦åŠ›ç›¡
    if (player.currentHp <= 0) {
        player.currentHp = 0;
        finishBattle(false); // åˆ¤å®šå¤±æ•—
    }
    
    updatePlayerUI();
}



// =========================================
// âš”ï¸ è£å‚™ç³»çµ±æ ¸å¿ƒï¼šè³‡æ–™åˆå§‹åŒ– (Data Initialization)
// =========================================

// 1. åˆå§‹åŒ–è£å‚™æ•¸æ“š (æ–°å¢ offhand èˆ‡ç¬¦æ–‡æ§½ï¼ŒåŒæ™‚ä¿ç•™èˆŠè³‡æ–™)
function initEquipmentData() {
    // å¦‚æœç©å®¶é‚„æ²’æœ‰è£å‚™è³‡æ–™ï¼Œæˆ–è€…è³‡æ–™çµæ§‹éèˆŠ (æ²’æœ‰ offhand)ï¼Œå‰‡é€²è¡Œä¿®è£œ
    if (!player.equips || typeof player.equips.offhand === 'undefined') {
        
        // æš«å­˜èˆŠè³‡æ–™ (å¦‚æœæœ‰çš„è©±)
        const old = player.equips || {};
        
        // é‡å»ºçµæ§‹ï¼Œå„ªå…ˆä½¿ç”¨èˆŠè³‡æ–™ï¼Œæ²’æœ‰å‰‡è¨­ç‚º null
        player.equips = {
            head: old.head || null,
            necklace: old.necklace || null, 
            body: old.body || null, 
            gloves: old.gloves || null,
            ring1: old.ring1 || null, 
            ring2: old.ring2 || null, 
            legs: old.legs || null, 
            boots: old.boots || null, 
            weapon: old.weapon || null,
            offhand: old.offhand || null, // ğŸ”¥ æ–°å¢ï¼šå‰¯æ‰‹æ¬„ä½
            rune1: old.rune1 || null, 
            rune2: old.rune2 || null, 
            rune3: old.rune3 || null, 
            rune4: old.rune4 || null, 
            rune5: old.rune5 || null
        };

        // èˆŠå­˜æª”é·ç§»é‚è¼¯ (å¦‚æœä»¥å‰ç”¨ accessory ä»£è¡¨é …éŠ)
        if (old.accessory && !player.equips.necklace) {
            player.equips.necklace = old.accessory;
        }
    }
}

/**
 * ğŸ“Š ç‰©ç†å­ç¨‹åºï¼šå±¬æ€§æ•¸æ“šæ ¡æº–
 */
function initAttributeData() {
    player.lv = player.lv || 1;
    // ğŸ”¥ æ ¸å¿ƒä¿®æ­£ï¼šè‹¥å±¬æ€§ä¸å­˜åœ¨ï¼Œå¼·åˆ¶å¯«å…¥é è¨­å€¼
    if (!player.attributes) {
        player.attributes = { str: 0, sta: 0, int: 0, agi: 0, block: 0, eva: 0, p_eva: 0 };
    }
    // è¨ˆç®—å‰©é¤˜é»æ•¸ï¼š(ç­‰ç´š * 3) - å·²åˆ†é…ç¸½å’Œ
    const attr = player.attributes;
    const totalSpent = (attr.str || 0) + (attr.sta || 0) + (attr.int || 0) + (attr.agi || 0);
    player.statPoints = (player.lv * 3) - totalSpent;
}

/**
 * ğŸ“Š æ•¸æ“šå­ç¨‹åºï¼šé»æ•¸èˆ‡å±¬æ€§æ›ç®— (V5.9.35)
 */
function getCombatPerformance() {
    const attr = player.attributes || { str: 0, sta: 0, agi: 0, int: 0, block: 0, eva: 0, p_eva: 0 };
    const equipDef = player.equips?.body?.stats?.def || 0; 

    // 1. ç‰©ç†ç¸½é˜²ç¦¦ï¼š$ (BaseDef + STA \times 2) \times (1 + STR \times 0.5\%) $ [cite: 2026-02-06]
    const finalDefPoints = (equipDef + (attr.sta * 2)) * (1 + (attr.str * 0.005));

    // 2. ç‰©ç†æŠµæŠ—åŠ›ï¼šæ¯ 1 é» Def æä¾› 0.5% æ¸›å‚· [cite: 2026-02-06]
    const physicalResistance = finalDefPoints * 0.005;

    // 3. è¿´é¿èˆ‡å®Œå…¨è¿´é¿åˆ¤å®šéˆ [cite: 2026-02-06]
    const evaRate = (attr.agi * 0.005) + (attr.eva * 0.01);
    // å®Œå…¨è¿´é¿ = Block*1.5% + Eva*20% + PEva*1% [cite: 2026-02-06]
    const perfectDodgeRate = (attr.block * 0.015) + (evaRate * 0.2) + (attr.p_eva * 0.01);

    return {
        defPoints: finalDefPoints,
        physResist: Math.min(0.9, physicalResistance), 
        perfectDodge: Math.min(0.8, perfectDodgeRate), 
        specResist: attr.int * 5,
        remainingPoints: (player.lv * 3) - (attr.str + attr.sta + attr.agi + attr.int)
    };
}


// 4. è£å‚™UIä¸»æ¸²æŸ“å…¥å£
function renderEquipmentUI() {
    initEquipmentData(); // ç¢ºä¿è£å‚™çµæ§‹
    initAttributeData(); // ğŸ”¥ ç¢ºä¿å±¬æ€§çµæ§‹ (ä¿®å¾© Cannot read properties of undefined)

    const scrollContent = document.querySelector('#equipment-popup .popup-content-scroll') || 
                          document.querySelector('#equipment-screen .content-area');
    
    if (!scrollContent) {
        console.warn("âŒ æ¸²æŸ“å¤±æ•—ï¼šæ‰¾ä¸åˆ°è£å‚™è¦–çª—å®¹å™¨");
        return;
    }

    // 1. é ‚éƒ¨æ¨™ç±¤åˆ—
    const tabHeader = `
        <div style="display:flex; gap:10px; margin-bottom:20px; background:rgba(0,0,0,0.3); padding:5px; border-radius:12px;">
            <div onclick="window.switchEquipTab('equip')" style="flex:1; padding:10px; text-align:center; cursor:pointer; border-radius:8px; font-size:12px; font-weight:bold; transition:0.2s; background:${currentEquipTab === 'equip' ? '#3498db' : 'transparent'}; color:${currentEquipTab === 'equip' ? '#fff' : '#666'};">ğŸ›¡ï¸ æ­¦è£æ›è¼‰</div>
            <div onclick="window.switchEquipTab('stats')" style="flex:1; padding:10px; text-align:center; cursor:pointer; border-radius:8px; font-size:12px; font-weight:bold; transition:0.2s; background:${currentEquipTab === 'stats' ? '#3498db' : 'transparent'}; color:${currentEquipTab === 'stats' ? '#fff' : '#666'};">ğŸ“Š æˆé•·ç´ è³ª</div>
        </div>
    `;

    // 2. å…§å®¹åˆ†æµ
    if (currentEquipTab === 'equip') {
        drawEquipmentTabView(scrollContent, tabHeader);
    } else {
        drawAttributesTabView(scrollContent, tabHeader);
    }
}


/**
 * ğŸ›¡ï¸ è£å‚™åˆ†é æ¸²æŸ“ (V5.9.38 æ•¸å€¼é€£å‹•ç‰ˆ)
 * ä¿®æ­£ï¼šé ‚éƒ¨é¢æ¿ç¾åœ¨é¡¯ç¤ºåŒ…å«ã€ŒåŠ›é‡åŠ æˆã€å¾Œçš„æœ€çµ‚é˜²ç¦¦åŠ›ã€‚
 */
function drawEquipmentTabView(container, headerHTML) {
    // ğŸ”¥ 1. ç²å–å…¨åŸŸè¨ˆç®—å¾Œçš„æœ€çµ‚æ•¸å€¼ (å« STR/STA åŠ æˆ)
    const finalStats = calculateCombatStats(); 
    
    // å®šç¾©æ§½ä½
    const slots = [
        { id: 'gloves', icon: 'ğŸ§¤', label: 'æ‰‹å¥—' }, { id: 'weapon', icon: 'âš”ï¸', label: 'ä¸»æ‰‹' }, { id: 'ring1', icon: 'ğŸ’', label: 'æˆ’æŒ‡ I' },
        { id: 'head', icon: 'ğŸ‘‘', label: 'é ­éƒ¨' }, { id: 'body', icon: 'ğŸ§¥', label: 'ç›”ç”²' }, { id: 'legs', icon: 'ğŸ‘–', label: 'è¤²ç”²' }, { id: 'boots', icon: 'ğŸ‘¢', label: 'é‹å­' },
        { id: 'necklace', icon: 'ğŸ“¿', label: 'é …éŠ' }, { id: 'offhand', icon: 'ğŸ›¡ï¸', label: 'å‰¯æ‰‹' }, { id: 'ring2', icon: 'ğŸ’', label: 'æˆ’æŒ‡ II' }
    ];
    const runes = [
        { id: 'rune1', icon: 'ğŸ”®', label: 'I' }, { id: 'rune2', icon: 'ğŸ”®', label: 'II' },
        { id: 'rune3', icon: 'ğŸ”®', label: 'III' }, { id: 'rune4', icon: 'ğŸ”®', label: 'IV' }, { id: 'rune5', icon: 'ğŸ”®', label: 'V' }
    ];

    // è¼”åŠ©æ¸²æŸ“æ§½ä½
    const renderSlot = (s, isRune = false) => {
        const eqName = player.equips[s.id];
        let content = '';
        let itemClass = isRune ? 'equip-slot rune' : 'equip-slot';

        if (eqName) {
            itemClass += ' equipped';
            const parts = eqName.split(' ');
            const icon = parts[0];
            const name = parts.slice(1).join(' ').split(' (+')[0];
            const lv = getRefineLv(eqName);
            const lvText = lv > 0 ? `<span style="color:#f1c40f;">+${lv}</span>` : '';
            
            content = `
                <div class="${itemClass}" id="slot-${s.id}" onclick="showItemDetails('${eqName}', 'equip', '${s.id}')">
                    <div class="slot-icon">${icon}</div>
                    <div class="slot-name">${name} ${lvText}</div>
                </div>
            `;
        } else {
            const type = isRune ? 'rune' : (s.id.includes('ring') ? 'ring' : s.id);
            content = `
                <div class="${itemClass}" id="slot-${s.id}" onclick="openEquipSelector('${s.id}', '${type}')">
                    <span style="font-size:20px; opacity:0.2;">${s.icon}</span>
                </div>
            `;
        }
        return `<div class="slot-wrapper"><div class="slot-label">${s.label}</div>${content}</div>`;
    };

    // ğŸ”¥ 2. ä½¿ç”¨ finalStats.atkPoints èˆ‡ defPoints æ¸²æŸ“é ‚éƒ¨é¢æ¿
    // é€™ç¢ºä¿äº†æ•¸å€¼èˆ‡ã€Œæˆé•·ç´ è³ªã€é é¢å®Œå…¨ä¸€è‡´
    const paperDollHTML = `
        <div class="equip-stats-preview">
            <div>ğŸ’¥ ç¸½æ”»æ“Š: <span id="eq-total-atk" style="color:#e74c3c;">${finalStats.atkPoints}</span></div>
            <div>ğŸ›¡ï¸ ç¸½é˜²ç¦¦: <span id="eq-total-def" style="color:#3498db;">${finalStats.defPoints}</span></div>
        </div>

        <div class="paper-doll-grid">
            <div class="doll-col side-col">${renderSlot(slots[0])} ${renderSlot(slots[1])} ${renderSlot(slots[2])}</div>
            <div class="doll-col center-col">${renderSlot(slots[3])} ${renderSlot(slots[4])} ${renderSlot(slots[5])} ${renderSlot(slots[6])}</div>
            <div class="doll-col side-col">${renderSlot(slots[7])} ${renderSlot(slots[8])} ${renderSlot(slots[9])}</div>
        </div>

        <div class="rune-section">
            <div class="section-title">ğŸ”® ç¬¦æ–‡å…±é³´ (Runes)</div>
            <div class="rune-container">${runes.map(r => renderSlot(r, true)).join('')}</div>
        </div>
    `;

    // æˆ°è¡“è…°å¸¶æ¸²æŸ“ (ç¶­æŒåŸæ¨£)
    const tSlots = player.tacticalSlots || ['hp_pot', 'antidote', 'stimulant'];
    const tItems = player.items || {};
    const meta = { 'hp_pot': { icon: 'ğŸº', name: 'å†é€ ç½' }, 'potion': { icon: 'ğŸ§´', name: 'è—¥æ°´' }, 'antidote': { icon: 'ğŸ§ª', name: 'è§£æ¯’' }, 'hemostat': { icon: 'ğŸ©¹', name: 'æ­¢è¡€' }, 'stimulant': { icon: 'ğŸ’‰', name: 'èˆˆå¥®åŠ‘' }, 'none': { icon: 'ğŸš«', name: 'ç©º' } };
    
    const beltHTML = `
        <div id="tactical-loadout-belt-container" style="margin-top:25px; padding-top:20px; border-top:1px double rgba(255,255,255,0.1);">
            <div style="color: #3498db; font-size: 13px; margin-bottom: 12px; font-weight: bold; display: flex; align-items: center; gap: 8px;">
                <span>ğŸ’ æˆ°è¡“ç‰©è³‡æ›è¼‰ (Tactical Loadout)</span>
            </div>
            <div style="display: flex; gap: 10px; justify-content: space-around;">
                ${tSlots.map((id, i) => {
                    const info = meta[id] || meta['none'];
                    const count = tItems[id] || 0;
                    return `<div onclick="openTacticalLoadout()" style="flex:1; background:rgba(255,255,255,0.03); border:1.5px solid #444; border-radius:12px; padding:10px 5px; text-align:center; cursor:pointer;" onmouseover="this.style.borderColor='#3498db'" onmouseout="this.style.borderColor='#444'"><div style="font-size: 9px; color:#555; margin-bottom:4px;">SLOT ${i+1}</div><div style="font-size: 24px;">${info.icon}</div><div style="font-size: 10px; color:#aaa; margin-top:4px;">${info.name}</div>${count>0?`<div style="font-size:8px; color:#2ecc71;">x${count}</div>`:''}</div>`;
                }).join('')}
            </div>
            <p style="text-align:center; font-size:9px; color:#555; margin-top:10px;">é»æ“Šæ ¼å­ä»¥è‡ªå®šç¾©æ›´æ›ç‰©è³‡</p>
        </div>
        <div id="equip-selector-panel" class="equip-selector-overlay" style="display:none;"><div class="selector-header"><span id="selector-title">é¸æ“‡è£å‚™</span><button onclick="closeEquipSelector()">âœ•</button></div><div id="selector-list" class="item-grid"></div><button onclick="unequipCurrentSlot()" class="game-btn" style="width:100%; margin-top:10px; background:#c0392b; border-color:#e74c3c;">å¸ä¸‹è£å‚™</button></div>
    `;

    container.innerHTML = headerHTML + paperDollHTML + beltHTML;
}


/**
 * ğŸ“Š ç´ è³ªåˆ†é æ¸²æŸ“ (V5.9.39 é‡ç½®èˆ‡é¡¯ç¤ºå¢å¼·ç‰ˆ)
 */
function drawAttributesTabView(container, headerHTML) {
    const stats = calculateCombatStats(); // ç²å–å«åŸºåº•çš„æœ€çµ‚æ•¸å€¼
    const attr = player.attributes || { str: 0, sta: 0, agi: 0, int: 0 };
    const base = player.lv;

    container.innerHTML = headerHTML + `
        <div style="animation:fadeIn 0.3s ease;">
            <div style="background:rgba(52,152,219,0.1); border:1.5px solid #3498db; border-radius:16px; padding:15px; text-align:center; margin-bottom:20px;">
                <div style="font-size:10px; color:#3498db; letter-spacing:1px;">å¯ç”¨æˆé•·é»æ•¸ (REMAINING POINTS)</div>
                <div style="font-size:32px; font-weight:900; font-family:monospace; color:#fff;">${stats.remainingPoints}</div>
                <div style="font-size:9px; color:#666; margin-top:4px;">LV.${player.lv} (æ¯ç´š+3é» / å…¨å±¬æ€§åŸºåº•+${player.lv})</div>
            </div>

            <div style="display:flex; flex-direction:column; gap:10px; margin-bottom:25px;">
                ${['str', 'sta', 'agi', 'int'].map(k => {
                    const labelMap = {str:'åŠ›é‡ (STR)', sta:'é«”åŠ› (STA)', agi:'æ•æ· (AGI)', int:'æ™ºåŠ› (INT)'};
                    const colorMap = {str:'#e74c3c', sta:'#2ecc71', agi:'#f1c40f', int:'#9b59b6'};
                    
                    // ğŸ”¥ é¡¯ç¤ºé‚è¼¯ï¼šç¸½å€¼ (åŸºåº• + é…é»)
                    const added = attr[k] || 0;
                    const total = base + added;
                    
                    return `
                        <div style="display:flex; align-items:center; background:rgba(255,255,255,0.03); border:1px solid #333; border-radius:12px; padding:10px 15px;">
                            <b style="color:${colorMap[k]}; flex:1; font-size:13px;">${labelMap[k]}</b>
                            
                            <div style="text-align:right; margin-right:15px; font-family:monospace;">
                                <span style="font-size:16px; color:#fff; font-weight:bold;">${total}</span>
                                <span style="font-size:10px; color:#666;">(${base}+${added})</span>
                            </div>

                            <button onclick="window.addStatPoint('${k}')" style="width:32px; height:32px; border-radius:8px; border:none; background:#3498db; color:#fff; font-weight:bold; cursor:pointer; opacity:${stats.remainingPoints > 0 ? 1 : 0.3}; box-shadow:0 2px 5px rgba(0,0,0,0.3);">+</button>
                        </div>
                    `;
                }).join('')}
            </div>

            <div style="margin-top:25px; padding-top:20px; border-top:1px dashed #444;">
                <div style="color: #666; font-size: 11px; margin-bottom: 15px; letter-spacing: 2px;">å¯¦æ•ˆè½‰æ› (REAL-TIME EFFECTS)</div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    <div class="effect-card"><span>ç‰©ç†å‚·æ¸›</span><b>+${(stats.physResist * 100).toFixed(1)}%</b></div>
                    <div class="effect-card"><span>å®Œå…¨è¿´é¿</span><b>+${(stats.perfectDodge * 100).toFixed(1)}%</b></div>
                    <div class="effect-card"><span>ç•°å¸¸æŠµæŠ—</span><b>+${stats.specResist} pts</b></div>
                    <div class="effect-card"><span>ç¸½é«”é˜²ç¦¦</span><b>${Math.floor(stats.defPoints)} pts</b></div>
                </div>
            </div>

            <button onclick="window.resetAttributes()" style="width:100%; margin-top:25px; padding:12px; background:rgba(231, 76, 60, 0.1); border:1px solid #c0392b; color:#e74c3c; border-radius:8px; font-size:12px; cursor:pointer; font-weight:bold; transition:0.2s;" onmouseover="this.style.background='#c0392b'; this.style.color='#fff';" onmouseout="this.style.background='rgba(231, 76, 60, 0.1)'; this.style.color='#e74c3c';">
                ğŸ”„ é‡ç½®ç´ è³ª (5,000 G)
            </button>
            <div style="text-align:center; font-size:9px; color:#555; margin-top:5px;">* è²»ç”¨å°‡å…¨æ•¸ä¸Šç¹³åœ‹åº«</div>
        </div>
        <style>
            .effect-card { background:rgba(0,0,0,0.3); border-radius:8px; padding:10px; border-left:3px solid #3498db; display:flex; flex-direction:column; }
            .effect-card span { font-size:9px; color:#555; margin-bottom:4px; }
            .effect-card b { font-size:14px; color:#eee; font-family:monospace; }
        </style>
    `;
}


// è¼”åŠ©ï¼šåˆ¤æ–·ç‰©å“é¡å‹ (ä¿®æ­£å‰¯æ‰‹é‚è¼¯ï¼šæ”¯æ´ ç›¾ç‰Œ/å‰¯æ‰‹/æ­¦å™¨)
function isItemOfType(itemName, targetType) {
    const baseName = itemName.split(' (+')[0].trim();
    const data = MASTER_COLLECTION.find(m => baseName.includes(m.name) || m.name.includes(baseName));
    
    if (!data) return false;
    
    // æˆ’æŒ‡é€šé…
    if (targetType === 'ring') return data.type === 'ring';
    
    // ç¬¦æ–‡é€šé…
    if (targetType === 'rune') return data.type === 'rune';
    
    // å‰¯æ‰‹é‚è¼¯ï¼šå¯ä»¥æ˜¯ç›¾ç‰Œ(shield)ã€å‰¯æ‰‹(offhand)ï¼Œä¹Ÿå¯ä»¥æ˜¯æ­¦å™¨(weapon)åšé›™æŒ
    if (targetType === 'offhand') {
        return data.type === 'shield' || data.type === 'offhand' || data.type === 'weapon';
    }
    
    // åš´æ ¼æ¯”å° (é ­ã€èº«ã€æ‰‹ã€è…³ã€é …éŠç­‰)
    return data.type === targetType;
}

// =========================================
// âš”ï¸ è£å‚™é¸æ“‡å™¨äº¤äº’ (Selector Interaction)
// =========================================

// 3. é–‹å•Ÿè£å‚™é¸æ“‡å™¨ (UI å„ªåŒ–ç‰ˆ)
function openEquipSelector(slotId, overrideType = null) {
    currentEquipSlotId = slotId;
    
    // å¦‚æœæœ‰ overrideType (å¦‚ ring, rune)ï¼Œå°±ç”¨å®ƒï¼›å¦å‰‡ç›´æ¥ç”¨ slotId (å¦‚ head, body)
    currentEquipType = overrideType || slotId; 

    const panel = document.getElementById('equip-selector-panel');
    const list = document.getElementById('selector-list');
    const title = document.getElementById('selector-title');

    if (!panel || !list || !title) return;

    // å®šç¾©æ¨™é¡Œç¿»è­¯æ˜ å°„
    const typeNameMap = {
        'head': 'é ­éƒ¨',
        'body': 'ç›”ç”²',
        'legs': 'è¤²ç”²',
        'boots': 'é‹å­',
        'gloves': 'æ‰‹å¥—',
        'necklace': 'é …éŠ',
        'ring': 'æˆ’æŒ‡',
        'weapon': 'æ­¦å™¨',
        'offhand': 'å‰¯æ‰‹',
        'rune': 'ç¬¦æ–‡'
    };
    
    // è¨­å®šæ¨™é¡Œ (å¦‚æœæ‰¾ä¸åˆ°æ˜ å°„å°±é¡¯ç¤ºåŸæ–‡)
    const displayTitle = typeNameMap[currentEquipType] || currentEquipType;
    title.innerText = `æ›´æ›è£å‚™ï¼š${displayTitle}`;
    list.innerHTML = '';

    // ç¯©é¸èƒŒåŒ…ä¸­ç¬¦åˆé¡å‹çš„ç‰©å“
    const candidates = [];
    player.inventory.forEach((item, idx) => {
        // ä½¿ç”¨æˆ‘å€‘å‰›å‰›ä¿®æ­£éçš„ isItemOfType é€²è¡Œåˆ¤æ–·
        if (isItemOfType(item, currentEquipType)) {
            candidates.push({ item, idx });
        }
    });

    // æ¸²æŸ“å€™é¸åˆ—è¡¨
    if (candidates.length === 0) {
        list.innerHTML = `
            <div style="grid-column:1/-1; text-align:center; color:#888; padding:30px; font-size:12px;">
                èƒŒåŒ…è£¡æ²’æœ‰å¯ç”¨çš„ã€${displayTitle}ã€‘<br>
                <span style="font-size:10px; opacity:0.6;">å»æ‰“æ€ªæˆ–åˆæˆå¼„é»è£å‚™å§ï¼</span>
            </div>
        `;
    } else {
        list.innerHTML = candidates.map(c => {
            const parts = c.item.split(' ');
            const icon = parts[0];
            const name = parts.slice(1).join(' ');
            
            // ç°¡å–®åˆ¤æ–·ç¨€æœ‰åº¦çµ¦äºˆé‚Šæ¡†ç‰¹æ•ˆ (æå‡è³ªæ„Ÿ)
            const isRare = name.includes('ğŸ‘‘') || name.includes('ğŸ’€') || name.includes('ğŸ’') || name.includes('ğŸ”¥');
            const rareStyle = isRare ? 'border-color: #f1c40f; box-shadow: inset 0 0 8px rgba(241,196,15,0.2);' : '';

            return `
                <div class="inv-item-card" onclick="doEquip(${c.idx})" style="cursor:pointer; ${rareStyle}">
                    <div style="font-size:24px; margin-bottom:4px;">${icon}</div>
                    <div style="font-size:11px; line-height:1.2;">${name}</div>
                </div>
            `;
        }).join('');
    }

    panel.style.display = 'flex';
}

// 4. é—œé–‰è£å‚™é¸æ“‡å™¨
function closeEquipSelector() {
    const panel = document.getElementById('equip-selector-panel');
    if (panel) panel.style.display = 'none';
    
    // æ¸…é™¤ç‹€æ…‹ï¼Œé¿å…èª¤æ“ä½œ
    currentEquipSlotId = null;
    currentEquipType = null;
}


// =========================================
// âš”ï¸ è£å‚™æ“ä½œæ ¸å¿ƒ (Equip Actions)
// =========================================

// 4. åŸ·è¡Œè£å‚™ (é‚è¼¯é †åºå„ªåŒ–ç‰ˆ)
function doEquip(inventoryIdx) {
    // é˜²å‘†ï¼šå¦‚æœæ²’æœ‰é¸ä¸­æ§½ä½æˆ–ç´¢å¼•ç„¡æ•ˆ
    if (!currentEquipSlotId || inventoryIdx === null || inventoryIdx === undefined) return;

    // å–å¾—è¦è£å‚™çš„ç‰©å“ (æ–°) èˆ‡ æ§½ä½ä¸Šçš„ç‰©å“ (èˆŠ)
    const newItem = player.inventory[inventoryIdx];
    const oldItem = player.equips[currentEquipSlotId];

    if (!newItem) return; // å†æ¬¡ç¢ºèªç‰©å“å­˜åœ¨

    // ğŸ”¥ æ­¥é©Ÿ 1ï¼šå…ˆå¾èƒŒåŒ…ç§»é™¤æ–°è£å‚™ (é¿å…ç´¢å¼•è·‘æ‰)
    // æˆ‘å€‘å…ˆåŸ·è¡Œç§»é™¤ï¼Œé€™æ¨£å°±ä¸æœƒå—åˆ°å¾ŒçºŒ push æ“ä½œå½±éŸ¿é™£åˆ—é•·åº¦
    player.inventory.splice(inventoryIdx, 1);

    // ğŸ”¥ æ­¥é©Ÿ 2ï¼šå¦‚æœæœ‰èˆŠè£å‚™ï¼Œå°‡å…¶æ”¾å›èƒŒåŒ…
    if (oldItem) {
        player.inventory.push(oldItem);
    }

    // ğŸ”¥ æ­¥é©Ÿ 3ï¼šå°‡æ–°è£å‚™å¯«å…¥æ§½ä½
    player.equips[currentEquipSlotId] = newItem;

    // é¡¯ç¤ºé€šçŸ¥
    const displayName = newItem.split(' ')[0]; // åªé¡¯ç¤ºåœ–ç¤ºæˆ–ç°¡ç¨±
    showNotification(`âš”ï¸ å·²è£å‚™ï¼š${displayName}`);
    
    // æ­¥é©Ÿ 4ï¼šå­˜æª”èˆ‡åˆ·æ–°å…¨ä»‹é¢
    if (typeof savePlayerToDB === 'function') savePlayerToDB();
    
    // é‡æ–°æ¸²æŸ“è£å‚™ç›¤ (æ›´æ–°æ•¸å€¼)
    renderEquipmentUI();
    
    // é—œé–‰é¸æ“‡è¦–çª—
    closeEquipSelector();
    
    // åˆ·æ–°èƒŒåŒ… (å› ç‚ºç‰©å“è®Šå‹•äº†)
    refreshInventoryUI(); 
}

// 5. å¸ä¸‹ç•¶å‰è£å‚™
function unequipCurrentSlot() {
    if (!currentEquipSlotId) return;
    
    const item = player.equips[currentEquipSlotId];
    
    // åªæœ‰ç•¶æ§½ä½æœ‰æ±è¥¿æ™‚æ‰åŸ·è¡Œ
    if (item) {
        // 1. æ”¾å›èƒŒåŒ…
        player.inventory.push(item);
        
        // 2. æ¸…ç©ºæ§½ä½
        player.equips[currentEquipSlotId] = null;
        
        const displayName = item.split(' ')[0];
        showNotification(`ğŸ“¦ å·²å¸ä¸‹ï¼š${displayName}`);
        
        // 3. å­˜æª”èˆ‡åˆ·æ–°
        if (typeof savePlayerToDB === 'function') savePlayerToDB();
        renderEquipmentUI();
        refreshInventoryUI();
    }
    
    // ç„¡è«–æœ‰ç„¡å¸ä¸‹ï¼Œéƒ½é—œé–‰é¸æ“‡å™¨
    closeEquipSelector();
}


// =========================================
// âš”ï¸ ç‰©å“èˆ‡æ•¸å€¼è¼”åŠ©æ ¸å¿ƒ (Item & Stats Helper)
// =========================================

/**
 * è¼”åŠ©ï¼šåˆ¤æ–·ç‰©å“é¡å‹ (ä¿®æ­£ç‰ˆï¼šæ”¯æ´å‰¯æ‰‹èˆ‡å¤šæ§½ä½)
 * @param {string} itemName - ç‰©å“åç¨±
 * @param {string} targetSlotId - ç›®æ¨™æ§½ä½ ID (å¦‚ 'head', 'ring1', 'offhand') æˆ– é¡å‹ (å¦‚ 'ring')
 */
function isItemOfType(itemName, targetSlotId) {
    // 1. å–å¾—ç‰©å“åŸå§‹åç¨± (ç§»é™¤ç²¾ç…‰ç­‰ç´šå¾Œç¶´ (+n))
    const baseName = itemName.split(' (+')[0].trim();
    
    // 2. å¾è³‡æ–™åº«æŸ¥æ‰¾è©²ç‰©å“çš„å®šç¾©
    const data = MASTER_COLLECTION.find(m => baseName.includes(m.name) || m.name.includes(baseName));
    
    // å¦‚æœè³‡æ–™åº«æ²’é€™å€‹æ±è¥¿ï¼Œå°±ç„¡æ³•è£å‚™
    if (!data) return false;
    
    const type = data.type;

    // A. æˆ’æŒ‡æ§½ (ring1, ring2, æˆ–ç›´æ¥å‚³ ring) -> åªæ¥å— ring
    if (targetSlotId === 'ring1' || targetSlotId === 'ring2' || targetSlotId === 'ring') {
        return type === 'ring';
    }
    
    // B. å‰¯æ‰‹æ§½ (offhand) -> æ¥å— offhand, shield, æˆ– weapon (é›™æŒ)
    if (targetSlotId === 'offhand') {
        return type === 'offhand' || type === 'shield' || type === 'weapon';
    }
    
    // C. ç¬¦æ–‡æ§½ (rune1 ~ rune5, æˆ–ç›´æ¥å‚³ rune) -> åªæ¥å— rune
    if (targetSlotId.startsWith('rune') || targetSlotId === 'rune') {
        return type === 'rune';
    }

    // D. å…¶ä»–æ¨™æº–æ§½ä½ (head, body, legs, boots, gloves, necklace, weapon)
    // ç›´æ¥æ¯”å° type æ˜¯å¦ä¸€è‡´
    return type === targetSlotId;
}


// è¼”åŠ©ï¼šè§£æç²¾ç…‰ç­‰ç´š
function getRefineLv(name) {
    const match = name.match(/\(\+(\d+)\)/);
    return match ? parseInt(match[1]) : 0;
}


// =========================================
// ğŸ¯ è³é‡‘çµäººç³»çµ± (Bounty Hunter System)
// =========================================
const BountyManager = {
    timer: null,
    baseInterval: 45000,   // æ¯ 45 ç§’åˆ¤å®šä¸€æ¬¡
    chance: 0.4,           // 40% æ©Ÿç‡å‡ºç¾æ‡¸è³

    // å•Ÿå‹•ç³»çµ±
    init: function() {
        if (this.timer) clearInterval(this.timer);
        console.log("ğŸ“¡ æˆ°è¡“é›·é”å·²å•Ÿå‹•ï¼Œé–‹å§‹ç›£è½é »æ®µ...");
        // åˆå§‹å…ˆé‡ç½®ä¸€æ¬¡ï¼Œç¢ºä¿ç•«é¢æ­£ç¢º
        resetIntelRadar();
        this.timer = setInterval(() => this.scan(), this.baseInterval);
    },

    // æƒæé‚è¼¯
    scan: function() {
        // å¦‚æœç©å®¶æ­£åœ¨æˆ°é¬¥ã€åˆ‡æ›åœ°åœ–ï¼Œæˆ–å·²ç¶“æ‰‹å‹•é–å®šäº†ç›®æ¨™(æŒ‰éˆ•æ˜¯ç´…çš„)ï¼Œå‰‡ä¸æ‰“æ“¾
        const btn = document.getElementById('btn-intel-action');
        const isBusy = (typeof battleData !== 'undefined' && battleData.isBattleActive) || window.isBattleTransitioning;
        const isLocked = btn && !btn.disabled; 

        if (isBusy) return;

        // éš¨æ©Ÿåˆ¤å®š
        if (Math.random() < this.chance) {
            this.triggerBounty();
        } else {
            // å¦‚æœæ²’æƒåˆ°æ±è¥¿ï¼Œä¸”ç›®å‰æ²’æœ‰é–å®šç›®æ¨™ï¼Œç¢ºä¿é›·é”ä¿æŒåœ¨æƒæå‹•ç•«
            if (!isLocked) resetIntelRadar();
        }
    },

    // ğŸ”¥ è§¸ç™¼æ‡¸è³
    triggerBounty: function() {
        const diffs = ["N5", "N4", "N3", "N2", "N1"];
        // æ ¹æ“šç©å®¶ç­‰ç´šå‹•æ…‹æ±ºå®šé›£åº¦ï¼Œé¿å… LV1 é‡åˆ° N1
        const maxIndex = Math.min(4, Math.ceil((player.lv || 1) / 10));
        const targetDiff = diffs[Math.floor(Math.random() * (maxIndex + 1))] || "N5";
        
        // ç”Ÿæˆéš¨æ©Ÿé­”ç‰©åŒ… (å€Ÿç”¨ç”Ÿæˆå™¨)
        // éœ€ç¢ºä¿ generateDynamicExam å­˜åœ¨ï¼Œå¦å‰‡ç”¨éœæ…‹æ•¸æ“š
        let bountyPack = (typeof generateDynamicExam === 'function') 
            ? generateDynamicExam(targetDiff) 
            : { name: "ç¥ç§˜ä¿¡è™Ÿ", difficulty: targetDiff };
        
        // åŠ å·¥ç‚ºæ‡¸è³å–®
        bountyPack.name = `ğŸ¯ [æ‡¸è³] ${bountyPack.name.replace(/ğŸ‘¾|ğŸ‘¹|ğŸ‰|ğŸ‘»/g, '').trim()}`;
        bountyPack.isBounty = true; // é‡è¦æ¨™è¨˜
        bountyPack.appearance = "ğŸ‘º"; // æ‡¸è³æ€ªçµ±ä¸€å¤–è§€æˆ–éš¨æ©Ÿ

        // æ‡¸è³å¿…æ‰çå‹µ (ç¯„ä¾‹ï¼šç”Ÿå‘½ä¹‹æœ æˆ– è£å‚™)
        bountyPack.loots = [{ id: "misc_apple", chance: 1.0 }]; 

        // è¦–è¦ºé€šçŸ¥
        if(typeof showNotification === 'function') {
            showNotification(`ğŸš¨ åµæ¸¬åˆ°é«˜èƒ½åæ‡‰ï¼æ‡¸è³é­”ç‰©ã€${targetDiff}ã€‘å‡ºç¾ï¼`);
        }
        
        // å¼·åˆ¶æ›´æ–°é¢æ¿ (é€™æœƒè§¸ç™¼ç´…å…‰ç‰¹æ•ˆ)
        updateIntelPanel(bountyPack);
    }
};

/**
 * ğŸ“¡ ç‰©ç†å­ç¨‹åºï¼šé‡ç½®é›·é”ç‚ºã€Œæƒæä¸­ã€ç‹€æ…‹ (å¾…æ©Ÿæ¨¡å¼)
 */
function resetIntelRadar() {
    // æ¸…é™¤é–å®šç›®æ¨™
    window.currentActivePack = null;
    
    const els = {
        sprite: document.getElementById('intel-sprite'),
        name: document.getElementById('intel-name'),
        diff: document.getElementById('intel-diff'),
        element: document.getElementById('intel-element'),
        hp: document.getElementById('intel-hp'),
        loots: document.getElementById('intel-loots'),
        btn: document.getElementById('btn-intel-action'),
        scanLine: document.getElementById('radar-scan-line'),
        panel: document.getElementById('intel-panel')
    };

    if (!els.panel) return;

    // æ¢å¾©å¾…æ©Ÿè¦–è¦º
    if (els.sprite) {
        els.sprite.innerText = "ğŸ“¡";
        els.sprite.style.filter = "grayscale(1) opacity(0.5)";
    }
    
    if (els.name) {
        els.name.innerText = "æ­£åœ¨æœå°‹ä¿¡è™Ÿ...";
        els.name.style.color = "#999";
    }
    
    if (els.diff) {
        els.diff.innerText = "SCANNING";
        els.diff.style.background = "#555";
    }
    
    if (els.element) {
        els.element.innerText = "ä¿¡è™Ÿå¾®å¼±";
        els.element.style.color = "#999";
    }
    
    if (els.hp) {
        els.hp.innerText = "HP: --";
        els.hp.style.color = "#999";
    }
    
    if (els.loots) {
        els.loots.innerHTML = "<span style='font-size:10px; color:#bbb;'>[ ç­‰å¾…ç›®æ¨™é–å®š ]</span>";
    }
    
    // ç¦ç”¨æŒ‰éˆ•
    if (els.btn) {
        els.btn.disabled = true;
        els.btn.innerText = "âš ï¸ å°šæœªé–å®šç›®æ¨™";
        els.btn.style.background = "#95a5a6";
        els.btn.style.cursor = "not-allowed";
        els.btn.onclick = null; 
    }

    // æ¢å¾©æƒæç·šèˆ‡ç§»é™¤è­¦å ±
    if (els.scanLine) els.scanLine.style.display = "block";
    els.panel.style.animation = "none";
    els.panel.style.borderColor = "var(--nhk-green)";
}


/**
 * ğŸ› ï¸ è¬ç”¨é¸å–®æ§åˆ¶ï¼šç‰©ç†åŠ å›ºã€æ»¾å‹•æ¬Šé™å›æ”¶èˆ‡è¦–åœ–å°æ­£ç‰ˆ (æ•´åˆåœ°åœ–æ¸²æŸ“)
 * ä¿®æ­£ï¼š
 * 1. åŒ…å« 'log' æ˜ å°„ä¿®æ­£ã€‚
 * 2. ğŸ”¥ æ•´åˆ 'map' æ˜ å°„èˆ‡æ¸²æŸ“ï¼Œè§£æ±ºåœ°åœ–åˆ—è¡¨ç©ºç™½å•é¡Œã€‚
 * 3. æ»¾å‹•æ¢ç‰©ç†é–å®šèˆ‡å›å½ˆã€‚
 */
function toggleMenu(menuKey) {
    console.log(`%cğŸ–±ï¸ åŸ·è¡Œé¸å–®æŒ‡ä»¤: [${menuKey}]`, "color: #00a0e9; font-weight: bold;");

    const menuMapping = {
        'equipment': 'equipment-popup',      // è£å‚™è¦–çª—
        'inventory': 'inventory-popup',      // èƒŒåŒ…è¦–çª—
        'collection': 'collection-popup',    // åœ–é‘‘è¦–çª—
        'alchemy': 'alchemy-popup',          // éŠé‡‘è¦–çª—
        'map': 'adventure-map-popup',        // ğŸ”¥ åœ°åœ–è¦–çª— (é—œéµä¿®å¾©)
        'adventure-map': 'adventure-map-popup', 
        'adventure-log': 'adventure-log-popup', // æ—¥èªŒè¦–çª—
        'log': 'adventure-log-popup'         // Header æ—¥èªŒæŒ‰éˆ•æ˜ å°„
    };

    const targetId = menuMapping[menuKey];
    const targetEl = document.getElementById(targetId);
    
    // ç‰©ç†é˜²ç¦¦ï¼šå¦‚æœæ‰¾ä¸åˆ° IDï¼Œå›å ±éŒ¯èª¤ä¸¦ä¸­æ­¢
    if (!targetEl) {
        console.error(`âŒ ç‰©ç†æ–·è£‚ï¼šæ‰¾ä¸åˆ°ç›®æ¨™å…ƒä»¶ ID [${targetId}] (Key: ${menuKey})`);
        return;
    }

    // å–å¾—ç•¶å‰çœŸå¯¦é¡¯ç¤ºç‹€æ…‹
    const currentStyle = window.getComputedStyle(targetEl).display;
    const isOpening = (currentStyle === 'none');

    // 1. ğŸ”¥ ã€å…¨åŸŸç‰©ç†æ¸…ç†ã€‘
    // é—œé–‰æ‰€æœ‰é–‹å•Ÿä¸­çš„å½ˆçª—
    Object.values(menuMapping).forEach(id => {
        const el = document.getElementById(id);
        if (el) el.style.display = 'none';
    });
    // æ¢å¾© body æ²è»¸æ¬Šé™
    document.body.style.overflow = 'auto'; 

    // 2. ğŸ”¥ ã€ç‰©ç†é–å®šèˆ‡ç²¾ç¢ºæ¸²æŸ“ã€‘
    if (isOpening) {
        // é¡¯ç¤ºå½ˆçª— (ä½¿ç”¨ flex å°é½Šæ–° CSS çµæ§‹)
        targetEl.style.display = 'flex'; 
        
        // ğŸ”’ ç‰©ç†é–å®šï¼šç¦æ­¢ä¸»é é¢åœ¨å½ˆçª—é–‹å•Ÿæ™‚æ²å‹•
        document.body.style.overflow = 'hidden'; 
        
        console.log(`âœ… åº§æ¨™å®šä½æˆåŠŸï¼š${targetId}`);

        try {
            // --- åŸ·è¡Œå„æ¨¡çµ„å°ˆå±¬æ¸²æŸ“éˆ ---
            
            // ğŸ”¥ è£å‚™ç³»çµ±æ¸²æŸ“
            if (menuKey === 'equipment' && typeof renderEquipmentUI === 'function') {
                renderEquipmentUI();
            }

            // èƒŒåŒ…åˆ†é¡æ¸²æŸ“
            if (menuKey === 'inventory' && typeof refreshInventoryUI === 'function') {
                refreshInventoryUI();
            }

            // å‚³èªªåœ–é‘‘æ¸²æŸ“
            if (menuKey === 'collection' && typeof renderCollection === 'function') {
                renderCollection();
            }

            // éŠé‡‘çˆä»‹é¢é‡ç½®
            if (menuKey === 'alchemy' && typeof refreshAlchemyUI === 'function') {
                if (typeof switchAlchemyTab === 'function') {
                    if (typeof currentAlchemyTab !== 'undefined' && currentAlchemyTab === 'refine') {
                         if (typeof refreshRefineList === 'function') refreshRefineList();
                    } else {
                         refreshAlchemyUI();
                    }
                } else {
                    refreshAlchemyUI();
                }
            }

            // ğŸ”¥ å†’éšªåœ°åœ– (é—œéµä¿®å¾©é»)
            // ç¢ºä¿æ‰“é–‹åœ°åœ–æ™‚ï¼ŒæŒ‰éˆ•åˆ—è¡¨æœƒè¢«æ¸²æŸ“å‡ºä¾†
            if ((menuKey === 'map' || menuKey === 'adventure-map') && typeof renderAdventureMap === 'function') {
                renderAdventureMap();
            }

            // å†’éšªæ—¥èªŒ
            if ((menuKey === 'adventure-log' || menuKey === 'log') && typeof renderAdventureLog === 'function') {
                renderAdventureLog();
            }

            // ğŸš€ ã€è¦–åœ–å°æ­£ã€‘ç‰©ç†å›å½ˆè‡³é ‚ç«¯
            // å˜—è©¦æŠ“å–æ‰€æœ‰å¯èƒ½çš„æ²å‹•å®¹å™¨ class
            const scrollArea = targetEl.querySelector('.popup-content-scroll') || 
                               targetEl.querySelector('.map-content') || 
                               targetEl.querySelector('.inventory-scroll-area') ||
                               targetEl.querySelector('#log-list'); 
            if (scrollArea) {
                scrollArea.scrollTop = 0;
            }

        } catch (e) {
            console.error(`ğŸš¨ [ç‰©ç†æ•…éšœ] æ¸²æŸ“éˆä¸­æ–· [${menuKey}]:`, e);
        }
    } else {
        console.log(`ğŸ”Œ ç‰©ç†åˆ‡æ–·ï¼š[${menuKey}] å·²é—œé–‰`);
    }
}

/**
 * ğŸƒ ç‰©ç†å­ç¨‹åºï¼šæ´—ç‰Œèˆ‡ç‰Œçµ„åˆå§‹åŒ– (å®Œå…¨å°æ­£ç‰ˆ)
 * åŒ…å«é¬¼ç‰Œæ³¨å…¥ã€Fisher-Yates æ·±åº¦æ´—ç‰Œèˆ‡ Power æ¬Šé‡æ ¡æº–
 */
function initPokerDeck() {
    const suits = ['â™£', 'â™¦', 'â™¥', 'â™ ']; // ç‰©ç†èŠ±è‰²ï¼šæ¢…èŠ±ã€æ–¹å¡Šã€ç´…å¿ƒã€é»‘æ¡ƒ
    const values = ['3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K', 'A', '2'];
    pokerGame.deck = [];
    pokerGame.playedCards = []; // ğŸ”¥ ç‰©ç†é‡ç½®è¨˜ç‰Œå›æ”¶æ¡¶
    
    // 1. ç”Ÿæˆ 52 å¼µæ¨™æº–ç‰Œ
    suits.forEach((s, sIdx) => {
        values.forEach((v, vIdx) => {
            pokerGame.deck.push({ 
                suit: s, 
                value: v, 
                // ç‰©ç† Powerï¼š3=0, 2=120ã€‚åŠ ä¸ŠèŠ±è‰²åç§» (0~3) ç¢ºä¿å”¯ä¸€æ€§
                power: vIdx * 10 + sIdx, 
                label: s + v 
            });
        });
    });

    // 2. ğŸ”¥ ã€ç‰©ç†æ ¸å¿ƒã€‘æ³¨å…¥ 2 å¼µåŸºç¤é¬¼ç‰Œ (JOKER)
    // é¬¼ç‰Œ Power è¨­ç‚º 150/151ï¼Œç‰©ç†ç¢¾å£“é»‘æ¡ƒ 2 (123)
    pokerGame.deck.push({ suit: 'ğŸƒ', value: 'JOKER', power: 150, label: 'JOKER', type: 'standard' });
    pokerGame.deck.push({ suit: 'ğŸƒ', value: 'JOKER', power: 151, label: 'JOKER', type: 'standard' });

    // 3. ğŸ”¥ ã€ç‰©ç†æ´—ç‰Œï¼šFisher-Yates æ¼”ç®—æ³•ã€‘
    // æ¨æ£„ä¸ç©©å®šçš„ sort éš¨æ©Ÿï¼Œæ”¹ç”¨æ¨™æº–ç‰©ç†æ´—ç‰Œæ¼”ç®—æ³•åŸ·è¡Œ 3 æ¬¡
    for (let round = 0; round < 3; round++) {
        for (let i = pokerGame.deck.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [pokerGame.deck[i], pokerGame.deck[j]] = [pokerGame.deck[j], pokerGame.deck[i]];
        }
    }

    console.log(`%cğŸ”€ ç‰Œçµ„å·²ç‰©ç†é‡ç”Ÿï¼šå…±è¨ˆ ${pokerGame.deck.length} å¼µå¡ç‰‡ (å« 2 å¼µé¬¼ç‰Œ)`, "color: #2ecc71; font-weight: bold;");
    addBattleLog("ğŸ”€ ç‰Œçµ„å·²å®Œæˆæ·±åº¦ç‰©ç†æ´—ç‰Œã€‚");
}

// --- ğŸ©¸ ç‰©ç†æ ¸å¿ƒï¼šéšç´šæ›ç‰Œæ©Ÿåˆ¶ (å„ªåŒ–ï¼šå¼·è€…æ å¥ªèˆ‡ç²¾æº–å›è´ˆ) ---
function performRankExchange() {
    if (pokerGame.isFirstRound) {
        console.log("ğŸš© é¦–å±€å°æˆ°ï¼šå…å¾µç¨…ã€‚");
        return;
    }

    // 1. ç‰©ç†å®šä½ï¼šç²å–å„éšç´šå°è±¡
    const king = pokerGame.players.find(p => p.rank === "king");
    const noble = pokerGame.players.find(p => p.rank === "noble");
    const citizen = pokerGame.players.find(p => p.rank === "citizen");
    const slave = pokerGame.players.find(p => p.rank === "slave");

    if (!king || !noble || !citizen || !slave) {
        console.error("âŒ éšç´šæ•¸æ“šä¸å®Œæ•´ï¼Œç„¡æ³•åŸ·è¡Œæ›ç‰Œã€‚");
        return;
    }

    console.log("âš–ï¸ éšç´šç¤¾æœƒçš„ç‰©ç†è¦å‰‡å•Ÿå‹•ï¼šé–‹å§‹åŸ·è¡Œå¾µç¨…èˆ‡åˆ†é…...");

    // 2. ğŸ”¥ ã€ç‰©ç†æ ¸å¿ƒä¿®æ­£ï¼šåŒæ™‚äº¤æ›é˜²æ­¢å¼·ç‰Œé€£è·³ã€‘
    // è¦å‰‡ï¼šå¤§è´å®¶(King)æ›2å¼µã€æ¬¡è´å®¶(Noble)æ›1å¼µ
    
    // --- ğŸ‘‘ åœ‹ç‹ vs å¥´éš¸ (äº¤æ› 2 å¼µ) ---
    executePhysicalSwap(king, slave, 2);

    // --- ğŸ’ è²´æ— vs å¹³æ°‘ (äº¤æ› 1 å¼µ) ---
    executePhysicalSwap(noble, citizen, 1);

    // 3. ç‰©ç†é‡æ•´ï¼šæ›ç‰Œå¾Œæ‰€æœ‰äººçš„æ‰‹ç‰Œå¿…é ˆé‡æ–°æ’åº
    pokerGame.players.forEach(p => {
        p.cards.sort((a, b) => a.power - b.power);
    });

    showNotification("ğŸ’‰ éšç´šå¾µç¨…å®Œç•¢ï¼šå¼·è€…å¥ªå–äº†å„ªå‹¢ï¼Œå¼±è€…å¤±å»äº†æœªä¾†ã€‚");
}

/**
 * ç‰©ç†åŸ·è¡Œäº¤æ›é‚è¼¯
 * @param {Object} stronger å¼·è€… (King/Noble)
 * @param {Object} weaker   å¼±è€… (Slave/Citizen)
 * @param {number} count    äº¤æ›å¼µæ•¸
 */
function executePhysicalSwap(stronger, weaker, count) {
    // A. å¼±è€…æº–å‚™ï¼šç‰©ç†æ‰¾å‡ºæ‰‹ä¸­æœ€å¼·çš„ç‰Œ (Power ç”±å¤§åˆ°å°æ’)
    weaker.cards.sort((a, b) => b.power - a.power);
    const taxCards = weaker.cards.splice(0, count);

    // B. å¼·è€…æº–å‚™ï¼šç‰©ç†æ‰¾å‡ºæ‰‹ä¸­æœ€å¼±çš„ç‰Œ (Power ç”±å°åˆ°å¤§æ’)
    stronger.cards.sort((a, b) => a.power - b.power);
    const giftCards = stronger.cards.splice(0, count);

    // C. ç‰©ç†è½‰ç§»æ•¸æ“š
    stronger.cards.push(...taxCards);
    weaker.cards.push(...giftCards);

    console.log(`ğŸ“¡ [ç‰©æµç›£æ§] ${stronger.name} å¥ªå–äº† ${taxCards.map(c=>c.label).join(', ')}`);
    console.log(`ğŸ“¡ [ç‰©æµç›£æ§] ${weaker.name} ç²å¾—äº†å¼·è€…çš„æ–½æ¨: ${giftCards.map(c=>c.label).join(', ')}`);
}

/**
 * ğŸ“‰ ç‰©ç†æ¸²æŸ“ï¼šå´é‚Šæ¬„è‚¡å¸‚å¿«è¨Š (é˜²ç¦¦åŠ å›ºç‰ˆ)
 * ä¿®æ­£ï¼š
 * 1. ç‰©ç†æ””æˆªï¼šåŠ å…¥ history å­˜åœ¨æ€§èˆ‡é•·åº¦æª¢æŸ¥ï¼Œè§£æ±º length-2 å´©æ½°ã€‚
 * 2. æ•¸æ“šå°é½Šï¼šç¢ºä¿åœ¨å¸‚å ´å‰›é–‹ç›¤ï¼ˆæ•¸æ“šå°‘æ–¼2ç­†ï¼‰æ™‚ä»èƒ½é¡¯ç¤ºç•¶å‰è‚¡åƒ¹ã€‚
 * 3. ç©©å®šæ€§åŠ å›ºï¼šéæ¿¾ undefined æˆ– null è‚¡ç¥¨ç‰©ä»¶ã€‚
 */
function renderStockTicker() {
    // 0. ğŸ”¥ ã€æ•¸æ“šéˆè·¯å®‰å…¨æª¢æŸ¥ã€‘
    if (!window.kingdomStocks || !Array.isArray(window.kingdomStocks)) return '';

    // 1. ğŸ”¥ ã€ç‰©ç†å®‰å…¨éæ¿¾èˆ‡æ’åºã€‘
    // æˆ‘å€‘åªæŒ‘é¸å‡ºå…·å‚™ history æ•¸æ“šçš„è‚¡ç¥¨ï¼Œä¸¦ä»¥çµ•å°æ³¢å¹…æ’åº
    const hotStocks = [...window.kingdomStocks]
        .filter(s => s && s.history && Array.isArray(s.history)) 
        .sort((a, b) => {
            const aHist = a.history;
            const bHist = b.history;
            
            // ç‰©ç†è¨ˆç®—æ³¢å¹… (è‹¥æ­·å²ä¸è¶³ 2 ç­†ï¼Œæ³¢å¹…è¦–ç‚º 0)
            const aPrev = aHist.length >= 2 ? aHist[aHist.length - 2] : a.price;
            const bPrev = bHist.length >= 2 ? bHist[bHist.length - 2] : b.price;
            
            const aDiff = Math.abs(a.price - aPrev);
            const bDiff = Math.abs(b.price - bPrev);
            
            return bDiff - aDiff; // ç”±å¤§åˆ°å°æ’
        })
        .slice(0, 3);

    // 2. ğŸ›¡ï¸ ã€ç©ºå€¼ä¿åº•ã€‘è‹¥å¸‚å ´å‰›å•Ÿå‹•å°šç„¡æ³¢å‹•ï¼Œå‰‡å–å‰ä¸‰æ”¯é è¨­è‚¡ç¥¨é¡¯ç¤º
    const displayList = hotStocks.length > 0 ? hotStocks : window.kingdomStocks.slice(0, 3);

    return `
        <div id="stock-market-ticker" style="background:rgba(0,0,0,0.8); border:1px solid #444; border-radius:8px; padding:8px; margin-top:10px; font-family:monospace;">
            <div style="color:#888; font-size:9px; margin-bottom:5px; letter-spacing:1px;">ğŸ“Š MARKET_LIVE_TICKER</div>
            ${displayList.map(s => {
                if (!s) return '';
                
                // ç‰©ç†è¨ˆç®—æ¼²è·Œ
                const hist = s.history || [];
                const lastPrice = (hist.length >= 2) ? hist[hist.length - 2] : s.price;
                const diff = s.price - lastPrice;
                const color = diff >= 0 ? '#2ecc71' : '#e74c3c';
                const sign = diff >= 0 ? 'â–²' : 'â–¼';
                
                return `
                    <div style="display:flex; justify-content:space-between; font-size:10px; margin-bottom:3px;">
                        <span style="color:#eee;">${s.id}</span>
                        <span style="color:${color};">${sign} $${s.price}</span>
                    </div>
                `;
            }).join('')}
            <button onclick="showFinancialCenter()" style="width:100%; background:none; border:1px solid #555; color:#aaa; font-size:9px; margin-top:5px; cursor:pointer; border-radius:3px;">é€²å…¥äº¤æ˜“æ‰€</button>
        </div>
    `;
}

/**
 * ğŸ›ï¸ ç‰©ç†æ¸²æŸ“ï¼šç‹åœ‹é‡‘èä¸­å¿ƒ (åŒæ­¥åŠ å›ºç‰ˆ)
 */
async function showFinancialCenter() {
    // 0. ğŸ”¥ ã€ç‰©ç†åŒæ­¥é–ã€‘é–‹å•Ÿå‰å¼·åˆ¶æª¢ç´¢æœ€æ–°è¨­æ–½èˆ‡è‚¡å¸‚å­˜æª”
    await ensureKingdomSystem();
    
    const existing = document.getElementById('financial-modal');
    if (existing) existing.remove();

    const modal = document.createElement('div');
    modal.id = 'financial-modal';
    // ... æ¨£å¼ä¿æŒä¸è®Š ...
    modal.style = `position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); width:500px; height:600px; background:rgba(10,10,10,0.98); border:2px solid #f1c40f; z-index:200000; border-radius:15px; color:#eee; font-family:monospace; display:flex; flex-direction:column; box-shadow:0 0 100px #000; backdrop-filter:blur(20px);`;

    modal.innerHTML = `
        <div style="padding:20px; border-bottom:1px solid #333; display:flex; justify-content:space-between; align-items:center;">
            <b style="color:#f1c40f; font-size:20px; letter-spacing:3px;">ğŸ›ï¸ ç‹åœ‹é‡‘èä¸­å¿ƒ</b>
            <div id="fin-header-stats" style="text-align:right;">
                <div style="font-size:12px; color:#fff;">ç¾é‡‘: $${player.coin.toLocaleString()} G</div>
                <div style="font-size:10px; color:#888;">åœ‹åº«å„²å‚™: $${window.kingdomSystem.treasury.toLocaleString()} G</div>
            </div>
        </div>
        
        <div style="display:flex; flex:1; overflow:hidden;">
            <div style="width:120px; border-right:1px solid #333; display:flex; flex-direction:column;">
                <button onclick="switchFinTab('infra')" style="flex:1; background:none; color:#f1c40f; border:none; border-bottom:1px solid #222; cursor:pointer; font-weight:bold;">ğŸ—ï¸ åŸºç¤è¨­æ–½</button>
                <button onclick="switchFinTab('stocks')" style="flex:1; background:none; color:#f1c40f; border:none; cursor:pointer; font-weight:bold;">ğŸ“ˆ è­‰åˆ¸äº¤æ˜“</button>
            </div>
            <div id="fin-content-area" style="flex:1; padding:15px; overflow-y:auto; background:rgba(255,255,255,0.02);">
                </div>
        </div>
        
        <button onclick="this.parentElement.remove()" style="width:100%; padding:15px; background:#222; color:#666; border:none; border-top:1px solid #333; cursor:pointer; font-weight:bold;">ç‰©ç†æ€§é›¢é–‹ä¸­å¿ƒ [ESC]</button>
    `;

    document.body.appendChild(modal);
    switchFinTab('infra'); 
}


/**
 * ğŸ”„ ç‰©ç†åˆ‡æ›ï¼šé‡‘èä¸­å¿ƒåˆ†é é‚è¼¯ (V5.9.2 è·äººæ”¶å°¾ç‰ˆ)
 * ä¿®æ­£é»ï¼š
 * 1. è¦–è¦ºé–å®šï¼šå‹•æ…‹åˆ‡æ›æŒ‰éˆ•é«˜äº®èˆ‡å³å´æŒ‡ç¤ºæ¢ã€‚
 * 2. èªç¾©è£œå®Œï¼šæ•´åˆåŸºç¤è¨­æ–½ç‰©ç†æè¿°ï¼Œæ¶ˆé™¤è³‡è¨Šæ–·å±¤ã€‚ [cite: 2026-02-06]
 * 3. è‚¡å¸‚é€£å‹•ï¼šç‰©ç†èª¿åº¦ renderStockContent è™•ç†å¤§å‹æ•¸æ“šã€‚
 */
function switchFinTab(tab) {
    const area = document.getElementById('fin-content-area');
    if (!area) return;

    // 1. ğŸ”¥ ã€èªç¾©èªªæ˜ç‡ƒæ–™åŒ…ã€‘å®šç¾©å„è¨­æ–½å°ç‹åœ‹ç³»çµ±çš„ç‰©ç†å½±éŸ¿ [cite: 2026-02-06]
    const upgradeManifest = {
        vault: { name: "ä¸­å¤®é‡‘åº«", desc: "æ“´å¼µç‰©ç†å„²é‡ä¸Šé™ï¼Œæå‡çµç®—å¾Œçš„è¤‡åˆ©ç”Ÿæˆä¿‚æ•¸ã€‚" },
        mint: { name: "çš‡å®¶é€ å¹£å» ", desc: "å„ªåŒ–é€ å¹£æµç¨‹ï¼Œæ°¸ä¹…æå‡è´å®¶å½©é‡‘æ± çš„åŸºç¤æº¢åƒ¹ã€‚" },
        intelligence: { name: "åœ°ä¸‹æƒ…å ±å±€", desc: "ä½ˆå»ºæƒ…å ±ç¶²ï¼Œç‰©ç†æå‡ç¨€æœ‰éºç‰©æ‰è½ç‡èˆ‡åˆ†æåŠ›ã€‚" },
        trade: { name: "è¡€ç›Ÿè²¿æ˜“ç«™", desc: "å»ºç«‹ç‰©æµéˆï¼Œé™ä½äº¤æ˜“æ‰€æº¢åƒ¹ä¸¦è§£é–è·¨å€ç¨€æœ‰ç‰©è³‡ã€‚" },
        arena: { name: "å¤§ç«¶æŠ€å ´", desc: "æ“´å¼µå½±éŸ¿åŠ›ï¼Œæå‡ç‹‚æš´æ©Ÿç‡èˆ‡åœ‹ç‹é€£å‹æ”¶ç›ŠåŠ æˆã€‚" }
    };

    // A. ç‰©ç†è¦–è¦ºï¼šåˆ‡æ›å·¦å´æŒ‰éˆ•çš„é«˜äº®ç‹€æ…‹èˆ‡æŒ‡ç¤ºæ¢
    const tabs = document.querySelectorAll('#financial-modal button[onclick*="switchFinTab"]');
    tabs.forEach(btn => {
        if (btn.getAttribute('onclick').includes(tab)) {
            btn.style.background = "rgba(241,196,15,0.15)";
            btn.style.color = "#f1c40f";
            btn.style.borderRight = "3px solid #f1c40f"; // ç‰©ç†é«˜äº®ï¼šå³å´æŒ‡ç¤ºæ¢
        } else {
            btn.style.background = "none";
            btn.style.color = "#888";
            btn.style.borderRight = "none";
        }
    });

    // B. ç‰©ç†æ¸…æ´—ï¼šå¼·åˆ¶æ¸…ç©ºå…§å®¹å€åŸŸï¼Œé˜²æ­¢ DOM æ®˜ç•™
    area.innerHTML = '';

    // C. å…§å®¹åˆ†æµæ¸²æŸ“
    if (tab === 'infra') {
        // --- ğŸ—ï¸ åŸºç¤è¨­æ–½åˆ†é  ---
        const sys = window.kingdomSystem;
        if (!sys || !sys.upgrades) return;

        area.innerHTML = Object.keys(sys.upgrades).map(k => {
            const up = sys.upgrades[k];
            const info = upgradeManifest[k] || { name: up.name, desc: "ç‹åœ‹æ©Ÿå¯†è¨­æ–½ã€‚" };
            // é€²åº¦æ¢ç‰©ç†è¨ˆç®—
            const percent = Math.min(100, (up.lv / 10)).toFixed(1); 
            
            return `
            <div style="background:rgba(255,255,255,0.03); padding:15px; margin-bottom:12px; border-radius:12px; border:1px solid #333; transition:0.2s;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                    <div>
                        <b style="color:#f1c40f; font-size:15px; letter-spacing:1px;">${info.name}</b>
                        <span style="color:#666; font-size:11px; margin-left:8px; background:rgba(0,0,0,0.3); padding:2px 6px; border-radius:4px;">LV.${up.lv}</span>
                    </div>
                    <button onclick="manualInvest('${k}')" style="background:#f1c40f; color:#000; border:none; padding:6px 14px; border-radius:6px; font-weight:900; cursor:pointer; font-size:11px; box-shadow:0 4px 10px rgba(241,196,15,0.2);">æŠ•è³‡ $5k</button>
                </div>
                
                <div style="font-size:12px; color:#aaa; line-height:1.5; font-style:italic; border-left:2px solid #444; padding-left:12px; margin-bottom:10px;">
                    ${info.desc}
                </div>

                <div style="width:100%; height:5px; background:#111; border-radius:3px; overflow:hidden; border:1px solid #222;">
                    <div style="width:${percent}%; height:100%; background:linear-gradient(90deg, #b7950b, #f1c40f); box-shadow: 0 0 8px rgba(241,196,15,0.5);"></div>
                </div>
            </div>`;
        }).join('');
        
    } else if (tab === 'stocks') {
        // --- ğŸ“ˆ è­‰åˆ¸äº¤æ˜“åˆ†é  ---
        // ç‰©ç†æŒ‡ä»¤ï¼šå‘¼å«å°ˆå±¬æ¸²æŸ“å‡½æ•¸è™•ç†å¤§å‹è‚¡å¸‚æ•¸æ“š
        if (typeof renderStockContent === 'function') {
            renderStockContent();
        } else {
            area.innerHTML = `
                <div style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%; color:#555;">
                    <div style="font-size:40px; margin-bottom:10px;">ğŸ“ˆ</div>
                    <div style="font-size:14px; letter-spacing:2px;">è‚¡å¸‚å¼•æ“é»ç«ä¸­...</div>
                </div>`;
        }
    }
}


function exchangeCards(stronger, weaker) {
    // ç‰©ç†è¡Œç‚ºï¼šå¼·è€…å¾å¼±è€…æ‰‹ä¸­æŠ½èµ°æœ€å¼·çš„ç‰Œ
    weaker.cards.sort((a, b) => b.power - a.power);
    const takenCard = weaker.cards.shift();
    
    // å¼·è€…å›è´ˆè‡ªå·±æœ€å¼±çš„ç‰Œ
    stronger.cards.sort((a, b) => a.power - b.power);
    const giveBackCard = stronger.cards.shift();
    
    stronger.cards.push(takenCard);
    weaker.cards.push(giveBackCard);
}

function findFirstTurn() {
    let firstPlayerIdx = -1;
    
    pokerGame.players.forEach((p, idx) => {
        // ç‰©ç†æª¢æŸ¥ï¼šèª°æŒæœ‰æ¢…èŠ± 3 (â™£3)
        const hasClub3 = p.cards.some(c => c.label === 'â™£3');
        if (hasClub3) {
            firstPlayerIdx = idx;
        }
    });

    if (firstPlayerIdx === -1) {
        console.error("âŒ éŒ¯èª¤ï¼šç‰Œçµ„ä¸­æ‰¾ä¸åˆ°æ¢…èŠ± 3ï¼");
        return;
    }

    pokerGame.turn = firstPlayerIdx;
    pokerGame.isFirstRound = true; // æ¨™è¨˜ç‚ºé–‹å±€ç¬¬ä¸€æ‰‹
    pokerGame.lastMovePattern = null; // ç¢ºä¿æ²’æœ‰èˆŠç‰Œçµ„æ®˜ç•™
    pokerGame.passCount = 0;

    const firstPlayer = pokerGame.players[firstPlayerIdx];
    
    if (firstPlayer.id === 'player') {
        showNotification("ğŸš© ä½ æŒæœ‰ã€æ¢…èŠ± 3ã€‘ï¼Œè«‹ç”±ä½ é–‹å§‹ç¬¬ä¸€æ‰‹ï¼");
        renderPokerTable(document.getElementById('poker-table'));
    } else {
        showNotification(`ğŸš© ã€${firstPlayer.name}ã€‘æŒæœ‰æ¢…èŠ± 3ï¼Œé–‹å§‹é–‹å±€...`);
        // ğŸ”¥ ç‰©ç†è§¸ç™¼ AI å‡ºç‰Œï¼Œä¸¦ç¢ºä¿å®ƒç¬¬ä¸€æ‰‹å¿…å«æ¢…èŠ± 3
        setTimeout(() => aiPlayTurn(firstPlayerIdx), 1500);
    }
}

function playCard(cardIdx) {
    const player = pokerGame.players.find(p => p.id === 'player');
    const selectedCard = player.cards[cardIdx];

    // 1. ç‰©ç†é¦–å±€é™åˆ¶ï¼šå¦‚æœæ˜¯ç¬¬ä¸€æ‰‹ï¼Œå¿…é ˆåŒ…å«æ¢…èŠ±3
    if (pokerGame.isFirstRound && pokerGame.currentTable.length === 0) {
        if (selectedCard.label !== 'â™£3') {
            showNotification("âŒ ç¬¬ä¸€æ‰‹å¿…é ˆå‡ºã€æ¢…èŠ± 3ã€‘ï¼");
            return;
        }
    }

    // 2. ç‰©ç†ç§»å‡ºæ‰‹ç‰Œä¸¦æ”¾åˆ°æ¡Œé¢
    pokerGame.currentTable = [selectedCard];
    player.cards.splice(cardIdx, 1);

    // 3. æ›´æ–° UI
    renderPokerTable(document.getElementById('poker-table'));
    document.getElementById('table-center').innerHTML = `
        <div style="font-size:40px; background:white; color:black; padding:10px; border-radius:8px;">
            ${selectedCard.label}
        </div>
    `;

    // 4. åˆ‡æ›å›åˆçµ¦ä¸‹ä¸€å€‹ AI
    pokerGame.isFirstRound = false;
    pokerGame.turn = (pokerGame.turn + 1) % 4;
    
    // å‘¼å« AI é‹ä½œ
    setTimeout(() => aiPlayTurn(pokerGame.turn), 1500);
}

/**
 * ğŸ¤– AI è‡ªå‹•å°æˆ°ç¸½æ§ï¼šæ¨¡çµ„åŒ–èª¿åº¦å¼•æ“
 */
function aiPlayTurn(playerIdx) {
    // 0. ğŸ”¥ ã€ç‰©ç†åˆ¶å‹•èˆ‡å®‰å…¨å®ˆè¡›ã€‘
    if (window.isGameEnding || !pokerGame.gameActive || pokerGame.turn !== playerIdx) {
        if (window.pokerAITimer) clearTimeout(window.pokerAITimer);
        return;
    }

    const ai = pokerGame.players[playerIdx];
    if (ai.id === 'player') return; 

    // 1. ğŸ”¥ ã€çµ‚å±€åµæ¸¬ã€‘
    if (pokerGame.players.some(p => p.cards.length === 0)) {
        return finishPokerGame(pokerGame.players.find(p => p.cards.length === 0));
    }

    // 2. ğŸ”¥ ã€å‰ç½®æ””æˆªèˆ‡ç‰¹æ®Šæ±ºç­–ã€‘ (è–æ—¨/è¡€ç›Ÿ/é¸ç‰Œ)
    if (executePreTurnIntercepts(playerIdx, ai)) return;

    // 3. ğŸ¯ ã€ç­–ç•¥é¸ç‰Œã€‘
    const move = decideAIMove(ai);

    // 4. ğŸŸ¢ ã€åŸ·è¡Œå‹•ä½œã€‘
    if (move) {
        executeAIAction(playerIdx, ai, move);
    } else {
        executeAIPass(playerIdx, ai);
    }
}

/**
 * ğŸ›¡ï¸ ç‰©ç†å­ç¨‹åºï¼šè™•ç†å›åˆå‰ç½®æ””æˆª (è–æ—¨/è¡€ç›Ÿ)
 */
function executePreTurnIntercepts(idx, ai) {
    // A. è–æ—¨æ””æˆª
    if (pokerGame.nextAiMustPass) {
        pokerGame.nextAiMustPass = false; 
        ai.isPassed = true;
        pokerGame.passCount++;
        triggerAISpeech(idx, { text: "åœ‹ç‹çš„è©”ä»¤ï¼Ÿï¼æˆ‘...æˆ‘ç„¡æ³•å‹•å½ˆ...", vfx: "shake" });
        addBattleLog(`ğŸ“œ <b style="color:#e74c3c;">[è–æ—¨]</b> ${ai.name} è¢«è¿«ç¦è¨€æ£„æ¬Šï¼`);
        finalizeAITurn();
        return true;
    }

    // B. è¡€ç›Ÿåˆä½œæ ¡æº–
    const isBerserk = !!pokerGame.isBerserkKingActive;
    const lastActor = pokerGame.players.find(p => p.name === pokerGame.lastPlayerName);
    if (pokerGame.isKingSiege && ai.rank !== 'king' && lastActor && lastActor.rank !== 'king' && lastActor.id !== ai.id) {
        const coopChance = isBerserk ? 1.0 : 0.85;
        if (Math.random() < coopChance) {
            ai.isPassed = true;
            pokerGame.passCount++;
            addBattleLog(`ğŸ›¡ï¸ <b style="color:#9b59b6;">[è¡€ç›Ÿå…±é³´]</b> ${ai.name} èª“æ­»ç‚ºåŒå¿—å®ˆä½ç™¼çƒæ¬Šã€‚`);
            triggerAISpeech(idx, getAIRankTalk(ai.rank, 'pass'));
            finalizeAITurn();
            return true;
        }
    }
    return false;
}

/**
 * ğŸ¯ ç‰©ç†å­ç¨‹åºï¼šæ±ºå®š AI å‡ºç‰Œçµ„åˆ
 */
function decideAIMove(ai) {
    const isStarter = (!pokerGame.lastMovePattern || pokerGame.lastPlayerName === "NONE");
    let move = null;

    if (isStarter) {
        if (pokerGame.isFirstRound) {
            const club3 = ai.cards.find(c => c.value === '3' && c.suit === 'â™£');
            if (club3) {
                const combos = (typeof POKER_AI.getAllPossible5CardCombos === 'function') ? 
                                POKER_AI.getAllPossible5CardCombos(ai.cards, null) : [];
                move = combos.find(c => c.some(card => card.label === 'â™£3')) || [club3];
                addBattleLog(`ğŸš© <b style="color:#2ecc71;">[æ³•å¾‹ç¾©å‹™]</b> ${ai.name} å±¥è¡Œç¾©å‹™é–‹å±€ã€‚`);
            }
        } else {
            move = POKER_AI.findMove(ai.cards, null);
        }
        if (!move && ai.cards.length > 0) move = [ai.cards[0]];
    } else {
        move = POKER_AI.findMove(ai.cards, pokerGame.lastMovePattern);
    }
    return move;
}

/**
 * ğŸŸ¢ ç‰©ç†å­ç¨‹åºï¼šåŸ·è¡Œ AI å‡ºç‰Œå‹•ä½œ (å«å‚·å®³èˆ‡è‚¡å¸‚é€£å‹•ç‰ˆ)
 * ä¿®æ­£ï¼š
 * 1. å‚·å®³æ›è¼‰ï¼šå‘¼å« applyCardBattleDamage è®“ AI çš„ç‰Œå…·æœ‰ç‰©ç†æ®ºå‚·åŠ›ã€‚
 * 2. ç¶“æ¿ŸåŒæ­¥ï¼šå‘¼å« updateStockMarket è®“ AI è¡Œå‹•ä¹Ÿèƒ½å½±éŸ¿è‚¡åƒ¹ã€‚
 * 3. è¦–è¦ºè¡æ“Šï¼šç‚¸å½ˆç‰Œå‹è§¸ç™¼ç•«é¢éœ‡å‹•ã€‚
 */
function executeAIAction(idx, ai, move) {
    // 0. ğŸ”¥ ã€ç‰©ç†é‘‘å®šã€‘
    const movePattern = POKER_AI.getPattern(move);
    
    // 1. ğŸ”¥ ã€ç‰©ç†æ•¸æ“šå¯«å…¥ï¼šç‹€æ…‹è®Šæ›´ã€‘
    pokerGame.playedCards = (pokerGame.playedCards || []).concat(move);
    ai.cards = ai.cards.filter(c => !move.includes(c));
    ai.lastMove = [...move]; // ç‰©ç†éš”é›¢å¼•ç”¨
    ai.isPassed = false;
    
    // 2. ğŸ”¥ ã€æˆ°å ´åƒæ•¸é–å®šã€‘
    pokerGame.lastMovePattern = movePattern;
    pokerGame.lastMoveCards = [...move];
    pokerGame.lastPlayerName = ai.name;
    pokerGame.passCount = 0;
    pokerGame.isFirstRound = false; 

    // å…¨å“¡ç‰©ç†å–šé†’ (é™¤äº†ç•¶å‰å‡ºç‰Œè€…)
    pokerGame.players.forEach(p => { if (p.id !== ai.id) p.isPassed = false; });
    
    addBattleLog(`ğŸ¤– <b>${ai.name}</b> ç¥­å‡ºäº†ï¼š${move.map(c => c.label).join(', ')}`);

    // =========================================
    // ğŸ”¥ğŸ”¥ğŸ”¥ 2.5 ã€ç‰©ç†å‚·å®³èˆ‡ç’°å¢ƒé€£å‹•ã€‘ (æ–°å¢) ğŸ”¥ğŸ”¥ğŸ”¥
    // =========================================
    
    // A. é€ æˆç‰©ç†å‚·å®³ (æ‰“äºº)
    if (typeof applyCardBattleDamage === 'function') {
        applyCardBattleDamage(ai, move);
    }

    // B. å½±éŸ¿è‚¡å¸‚æ³¢å‹• (ç¶“æ¿Ÿ)
    if (typeof updateStockMarket === 'function') {
        updateStockMarket();
    }

    // C. ç‚¸å½ˆè¦–è¦ºè¡æ“Š (éœ‡å‹•)
    if (movePattern.type === 'bomb') {
        const table = document.getElementById('poker-table');
        if (table) {
            table.style.animation = "dqShake 0.4s ease-in-out";
            setTimeout(() => table.style.animation = "", 400);
        }
    }
    // =========================================

    // 3. ğŸ”¥ ã€ç‰©ç†ç ´å£é‚è¼¯åŸ·è¡Œã€‘(ç‹‚æš´åœ‹ç‹å°ˆå±¬)
    if (!!pokerGame.isBerserkKingActive && ai.rank === 'king') {
        if (typeof applyBerserkDestruction === 'function') {
            applyBerserkDestruction(); 
        }
    }

    // 4. ğŸ”¥ ã€å°è©±æ•¸æ“šæå–ã€‘
    // é—œéµï¼šåœ¨ DOM é‡ç¹ªå‰å…ˆæ±ºå®šå¥½è¦èªªçš„è©±
    const talkData = getAIRankTalk(ai.rank, 'play');

    // 5. ğŸ”¥ ã€çµ‚å±€æˆ–ç§»äº¤ã€‘
    if (ai.cards.length === 0) {
        // è‹¥ AI ç²å‹ï¼Œç«‹å³é€²å…¥çµç®—ä»‹é¢
        return finishPokerGame(ai); 
    }

    // 6. ğŸ”¥ ã€æ¬ŠåŠ›ç§»äº¤é»ç«ã€‘
    // ç‰©ç†éŠœæ¥ï¼šå‚³å…¥ç•¶å‰ç´¢å¼•èˆ‡é è¼‰çš„åŠ‡æœ¬å…§å®¹
    if (typeof finalizeAITurn === 'function') {
        finalizeAITurn(idx, talkData);
    } else {
        console.error("âŒ ç‰©ç†æ–·è£‚ï¼šæ‰¾ä¸åˆ° finalizeAITurn å­ç¨‹åº");
    }
}


/**
 * ğŸ”´ ç‰©ç†å­ç¨‹åºï¼šåŸ·è¡Œæ£„æ¬Š (Pass) èˆ‡ç’°å¢ƒèªéŸ³é»ç«
 * ä¿®æ­£ï¼š
 * 1. åŠ‡æœ¬é é–å®šï¼šåœ¨ DOM é‡ç¹ªå‰å…ˆæå– getAIRankTalk å°è©ã€‚
 * 2. éˆè·¯åˆ†æ”¯ï¼šå€åˆ†ã€Œå…¨å“¡ Pass æ·¨ç©ºã€èˆ‡ã€Œå–®äºº Pass ç§»äº¤ã€çš„ç‰©ç†åŸ·è¡Œè·¯å¾‘ã€‚
 * 3. ç©©å®šæ›è¼‰ï¼šç¢ºä¿ Pass å°è©åœ¨æˆ°å ´ç‹€æ…‹æ›´æ–°å¾Œä»èƒ½ç‰©ç†é¡¯ç¾ã€‚
 */
function executeAIPass(idx, ai) {
    // 1. ğŸ”¥ ã€æ•¸æ“šå¯«å…¥ã€‘è®Šæ›´ç©å®¶ç‹€æ…‹
    ai.isPassed = true;
    pokerGame.passCount++;
    addBattleLog(`ğŸ§¤ ${ai.name} é¸æ“‡äº†æ£„æ¬Š (Pass)`);
    
    // 2. ğŸ”¥ ã€åŠ‡æœ¬æå–ã€‘æ ¹æ“šç’°å¢ƒåˆ¤å®šå°è© (Berserk/Siege/Normal)
    const talkData = getAIRankTalk(ai.rank, 'pass');

    // 3. ğŸ”¥ ã€è·¯å¾‘åˆ†æµåˆ¤å®šã€‘
    if (pokerGame.passCount >= 3) {
        // --- A åˆ†æµï¼šå…¨å“¡ Passï¼Œæˆ°å ´ç‰©ç†æ·¨åŒ– ---
        // å…ˆå™´å‡ºæ£„æ¬Šå°è©±ï¼Œå†åŸ·è¡Œæ·¨ç©º
        if (typeof triggerAISpeech === 'function') {
            triggerAISpeech(idx, talkData);
        }
        
        // å»¶é²åŸ·è¡Œæ·¨ç©ºï¼Œçµ¦ç©å®¶çœ‹ä¸€çœ¼ AI æ£„æ¬Šçš„å°è©èˆ‡è¡¨æƒ…
        setTimeout(() => {
            if (typeof resetTableForNewLead === 'function') {
                resetTableForNewLead();
            }
        }, 800); 

    } else {
        // --- B åˆ†æµï¼šå›åˆæ¬ŠåŠ›ç§»äº¤ ---
        // ç‰©ç†éŠœæ¥ï¼šå‚³éå°è©±æ•¸æ“šï¼Œè®“æŒ‡é‡æ§åˆ¶é‡ç¹ªå¾Œçš„æ›è¼‰
        if (typeof finalizeAITurn === 'function') {
            finalizeAITurn(idx, talkData);
        } else {
            console.error("âŒ ç‰©ç†æ–·è£‚ï¼šæ‰¾ä¸åˆ° finalizeAITurn å­ç¨‹åº");
            // å‚™æ´æ–¹æ¡ˆ
            renderPokerTable(document.getElementById('poker-table'));
            proceedToNextTurn();
        }
    }
}


/**
 * â™»ï¸ ç‰©ç†å­ç¨‹åºï¼šç§»äº¤å›åˆæ¬ŠåŠ›èˆ‡ç¯€å¥èª¿æ§
 * ä¿®æ­£ï¼š
 * 1. ç‰©ç†éè¿´ï¼šè‡ªå‹•åµæ¸¬ä¸¦è·³éå·²æ£„æ¬Šç©å®¶ï¼Œç›´åˆ°è§¸ç™¼å…¨å“¡ Pass æ·¨ç©ºæˆ–æ‰¾åˆ°åˆæ³•è¡Œå‹•è€…ã€‚
 * 2. æ¨¡å¼é©é…ï¼šæ ¹æ“šç‹‚æš´åœ‹ç‹ç‹€æ…‹ï¼Œç‰©ç†ç¸®æ¸› AI è¡Œå‹•å»¶é²ã€‚
 * 3. ç‹€æ…‹åŒæ­¥ï¼šç•¶æ¬ŠåŠ›ç§»äº¤å›å‹‡è€…æ™‚ï¼Œå¼·åˆ¶è§¸ç™¼ UI é‡ç¹ªä»¥å•Ÿå‹• ACT/PASS æŒ‰éˆ•ã€‚
 */
function proceedToNextTurn() {
    // 0. ğŸ”¥ ã€ç‰©ç†åˆ¶å‹•ã€‘å®‰å…¨æª¢æŸ¥
    if (!pokerGame.gameActive || window.isGameEnding) {
        if (window.pokerAITimer) clearTimeout(window.pokerAITimer);
        return;
    }
    
    // 1. ğŸ”¥ ã€ç‰©ç†ä½ç§»ã€‘å›åˆæŒ‡é‡å¾ªç’°ç§»ä½ (0->1->2->3->0)
    pokerGame.turn = (pokerGame.turn + 1) % 4;
    const nextPlayer = pokerGame.players[pokerGame.turn];
    
    // ç‰©ç†æ¸…ç†èˆŠæœ‰çš„è¡Œå‹•è¨ˆæ™‚å™¨
    if (window.pokerAITimer) clearTimeout(window.pokerAITimer);

    // 2. ğŸ”¥ ã€åˆ†æµåŸ·è¡Œã€‘å‹‡è€…ç«¯ vs AI ç«¯
    if (nextPlayer.id === 'player') {
        // --- ğŸ‘¤ å‹‡è€…å›åˆé»ç« ---
        // ç‰©ç†å¼·åˆ¶é‡ç¹ªï¼Œç¢ºä¿ç©å®¶æ‰‹ç‰Œèˆ‡åŠŸèƒ½æŒ‰éˆ•è™•æ–¼å¯äº’å‹•ç‹€æ…‹
        const table = document.getElementById('poker-table');
        if (table) renderPokerTable(table);
        
        showNotification(pokerGame.isBerserkKingActive ? 
            "ğŸ’€ <b style='color:#ff4d4d;'>ç‹‚æš´å¨å£“æŒçºŒä¸­</b>ï¼Œè¼ªåˆ°ä½ äº†ï¼" : "ğŸ‘‰ è¼ªåˆ°ä½ äº†");
            
    } else {
        // --- ğŸ¤– AI å›åˆé»ç« ---
        // ç‰©ç†ç¯€å¥æ¼”ç®—ï¼šç‹‚æš´æœŸé–“ 0.6sï¼Œä¸€èˆ¬æœŸé–“ 1.5s
        const delay = !!pokerGame.isBerserkKingActive ? 600 : 1500;
        
        window.pokerAITimer = setTimeout(() => {
            // ç‰©ç†åµæ¸¬ï¼šè‹¥è©² AI å·²ç¶“ Pass ä¸”æœªé”å…¨å“¡æ·¨ç©ºé–€æª» (3æ¬¡)ï¼Œå‰‡ç¹¼çºŒéè¿´æŸ¥æ‰¾
            if (nextPlayer.isPassed && pokerGame.passCount < 3) {
                console.log(`ğŸ“¡ ç‰©ç†è·³éå·²æ£„æ¬Šè€…ï¼š${nextPlayer.name}`);
                proceedToNextTurn(); 
            } else {
                // é€²å…¥ AI æ±ºç­–éˆ
                if (typeof aiPlayTurn === 'function') {
                    aiPlayTurn(pokerGame.turn);
                } else {
                    console.error("âŒ è‡´å‘½ç¼ºå¤±ï¼šæ‰¾ä¸åˆ° aiPlayTurn å¼•æ“ï¼");
                }
            }
        }, delay);
    }
}

/**
 * â™»ï¸ ç‰©ç†å­ç¨‹åºï¼šå®Œæˆå›åˆã€é‡ç¹ªæˆ°å ´èˆ‡åŸ·è¡Œæ°£æ³¡æ›è¼‰
 * ä¿®æ­£ï¼š
 * 1. åŠ‡æœ¬å°é½Šï¼šæ¥æ”¶ talkData åƒæ•¸ï¼Œç¢ºä¿ AI è¡Œå‹•èˆ‡å°è©ç‰©ç†åŒæ­¥ã€‚
 * 2. æ¸²æŸ“å±éšœï¼šè§£æ±º renderPokerTable æœƒéŠ·æ¯€èˆŠæ°£æ³¡çš„å•é¡Œï¼ŒåŸ·è¡Œå»¶é²é»ç«ã€‚
 * 3. é‚è¼¯å°æ­£ï¼šç¢ºä¿ proceedToNextTurn åœ¨ç©©å®šçš„ç‹€æ…‹ä¸‹è¢«è§¸ç™¼ã€‚
 */
function finalizeAITurn(playerIdx, talkData) {
    // 1. ğŸ”¥ ã€ç¶“æ¿Ÿé€£å‹•ã€‘
    if (typeof updateStockMarket === 'function') updateStockMarket();
    
    // 2. ğŸ”¥ ã€ç‰©ç†é‡ç¹ªã€‘
    // æ ¸å¿ƒå‹•ä½œï¼šé€™æœƒæ¸…ç©ºèˆŠçš„æ‰€æœ‰ DOM ç¯€é»ï¼ŒåŒ…æ‹¬æ­£åœ¨é¡¯ç¤ºçš„ bubble
    const tableContainer = document.getElementById('poker-table');
    if (tableContainer) {
        renderPokerTable(tableContainer);
    }
    
    // 3. ğŸ”¥ ã€å°è©±é»ç«ï¼šå»¶é²è£œå„Ÿæ©Ÿåˆ¶ã€‘
    // ç‚ºä»€éº¼è¦å»¶é²ï¼Ÿå› ç‚º renderPokerTable åŸ·è¡Œå®Œå¾Œçš„ä¸‹ä¸€å¹€ï¼Œæ–° DOM æ‰çœŸæ­£ç‰©ç†å¯ç”¨ã€‚
    if (talkData && playerIdx !== undefined) {
        setTimeout(() => {
            if (typeof triggerAISpeech === 'function') {
                // åœ¨æ–°ç”Ÿæˆçš„å®¹å™¨ä¸Šç‰©ç†æ›è¼‰å°è©±
                triggerAISpeech(playerIdx, talkData);
            }
        }, 80); // ç‰©ç†ç·©è¡ 80msï¼Œå®Œç¾é¿é–‹æ¸²æŸ“è¡çª
    }
    
    // 4. ğŸ”¥ ã€æ¬ŠåŠ›ç§»äº¤ã€‘
    // èª¿ç”¨æˆ‘å€‘å…ˆå‰ä¿®æ­£è£œå…¨çš„æŒ‡é‡å‡½æ•¸
    if (typeof proceedToNextTurn === 'function') {
        proceedToNextTurn();
    } else {
        console.warn("âš ï¸ ç‰©ç†è­¦å‘Šï¼šæœªåµæ¸¬åˆ° proceedToNextTurn æŒ‡é‡ï¼ŒAI æµç¨‹å¯èƒ½ä¸­æ–·ã€‚");
    }
}


/**
 * ğŸ”¨ ç‰©ç†ç ´å£ï¼šç‹‚æš´åœ‹ç‹æ¯€æ»…å¼•æ“
 * åŸ·è¡Œæ–¼ï¼šç‹‚æš´åœ‹ç‹æ¯æ¬¡æˆåŠŸå‡ºç‰Œæ™‚
 */
function applyBerserkDestruction() {
    if (!pokerGame.isBerserkKingActive) return;

    const sys = window.kingdomSystem;
    const stocks = window.kingdomStocks;
    
    console.log("%cğŸŒ‹ [ç‹‚æš´å¨å£“] æ­£åœ¨åŸ·è¡Œç‰©ç†ç ´å£ç¨‹åº...", "color: #ff0000; font-weight: bold;");

    // --- a. åŸºç¤å»ºè¨­ç ´å£ (0.1% - 0.5% ç­‰ç´šè¡°é€€) ---
    let infraLossMsg = "";
    Object.keys(sys.upgrades).forEach(key => {
        const up = sys.upgrades[key];
        if (up.lv > 0) {
            // ç‰©ç†è¡°é€€ç‡ï¼š0.001 ~ 0.005
            const decayRate = (Math.random() * 0.4 + 0.1) / 100;
            const lvLoss = Math.ceil(up.lv * decayRate);
            up.lv = Math.max(0, up.lv - lvLoss);
            if (lvLoss > 0) infraLossMsg += `${up.name}-Lv.${lvLoss} `;
        }
    });

    // --- b. è‚¡å¸‚éœ‡ç›ª (å…¨ç›¤ 1% - 5% éš¨æ©Ÿé‡æŒ«) ---
    stocks.forEach(s => {
        const crashRate = 1 - (Math.random() * 0.04 + 0.01);
        const oldPrice = s.price;
        s.price = Math.max(1, Math.floor(s.price * crashRate));
        s.lastChange = s.price - oldPrice;
        
        // ç‰©ç†ç´€éŒ„æ­·å²è»Œè·¡ (Kç·šæœƒå‡ºç¾è·³ç©ºç¼ºå£)
        if (s.history) {
            s.history.push(s.price);
            if (s.history.length > 20) s.history.shift();
        }
    });

    // --- c. åœ‹åº«è³‡é‡‘è’¸ç™¼ (0.1% - 2% ç‰©ç†æå¤±) ---
    const treasuryDecay = (Math.random() * 0.019 + 0.001);
    const goldLoss = Math.floor(sys.treasury * treasuryDecay);
    sys.treasury = Math.max(0, sys.treasury - goldLoss);

    // --- ğŸ“¢ æˆ°è¡“æ—¥èªŒèˆ‡è¦–è¦ºå›é¥‹ ---
    addBattleLog(`ğŸ’€ <b style="color:#ff4d4d;">[æ¯€æ»…]</b> ç‹‚æš´åœ‹ç‹çš„å’†å“®å°è‡´ï¼š${infraLossMsg}`);
    addBattleLog(`ğŸ“‰ è‚¡å¸‚å…¨ç›¤é‡æŒ«ï¼åœ‹åº«å› æ··äº‚æå¤±äº† <b style="color:#ff4d4d;">$${goldLoss.toLocaleString()}G</b>`);

    // è§¸ç™¼ç•«é¢ä¸Šæ–¹ K ç·šèˆ‡çœ‹æ¿çš„ç‰©ç†é‡ç¹ª
    if (typeof renderStockContent === 'function') renderStockContent();
    
    // ç‰©ç†éœ‡æ’¼ï¼šå¼·çƒˆéœ‡å‹•
    const table = document.getElementById('poker-table');
    if (table) {
        table.classList.add('cheat-shatter-active');
        setTimeout(() => table.classList.remove('cheat-shatter-active'), 500);
    }
}


/**
 * ğŸ’¬ è¼”åŠ©å‡½æ•¸ï¼šç’°å¢ƒæ„ŸçŸ¥å‹èªéŸ³ä¸­æ¨
 * é‚è¼¯é †ä½ï¼šç‹‚æš´åœ‹ç‹ > åœ‹ç‹åŒ…åœç¶² > ç¥çš‡å¨å£“ > ä¸€èˆ¬æƒ…å¢ƒ
 */
function getAIRankTalk(rank, type) {
    const isBerserk = !!pokerGame.isBerserkKingActive;
    const isSiege = !!pokerGame.isKingSiege;
    const isKing = (rank === 'king');
    const hero = pokerGame.players.find(p => p.id === 'player');
    const heroStreak = player.kingStreak || 0;

    // --- ğŸ‘¹ 1. ã€ç‰©ç†æ¨¡å¼ï¼šç‹‚æš´åœ‹ç‹ç¾èº«ã€‘(æœ€é«˜å„ªå…ˆ) ---
    if (isBerserk) {
        if (isKing) {
            // ç‹‚æš´åœ‹ç‹ç™¼è¨€ï¼šæ¯€æ»…èˆ‡éäººæ„Ÿ
            const berserkPool = [
                { text: "ã€Œå‡¡äººï¼Œè¦‹è­‰ä¸–ç•Œç‰©ç†æ€§çš„å´©å¡Œå§ï¼ã€", vfx: "glitch" },
                { text: "ã€Œé€™åº§ç‹åœ‹ï¼Œå°‡éš¨æœ•ä¸€åŒæ²‰å…¥è™›ç©º...ã€", vfx: "glitch" },
                { text: "ã€Œé¡«æŠ–å§... æ¯€æ»…çš„é½’è¼ªå·²ç¶“è½‰å‹•ã€‚ã€", vfx: "shake" },
                { text: "ã€Œä½ å€‘çš„æ™æ‰ï¼Œä¸éæ˜¯è™›ç©ºä¸­çš„å›éŸ¿ã€‚ã€", vfx: "glitch" }
            ];
            return berserkPool[Math.floor(Math.random() * berserkPool.length)];
        } else {
            // ç›Ÿè»/å¹³æ°‘é¢å°ç‹‚æš´åœ‹ç‹çš„ææ‡¼
            const terrorPool = [
                { text: "ã€Œé‚£...é‚£æ˜¯åœ‹ç‹é™›ä¸‹å—ï¼Ÿä¸ï¼Œé‚£æ˜¯æ€ªç‰©...ã€", vfx: "shake" },
                { text: "ã€Œæ•‘å‘½... ç©ºé–“æ­£åœ¨ç‰©ç†ç¢è£‚...ã€", vfx: "shake" },
                { text: "ã€Œå‹‡è€…...è«‹å¿«é»çµæŸé€™å ´å™©å¤¢...ã€", vfx: "pulse" },
                { text: "ã€Œç†æ™ºæ­£åœ¨æ¶ˆå¤±... èª°ä¾†æ•‘æ•‘æˆ‘å€‘ï¼Ÿã€", vfx: "shake" }
            ];
            return terrorPool[Math.floor(Math.random() * terrorPool.length)];
        }
    }

    // --- âš–ï¸ 2. ã€ç‰©ç†æ¨¡å¼ï¼šåœ‹ç‹åŒ…åœç¶²æˆç«‹ã€‘ ---
    if (isSiege) {
        if (isKing) {
            // åœ‹ç‹åœ¨åŒ…åœç¶²ä¸‹çš„åæ‡‰ï¼šæ†¤æ€’ã€å›°ç¸ä¹‹é¬¥
            const kingSiegePool = [
                { text: "ã€Œé›†çµäº†è»èŸ»å°±æƒ³æŒ‘æˆ°ç‹æ¬Šï¼Ÿç‰©ç†æ€§çš„æ„šè ¢ï¼ã€", vfx: "pulse" },
                { text: "ã€Œé€™å ´åŒ…åœç¶²ï¼Œåªæ˜¯æœ•çš„åˆ‘å ´ç½·äº†ã€‚ã€", vfx: "pop" },
                { text: "ã€ŒèƒŒå›è€…ï¼Œæœ•æœƒè¦ªè‡ªé€ä½ å€‘å…¥åœ°ç„ã€‚ã€", vfx: "shake" },
                { text: "ã€Œæœ•çš„çµ±æ²»ä¸å¯æ’¼å‹•ï¼Œçˆ¾ç­‰çš†ç‚ºæ­»å›šï¼ã€", vfx: "pulse" }
            ];
            return kingSiegePool[Math.floor(Math.random() * kingSiegePool.length)];
        } else {
            // åæŠ—è»(ç›Ÿè»)çš„é©å‘½å°è©±
            const rebelPool = [
                { text: "ã€Œæš—å½±ä¸­çš„åŒå¿—ï¼Œé€™æ˜¯ç‰©ç†æ€§çš„è‡´å‘½ä¸€æ“Šï¼ã€", vfx: "pulse" },
                { text: "ã€Œç‚ºäº†æ¨ç¿»æš´æ”¿ï¼Œæˆ‘ç”˜é¡˜ç»å‡ºä¸€åˆ‡ï¼ã€", vfx: "pop" },
                { text: "ã€Œæš´å›ï¼Œä½ çš„é€£èŠåˆ°æ­¤ç‚ºæ­¢äº†ï¼ã€", vfx: "shake" },
                { text: "ã€Œé€™å±€ç”±è¡€ç›Ÿæ‰¿æ¥ï¼Œå‹‡è€…ï¼Œæˆ‘å€‘ç‚ºä½ é–‹è·¯ï¼ã€", vfx: "none" }
            ];
            const pool = (type === 'play') ? rebelPool : [
                { text: "ã€Œé€™ä¸€æ‰‹äº¤çµ¦åŒå¿—äº†ï¼Œæˆ‘æš«ä¸”æŒ‰å…µä¸å‹•ã€‚ã€", vfx: "none" },
                { text: "ã€Œç­‰å¾…è¡€ç›Ÿçš„é›†çµ... ä¸‹ä¸€æ“Šå°‡æ˜¯è‡´å‘½çš„ã€‚ã€", vfx: "none" }
            ];
            return pool[Math.floor(Math.random() * pool.length)];
        }
    }

    // --- ğŸ©¸ 3. ã€ç‰©ç†æ¨¡å¼ï¼šç¥çš‡å¨å£“ã€‘(é€£èŠ >= 50) ---
    if (hero.rank === 'king' && heroStreak >= 50 && !isKing) {
        const fearPool = [
            { text: "é‚£...é‚£æ˜¯ç¥çš„å…‰èŠ’å—ï¼Ÿæˆ‘ç«Ÿç„¶ç„¡æ³•ç›´è¦–é™›ä¸‹...", vfx: "shake" },
            { text: "åœ¨ç™¾ä»£ç¥çš‡é¢å‰ï¼Œç‰Œçµ„çš„æ„ç¾©å·²ç¶“ç‰©ç†æ€§æ¶ˆå¤±äº†ã€‚", vfx: "glitch" },
            { text: "æ±‚æ‚¨æ”¶æ‰‹å§...é€™å·²ç¶“ä¸æ˜¯è³­åšï¼Œæ˜¯ç¥è¹Ÿçš„é™è‡¨ã€‚", vfx: "none" },
            { text: "é™›ä¸‹ï¼Œè«‹é ˜æ”¶æˆ‘çš„éˆé­‚ï¼Œé€™å±€æˆ‘å·²ç„¡è™•å¯é€ƒã€‚", vfx: "pulse" }
        ];
        return fearPool[Math.floor(Math.random() * fearPool.length)];
    }

    // --- ğŸƒ 4. ã€ç‰©ç†æ¨¡å¼ï¼šä¸€èˆ¬æƒ…å¢ƒåƒåœ¾è©±ã€‘ ---
    const basePool = RANK_VOICE[rank] ? RANK_VOICE[rank][type] : RANK_VOICE.citizen[type];
    const pickedText = basePool[Math.floor(Math.random() * basePool.length)];

    let vfx = "none";
    if (rank === 'slave' && type === 'play') vfx = "shake";
    if (rank === 'king' && type === 'play') vfx = "pulse";
    if (pickedText.includes("ï¼") || pickedText.includes("ï¼Ÿ")) vfx = "pop";

    return { text: pickedText, vfx: vfx };
}

/**
 * âœˆï¸ ç‰©ç†å­ç¨‹åºï¼šç‰©è³‡å‚³éé£›è¡Œç‰¹æ•ˆ (å¤šå‘åº§æ¨™ç²¾æº–ç‰ˆ)
 * ä¿®æ­£ï¼š
 * 1. è‡ªå‹•é©é… IDï¼šæ”¯æ´å¾ AI åˆ°ç©å®¶ï¼Œæˆ–å¾ç©å®¶åˆ° AI çš„é›™å‘ç‰©ç†è·¯å¾‘ã€‚
 * 2. åº§æ¨™åç§»æ ¡æº–ï¼šè§£æ±ºå¡ç‰‡ç¸®æ”¾å°è‡´çš„èµ·é»åç§»ã€‚
 * 3. å‹•æ…‹å±¤ç´šï¼šç¢ºä¿é£›è¡Œç‰©çµ•å°ä½æ–¼é ‚å±¤ï¼Œä¸è¢«ä¸­å¤®æˆ°å€é®æ“‹ã€‚
 */
function triggerCardTransferVfx(fromIdx, toIdx) {
    // 1. ğŸ”¥ ã€ç‰©ç†éŒ¨å®šã€‘ä¿®æ­£ï¼šAI å®¹å™¨é€šå¸¸åœ¨ ai-players å…§ï¼Œæˆ‘å€‘ç›´æ¥å‹•æ…‹ç²å–
    // ç²å–æ‰€æœ‰å¯èƒ½çš„ç¯€é»ï¼šå¦‚æœæ˜¯ç©å®¶å‰‡æ‰¾æ‰‹ç‰Œå€ï¼Œå¦‚æœæ˜¯ AI å‰‡æ‰¾å°æ‡‰çš„ card-player
    const allPlayersUI = document.querySelectorAll('.card-player');
    const playerHandUI = document.getElementById('player-hand');

    // å–å¾—èµ·å§‹é»å…ƒç´  (from)
    let fromEl = (fromIdx === 'player') ? playerHandUI : allPlayersUI[fromIdx > 0 ? fromIdx - 1 : fromIdx];
    // å–å¾—çµ‚é»å…ƒç´  (to)
    let toEl = (toIdx === 'player') ? playerHandUI : allPlayersUI[toIdx > 0 ? toIdx - 1 : toIdx];

    // ğŸ›¡ï¸ ç‰©ç†å®‰å…¨æ€§æª¢æŸ¥ï¼šè‹¥ DOM å°šæœªç”Ÿæˆï¼ŒåŸ·è¡Œéœé»˜è£œå„Ÿ
    if (!fromEl || !toEl) {
        console.warn(`ğŸ“¡ ç‰©ç†å®šä½è£œå„Ÿï¼šä¾†æº ${fromIdx} æˆ– ç›®æ¨™ ${toIdx} å°šæœªæ¸²æŸ“ã€‚`);
        return;
    }

    // 2. âš–ï¸ ã€åº§æ¨™ç‰©ç†æ¸¬é‡ã€‘
    const fromRect = fromEl.getBoundingClientRect();
    const toRect = toEl.getBoundingClientRect();

    // 3. ğŸƒ ã€é£›è¡Œå¯¦é«”é‡é‘„ã€‘
    const flyer = document.createElement('div');
    flyer.className = 'transfer-flyer-vfx';
    flyer.style = `
        position: fixed;
        width: 45px; height: 65px;
        background: white;
        border: 2px solid #9b59b6;
        border-radius: 6px;
        z-index: 300000;
        top: ${fromRect.top + fromRect.height / 2}px;
        left: ${fromRect.left + fromRect.width / 2}px;
        box-shadow: 0 0 25px rgba(155, 89, 182, 0.8);
        display: flex; align-items: center; justify-content: center;
        font-size: 24px;
        pointer-events: none;
        transform: translate(-50%, -50%) scale(0.5);
        opacity: 0;
        transition: none;
    `;
    flyer.innerHTML = (toIdx === 'player') ? "ğŸ¤" : "ğŸ’¸";
    document.body.appendChild(flyer);

    // 4. ğŸš€ ã€é»ç‡ƒå‹•åŠ›ï¼šéåŒæ­¥ä½ç§»ã€‘
    requestAnimationFrame(() => {
        flyer.style.transition = "all 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55)";
        flyer.style.opacity = "1";
        flyer.style.transform = "translate(-50%, -50%) scale(1.1) rotate(720deg)";
        flyer.style.top = `${toRect.top + toRect.height / 2}px`;
        flyer.style.left = `${toRect.left + toRect.width / 2}px`;
    });

    // 5. ğŸ›¬ ã€æŠµé”éœ‡å‹•èˆ‡ç‰©ç†æ¸…ç†ã€‘
    setTimeout(() => {
        // è§¸ç™¼ç›®æ¨™å€åŸŸçš„ç‰©ç†åé¥‹ (å¾®éœ‡å‹•)
        toEl.style.transition = "transform 0.1s";
        toEl.style.transform = "scale(1.05)";
        
        flyer.style.transition = "all 0.2s ease-out";
        flyer.style.opacity = "0";
        flyer.style.transform = "translate(-50%, -50%) scale(1.5) rotate(720deg)";

        setTimeout(() => {
            toEl.style.transform = "scale(1)";
            flyer.remove();
            // ğŸ”¥ åŒæ­¥æœ€å¾Œæ•¸æ“šç‹€æ…‹ä¸¦é‡ç¹ªï¼Œè®“æ–°ç‰Œæ­£å¼é¡¯ç¾
            renderPokerTable(document.getElementById('poker-table'));
        }, 150);
    }, 800);
}

/**
 * ğŸ’° ç‹åœ‹ç¶“æ¿Ÿèˆ‡ç´¯é€²æ‡²ç½°ä¸­æ¨
 * å¯¦è£ï¼š
 * 1. å…¥å ´è²»ï¼š$10,000 (å•Ÿå‹•æ™‚æ‰£é™¤)
 * 2. ç´¯é€²æ‡²ç½°ï¼šå–®å¼µ $30ï¼Œ5å¼µ/10å¼µæ™‚ç‰©ç†ç¿»å€ã€‚
 * 3. ç‹åœ‹ç¨…æï¼šç¸½å½©é‡‘ 10% æ­¸å…¥åœ‹åº«ã€‚
 */

// 1. åˆå§‹åŒ–ç¶“æ¿Ÿæ•¸æ“š (æ“´å±•åŸæœ‰ç©å®¶ç‰©ä»¶)
pokerGame.players.forEach(p => {
    p.coins = p.coins || 100000; // é è¨­ 10 è¬ç±Œç¢¼
    p.currentEntryFee = 10000;
});

/**
 * âš–ï¸ ç‰©ç†çµç®—å¼•æ“ï¼šè¨ˆç®—è¼¸è´èˆ‡ç¨…æ”¶
 */
function settleGameEconomy() {
    const winner = pokerGame.players[pokerGame.winnerIdx];
    let totalPenaltyPool = 0;
    const baseRate = 30; // å–®å¼µ 30 å…ƒ

    console.group("%câš–ï¸ ç‹åœ‹ç¶“æ¿Ÿçµç®—å ±å‘Š", "color: #f1c40f; font-weight: bold;");

    pokerGame.players.forEach((p, idx) => {
        if (idx === pokerGame.winnerIdx) return; // è·³éè´å®¶

        const cardCount = p.hand.length;
        let penalty = 0;

        // ğŸ”¥ ã€ç´¯é€²æ‡²ç½°ç®—æ³•ã€‘
        if (cardCount >= 10) {
            // 10å¼µä»¥ä¸Šï¼šå¤š 2 å€ (åŸå§‹ 1 + é¡å¤– 2 = 3å€ä¿‚æ•¸ï¼Œå†ä¾å…¬å¼ 30 * 10 * 4)
            // ä¾æ“šæ‚¨çš„å…¬å¼é‚è¼¯ï¼š10å¼µå¤š2å€ = 30 * 10 * 4 = 1200
            penalty = baseRate * cardCount * 4;
        } else if (cardCount >= 5) {
            // 5å¼µä»¥ä¸Šï¼šå¤š 1 å€ = 30 * 5 * 2 = 300
            penalty = baseRate * cardCount * 2;
        } else {
            // ä¸€èˆ¬å¼µæ•¸
            penalty = baseRate * cardCount;
        }

        // ç‰©ç†æ‰£æ¬¾
        p.coins -= penalty;
        totalPenaltyPool += penalty;
        console.log(`ç©å®¶ ${p.name}: å‰©é¤˜ ${cardCount} å¼µ -> æ‰£é™¤ $${penalty}`);
    });

    // ğŸ‘‘ ã€ç‹åœ‹ç¨…æ”¶èˆ‡è´å®¶åˆ†ç´…ã€‘
    const taxAmount = Math.floor(totalPenaltyPool * 0.10); // 10% ç¨…é‡‘
    const netPrize = totalPenaltyPool - taxAmount;

    winner.coins += netPrize;
    // å‡è¨­æœ‰ä¸€å€‹å…¨åŸŸè®Šæ•¸è¨˜éŒ„ç‹åœ‹åº«å­˜
    pokerGame.kingdomTax = (pokerGame.kingdomTax || 0) + taxAmount;

    console.log(`ç¸½å½©é‡‘æ± : $${totalPenaltyPool}`);
    console.log(`ğŸ° ç‹åœ‹ç¨…æ”¶ (10%): $${taxAmount}`);
    console.log(`ğŸ† è´å®¶ ${winner.name} ç²å¾—: $${netPrize}`);
    console.groupEnd();

    // åŸ·è¡Œ UI æ›´æ–°
    updateEconomyUI();
}

/**
 * ğŸ–¼ï¸ ç±Œç¢¼æ¸²æŸ“å¼•æ“
 * åœ¨ç‰Œæ¡Œä¸ŠåŒæ­¥é¡¯ç¤ºæ‰€æœ‰ç©å®¶çš„ç›®å‰ç±Œç¢¼
 */
function updateEconomyUI() {
    pokerGame.players.forEach((p, idx) => {
        const container = (idx === 0) 
            ? document.getElementById('player-info') 
            : document.querySelectorAll('.card-player')[idx-1];
            
        if (container) {
            // å°‹æ‰¾æˆ–å‰µå»ºç±Œç¢¼é¡¯ç¤ºæ¨™ç±¤
            let coinEl = container.querySelector('.coin-display');
            if (!coinEl) {
                coinEl = document.createElement('div');
                coinEl.className = 'coin-display';
                coinEl.style = "color: #f1c40f; font-weight: bold; text-shadow: 1px 1px 2px #000;";
                container.appendChild(coinEl);
            }
            coinEl.innerHTML = `ğŸ’° $${p.coins.toLocaleString()}`;
        }
    });
}

// --- ğŸƒ Roguelike æ©è³œå„€å¼ï¼šé–‹å±€æ”¹è®Šç‰©ç†æ³•å‰‡ ---
function showBoonSelection() {
    const pokerTable = document.getElementById('poker-table');
    if (!pokerTable) return;

    // 1. ç‰©ç†å‰µå»ºæ©è³œé®ç½©
    const overlay = document.createElement('div');
    overlay.id = "boon-overlay";
    overlay.style = `
        position:fixed; top:0; left:0; width:100%; height:100%; 
        background:rgba(0,0,0,0.95); z-index:20000; 
        display:flex; flex-direction:column; align-items:center; justify-content:center;
        animation: fadeIn 0.5s ease;
    `;

    // 2. å®šç¾©æ©è³œæ±  (Boons Pool)
    const boonPool = [
        { id: 'joker_2', name: 'ğŸƒ å°ä¸‘çš„æƒ¡ä½œåŠ‡', desc: 'ç²å¾— 2 å¼µè¬ç”¨é¬¼ç‰Œ', icon: 'ğŸƒ' },
        { id: 'monochrome', name: 'ğŸŒˆ è‰²ç›²çµ±æ²»è€…', desc: 'æ‰€æœ‰æ‰‹ç‰Œè¦–ç‚ºåŒä¸€èŠ±è‰²', icon: 'ğŸ¨' },
        { id: 'black_market', name: 'ğŸ”„ é»‘å¸‚äº¤æ˜“', desc: 'éš¨æ©Ÿæ›¿æ› 3 å¼µæ‰‹ç‰Œ', icon: 'âš–ï¸' },
        { id: 'tax_heavy', name: 'ğŸ’° æš´æ”¿ç¨…æ”¶', desc: 'å¾µç¨…éšæ®µå¤šæŠ½ 1 å¼µç‰Œ', icon: 'ğŸ›ï¸' },
        { id: 'immortal', name: 'ğŸ›¡ï¸ è² å‚µè±å…', desc: 'æœ¬å±€è½æ•—ä¸è§¸ç™¼ç­‰ç´šæ‡²ç½°', icon: 'â›“ï¸' }
    ];

    // éš¨æ©ŸæŠ½å– 3 å¼µ
    const pickedBoons = boonPool.sort(() => 0.5 - Math.random()).slice(0, 3);

    overlay.innerHTML = `
        <h1 style="color:#f1c40f; letter-spacing:8px; text-shadow:0 0 20px #f1c40f; margin-bottom:10px;">è¡€è…¥æ©è³œ</h1>
        <p style="color:#888; margin-bottom:40px;">é¸æ“‡ä¸€å€‹æœ¬å±€ç”Ÿæ•ˆçš„ Roguelike ç‰¹è³ª</p>
        <div style="display:flex; gap:25px;">
            ${pickedBoons.map(boon => `
                <div onclick="applyBoonAndStart('${boon.id}')" class="boon-card" style="
                    width:160px; padding:25px 15px; background:#111; border:2px solid #444; 
                    border-radius:15px; cursor:pointer; text-align:center; transition:0.3s;
                    box-shadow: 0 5px 15px rgba(0,0,0,0.5);">
                    <div style="font-size:40px; margin-bottom:15px;">${boon.icon}</div>
                    <b style="color:#fff; font-size:16px; display:block; margin-bottom:10px;">${boon.name}</b>
                    <small style="color:#777; line-height:1.4; display:block;">${boon.desc}</small>
                </div>
            `).join('')}
        </div>
    `;

    document.body.appendChild(overlay);
}

/**
 * ğŸƒ éšç´šå‘½é‹æŠ½é¸ç³»çµ±ï¼šRoguelike è¦–è¦ºèˆ‡å±¤ç´šåŠ å›ºç‰ˆ
 * ä¿®æ­£ï¼š
 * 1. ç‰©ç†å±¤ç´šç½®é ‚ï¼šz-index 30000 ç¢ºä¿ä¸è¢«æ—¥èªŒæˆ–æ§åˆ¶å°é®æ“‹ã€‚
 * 2. ç¨€æœ‰åº¦è¦–è¦ºåŒæ­¥ï¼šå¯¦è£å‚³å¥‡é‡‘ã€ç¨€æœ‰ç´…ã€èˆ‡å„é‹ç´«çš„ç‰©ç†å…‰æšˆã€‚
 * 3. å‹•ä½œéˆè·¯é–å®šï¼šonclick ç›´æ¥æ›è¼‰ applyBoonAndStartï¼Œç¢ºä¿é»ç«æµç¨‹ä¸ä¸­æ–·ã€‚
 */
function showRankBoonSelection() {
    const hero = pokerGame.players.find(p => p.id === 'player');
    
    // 0. ğŸ”¥ ã€ç‰©ç†é˜²ç¦¦ã€‘
    if (!hero || !pokerGame.gameActive || !RANK_BOON_DATA) return;

    // 1. ğŸ”¥ ã€ç‰©ç†ç’°å¢ƒæ·¨åŒ–ã€‘
    const existing = document.getElementById('boon-overlay');
    if (existing) existing.remove();

    const rank = hero.rank || 'citizen';
    const pool = RANK_BOON_DATA[rank] || RANK_BOON_DATA['citizen'];
    
    // ğŸ² ç‰©ç†æŠ½é¸ï¼šæ´—ç‰Œä¸¦é¸å– 3 ç¨®å‘½é‹
    const picked = [...pool].sort(() => 0.5 - Math.random()).slice(0, 3);

    // 2. ç‰©ç†æ§‹å»º UI é®ç½©
    const overlay = document.createElement('div');
    overlay.id = "boon-overlay";
    overlay.style = `
        position:fixed; top:0; left:0; width:100%; height:100%; 
        background:radial-gradient(circle, rgba(15,15,15,0.98) 0%, rgba(0,0,0,1) 100%); 
        z-index:30000; display:flex; flex-direction:column; align-items:center; justify-content:center;
        font-family: 'Consolas', 'Courier New', monospace; animation: fadeIn 0.6s ease-out forwards;
        backdrop-filter: blur(12px);
    `;

    overlay.innerHTML = `
        <div style="color:#f1c40f; font-size:14px; margin-bottom:15px; letter-spacing:6px; text-shadow:0 0 10px #f1c40f; opacity:0.8;">
            [ ${rank.toUpperCase()} FATE SELECTION ]
        </div>
        <h1 style="color:white; margin-bottom:60px; letter-spacing:15px; font-weight:lighter; text-transform:uppercase; text-shadow:0 0 20px rgba(255,255,255,0.2);">è¡€ è…¥ æŠ‰ æ“‡</h1>
        
        <div style="display:flex; gap:35px;">
            ${picked.map(b => {
                // ğŸ”¥ ã€ç‰©ç†ç¨€æœ‰åº¦æ¸²æŸ“çŸ©é™£ã€‘
                const styles = {
                    legend: { label: 'ã€ å‚³ å¥‡ ã€‘', color: '#f1c40f', glow: 'rgba(241,196,15,0.4)' },
                    rare:   { label: 'ã€ ç¨€ æœ‰ ã€‘', color: '#e74c3c', glow: 'rgba(231,76,60,0.3)' },
                    normal: { label: 'ã€ ä¸€ èˆ¬ ã€‘', color: '#888',    glow: 'rgba(255,255,255,0.1)' },
                    curse:  { label: 'ã€ å„ é‹ ã€‘', color: '#9b59b6', glow: 'rgba(155,89,182,0.4)' }
                }[b.rarity || 'normal'];

                return `
                <div onclick="applyBoonAndStart('${b.id}')" class="boon-card" style="
                    width:220px; padding:40px 25px; background:linear-gradient(135deg, #0f0f0f 0%, #050505 100%); 
                    border: 1px solid ${styles.color}55; border-radius:12px; 
                    cursor:pointer; text-align:center; transition:0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
                    box-shadow: 0 15px 45px rgba(0,0,0,0.8), inset 0 0 15px ${styles.glow}; 
                    position:relative; overflow:hidden;">
                    
                    <div style="font-size:11px; color:${styles.color}; margin-bottom:20px; letter-spacing:2px; font-weight:bold;">
                        ${styles.label}
                    </div>

                    <div style="color:white; font-size:22px; font-weight:bold; margin-bottom:20px; height:60px; display:flex; align-items:center; justify-content:center; text-shadow:0 2px 10px #000;">
                        ${b.name}
                    </div>
                    
                    <div style="color:#999; font-size:13px; line-height:1.7; height:80px; border-top:1px solid ${styles.color}22; padding-top:20px;">
                        ${b.desc}
                    </div>
                    
                    <div class="boon-tag" style="margin-top:30px; color:#444; font-size:9px; letter-spacing:2px; transition:0.3s;">
                        - ACCEPT_THE_CONTRACT -
                    </div>
                </div>
                `;
            }).join('')}
        </div>

        <div style="margin-top:70px; color:#444; font-size:10px; font-family:monospace; letter-spacing:1px;">
            SYSTEM_MESSAGE: BOONS_WILL_ALTER_PHYSICAL_LAWS_OF_THIS_ROUND
        </div>
    `;

    // 3. ğŸ”¥ ã€CSS ç‰©ç†æ³¨å…¥ï¼šå‹•æ…‹æ•ˆæœã€‘
    if (!document.getElementById('boon-style-vfx')) {
        const style = document.createElement('style');
        style.id = 'boon-style-vfx';
        style.innerHTML = `
            .boon-card:hover { 
                transform: translateY(-25px) scale(1.05);
                border-color: #fff !important;
                box-shadow: 0 25px 60px rgba(0,0,0,0.9), 0 0 30px rgba(255,255,255,0.1) !important;
            }
            .boon-card:hover .boon-tag { color: #f1c40f !important; }
            @keyframes fadeIn { from { opacity:0; transform:scale(1.1); } to { opacity:1; transform:scale(1); } }
        `;
        document.head.appendChild(style);
    }

    document.body.appendChild(overlay);
    addBattleLog(`ğŸ° <b style="color:#f1c40f;">åäººå ‚ç³»çµ±</b>ï¼šæ­£åœ¨ç‚º [${rank.toUpperCase()}] åˆ†é…å‘½é‹åˆ†æ”¯...`);
}


/**
 * ğŸ’° ç‰©ç†åˆ†é…ï¼šè‡ªå‹•åŒ–ç¨…æ”¶æŠ•è³‡ä¸¦ç™¼æ”¾ç´…åˆ©
 * @param {number} taxCollected æœ¬å±€æŠ½å–çš„ 10% ç¨…é‡‘
 */
function distributeKingdomEconomy(taxCollected) {
    if (taxCollected <= 0) return;

    // 1. ğŸ”¥ ã€ç´…åˆ©æ’¥æ”¾ã€‘åªè¦æ˜¯å…¬æ°‘ä»¥ä¸Šä¸”éè² å‚µï¼Œå³å¯ç²å¾— 2% è¨­æ–½å›é¥‹ (èº«åˆ†ç´…åˆ©)
    const hero = pokerGame.players.find(p => p.id === 'player');
    if (hero.rank !== 'slave' && player.coin >= 0) {
        const dividend = Math.floor(taxCollected * 0.02); 
        player.coin += dividend;
        window.kingdomSystem.totalDividendsIssued += dividend;
        addBattleLog(`ğŸ¦ <b style="color:#f1c40f;">[ç‹åœ‹ç´…åˆ©]</b> è¨­æ–½ç‡Ÿé‹å›é¥‹äº† $${dividend} G åˆ°æ‚¨çš„å¸³æˆ¶ã€‚`);
    }

    // 2. ğŸ”¥ ã€è‡ªå‹•æŠ•è³‡ã€‘å°‡ç¨…é‡‘è½‰åŒ–ç‚ºç¡¬é«”è¨­æ–½ç¶“é©—å€¼
    let remainingTax = taxCollected;
    const cost = kingdomSystem.investmentCost || 2000;
    let upgradeCount = 0;

    while (remainingTax >= cost) {
        const keys = Object.keys(kingdomSystem.upgrades);
        const available = keys.filter(k => kingdomSystem.upgrades[k].lv < 1000);
        if (available.length === 0) break;

        const target = available[Math.floor(Math.random() * available.length)];
        kingdomSystem.upgrades[target].lv++;
        remainingTax -= cost;
        upgradeCount++;
        
        // ç‰©ç†ç´€éŒ„ç©å®¶çš„ç¸½è²¢ç»ï¼ˆå› ç¨…é‡‘ä¾†è‡ªåšå¼ˆï¼Œè¦–ç‚ºç©å®¶é–“æ¥æŠ•è³‡ï¼‰
        window.kingdomSystem.playerInvestmentTotal += cost;
    }

    // 3. å‰©é¤˜ä¸è¶³ 2000 çš„ç¨…é‡‘ç‰©ç†å­˜å…¥åœ‹åº«
    kingdomSystem.treasury += remainingTax;

    if (upgradeCount > 0) {
        addBattleLog(`ğŸ—ï¸ <b style="color:#f1c40f;">ç‹åœ‹å»ºè¨­</b>ï¼šæœ¬å±€ç¨…æ”¶è‡ªå‹•å®Œæˆäº† ${upgradeCount} æ¬¡è¨­æ–½å‡ç´šï¼`);
    }
}

/**
 * ğŸ‘‘ åœ‹ç‹å¼·å¥ªï¼šç‰©ç†é›™é¸æˆ°ç•¥ä»‹é¢ (å…¨è²Œå°ç…§ç‰ˆ)
 * ä¿®æ­£ï¼šåŒæ™‚æ¸²æŸ“å¥´éš¸èˆ‡åœ‹ç‹æ‰‹ç‰Œï¼Œæ”¯æ´å³æ™‚æ¯”å°èˆ‡ä¸€éµäº¤æ›
 */
async function openTyrannyTaxUI(slave) {
    return new Promise((resolve) => {
        const hero = pokerGame.players.find(p => p.id === 'player');
        if (!hero || !slave) return resolve();

        const marketDiv = document.createElement('div');
        marketDiv.id = "tyranny-overlay";
        marketDiv.style = `
            position:fixed; top:0; left:0; width:100%; height:100%; 
            background:rgba(0,0,0,0.96); z-index:40000; 
            display:flex; flex-direction:column; align-items:center; justify-content:center;
            backdrop-filter: blur(15px); transition: 0.3s;
        `;

        // ç‰©ç†ç‹€æ…‹è¿½è¹¤
        let selectedSlaveIdx = -1;
        let selectedHeroIdx = -1;

        const refreshUI = () => {
            marketDiv.innerHTML = `
                <h2 style="color:#f1c40f; letter-spacing:5px; text-shadow:0 0 15px gold; margin-bottom:5px;">ğŸ‘‘ æš´æ”¿ç¨…æ”¶ï¼šæ¬Šå¨å°ç…§</h2>
                <p style="color:#aaa; margin-bottom:25px;">è«‹åˆ†åˆ¥é»æ“Šã€Œå¥´éš¸ä¹‹ç‰©ã€èˆ‡ã€Œæ–½æ¨ä¹‹ç‰©ã€é€²è¡Œç‰©ç†ç½®æ›</p>
                
                <div style="display:flex; gap:40px; width:95%; max-width:1000px; justify-content:center; align-items:flex-start;">
                    
                    <div style="flex:1; background:rgba(255,0,0,0.05); padding:20px; border-radius:12px; border:1px solid #400;">
                        <h3 style="color:#ff4d4d; text-align:center; margin-top:0;">â›“ï¸ å¥´éš¸çš„æ‰‹ç‰Œ (å–èµ°å…¶ä¸€)</h3>
                        <div style="display:flex; flex-wrap:wrap; gap:8px; justify-content:center;">
                            ${slave.cards.map((c, idx) => `
                                <div onclick="selectSlaveCard(${idx})" style="
                                    background:white; color:${c.suit === 'â™¥' || c.suit === 'â™¦' ? 'red' : 'black'}; 
                                    padding:12px 8px; border-radius:5px; font-weight:bold; cursor:pointer; 
                                    border: 3px solid ${selectedSlaveIdx === idx ? '#f1c40f' : '#ddd'};
                                    transform: ${selectedSlaveIdx === idx ? 'scale(1.1) translateY(-5px)' : 'scale(1)'};
                                    box-shadow: ${selectedSlaveIdx === idx ? '0 0 15px gold' : 'none'};
                                    transition:0.2s; min-width:35px; text-align:center;">
                                    ${c.label}
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <div style="flex:1; background:rgba(241,196,15,0.05); padding:20px; border-radius:12px; border:1px solid #440;">
                        <h3 style="color:#f1c40f; text-align:center; margin-top:0;">ğŸ‘‘ åœ‹ç‹çš„æ‰‹ç‰Œ (æ‹‹æ£„å…¶ä¸€)</h3>
                        <div style="display:flex; flex-wrap:wrap; gap:8px; justify-content:center;">
                            ${hero.cards.map((c, idx) => `
                                <div onclick="selectHeroCard(${idx})" style="
                                    background:white; color:${c.suit === 'â™¥' || c.suit === 'â™¦' ? 'red' : 'black'}; 
                                    padding:12px 8px; border-radius:5px; font-weight:bold; cursor:pointer; 
                                    border: 3px solid ${selectedHeroIdx === idx ? '#e74c3c' : '#ddd'};
                                    transform: ${selectedHeroIdx === idx ? 'scale(1.1) translateY(-5px)' : 'scale(1)'};
                                    box-shadow: ${selectedHeroIdx === idx ? '0 0 15px #e74c3c' : 'none'};
                                    transition:0.2s; min-width:35px; text-align:center;">
                                    ${c.label}
                                </div>
                            `).join('')}
                        </div>
                    </div>

                </div>

                <div style="margin-top:40px; display:flex; flex-direction:column; align-items:center; gap:15px;">
                    <div id="exchange-preview" style="color:#fff; font-size:16px; min-height:24px; font-family:monospace;">
                        ${(selectedSlaveIdx !== -1 && selectedHeroIdx !== -1) ? 
                            `ç‰©ç†ç½®æ›ï¼š<b style="color:gold;">${slave.cards[selectedSlaveIdx].label}</b> â†”ï¸ <b style="color:#aaa;">${hero.cards[selectedHeroIdx].label}</b>` : 
                            `ç­‰å¾…é¸å–ä¸­...`}
                    </div>
                    
                    <button onclick="confirmTyrannySwap()" id="tyranny-btn" style="
                        padding:15px 60px; background:${(selectedSlaveIdx !== -1 && selectedHeroIdx !== -1) ? '#f1c40f' : '#333'}; 
                        color:#000; border:none; border-radius:30px; font-weight:bold; font-size:20px; 
                        cursor:${(selectedSlaveIdx !== -1 && selectedHeroIdx !== -1) ? 'pointer' : 'not-allowed'};
                        box-shadow: 0 5px 0 #b7950b; transition:0.2s;">
                        åŸ· è¡Œ æ  å¥ª
                    </button>
                    
                    <button onclick="cancelTyranny()" style="background:none; border:none; color:#666; cursor:pointer; font-size:12px; text-decoration:underline;">
                        æš«ä¸åŸ·è¡Œï¼Œç”±ç³»çµ±ä»£é¸
                    </button>
                </div>
            `;
        };

        // ç‰©ç†é‚è¼¯ç¶å®š
        window.selectSlaveCard = (idx) => { selectedSlaveIdx = idx; refreshUI(); };
        window.selectHeroCard = (idx) => { selectedHeroIdx = idx; refreshUI(); };

        window.cancelTyranny = () => {
            marketDiv.remove();
            cleanup();
            resolve();
        };

        window.confirmTyrannySwap = () => {
            if (selectedSlaveIdx === -1 || selectedHeroIdx === -1) return;

            // 1. ç‰©ç†ç§»é™¤èˆ‡ç²å–æ•¸æ“š
            const taken = slave.cards.splice(selectedSlaveIdx, 1)[0];
            const gift = hero.cards.splice(selectedHeroIdx, 1)[0];

            // 2. ç‰©ç†äº¤æ›
            hero.cards.push(taken);
            slave.cards.push(gift);

            // 3. æ•¸æ“šé‡æ•´
            hero.cards.sort((a, b) => a.power - b.power);
            slave.cards.sort((a, b) => a.power - b.power);

            showNotification(`âš–ï¸ æš´æ”¿é”æˆï¼šä»¥ã€${gift.label}ã€‘å¼·è¡Œç´¢å–äº†ã€${taken.label}ã€‘ï¼`);
            
            // 4. æ¸…ç†
            marketDiv.remove();
            cleanup();
            resolve();
        };

        function cleanup() {
            delete window.selectSlaveCard;
            delete window.selectHeroCard;
            delete window.confirmTyrannySwap;
            delete window.cancelTyranny;
        }

        document.body.appendChild(marketDiv);
        refreshUI();
    });
}


/**
 * ğŸ›ï¸ åäººå ‚ï¼šè¨˜éŒ„å‹‡è€…çš„çµ‚ç„‰ (ç‹æ¬Šç¨±è™Ÿèˆ‡ç™¾é€£å‹ç´€éŒ„å¼·åŒ–ç‰ˆ)
 */
async function recordToHallOfFame(cause = "é›¢é–‹ç‹åœ‹") {
    // 1. ğŸ”¥ ã€ç‰©ç†æ ¸å¿ƒï¼šç‹æ¬Šç¨±è™Ÿåˆ¤å®šçŸ©é™£ã€‘
    const streak = player.kingStreak || 0;
	const titleData = getKingTitleData(player.kingStreak || 0); // ç‰©ç†å¼•ç”¨å…¨åŸŸå‡½æ•¸

    // å–å¾—ç•¶å‰ç‰©ç†æœ€é«˜ç¨±è™Ÿ
    const currentKingTitle = KING_TITLES.find(t => streak >= t.threshold) || KING_TITLES[KING_TITLES.length - 1];

    // 2. ğŸ”¥ ã€æ•¸æ“šå¿«ç…§ã€‘æ•´åˆå†’éšªç¨±è™Ÿèˆ‡ç‹æ¬Šæˆå°±
    const record = {
        date: new Date().toLocaleString(),
        lv: player.lv,
        // ç‰©ç†çµ„åˆé ­éŠœï¼š[å†’éšªç­‰ç´š] | [ç‹æ¬Šç¨±è™Ÿ]
        title: `${player.title} | ${currentKingTitle.name}`, 
        maxStreak: Math.max(streak, player.maxKingStreak || 0),
        totalWins: pokerGame.playerTotalWins || 0,
        totalLoot: player.coin,
        deathCause: cause,
        // ç‰©ç†è¦–è¦ºæ¨™ç±¤ï¼šç”¨æ–¼ openHallOfFame æ¸²æŸ“é¡è‰²
        visualTag: {
            color: currentKingTitle.color,
            glow: currentKingTitle.glow,
            isGod: streak >= 100
        }
    };

    try {
        // 3. ç‰©ç†å¯«å…¥ IndexedDB
        await db.hallOfFame.add(record);
        
        // 4. æ§åˆ¶å°ç‰©ç†è‡´æ•¬
        console.log(
            `%cğŸ“œ å²å†Šæ›´æ–°ï¼š${currentKingTitle.name} çš„å‚³å¥‡å·²é–å®šã€‚`, 
            `color: ${currentKingTitle.color}; font-weight: bold; text-shadow: ${currentKingTitle.glow};`
        );

        // 5. ç‰©ç†åŒæ­¥æ›´æ–°ç©å®¶æ­·å²æœ€é«˜ç´€éŒ„
        if (streak > (player.maxKingStreak || 0)) {
            player.maxKingStreak = streak;
            await savePlayerToDB();
        }

    } catch (e) {
        console.error("âŒ åäººå ‚ç¢‘æ–‡åˆ»å°å¤±æ•—:", e);
    }
}

/**
 * ğŸ“ˆ è‚¡å¸‚ç‰©ç†å¼•æ“ï¼šK ç·šæ¡é›†ã€SOJ å¤§å–®ç›£æ§èˆ‡ç’°å¢ƒæ„ŸçŸ¥é€£å‹•
 * ä¿®æ­£ï¼šå¯¦è£ç‰©ç†é˜²ç«ç·š (MIN_PRICE) èˆ‡ä½åƒ¹å€è­·ç›¤å¼•åŠ›ï¼Œé˜²æ­¢è‚¡åƒ¹æ­¸é›¶ã€‚
 */
function updateStockMarket() {
    const sys = window.kingdomSystem;
    if (!window.kingdomStocks) return;

    // ğŸ”¥ ç‰©ç†é˜²ç«ç·šåƒæ•¸è¨­å®š [cite: 2026-02-06]
    const MIN_PRICE = 5;          // çµ•å°åº•ç·šï¼Œç¦æ­¢è‚¡åƒ¹æ­¸é›¶
    const BAILOUT_THRESHOLD = 15; // æ•‘å¸‚é–€æª»ï¼Œä½æ–¼æ­¤åƒ¹å•Ÿå‹•å¼•åŠ›åè½‰

    const hasAnnihilus = player.inventory.includes("ğŸ’ æ¯€æ»…å°ç¬¦ (Annihilus)");

    let globalFactor = 1.0;
    let eventMessage = "";

    // --- ğŸ’ 1. ã€ç‰©ç†æ ¸å¿ƒï¼šå–¬ä¸¹å¯¦æ¥­ (SOJ) å¤§å–®åµæ¸¬ã€‘ ---
    const jordanRoll = Math.random() * 100;
    if (jordanRoll < 1.3) {
        const soj = window.kingdomStocks.find(s => s.id === 'SOJ');
        if (soj) {
            const isBuy = Math.random() > 0.5;
            
            let impact = isBuy ? 1.25 : 0.75; 
            if (hasAnnihilus) impact = isBuy ? 1.40 : 0.90; 
            
            pokerGame.berserkTriggerChance = (pokerGame.berserkTriggerChance || 0) + 1.5;
            
            // ğŸ”¥ ç‰©ç†ä¿®æ­£ï¼šSOJ è¡æ“Šå¾Œä¾ç„¶å—é˜²ç«ç·šä¿è­·
            soj.price = Math.max(MIN_PRICE, Math.floor(soj.price * impact));
            
            const actionText = isBuy ? "å¤§é‡è²·é€²" : "ç˜‹ç‹‚æ‹‹å”®";
            const color = isBuy ? "#2ecc71" : "#e74c3c";
            
            addBattleLog(`ğŸ“¡ <b style="color:${color};">[å¤§å–®ç›£æ§]</b> å¸‚å ´å‚³å‡º ${actionText} å–¬ä¸¹å¯¦æ¥­ è‚¡ç¥¨ï¼`);
            if (hasAnnihilus) addBattleLog(`âœ¨ <b style="color:#9b59b6;">[æ¯€æ»…å…±é³´]</b> è­·ç¬¦æ•£ç™¼ç´«å…‰ï¼ŒæŠµéŠ·äº†æš—å½±å¤§å–®çš„è¡æ“Šã€‚`);
            
            addBattleLog(`ğŸŒ‘ è™›ç©ºä¸­çš„æš—å½±æ°£æ¯å¢å¼·äº†... (ç›®å‰ç´¯ç©æ©Ÿç‡: ${pokerGame.berserkTriggerChance.toFixed(1)}%)`);

            triggerGlobalEnvironmentalTalk(isBuy);
            if (typeof triggerJordanVfx === 'function') triggerJordanVfx(isBuy);
            
            const hero = pokerGame.players.find(p => p.id === 'player');
            if (pokerGame.berserkTriggerChance >= 15 && hero.rank !== 'king' && !pokerGame.isBerserkKingActive) {
                if (Math.random() * 100 < pokerGame.berserkTriggerChance) {
                    if (typeof triggerBerserkKingRise === 'function') triggerBerserkKingRise();
                }
            }
        }
    }

    // --- ğŸ“Š 2. ã€ç‰©ç†äº‹ä»¶åˆ¤å®šï¼šå¤§ç›¤èµ°å‹¢ã€‘ ---
    if ((sys.siphonCount || 0) >= 3 && Math.random() < 0.20) {
        globalFactor = 0.90;
        if (hasAnnihilus) globalFactor = 0.98; 
        
        eventMessage = hasAnnihilus ? 
            "ğŸ“ˆ <b style='color:#9b59b6;'>[æ¯€æ»…è­·é«”]</b> è‚¡å¸‚é›–æœ‰éœ‡ç›ªï¼Œä½†æ¯€æ»…å°ç¬¦å®ˆè­·äº†ç©å®¶çš„è³‡ç”¢ï¼" :
            "ğŸ“‰ <b style='color:#e74c3c;'>[è‚¡å¸‚å´©ç›¤]</b> æ˜å›ç„¡é“ï¼Œå¼•ç™¼ææ…Œæ€§æ‹‹å”®ï¼å…¨ç›¤è·Œåœï¼";
        sys.siphonCount = 0;
    } 
    else if (player.kingStreak >= 2 && (sys.siphonCount || 0) === 0 && Math.random() < 0.05) {
        globalFactor = 1.15; 
        eventMessage = "ğŸ“ˆ <b style='color:#2ecc71;'>[åœ‹é‹æ˜Œéš†]</b> ä»å›åœ¨ä½ï¼Œå¸‚å ´ä¿¡å¿ƒå¤§å¢ï¼";
    }

    // --- ğŸ§ª 3. ã€ç‰©ç†æ³¢å‹•æ¼”ç®—ï¼šå„è‚¡ K ç·šå¯«å…¥ã€‘ ---
    window.kingdomStocks.forEach(s => {
        const oldPrice = s.price;
        let volatility = (Math.random() - 0.5) * 0.04; 
        
        // ğŸ”¥ ã€æ ¸å¿ƒä¿®æ­£ï¼šç‰©ç†é˜²ç«ç·šèˆ‡å¼•åŠ›åè½‰ã€‘ [cite: 2026-02-06]
        if (s.price < BAILOUT_THRESHOLD) {
            // ç•¶è‚¡åƒ¹é€²å…¥ã€Œé˜²ç«ç·šå€åŸŸã€ï¼Œ80% æ©Ÿç‡å¼·è¡Œå›æ¼² (0~8%)ï¼Œ20% è¼•å¾®å›æ¸¬
            volatility = (Math.random() < 0.8) ? (Math.random() * 0.08) : -(Math.random() * 0.02);
            s.isProtected = true; // æ¨™è¨˜ç‚ºåœ‹ç‹å®ˆè­·ç‹€æ…‹
        } else {
            s.isProtected = false;
        }

        // åŸ·è¡Œåƒ¹æ ¼æ¼”é€²ï¼Œä¸¦ç‰©ç†æ€§å¼·åˆ¶é–å®šæœ€å°å€¼ MIN_PRICE
        const newPrice = Math.max(MIN_PRICE, Math.min(500, Math.floor(oldPrice * (1 + volatility) * globalFactor)));
        
        const shadowRange = Math.max(1, Math.floor(newPrice * 0.02)); 
        const highPrice = Math.max(oldPrice, newPrice) + Math.floor(Math.random() * shadowRange);
        
        // ğŸ”¥ å½±ç·šæœ€ä½é»åŒæ¨£å—é˜²ç«ç·šç‰©ç†é–å®š
        const lowPrice = Math.max(MIN_PRICE, Math.min(oldPrice, newPrice) - Math.floor(Math.random() * shadowRange));

        s.candles = s.candles || [];
        s.candles.push({ o: oldPrice, h: highPrice, l: lowPrice, c: newPrice, t: Date.now() });
        if (s.candles.length > 80) s.candles.shift();

        s.price = newPrice;
        s.lastChange = newPrice - oldPrice;
        s.history = s.history || [];
        s.history.push(newPrice);
        if (s.history.length > 20) s.history.shift();
    });

    if (eventMessage) addBattleLog(eventMessage);
    
    if (document.getElementById('financial-modal')) {
        requestAnimationFrame(() => {
            if (typeof renderStockContent === 'function') renderStockContent();
        });
    }
}


/**
 * ğŸ“¡ ç‰©ç†å­ç¨‹åºï¼šå…¨å ´ç’°å¢ƒæ„ŸçŸ¥å°è©± (SOJ è¯å‹•ç‰ˆ)
 * ä½œç”¨ï¼šè®“æ‰€æœ‰åœ¨å ´ç©å®¶ç‰©ç†æ„Ÿæ‡‰è™›ç©ºå¤§å–®çš„å£“åŠ›
 */
function triggerGlobalEnvironmentalTalk(isBuy) {
    console.log("%cğŸŒ‘ åŸ·è¡Œç’°å¢ƒæ„Ÿæ‡‰å”è­°ï¼šæš—å½±æ­£åœ¨ç‰©ç†æ€§æ“´æ•£...", "color: #9b59b6; font-weight: bold;");

    const actionText = isBuy ? "æ¹§å…¥" : "æ’¤é›¢";
    
    pokerGame.players.forEach((p, idx) => {
        // è·³éå‹‡è€…ï¼Œæ”¹ç”±é€šçŸ¥ç³»çµ±è™•ç†ç›´è¦ºæ„Ÿæ‡‰
        if (p.id === 'player') {
            showNotification(`ğŸŒŒ <b style="color:#9b59b6;">[ç›´è¦º]</b> è™›ç©ºè³‡é‡‘æ­£åœ¨ç‰©ç†æ€§${actionText}å¸‚å ´...`);
            return;
        }

        // æ ¹æ“šéšç´šèˆ‡ç’°å¢ƒç‹€æ…‹ï¼Œè³¦äºˆå°æ‡‰çš„è·äººç´šåŠ‡æœ¬
        const envScripts = {
            king: [
                { text: "ã€Œé€™è‚¡å¯’æ°£... æ˜¯å–¬ä¸¹å¯¦æ¥­åœ¨å“€é³´ï¼Ÿã€", vfx: "shake" },
                { text: "ã€Œæš—å½±é®å¤©... åœ‹åº«çš„é½’è¼ªæ­£åœ¨ç‰©ç†æ€§ç£¨æã€‚ã€", vfx: "glitch" }
            ],
            noble: [
                { text: "ã€Œå¤§å–®æ³¨å…¥çš„æ³¢å‹•... æˆ‘çš„è³‡ç”¢æ­£åœ¨è’¸ç™¼ï¼ã€", vfx: "pop" },
                { text: "ã€Œé€™æ˜¯è™›ç©ºçš„æ°£æ¯ï¼ŒæŸç¨®å­˜åœ¨è¦é™è‡¨äº†ã€‚ã€", vfx: "pulse" }
            ],
            citizen: [
                { text: "ã€Œå¤©ç©ºè®Šè‰²äº†... äº¤æ˜“æ‰€çš„ç´…å…‰å¥½åˆºçœ¼ã€‚ã€", vfx: "none" },
                { text: "ã€Œæš—å½±... æ‰€æœ‰çš„æ•¸å­—éƒ½åœ¨é¡«æŠ–ã€‚ã€", vfx: "shake" }
            ],
            slave: [
                { text: "ã€Œæ·é–è®Šé‡äº†... åœ°ç„çš„é–€æ‰“é–‹äº†å—ï¼Ÿã€", vfx: "glitch" },
                { text: "ã€Œæš—å½±é®å¤©... æ¯€æ»…å°å¥´éš¸ä¾†èªªä¹Ÿæ˜¯ç¨®ç‰©ç†æ•‘è´–ã€‚ã€", vfx: "none" }
            ]
        };

        const pool = envScripts[p.rank] || envScripts.citizen;
        const talk = pool[Math.floor(Math.random() * pool.length)];

        // ç‰©ç†æ§é »ï¼šç¨å¾®éŒ¯é–‹æ¯å€‹äººçš„æ°£æ³¡å½ˆå‡ºæ™‚é–“ï¼Œå¢åŠ æ¼”ç¹¹å±¤æ¬¡æ„Ÿ
        setTimeout(() => {
            if (typeof triggerAISpeech === 'function') {
                triggerAISpeech(idx, talk);
            }
        }, 100 + (idx * 350));
    });
}

/**
 * ğŸ‘¹ ç‹‚æš´åœ‹ç‹ç¾èº«ï¼šç‰©ç†è¦–è¦ºå¼•æ“å¼·åŒ–
 */
function triggerBerserkKingRise() {
    pokerGame.isBerserkKingActive = true;
    pokerGame.isKingSiege = true; 
    pokerGame.berserkTriggerChance = 0;

    console.log("%cğŸ‘¹ ã€Œè™›ç©ºå·²è‡³ï¼Œç§©åºçµ‚çµï¼ã€", "color: #ff0000; font-size: 20px; font-weight: bold;");

    // 1. ğŸ”¥ ã€ç‰©ç†éœ‡ç›ªé»ç«ã€‘
    const table = document.getElementById('poker-table');
    if (table) {
        table.classList.add('berserk-world-shake');
        table.classList.add('glitch-shatter-active'); // å°å…¥ç‰©ç†ç¢è£‚
    }

    // 2. ğŸ¨ ã€å…¨åŸŸè¦–è¦ºé‡å¡‘ã€‘
    const mainWrapper = document.querySelector('.main-wrapper');
    if (mainWrapper) {
        mainWrapper.style.filter = "sepia(1) hue-rotate(-50deg) saturate(2.5) brightness(0.7) contrast(1.2)";
    }

    // 3. ğŸŒ«ï¸ ã€è™›ç©ºæ¿¾é¡æ›è¼‰ã€‘
    let voidOverlay = document.getElementById('void-vfx-overlay');
    if (!voidOverlay) {
        voidOverlay = document.createElement('div');
        voidOverlay.id = 'void-vfx-overlay';
        voidOverlay.className = 'void-overlay-vfx';
        document.body.appendChild(voidOverlay);
    }
    setTimeout(() => voidOverlay.classList.add('void-active'), 100);

    // 4. âš¡ ã€é–ƒé›»å¾ªç’°å•Ÿå‹•ã€‘
    if (window.berserkLightningTimer) clearInterval(window.berserkLightningTimer);
    window.berserkLightningTimer = setInterval(() => {
        if (!pokerGame.isBerserkKingActive) {
            clearInterval(window.berserkLightningTimer);
            return;
        }
        triggerLightningFlash();
    }, 4500);

    showNotification("ğŸ’€ <b style='color:#ff0000;'>DIABLO CLONE HAS WALKED THE KINGDOM.</b>");
    renderPokerTable(document.getElementById('poker-table'));
}

/**
 * âš¡ ç‰©ç†è¼”åŠ©ï¼šåœ°ç„é–ƒé›»ç‰¹æ•ˆ
 */
function triggerLightningFlash() {
    const flash = document.createElement('div');
    flash.style = `
        position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
        background: rgba(255, 255, 255, 0.3); z-index: 300000;
        pointer-events: none; opacity: 0; transition: opacity 0.05s;
    `;
    document.body.appendChild(flash);
    
    // é–ƒçˆåºåˆ—
    setTimeout(() => flash.style.opacity = "1", 50);
    setTimeout(() => flash.style.opacity = "0", 100);
    setTimeout(() => flash.style.opacity = "0.8", 150);
    setTimeout(() => {
        flash.style.opacity = "0";
        setTimeout(() => flash.remove(), 100);
    }, 200);
}

/**
 * ğŸ¨ ç‰©ç†æ¸²æŸ“ï¼šCanvas å¾®å‹ K ç·šç¹ªè£½ (æ¥µé€Ÿè¼•é‡ç‰ˆ)
 * å„ªåŒ–ï¼š
 * 1. ç§»é™¤æˆæœ¬ç·šç¹ªè£½ (äº¤çµ¦å°ˆæ¥­ç‰ˆè¦–çª—è™•ç†ï¼Œåˆ—è¡¨åƒ…éœ€ç´…è‰²é‚Šæ¡†è­¦ç¤º)ã€‚
 * 2. ç§»é™¤ ctx.save/restore èˆ‡è™›ç·šé‹ç®—ï¼Œå¤§å¹…æå‡åˆ—è¡¨æ»¾å‹• FPSã€‚
 * 3. å°ˆæ³¨æ–¼ "20K" è¶¨å‹¢çš„å¿«é€Ÿæ¸²æŸ“ã€‚
 */
function drawMiniKLine(canvasId, candles, count) {
    const canvas = document.getElementById(canvasId);
    // ç‰©ç†é˜²å‘†ï¼šæ•¸æ“šä¸è¶³ä¸ç¹ªè£½
    if (!canvas || !candles || candles.length < 2) return;
    
    // ğŸ”¥ å„ªåŒ–æŠ€ï¼šé—œé–‰ Alpha é€šé“ (å‡è¨­èƒŒæ™¯æ˜¯å¯¦è‰²)ï¼Œé¡¯è‘—æå‡æ¸²æŸ“æ•ˆèƒ½
    const ctx = canvas.getContext('2d', { alpha: false }); 
    const width = canvas.width;
    const height = canvas.height;

    // 1. æ•¸æ“šåˆ‡ç‰‡
    const data = candles.slice(-count);

    // 2. æ¥µé€Ÿè¨ˆç®—æ¥µå€¼ (å–®æ¬¡éæ­·)
    let maxH = -Infinity;
    let minL = Infinity;
    for (let i = 0; i < data.length; i++) {
        if (data[i].h > maxH) maxH = data[i].h;
        if (data[i].l < minL) minL = data[i].l;
    }

    // é‚Šç•Œç·©è¡ (10%)
    const padding = (maxH - minL) * 0.1;
    const viewMax = maxH + padding;
    const viewMin = minL - padding;
    const range = viewMax - viewMin || 1; // é˜²æ­¢é™¤ä»¥é›¶

    // æ¸…ç©ºç•«å¸ƒ (ä½¿ç”¨é»‘è‰²åº•ï¼Œå› ç‚ºé—œé–‰äº† Alpha)
    ctx.fillStyle = "#111"; 
    ctx.fillRect(0, 0, width, height);

    const step = width / data.length;
    const barWidth = Math.max(1, step - 1); // ç•™ 1px é–“éš™

    // 3. ç¹ªè£½å¾ªç’°
    for (let i = 0; i < data.length; i++) {
        const d = data[i];
        const isUp = d.c >= d.o;
        const color = isUp ? '#2ecc71' : '#e74c3c';

        // åæ¨™æ˜ å°„ (ä½¿ç”¨ | 0 å–ä»£ Math.floor æå‡æ•ˆèƒ½)
        const x = (i * step) | 0;
        const center = (x + barWidth / 2) | 0;
        const yOpen = (height - ((d.o - viewMin) / range * height)) | 0;
        const yClose = (height - ((d.c - viewMin) / range * height)) | 0;
        const yHigh = (height - ((d.h - viewMin) / range * height)) | 0;
        const yLow = (height - ((d.l - viewMin) / range * height)) | 0;

        ctx.fillStyle = color;
        ctx.strokeStyle = color;
        ctx.lineWidth = 1;

        // A. ç¹ªè£½å½±ç·š (High - Low)
        ctx.beginPath();
        ctx.moveTo(center, yHigh);
        ctx.lineTo(center, yLow);
        ctx.stroke();

        // B. ç¹ªè£½å¯¦é«” (Open - Close)
        const bodyHeight = Math.max(1, Math.abs(yClose - yOpen));
        ctx.fillRect(x, Math.min(yOpen, yClose), barWidth, bodyHeight);
    }
}


/**
 * ğŸ’¸ è‚¡å¸‚äº¤æ˜“æ ¸å¿ƒ (é‚è¼¯å±¤ï¼šæ¯€æ»…å°ç¬¦ç‰¹æ¬Šç‰ˆ)
 * ä¿®æ­£ï¼š
 * 1. æ”¯æ´å½ˆæ€§è‚¡æ•¸ï¼šæ¥æ”¶ä»»æ„ amountï¼Œä¸å†å¯«æ­» 100/1000ã€‚
 * 2. ç¨…ç‡ç‰¹æ¬Šï¼šæŒæœ‰ã€Œæ¯€æ»…å°ç¬¦ã€ç¨…ç‡é™è‡³ 1%ã€‚
 * 3. æˆæœ¬è¨ˆç®—ï¼šè²·å…¥æ™‚åŸ·è¡ŒåŠ æ¬Šå¹³å‡ï¼Œè³£å‡ºæ™‚è¨ˆç®—å¯¦æ™‚æç›Šã€‚
 */
function tradeStock(id, amount) {
    const stock = window.kingdomStocks.find(s => s.id === id);
    if (!stock) return;

    // ğŸ”¥ ã€ç‰©ç†æ¬Šé™æª¢æŸ¥ã€‘æª¢æ¸¬å‹‡è€…æ˜¯å¦æŒæœ‰ã€Œæ¯€æ»…å°ç¬¦ã€
    // æŒæœ‰è€…äº«å— 1% ä½ç¨…ç‡ï¼Œå¦å‰‡ç‚º 5%
    const hasAnnihilus = player.inventory.includes("ğŸ’ æ¯€æ»…å°ç¬¦ (Annihilus)");
    const taxRate = hasAnnihilus ? 0.01 : 0.05;
    
    const price = stock.price;
    const totalValue = price * Math.abs(amount);
    const tax = Math.floor(totalValue * taxRate); 
    const sys = window.kingdomSystem;

    if (amount > 0) { 
        // --- ğŸŸ¢ è²·å…¥é‚è¼¯ ---
        if (player.coin < totalValue) { 
            showNotification("ğŸ’€ è³‡é‡‘ä¸è¶³ï¼"); 
            return; 
        }
        
        // ç‰©ç†é‡‘æµæ‰£é™¤
        player.coin -= totalValue;
        
        // è¨ˆç®—ç‰©ç†å¹³å‡æˆæœ¬ (åŠ æ¬Šå¹³å‡æ³•)
        const oldOwned = stock.owned || 0;
        const oldAvgCost = stock.avgCost || 0;
        
        const newTotalOwned = oldOwned + amount;
        // ç¸½æˆæœ¬ = èˆŠç¸½æˆæœ¬ + æœ¬æ¬¡å¸‚å€¼
        const newTotalCost = (oldAvgCost * oldOwned) + totalValue;
        
        stock.avgCost = Math.floor(newTotalCost / newTotalOwned);
        stock.owned = newTotalOwned;

        const taxMsg = hasAnnihilus ? `<span style="color:#9b59b6;">[æ¯€æ»…ç‰¹æ¬Š 1%]</span>` : `[ç¨…ç‡ 5%]`;
        addBattleLog(`ğŸ“ˆ <b style="color:#2ecc71;">[è‚¡å¸‚]</b> è²·å…¥ ${amount} è‚¡ ${stock.name}ï¼Œå¹³å‡æˆæœ¬ï¼š$${stock.avgCost} G ${taxMsg}`);

    } else { 
        // --- ğŸ”´ è³£å‡ºé‚è¼¯ ---
        const sellAmount = Math.abs(amount);
        if ((stock.owned || 0) < sellAmount) { 
            showNotification("ğŸ’€ æŒè‚¡ä¸è¶³ï¼"); 
            return; 
        }

        // å¯¦æ”¶é‡‘é¡ = ç¸½åƒ¹å€¼ - äº¤æ˜“ç¨…
        const netProceeds = totalValue - tax;
        player.coin += netProceeds;
        stock.owned -= sellAmount;

        // ç‰©ç†æç›Šè¨ˆç®—
        const profit = netProceeds - (stock.avgCost * sellAmount);
        const profitColor = profit >= 0 ? '#2ecc71' : '#e74c3c';
        const taxMsg = hasAnnihilus ? `<span style="color:#9b59b6;">(å·²äº« 1% ä½ç¨…)</span>` : `(æ‰£é™¤ 5% ç¨…)`;
        
        addBattleLog(`ğŸ“‰ <b style="color:#e74c3c;">[è‚¡å¸‚]</b> å‡ºå”® ${sellAmount} è‚¡ ${stock.name}ï¼Œæç›Šï¼š<b style="color:${profitColor};">$${profit} G</b> ${taxMsg}`);

        // æ¸…å€‰é‡ç½®æˆæœ¬
        if (stock.owned <= 0) {
            stock.owned = 0;
            stock.avgCost = 0;
        }
    }

    // ğŸ›ï¸ åœ‹åº«ç‰©ç†æ³¨å…¥ (ä¾†è‡ªäº¤æ˜“ç¨…)
    sys.treasury = (sys.treasury || 0) + tax;

    // --- ğŸ¨ ç‰©ç†åŒæ­¥æ¸²æŸ“éˆ ---
    // 1. åˆ·æ–°èƒŒæ™¯çš„è‚¡ç¥¨åˆ—è¡¨
    if (typeof renderStockContent === 'function') renderStockContent();
    
    // 2. åˆ·æ–°ç©å®¶é‡‘å¹£ UI
    if (typeof updatePlayerUI === 'function') updatePlayerUI();      
    
    // 3. åˆ·æ–°é‡‘èä¸­å¿ƒé ‚éƒ¨æ•¸æ“š
    const modal = document.getElementById('financial-modal');
    if (modal) {
        const cashDisplay = modal.querySelector('div[style*="text-align:right"]');
        if (cashDisplay) {
            cashDisplay.innerHTML = `
                <div style="font-size:12px; color:#fff;">ç¾é‡‘: $${player.coin.toLocaleString()} G</div>
                <div style="font-size:10px; color:#888;">åœ‹åº«å„²å‚™: $${sys.treasury.toLocaleString()} G</div>
            `;
        }
    }
    
    // 4. ç‰©ç†å­˜æª”
    if (typeof savePlayerToDB === 'function') savePlayerToDB();
}

// --- ğŸ¨ ç‰©ç†æ³¨å…¥ï¼šå°ˆæ¥­è‚¡å¸‚æ¨£å¼ ---
if (!document.getElementById('pro-stock-css')) {
    const style = document.createElement('style');
    style.id = 'pro-stock-css';
    style.innerHTML = `
        /* è©³æƒ…è¦–çª—å®¹å™¨ */
        #stock-detail-modal {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 95%; max-width: 600px; background: #0b0b0b; 
            border: 2px solid #f1c40f; border-radius: 12px;
            z-index: 210000; display: flex; flex-direction: column;
            box-shadow: 0 0 80px rgba(0,0,0,1); color: #eee;
            font-family: 'Consolas', monospace; overflow: hidden;
            animation: popupFadeIn 0.2s ease-out;
        }

        /* Kç·šåœ–ç•«å¸ƒå®¹å™¨ */
        .chart-container {
            position: relative; height: 300px; width: 100%;
            background: #111; border-bottom: 1px solid #333;
            cursor: crosshair;
        }

        /* é ‚éƒ¨è³‡è¨Šåˆ— */
        .stock-header {
            padding: 15px; background: #1a1a1a; 
            border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center;
        }

        /* æ™‚é–“åˆ‡æ›æŒ‰éˆ• */
        .timeframe-bar {
            display: flex; gap: 2px; padding: 5px; background: #111; border-bottom: 1px solid #333;
        }
        .tf-btn {
            flex: 1; background: #222; border: none; color: #888; 
            padding: 8px; cursor: pointer; font-size: 12px; font-weight: bold;
        }
        .tf-btn.active { background: #333; color: #f1c40f; border-bottom: 2px solid #f1c40f; }

        /* äº¤æ˜“æ“ä½œå€ */
        .trade-panel {
            padding: 15px; background: #111; display: flex; flex-direction: column; gap: 10px;
        }
        .trade-row { display: flex; gap: 10px; align-items: center; }
        
        .trade-input {
            flex: 1; background: #000; border: 1px solid #444; color: #fff; 
            padding: 10px; font-size: 16px; border-radius: 4px; text-align: right;
        }
        
        .action-btn {
            flex: 1; padding: 12px; border: none; border-radius: 4px; 
            font-weight: bold; font-size: 14px; cursor: pointer; transition: 0.2s;
        }
        .btn-buy { background: #2ecc71; color: #000; }
        .btn-sell { background: #e74c3c; color: #fff; }
        .btn-buy:hover { filter: brightness(1.2); }
        .btn-sell:hover { filter: brightness(1.2); }
        
        /* åå­—æº–æ˜Ÿè³‡è¨Š (Tooltip) */
        .chart-tooltip {
            position: absolute; top: 5px; left: 5px; 
            background: rgba(0,0,0,0.6); padding: 4px 8px; border-radius: 4px;
            font-size: 10px; pointer-events: none; display: none; border: 1px solid #555;
        }
    `;
    document.head.appendChild(style);
}


/**
 * ğŸ“Š äº¤æ˜“æ‰€å…§å®¹æ¸²æŸ“ (V5.9.6 é˜²ç«ç·šé€£å‹•ç‰ˆ)
 * ä¿®æ­£é»ï¼š
 * 1. æ•‘å¸‚è¦–è¦ºï¼šåµæ¸¬ s.isProtectedï¼Œå¯¦è£é‡‘é‚Šèˆ‡é˜²ç¦¦ç›¾ç‰Œæ¨™è¨˜ã€‚ [cite: 2026-02-06]
 * 2. ä½ˆå±€åŠ å›ºï¼šçµ±ä¸€æ©«å‘ä½ˆå±€å¯¬åº¦ï¼Œè§£æ±ºæ–‡å­—æº¢å‡ºå•é¡Œã€‚ [cite: 2026-02-05]
 * 3. æ¸²æŸ“æ•ˆèƒ½ï¼šç¶­æŒ requestAnimationFrame ç­–ç•¥ï¼Œåƒ…è™•ç† 20 æ ¹ K ç·šã€‚
 */
function renderStockContent() {
    const container = document.getElementById('fin-content-area');
    if (!container || !window.kingdomStocks) return;

    // ç‰©ç†æ˜ å°„ï¼šå°‡æ•¸æ“šè½‰æ›ç‚ºé«˜å°æ¯”å¡ç‰‡
    container.innerHTML = window.kingdomStocks.map(s => {
        const change = s.lastChange || 0;
        const color = change >= 0 ? '#2ecc71' : '#e74c3c';
        const sign = change >= 0 ? '+' : '';
        const owned = s.owned || 0;
        const avgCost = s.avgCost || 0;
        
        // 1. ç‰©ç†è­¦å ±åˆ¤å®š (è™§æç´…æ¡† vs æ•‘å¸‚é‡‘æ¡†)
        const isUnderCost = owned > 0 && s.price < avgCost;
        const profit = owned > 0 ? (s.price - avgCost) * owned : 0;
        const profitColor = profit >= 0 ? '#2ecc71' : '#ff4d4d';

        // ğŸ”¥ ã€æ ¸å¿ƒä¿®æ­£ï¼šç‰©ç†é˜²ç«ç·šå¤–è§€ã€‘
        // å„ªå…ˆåºï¼šå—ä¿è­·(é‡‘) > è™§æä¸­(ç´…) > å¸¸è¦(æ·±ç°)
        let borderStyle = `1px solid #333`;
        if (s.isProtected) {
            borderStyle = `2px solid #f1c40f`;
        } else if (isUnderCost) {
            borderStyle = `1px solid #ff4d4d`;
        }

        return `
            <div onclick="openStockDetail('${s.id}')" 
                 style="cursor:pointer; background:rgba(255,255,255,0.02); padding:12px; margin-bottom:8px; border-radius:10px; border:${borderStyle}; display:flex; align-items:center; gap:12px; transition:0.2s; position:relative; overflow:hidden;" 
                 onmouseover="this.style.background='rgba(255,255,255,0.05)'" 
                 onmouseout="this.style.background='rgba(255,255,255,0.02)'">
                
                <div style="width: 85px; flex-shrink: 0;">
                    <div style="font-weight:900; font-size:14px; color:#fff; display:flex; align-items:center; gap:4px;">
                        ${s.name}
                        ${s.isProtected ? '<span style="color:#f1c40f; font-size:10px;" title="ç‹åœ‹é‡‘ç›¾é˜²ç«ç·šå•Ÿå‹•ä¸­">ğŸ›¡ï¸</span>' : ''}
                    </div>
                    <div style="font-size:10px; color:#666; font-family:monospace;">${s.id}</div>
                </div>

                <div style="flex:1; height:40px; position:relative;">
                    <canvas id="cvs-list-${s.id}" width="120" height="40" style="width:100%; height:100%; filter: ${s.isProtected ? 'drop-shadow(0 0 2px #f1c40f)' : 'none'};"></canvas>
                </div>

                <div style="text-align:right; width: 90px; flex-shrink: 0;">
                    <div style="font-family:monospace; font-size:14px; font-weight:bold; color:#fff;">$${s.price.toLocaleString()}</div>
                    <div style="font-size:11px; color:${color}; font-weight:bold;">${sign}${change}</div>
                </div>
                
                ${owned > 0 ? `
                    <div style="font-size:10px; background:rgba(0,0,0,0.4); padding:4px 8px; border-radius:6px; text-align:right; min-width:65px; border:1px solid #444;">
                        <div style="color:#f1c40f; font-weight:900;">${owned} è‚¡</div>
                        <div style="color:${profitColor}; font-family:monospace;">${(profit / (avgCost * owned) * 100).toFixed(1)}%</div>
                    </div>
                ` : ''}
                
                ${s.isProtected ? `<div style="position:absolute; top:0; left:0; width:100%; height:100%; background:linear-gradient(90deg, rgba(241,196,15,0.05) 0%, transparent 100%); pointer-events:none;"></div>` : ''}
            </div>`;
    }).join('');

    // ğŸ¬ ç‰©ç†åŸ·è¡Œ Canvas ç¹ªåœ–éˆè·¯
    requestAnimationFrame(() => {
        window.kingdomStocks.forEach(s => {
            if (s.candles && s.candles.length >= 2) {
                if (typeof drawMiniKLine === 'function') {
                    // é–å®š 20 æ ¹ K ç·šä»¥å„ªåŒ–æ²å‹•æ•ˆèƒ½
                    drawMiniKLine(`cvs-list-${s.id}`, s.candles, 20);
                }
            }
        });
    });
}


// è¼”åŠ©ï¼šè¨ˆç®—ç¸½æŠ•è³‡é¡ (é˜²å‘†é™¤ä»¥0)
function totalInvestment(s) {
    return (s.avgCost * s.owned) || 1;
}


/**
 * ğŸ“ˆ æ‰“é–‹å°ˆæ¥­è‚¡å¸‚è©³æƒ…è¦–çª—
 */
function openStockDetail(stockId) {
    currentDetailStockId = stockId;
    const stock = window.kingdomStocks.find(s => s.id === stockId);
    if (!stock) return;

    // 1. ç§»é™¤èˆŠè¦–çª—
    const existing = document.getElementById('stock-detail-modal');
    if (existing) existing.remove();

    // 2. æ§‹å»º DOM
    const modal = document.createElement('div');
    modal.id = 'stock-detail-modal';
    
    // è¨ˆç®—æç›Š
    const owned = stock.owned || 0;
    const avg = stock.avgCost || 0;
    const profit = (stock.price - avg) * owned;
    const profitClass = profit >= 0 ? '#2ecc71' : '#e74c3c';

    modal.innerHTML = `
        <div class="stock-header">
            <div>
                <b style="font-size:18px; color:#fff;">${stock.name}</b> <span style="color:#666;">${stock.id}</span>
                <div style="font-size:10px; color:#aaa; margin-top:4px;">${stock.category} Sector</div>
            </div>
            <div style="text-align:right;">
                <div style="font-size:24px; font-weight:bold; font-family:monospace;">$${stock.price}</div>
                <div style="color:${stock.lastChange >= 0 ? '#2ecc71' : '#e74c3c'}; font-size:12px;">
                    ${stock.lastChange >= 0 ? 'â–²' : 'â–¼'} ${stock.lastChange}
                </div>
            </div>
            <button onclick="closeStockDetail()" style="background:none; border:none; color:#666; font-size:20px; cursor:pointer;">âœ•</button>
        </div>

        <div class="timeframe-bar">
            <button class="tf-btn" onclick="switchTimeframe(5)" id="btn-tf-5">5K</button>
            <button class="tf-btn active" onclick="switchTimeframe(20)" id="btn-tf-20">20K</button>
            <button class="tf-btn" onclick="switchTimeframe(60)" id="btn-tf-60">60K</button>
        </div>

        <div class="chart-container">
            <canvas id="pro-kline-chart" width="600" height="300" style="width:100%; height:100%;"></canvas>
            <div id="chart-tooltip" class="chart-tooltip"></div>
        </div>

        <div style="padding:10px; background:#1a1a1a; font-size:11px; display:flex; justify-content:space-between; color:#aaa;">
            <span>æŒæœ‰æ•¸é‡: <b style="color:#fff;">${owned}</b></span>
            <span>å¹³å‡æˆæœ¬: $${avg}</span>
            <span>æœªå¯¦ç¾æç›Š: <b style="color:${profitClass};">$${profit.toLocaleString()}</b></span>
        </div>

        <div class="trade-panel">
            <div class="trade-row">
                <input type="number" id="trade-amount-input" class="trade-input" placeholder="è¼¸å…¥è‚¡æ•¸" value="100">
                <button onclick="setTradeAmount(${owned})" style="background:#333; color:#aaa; border:none; padding:10px; border-radius:4px; cursor:pointer; font-size:10px;">MAX</button>
            </div>
            <div class="trade-row">
                <button class="action-btn btn-buy" onclick="executeTrade('buy')">è²·å…¥ (Buy)</button>
                <button class="action-btn btn-sell" onclick="executeTrade('sell')">è³£å‡º (Sell)</button>
            </div>
            <div style="font-size:10px; color:#666; text-align:center;">
                ç¾é‡‘é¤˜é¡: $${player.coin.toLocaleString()}
            </div>
        </div>
    `;

    document.body.appendChild(modal);
    
    // 3. åˆå§‹æ¸²æŸ“ K ç·š
    requestAnimationFrame(() => renderProChart());
}

function closeStockDetail() {
    const el = document.getElementById('stock-detail-modal');
    if (el) el.remove();
}

function switchTimeframe(tf) {
    currentDetailTimeframe = tf;
    document.querySelectorAll('.tf-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(`btn-tf-${tf}`).classList.add('active');
    renderProChart();
}

function setTradeAmount(val) {
    document.getElementById('trade-amount-input').value = val;
}

/**
 * ğŸ¨ å°ˆæ¥­ç¹ªåœ–å¼•æ“ï¼šç¹ªè£½ K ç·š + å‡ç·š + åå­—ç·š
 */
function renderProChart() {
    const canvas = document.getElementById('pro-kline-chart');
    if (!canvas) return;
    
    const stock = window.kingdomStocks.find(s => s.id === currentDetailStockId);
    if (!stock || !stock.candles) return;

    // 1. æ•¸æ“šåˆ‡ç‰‡ (æ ¹æ“š Timeframe)
    const data = stock.candles.slice(-currentDetailTimeframe);
    if (data.length < 2) return;

    drawProfessionalKLine(canvas, data);
}

/**
 * ğŸ–Œï¸ æ ¸å¿ƒç¹ªåœ–é‚è¼¯ (æ¯” Mini æ›´ç²¾ç´°)
 */
function drawProfessionalKLine(canvas, data) {
    const ctx = canvas.getContext('2d');
    const w = canvas.width;
    const h = canvas.height;

    // æ¸…ç©º
    ctx.clearRect(0, 0, w, h);
    ctx.fillStyle = "#111";
    ctx.fillRect(0, 0, w, h);

    // è¨ˆç®—æ¥µå€¼ (åŒ…å« MA ç·šçš„ç¯„åœ)
    let maxPrice = -Infinity;
    let minPrice = Infinity;
    
    // ç²å–åŸå§‹è‚¡ç¥¨æ•¸æ“šè¨ˆç®— MA
    const stock = window.kingdomStocks.find(s => s.id === currentDetailStockId);

    // è¨ˆç®— MA (ç°¡å–®ç§»å‹•å¹³å‡)
    const ma5 = calculateMA(stock.candles, 5).slice(-currentDetailTimeframe);
    const ma10 = calculateMA(stock.candles, 10).slice(-currentDetailTimeframe);

    data.forEach(d => {
        if (d.h > maxPrice) maxPrice = d.h;
        if (d.l < minPrice) minPrice = d.l;
    });
    
    // æ“´å±•æ¥µå€¼ä»¥å®¹ç´ MA ç·š
    [...ma5, ...ma10].forEach(v => {
        if (v) {
            if (v > maxPrice) maxPrice = v;
            if (v < minPrice) minPrice = v;
        }
    });

    // é‚Šè·ç·©è¡
    const padding = (maxPrice - minPrice) * 0.1;
    maxPrice += padding;
    minPrice -= padding;
    const priceRange = maxPrice - minPrice;

    // æ˜ å°„ Y è»¸
    const getY = (p) => h - ((p - minPrice) / priceRange * h);
    
    // ç¹ªè£½ç¶²æ ¼
    ctx.strokeStyle = "#222";
    ctx.lineWidth = 1;
    ctx.beginPath();
    for (let i = 1; i < 5; i++) {
        const y = h * (i / 5);
        ctx.moveTo(0, y);
        ctx.lineTo(w, y);
    }
    ctx.stroke();

    // ç¹ªè£½ K ç·š
    const candleW = w / data.length;
    const gap = candleW * 0.2;
    const barW = candleW - gap;

    data.forEach((d, i) => {
        const x = i * candleW + (gap / 2);
        const yO = getY(d.o);
        const yC = getY(d.c);
        const yH = getY(d.h);
        const yL = getY(d.l);

        const isUp = d.c >= d.o;
        const color = isUp ? '#2ecc71' : '#e74c3c'; // ç¶ æ¼²ç´…è·Œ (åŠ å¯†è²¨å¹£/ç¾è‚¡é¢¨æ ¼)

        ctx.fillStyle = color;
        ctx.strokeStyle = color;

        // å½±ç·š
        ctx.beginPath();
        ctx.moveTo(x + barW/2, yH);
        ctx.lineTo(x + barW/2, yL);
        ctx.stroke();

        // å¯¦é«”
        const bodyH = Math.max(1, Math.abs(yC - yO));
        ctx.fillRect(x, Math.min(yO, yC), barW, bodyH);
    });

    // ç¹ªè£½ MA ç·š
    drawLine(ctx, ma5, w, getY, '#f1c40f'); // MA5 é»ƒè‰²
    drawLine(ctx, ma10, w, getY, '#3498db'); // MA10 è—è‰²
}

// è¼”åŠ©ï¼šç¹ªè£½æŠ˜ç·š
function drawLine(ctx, dataArr, w, getY, color) {
    if (dataArr.length === 0) return;
    const step = w / dataArr.length;
    ctx.beginPath();
    ctx.strokeStyle = color;
    ctx.lineWidth = 2;
    
    dataArr.forEach((val, i) => {
        if (!val) return;
        const x = i * step + (step / 2);
        const y = getY(val);
        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
    });
    ctx.stroke();
}

// è¼”åŠ©ï¼šè¨ˆç®— MA
function calculateMA(candles, period) {
    let result = [];
    for (let i = 0; i < candles.length; i++) {
        if (i < period - 1) {
            result.push(null);
            continue;
        }
        let sum = 0;
        for (let j = 0; j < period; j++) sum += candles[i - j].c;
        result.push(sum / period);
    }
    return result;
}

/**
 * ğŸ’¸ åŸ·è¡Œäº¤æ˜“ (å½ˆæ€§è‚¡æ•¸ç‰ˆ)
 */
function executeTrade(type) {
    const input = document.getElementById('trade-amount-input');
    let amount = parseInt(input.value);

    if (isNaN(amount) || amount <= 0) {
        showNotification("âš ï¸ è«‹è¼¸å…¥æœ‰æ•ˆçš„è‚¡æ•¸");
        return;
    }

    // è³£å‡ºè½‰ç‚ºè² æ•¸
    if (type === 'sell') amount = -amount;

    // å‘¼å«åŸæœ¬çš„äº¤æ˜“å‡½æ•¸
    if (typeof tradeStock === 'function') {
        tradeStock(currentDetailStockId, amount);
        
        // äº¤æ˜“å¾Œåˆ·æ–°è©³æƒ…é æ•¸æ“š
        // å°æŠ€å·§ï¼šç¨å¾®å»¶é²ä¸€ä¸‹ç­‰å¾… tradeStock å®Œæˆ
        setTimeout(() => {
            const el = document.getElementById('stock-detail-modal');
            if (el) openStockDetail(currentDetailStockId); // é‡æ–°æ¸²æŸ“ä»¥æ›´æ–°æŒå€‰æ•¸æ“š
        }, 100);
    }
}


/**
 * ğŸº ç‰©ç†å­ç¨‹åºï¼šé–‹å•Ÿåäººå ‚ä¸¦æ¸²æŸ“ã€ç¥è©±ç´šã€‘ç¢‘æ–‡
 */
async function openHallOfFame() {
    const existing = document.getElementById('hall-of-fame-modal');
    if (existing) existing.remove();

    // 1. ç‰©ç†ç²å–è³‡æ–™åº«æ•¸æ“š (ä¾æ™‚é–“å€’åºæ’)
    const records = await db.hallOfFame.reverse().toArray();

    const modal = document.createElement('div');
    modal.id = "hall-of-fame-modal";
    modal.style = `
        position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
        width: 420px; height: 550px; background: #050505; border: 2px solid #8b4513;
        padding: 30px; z-index: 140000; border-radius: 12px; color: #d4af37;
        box-shadow: 0 0 120px rgba(0,0,0,1), inset 0 0 40px rgba(139,69,19,0.4);
        font-family: 'serif', 'Noto Serif TC', serif; display: flex; flex-direction: column;
        animation: modalScaleUp 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    `;

    // 2. ğŸ”¥ ã€ç‰©ç†æ¸²æŸ“å¼•æ“ï¼šå…¨åŸŸæ•¸æ“šå°é½Šç‰ˆã€‘
    const listHTML = records.length > 0 ? records.map(r => {
        // --- æ ¸å¿ƒä¿®æ­£é»ï¼šå¼•ç”¨å…¨åŸŸå”¯ä¸€çœŸç†ä¾†æº (getKingTitleData) ---
        // æˆ‘å€‘æ ¹æ“šè©²ç´€éŒ„ç•¶æ™‚çš„å·”å³°é€£èŠæ•¸ (maxStreak) ä¾†æª¢ç´¢å°æ‡‰çš„è¦–è¦ºå±¬æ€§
        const kTitle = getKingTitleData(r.maxStreak); 
        
        // åˆ¤å®šæ˜¯å¦é”åˆ°ç¥çš‡ä½éš (100é€£å‹)
        const isGod = r.maxStreak >= 100;
        
        // ğŸ¨ ç‰©ç†æ˜ å°„ï¼šç›´æ¥å¾å…¨åŸŸè¨­å®šæª”æå–é¡è‰²èˆ‡å…‰æšˆ
        const titleStyle = `color: ${kTitle.color}; text-shadow: ${kTitle.glow};`;
        const blockClass = isGod ? "hall-god-entry" : "";

        return `
        <div class="${blockClass}" style="border-bottom: 1px solid #221100; padding: 20px 10px; position: relative; transition: 0.3s;">
            <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:10px;">
                <div style="flex: 1;">
                    <b style="font-size: 16px; ${titleStyle}">${r.title}</b>
                    <div style="font-size: 10px; color: #666; margin-top: 4px; font-family: monospace;">LV.${r.lv} | RECORDED ON ${r.date}</div>
                </div>
                ${isGod ? '<div style="font-size: 24px; filter: drop-shadow(0 0 10px gold); animation: float 3s infinite ease-in-out;">ğŸŒŒ</div>' : ''}
            </div>
            
            <div style="line-height:1.7; color:#bbb; font-size: 13px;">
                <span style="color:#d4af37; opacity:0.8;">âš”ï¸ å¾æœæ¬¡æ•¸ï¼š</span>${r.totalWins} å‹<br>
                <span style="color:#d4af37; opacity:0.8;">ğŸ”¥ å·”å³°é€£èŠï¼š</span><b style="color:#fff;">${r.maxStreak} æ¬¡</b><br>
                <span style="color:#d4af37; opacity:0.8;">ğŸ’° çµ‚ç„‰è²¡å¯Œï¼š</span>${r.totalLoot.toLocaleString()} G<br>
                <span style="color:#d4af37; opacity:0.8;">ğŸ“œ å‘½é‹çµ‚é»ï¼š</span><span style="color:#e74c3c; font-style:italic;">"${r.deathCause}"</span>
            </div>
        </div>
    `}).join('') : '<p style="text-align:center; color:#444; margin-top:15px; letter-spacing:2px;">ç‹åœ‹è’è•ªï¼Œå°šç„¡äººç•™ä¸‹å‚³å¥‡...</p>';

    modal.innerHTML = `
        <h2 style="text-align:center; color:#8b4513; margin:0 0 25px 0; letter-spacing:8px; border-bottom: 1px double #8b4513; padding-bottom: 15px;">ğŸ›ï¸ æ°¸æ†åäººå ‚</h2>
        <div id="hall-scroll-area" style="flex:1; overflow-y:auto; padding-right:12px; scrollbar-width: thin;">
            ${listHTML}
        </div>
        <button onclick="this.parentElement.remove()" style="width:100%; margin-top:25px; padding:15px; background:linear-gradient(to bottom, #2a180c, #1a0f08); color:#8b4513; border:1px solid #8b4513; cursor:pointer; font-weight:bold; font-size: 16px; letter-spacing:3px; transition:0.2s;" 
                onmouseover="this.style.color='#f1c40f'; this.style.borderColor='#f1c40f';" 
                onmouseout="this.style.color='#8b4513'; this.style.borderColor='#8b4513';">
            ç‰©ç†æ€§é—”ä¸Šå²å†Š
        </button>

        <style>
            @keyframes modalScaleUp {
                from { opacity: 0; transform: translate(-50%, -40%) scale(0.9); }
                to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            }
            @keyframes float {
                0%, 100% { transform: translateY(0); }
                50% { transform: translateY(-5px); }
            }
            #hall-scroll-area::-webkit-scrollbar { width: 5px; }
            #hall-scroll-area::-webkit-scrollbar-track { background: transparent; }
            #hall-scroll-area::-webkit-scrollbar-thumb { background: #332211; border-radius: 10px; }
            
            .hall-god-entry {
                background: linear-gradient(90deg, rgba(255,255,255,0.03) 0%, transparent 100%);
                border-left: 3px solid #fff !important;
                box-shadow: inset 20px 0 30px rgba(241,196,15,0.05);
            }
        </style>
    `;

    document.body.appendChild(modal);
}

/**
 * ğŸ† çµ‚æ¥µä¿®æ­£ç‰ˆï¼šè¡€è…¥ç‹åœ‹çµç®—ç¸½èª¿åº¦ä¸­æ¨ (V5.9.15 å®Œå…¨å°æ­£ç‰ˆ)
 * ä½œç”¨ï¼šæŒ‰é †åºèª¿åº¦æ•¸æ“šæ¸…ç®—ã€è³‡ç”¢è½‰ç§»ã€ç’°å¢ƒæ¢å¾©èˆ‡é ‚å±¤ UI æ¸²æŸ“
 * ä¿®æ­£ï¼š
 * 1. é™£åˆ—åŒ–æ‰å¯¶ï¼šå°æ‡‰ loots é™£åˆ—ï¼Œè§£æ±ºå–®ä¸€å­—ä¸²å°è‡´çš„å¤šæ¨£ç‰©å“éºå¤±å•é¡Œã€‚ [cite: 2026-02-06]
 * 2. åˆ©æ¯ç¢ºæ¬Šï¼šç²¾ç¢ºè§£æ§‹ interestAmount ä¸¦å‚³éè‡³æ¸²æŸ“å±¤ã€‚ [cite: 2026-02-06]
 * 3. åº§æ¨™é˜²ç¦¦ï¼šç¶­æŒ restoreWorld ç‰©ç†å„ªå…ˆç´šï¼Œè§£æ±º 259px åç§»å•é¡Œã€‚ [cite: 2026-02-05]
 */
async function finishPokerGame(winner) {
    // 1. ğŸ”¥ ã€ç‰©ç†å®‰å…¨é–€è¡›ã€‘é–å®šçµç®—ç‹€æ…‹ï¼Œé˜²æ­¢ç•°æ­¥é‡ç–Šè§¸ç™¼
    if (!PokerSettlementSystem.init()) return;

    // 2. ğŸŒ ã€åº§æ¨™é‚„åŸã€‘ç‰©ç†ç§»é™¤æ¿¾é¡ï¼Œç¢ºä¿ fixed è¦–çª—å®šä½æ–¼è¦–å£ä¸­å¿ƒ (0,0)
    PokerSettlementSystem.restoreWorld();

    // 3. ç²å–æ•¸æ“šåŸºæº–
    const hero = pokerGame.players.find(p => p.id === 'player');
    const oldRank = hero ? hero.rank : 'slave';
    
    // 4. âš–ï¸ ã€å‘½é‹é‡çµ„ã€‘ç‰©ç†è¨ˆç®—ä¸‹ä¸€å±€çš„ä½éšåˆ†é…
    const { newRanks } = PokerSettlementSystem.calculateNewRanks();

    // 5. ğŸ’° ã€è³‡ç”¢æ¸…ç®—ã€‘åŸ·è¡Œç´¯é€²æ‡²ç½°å…¬å¼èˆ‡æ˜å›è™•æ±º
    const { totalPenaltyPool, playerLoss } = PokerSettlementSystem.calculatePenalties(winner, oldRank);

    // 6. ğŸ‘¹ ã€äº‹ä»¶åˆ¤å®šã€‘è™•ç†ç‹‚æš´ç‹€æ…‹èˆ‡ç¥è©±æ‰è½
    const { isBerserkVictory, berserkLoot } = PokerSettlementSystem.processBerserkEvent(winner);

    // 7. ğŸ† ã€è´å®¶å›æµã€‘æ ¸å¿ƒæ•¸æ“šè™•ç†éˆè·¯ [cite: 2026-02-06]
    // ğŸ”¥ ã€æ ¸å¿ƒä¿®æ­£ã€‘å°æ‡‰ V5.9.13 å¼•æ“å›å‚³çš„ loots é™£åˆ—èˆ‡ interestAmount
    const { 
        finalWinAmount, 
        kingdomTax, 
        interestAmount, // ç”¢ç”Ÿçš„åˆ©æ¯
        loots           // ç²å¾—çš„æ‰€æœ‰ç‰©å“æ¸…å–®
    } = await PokerSettlementSystem.processWinner(
        winner, 
        totalPenaltyPool, 
        oldRank, 
        berserkLoot
    );

    // 8. ğŸ’¾ ã€æŒä¹…åŒ–ã€‘æ¸…ç©ºæš«æ…‹ä¸¦å°‡å…¨åŸŸè³‡ç”¢ç‰©ç†å¯«å…¥ IndexedDB
    await PokerSettlementSystem.cleanupAndSave(newRanks);

    // 9. ğŸ“º ã€çµ‚æ¥µæ¸²æŸ“ã€‘é»ç‡ƒé ‚å±¤å…¨åŸŸæ”¶æ“š UI [cite: 2026-01-21]
    // å‚³åƒå°é½Šï¼šç¢ºä¿ loots èˆ‡ interestAmount è¢«å‚³å…¥ renderVictoryUI
    PokerSettlementSystem.renderVictoryUI(
        winner, 
        finalWinAmount, 
        playerLoss, 
        isBerserkVictory, 
        kingdomTax, 
        totalPenaltyPool,
        loots,          // ç‰©ç†åƒæ•¸ï¼šå¤šé‡æ‰å¯¶é™£åˆ—
        interestAmount  // ç‰©ç†åƒæ•¸ï¼šé‡‘åº«è¤‡åˆ©
    );
}



/**
 * âš–ï¸ çµç®—ç³»çµ±æ ¸å¿ƒæ¨¡çµ„ï¼šç‰©ç†æ”¶æ”¯é€æ˜åŒ–å®Œå…¨ç‰ˆ (V5.9)
 * æ³¨æ„ï¼šæ­¤æ®µè½åŒ…å«ç‰©ä»¶çš„é–‹é ­èˆ‡æ ¸å¿ƒé‹ç®—é‚è¼¯
 */
const PokerSettlementSystem = {
    // 1. ğŸ åˆå§‹åŒ–èˆ‡ç‹€æ…‹é–
    init: function() {
        if (window.isGameEnding) return false;
        window.isGameEnding = true;
        pokerGame.gameActive = false;
        console.log("%cğŸ çµç®—ç¨‹åºé»ç«ï¼šé–å®šå…¨åŸŸç‹€æ…‹æˆåŠŸã€‚", "color: #2ecc71; font-weight: bold;");
        return true;
    },

    // 2. ğŸŒ ç’°å¢ƒé‚„åŸï¼šä¿®å¾© 259px åç§»
    restoreWorld: function() {
        if (window.berserkLightningTimer) clearInterval(window.berserkLightningTimer);
        const mainWrapper = document.querySelector('.main-wrapper');
        if (mainWrapper) {
            mainWrapper.style.filter = "none";
            mainWrapper.style.transform = "none";
        }
        const table = document.getElementById('poker-table');
        if (table) table.className = ""; 
    },

    // 3. ä½éšé‡æ–°æ˜ å°„
    calculateNewRanks: function() {
        const ranking = [...pokerGame.players].sort((a, b) => a.cards.length - b.cards.length);
        return { 
            newRanks: {
                [ranking[0].id]: "king", [ranking[1].id]: "noble",
                [ranking[2].id]: "citizen", [ranking[3].id]: "slave"
            }
        };
    },

    // 4. ğŸ”¥ æ‡²ç½°é‡‘æ¸…ç®—ï¼šåŒ…å« 5-10 å¼µç‰Œå€ç‡èˆ‡ç´°ç›®ç´€éŒ„
    calculatePenalties: function(winner, oldRank) {
        const baseRate = 30;
        let totalPenaltyPool = 0;
        let playerLoss = 0;
        let breakdown = []; 

        pokerGame.players.forEach(p => {
            if (p.id === winner.id) return;
            const count = p.cards.length;
            // ç´¯é€²å…¬å¼ï¼š10å¼µ4å€ / 5å¼µ2å€
            let penalty = (count >= 10) ? baseRate * count * 4 : (count >= 5 ? baseRate * count * 2 : baseRate * count);

            // æ˜å›è™•æ±ºæ¢æ¬¾
            if (p.id === 'player' && !!pokerGame.forceSiege && oldRank === 'king') {
                const siphoned = window.kingdomSystem?.lastSiphonedAmount || 0;
                penalty += Math.floor(siphoned * 2.0);
                window.kingdomSystem.lastSiphonedAmount = 0;
            }

            if (p.id === 'player') {
                playerLoss = penalty;
                player.coin -= penalty;
            } else {
                p.coins = (p.coins || 0) - penalty;
            }

            totalPenaltyPool += penalty;
            breakdown.push({ name: p.name, count: count, amount: penalty });
        });
        
        window.lastGameBreakdown = breakdown; 
        return { totalPenaltyPool, playerLoss };
    },

    // 5. ç‹‚æš´äº‹ä»¶è™•ç†
    processBerserkEvent: function(winner) {
        const isBerserk = !!pokerGame.isBerserkKingActive;
        let loot = null;
        if (isBerserk) {
            pokerGame.isBerserkKingActive = false;
            if (winner.id === 'player') {
                loot = "ğŸ’ æ¯€æ»…å°ç¬¦ (Annihilus)";
                if (!player.inventory.includes(loot)) player.inventory.push(loot);
            }
            // ç‹åœ‹å¤§èµ¦
            Object.keys(window.kingdomSystem.upgrades).forEach(k => {
                window.kingdomSystem.upgrades[k].lv = Math.min(1000, window.kingdomSystem.upgrades[k].lv + 5);
            });
        }
        return { isBerserkVictory: isBerserk, berserkLoot: loot };
    },

/**
 * ğŸ† 6. è´å®¶çµç®—ï¼šå¤šé‡æœåˆ®èˆ‡ç¶“æ¿Ÿæ•¸æ“šé–‰ç’° (V5.9.15 å®Œå…¨å°æ­£ç‰ˆ)
 * ä½œç”¨ï¼šæŒ‰é †åºåŸ·è¡Œç¨…æ”¶å¾µæ”¶ã€åˆ©æ¯æ¼”ç®—ã€ä¸‰éšå±¤æ‰å¯¶åˆ¤å®šèˆ‡æ•¸æ“šå°é–ã€‚
 * ä¿®æ­£é»ï¼š
 * 1. ç‰©ç†ç”Ÿæ¯åŒæ­¥ï¼šç¢ºä¿åˆ©æ¯è¨ˆç®—åŒ…å«æœ¬å±€ç¨…é‡‘æ”¶å…¥ã€‚
 * 2. å¤šé‡æœåˆ®ï¼šç”±å–®ä¸€ lootName å‡ç´šç‚º loots é™£åˆ—ï¼Œå–®å±€æœ€é«˜å¯ç² 3 æ¨£ç‰©è³‡ã€‚
 * 3. æ•¸æ“šå°é½Šï¼šç¢ºä¿ return ç‰©ä»¶éµåèˆ‡ renderVictoryUI åƒæ•¸å®Œå…¨ç‰©ç†ä¸€è‡´ã€‚
 */
processWinner: async function(winner, totalPool, oldRank, berserkLoot) {
    // --- A. ğŸ“Š ç¶“æ¿Ÿæ¸…ç®—å±¤ (ç‰©ç†æ³¨å…¥èˆ‡ç”Ÿæ¯) ---
    const kingdomTax = Math.floor(totalPool * 0.10);
    const finalWinAmount = totalPool - kingdomTax;
    
    // ğŸ›¡ï¸ ç‰©ç†é–å®šï¼šç¢ºä¿åœ‹åº«ç³»çµ±å·²åˆå§‹åŒ–
    if (!window.kingdomSystem) await ensureKingdomSystem();
    
    // 1. ç¨…é‡‘å¯¦é«”æ³¨å…¥
    window.kingdomSystem.treasury = (window.kingdomSystem.treasury || 0) + kingdomTax;
    
    // 2. ğŸ”¥ ã€ç‰©ç†åˆ©æ¯ç”¢ç”Ÿã€‘åœ¨ç¨…é‡‘æ³¨å…¥å¾ŒåŸ·è¡Œï¼Œé”æˆå³æ™‚è¤‡åˆ©
    const interestAmount = (typeof applyTreasuryInterest === 'function') ? applyTreasuryInterest() : 0;
    
    // 3. è¨­æ–½è‡ªå‹•æŠ•è³‡
    if (typeof distributeKingdomEconomy === 'function') {
        distributeKingdomEconomy(kingdomTax);
    }

    // --- B. ğŸ ç‰©ç†æœåˆ®å±¤ (ä¸‰éšå±¤æª¢å®šå¼•æ“) ---
    let loots = []; // ğŸ”¥ å‡ç´šç‚ºé™£åˆ—ï¼Œç¢ºä¿å¤šæ¨£æ‰è½
    
    // æ ¸å¿ƒåˆ¤å®šï¼šè‹¥æœ‰ç‹‚æš´åœ‹ç‹ä¿åº•æ‰è½ (å¦‚ Annihilus)ï¼Œå„ªå…ˆå…¥åº«
    if (berserkLoot) loots.push(berserkLoot);

    // è¨ˆç®—ç•¶å‰æ‰å¯¶å€ç‡ (åŸºç¤ 15% + é€£èŠ + è£å‚™å‹³ç« )
    const streak = player.kingStreak || 0;
    const equipBonus = (typeof calculateDropRateBonus === 'function') ? calculateDropRateBonus() : 0;
    const dropChance = 0.15 + (streak * 0.05) + equipBonus; 

    // ğŸ”¥ ã€ç‰©ç†åˆ¤å®š Iï¼šå¸¸è¦è»éœ€å“ã€‘
    if (Math.random() < dropChance) {
        const item1 = (typeof triggerPokerLoot === 'function') ? triggerPokerLoot(false) : null;
        if (item1) loots.push(item1);
    }

    // ğŸ”¥ ã€ç‰©ç†åˆ¤å®š IIï¼šé€£èŠç´…åˆ©ã€‘ (åœ‹ç‹é€£èŠ 3 æ¬¡ä»¥ä¸Šé»ç‡ƒé¡å¤–æœåˆ®)
    if (streak >= 3 && Math.random() < (dropChance * 0.6)) {
        const item2 = (typeof triggerPokerLoot === 'function') ? triggerPokerLoot(true) : null;
        if (item2) loots.push(item2);
    }

    // ğŸ”¥ ã€ç‰©ç†åˆ¤å®š IIIï¼šç‹‚æš´é¤˜éœ‡ã€‘ (åƒ…åœ¨ç‹‚æš´æ¨¡å¼ä¸‹æ¥µä½æ©Ÿç‡ç”¢ç”Ÿç¥å™¨ç¢ç‰‡)
    if (pokerGame.isBerserkKingActive && Math.random() < 0.08) {
        const artifacts = ["ğŸ‘‘ è¡€è…¥ç‹æ¬Šç¢ç‰‡", "ğŸ’ åœ‹ç‹çš„è²ªå©ªä¹‹å¿ƒ"];
        const item3 = artifacts[Math.floor(Math.random() * artifacts.length)];
        if (!player.inventory.includes(item3)) {
            player.inventory.push(item3);
            loots.push(item3);
        }
    }

    // --- C. ğŸ’° è³‡ç”¢æ¬Šé™å›æ”¶èˆ‡æ—¥èªŒ ---
    if (winner.id === 'player') {
        player.coin += finalWinAmount;
        // é€£èŠé‚è¼¯ä¿®æ­£ï¼šè‹¥åŸæœ¬å°±æ˜¯åœ‹ç‹ä¸”è´äº†ï¼Œå‰‡é€£èŠ+1ï¼Œå¦å‰‡å•Ÿå‹•æ–°çµ±æ²»
        player.kingStreak = (oldRank === 'king') ? (player.kingStreak + 1) : 1;
        
        const lootText = loots.length > 0 ? `ç²å¾—ç‰©è³‡: ${loots.join(', ')}` : "æœ¬æ¬¡ç„¡é¡å¤–ç‰©è³‡æœåˆ®";
        addBattleLog(`ğŸŠ å‹åˆ©ï¼ç²å¾—ç´”ç›Š $${finalWinAmount.toLocaleString()} Gï¼Œ${lootText}ã€‚`);
    } else {
        // AI è´å®¶æ•¸æ“šæ¨¡æ“¬
        winner.coins = (winner.coins || 0) + finalWinAmount;
        player.kingStreak = 0; 
    }

    // æ›´æ–°å…¨åŸŸ UI å¿«ç…§
    if (typeof updatePlayerUI === 'function') updatePlayerUI();
    
    // ğŸ§± ã€å¤§ä¸€çµ±å›å‚³ã€‘å°æµè‡³æ¸²æŸ“å±¤ (å¿…é ˆåŒ…å« interestAmount èˆ‡ loots)
    return { 
        finalWinAmount, 
        kingdomTax, 
        interestAmount, 
        loots,          // å‚³å›é™£åˆ—
        totalPool 
    };
},

    // 7. â™»ï¸ ç‰©ç†é‡ç½®èˆ‡å­˜æª” [cite: 2026-01-21]
    cleanupAndSave: async function(newRanks) {
        pokerGame.players.forEach(p => { 
            p.rank = newRanks[p.id]; p.cards = []; p.isPassed = false; 
        });
        pokerGame.lastMoveCards = [];
        pokerGame.lastMovePattern = null;
        pokerGame.isKingSiege = false;
        window.selectedCards = [];
        if (typeof savePlayerToDB === 'function') await savePlayerToDB();
    },

/**
     * ğŸ“º 8. æ¸²æŸ“é«˜ç´°ç¯€çµç®— UI (V5.9.13 ç‰©ç†æ”¶æ“šé‡æ•´ç‰ˆ)
     * ä¿®æ­£ï¼š
     * 1. å¤šé‡æ‰å¯¶ï¼šéæ­· loots é™£åˆ—ï¼Œç¢ºä¿å¤šæ¨£ç‰©å“åŒæ™‚é¡¯ç¾ã€‚
     * 2. ç”Ÿæ¯é¡¯ç¤ºï¼šæ–°å¢ã€Œé‡‘åº«ç•¶å±€ç”Ÿæ¯ã€æ˜ç´°ï¼Œå°é½Šç‰©ç†ç”Ÿæ¯å¼•æ“ã€‚ [cite: 2026-02-06]
     * 3. è¦–è¦ºéš”é›¢ï¼šå¼·åŒ–å°åº•å±¤å…ƒä»¶çš„æ§åˆ¶å›æ”¶ã€‚ [cite: 2026-01-19]
     */
    renderVictoryUI: function(winner, winAmount, playerLoss, isBerserkVictory, kingdomTax, totalPool, loots = [], interestAmount = 0) {
        const overlay = document.getElementById('victory-screen');
        if (!overlay) return;

        // 1. ğŸ›¡ï¸ ã€ç‰©ç†éš”é›¢ï¼šæ¬Šé™å›æ”¶ã€‘éš±è—æ“ä½œå…ƒä»¶ï¼Œé˜²æ­¢é»æ“Šç©¿é€èƒŒæ™¯
        const controls = ['player-hand', 'btn-poker-act', 'btn-poker-pass', 'poker-helper-bar', 'player-interaction-wrapper'];
        controls.forEach(id => {
            const el = document.getElementById(id);
            if (el) el.style.visibility = 'hidden';
        });

        // 2. ğŸ“Š ã€æ•¸æ“šèšåˆã€‘å»ºæ§‹æ”¶æ“šæ˜ç´° (Breakdown)
        const breakdown = window.lastGameBreakdown || [];
        const breakdownHtml = breakdown.map(b => `
            <div style="display:flex; justify-content:space-between; font-size:13px; color:#aaa; margin-bottom:6px; font-family:monospace;">
                <span>ğŸ‘¤ ${b.name} (${b.count}å¼µ)</span>
                <span style="color:#fff;">+$${b.amount.toLocaleString()} G</span>
            </div>
        `).join('') || '<div style="text-align:center; color:#444; font-size:12px;">ç„¡å¤–éƒ¨æ•¸æ“šæµå…¥</div>';

        // 3. ğŸ ã€ç‰©ç†æ¸²æŸ“ï¼šå¤šé‡æ‰å¯¶æ¸…å–®ã€‘ [cite: 2026-02-06]
        // éæ­· loots é™£åˆ—ä¸¦æ ¹æ“šç¨€æœ‰åº¦é—œéµå­—æ›è¼‰è¦–è¦ºç‰¹æ•ˆ
        const lootsHtml = (Array.isArray(loots) && loots.length > 0) ? loots.map(item => {
            const isLegendary = item.includes("ğŸ’") || item.includes("ğŸ‘‘") || item.includes("ğŸº") || item.includes("æ¯€æ»…");
            return `
                <div class="loot-card ${isLegendary ? 'legendary-glow' : ''}" style="
                    margin-top:10px; padding:15px; border-radius:12px; 
                    background:rgba(255,255,255,0.05); border:1.5px solid ${isLegendary ? '#f1c40f' : '#444'}; 
                    color:${isLegendary ? '#f1c40f' : '#eee'}; font-weight:bold; font-size:14px;
                    box-shadow: ${isLegendary ? '0 0 20px rgba(241,196,15,0.2)' : 'none'};
                ">
                    ğŸ ç²å¾—ï¼š${item}
                </div>`;
        }).join('') : '';

        // 4. ğŸ¨ ã€æ ¸å¿ƒæ¸²æŸ“ä½ˆå±€ã€‘
        overlay.innerHTML = `
            <div class="fade-in-popup victory-impact-shake" style="text-align:center; background: rgba(10, 10, 15, 0.98); padding: 45px; border: 2px solid ${isBerserkVictory ? '#9b59b6' : '#f1c40f'}; border-radius: 28px; box-shadow: 0 0 150px #000; color: white; min-width: 440px; position: relative; backdrop-filter: blur(15px); user-select: none;">
                <h1 style="font-size: 60px; color: ${isBerserkVictory ? '#9b59b6' : '#f1c40f'}; margin:0; text-shadow: 0 0 25px rgba(241,196,15,0.3); font-family: 'Cinzel', serif; letter-spacing:4px;">VICTORY</h1>
                <p style="font-size: 14px; color: #666; margin:10px 0; letter-spacing:2px; font-weight:bold;">ğŸ“œ BLOOD_KINGDOM_RECEIPT</p>
                
                <div style="background:rgba(0,0,0,0.4); padding:20px; border-radius:18px; border:1px solid #333; text-align:left; margin-top:25px;">
                    <div style="border-bottom:1px solid #444; padding-bottom:10px; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center;">
                        <span style="color:#888; font-size:11px; font-weight:bold;">å½©é‡‘æ± ç¸½é¡ (Gross Pool)</span>
                        <b style="font-size:22px; color:#f1c40f; font-family:monospace;">$${(totalPool || 0).toLocaleString()} G</b>
                    </div>
                    ${breakdownHtml}
                    <div style="border-top:1px dashed #555; margin-top:10px; padding-top:12px; display:flex; justify-content:space-between; color:#e74c3c; font-size:12px; font-weight:bold;">
                        <span>ğŸ›ï¸ ç‹åœ‹ç´ç¨… (10% Tax)</span>
                        <span>-$${(kingdomTax || 0).toLocaleString()} G</span>
                    </div>
                    ${interestAmount > 0 ? `
                    <div style="display:flex; justify-content:space-between; color:#2ecc71; font-size:12px; font-weight:bold; margin-top:6px; border-top:1px solid rgba(46,204,113,0.1); padding-top:6px;">
                        <span>ğŸ¦ é‡‘åº«ç•¶å±€ç”Ÿæ¯ (Interest)</span>
                        <span>+$${interestAmount.toLocaleString()} G</span>
                    </div>` : ''}
                </div>

                <div style="background:rgba(46, 204, 113, 0.08); padding:30px; border-radius:24px; margin:20px 0; border:1px solid rgba(46, 204, 113, 0.4); position:relative;">
                    <span style="color:#2ecc71; font-size:12px; font-weight:bold; letter-spacing:1px;">æœ€çµ‚å¯¦é ˜æ·¨åˆ© (Net Profit)</span>
                    <div style="font-size:52px; font-weight:900; color:#2ecc71; font-family:monospace; margin:10px 0;">
                        ${winner.id === 'player' ? `+$${winAmount.toLocaleString()}` : `<span style="color:#e74c3c;">-$${playerLoss.toLocaleString()}</span>`}
                    </div>
                </div>

                <div id="loot-container" style="margin-bottom:25px;">
                    ${lootsHtml}
                </div>

                <div style="display:flex; flex-direction:column; gap:14px; width:100%;">
                    <button class="btn-nhk" onclick="closeVictoryAndRestart()" style="background:linear-gradient(180deg, #f1c40f 0%, #d4af37 100%); color:#000; border:none; padding:20px; border-radius:16px; font-weight:900; font-size:22px; cursor:pointer; box-shadow: 0 6px 0 #b7950b;">æ¥å—å‘½é‹ä¸¦å†æˆ°</button>
                    <button onclick="exitKingdom()" style="background:none; border:none; color:#555; cursor:pointer; font-size:14px; text-decoration:underline;">é›¢é–‹è¡€è…¥ç‹åœ‹</button>
                </div>
            </div>
        `;
        
        overlay.style.display = 'flex';
        overlay.style.zIndex = "200000";

        // 5. ğŸ§± ã€éœ‡å‹•ç‰©ç†é€£å‹•ã€‘
        requestAnimationFrame(() => {
            const table = document.getElementById('poker-table');
            if (table) {
                table.classList.remove('dqShake-active');
                void table.offsetWidth; // ç‰©ç†é‡ç¹ªèª˜ç™¼ Reflow
                table.classList.add('dqShake-active');
                setTimeout(() => { if (table) table.classList.remove('dqShake-active'); }, 600);
            }
        });
    }
}; // ğŸ PokerSettlementSystem ç‰©ä»¶çµæ§‹å®Œç¾é–‰åˆï¼Œç‰©ç†é–å®š F12

/**
 * ğŸ¬ ç‰©ç†å­ç¨‹åºï¼šç‰©è³‡å…¥åº«ç‰¹æ•ˆ
 */
function triggerItemGetVfx() {
    const hud = document.getElementById('tactical-hud');
    if (hud) {
        hud.style.transition = "none";
        hud.style.transform = "scale(1.2) rotate(3deg)";
        hud.style.filter = "brightness(2) drop-shadow(0 0 15px #f1c40f)";
        
        setTimeout(() => {
            hud.style.transition = "all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275)";
            hud.style.transform = "scale(1) rotate(0deg)";
            hud.style.filter = "none";
        }, 100);
    }
}

/**
 * â™»ï¸ ç‰©ç†å›æ­¸ï¼šæ¸…ç©ºçµç®—ä¸¦æ¢å¾©éŠæˆ²æ§åˆ¶æ¬Š
 */
window.closeVictoryAndRestart = function() {
    const overlay = document.getElementById('victory-screen');
    if (overlay) overlay.style.display = 'none';

    // æ¢å¾©æ§åˆ¶é …é¡¯ç¤º
    const controls = ['player-hand', 'btn-poker-act', 'btn-poker-pass', 'poker-helper-bar'];
    controls.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.style.visibility = 'visible';
    });

    // å•Ÿå‹•ä¸‹ä¸€å±€é»ç«
    resetGameLockAndStart();
};



/**
 * ğŸ’€ ç ´ç”¢çµå±€ç•«é¢
 */
function showBankruptcyScreen(bankruptAI) {
    const tableCenter = document.getElementById('table-center');
    if (!tableCenter) return;

    // ç‰©ç†éœ‡æ’¼ï¼šè¢å¹•è®Šç°ï¼Œæ‚²å‚·çš„æ°›åœ
    const mainWrapper = document.querySelector('.main-wrapper');
    if (mainWrapper) mainWrapper.style.filter = "grayscale(1) brightness(0.5)";

    tableCenter.innerHTML = `
        <div style="text-align:center; background: #000; padding: 30px; border: 3px solid #7f8c8d; border-radius:15px; box-shadow: 0 0 150px #000; color: #ccc; min-width:380px;">
            <div style="font-size: 50px; margin-bottom: 10px;">ğŸ’¸</div>
            <h2 style="color:#95a5a6; margin:0; letter-spacing:5px;">ç ´ ç”¢ å®£ å‘Š</h2>
            <p style="font-size: 16px; margin: 20px 0; line-height: 1.6;">
                å°æ‰‹ <b style="color:#fff;">${bankruptAI.name}</b> å·²è³‡ä¸æŠµå‚µã€‚<br>
                è² å‚µï¼š<span style="color:#e74c3c;">$${bankruptAI.coins.toLocaleString()} G</span>
            </p>
            <div style="background:rgba(255,255,255,0.1); padding:10px; font-size:12px; border-radius:6px; margin-bottom:20px;">
                â›“ï¸ æ ¹æ“šç‹åœ‹å¾‹æ³•ï¼Œè©²æˆå“¡å°‡è¢«è²¶ç‚ºæ°¸ä¹…å¥´éš¸ä¸¦é€å¾€ç¤¦å‘ã€‚<br>
                æœ¬å ´ç‰Œå±€å¼·åˆ¶çµæŸã€‚
            </div>
            <button onclick="restartFullGame()" style="width:100%; padding:15px; background:#e74c3c; color:#fff; border:none; border-radius:8px; cursor:pointer; font-weight:bold; font-size:18px; box-shadow: 0 5px 0 #c0392b;">
                ğŸ’€ é‡æ–°æ´—ç‰Œï¼Œå°‹æ‰¾æ–°çš„å—å®³è€… (é‡å•Ÿ)
            </button>
        </div>
    `;
}

// é‡å•ŸéŠæˆ²é‚è¼¯ï¼šé‡ç½®æ‰€æœ‰ AI è³‡é‡‘
function restartFullGame() {
    // æ¢å¾©ç•«é¢
    const mainWrapper = document.querySelector('.main-wrapper');
    if (mainWrapper) mainWrapper.style.filter = "none";
    
    // é‡ç½® AI è³‡é‡‘
    pokerGame.players.forEach(p => {
        if (p.id !== 'player') p.coins = 50000; // æ¢å¾©åˆå§‹è³‡é‡‘
    });
    
    // é‡ç½®ç‹‚æš´æ©Ÿç‡
    pokerGame.berserkTriggerChance = 0;
    
    showNotification("ğŸ”„ æ–°çš„çµç‰©å·²å…¥å ´ï¼Œè³‡é‡‘æ± é‡ç½®ã€‚");
    resetGameLockAndStart();
}



/**
 * ğŸ©¸ ç‰Œæ¡Œç‰©ç†å‚·å®³å¼•æ“ (V5.9.31 å±¬æ€§é™£åˆ—ä¿®æ­£ç‰ˆ)
 */
function applyCardBattleDamage(attacker, cards) {
    if (!pokerGame.gameActive) return;

    // ğŸ”¥ ç²å–æœ€æ–°ç‰©ç†å±¬æ€§å¿«ç…§
    const stats = calculateCombatStats();
    const maxHP = player.maxHp || 100;

    // 1. ç‰©ç†å¼·åº¦è¨ˆç®— (ç‰Œé¢æ¬Šé‡)
    const maxPower = Math.max(...cards.map(c => {
        if (c.value === 'JOKER') return 20;
        const map = {'2':15, 'A':14, 'K':13, 'Q':12, 'J':11};
        return map[c.value] || parseInt(c.value) || 3;
    }));

    // 2. éšç´šèˆ‡ç‰Œå‹åŠ å£“
    let rankFactor = { 'king': 0.10, 'noble': 0.06, 'citizen': 0.02, 'slave': 0.01 }[attacker.rank] || 0.02;
    const pattern = POKER_AI.getPattern(cards);
    let typeMult = pattern?.type === 'bomb' ? 3.5 : (pattern?.sub === 'fullhouse' ? 2.0 : 1.0);
    if (cards.length >= 3) typeMult += 0.3;

    // 3. åŸºç¤å‚·å®³æ¼”ç®—
    let rawDamage = Math.floor((maxHP * rankFactor * typeMult) + (maxPower * 3));
    if (pokerGame.isBerserkKingActive && attacker.rank === 'king') rawDamage *= 2.5;

    // 4. ğŸ›¡ï¸ ã€ç‰©ç†é˜²ç¦¦èˆ‡è¿´é¿åŸ·è¡Œã€‘ [cite: 2026-02-06]
    pokerGame.players.forEach(p => {
        if (p.id === 'player') {
            // A. å®Œå…¨è¿´é¿æª¢å®š
            if (Math.random() < stats.perfectDodge) {
                addBattleLog(`ğŸ›¡ï¸ <b style="color:#3498db;">[å®Œå…¨è¿´é¿]</b> å‹‡è€…å‹•ä½œå¦‚é¢¨ï¼Œæ¯«é«®ç„¡å‚·ï¼`);
                return;
            }

            // B. ç‰©ç†å‚·æ¸›è¨ˆç®—
            // å¯¦éš›å‚·å®³ = åŸºç¤å‚·å®³ * (1 - ç‰©ç†æŠµæŠ—åŠ›)
            const finalDmg = Math.max(1, Math.floor(rawDamage * (1 - stats.physResist)));
            player.currentHp = Math.max(0, player.currentHp - finalDmg);

            // C. ç‹€æ…‹ç•°å¸¸æŠµæŠ— (å—æ™ºåŠ›å½±éŸ¿)
            const roll = Math.random() * 100;
            // è‹¥æ“²éª°é»æ•¸å°æ–¼ç‰¹æ®ŠæŠ—æ€§ï¼Œå‰‡ç‰©ç†é˜»æ–·ç‹€æ…‹è§¸ç™¼
            if (finalDmg > 0 && roll > stats.specResist) {
                if (typeof processStatusAilment === 'function') processStatusAilment(attacker);
            } else if (finalDmg > 0) {
                addBattleLog(`ğŸ§  <b style="color:#9b59b6;">[æ™ºåŠ›æŠµæŠ—]</b> å‹‡è€…å†·éœåˆ†æï¼Œå…å—äº†ç•°å¸¸ç‹€æ…‹ä¾µè•ã€‚`);
            }

            // D. æ­»äº¡å³æ™‚åˆ¤å®š
            if (player.currentHp <= 0) {
                addBattleLog(`ğŸ’€ <b style="color:#ff4d4d;">å‹‡è€…åŠ›ç›¡ï¼</b> æ„è­˜ç‰©ç†ä¸­æ–·...`);
                setTimeout(() => { if (pokerGame.gameActive) finishPokerGame(attacker); }, 800);
            }

            // è¦–è¦ºå›é¥‹
            const screen = document.getElementById('adventure-screen');
            if (screen) {
                screen.style.animation = `dqShake ${finalDmg > 100 ? "0.4s" : "0.2s"} both`;
                setTimeout(() => screen.style.animation = "", 400);
            }
        }
    });

    if (typeof updatePlayerUI === 'function') updatePlayerUI();
}

/**
 * ğŸ“Š ç‰©ç†å­ç¨‹åºï¼šå…¨åŸŸæˆ°é¬¥å±¬æ€§çµç®— (V5.9.31)
 * ä½œç”¨ï¼šå°‡ 6 å¤§æ ¸å¿ƒå±¬æ€§èˆ‡è£å‚™é˜²ç¦¦ï¼Œç‰©ç†è½‰åŒ–ç‚ºå‚·æ¸›èˆ‡å®Œå…¨è¿´é¿ç‡ã€‚
 */
function calculateCombatStats() {
    // 0. ğŸ›¡ï¸ æ•¸æ“šç²å–ï¼šè®€å–å¤§ä¸€çµ±ç‡ƒæ–™åŒ…å±¬æ€§èˆ‡è£å‚™åŸºç¤å€¼
    const attr = player.attributes || { str: 0, sta: 0, agi: 0, int: 0, block: 0, eva: 0, p_eva: 0 };
    const equipDef = player.equips?.body?.stats?.def || 0; 

    // 1. ğŸ”¥ ç‰©ç†ç¸½é˜²ç¦¦é»æ•¸çµç®— [cite: 2026-02-06]
    // å…¬å¼ï¼š(è£å‚™é˜²ç¦¦ + é«”åŠ›*2) * (1 + åŠ›é‡*0.5%)
    const baseDefTotal = (equipDef + (attr.sta * 2));
    const finalDefPoints = baseDefTotal * (1 + (attr.str * 0.005));

    // 2. ğŸ›¡ï¸ ç‰©ç†å‚·å®³æŠµæŠ—åŠ› (0.5% per Def point) [cite: 2026-02-06]
    // æ¯ä¸€é»é˜²ç¦¦ç‰©ç†æä¾› 0.5% çš„ç‰©ç†æ¸›å‚·
    const physicalResistance = finalDefPoints * 0.005;

    // 3. ğŸ’¨ è¿´é¿èˆ‡å®Œå…¨è¿´é¿åˆ¤å®šéˆ [cite: 2026-02-06]
    // åŸºç¤è¿´é¿ç‡ = æ•æ·*0.5% + è¿´é¿é»æ•¸*1%
    const evaRate = (attr.agi * 0.005) + (attr.eva * 0.01);
    
    // å®Œå…¨è¿´é¿ç‡ = æ ¼æ“‹*1.5% + (ç¸½è¿´é¿ç‡ * 0.2) + å®Œå…¨è¿´é¿é»æ•¸*1% [cite: 2026-02-06]
    // ç‰©ç†æ„ç¾©ï¼šåŸºç¤è¿´é¿çš„ 1/5 æœƒè½‰åŒ–ç‚ºå®Œå…¨ç‰©ç†è¿´é¿
    const perfectDodgeRate = (attr.block * 0.015) + (evaRate * 0.2) + (attr.p_eva * 0.01);

    // 4. ğŸ§  ç‰¹æ®ŠæŠ—æ€§çµç®— (æ™ºåŠ›*5) [cite: 2026-02-06]
    // æ™ºåŠ›è¶Šé«˜ï¼Œè¶Šèƒ½ç‰©ç†æŠµæŠ—æµè¡€ã€ä¸­æ¯’ç­‰ç•°å¸¸ç‹€æ…‹è§¸ç™¼
    const statusResist = attr.int * 5;

    return {
        defPoints: finalDefPoints,
        physResist: Math.min(0.9, physicalResistance), // ç‰©ç†å‚·æ¸›ä¸Šé™ç‰©ç†å°é ‚ 90%
        perfectDodge: Math.min(0.8, perfectDodgeRate), // å®Œå…¨è¿´é¿ä¸Šé™ç‰©ç†å°é ‚ 80%
        specResist: statusResist,
        totalEva: evaRate
    };
}

/**
 * ğŸ’€ ç‰©ç†å­ç¨‹åºï¼šéšç´šå¨å£“ç‹€æ…‹åˆ¤å®š (V5.9.20 æˆ°è¡“åŠ å£“ç‰ˆ)
 * ä¿®æ­£é»ï¼š
 * 1. æ©Ÿç‡é‡å¡‘ï¼šåŸºç¤æ©Ÿç‡ä¸Šèª¿è‡³ 10-15%ï¼Œç§»é™¤ã€Œç„¡æ„Ÿã€æ¨™ç±¤ã€‚
 * 2. ç‰Œå‹åŠ æ¬Šï¼šç‚¸å½ˆèˆ‡å¼·åŠ›ç‰Œå‹å…·å‚™æ›´é«˜ç‰©ç†å¨å£“ï¼ˆæœ€é«˜åŠ æˆ 2.5xï¼‰ã€‚ [cite: 2026-02-06]
 * 3. è¦–è¦ºå…±é³´ï¼šè§¸ç™¼æ™‚å¼·åˆ¶éœ‡å‹•ç”Ÿå‘½ä¹‹çƒã€‚
 */
function processStatusAilment(attacker) {
    if (player.currentHp <= 0 || !pokerGame.gameActive) return;

    // 1. ğŸ”¥ ã€ç‰©ç†æ©Ÿç‡åŸºæ•¸ã€‘ 
    const isBerserk = !!pokerGame.isBerserkKingActive;
    // åŸºç¤æ©Ÿç‡ä¸Šèª¿ï¼šå¹³æ™‚ 12%ï¼Œç‹‚æš´æ™‚ 30%
    let baseChance = isBerserk ? 30 : 12; 

    // 2. ğŸ’¥ ã€ç‰Œå‹æ¬Šé‡åŠ æˆã€‘ [cite: 2026-02-06]
    // å–å¾—æœ€å¾Œä¸€æ‰‹çš„ç‰Œå‹ï¼Œç‰Œå‹è¶Šå¼·ï¼Œå¨å£“æ„Ÿè¶Šé‡
    const pattern = pokerGame.lastMovePattern;
    let patternWeight = 1.0;

    if (pattern) {
        if (pattern.type === 'bomb') patternWeight = 2.5;         // ç‚¸å½ˆï¼š2.5å€å£“è¿«
        else if (pattern.sub === 'fullhouse') patternWeight = 1.8; // è‘«è˜†ï¼š1.8å€å£“è¿«
        else if (pattern.sub === 'straight') patternWeight = 1.4;  // é †å­ï¼š1.4å€å£“è¿«
        else if (pattern.cardsCount >= 2) patternWeight = 1.2;     // å°å­ï¼š1.2å€å£“è¿«
    }

    // æœ€çµ‚åˆ¤å®šæ©Ÿç‡ (ä¾‹å¦‚ï¼šç‹‚æš´åœ‹ç‹æ‰“ç‚¸å½ˆ = 30 * 2.5 = 75% å¿…ä¸­ç‹€æ…‹)
    const finalChance = baseChance * patternWeight;
    const roll = Math.random() * 100;

    console.log(`ğŸ² å¨å£“åˆ¤å®šï¼šRoll ${roll.toFixed(1)} < Target ${finalChance.toFixed(1)}%`);

    if (roll < finalChance) {
        let effect = null;
        
        // éšç´šå±¬æ€§åˆ†æµ
        if (attacker.rank === 'king') {
            // åœ‹ç‹ï¼šéš¨æ©Ÿè©›å’’ (ç‹‚æš´) æˆ– åŠ‡æ¯’ (ä¸€èˆ¬)
            effect = isBerserk ? ['poison', 'bleed', 'paralyze'][Math.floor(Math.random() * 3)] : 'poison';
        } else if (attacker.rank === 'noble') {
            effect = 'bleed';    // è²´æ—ï¼šæ’•è£‚å‚·
        } else if (attacker.rank === 'slave') {
            effect = 'paralyze'; // å¥´éš¸ï¼šæƒ¡æ„éº»ç—º
        } else {
            // å¹³æ°‘ä¹Ÿæœ‰ 5% æ©Ÿç‡é€ æˆå£“åŠ› (ä¸­æ¯’)
            if (Math.random() < 0.05) effect = 'poison';
        }

        // 3. ğŸ”¥ ã€åŸ·è¡Œç‹€æ…‹ç‰©ç†å¯«å…¥ã€‘
        if (effect && player.status !== effect) {
            player.status = effect;
            
            const statusMap = {
                'poison': { name: 'ä¸­æ¯’', color: '#2ecc71', desc: 'ç‰©ç†æº¶è§£ï¼šæ¯ç§’æ‰£é™¤ 3% æœ€å¤§ç”Ÿå‘½' },
                'bleed': { name: 'å‡ºè¡€', color: '#e74c3c', desc: 'æ²»ç™’æ–·çµ•ï¼šè‡ªå‹•å›è¡€ç‰©ç†å¤±æ•ˆï¼Œä¸”æŒçºŒæè¡€' },
                'paralyze': { name: 'éº»ç—º', color: '#95a5a6', desc: 'ç¥ç¶“å¹²æ“¾ï¼šç‰©ç†æ“ä½œå…·å‚™ 30% å¤±æ•—ç‡' }
            };
            
            // æˆ°è¡“æ—¥èªŒèˆ‡é€šçŸ¥
            addBattleLog(`ğŸš¨ <b style="color:${statusMap[effect].color};">[å¨å£“]</b> å—åˆ° ${attacker.name} çš„æ¬ŠåŠ›é‡å£“ï¼Œé™·å…¥ã€${statusMap[effect].name}ã€‘ï¼`);
            showNotification(`ğŸ’€ ç‹€æ…‹ç•°å¸¸ï¼š${statusMap[effect].name} (${statusMap[effect].desc})`);
            
            // ç‰©ç†ç‰¹æ•ˆï¼šç”Ÿå‘½çƒç”¢ç”Ÿå°æ‡‰é¡è‰²çš„ç‰©ç†è„ˆè¡
            const orb = document.querySelector('.hp-orb-container');
            if (orb) {
                orb.style.animation = "none";
                void orb.offsetWidth;
                orb.style.animation = "dqShake 0.4s ease-in-out";
                orb.classList.add(`orb-${effect}ed`);
                setTimeout(() => orb.classList.remove(`orb-${effect}ed`), 1500);
            }
            
            // 4. ğŸ”¥ ã€å³æ™‚åŒæ­¥ã€‘
            // å¼·åˆ¶é‡ç¹ª HUD ç¢ºä¿ç‹€æ…‹åœ–ç¤ºèˆ‡è¡€é‡æ ¼å¼ (HP99 / HP999) ç«‹å³å°é½Š
            renderPokerTable(document.getElementById('poker-table'));
        }
    }
}


/**
 * â³ ç‰©ç†å­ç¨‹åºï¼šç‹€æ…‹æ•ˆæ‡‰çµç®— (æ¯ç§’åŸ·è¡Œ)
 */
function handleStatusTicks() {
    if (!pokerGame.gameActive || player.currentHp <= 0) return;

    if (player.status === 'poison') {
        player.currentHp = Math.max(1, player.currentHp - (player.maxHp * 0.01)); // æ¯ç§’æ‰£ 1%
    } else if (player.status === 'bleed') {
        player.currentHp = Math.max(1, player.currentHp - 25); // æ¯ç§’å›ºå®šæ‰£ 25 é» (å¤§å‡ºè¡€)
    }
    
    // éº»ç—ºæ•ˆæœï¼šåœ¨ finalizeStartingTurn åˆ¤å®šï¼Œå°‡ç©å®¶ç­”é¡Œæ™‚é–“æˆ–æ“ä½œæ¬Šé–å®š
}

// æ¯ç§’è‡ªå‹•å•Ÿå‹•ä¸€æ¬¡ç‰©ç†çµç®—
setInterval(handleStatusTicks, 1000);

/**
 * ğŸ¬ ç‰©ç†ç‰¹æ•ˆï¼šåœ‹ç‹é€£èŠé‡‘è‰²å™´ç™¼ (å«ç‰©ç†æŠ–å‹•èˆ‡å½±æ ¼æ³¨å…¥)
 */
function triggerStreakVisuals(count, bonus) {
    // 1. ğŸ”¥ ã€ç‰©ç†é˜²ç¦¦ã€‘æ³¨å…¥å¿…è¦çš„ CSS å½±æ ¼å®šç¾© (è‹¥ä¸å­˜åœ¨)
    if (!document.getElementById('streak-visual-styles')) {
        const style = document.createElement('style');
        style.id = 'streak-visual-styles';
        style.innerHTML = `
            @keyframes streakJump {
                0% { opacity: 0; transform: translate(-50%, 0%) scale(0.5) rotate(-5deg); }
                20% { opacity: 1; transform: translate(-50%, -60%) scale(1.3) rotate(5deg); }
                40% { transform: translate(-50%, -50%) scale(1.1) rotate(0deg); }
                80% { opacity: 1; transform: translate(-50%, -55%) scale(1); }
                100% { opacity: 0; transform: translate(-50%, -100%) scale(0.8); }
            }
            @keyframes goldCoinBurst {
                from { text-shadow: 0 0 10px gold, 0 0 20px orange; }
                to { text-shadow: 0 0 40px #f1c40f, 0 0 80px white; }
            }
        `;
        document.head.appendChild(style);
    }

    // 2. ç‰©ç†æ§‹å»ºç‰¹æ•ˆå®¹å™¨
    const el = document.createElement('div');
    el.style = `
        position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
        width: 100%; pointer-events: none; z-index: 200000;
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        text-align: center; font-family: 'Courier New', monospace;
        animation: streakJump 1.6s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
    `;

    // 3. ç‰©ç†æ³¨å…¥å…§å®¹ï¼šé€£èŠå€ç‡èˆ‡çé‡‘
    // ä½¿ç”¨æ¼¸å±¤è‰²èˆ‡ç™¼å…‰å‹•æ•ˆå¼·åŒ–ã€Œç‹æ¬Šã€è³ªæ„Ÿ
    el.innerHTML = `
        <div style="font-size: 64px; font-weight: 900; color: #f1c40f; 
                    animation: goldCoinBurst 0.3s infinite alternate;
                    filter: drop-shadow(0 0 15px rgba(0,0,0,0.8));">
            ğŸ‘‘ KING STREAK x${count}
        </div>
        <div style="font-size: 24px; font-weight: bold; color: #fff; margin-top: 10px;
                    background: rgba(0,0,0,0.6); padding: 5px 20px; border-radius: 20px;
                    border: 2px solid #f1c40f; box-shadow: 0 0 15px #f1c40f;">
            ğŸ’° çµ±æ²»æ´¥è²¼: +${bonus.toLocaleString()} G
        </div>
    `;
    
    document.body.appendChild(el);

    // 4. ğŸ”¥ ã€ç‰©ç†é€£å‹•ã€‘è¢å¹•éœ‡æ’¼æŠ–å‹•
    const table = document.getElementById('poker-table');
    if (table) {
        // ç‰©ç†ç–ŠåŠ æŠ–å‹• Class
        table.style.transition = "none";
        table.style.animation = "dqShake 0.6s cubic-bezier(.36,.07,.19,.97) both";
        
        // æŠ–å‹•çµæŸå¾Œç‰©ç†æ¸…ç†
        setTimeout(() => {
            table.style.animation = "";
        }, 600);
    }

    // 5. ç‰©ç†éŠ·æ¯€èˆ‡å…§å­˜å›æ”¶
    setTimeout(() => {
        el.remove();
    }, 1600);
    
    console.log(`%câœ¨ ç‹æ¬Šå…±é³´ï¼šé€£èŠ x${count} é”æˆï¼Œç‰©ç†çå‹µå™´ç™¼ä¸­ã€‚`, "color: #f1c40f; font-weight: bold;");
}


/**
 * â™»ï¸ ç‰©ç†é½’è¼ªï¼šé‡ç½®é–å®šã€åœ‹åº«å¾µæ”¶èˆ‡è´å®¶é ˜å…ˆæ¬Šæ ¡æº–
 * ä¿®æ­£ï¼š
 * 1. è²¡å‹™éš”é›¢ï¼š$10,000 å…¥å ´è²»ç›´æ¥é€²å…¥ç‹åœ‹åœ‹åº«ï¼Œä¸è¨ˆå…¥ç©å®¶è³­é‡‘æ± ã€‚
 * 2. è´å®¶é ˜å…ˆæ¬Šï¼šé™¤é¦–å±€å¤–ï¼Œç‰©ç†é–å®šä¸Šä¸€å±€è´å®¶ç‚ºé–‹å±€ç™¼çƒè€…ã€‚
 * 3. æ­»å¾ªç’°æ””æˆªï¼šå„ªåŒ– AI å•Ÿå‹•éˆè·¯ï¼Œé˜²æ­¢ã€Œéµæ”¯æ´—ç‰ˆã€æ­»çµã€‚
 */
async function resetGameLockAndStart() {
    console.log("%câ™»ï¸ åŸ·è¡Œç‹åœ‹æ³•å¾‹ï¼šé‡ç½®æˆ°å ´ä¸¦å¾µæ”¶ç¨…æ”¶...", "color: #3498db; font-weight: bold;");

    // 0. ğŸ”¥ ã€ç‰©ç†å®‰å…¨èˆ‡è´å®¶è¨˜éŒ„ã€‘
    window.isGameEnding = false;
    pokerGame.gameActive = true; 
    window.selectedCards = []; 

    // å–å¾—ä¸Šä¸€å±€è¨˜éŒ„çš„è´å®¶ (æ­¤æ•¸æ“šç”± finishPokerGame å¯«å…¥)
    const lastWinnerName = pokerGame.lastWinnerName || "NONE";
    const isFirstGameOfSession = (!pokerGame.lastWinnerName); 

    // 1. ğŸ’° ã€ç‰©ç†ç¶“æ¿Ÿå¾ªç’°ï¼šåœ‹åº«é–€ç¥¨å¾µæ”¶ã€‘
    const entryFee = 10000;
    
    pokerGame.players.forEach(p => {
        // å…¨å“¡ç‰©ç†æ‰£æ¬¾ (å« AI)
        if (p.id === 'player') {
            if (player.coin < entryFee && p.rank === "slave") {
                const loan = entryFee - player.coin;
                player.debt = (player.debt || 0) + Math.floor(loan * 2.0);
                player.coin = entryFee;
                addBattleLog(`â›“ï¸ <b style="color:#e74c3c;">[å¥‘ç´„]</b> å¥´éš¸å› è³‡é‡‘ä¸è¶³ï¼Œç°½ç½²å€Ÿè²¸å”å®šã€‚`);
            }
            player.coin -= entryFee;
        } else {
            p.coins = (p.coins || 50000) - entryFee;
        }
    });

    // ğŸš¨ ä¿®æ­£ï¼šçæ±  (Pot) æœ¬å±€èµ·å§‹æ‡‰ç‚º 0ï¼Œæˆ–åƒ…ç”±ç¨…é‡‘åŸºæ•¸æ§‹æˆï¼Œè´å®¶çš„éŒ¢ä¾†è‡ªè¼¸å®¶è™•ç½°é‡‘
    pokerGame.playerPot = 0; 
    addBattleLog(`ğŸ° <b style="color:#f1c40f;">ç‹åœ‹åœ‹åº«</b>ï¼šå·²å¾µæ”¶å…¨å“¡é–€ç¥¨ $${entryFee.toLocaleString()}Gã€‚`);

    // 2. ğŸ”¥ ã€UI èˆ‡æ•¸æ“šæ·¨åŒ–ã€‘ (ç•¥éé‡è¤‡çš„ HTML æ¨¡æ¿)
    const ledger = document.getElementById('poker-ledger');
    if (ledger) ledger.remove();
    
    initPokerDeck(); 
    pokerGame.players.forEach(p => {
        p.lastMove = [];
        p.isPassed = false;
        p.cards = []; 
        p.lastTalk = ""; 
    });

    // æ¨™æº–ç™¼ç‰Œ
    for (let i = 0; i < 13; i++) {
        pokerGame.players.forEach(p => p.cards.push(pokerGame.deck.pop()));
    }

    // 3. ğŸ”¥ ã€åŸ·è¡Œå¾µç¨…å„€å¼ã€‘ (éšç´šæ å¥ª)
    renderPokerTable(document.getElementById('poker-table'));
    if (typeof runTaxCeremony === 'function') {
        await runTaxCeremony(); 
    }

    // 4. ğŸš© ã€ç™¼çƒæ¬Šç‰©ç†éŒ¨å®šï¼šæ ¸å¿ƒä¿®æ­£ã€‘
    let starterIdx = -1;

    if (isFirstGameOfSession) {
        // æƒ…æ³ Aï¼šæœ¬æ¬¡æœƒè©±çš„ç¬¬ä¸€å±€ -> æ‰¾æ¢…èŠ± 3
        starterIdx = pokerGame.players.findIndex(p => p.cards.some(c => c.label === 'â™£3'));
        addBattleLog(`ğŸš© <b style="color:#f1c40f;">[æ³•å¾‹ç¾©å‹™]</b> æŒæœ‰æ¢…èŠ± 3 è€…èµ·å§‹é–‹å±€ã€‚`);
    } else {
        // æƒ…æ³ Bï¼šéç¬¬ä¸€å±€ -> ç”±ä¸Šä¸€å±€è´å®¶é ˜å…ˆ
        starterIdx = pokerGame.players.findIndex(p => p.name === lastWinnerName);
        if (starterIdx === -1) starterIdx = 0; // å‚™æ´
        addBattleLog(`ğŸ‘‘ <b style="color:#f1c40f;">[è´å®¶æ¬ŠåŠ›]</b> ç”±ä¸Šå±€è´å®¶ <b style="color:#fff;">${lastWinnerName}</b> é ˜å…ˆé–‹å±€ã€‚`);
    }

    pokerGame.turn = starterIdx;
    pokerGame.lastPlayerName = "NONE"; 
    pokerGame.lastMovePattern = null;
    pokerGame.isFirstRound = isFirstGameOfSession; // åªæœ‰é¦–å±€æœ‰æ¢…èŠ± 3 ç¾©å‹™

    // 5. ğŸ² ã€å‘½é‹é»ç«ã€‘
    pokerGame.players.forEach(p => p.cards.sort((a, b) => a.power - b.power));
    
    if (typeof showRankBoonSelection === 'function') {
        showRankBoonSelection(); 
    } else {
        renderPokerTable(document.getElementById('poker-table'));
        // ğŸš¨ ç‰©ç†åˆ¶å‹•ï¼šå¢åŠ å»¶é²ï¼Œé˜²æ­¢ AI é€£çºŒç™¼æ‹›é€ æˆæ­»å¾ªç’°
        setTimeout(() => {
            if (pokerGame.players[pokerGame.turn].id !== 'player') {
                aiPlayTurn(pokerGame.turn);
            }
        }, 1500);
    }

    if (typeof updatePlayerUI === 'function') updatePlayerUI();
}


/**
 * âš–ï¸ ç‰©ç†å­ç¨‹åºï¼šçµ‚æ¥µå›åˆå•Ÿå‹•æ ¡æº–
 * ä¿®æ­£ï¼šåœ¨ç¢ºå®šç™¼çƒæ¬Šå¾Œï¼ŒåŒæ­¥é»ç‡ƒæˆ°è¡“è¼”åŠ©å¼•æ“ï¼Œç¢ºä¿ Joker è®Šå¹»èˆ‡ç‰Œå‹æŒ‰éˆ•å³æ™‚é¡¯ç¾ã€‚
 */
function finalizeStartingTurn() {
    console.log("%câš–ï¸ åŸ·è¡Œå›åˆæ¬ŠåŠ›åˆ†é…å„€å¼...", "color: #f1c40f;");
    const table = document.getElementById('poker-table');

    // 1. ğŸ”¥ ã€ç‰©ç†æƒ…å¢ƒåˆ¤å®šã€‘é¦–å±€ï¼šæ¢…èŠ± 3 ç¾©å‹™
    if (pokerGame.isFirstRound) {
        let starterIdx = -1;
        pokerGame.players.forEach((p, idx) => {
            if (p.cards.some(c => c.label === 'â™£3')) {
                starterIdx = idx;
            }
        });

        if (starterIdx !== -1) {
            pokerGame.turn = starterIdx;
            const starter = pokerGame.players[starterIdx];
            
            addBattleLog(`ğŸš© <b style="color:#2ecc71;">é¦–å±€ç¾©å‹™</b>ï¼šã€${starter.name}ã€‘æŒæœ‰æ¢…èŠ± 3ï¼Œå¥ªå–é–‹çƒæ¬Šï¼`);
            showNotification(`ğŸš© é–‹å±€å„€å¼ï¼šç”±æŒæœ‰ã€æ¢…èŠ± 3ã€‘çš„ ${starter.name} é–‹å§‹ï¼`);
            
            if (starter.id === 'player') {
                // --- å‹‡è€…ç™¼çƒé»ç« ---
                window.selectedCards = []; 
                if (typeof updateTacticalHelper === 'function') updateTacticalHelper();
                renderPokerTable(table);
            } else {
                // --- AI ç™¼çƒé»ç« ---
                if (window.pokerAITimer) clearTimeout(window.pokerAITimer);
                window.pokerAITimer = setTimeout(() => aiPlayTurn(starterIdx), 1500);
                renderPokerTable(table);
            }
            return;
        }
    }

    // 2. ğŸ”¥ ã€å¾ŒçºŒå±€æ•¸ï¼šéšç´šæ¬ŠåŠ›æ¸…ç®—ã€‘
    // è¦å‰‡ï¼šç”±åœ‹ç‹ (King) æˆ–ä¸Šä¸€å±€è´å®¶å„ªå…ˆç™¼çƒ
    let kingIdx = pokerGame.players.findIndex(p => p.rank === 'king');
    if (kingIdx === -1) kingIdx = 0; 

    pokerGame.turn = kingIdx;
    const leader = pokerGame.players[pokerGame.turn];
    addBattleLog(`ğŸ‘‘ <b style="color:#f1c40f;">ç‹æ¬Šå„ªå…ˆ</b>ï¼šæœ¬å±€ç”±éšç´šå·”å³°ã€${leader.name}ã€‘ç™¼çƒã€‚`);

    if (leader.id === 'player') {
        // --- å‹‡è€…çµ±æ²»é»ç« ---
        window.selectedCards = [];
        // é—œéµï¼šåœ¨æ¸²æŸ“å‰å…ˆè¨ˆç®—æ‰‹ç‰Œçµ„åˆï¼Œç¢ºä¿è¼”åŠ©æŒ‰éˆ•äº®èµ·
        if (typeof updateTacticalHelper === 'function') updateTacticalHelper();
        renderPokerTable(table);
    } else {
        // --- AI çµ±æ²»é»ç« ---
        if (window.pokerAITimer) clearTimeout(window.pokerAITimer);
        window.pokerAITimer = setTimeout(() => aiPlayTurn(pokerGame.turn), 1500);
        renderPokerTable(table);
    }
}


/**
 * ğŸ” ç‰©ç†æª¢ç´¢è¼”åŠ©å™¨ï¼šæ‰€æœ‰æ¨¡çµ„å…±ç”¨
 */
function getKingTitleData(streak) {
    return KING_TITLES.find(t => streak >= t.streak) || KING_TITLES[KING_TITLES.length - 1];
}

/**
 * ğŸš€ Roguelike ç•°èƒ½åŸ·è¡Œä¸­æ¨ï¼š24ç¨®ç‹€æ…‹ã€ç¦å¿Œé“å…·èˆ‡ã€âš–ï¸ ç§˜å¯†å¯†å‡½æ”¿æ²»å”å•†ã€‘å®Œå…¨é›†æˆç‰ˆ
 */
async function applyBoonAndStart(boonId) {
    const hero = pokerGame.players.find(p => p.id === 'player');
    const king = pokerGame.players.find(p => p.rank === 'king');
    const slave = pokerGame.players.find(p => p.rank === 'slave');
    
    if (!hero) return;

    // 1. ğŸ”¥ ã€ç‰©ç†ç‹€æ…‹é–å®šã€‘
    pokerGame.activeBoon = boonId;
    const overlay = document.getElementById('boon-overlay');
    if (overlay) overlay.remove();

    const rank = hero.rank || 'citizen';
    const boonData = RANK_BOON_DATA[rank]?.find(b => b.id === boonId);
    showNotification(`âœ¨ å¥‘ç´„é”æˆï¼šã€${boonData ? boonData.name : boonId}ã€‘ç‰©ç†ç”Ÿæ•ˆï¼`);

    // 2. ğŸ­ ã€ç«‹å³è§¸ç™¼å‹æ©è³œç•°èƒ½ã€‘ (ä¿æŒåŸé‚è¼¯)
    switch (boonId) {
        case 'tyranny': if (slave && typeof openTyrannyTaxUI === 'function') await openTyrannyTaxUI(slave); break;
        case 'joker_king': hero.cards.push({ suit: 'ğŸƒ', value: 'JOKER', power: 200, label: 'JOKER' }); break;
        case 'decree': pokerGame.aiPassRate = 0.5; break;
        case 'elegant': 
            hero.cards = []; initPokerDeck(); 
            for (let i = 0; i < 13; i++) hero.cards.push(pokerGame.deck.pop()); 
            break;
        case 'market': if (typeof openBlackMarketUI === 'function') { openBlackMarketUI(); return; } break;
        case 'luck': if (Math.random() < 0.3) hero.cards.push({ suit: 'â™ ', value: '2', power: 123, label: 'â™ 2' }); break;
        case 'debt_trap': player.coin += 300; break;
        case 'hidden': for (let i = 0; i < 2; i++) hero.cards.push({ suit: 'ğŸƒ', value: 'JOKER', power: 200, label: 'JOKER' }); break;
        case 'betrayal':
            if (king && king.cards.length > 0) {
                king.cards.sort((a, b) => b.power - a.power);
                const kMax = king.cards.shift();
                hero.cards.sort((a, b) => a.power - b.power);
                king.cards.push(hero.cards.shift()); hero.cards.push(kMax);
            }
            break;
        case 'chaos': pokerGame.isChaosStart = true; break;
        case 'despair': showNotification("ğŸ’€ çµ•æœ›å¥‘ç´„ï¼šç¦æ­¢å‡º2ï¼Œé‡‘å¹£+300%"); break;
    }

    // 3. ğŸ©¸ ã€ç‰©ç†æ ¸å¿ƒï¼šç¦å¿Œé“å…·åµæ¸¬å±¤ã€‘
    const forbidden = player.activeForbiddenItem;
    if (forbidden) {
        switch (forbidden) {
            case 'fake_decree': pokerGame.nextAiMustPass = true; break;
            case 'wiretap': 
                const targetIdx = [1, 2, 3][Math.floor(Math.random() * 3)];
                pokerGame.wiretapTarget = targetIdx; 
                break;
            case 'soul_overdraft': 
                for (let i = 0; i < 2; i++) hero.cards.push({ suit: 'ğŸƒ', value: 'JOKER', power: 200, label: 'JOKER', fromSoul: true });
                pokerGame.soulPenaltyActive = true; 
                break;
        }
        player.activeForbiddenItem = null;
    }

    // --- âš–ï¸ 4. ã€ç‰©ç†ä¿®æ­£ï¼šåœ‹ç‹åŒ…åœç¶²æ”¿æ²»å”å•† - å¯†å‡½ç‰ˆã€‘ ---
    if (hero.rank !== 'king') {
        // A. ç³»çµ±åˆ¤å®šï¼šè‹¥åœ‹ç‹é€£èŠ >= 3ï¼Œç‰©ç†è§¸ç™¼ã€ŒåæŠ—è»å¯†å‡½ã€
        if (player.kingStreak >= 3 && !pokerGame.isKingSiege) {
            const accepted = await showSecretLetter("rebel_invite");
            if (accepted) await triggerPhysicalSiege();
        } 
        // B. ç©å®¶è‡ªç™¼æ€§åˆ¤å®š
        else if (!pokerGame.isKingSiege) {
            const wantsToLaunch = await showSecretLetter("player_initiative");
            if (wantsToLaunch) {
                if (Math.random() > 0.4) {
                    showNotification("ğŸŒ‘ ç›Ÿç´„é”æˆï¼šæš—å½±ä¸­çš„å‹¢åŠ›å·²ç‰©ç†éŸ¿æ‡‰ã€‚");
                    await triggerPhysicalSiege();
                } else {
                    showNotification("âŒ å”å•†å¤±æ•—ï¼šå¯†å‡½è¢«åŸæ¨£é€€å›ï¼Œç„¡äººæ•¢æ‡‰ã€‚");
                }
            }
        }
    }

    // --- âš–ï¸ 5. ã€åŒ…åœç¶²æˆç«‹ï¼šç‰©ç†è­¦å‘Šè¦–çª—ã€‘ ---
    if (pokerGame.isKingSiege) {
        await showSiegeWarningPopup();
    }

    // 6. ğŸ”¥ ã€ç‰©ç†é‡æ•´èˆ‡å•Ÿå‹•ã€‘
    hero.cards.sort((a, b) => a.power - b.power);
    if (typeof finalizeStartingTurn === 'function') finalizeStartingTurn();
}

/**
 * ğŸ“œ ç‰©ç†å­ç¨‹åºï¼šé¡¯ç¤ºåæŠ—è»ç§˜å¯†å¯†å‡½ (å«ç„šæ¯€èˆ‡ã€ç°½ç½²éœ‡å‹•ã€‘ç‰¹æ•ˆ)
 */
function showSecretLetter(type) {
    return new Promise((resolve) => {
        const overlay = document.createElement('div');
        overlay.id = "secret-letter-overlay";
        overlay.style = `
            position:fixed; top:0; left:0; width:100%; height:100%; 
            background:rgba(0,0,0,0.95); z-index:110000; 
            display:flex; align-items:center; justify-content:center;
            backdrop-filter: blur(20px); transition: opacity 0.5s;
        `;

        const content = type === "rebel_invite" ? {
            title: "ã€ çµ• å¯† å‘½ ä»¤ ã€‘",
            body: "è‡´ æ·ªè½æ–¼åº•å±¤çš„éˆé­‚ï¼š<br><br>åœ‹ç‹çš„çµ±æ²»å·²éæ–¼å†—é•·ï¼Œç‹åº§ä¸‹çš„è¡€è·¡æ—©å·²ä¹¾æ¶¸ã€‚<br>è²´æ—æ­£åœ¨ç£¨åŠï¼Œå¥´éš¸å·²åœ¨æš—è™•æº–å‚™å¥½äº†ç¹©ç´¢ã€‚<br>åªè¦ä½ é»é ­ï¼Œ<span style='color:#c0392b; font-weight:bold;'>æˆ‘å€‘å°‡äº’ç‚ºè¡€ç›Ÿ</span>ã€‚<br><br>ä½ è¦åŠ å…¥é€™å ´è¦†æ»…æš´æ”¿çš„ç››å®´å—ï¼Ÿ",
            yes: "ã€Œ ç°½ç½²è¡€ç›Ÿ ã€", no: "ã€Œ ç„šæ¯€æ­¤ä¿¡ ã€"
        } : {
            title: "ã€ æŠ• å ç‹€ ã€‘",
            body: "æš—å½±ä¸­çš„ç›Ÿå‹å€‘ï¼š<br><br>æš´å›çš„é€£èŠæ˜¯å°æˆ‘å€‘å°Šåš´çš„ç‰©ç†è¸è¸ã€‚<br>æˆ‘æè­°å»ºç«‹ã€åŒ…åœç¶²ã€‘ï¼Œå…±äº«è³‡æºï¼Œå…±è¬€ç”Ÿè·¯ã€‚<br>è‹¥ä½ å€‘é¡˜æ„å°‡å‘½é‹èˆ‡æˆ‘ç¶å®šï¼Œè«‹åœ¨æ­¤æŒ‰ä¸‹æŒ‡å°ã€‚<br><br>é€™æ˜¯ä¸€å ´æ²’æœ‰é€€è·¯çš„è±ªè³­ã€‚",
            yes: "ã€Œ ç™¼å‡ºé€šä¿¡ ã€", no: "ã€Œ ä¿æŒæ²‰é»˜ ã€"
        };

        overlay.innerHTML = `
            <div id="letter-paper" style="position:relative; width:420px; background:#f4e4bc; border:1px solid #8b4513; 
                        box-shadow: 0 0 50px rgba(0,0,0,1), inset 0 0 100px rgba(139,69,19,0.2);
                        padding:50px 40px; color:#4a2c16; font-family:'serif', 'Noto Serif TC', serif;
                        transform: rotate(-1deg); transition: all 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94);">
                
                <div id="blood-hand-vfx" style="position:absolute; top:40px; right:30px; font-size:110px; opacity:0.35; 
                            color:#8b0000; pointer-events:none; filter: blur(1px); transform: rotate(15deg); 
                            user-select:none; transition: all 0.2s ease-out;">âœ‹</div>
                
                <h2 style="text-align:center; letter-spacing:8px; border-bottom:1px solid #8b4513; padding-bottom:10px;">${content.title}</h2>
                <p style="font-size:17px; line-height:1.9; margin:25px 0;">${content.body}</p>
                
                <div style="display:flex; justify-content:space-around; margin-top:40px;">
                    <button id="btn-accept-letter" style="background:none; border:2px solid #8b4513; color:#8b4513; padding:10px 25px; cursor:pointer; font-weight:bold; font-size:18px; transition:0.3s;">${content.yes}</button>
                    <button id="btn-reject-letter" style="background:none; border:1px solid #aaa; color:#999; padding:10px 25px; cursor:pointer; font-size:14px;">${content.no}</button>
                </div>
            </div>

            <div id="sign-flash-vfx" style="position:fixed; top:0; left:0; width:100%; height:100%; background:#8b0000; opacity:0; pointer-events:none; z-index:110001; transition: opacity 0.1s;"></div>

            <style>
                #btn-accept-letter:hover { background:#8b4513; color:#f4e4bc; transform:scale(1.05); }
                .burn-effect { 
                    filter: brightness(0.1) sepia(1) saturate(10) !important;
                    transform: scale(0.6) rotate(10deg) translateY(200px) !important;
                    opacity: 0 !important;
                }
                /* ç‰©ç†éœ‡å‹•å½±æ ¼å®šç¾© */
                @keyframes heavyShatter {
                    0% { transform: translate(0,0) rotate(-1deg); }
                    10% { transform: translate(-15px, 15px) rotate(-3deg); }
                    20% { transform: translate(15px, -15px) rotate(1deg); }
                    30% { transform: translate(-20px, 0px) rotate(-2deg); }
                    40% { transform: translate(20px, 10px) rotate(0deg); }
                    100% { transform: translate(0,0) rotate(-1deg); }
                }
                .signed-impact { animation: heavyShatter 0.4s ease-out; }
            </style>
        `;

        document.body.appendChild(overlay);

        // ğŸ”¥ ã€æ ¸å¿ƒå¯¦è£ï¼šç°½ç½²è¡€ç›Ÿçš„ç‰©ç†è¡æ“Šã€‘
        document.getElementById('btn-accept-letter').onclick = () => {
            const paper = document.getElementById('letter-paper');
            const hand = document.getElementById('blood-hand-vfx');
            const flash = document.getElementById('sign-flash-vfx');

            // 1. ç‰©ç†è¦–è¦ºç‰¹æ•ˆï¼šæ‰‹å°ç¬é–“åŠ æ·±ä¸¦æ“´å¤§
            hand.style.opacity = "0.9";
            hand.style.transform = "rotate(15deg) scale(1.5)";
            hand.style.filter = "blur(0px) drop-shadow(0 0 20px #f00)";

            // 2. ç‰©ç†é–ƒçˆï¼šç¬é–“ç´…å…‰ç‚¸è£‚
            flash.style.opacity = "0.4";

            // 3. ç‰©ç†éœ‡å‹•ï¼šç´™å¼µèˆ‡èƒŒæ™¯åŒæ­¥åŠ‡éœ‡
            paper.classList.add('signed-impact');
            if (typeof triggerCheatShatterEffect === 'function') triggerCheatShatterEffect();

            showNotification("ğŸ©¸ <b style='color:#f1c40f;'>ç›Ÿç´„å·²æˆ</b>ï¼šå‘½é‹ç‰©ç†é–å®šï¼");

            // 4. ç‰¹æ•ˆçµæŸå¾Œæ·¡å‡º
            setTimeout(() => {
                flash.style.opacity = "0";
                overlay.style.opacity = '0';
                setTimeout(() => { 
                    overlay.remove(); 
                    resolve(true); 
                }, 500);
            }, 600);
        };

        // ç„šæ¯€é‚è¼¯ (ä¿æŒä¸è®Š)
        document.getElementById('btn-reject-letter').onclick = () => {
            const paper = document.getElementById('letter-paper');
            paper.classList.add('burn-effect'); 
            showNotification("ğŸ”¥ ç§˜å¯†å¯†å‡½å·²è¢«ç‰©ç†ç„šæ¯€...");
            setTimeout(() => { overlay.remove(); resolve(false); }, 1000);
        };
    });
}

/**
 * ğŸ—£ï¸ ç‰©ç†å¯¦è£ï¼šåæŠ—è»ç›Ÿå‹è‡´æ„ç³»çµ±
 */
function triggerSiegeGreetings() {
    if (!pokerGame.isKingSiege) return;

    pokerGame.players.forEach((p, idx) => {
        if (p.id === 'player' || p.rank === 'king') return;

        // æ ¹æ“šéšç´šè³¦äºˆä¸åŒçš„é©å‘½å°è©
        const greetings = {
            noble: "æš—å½±ä¸­çš„åŒå¿—ï¼Œæˆ‘çš„åŠèˆ‡è²¡ç”¢æ­¤åˆ»èˆ‡ä½ å…±é³´ã€‚",
            citizen: "çµ‚æ–¼ç­‰åˆ°é€™ä¸€å¤©äº†...è®“æˆ‘å€‘æŠŠé‚£é ‚çš‡å† ç‰©ç†æ€§åœ°æ‹½ä¸‹ä¾†ï¼",
            slave: "é€™æ¢éµéˆï¼Œä»Šå¤©å°±è¦ç‰©ç†æ€§åœ°å¥—åœ¨æš´å›çš„è„–å­ä¸Šã€‚"
        };

        const msg = greetings[p.rank] || "æš—å½±ä¸­çš„åŒå¿—ï¼Œå‘ä½ è‡´æ„ã€‚";
        
        // å»¶é²è§¸ç™¼æ°£æ³¡ï¼Œç‡Ÿé€ å‡ºä¸€å€‹æ¥ä¸€å€‹è¡¨æ…‹çš„æ„Ÿè¦º
        setTimeout(() => {
            if (typeof triggerAISpeech === 'function') triggerAISpeech(idx, msg);
        }, 800 + (idx * 600));
    });
}

/**
 * ğŸ§± ç‰©ç†å­ç¨‹åºï¼šé¡¯ç¤ºå¼·åˆ¶ç¢ºèªçš„è­¦å‘Šè³‡è¨Š
 */
function showSiegeWarningPopup() {
    return new Promise((resolve) => {
        const popup = document.createElement('div');
        popup.style = `
            position:fixed; top:0; left:0; width:100%; height:100%; 
            background:rgba(0,0,0,0.9); z-index:100000; 
            display:flex; flex-direction:column; align-items:center; justify-content:center;
            border: 5px solid #e74c3c; box-sizing: border-box; animation: flashRed 1s infinite alternate;
        `;
        
        popup.innerHTML = `
            <h1 style="color:#e74c3c; font-size:48px; letter-spacing:10px; text-shadow:0 0 20px #f00;">âš–ï¸ åœ‹ç‹åŒ…åœç¶²æˆç«‹</h1>
            <div style="color:white; font-size:18px; line-height:1.8; text-align:center; max-width:500px; margin:30px 0; background:rgba(255,255,255,0.05); padding:20px; border-radius:10px;">
                âš ï¸ <b style="color:#f1c40f;">ç‰©ç†æ•ˆæ‡‰å·²å•Ÿå‹•</b>ï¼š<br>
                1. æ‰€æœ‰åæŠ—è»æˆå“¡ (AI) ç›¸äº’å‹å¥½ï¼Œä¸æœƒäº’ç›¸å£“ç‰Œã€‚<br>
                2. åæŠ—è»æˆå“¡å‰›å®Œæˆäº†æœ€å¼· 3 å¼µç‰Œçš„ç§˜å¯†äº¤æ›ã€‚<br>
                3. åæŠ—è»å…¨å“¡å„ç²å¾—ä¸€å¼µ <span style="color:#f1c40f;">JOKER</span> æ´åŠ©ã€‚<br>
                4. è‹¥åœ‹ç‹å®ˆä½ç‹æ¬Šï¼Œæˆ°åˆ©å“å°‡ç‰©ç†ç‹‚æš´åŒ–ï¼
            </div>
            <button id="close-siege-popup" style="padding:15px 60px; background:#e74c3c; color:white; border:none; border-radius:30px; font-weight:bold; font-size:20px; cursor:pointer; box-shadow:0 0 20px #e74c3c;">
                æ¥å—æŒ‘æˆ° (ç‰©ç†ç¢ºèª)
            </button>
            <style>
                @keyframes flashRed { from { border-color: #600; } to { border-color: #f00; } }
            </style>
        `;

        document.body.appendChild(popup);
        document.getElementById('close-siege-popup').onclick = () => {
            popup.remove();
            resolve();
        };
    });
}

/**
 * ğŸ§¬ ç‰©ç†å­ç¨‹åºï¼šå•Ÿå‹•åŒ…åœç¶²æ•¸æ“šæµ
 */
async function triggerPhysicalSiege() {
    pokerGame.isKingSiege = true;
    // ç«‹å³è§¸ç™¼æ›ç‰Œèˆ‡æ´åŠ©é‚è¼¯
    if (typeof runTaxCeremony === 'function') {
        await runTaxCeremony(); // å…§éƒ¨å·²æœ‰ if(isKingSiege) é‚è¼¯
    }
}

/**
 * ğŸšï¸ ç‰©ç†å­ç¨‹åºï¼šé–‹å•Ÿç‹åœ‹è£œçµ¦ä¸­æ¨ (V5.6 æ¸²æŸ“å°æ­£ç‰ˆ)
 * ä½œç”¨ï¼šæ•´åˆåº«å­˜é¡¯ç¤ºã€è³¼ç‰©è»Šå®¹å™¨ã€ä¸¦ç¢ºä¿æ¯å€‹ ID ç‰©ç†å°é½Š
 */
function openKingdomShop() {
    const existing = document.getElementById('kingdom-shop-modal');
    if (existing) existing.remove();

    const shop = document.createElement('div');
    shop.id = "kingdom-shop-modal";
    shop.style = `position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); width:460px; background:rgba(12,12,12,0.98); border:2px solid #3498db; color:#eee; padding:25px; z-index:120000; border-radius:20px; box-shadow:0 20px 100px #000; backdrop-filter:blur(25px); font-family:monospace;`;

    // ğŸ† ç‰©ç†å¤§ä¸€çµ±å•†å“æ± ï¼šåŒ…å«é†«ç™‚è€—æèˆ‡ç¦å¿Œé“å…· [cite: 2026-01-21]
    const items = [
        { id: 'hp_pot', name: 'ğŸº å·¨å¤§è£œè¡€ç½', price: 200, dust: 0, desc: 'æ¯ç§’æ¢å¾© 20HPï¼ŒæŒçºŒ 60 ç§’ã€‚' },
        { id: 'potion', name: 'ğŸ§´ æ™®é€šè£œè¡€è—¥', price: 100, dust: 0, desc: 'ç¬é–“æ¢å¾©å°‘é‡ç”Ÿå‘½å€¼ã€‚' },
        { id: 'antidote', name: 'ğŸ§ª ç‰¹æ•ˆè§£æ¯’è—¥', price: 200, dust: 0, desc: 'ç‰©ç†æ¸…é™¤ã€ä¸­æ¯’ã€‘ç‹€æ…‹ã€‚' },
        { id: 'hemostat', name: 'ğŸ©¹ æ­¢è¡€åŠ‘', price: 200, dust: 0, desc: 'ç‰©ç†æ¸…é™¤ã€å‡ºè¡€ã€‘ç‹€æ…‹ã€‚' },
        { id: 'stimulant', name: 'ğŸ’‰ èˆˆå¥®åŠ‘', price: 200, dust: 0, desc: 'ç‰©ç†æ¸…é™¤ã€éº»ç—ºã€‘ç‹€æ…‹ã€‚' },
        { id: 'scroll_king', name: 'ğŸ“œ åœ‹ç‹è®Šèº«å·è»¸', price: 1500, dust: 0, desc: 'ç‰©ç†ä¿®æ”¹å¥‘æ“šï¼Œä¸‹å±€å¼·åˆ¶ä»¥ã€åœ‹ç‹ã€‘èº«åˆ†å…¥å ´ã€‚' },
        { id: 'scroll_noble', name: 'ğŸ“œ è²´æ—è®Šèº«å·è»¸', price: 800, dust: 0, desc: 'å½é€ çš„å®¶å¾½ï¼Œä¸‹å±€ä»¥ã€è²´æ—ã€‘èº«åˆ†å…¥å ´ã€‚' },
        { id: 'fake_decree', name: 'ğŸ“œ å½é€ çš„è–æ—¨', price: 2000, dust: 5, desc: 'ç‰©ç†å¨å£“ã€‚ä¸‹å±€å¼·è¿«ä¸‹ä¸€ä½ AI å¿…é ˆ Passã€‚' },
        { id: 'wiretap', name: 'ğŸ“¡ ç¦å¿Œç«Šè½å™¨', price: 3500, dust: 10, desc: 'æƒ…å ±æˆ°ã€‚æœ¬å±€æ°¸ä¹…çœ‹ç©¿éš¨æ©Ÿä¸€å AI çš„æ‰‹ç‰Œã€‚' },
        { id: 'soul_overdraft', name: 'ğŸ’€ éˆé­‚é€æ”¯', price: 0, dust: 25, desc: 'ç¦å¿Œå¥‘ç´„ã€‚ç«‹å³ç² 2 å¼µé¬¼ç‰Œï¼Œè‹¥è¼¸å‰‡ç‰©ç†å€’æ‰£ 3 ç´šã€‚' }
    ];

    shop.innerHTML = `
        <div style="text-align:center; margin-bottom:20px;">
            <b style="color:#f1c40f; font-size:22px; letter-spacing:4px;">ğŸšï¸ ç‹åœ‹è£œçµ¦ä¸­æ¨</b>
            <div style="font-size:11px; color:#888; margin-top:8px;">
                ğŸ’° è³‡é‡‘ï¼š<span id="shop-coin-display" style="color:#fff;">${player.coin.toLocaleString()}</span> G 
                ${player.phantomDust > 0 ? `| âœ¨ å¡µåŸƒï¼š<span style="color:#d5a6bd;">${player.phantomDust}</span>` : ''}
            </div>
        </div>

        <div style="max-height:350px; overflow-y:auto; padding-right:12px; scrollbar-width:thin;">
            ${items.map(item => {
                const isForbidden = item.dust > 0;
                const finalPrice = (player.hasVipCard && !isForbidden) ? Math.floor(item.price * 0.8) : item.price;
                
                // ğŸ”¥ æ ¸å¿ƒä¿®æ­£ï¼šè®€å–ç›®å‰å‹‡è€…èº«ä¸Šçš„åº«å­˜æ•¸é‡ [cite: 2026-02-06]
                const currentOwned = (player.items && player.items[item.id]) ? player.items[item.id] : 0;

                return `
                <div style="border:1px solid #333; background:rgba(255,255,255,0.02); padding:15px; margin-bottom:12px; border-radius:15px;">
                    <div style="display:flex; justify-content:space-between; align-items:start;">
                        <div style="flex:1;">
                            <div style="display:flex; align-items:center; gap:8px;">
                                <b style="color:${isForbidden ? '#9b59b6' : '#2ecc71'};">${item.name}</b>
                                <span style="font-size:9px; padding:2px 6px; border-radius:4px; background:${currentOwned > 0 ? '#145a32' : '#300'}; color:${currentOwned > 0 ? '#2ecc71' : '#ff4d4d'}; border:1px solid ${currentOwned > 0 ? '#1e8449' : '#600'};">
                                    æŒæœ‰: ${currentOwned}
                                </span>
                            </div>
                            <div style="font-size:10px; color:#777; margin-top:6px; line-height:1.4;">${item.desc}</div>
                        </div>
                        <div style="text-align:right;">
                            <div style="font-size:11px; color:#f1c40f; margin-bottom:8px; font-weight:bold;">
                                ${finalPrice > 0 ? `ğŸ’°${finalPrice}` : ''}${isForbidden ? ` âœ¨${item.dust}` : ''}
                            </div>
                            <input type="number" id="qty-${item.id}" value="0" min="0" max="99" oninput="window.updateShopCart()"
                                   style="width:50px; background:#000; border:1px solid #3498db; color:#fff; text-align:center; border-radius:8px; padding:6px; font-weight:bold; outline:none;">
                        </div>
                    </div>
                </div>`;
            }).join('')}
        </div>

        <div id="shop-cart-footer" style="margin-top:20px; padding-top:15px; border-top:2px dashed #444;">
            <div id="cart-items-list" style="font-size:11px; color:#2ecc71; min-height:24px; margin-bottom:15px; line-height:1.6;">
                <span style="color:#444;">(å°šæœªé¸å–ç‰©è³‡)</span>
            </div>
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; background:rgba(0,0,0,0.3); padding:10px; border-radius:8px;">
                <b style="color:#888;">çµç®—ç¸½é¡:</b>
                <div style="text-align:right;">
                    <b id="cart-total-price" style="font-size:20px; color:#f1c40f; display:block;">0 G</b>
                    <b id="cart-total-dust" style="font-size:14px; color:#d5a6bd;"></b>
                </div>
            </div>
            <div style="display:flex; gap:12px;">
                <button id="btn-cart-checkout" onclick="window.checkoutCart()" disabled style="flex:2; background:#333; color:#666; border:none; padding:16px; border-radius:12px; font-weight:bold; cursor:not-allowed; transition:0.3s; letter-spacing:2px;">ç¢ºèªæ‰¹æ¬¡è³¼è²·</button>
                <button onclick="this.parentElement.parentElement.parentElement.remove()" style="flex:1; background:#222; border:1px solid #444; color:#888; border-radius:12px; cursor:pointer; font-weight:bold;">é›¢é–‹</button>
            </div>
        </div>
    `;
    document.body.appendChild(shop);
    window.updateShopCart(); // åˆå§‹åŒ–ç‹€æ…‹
}



/**
 * ğŸ’° ç‰©ç†è³¼è²·ä¸­æ¨ï¼šæ”¯æŒé›™å¹£æ”¯ä»˜èˆ‡ç¦å¿Œç‹€æ…‹é–å®š
 */
async function buyForbiddenItem(itemId, price, dust) {
    const isVip = player.hasVipCard;
    const isForbidden = dust > 0;
    
    // 1. ğŸ”¥ ã€ç‰©ç†é‹ç®—ã€‘è¨ˆç®—å¯¦éš›æˆæœ¬
    const actualCoin = (isVip && !isForbidden) ? Math.floor(price * 0.8) : price;
    const actualDust = dust;

    // 2. ç‰©ç†é¤˜é¡æª¢æŸ¥
    if (player.coin < actualCoin || (player.phantomDust || 0) < actualDust) {
        showNotification("ğŸ’€ å®ˆé–€äººï¼šè³‡æºä¸è¶³ä¹Ÿæƒ³è¦¬è¦¦ç¦å¿Œä¹‹ç‰©ï¼Ÿ");
        return;
    }

    // 3. åŸ·è¡Œæ‰£æ¬¾
    player.coin -= actualCoin;
    player.phantomDust -= actualDust;
    player.totalShopSpent = (player.totalShopSpent || 0) + actualCoin;

    // 4. ğŸ”¥ ã€ç¦å¿Œç‹€æ…‹ç‰©ç†æ›è¼‰ã€‘
    // å°‡è³¼è²·çš„é“å…· ID å­˜å…¥ç©å®¶è‡¨æ™‚ç‹€æ…‹ï¼Œä¸‹å±€é–‹å±€è§¸ç™¼
    player.activeForbiddenItem = itemId; 
    
    // VIP æ™‰å‡åˆ¤å®š
    if (!player.hasVipCard && player.totalShopSpent >= 5000) {
        player.hasVipCard = true;
        showNotification("ğŸšï¸ æ­å–œå‡ç´šç‚ºã€é»‘å¸‚è²´è³“ã€‘ï¼");
    }

    showNotification(`ğŸ”® äº¤æ˜“é”æˆï¼šã€${itemId}ã€‘å·²é€²å…¥æº–å‚™ç‹€æ…‹ï¼`);

    // 5. ç‰©ç†åŒæ­¥
    updatePlayerUI();
    if (typeof savePlayerToDB === 'function') await savePlayerToDB();
    openKingdomShop(); // åˆ·æ–° UI é¡¯ç¤ºæœ€æ–°é¤˜é¡
}


/**
 * ğŸ’° ç‰©ç†è³¼è²·é‚è¼¯ï¼šæ•´åˆç¦å¿Œé›™å¹£æ”¯ä»˜ã€VIP ç³»çµ±èˆ‡æ•ˆæœé–å®š
 * @param {string} itemId é“å…· ID
 * @param {number} price åŸºç¤é‡‘å¹£åƒ¹æ ¼
 * @param {number} dust åŸºç¤å¡µåŸƒåƒ¹æ ¼
 */
async function buyKingdomItem(itemId, price, dust = 0) {
    // 0. ğŸ”¥ ã€ç‰©ç†åˆ¤å®šã€‘æ˜¯å¦ç‚ºç¦å¿Œé“å…·
    const isForbidden = dust > 0;
    const isVip = player.hasVipCard;

    // 1. ğŸ”¥ ã€ç‰©ç†é‹ç®—ï¼šæŠ˜æ‰£æ ¡æº–ã€‘
    // è¦å‰‡ï¼šåªæœ‰æ™®é€šé“å…·äº«å— VIP æŠ˜æ‰£ï¼Œç¦å¿Œé“å…·åƒ¹æ ¼ç‰©ç†é–å®š
    const actualCoin = (isVip && !isForbidden) ? Math.floor(price * 0.8) : price;
    const actualDust = dust;

    // 2. ç‰©ç†è³‡æºæª¢æŸ¥
    if (player.coin < actualCoin || (player.phantomDust || 0) < actualDust) {
        showNotification("ğŸ’€ å®ˆé–€äººï¼šè³‡æºä¸è¶³ä¹Ÿæƒ³çªºæ¢ç¦å¿Œï¼Ÿæ»¾ï¼");
        return;
    }

    // 3. åŸ·è¡Œç‰©ç†æ‰£æ¬¾èˆ‡ç´€éŒ„
    player.coin -= actualCoin;
    player.phantomDust = (player.phantomDust || 0) - actualDust;
    player.totalShopSpent = (player.totalShopSpent || 0) + actualCoin;

    // 4. ğŸ”¥ ã€ç‰©ç†æ™‰å‡åˆ¤å®šã€‘
    if (!isVip && player.totalShopSpent >= 5000) {
        player.hasVipCard = true;
        showNotification("ğŸšï¸ æ­å–œï¼ä½ å·²æˆç‚ºã€é»‘å¸‚è²´è³“ã€‘ï¼Œæœªä¾†æ‰€æœ‰å•†å“ç‰©ç†æ‰“ 8 æŠ˜ï¼");
        if (!player.inventory.includes("ğŸšï¸ é»‘å¸‚è²´è³“å¡")) {
            player.inventory.push("ğŸšï¸ é»‘å¸‚è²´è³“å¡");
        }
    }

    // --- ğŸ“¦ ç‰©ç†æ•ˆæœåˆ†æµè™•ç† ---
    switch(itemId) {
        // --- ç¦å¿Œå€ (Forbidden) ---
        case 'fake_decree':
            player.activeForbiddenItem = 'fake_decree';
            showNotification("ğŸ“œ å½é€ è–æ—¨å·²ç‰©ç†å‚™æˆ°ï¼šä¸‹å±€å¼·åˆ¶ä¸‹ä¸€ä½ AI è‡£æœã€‚");
            break;
            
        case 'wiretap':
            player.activeForbiddenItem = 'wiretap';
            showNotification("ğŸ“¡ ç«Šè½å™¨å·²æ›è¼‰ï¼šä¸‹å±€å°‡ç‰©ç†é€è¦–éš¨æ©Ÿå°æ‰‹ã€‚");
            break;
            
        case 'soul_overdraft':
            player.activeForbiddenItem = 'soul_overdraft';
            showNotification("ğŸ’€ éˆé­‚å¥‘ç´„å·²ç°½ç½²ï¼šå…©å¼µé¬¼ç‰Œå·²å°±ä½ï¼Œæ•—å±€ä»£åƒ¹ç‰©ç†é–å®šã€‚");
            break;

        // --- å¸¸è¦å€ (Standard) ---
        case 'scroll_king':
            pokerGame.forceNextRank = 'king';
            showNotification("ğŸ“œ å¥‘ç´„ç°½ç½²å®Œæˆã€‚ä¸‹å±€ä½ å°±æ˜¯é€™åº§ç‹åœ‹çš„ä¸»äººã€‚");
            break;
            
        case 'scroll_noble':
            pokerGame.forceNextRank = 'noble';
            showNotification("ğŸ“œ å½é€ æ–‡ä»¶å·²ç”Ÿæ•ˆã€‚ä½ ç²å¾—äº†æš«æ™‚çš„è²´æ—æ¬Šé™ã€‚");
            break;
            
        case 'cat_finger':
            pokerGame.luckyDrawChance = 0.3;
            showNotification("ğŸ¾ è²“æ‰‹æŒ‡åœ¨å£è¢‹ç™¼ç†±... æ‰‹æ°£ä¼¼ä¹è®Šå¥½äº†ã€‚");
            break;
            
        case 'fake_coin':
            pokerGame.antiFake = true;
            showNotification("ğŸª™ ä½ åœ¨æ‰‹ä¸­è½‰å‹•ç¡¬å¹£ï¼Œä¸å†æ‡¼æ€•é»‘å¸‚çš„é¨™å±€ã€‚");
            break;
            
        default:
            const item = MASTER_COLLECTION.find(i => i.id === itemId) || { name: itemId };
            player.inventory.push(item.name);
            showNotification(`ğŸ“¦ ç²å¾—äº†ï¼š${item.name}`);
    }

    // 5. ğŸ”¥ ã€æ•¸æ“šç‰©ç†åŒæ­¥ã€‘
    updatePlayerUI();
    
    // ç‰©ç†é–å®šåˆ°è³‡æ–™åº«
    if (typeof savePlayerToDB === 'function') await savePlayerToDB();
    
    // ç«‹å³åˆ·æ–°å•†åº—ä»‹é¢
    if (typeof openKingdomShop === 'function') openKingdomShop(); 
}

/**
 * ğŸ¦ ç‰©ç†å­ç¨‹åºï¼šåŸ·è¡Œåœ‹åº«è‡ªå‹•ç”Ÿæ¯ (V5.9.11 å®Œå…¨å°æ­£ç‰ˆ)
 * ä½œç”¨ï¼š
 * 1. æª¢ç´¢ã€Œä¸­å¤®é‡‘åº«ã€ç­‰ç´šã€‚
 * 2. åŸºç¤åˆ©ç‡ 0.5%ï¼Œæ¯ç´šç‰©ç†æå‡ 0.005% (Lv.1000 æ™‚å¯é” 5.5%)ã€‚ [cite: 2026-02-06]
 * 3. åŸ·è¡Œè¤‡åˆ©è¨ˆç®—ä¸¦æ›´æ–°åœ‹åº«ç¸½é¡ï¼Œå›å‚³æ•¸å€¼ä¾› UI ä½¿ç”¨ã€‚
 * @returns {number} ç”¢ç”Ÿçš„åˆ©æ¯é‡‘é¡
 */
function applyTreasuryInterest() {
    const sys = window.kingdomSystem;
    // ğŸ›¡ï¸ ç‰©ç†é˜²ç¦¦ï¼šç¢ºä¿ç³»çµ±ç‰©ä»¶èˆ‡è¨­æ–½è³‡æ–™éˆè·¯æ­£å¸¸ [cite: 2026-01-21]
    if (!sys || !sys.upgrades || !sys.upgrades.vault) return 0;

    // 1. ğŸ”¥ ã€ç‰©ç†åˆ©ç‡æ¼”ç®—ã€‘
    const vaultLv = sys.upgrades.vault.lv || 0;
    // ç‰©ç†å…¬å¼ï¼š0.005 (0.5%) + (ç­‰ç´š * 0.00005)
    const interestRate = 0.005 + (vaultLv * 0.00005);
    
    // 2. ğŸ’° ã€è¤‡åˆ©å¢å€¼ã€‘
    const currentTreasury = sys.treasury || 0;
    const interestGained = Math.floor(currentTreasury * interestRate);
    
    if (interestGained > 0) {
        // ç‰©ç†æ³¨å…¥ï¼šç›´æ¥å¢åŠ åœ‹åº«å¯¦é«”å„²å‚™ [cite: 2026-02-06]
        sys.treasury += interestGained;
        
        // 3. ğŸ“Š ã€æˆ°è¡“è¨˜éŒ„ã€‘
        // ç¢ºä¿é—œéµå­—ã€Œé‡‘åº«ç”Ÿæ¯ã€è§¸ç™¼æ—¥èªŒæŸ“è‰²å¼•æ“
        addBattleLog(`ğŸ¦ <b style="color:#f1c40f;">[é‡‘åº«ç”Ÿæ¯]</b> ä¸­å¤®é‡‘åº« (Lv.${vaultLv}) ç”¢ç”Ÿäº† $${interestGained.toLocaleString()} G åˆ©æ¯ã€‚`);
        console.log(`%cğŸ“ˆ åœ‹åº«å¢å€¼ï¼šåˆ©ç‡ ${(interestRate * 100).toFixed(3)}%ï¼Œæ”¶ç›Š ${interestGained}`, "color: #f1c40f; font-weight: bold;");
    } else {
        console.log("ğŸ“‰ åœ‹åº«å„²å‚™ä¸è¶³æˆ–åˆ©ç‡éä½ï¼Œæœ¬å±€æœªç”¢ç”Ÿå¯è¨ˆé‡åˆ©æ¯ã€‚");
    }

    // ğŸ”¥ æ ¸å¿ƒä¿®æ­£ï¼šå¿…é ˆå›å‚³æ•¸å€¼ï¼Œå¦å‰‡çµç®— UI æœƒé¡¯ç¤º undefined
    return interestGained;
}



/**
 * ğŸ† çµç®—ç•°èƒ½èˆ‡ç¥å™¨é€£å‹•å®Œå…¨é«” (æ•´åˆï¼šåœ‹ç‹åŒ…åœç¶²ç¶“æ¿Ÿå¤±è¡¡æ©Ÿåˆ¶)
 */
async function applyBoonToResults(winAmount, winner) {
    const boon = pokerGame.activeBoon;
    const hero = pokerGame.players.find(p => p.id === 'player');
    let finalWin = winAmount;

    // --- ğŸ©¸ 0. ã€ç’°å¢ƒåœ–å±¤ï¼šåœ‹ç‹åŒ…åœç¶²åˆ¶è£ã€‘ ---
    // åˆ¤å®šç•¶å‰æ˜¯å¦è™•æ–¼åŒ…åœç¶²ç‹€æ…‹ (pokerGame.isKingSiege)
    if (pokerGame.isKingSiege) {
        if (winner.id === 'player' && hero.rank === 'king') {
            // ğŸ”¥ ã€ç‰©ç†è£œå„Ÿã€‘åœ‹ç‹ç²å‹ï¼šæ”¶å…¥éš¨é€£èŠæ•¸å¤§å¹…æå‡ (ç‹‚æš´çµ±æ²»)
            // å…¬å¼ï¼šåŸºç¤çå‹µ * (1 + 0.2 * é€£èŠæ•¸)
            const siegeMultiplier = 1 + (player.kingStreak * 0.2);
            finalWin = Math.floor(finalWin * siegeMultiplier);
            showNotification(`ğŸ‘‘ <b style="color:gold;">ç‹‚æš´çµ±æ²»</b>ï¼šåœ¨åŒ…åœç¶²ä¸­å®ˆä½ç‹æ¬Šï¼Œæ”¶ç›Šç‰©ç†å¢å¹… ${Math.round(siegeMultiplier*100)}%ï¼`);
        } 
        else if (winner.id === 'player' && hero.rank !== 'king') {
            // ğŸ“‰ ã€ç‰©ç†åˆ¶è£ã€‘åæŠ—è»ç²å‹ï¼šå› æˆ°äº‹å‹•å“¡å°è‡´ç‰©è³‡åŒ±ä¹ï¼Œæ”¶å…¥ç‰©ç†å‰Šæ¸› 40%
            finalWin = Math.floor(finalWin * 0.6);
            showNotification("ğŸ¤ <b style='color:#e74c3c;'>æˆ°äº‹æ¶ˆè€—</b>ï¼šåŒ…åœç¶²æœŸé–“ç‰©è³‡åŒ±ä¹ï¼Œé‡‘å¹£æ”¶ç›Šç‰©ç†å‰Šæ¸› 40%ã€‚");
        }
    }

    // --- ğŸ­ 1. ã€ç¬¬ä¸€åœ–å±¤ï¼šRoguelike æ©è³œå€ç‡ã€‘ (ä¹˜æ³•å€) ---
    if (winner.id === 'player') {
        if (boon === 'treasury') {
            finalWin *= 2;
            showNotification("ğŸ’° åœ‹åº«å……ç›ˆï¼šçé‡‘ç‰©ç†ç¿»å€ï¼");
        }
        if (boon === 'destiny') {
            finalWin *= 5;
            pokerGame.forceNextRank = 'king'; 
            showNotification("âœ¨ å‘½é‹ç¿»è½‰ï¼šä½ è™•æ±ºäº†æ‰€æœ‰äººä¸¦ç™»åŸºç‚ºç‹ï¼");
        }
        if (boon === 'despair') {
            finalWin *= 3;
            showNotification("ğŸ’€ çµ•æœ›å¥‘ç´„ï¼šä»¥ç—›è‹¦æ›å– 3 å€è²¡å¯Œã€‚");
        }
    }

    // --- ğŸ›¡ï¸ 2. ã€ç¬¬äºŒåœ–å±¤ï¼šç¥å™¨ç‰©ç†å…±é³´ã€‘ (ç™¾åˆ†æ¯”åŠ æˆå€) ---
    if (winner.id === 'player') {
        const hasFragment = player.inventory.includes("ğŸ‘‘ è¡€è…¥ç‹æ¬Šç¢ç‰‡");
        const hasFullCrown = player.inventory.includes("ğŸ‘‘ å§‹ç¥–ç‹çš„çœŸçš‡å† ");

        if (hasFullCrown) {
            finalWin = Math.floor(finalWin * 1.5); // çœŸçš‡å† ç‰©ç†åŠ æˆ 50%
            showNotification("ğŸ‘‘ å§‹ç¥–ç‹æ¬Šï¼šå¨åš´è®“æˆ°åˆ©å“æå‡äº† 50%ï¼");
        } else if (hasFragment) {
            finalWin = Math.floor(finalWin * 1.15); // ç¢ç‰‡ç‰©ç†åŠ æˆ 15%
            showNotification("âœ¨ ç‹æ¬Šå…±é³´ï¼šçå‹µé¡å¤–ç‰©ç†æå‡ 15%ï¼");
        }
    }

    // --- ğŸ”¨ 3. ã€ç¬¬ä¸‰åœ–å±¤ï¼šå›ºå®šæ´¥è²¼ã€‘ (åŠ æ³•å€) ---
    if (winner.id === 'player') {
        if (boon === 'work') {
            finalWin += 100;
            showNotification("ğŸ”¨ å‹¤å¥®å‹å‹•ï¼šé ˜å–é¡å¤–æ´¥è²¼ 100Gï¼");
        }
    }

    // 4. ç‰©ç†æ•¸å€¼é˜²ç¦¦
    return Math.floor(Math.max(0, finalWin));
}

/**
 * ğŸ“œ ç‰©ç†å­ç¨‹åºï¼šæª„æ–‡å¾è¨è¦–è¦ºæ•ˆæœ (å¢å¼·äº’å‹•ç‰ˆ)
 * ä¿®æ­£ï¼š
 * 1. éœ‡å‹•é–å®šï¼šæŒçºŒéœ‡å‹•ç›´åˆ°ç©å®¶é»æ“Šç¢ºèªï¼Œç‡Ÿé€ ç„¡æ³•å¿½è¦–çš„å£“è¿«æ„Ÿã€‚
 * 2. è¦–è¦ºå¼·åŒ–ï¼šåŠ å…¥ç´…è‰²å‘¼å¸å…‰æšˆ (siegeRedPulse)ã€‚
 */
function triggerSiegeAnnouncement() {
    // 1. ç‰©ç†ç§»é™¤èˆŠæœ‰é®ç½© (é˜²æ­¢é€£é»å †ç–Š)
    const existing = document.getElementById('siege-overlay');
    if (existing) existing.remove();

    // 2. æ³¨å…¥å‘¼å¸ç‡ˆ CSS (å¦‚æœå°šæœªå­˜åœ¨)
    if (!document.getElementById('siege-pulse-style')) {
        const style = document.createElement('style');
        style.id = 'siege-pulse-style';
        style.innerHTML = `@keyframes siegeRedPulse { 0% { box-shadow: 0 0 30px #600; } 100% { box-shadow: 0 0 80px #f00; } }`;
        document.head.appendChild(style);
    }

    const overlay = document.createElement('div');
    overlay.id = 'siege-overlay';
    overlay.style = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(10, 0, 0, 0.9); z-index: 200000;
        display: flex; align-items: center; justify-content: center;
        flex-direction: column; animation: fadeIn 0.3s ease;
        backdrop-filter: blur(15px); color: #fff; text-align: center;
    `;
    
    overlay.innerHTML = `
        <div style="border: 3px solid #ff4d4d; padding: 40px; background: rgba(20, 0, 0, 0.8); 
                    animation: siegeRedPulse 1s infinite alternate; border-radius: 8px; max-width: 500px;">
            <h1 style="color:#ff4d4d; font-size:48px; margin:0; letter-spacing:10px; text-shadow: 0 0 20px #f00; border-bottom: 1px solid #600; padding-bottom: 20px;">
                æª„ æ–‡ å¾ è¨
            </h1>
            <p style="font-size:16px; color:#ccc; margin:30px 0; letter-spacing:2px; line-height: 1.8;">
                æš´æ”¿å·²ä¹…ï¼Œæ°‘æ€¨æ²¸é¨°ã€‚<br>
                åæŠ—è»å·²æ–¼æš—è™•ç· çµè¡€ç›Ÿï¼Œèª“è¨€æ‹‰ä¸‹æ®˜æš´çš„çµ±æ²»è€…ï¼
            </p>
            <div style="margin-top:30px; background: rgba(255, 0, 0, 0.1); padding: 15px; border-left: 4px solid #ff4d4d;">
                <div style="color:#f1c40f; font-weight:bold; font-size:20px; margin-bottom: 5px;">âš ï¸ åœ‹ç‹åŒ…åœç¶²å•Ÿå‹•</div>
                <div style="color:#aaa; font-size: 12px;">AI ç©å®¶å°‡çµç›Ÿäº’ä¿ï¼Œä¸¦å…±äº«æˆ°ç•¥è³‡æºã€‚</div>
            </div>
            <button id="btn-accept-siege" style="margin-top:40px; background:#ff4d4d; color:white; border:none; padding:15px 50px; font-size:20px; font-weight:bold; cursor:pointer; border-radius:4px; box-shadow: 0 5px 15px rgba(255, 0, 0, 0.4); transition: 0.2s;">
                é ˜ æ—¨ æ¥ æˆ°
            </button>
        </div>
    `;
    document.body.appendChild(overlay);
    
    // 3. å•Ÿå‹•æŒçºŒæ€§ç‰©ç†éœ‡å‹•
    const table = document.getElementById('poker-table');
    if (table) {
        // ä½¿ç”¨ infinite è®“å®ƒä¸€ç›´éœ‡ï¼Œç›´åˆ°ç©å®¶è™•ç†
        table.style.animation = "dqShake 0.8s infinite"; 
    }

    // 4. ç¶å®šæŒ‰éˆ•äº‹ä»¶ (é»æ“Šå¾Œæ‰åœæ­¢éœ‡å‹•)
    document.getElementById('btn-accept-siege').onclick = () => {
        overlay.style.opacity = '0';
        overlay.style.transition = 'opacity 0.5s';
        
        // åœæ­¢éœ‡å‹•
        if (table) table.style.animation = "";
        
        // æ’­æ”¾ç¢ºèªéŸ³æ•ˆæˆ–æ—¥èªŒ
        if (typeof addBattleLog === 'function') {
            addBattleLog("âš”ï¸ <b style='color:#f1c40f;'>[ç³»çµ±]</b> ç©å®¶å·²ç°½ç½²ç”Ÿæ­»ç‹€ï¼Œæˆ°çˆ­é–‹å§‹ï¼");
        }

        setTimeout(() => overlay.remove(), 500);
    };
}

// åœ¨ finishPokerGame å…§èª¿ç”¨ï¼š
// winAmount = await applyBoonToResults(winAmount, winner);
/**
 * --- ğŸƒ æ¸²æŸ“æ¡Œé¢ä¸­å¿ƒï¼šç‰©ç†å‘ˆç¾å››æ–¹ä½ç‰Œçµ„ã€ç•°èƒ½ç‹€æ…‹èˆ‡ã€âš–ï¸ åœ‹ç‹åŒ…åœç¶²ã€‘ ---
 */
function renderTableCenter() {
    const tableCenter = document.getElementById('table-center');
    if (!tableCenter) return;

    // 1. ğŸ”¥ ã€ç‰©ç†æ ¸å¿ƒï¼šæ§‹å»ºå…¨å±€ç‹€æ…‹å¸¶ (Status Belt)ã€‘
    // æˆ‘å€‘éœ€è¦æŠ“å–ç•¶å‰ç©å®¶ç•°èƒ½èˆ‡åŒ…åœç¶²ç‹€æ…‹
    const hero = pokerGame.players.find(p => p.id === 'player');
    const heroBoon = pokerGame.activeBoon;
    const isSiege = pokerGame.isKingSiege; // åœ‹ç‹åŒ…åœç¶²æ¨™è¨˜

    // 2. ç‰©ç†é‡æ§‹ä¸­å¿ƒå€åŸŸå…§å®¹
    tableCenter.innerHTML = `
        <div id="status-belt-inner" style="position:absolute; top:-40px; width:100%; display:flex; justify-content:center; gap:10px; z-index:100;">
            ${isSiege ? `
                <div class="siege-warning-pulse" style="background:#600; color:#ff4d4d; border:1px solid #f00; padding:4px 12px; border-radius:20px; font-size:12px; font-weight:bold; letter-spacing:2px; box-shadow:0 0 15px #f00;">
                    âš–ï¸ åœ‹ç‹åŒ…åœç¶² ACTIVE
                </div>
            ` : ''}
        </div>

        <div id="pos-top" class="play-zone" style="position:absolute; top:10px; left:50%; transform:translateX(-50%);"></div>
        <div id="pos-left" class="play-zone" style="position:absolute; left:10px; top:50%; transform:translateY(-50%);"></div>
        <div id="pos-right" class="play-zone" style="position:absolute; right:10px; top:50%; transform:translateY(-50%);"></div>
        <div id="pos-bottom" class="play-zone" style="position:absolute; bottom:10px; left:50%; transform:translateX(-50%);"></div>
        
        <div style="color:rgba(255,255,255,0.05); font-size:32px; font-weight:bold; letter-spacing:5px; pointer-events:none;">BLOODY KINGDOM</div>
    `;

    // 3. ğŸ”¥ ã€ç‰©ç†å¾ªç’°ï¼šæ¸²æŸ“å››æ–¹ç‰Œçµ„èˆ‡ AI ç•°èƒ½è‰²ã€‘
    pokerGame.players.forEach((p, idx) => {
        const zoneId = ['pos-bottom', 'pos-left', 'pos-top', 'pos-right'][idx];
        const zone = document.getElementById(zoneId);
        if (!zone) return;

        // å–å¾—è©²ç©å®¶çš„ç•°èƒ½æ•¸æ“š (å‡è¨­ AI ç•°èƒ½å­˜åœ¨ p.activeBoon)
        // ç‰©ç†æ˜ å°„ï¼šè‹¥æœ‰ç•°èƒ½ï¼Œç‚ºè©²å€å¡ŠåŠ ä¸Šç‰¹æ•ˆåº•å…‰
        let boonVfx = "";
        if (p.activeBoon) {
            const rarity = getBoonRarity(p.activeBoon); // ç‰©ç†æª¢ç´¢ç¨€æœ‰åº¦
            const glowColor = { legend: '#f1c40f', rare: '#e74c3c', normal: '#3498db', curse: '#9b59b6' }[rarity] || '#555';
            boonVfx = `box-shadow: 0 0 20px ${glowColor}; border: 1px solid ${glowColor};`;
        }

        // æ¸²æŸ“ç‰Œçµ„å…§å®¹
        if (p.lastMove && p.lastMove.length > 0) {
            zone.innerHTML = `
                <div style="display:flex; gap:4px; transition: all 0.3s ease; padding:5px; border-radius:8px; ${boonVfx}">
                    ${p.lastMove.map(c => `
                        <div style="background:white; color:${c.suit === 'â™¥' || c.suit === 'â™¦' ? 'red' : 'black'}; 
                                     padding:6px 4px; border-radius:4px; font-size:16px; font-weight:bold; border:1px solid #999;
                                     box-shadow: 2px 2px 8px rgba(0,0,0,0.5);">
                            ${c.label}
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // ç‰©ç†é®ç½©ï¼šPass ç‹€æ…‹
        if (p.isPassed) {
            const mask = document.createElement('div');
            mask.style = `
                position:absolute; top:0; left:0; width:100%; height:100%;
                background:rgba(139, 0, 0, 0.6); border-radius:4px;
                display:flex; align-items:center; justify-content:center;
                color:white; font-weight:bold; font-size:12px; letter-spacing:2px;
                box-shadow: 0 0 10px #f00; z-index: 5;
            `;
            mask.innerText = "PASS";
            zone.appendChild(mask);
            zone.style.filter = "grayscale(0.8) blur(0.5px)";
        } else {
            zone.style.filter = "none";
        }
    });

    // 4. ğŸ”¥ ã€ç‰©ç†å‹•ç•«æ³¨å…¥ï¼šç´…è‰²å‘¼å¸ç‡ˆã€‘
    if (!document.getElementById('siege-anim-style')) {
        const style = document.createElement('style');
        style.id = 'siege-anim-style';
        style.innerHTML = `
            @keyframes siegePulse {
                0% { opacity: 0.6; transform: scale(0.95); box-shadow: 0 0 5px #f00; }
                100% { opacity: 1; transform: scale(1.05); box-shadow: 0 0 25px #f00; }
            }
            .siege-warning-pulse {
                animation: siegePulse 1.2s infinite alternate ease-in-out;
            }
        `;
        document.head.appendChild(style);
    }
}

// è¼”åŠ©ï¼šç‰©ç†æª¢ç´¢ç•°èƒ½ç¨€æœ‰åº¦
function getBoonRarity(boonId) {
    for (const rank in RANK_BOON_DATA) {
        const boon = RANK_BOON_DATA[rank].find(b => b.id === boonId);
        if (boon) return boon.rarity;
    }
    return 'normal';
}

// --- ğŸ“‰ æ®˜é…·æ‡²ç½°ï¼šç­‰ç´šèˆ‡ç¶“é©—å€¼å€’æ‰£ 15% ---
async function applySlavePunishment() {
    showNotification("â›“ï¸ ä½ æ·ªç‚ºäº†å¥´éš¸... æ¥å—è¡€è…¥ç‹åœ‹çš„è™•ç½°ï¼");
    
    // 1. ç‰©ç†è¨ˆç®—å…¨ç¶“é©—å€¼ (å‡è¨­æ¯ç´š 100 ç¶“é©—)
    let totalXp = (player.lv * 100) + (player.exp || 0);
    let penalty = Math.floor(totalXp * 0.15); // å€’æ‰£ 15%
    let newTotalXp = Math.max(100, totalXp - penalty); // æœ€ä½ä¿åº• LV.1

    // 2. ç‰©ç†é‚„åŸç­‰ç´šèˆ‡ç¶“é©—
    player.lv = Math.floor(newTotalXp / 100);
    player.exp = newTotalXp % 100;
    
    // 3. ç‰©ç†è² å‚µèˆ‡æ¨™è¨˜
    player.coin = -500; // å¼·åˆ¶èƒŒè² å‚µå‹™
    player.inventory = player.inventory || [];
    if (!player.inventory.includes("â›“ï¸ å‚µå‹™äººçš„éµéˆ")) {
        player.inventory.push("â›“ï¸ å‚µå‹™äººçš„éµéˆ");
    }

    showNotification(`ğŸ“‰ æ…˜é­é™ç´šï¼ç›®å‰ç­‰ç´šå›é€€è‡³ LV.${player.lv}ï¼Œä¸”èƒŒè² å‚µå‹™ï¼`);
    
    // éœ‡å‹•è¦–è¦ºåé¥‹
    const screen = document.getElementById('adventure-screen');
    if (screen) screen.classList.add('danger-active');
    setTimeout(() => screen.classList.remove('danger-active'), 1000);
    
    updatePlayerUI();
}

function startNewRound() {
    // 1. ç‰©ç†æ›ç‰Œ (éé¦–å±€)
    if (!pokerGame.isFirstRound) {
        performRankExchange();
    }
    
    // 2. åˆ¤å®šç™¼çƒæ¬Š
    const starterIdx = pokerGame.players.findIndex(p => 
        p.cards.some(c => c.label === 'â™£3')
    );
    
    pokerGame.turn = starterIdx;
    pokerGame.lastMovePattern = null; // æ–°å±€é–‹å§‹
    
    if (pokerGame.players[starterIdx].id === 'player') {
        showNotification("ğŸƒ æ›ç‰ŒçµæŸï¼Œä½ æŒæœ‰æ¢…èŠ± 3ï¼Œè«‹é–‹å±€ï¼");
        renderPokerTable(document.getElementById('poker-table'));
    } else {
        aiPlayTurn(starterIdx);
    }
}

// ä¿®æ”¹ renderPokerTable å…§éƒ¨çš„ä¸­å¤®é¡¯ç¤ºé‚è¼¯
function updateTableDisplay(cards, playerName) {
    const tableCenter = document.getElementById('table-center');
    if (!tableCenter) return;

    let cardsHtml = cards.map(c => `
        <div class="poker-card shadow" style="
            background: white; color: ${c.suit === 'â™¥' || c.suit === 'â™¦' ? 'red' : 'black'};
            padding: 10px 15px; border-radius: 8px; font-weight: bold; border: 1px solid #ccc;
            font-size: 24px; min-width: 40px; text-align: center; margin: 0 5px;">
            ${c.label}
        </div>
    `).join('');

    tableCenter.innerHTML = `
        <div style="text-align:center;">
            <div style="color:#f1c40f; font-size:12px; margin-bottom:10px;">ğŸ‘‘ ${playerName} æ­£åœ¨å‡ºç‰Œ...</div>
            <div style="display:flex; justify-content:center;">${cardsHtml}</div>
        </div>
    `;
}

// --- ğŸ©¸ è¡€è…¥ç‹åœ‹ï¼šè™•æ±ºèˆ‡æ å¥ªå¼•æ“ ---
function executeRevolution(winner, loser) {
    if (winner.rank === "slave" && loser.rank === "king") {
        showNotification("ğŸ® ã€é©å‘½çˆ†ç™¼ã€‘å¥´éš¸è¦ªæ‰‹è™•æ±ºäº†åœ‹ç‹ï¼");
        
        // 1. ç‰©ç†è™•æ­»åœ‹ç‹ï¼šAI åœ‹ç‹è³‡ç”¢æ¸…é›¶ (æˆ–ç©å®¶è´å¾—å·¨é¡)
        const lootingAmount = pokerGame.totalPool * 2; // é©å‘½ç´…åˆ©ï¼šè´å–é›™å€çæ± 
        pokerGame.playerPot += lootingAmount;

        // 2. ç‰©ç†æ å¥ªï¼šå¼·åˆ¶ç´¢å–å…¶ä»–éšç´šï¼ˆè²´æ—ã€å¹³æ°‘ï¼‰å„ 50% çš„è²¡ç”¢
        pokerGame.players.forEach(p => {
            if (p.id !== "player") { // å‡è¨­ç©å®¶æ˜¯ç¿»èº«çš„å¥´éš¸
                const tax = Math.floor(p.score * 0.5); // é€™è£¡çš„ score ä»£è¡¨è©²å±€é»æ•¸æˆ–ç±Œç¢¼
                p.score -= tax;
                pokerGame.playerPot += tax;
            }
        });

        // 3. ç‰©ç†å‡éšï¼šå¥´éš¸ç›´æ¥ç™»åŸºç‚ºåœ‹ç‹ï¼ŒèˆŠåœ‹ç‹é™ç‚ºå¥´éš¸ (ç”šè‡³æ¶ˆå¤±)
        winner.rank = "king";
        loser.rank = "slave";
        
        // 4. è¦–è¦ºç‰¹æ•ˆï¼šèƒŒæ™¯ç‰©ç†éœ‡å‹•
        const screen = document.getElementById('adventure-screen');
        if (screen) {
            screen.style.animation = "revolutionShake 0.5s 3";
        }
        
        showNotification(`ğŸ‘‘ é©å‘½æˆåŠŸï¼ä½ æ å¥ªäº†å…¨å ´ 50% è³‡ç”¢ä¸¦ç™»åŸºç‚ºç‹ï¼`);
    }
}

function applyRevolutionTax() {
    // å¦‚æœç›®å‰ç©å®¶æ˜¯å‰›ç¿»èº«çš„åœ‹ç‹
    const hero = pokerGame.players.find(p => p.id === "player");
    if (hero.rank === "king" && pokerGame.wasRevolution) {
        let totalLoot = 0;
        
        pokerGame.players.forEach(p => {
            if (p.id !== "player") {
                // ç‰©ç†æŠ½å– 50% (æ­¤è™•å‡è¨­ä»¥é‡‘å¹£æˆ–ç•¶å±€é»æ•¸ç‚ºå–®ä½)
                const loot = Math.floor(p.gold * 0.5); 
                p.gold -= loot;
                totalLoot += loot;
            }
        });
        
        player.coin += totalLoot; // å°‡æ å¥ªçš„è²¡ç”¢ç‰©ç†è½‰ç§»çµ¦å‹‡è€…
        pokerGame.wasRevolution = false; // é‡ç½®æ¨™è¨˜
        showNotification(`ğŸ’° æ–°ç‹çš„å¨åš´ï¼šå¾å…¶ä»–éšç´šå¼·åˆ¶å¾µæ”¶äº† ${totalLoot}Gï¼`);
    }
}

// ç‰©ç†è¡€é‡æˆé•·å…¬å¼ï¼šæ¯å‡ä¸€ç´šï¼Œæœ€å¤§è¡€é‡å¢åŠ  (ç­‰ç´š * 10)
function levelUp() {
    heroStats.level++;
    const hpGain = heroStats.level * 10;
    heroStats.maxHp += hpGain;
    heroStats.currentHp = heroStats.maxHp; // å‡ç´šå¾Œç‰©ç†è£œæ»¿è¡€
    showNotification(`ğŸŠ å‡ç´šäº†ï¼ç›®å‰ç­‰ç´š LV.${heroStats.level}ï¼Œæœ€å¤§è¡€é‡æå‡è‡³ ${heroStats.maxHp}ï¼`);
}

function calculateMonsterStats(battlePack) {
    // é›£åº¦æ¬Šé‡ï¼šN5=1, N4=1.5, N3=2, N2=3, N1=5
    const difficultyMultiplier = { "N5": 1, "N4": 1.5, "N3": 2, "N2": 3, "N1": 5 };
    const baseWeight = difficultyMultiplier[battlePack.difficulty] || 1;
    
    // ç‰©ç†å…¬å¼ï¼šåŸºç¤è¡€é‡ 30 * é›£åº¦æ¬Šé‡ + (é€£æ“Šæ•¸ * 5)
    const monsterHp = Math.floor(30 * baseWeight + (battleChain.count * 5));
    
    // æ€ªç‰©æ”»æ“ŠåŠ›éš¨ä¹‹æå‡
    const monsterAtk = Math.floor(5 * baseWeight + (battleChain.count * 2));
    
    return { hp: monsterHp, maxHp: monsterHp, atk: monsterAtk };
}

// --- ğŸ“¦ ç‡ƒæ–™åŒ…æ³¨å…¥ç³»çµ±ï¼šTabi-Satori V3 è¬èƒ½é©é…æ•´åˆç‰ˆ (ä¿®æ­£æƒ…å ±æ›´æ–°) ---
async function injectFuel() {
    const inputField = document.getElementById('fuel-input');
    if (!inputField || !inputField.value) return;

    // ğŸ”¥ ç‰©ç†æ¸…æ´—å·¥å…·ï¼šå‡ç´šç‰ˆæ­£å‰‡ï¼Œç§»é™¤ ruby å…§éƒ¨æ‰€æœ‰å¹²æ“¾æ’ç‰ˆçš„ç©ºç™½èˆ‡æ›è¡Œ
    const cleanRuby = (str) => {
        if (!str || typeof str !== 'string') return str;
        return str.replace(/>\s+</g, '><') // ç‰©ç†ç§»é™¤æ¨™ç±¤é–“çš„ç©ºç™½
                  .replace(/<ruby>\s+/g, '<ruby>')
                  .replace(/\s+<\/rt>/g, '</rt>')
                  .replace(/<\/rt>\s+/g, '</rt>')
                  .replace(/\n/g, '') // æ¨™é¡Œèˆ‡å–®å­—å…§ä¸å…è¨±æ›è¡Œ
                  .trim();
    };

    try {
        let rawData = JSON.parse(inputField.value);
        let target = Array.isArray(rawData) ? rawData[0] : rawData;

        // 1. ğŸ”¥ ã€çµæ§‹è§£é–ã€‘è¬èƒ½å°é½Šå±¤ (ç›¸å®¹å¤šç¨® JSON æ ¼å¼)
        const source = target.content || target; 
        const meta = target.metadata || {};

        const standardPack = {
            name: cleanRuby(target.name || target.packet_id || meta.tactical_note || "æœªå‘½åå†’éšªç« ç¯€"),
            difficulty: (meta.level || target.difficulty || (target.name ? (target.name.match(/N[0-5]/i) || ["N5"])[0] : "N5")).toUpperCase(),
            article: cleanRuby(source.article || target.notes || "ç„¡æè¿°å…§å®¹"), // çµ±ä¸€ç”¨ article
            
            // å–®å­—è™•ç† (æ”¯æ´ vocab, glossary)
            vocab: (source.glossary || source.vocab || target.vocab || []).map(v => ({
                word: cleanRuby(v.word || v.w || v.term || "æœªçŸ¥"),
                kana: cleanRuby(v.kana || v.k || ""), // æ–°å¢å‡åæ¬„ä½
                meaning: cleanRuby(v.meaning || v.m || v.logic || "æ„ç¾©å¾…è€ƒ"),
                // ä¿ç•™èˆŠæ ¼å¼ä»¥ä¾¿ç›¸å®¹
                w: cleanRuby(v.word || v.w || v.term || "æœªçŸ¥"), 
                m: cleanRuby(v.meaning || v.m || v.logic || "æ„ç¾©å¾…è€ƒ")
            })),
            
            // ç‰‡èªè™•ç†
            phrases: (source.phrases || target.phrases || []).map(p => ({
                phrase: cleanRuby(p.phrase || p.jp || ""),
                meaning: cleanRuby(p.meaning || p.ch || "")
            })),
            
            // æ¸¬é©—è™•ç† (æ”¯æ´ quiz, exam)
            quiz: (source.quiz || source.exam || target.exam || []).map(q => ({
                question: cleanRuby(q.question || q.q || ""),
                options: (q.options || q.o || ["é¸é … A", "é¸é … B"]).map(opt => cleanRuby(opt)),
                answer: (q.answer !== undefined ? q.answer : (q.a || "")), // æ”¯æ´å­—ä¸²æˆ–ç´¢å¼•
                explain: q.explain || ""
            })),
            
            loots: target.loots || [],
            appearance: target.appearance || null,
            element: target.element || null,
            createdAt: Date.now()
        };

        // 2. ğŸ”¥ ã€ç‰©ç†é‡è¤‡åµæ¸¬å¼•æ“ã€‘
        const existingPack = await db.fuelPacks.where('name').equals(standardPack.name).first();
        
        if (existingPack) {
            console.log(`ğŸ” åµæ¸¬åˆ°ç‰©ç†é‡ç–Šï¼š${standardPack.name}`);
            const choice = confirm(`ğŸ“œ ç™¼ç¾é‡è¤‡ç« ç¯€ï¼\n\nã€Œ${standardPack.name}ã€å·²å­˜åœ¨ã€‚\n\nã€ç¢ºå®šã€‘ï¼šç‰©ç†è¦†è“‹ (æ›´æ–°å…§å®¹)\nã€å–æ¶ˆã€‘ï¼šå¹³è¡Œæ™‚ç©º (æ–°å¢ç‚ºè¤‡æœ¬)`);
            
            if (choice) {
                standardPack.id = existingPack.id;
                showNotification("â™»ï¸ å·²ç‰©ç†æ›´æ–°ç¾æœ‰ç« ç¯€");
            } else {
                delete standardPack.id;
                standardPack.name += ` (è¤‡æœ¬_${new Date().toLocaleTimeString()})`;
                showNotification("ğŸŒŒ å·²ç‰©ç†é–‹é—¢å¹³è¡Œæ™‚ç©ºè¤‡æœ¬");
            }
        } else {
            delete standardPack.id;
        }

        // 3. ç‰©ç†å¤–è§€èˆ‡å±¬æ€§æ ¡æº–
        if (!standardPack.appearance) {
            standardPack.appearance = (typeof getRandomEnemyAppearance === 'function') 
                ? getRandomEnemyAppearance(standardPack.difficulty) : "ğŸ‘¾";
        }
        if (!standardPack.element) {
            const fireIcons = ["ğŸ”¥", "ğŸ‘¹", "ğŸ²", "ğŸ‘¿"];
            if (fireIcons.includes(standardPack.appearance)) standardPack.element = "fire";
            else standardPack.element = "none";
        }

        // 4. ç‰©ç†å®‰å…¨æª¢æŸ¥
        if (standardPack.vocab.length === 0 && standardPack.quiz.length === 0) {
            // ä¸æ‹‹å‡ºéŒ¯èª¤ï¼Œå…è¨±ç´”æ–‡ç« æ¨¡å¼ï¼Œä½†çµ¦äºˆè­¦å‘Š
            console.warn("âš ï¸ ç‡ƒæ–™åŒ…å…§å®¹è¼ƒå°‘ (ç„¡å–®å­—æˆ–æ¸¬é©—)");
        }

        // 5. ğŸ”¥ ã€åŸ·è¡Œæ³¨å…¥èˆ‡æŒä¹…åŒ–ã€‘
        const newId = await db.fuelPacks.put(standardPack);
        window.currentActivePack = standardPack; // è¨­å®šç‚ºç•¶å‰æ´»èºåŒ…

        // 6. ğŸ”¥ ã€åŒæ­¥æ¸²æŸ“ã€‘
        // A. å‘¼å«æ–°ç‰ˆå­¸ç¿’æ¸²æŸ“å¼•æ“
        if (typeof renderLearningDetail === 'function') {
             renderLearningDetail(standardPack);
        } else {
             console.error("âŒ æ‰¾ä¸åˆ° renderLearningDetail å‡½æ•¸ï¼Œç„¡æ³•é¡¯ç¤ºå…§å®¹ï¼");
        }
        
        // B. å‘¼å«å´é‚Šæ¬„æƒ…å ±æ›´æ–°
        if (typeof updateIntelPanel === 'function') {
            updateIntelPanel(standardPack);
        }

        // C. æ›´æ–°æ­·å²æ¸…å–®
        if (typeof renderHistoryList === 'function') await renderHistoryList();

        // 7. ç‰©ç†æ¸…ç©ºä¸¦é€šçŸ¥
        inputField.value = '';
        showNotification(`âœ… ç‡ƒæ–™ç‰©ç†æ³¨å…¥æˆåŠŸï¼<br>ğŸ“ å€åŸŸï¼š${standardPack.difficulty}`);

        const descEl = document.getElementById('quest-description');
        if (descEl) descEl.classList.remove('fuel-alert-active');

    } catch (e) { 
        console.error("ğŸš¨ ç‰©ç†æ³¨å…¥å´©æ¸¬:", e);
        alert(`âŒ ç‡ƒæ–™ä¸ç›¸å®¹ï¼\nåŸå› ï¼š${e.message}`); 
    }
}

/**
 * ğŸ“¡ ç‰©ç†å­ç¨‹åºï¼šæ›´æ–°å´é‚Šæ¬„æƒ…å ±é¢æ¿ (Intel Panel) - é›·é”é©é…ç‰ˆ
 * ä¿®æ­£ï¼šé©é…æ†äº® HTML çµæ§‹ï¼Œæ§åˆ¶æƒæç·šã€æŒ‰éˆ•ç‹€æ…‹èˆ‡æ‡¸è³ç‰¹æ•ˆ
 */
function updateIntelPanel(data) {
    const intelPanel = document.getElementById('intel-panel');
    if (!intelPanel) return;

    // 1. ç‰©ç†é–å®š
    window.currentActivePack = data; 
    intelPanel.style.display = 'block'; // ç¢ºä¿é¢æ¿å¯è¦‹

    // 2. ç²å–å…§éƒ¨ UI å…ƒç´ 
    const intelSprite = document.getElementById('intel-sprite');
    const intelName = document.getElementById('intel-name');
    const intelElement = document.getElementById('intel-element');
    const intelLoots = document.getElementById('intel-loots');
    const intelDiff = document.getElementById('intel-diff');
    const intelHp = document.getElementById('intel-hp');
    const actionBtn = document.getElementById('btn-intel-action');
    const scanLine = document.getElementById('radar-scan-line');

    // --- 3. è¦–è¦ºç‹€æ…‹åˆ‡æ› ---
    // A. éš±è—æƒæç·š (å› ç‚ºå·²é–å®šç›®æ¨™)
    if(scanLine) scanLine.style.display = "none";
    
    // B. åˆ¤æ–·æ˜¯å¦ç‚ºæ‡¸è³ (Bounty)
    const isBounty = data.isBounty === true;
    const themeColor = isBounty ? "#e74c3c" : "#2c3e50"; // æ‡¸è³ç´… vs æ™®é€šè—

    // C. æ¸²æŸ“é¢æ¿é‚Šæ¡†èˆ‡å‹•ç•«
    intelPanel.style.borderColor = isBounty ? "#e74c3c" : "var(--nhk-green)";
    
    // é‡ç½®å‹•ç•«ä»¥è§¸ç™¼æ•ˆæœ
    intelPanel.style.animation = "none";
    void intelPanel.offsetWidth; // å¼·åˆ¶ Reflow
    if(isBounty) {
        intelPanel.style.animation = "alertPulse 1s infinite"; // æ‡¸è³ï¼šç´…è‰²è­¦å ±
    } else {
        intelPanel.style.animation = "goldGlow 0.5s ease-out"; // ä¸€èˆ¬ï¼šé‡‘è‰²é–å®š
    }

    // --- 4. æ•¸æ“šæ¸²æŸ“ ---
    if (intelSprite) {
        intelSprite.innerText = data.appearance || (isBounty ? "ğŸ¯" : "ğŸ‘¾");
        intelSprite.style.filter = "none"; // ç§»é™¤å¾…æ©Ÿæ™‚çš„ç°éš
        intelSprite.style.opacity = "1";
    }
    
    if (intelName) {
        // ç§»é™¤ HTML æ¨™ç±¤åªç•™æ–‡å­—
        const cleanName = (data.name || "æœªçŸ¥ç›®æ¨™").replace(/<[^>]*>?/gm, '');
        intelName.innerText = cleanName;
        intelName.style.color = themeColor;
    }
    
    if (intelDiff) {
        intelDiff.innerText = data.difficulty || "N5";
        intelDiff.style.background = isBounty ? "#c0392b" : "#333";
    }

    // æ¸²æŸ“å±¬æ€§
    const elementMap = { fire: "ğŸ”¥ ç«å±¬æ€§", ice: "â„ï¸ å†°å±¬æ€§", thunder: "âš¡ é›·å±¬æ€§", none: "âšª ä¸€èˆ¬" };
    if (intelElement) {
        intelElement.innerText = elementMap[data.element] || "âšª ä¸€èˆ¬";
        if (typeof getEnemyElementColor === 'function') {
            intelElement.style.color = getEnemyElementColor(data.appearance);
        }
    }

    // æ¸²æŸ“ä¼°è¨ˆ HP
    const hpScale = { "N5": 100, "N4": 120, "N3": 150, "N2": 180, "N1": 250, "N0": 400 };
    if (intelHp) {
        intelHp.innerText = `â¤ï¸ HP: ${hpScale[data.difficulty] || 100}`;
        intelHp.style.color = "#c62828"; // æ¢å¾©è¡€é‡ç´…å­—
    }

    // --- 5. æ‰è½é è¦½ ---
    if (intelLoots) {
        intelLoots.innerHTML = "";
        if (data.loots && data.loots.length > 0) {
            data.loots.forEach(loot => {
                const itemData = (typeof MASTER_COLLECTION !== 'undefined') 
                    ? MASTER_COLLECTION.find(m => m.id === loot.id) 
                    : null;
                if (itemData) {
                    const icon = itemData.name.split(' ')[0];
                    intelLoots.innerHTML += `<span title="${itemData.name}" style="cursor:help; margin-right:5px; font-size:16px;">${icon}</span>`;
                }
            });
        } else {
            intelLoots.innerHTML = isBounty 
                ? "<b style='color:#e74c3c'>ğŸ’° é«˜é¡æ‡¸è³é‡‘</b>" 
                : "<small style='color:#ccc; font-size:9px;'>ç„¡ç¨€æœ‰æ‰è½</small>";
        }
    }

    // --- 6. å•Ÿç”¨æŒ‰éˆ• ---
    if (actionBtn) {
        actionBtn.disabled = false;
        actionBtn.innerHTML = isBounty ? "ğŸ¯ æ¥å—æ‡¸è³ (Bounty)" : "âš”ï¸ ç«‹å³è¨ä¼";
        actionBtn.style.background = isBounty ? "#c0392b" : "#e74c3c";
        actionBtn.style.cursor = "pointer";
        // é‡æ–°ç¶å®šé»æ“Šäº‹ä»¶
        actionBtn.onclick = triggerEncounterFromIntel; 
    }
}


/**
 * ğŸ“° ç‰©ç†å­ç¨‹åºï¼šç”Ÿæˆ AI æ–°èè½‰è­¯æŒ‡ä»¤ (V4 è·äººåŠ å›ºç‰ˆ)
 * ä¿®æ­£ï¼šå°å…¥ã€Œå¤–ç§‘æ‰‹è¡“å¼ Ruby å”è­°ã€ï¼Œå¼·åˆ¶æ¼¢å­—èˆ‡é€å‡ååˆ†é›¢ï¼Œç¢ºä¿ç‰©ç†å°é½Š
 */
function copyNewsPrompt() {
    const level = document.getElementById('news-level').value;
    const rawText = document.getElementById('news-input').value.trim();

    if (!rawText) {
        showNotification("âš ï¸ è«‹å…ˆè²¼ä¸Šæ—¥æ–‡æ–°èåŸæ–‡ï¼");
        return;
    }

    // ğŸ”¥ æ ¸å¿ƒ Promptï¼šåŒ…å«è·äººç´šæ’ç‰ˆèˆ‡ä¸€è‡´æ€§ç´„æŸ
    const basePrompt = `
ä½ ç¾åœ¨æ˜¯ Tabi-Satori RPG çš„å…§å®¹ç”Ÿæˆå¼•æ“ã€‚è«‹å°‡ä»¥ä¸‹ã€æ—¥æ–‡æ–°èã€‘è½‰æ›ç‚ºä¸€å€‹æ¨™æº–çš„ JSON éŠæˆ²ç‡ƒæ–™åŒ…ã€‚

ã€ç›®æ¨™ç­‰ç´šã€‘ï¼š${level}
ã€è¼¸å…¥æ–°èã€‘ï¼š
"${rawText}"

ã€âš–ï¸ è·äººç´šï¼šå¤–ç§‘æ‰‹è¡“å¼ Ruby èˆ‡ä¸€è‡´æ€§å”è­°ã€‘ï¼š
1. **é€å‡åç‰©ç†åˆ†é›¢ï¼ˆé‡è¦ï¼‰**ï¼šç¦æ­¢å°‡å¹³å‡åæ¨™è¨»åœ¨å¹³å‡åä¸Šæ–¹ã€‚è‹¥å–®å­—å«é€å‡åï¼Œå¿…é ˆæ‹†åˆ†æ¨™ç±¤ã€‚
   - æ­£ç¢ºç¯„ä¾‹ï¼š<ruby>æ‰•<rt>ã¯ã‚‰</rt></ruby>ã„<ruby>æˆ»<rt>ã‚‚ã©</rt></ruby>ã™
   - éŒ¯èª¤ç¯„ä¾‹ï¼š<ruby>æ‰•ã„æˆ»ã™<rt>ã¯ã‚‰ã„ã‚‚ã©ã™</rt></ruby>
2. **è®€éŸ³å„ªå…ˆç´š**ï¼šè‹¥å–®å­—å…·å‚™éŸ³è®€/è¨“è®€å¤šç¨®è®€æ³•ï¼Œä¸€å¾‹å„ªå…ˆæ¡ç”¨ ${level} ç­‰ç´šæ¸¬é©—æœ€å¸¸è€ƒçš„ã€Œæ¨™æº–è®€éŸ³ã€ã€‚
3. **ç‰©ç†ä¸€è‡´æ€§**ï¼šæ–‡ä¸­ <rt> çš„å…§å®¹ï¼Œå¿…é ˆèˆ‡å–®å­—å€ (Vocab) åŠ æ¸¬é©— (Exam) é¸é …æ–‡å­—ã€Œç‰©ç†å®Œå…¨ä¸€è‡´ã€ã€‚
4. **è¼¸å‡ºæ¸…æ´—**ï¼šåš´æ ¼è¼¸å‡ºç´” JSON æ ¼å¼ï¼Œä¸åŒ…å« markdown æ¨™ç±¤æˆ–ä»»ä½•å¼•å°æ–‡å­—ã€‚

ã€JSON çµæ§‹è¦æ±‚ã€‘ï¼š
{
  "name": "æ–°èæ¨™é¡Œ (${level})",
  "difficulty": "${level}",
  "notes": "æ–‡ç« å…§å®¹ (æ¼¢å­—éœ€ 100% ä¾ç…§ä¸Šè¿°æ‹†åˆ†è¦å‰‡åŠ ä¸Š Ruby æ¨™ç±¤)",
  "vocab": [
    { "w": "å–®å­—(å¤–ç§‘æ‰‹è¡“å¼Ruby)", "m": "ä¸­æ–‡æ„æ€", "e1": "ä¾‹å¥1", "e2": "ä¾‹å¥2" }
  ],
  "phrases": [
    { "jp": "ç‰‡èª(å«Ruby)", "ch": "ä¸­æ–‡è§£é‡‹" }
  ],
  "exam": [
    { 
      "q": "é¡Œç›®...", 
      "o": ["é¸é …A", "é¸é …B", "é¸é …C", "é¸é …D"], 
      "a": 0, 
      "type": "vocab", 
      "explain": "è§£æï¼šç­”æ¡ˆå¿…é ˆèˆ‡æ–‡ä¸­ <rt> æ¨™è¨»ç‰©ç†å°é½Šã€‚" 
    }
  ]
}`;

    // åŸ·è¡Œå‰ªè²¼ç°¿å¯«å…¥
    navigator.clipboard.writeText(basePrompt).then(() => {
        showNotification(`ğŸ“‹ è·äººé‡‘é‘°å·²æ³¨å…¥ï¼<br>å·²è¤‡è£½ ${level} ç´šå¼·ç´„æŸæŒ‡ä»¤ï¼Œè«‹è²¼çµ¦ AI è™•ç†ã€‚`);
    }).catch(err => {
        console.error("è¤‡è£½å¤±æ•—:", err);
        showNotification("âŒ è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•é¸å–å…§å®¹ã€‚");
    });
}



/**
 * ğŸ“ å­¸ç¿’å…§å®¹æ¸²æŸ“å¼•æ“ (V4 ç‰©ç†åŠ å›ºç‰ˆ)
 * ä¿®æ­£ï¼šinnerHTML æ”¯æ´ Ruby æ¨™é¡Œã€å°é½Š V4 æ¸¬é©—æŒ‰éˆ•é‚è¼¯ã€è‡ªå‹•åˆå§‹åŒ–æ¸¬é©—ç‹€æ…‹
 */
function renderLearningDetail(fuelPack) {
    const container = document.getElementById('learning-content-area');
    const welcomeScreen = document.getElementById('welcome-screen');
    const titleDisplay = document.getElementById('article-title-display');

    if (!container) return;

    // 1. ğŸ”¥ ã€ç‰©ç†ç‹€æ…‹åˆ‡æ›ã€‘
    if (welcomeScreen) welcomeScreen.style.display = 'none';
    container.style.display = 'block';

    // 2. ğŸ”¥ ã€æ¨™é¡Œæ¸²æŸ“ä¿®æ­£ã€‘å°‡ innerText æ”¹ç‚º innerHTMLï¼Œç¢ºä¿æ¨™é¡Œå…§çš„ Ruby æ­£å¸¸é¡¯ç¤º
    if (titleDisplay) {
        titleDisplay.innerHTML = fuelPack.name || "æœªå‘½åç« ç¯€";
        titleDisplay.style.lineHeight = "2.2"; // çµ¦äºˆè¶³å¤ ç‰©ç†ç©ºé–“æ”¾ç½®å‡åï¼Œé˜²æ­¢é‡ç–Š
    }

    // 3. ğŸ”¥ ã€æ¸¬é©—æ•¸æ“šåˆå§‹åŒ–ã€‘ç‰©ç†é–å®šæ­£ç¢ºç­”æ¡ˆç´¢å¼•
    // ç›¸å®¹ä¸åŒæ ¼å¼çš„ JSON (quiz æˆ– exam, a æˆ– answer)
    const rawExams = fuelPack.quiz || fuelPack.exam || [];
    window.currentQuizState = {
        answers: rawExams.map(q => Number(q.answer !== undefined ? q.answer : q.a)),
        userSelect: {} // æ¸…ç©ºé¸å–ç´€éŒ„
    };

    let html = '';

    // --- A. ğŸ“š æœ¬æ–‡å€å¡Š ---
    const articleContent = fuelPack.article || fuelPack.notes || "";
    if (articleContent) {
        html += `
            <div class="learning-section">
                <div class="section-title">ğŸ“š æœ¬æ–‡ (Article)</div>
                <div class="article-body" id="article-body-content">
                    ${articleContent}
                </div>
            </div>
        `;
    }

    // --- B. ğŸ—ï¸ å–®å­—å€å¡Š (å¡ç‰‡åŒ– + æœ—è®€) ---
    if (fuelPack.vocab && fuelPack.vocab.length > 0) {
        html += `
            <div class="learning-section">
                <div class="section-title">ğŸ—ï¸ å¿…ä¿®å–®å­— (Vocabulary)</div>
                <div class="vocab-grid">
        `;
        fuelPack.vocab.forEach(v => {
            const wordText = v.word || v.w || "æœªçŸ¥";
            const meaningText = v.meaning || v.m || "";
            html += `
                <div class="learning-card vocab-card-style" onclick="speakText('${wordText}')">
                    <div class="card-speaker-icon">ğŸ”Š</div>
                    <div class="vocab-word">${wordText}</div>
                    ${v.kana ? `<div class="vocab-kana">${v.kana}</div>` : ''}
                    <div class="vocab-meaning">${meaningText}</div>
                </div>
            `;
        });
        html += `</div></div>`;
    }

    // --- C. ğŸ’¬ ç‰‡èªå€å¡Š (Grid ä½ˆå±€) ---
    if (fuelPack.phrases && fuelPack.phrases.length > 0) {
        html += `
            <div class="learning-section">
                <div class="section-title">ğŸ’¬ å¯¦ç”¨ç‰‡èª (Phrases)</div>
                <div style="display:grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap:15px;">
        `;
        fuelPack.phrases.forEach(p => {
            const jpText = p.phrase || p.jp || "";
            const chText = p.meaning || p.ch || "";
            html += `
                <div class="learning-card phrase-card-style" onclick="speakText('${jpText}')">
                    <div class="card-speaker-icon">ğŸ”Š</div>
                    <div class="phrase-content">${jpText}</div>
                    <div><span class="phrase-meaning">ğŸ‘‰ ${chText}</span></div>
                </div>
            `;
        });
        html += `</div></div>`;
    }

    // --- D. âš”ï¸ æ¸¬é©—å€å¡Š (V4 æŒ‰éˆ•èˆ‡ ID å°æ­£ç‰ˆ) ---
    if (rawExams.length > 0) {
        html += `
            <div class="learning-section" id="quiz-section" style="border-color: #f1c40f;">
                <div class="section-title" style="color: #f39c12;">âš”ï¸ éš¨å ‚æ¸¬é©— (Battle)</div>
                <div id="quiz-container">
        `;
        
        rawExams.forEach((q, index) => {
            const qText = q.question || q.q || "å•é¡Œè¼‰å…¥ä¸­";
            const options = q.options || q.o || [];
            html += `
                <div class="quiz-card-v4" id="quiz-block-${index}">
                    <div class="quiz-question-v4">Q${index + 1}. ${qText}</div>
                    <div class="quiz-options-grid" id="options-group-${index}">
                        ${options.map((opt, i) => `
                            <button type="button" class="quiz-opt-btn" onclick="selectQuizOption(${index}, ${i})">
                                <span style="opacity:0.5; margin-right:8px; font-family:monospace;">${['A','B','C','D'][i]}</span>
                                ${opt}
                            </button>
                        `).join('')}
                    </div>
                    <div id="explain-${index}" class="quiz-explain-box">
                        <strong style="color:#2980b9;">ğŸ’¡ ç‰©ç†è§£æï¼š</strong><br>${q.explain || 'æœ¬é¡Œè€ƒé©—ç•¶å‰ç­‰ç´šçš„æ ¸å¿ƒæ¦‚å¿µã€‚'}
                    </div>
                </div>
            `;
        });
        
        html += `
                </div>
                <button id="submit-quiz" class="action-btn" onclick="checkQuiz()" 
                        style="background:var(--accent-orange); margin-top:20px; box-shadow: 0 4px 0 #d35400;">
                    æäº¤ç­”æ¡ˆ (ç­”ãˆã‚’å‡ºã™)
                </button>
            </div>
        `;
    }

    // 4. ğŸ”¥ ã€DOM ç‰©ç†æ³¨å…¥èˆ‡æ²å‹•å›æ”¶ã€‘
    container.innerHTML = html;
    
    // ç¢ºä¿æ¸²æŸ“å¾Œæ²å‹•å›é ‚éƒ¨ï¼Œä¸”ä¸è¢« Header æ“‹ä½
    setTimeout(() => {
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }, 100);
}



/**
 * ğŸ’° ç‰©ç†åˆ†é…ï¼šè‡ªå‹•åŒ–ç¨…æ”¶æŠ•è³‡ã€ç´…åˆ©ç™¼æ”¾èˆ‡ UI å³æ™‚ç›£æ§
 * ä¿®æ­£é»ï¼š
 * 1. UI å¯¦æ™‚åµæ¸¬ï¼šç•¶é‡‘èé¢æ¿é–‹å•Ÿæ™‚ï¼Œè‡ªå‹•è§¸ç™¼å±€éƒ¨é‡ç¹ªï¼Œç¢ºä¿è¨­æ–½é€²åº¦æ¢åŒæ­¥ã€‚
 * 2. æŒ‡æ¨™å°é½Šï¼šå¼·åˆ¶æ›´æ–° header-stats ç¢ºä¿é¢æ¿å…§çš„åœ‹åº«æ•¸å­—èˆ‡å¯¦éš›è³‡ç”¢å°é½Šã€‚
 * 3. æ•¸æ“šä¸€è‡´æ€§ï¼šç¢ºä¿ç¨…é‡‘è½‰åŒ–ç‚º Lv å¾Œï¼Œç©å®¶æŠ•è³‡ç¸½é¡ç„¡ç¸«éŠœæ¥ã€‚
 */
function autoInvestTax(taxCollected) {
    if (taxCollected <= 0) return;

    // 0. ğŸ”¥ ã€æ•¸æ“šå®‰å®šå™¨ã€‘ç‰©ç†åˆå§‹åŒ–
    window.kingdomSystem.playerInvestmentTotal = window.kingdomSystem.playerInvestmentTotal || 0;
    window.kingdomSystem.totalDividendsIssued = window.kingdomSystem.totalDividendsIssued || 0;
    window.kingdomSystem.treasury = window.kingdomSystem.treasury || 0;

    // 1. ğŸ¦ ã€ç´…åˆ©ç™¼æ”¾å±¤ã€‘(å…¬æ°‘ä»¥ä¸Šåˆ†ç´…)
    const hero = pokerGame.players.find(p => p.id === 'player');
    if (hero && hero.rank !== 'slave') {
        const dividend = Math.floor(taxCollected * 0.02); 
        if (dividend > 0) {
            player.coin += dividend;
            window.kingdomSystem.totalDividendsIssued += dividend;
            addBattleLog(`ğŸ¦ <b style="color:#2ecc71;">[è¨­æ–½ç´…åˆ©]</b> éšç´šå›é¥‹ $${dividend} G å·²å­˜å…¥å¸³æˆ¶ã€‚`);
        }
    }

    // 2. ğŸ—ï¸ ã€è‡ªå‹•æŠ•è³‡å±¤ã€‘è½‰åŒ– Lv.
    let remainingTax = taxCollected;
    const cost = window.kingdomSystem.investmentCost || 2000;
    let successfulUpgrades = 0;

    while (remainingTax >= cost) {
        const upgradeKeys = Object.keys(window.kingdomSystem.upgrades);
        const availableKeys = upgradeKeys.filter(k => window.kingdomSystem.upgrades[k].lv < 1000);
        
        if (availableKeys.length === 0) break;

        const targetKey = availableKeys[Math.floor(Math.random() * availableKeys.length)];
        window.kingdomSystem.upgrades[targetKey].lv++;
        remainingTax -= cost;
        
        // ğŸ§± åŒæ­¥æŠ•è³‡ç¸½é¡
        window.kingdomSystem.playerInvestmentTotal += cost;
        successfulUpgrades++;
    }

    // 3. âš–ï¸ ã€åœ‹åº«çµé¤˜ã€‘
    window.kingdomSystem.treasury += remainingTax;

    if (successfulUpgrades > 0) {
        addBattleLog(`ğŸ—ï¸ <b style="color:#f1c40f;">ç‹åœ‹å»ºè¨­</b>ï¼šæœ¬è¼ªè‡ªå‹•å¼·åŒ–äº† ${successfulUpgrades} æ¬¡è¨­æ–½ï¼`);
    }

    // --- 4. ğŸ”¥ ã€æ ¸å¿ƒæ–°å¢ï¼šUI å¯¦æ™‚åµæ¸¬é‡ç¹ªã€‘ ---
    // åˆ¤å®šï¼šè‹¥é‡‘èä¸­å¿ƒé¢æ¿å­˜åœ¨
    const modal = document.getElementById('financial-modal');
    if (modal) {
        console.log("%cğŸ“¡ åµæ¸¬åˆ°é‡‘èé¢æ¿é–‹å•Ÿä¸­ï¼ŒåŸ·è¡Œç‰©ç†æ•¸æ“šåŒæ­¥...", "color: #f1c40f;");
        
        // A. ç‰©ç†åˆ·æ–°è¨­æ–½åˆ†é  (è‹¥ç•¶å‰æ­£åœ¨çœ‹ infra)
        if (typeof switchFinTab === 'function') {
            // æˆ‘å€‘ä¸éœ€è¦çœŸæ­£çš„ã€Œåˆ‡æ›ã€ï¼Œåªéœ€ç‰©ç†é‡è·‘æ¸²æŸ“é‚è¼¯
            switchFinTab('infra'); 
        }

        // B. ç‰©ç†åŒæ­¥é ‚éƒ¨æ•¸å€¼æ¬„ä½
        const headerStats = document.getElementById('fin-header-stats');
        if (headerStats) {
            headerStats.innerHTML = `
                <div style="font-size:12px; color:#fff;">ç¾é‡‘: $${player.coin.toLocaleString()} G</div>
                <div style="font-size:10px; color:#888;">åœ‹åº«å„²å‚™: $${window.kingdomSystem.treasury.toLocaleString()} G</div>
            `;
        }
    }

    // åŸºç¤åŒæ­¥
    if (typeof updateEconomyUI === 'function') updateEconomyUI();
    if (typeof updatePlayerUI === 'function') updatePlayerUI();
}

/**
 * ğŸ›ï¸ ç‹åœ‹ç¶“æ¿Ÿç¸½é«”åˆå§‹åŒ–ä¸­æ¨ (å…¨ç’°å¢ƒä¸€éµé»ç«ç‰ˆ)
 * ä½œç”¨ï¼šå°‡è³‡æ–™åº«è®€å–ã€è‚¡å¸‚æ•¸æ“šæ¢å¾©èˆ‡ UI çœ‹æ¿æ¸²æŸ“ç‰©ç†ä¸²è¯
 * ç¢ºä¿ï¼šç¶²é åˆ·æ–°ã€æ’¤é€€å›æ­¸ã€é›²ç«¯åŒæ­¥å¾Œçš„æ•¸æ“šçµ•å°ä¸€è‡´
 */
async function initKingdomEconomy() {
    console.log("%cğŸ“¡ [ç¸½æ§ä¸­å¿ƒ] å•Ÿå‹•ç‹åœ‹ç¶“æ¿Ÿç‰©ç†æ ¡æº–ç¨‹åº...", "color: #f1c40f; font-weight: bold;");

    // 1. ğŸ”¥ ã€ç‰©ç†é‚„åŸå±¤ã€‘ï¼šå¾è³‡æ–™åº«æå–æœ€æ–°å¿«ç…§
    // ç¢ºä¿ loadPlayerFromDB å·²ç¶“åŸ·è¡Œå®Œç•¢ï¼Œæˆ–åœ¨æ­¤åŸ·è¡Œä¸€æ¬¡æ•¸æ“šæª¢ç´¢
    let savedData = null;
    try {
        savedData = await db.playerStats.get('hero');
    } catch (e) {
        console.warn("âš ï¸ è³‡æ–™åº«è®€å–å¤±æ•—ï¼Œå°‡åŸ·è¡Œå…§å­˜åˆå§‹åŒ–æ¨¡å¼ã€‚");
    }

    // 2. ğŸ—ï¸ ã€è¨­æ–½éˆè·¯æ ¡æº–ã€‘ï¼šå°é½Šç‹åœ‹è¨­æ–½æ•¸æ“š
    if (savedData && savedData.kingdomSystem) {
        window.kingdomSystem = savedData.kingdomSystem;
        console.log("âœ… è¨­æ–½ç­‰ç´šæ•¸æ“šå·²æ¢å¾©ã€‚");
    } else {
        // è‹¥ç„¡æ•¸æ“šï¼Œå‰‡å‘¼å« ensureKingdomSystem çš„åˆå§‹åŒ–é‚è¼¯
        if (typeof ensureKingdomSystem === 'function') await ensureKingdomSystem();
    }

    // 3. ğŸ“ˆ ã€è‚¡å¸‚å¯¦é«”é‚„åŸã€‘ï¼šæ¢å¾©æ‰€æœ‰è‚¡ç¥¨çš„æŒå€‰ã€åƒ¹æ ¼èˆ‡ K ç·š
    if (savedData && savedData.kingdomStocks && savedData.kingdomStocks.length > 0) {
        window.kingdomStocks = savedData.kingdomStocks;
        console.log("âœ… è‚¡å¸‚æ­·å²è»Œè·¡å·²é‚„åŸã€‚");
    } else {
        // ç‰©ç†ä¿åº•ï¼šè‹¥ç„¡å­˜æª”æ•¸æ“šï¼Œå¼·åˆ¶é‡å»º 50 æ”¯è‚¡ç¥¨å¯¦é«”
        if (typeof ensureKingdomSystem === 'function') await ensureKingdomSystem();
    }

    // 4. ğŸ¨ ã€è¦–è¦ºåŒæ­¥å±¤ã€‘ï¼šå¼·åˆ¶ UI æ¸²æŸ“
    // A. åˆ·æ–°ç©å®¶é ‚éƒ¨ç‹€æ…‹ (é‡‘å¹£ã€ç¨±è™Ÿ)
    if (typeof updatePlayerUI === 'function') updatePlayerUI();
    
    // B. åˆ·æ–°ç¶“æ¿Ÿçœ‹æ¿ (å³å´è¨­æ–½é€²åº¦æ¢)
    if (typeof updateEconomyUI === 'function') updateEconomyUI();
    
    // C. åˆ·æ–°åœ°åœ–å‹³ç«  (é ˜åœ°é€²åº¦)
    if (typeof updateMapBadges === 'function') updateMapBadges();

    // D. å¦‚æœç›®å‰é–‹è‘—é‡‘èä¸­å¿ƒï¼Œç‰©ç†é‡ç¹ªå…§å®¹
    if (document.getElementById('financial-modal')) {
        if (typeof renderStockContent === 'function') renderStockContent();
    }

    console.log("%cğŸ”¥ [ç¸½æ§ä¸­å¿ƒ] ç‰©ç†é»ç«æˆåŠŸï¼šå…¨ç³»çµ±æ•¸æ“šå·²å°é½Šä¸¦é–å®šã€‚", "color: #2ecc71; font-weight: bold;");
    return true;
}

/**
 * ğŸ“ˆ ç‰©ç†åŠ æˆè¨ˆç®—æ©Ÿï¼šå°‡ç­‰ç´šè½‰åŒ–ç‚ºæˆ°å ´æ•¸å€¼
 */
function getKingdomBonus(type) {
    const up = kingdomSystem.upgrades[type];
    if (!up) return 0;

    switch(type) {
        case 'vault': return up.lv * 0.1;   // æ¯ç´š 0.1% åˆ©æ¯
        case 'mint':  return up.lv * 0.1;   // æ¯ç´š 0.1% å½©é‡‘åŠ æˆ
        case 'trade': return up.lv * 0.1;   // æ¯ç´š 0.1% é–€ç¥¨æ¸›å…
        case 'arena': return up.lv * 0.02;  // æ¯ç´š 0.02 ç½°é‡‘åŸºæ•¸å¢åŠ 
        default: return 0;
    }
}

/**
 * ğŸ“Š ç‰©ç†æ¸²æŸ“ï¼šç‹åœ‹å»ºè¨­çœ‹æ¿ (V5.9.16 æ¬ŠåŠ›è¦ºé†’èªªæ˜ç‰ˆ)
 * ä¿®æ­£ï¼š
 * 1. èªç¾©è£œå®Œï¼šæ˜ç¢ºæ¨™è¨»ã€Œåœ‹ç‹é€£èŠ 3 æ¬¡ã€ä¹‹è¦ºé†’é–€æª»ã€‚ [cite: 2026-02-06]
 * 2. è¦–è¦ºåˆ†æµï¼šå€åˆ†ã€Œä½éšä¸ç¬¦ã€èˆ‡ã€Œé€²åº¦ä¸è¶³ã€çš„ç‰©ç†æç¤ºã€‚
 * 3. ä½ˆå±€åŠ å›ºï¼šç¶­æŒé«˜å°æ¯”æ·±é»‘é¢¨æ ¼ï¼Œå¼·åŒ–é–å®šæ„Ÿã€‚ [cite: 2026-01-19]
 */
function renderKingdomDashboard() {
    const sys = window.kingdomSystem;
    if (!sys || !sys.upgrades) return `<div style="color:#666; font-size:14px; padding:15px;">æ•¸æ“šåŒæ­¥ä¸­...</div>`;

    // ğŸ›¡ï¸ ç‰©ç†é–å®šï¼šæª¢ç´¢æœ€æ–°ä½éšèˆ‡é€£èŠæ•¸æ“š
    const hero = pokerGame.players.find(p => p.id === 'player');
    const streak = player.kingStreak || 0;
    const threshold = sys.streakThreshold || 3;
    const vaultLv = sys.upgrades.vault.lv;
    
    const interestRatePercent = (0.5 + (vaultLv * 0.005)).toFixed(3);
    const estimatedInterest = Math.floor(sys.treasury * (0.005 + (vaultLv * 0.00005)));

    // åˆ¤å®šï¼šåœ‹ç‹èº«ä»½ä¸”é€£èŠé”æ¨™
    const isKing = (hero && hero.rank === 'king');
    const canSiphon = (isKing && streak >= threshold);

    return `
        <div class="side-module" style="background: rgba(18, 18, 22, 0.96); border: 2px solid rgba(255, 255, 255, 0.1); border-radius: 16px; padding: 18px; margin-bottom: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.6); backdrop-filter: blur(12px);">
            
            <div style="font-size: 15px; font-weight: 900; color: #f1c40f; letter-spacing: 1.5px; border-bottom: 1px solid rgba(255,255,255,0.08); padding-bottom: 10px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center;">
                <span>ğŸ›ï¸ ç‹åœ‹å»ºè¨­ç¸½ç½²</span>
                <b style="color: #fff; font-family: monospace; font-size: 18px;">$${sys.treasury.toLocaleString()}</b>
            </div>

            <div style="display: flex; justify-content: space-between; font-size: 12px; color: #2ecc71; margin-bottom: 15px; font-weight:bold; background:rgba(46, 204, 113, 0.1); padding:8px 12px; border-radius:8px;">
                <span>åˆ©ç‡: +${interestRatePercent}%</span>
                <span>é ä¼°: +$${estimatedInterest.toLocaleString()}</span>
            </div>
            
            <div style="display: flex; flex-direction: column; gap: 10px;">
                ${Object.keys(sys.upgrades).map(k => {
                    const up = sys.upgrades[k];
                    const percent = Math.min(100, (up.lv / 10)).toFixed(1);
                    return `
                    <div>
                        <div style="display: flex; justify-content: space-between; font-size: 12px; color: #aaa; margin-bottom: 4px;">
                            <span style="font-weight: bold;">${up.name}</span>
                            <span style="color:#fff;">Lv.${up.lv}</span>
                        </div>
                        <div style="width: 100%; height: 5px; background: #000; border-radius: 3px; overflow: hidden; border: 1px solid #333;">
                            <div style="width: ${percent}%; height: 100%; background: linear-gradient(90deg, #b7950b, #f1c40f); box-shadow: 0 0 10px rgba(241, 196, 15, 0.4);"></div>
                        </div>
                    </div>`;
                }).join('')}
            </div>

            <div style="margin-top: 20px; border-top: 1px dashed rgba(255,255,255,0.1); padding-top: 15px;">
                ${canSiphon ? `
                    <button onclick="window.kingdomSystem.executeSiphon()" class="action-btn" style="width:100%; background: linear-gradient(45deg, #900, #c0392b); color:#fff; font-size:14px; font-weight:900; padding:12px; border-radius:10px; border:2px solid #f1c40f; cursor:pointer; box-shadow: 0 0 20px rgba(192,57,43,0.5); animation: pulse 1.5s infinite;">
                        ğŸ©¸ ç™¼å‹•æš´æ”¿ï¼šç§ååœ‹åº« (10%)
                    </button>
                    <div style="font-size:10px; color:#ff4d4d; text-align:center; margin-top:8px; font-style:italic;">âš ï¸ è­¦å‘Šï¼šæ­¤èˆ‰å°‡ç‰©ç†æ€§å¼•ç™¼åæŠ—è»åŒ…åœç¶²</div>
                ` : `
                    <div style="width:100%; background: #1a1a1a; border: 1px solid #444; border-radius:10px; padding:15px; display:flex; flex-direction:column; align-items:center; gap:8px; opacity: 0.85;">
                        <span style="font-size:20px; filter: grayscale(1); opacity: 0.5;">ğŸ”’</span>
                        <div style="font-size:13px; color:#f1c40f; font-weight:bold; letter-spacing:1px;">æš´æ”¿æ¬Šåˆ©å°šæœªè¦ºé†’</div>
                        
                        <div style="font-size:11px; color:#888; text-align:center; line-height:1.5;">
                            <b style="color:#eee;">ã€Œåœ‹ç‹ã€é€£èŠ3æ¬¡</b><br>å³å¯è§£é–<br>
                            <span style="color:#555; font-size:10px; margin-top:4px; display:block;">
                                ${isKing ? `ç•¶å‰é€£èŠé€²åº¦ï¼š<b style="color:#f1c40f;">${streak} / ${threshold}</b>` : `ç›®å‰ä½éšä¸ç¬¦ï¼Œæ¬Šåˆ©è™•æ–¼å°å°ç‹€æ…‹`}
                            </span>
                        </div>
                    </div>
                `}
            </div>
        </div>
    `;
}


/**
 * ğŸ’‰ ç‰©ç†æ¸²æŸ“ï¼šå‹‡è€…ç”Ÿå­˜ç›£æ§å„€ (HP + è—¥æ°´è£œçµ¦)
 * ä½œç”¨ï¼šåœ¨å°å±€ä¸­å³æ™‚é¡¯ç¤ºè¡€é‡ï¼Œä¸¦æä¾›è£œè¡€å¿«æ·éµ
 */
function renderHeroSurvivalBelt() {
    const hpPercent = Math.max(0, (player.currentHp / player.maxHp) * 100);
    const potionCount = player.items?.potion || 0;
    
    // æ ¹æ“šè¡€é‡ç‹€æ…‹ç‰©ç†æ”¹è®Šé¡è‰²
    const hpColor = hpPercent <= 25 ? "#ff4d4d" : (hpPercent <= 50 ? "#f1c40f" : "#2ecc71");

    return `
        <div id="hero-survival-belt" style="display: flex; align-items: center; gap: 15px; width: 100%; max-width: 850px; margin-bottom: 15px; padding: 12px; background: rgba(10, 10, 10, 0.8); border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px);">
            <div style="flex: 1; display: flex; align-items: center; gap: 12px;">
                <span style="font-size: 16px;">â¤ï¸</span>
                <div style="flex: 1; height: 12px; background: rgba(255,255,255,0.05); border-radius: 6px; overflow: hidden; border: 1px solid #333;">
                    <div id="poker-hp-fill" style="width: ${hpPercent}%; height: 100%; background: ${hpColor}; transition: width 0.5s cubic-bezier(0.1, 0.9, 0.2, 1);"></div>
                </div>
                <div style="font-family: monospace; font-size: 13px; color: ${hpColor}; width: 85px; text-align: right; font-weight: bold;">
                    ${Math.floor(player.currentHp)} / ${player.maxHp}
                </div>
            </div>

            <div style="display: flex; align-items: center; gap: 10px; border-left: 1px solid rgba(255,255,255,0.1); padding-left: 15px;">
                <button onclick="usePotionInPoker()" class="game-btn" style="background: ${potionCount > 0 ? 'rgba(46, 204, 113, 0.15)' : 'rgba(255,255,255,0.02)'}; border: 1px solid ${potionCount > 0 ? '#2ecc71' : '#444'}; color: ${potionCount > 0 ? '#fff' : '#666'}; padding: 6px 12px; border-radius: 8px; display: flex; align-items: center; gap: 8px; transition: 0.2s;" ${potionCount <= 0 ? 'disabled' : ''}>
                    ğŸ§´ è£œè¡€è—¥æ°´ <b style="color: #2ecc71;">x${potionCount}</b>
                </button>
            </div>
        </div>
    `;
}

/**
 * ğŸ§´ ç‰©ç†æ“ä½œï¼šåœ¨å°å±€ä¸­é£²ç”¨è£œè¡€è—¥æ°´ (V5.9.23 å®Œå…¨å°æ­£ç‰ˆ)
 * ä¿®æ­£é»ï¼š
 * 1. ç„¡æ™é–å®šï¼šè‹¥ HP å…¨æ»¿ä¸”ç„¡ç‹€æ…‹ï¼Œç‰©ç†æ””æˆªæ¶ˆè€—ä¸¦æç¤ºã€‚ [cite: 2026-02-06]
 * 2. å¾©ç”¦æ©Ÿåˆ¶ï¼šç§»é™¤ 0 HP é™åˆ¶ï¼Œå…è¨±å¾æ­»äº¡é‚Šç·£å¼·è¡Œå›è¡€ã€‚ [cite: 2026-02-06]
 * 3. æ ¼å¼æ ¡æº–ï¼šåŒæ­¥æ›´æ–°ç”Ÿå‘½çƒæ–‡å­—ç‚ºã€ŒHP99 / HP999ã€æ ¼å¼ã€‚ [cite: 2026-02-06]
 */
async function usePotionInPoker() {
    // 0. ğŸ”¥ ã€æ•¸æ“šéˆè·¯æª¢æŸ¥ã€‘
    if (!player.items || (player.items.potion || 0) <= 0) {
        showNotification("âŒ è—¥æ°´å·²ç”¨ç›¡ï¼");
        return;
    }

    // 1. ğŸ›¡ï¸ ã€ç‰©ç†æ””æˆªï¼šç„¡æ™æª¢å®šã€‘ [cite: 2026-02-06]
    // è¦å‰‡ï¼šè¡€é‡å¤§æ–¼ç­‰æ–¼ä¸Šé™ ä¸” ç›®å‰æ²’æœ‰ä¸­æ¯’ã€å‡ºè¡€ã€éº»ç—ºç­‰ç•°å¸¸ç‹€æ…‹
    if (player.currentHp >= player.maxHp && !player.status) {
        showNotification("âœ¨ ç›®å‰èº«å¿ƒç„¡æ™ï¼Œç„¡éœ€ä½¿ç”¨è—¥åŠ‘ã€‚");
        console.log("%cğŸ›¡ï¸ [ç‰©è³‡ä¿è­·] ç©å®¶ç‹€æ…‹å®Œå¥½ï¼Œç‰©ç†æ””æˆªè—¥æ°´æ¶ˆè€—ã€‚", "color: #2ecc71;");
        return;
    }

    // 2. ğŸ’¸ ã€ç‰©ç†æ¶ˆè€—èˆ‡æ¼”ç®—ã€‘ (æ¢å¾© 50% HP)
    const healAmount = Math.floor(player.maxHp * 0.5);
    player.items.potion--;
    
    // ğŸ”¥ ã€æ ¸å¿ƒä¿®æ­£ï¼šè§£é™¤æ­»äº¡é–å®šã€‘å…è¨±å¾ 0 æˆ– è² å€¼ç‰©ç†æ‹‰å›ç”Ÿå‘½ç·š [cite: 2026-02-06]
    player.currentHp = Math.min(player.maxHp, Math.max(0, player.currentHp) + healAmount);

    // 3. ğŸ¨ ã€ç‰©ç†è¦–è¦ºåŒæ­¥ï¼šç”Ÿå‘½ä¹‹çƒã€‘
    const liquid = document.querySelector('.hp-liquid');
    const hudHpText = document.getElementById('hud-hp-number');
    const hpBar = document.getElementById('poker-hp-fill');

    // A. æ²»ç™’é–ƒçˆæ¿¾é¡
    if (liquid) {
        liquid.style.transition = "none";
        liquid.style.filter = "brightness(2) drop-shadow(0 0 15px #fff)";
        const hpPercent = (player.currentHp / player.maxHp) * 100;
        liquid.style.height = `${hpPercent}%`;
        
        setTimeout(() => {
            liquid.style.transition = "height 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275), filter 0.5s";
            liquid.style.filter = "none";
        }, 50);
    }

    // B. ğŸ”¥ ã€æ ¼å¼é‡æ•´ã€‘å°é½Š HP99 / HP999 ç‰©ç†æ ¼å¼ [cite: 2026-02-06]
    if (hudHpText) {
        hudHpText.innerText = `HP${Math.floor(player.currentHp)} / HP${player.maxHp}`;
        // ç¢ºä¿å±¤ç´šç½®é ‚ (è‹¥æ¸²æŸ“æ™‚éºå¤±æ¨£å¼ï¼Œæ­¤è™•å¼·åˆ¶è£œå›)
        hudHpText.style.zIndex = "10";
    }

    if (hpBar) {
        hpBar.style.width = `${(player.currentHp / player.maxHp) * 100}%`;
    }

    // 4. ğŸ“Š ã€æˆ°è¡“è¨˜éŒ„ã€‘
    addBattleLog(`ğŸ§ª <b style="color:#2ecc71;">[ç‰©ç†å¾©ç”¦]</b> å‹‡è€…æ¶ˆè€—äº†è£œè¡€è—¥æ°´ï¼Œå›å¾©äº† ${healAmount} é» HPã€‚`);
    showNotification(`ğŸ§´ é«”åŠ›æ¢å¾©æˆåŠŸï¼`);

    // 5. ğŸ’¾ ã€å…¨åŸŸåŒæ­¥èˆ‡å­˜æª”ã€‘ [cite: 2026-01-21]
    if (typeof updatePlayerUI === 'function') updatePlayerUI();
    if (typeof savePlayerToDB === 'function') await savePlayerToDB();
    
    // ç‰©ç†é‡ç¹ªç•¶å‰ç‰Œæ¡Œï¼Œç¢ºä¿è—¥æ°´æ•¸é‡èˆ‡ HUD æŒ‡ä»¤æŒ‰éˆ•ç‹€æ…‹å°é½Š
    if (typeof renderPokerTable === 'function') {
        renderPokerTable(document.getElementById('poker-table'));
    }
}


// --- ğŸ§¹ ç‡ƒæ–™å¤§æƒé™¤å¼•æ“ï¼šå…§å®¹é‡è¤‡ç‡ç‰©ç†æ¢æ¸¬èˆ‡åˆä½µ ---
async function cleanUpFuelPacks() {
    showNotification("ğŸ” æ­£åœ¨é€²è¡Œè³‡æ–™åº«ç‰©ç†æƒæ...");
    
    try {
        const allPacks = await db.fuelPacks.toArray();
        if (allPacks.length < 2) return showNotification("â„¹ï¸ ç‡ƒæ–™é‡ä¸è¶³ï¼Œç„¡éœ€æƒé™¤ã€‚");

        let deletedCount = 0;
        const toDeleteIds = new Set();
        
        // 1. ğŸ”¥ ã€ç‰©ç†æƒæç‰¹å¾µæå–ã€‘
        // æå–æ¯å€‹ç« ç¯€çš„å–®å­—æŒ‡ç´‹ (å°‡æ‰€æœ‰å–®å­—çµ„åˆç‚ºä¸€é•·ä¸²å­—ä¸²)
        const packFingerprints = allPacks.map(p => ({
            id: p.id,
            name: p.name,
            fingerprint: (p.vocab || []).map(v => v.w).sort().join('|')
        }));

        // 2. ğŸ”¥ ã€ç›¸ä¼¼åº¦çŸ©é™£å°æ¯”ã€‘
        for (let i = 0; i < packFingerprints.length; i++) {
            if (toDeleteIds.has(packFingerprints[i].id)) continue;

            for (let j = i + 1; j < packFingerprints.length; j++) {
                if (toDeleteIds.has(packFingerprints[j].id)) continue;

                // ç‰©ç†ç›¸ä¼¼åº¦è¨ˆç®— (åŸºæ–¼å–®å­—æŒ‡ç´‹)
                const similarity = calculateSimilarity(packFingerprints[i].fingerprint, packFingerprints[j].fingerprint);
                
                if (similarity > 0.9) {
                    console.log(`âš–ï¸ æª¢æ¸¬åˆ°é«˜åº¦é‡è¤‡ï¼š\n[A] ${packFingerprints[i].name}\n[B] ${packFingerprints[j].name}\nç›¸ä¼¼åº¦: ${(similarity * 100).toFixed(1)}%`);
                    // ç­–ç•¥ï¼šä¿ç•™ iï¼Œæ¨™è¨˜åˆªé™¤ j
                    toDeleteIds.add(packFingerprints[j].id);
                    deletedCount++;
                }
            }
        }

        // 3. ğŸ”¥ ã€ç‰©ç†åŸ·è¡Œæƒé™¤ã€‘
        if (deletedCount > 0) {
            const confirmClean = confirm(`ğŸ§¹ æƒé™¤å ±å‘Šï¼š\n\nåµæ¸¬åˆ° ${deletedCount} å€‹å…§å®¹é«˜åº¦é‡ç–Šçš„ç« ç¯€ã€‚\næ˜¯å¦åŸ·è¡Œç‰©ç†åˆä½µï¼ˆä¿ç•™å”¯ä¸€ç‰ˆæœ¬ï¼‰ï¼Ÿ`);
            
            if (confirmClean) {
                await db.fuelPacks.bulkDelete(Array.from(toDeleteIds));
                showNotification(`âœ… å¤§æƒé™¤å®Œæˆï¼ç‰©ç†ç§»é™¤äº† ${deletedCount} å€‹è´…é¤˜ç« ç¯€ã€‚`);
                if (typeof renderHistoryList === 'function') await renderHistoryList();
            }
        } else {
            showNotification("âœ¨ æƒæå®Œç•¢ï¼æ‚¨çš„è³‡æ–™åº«éå¸¸æ•´æ½”ï¼Œç„¡é‡è¤‡ç‡ƒæ–™ã€‚");
        }

    } catch (e) {
        console.error("ğŸš¨ å¤§æƒé™¤ç‰©ç†å¤±æ•—:", e);
        showNotification("âŒ æƒé™¤éç¨‹ç™¼ç”Ÿç•°å¸¸");
    }
}

// è¼”åŠ©ï¼šç‰©ç†å­—ä¸²ç›¸ä¼¼åº¦è¨ˆç®— (Jaccard Index ç°¡åŒ–ç‰ˆ)
function calculateSimilarity(str1, str2) {
    if (str1 === str2) return 1.0;
    if (!str1 || !str2) return 0;
    
    const set1 = new Set(str1.split('|'));
    const set2 = new Set(str2.split('|'));
    const intersection = new Set([...set1].filter(x => set2.has(x)));
    const union = new Set([...set1, ...set2]);
    
    return intersection.size / union.size;
}


function getStarterPack(level) {
    const starters = {
        "N5": { 
            name: "ğŸŒ± è‰åœ°å²èŠå§†", 
            difficulty: "N5", 
            appearance: "ğŸŒ", 
            element: "earth",
            exam: [
                { q: "ã€Œã“ã‚“ã«ã¡ã¯ã€çš„æ„æ€æ˜¯ï¼Ÿ", o: ["ä½ å¥½", "è¬è¬", "å†è¦‹", "å°ä¸èµ·"], a: 0, element: "none" },
                { q: "ã€Œæ°´ã€çš„è®€éŸ³æ˜¯ï¼Ÿ", o: ["ã", "ã²", "ã¿ãš", "ã¤ã¡"], a: 2, element: "ice" }
            ],
            loots: [{ id: "pen_01", chance: 0.1 }]
        },
        "N4": { 
            name: "ğŸŒ² èªæ³•å“¥å¸ƒæ—", 
            difficulty: "N4", 
            appearance: "ğŸ‘º", 
            element: "thunder",
            exam: [
                { q: "ã€Œè¡Œãã¾ã™ã€çš„éå»å¼ï¼Ÿ", o: ["è¡Œãã¾ã—ãŸ", "è¡Œãã§ã—ãŸ", "è¡Œãã¦", "è¡Œã£ãŸ"], a: 0, element: "none" },
                { q: "ã€Œï½ã¦ãã ã•ã„ã€ç”¨æ–¼ï¼Ÿ", o: ["æƒ³åš", "è«‹æ±‚", "ç¦æ­¢", "æ­£åœ¨åš"], a: 1, element: "none" }
            ],
            loots: [{ id: "armor_01", chance: 0.05 }]
        },
        "N3": { 
            name: "â›°ï¸ è½åŠ›è™è ", 
            difficulty: "N3", 
            appearance: "ğŸ¦‡", 
            element: "ice",
            exam: [
                { q: "ã€Œæº–å‚™ã€çš„è®€éŸ³ï¼Ÿ", o: ["ã˜ã‚…ã‚“ã³", "ã˜ã‚…ã‚“ã´", "ãœã‚“ã³", "ã˜ã‚‡ã‚“ã³"], a: 0, element: "none" },
                { q: "ã€Œå…¨ç„¶ã€å¾Œæ¥ï¼Ÿ", o: ["è‚¯å®šå½¢", "å¦å®šå½¢", "ç–‘å•å½¢", "å‘½ä»¤å½¢"], a: 1, element: "none" }
            ],
            loots: [{ id: "hat_01", chance: 0.05 }]
        },
        "N2": { 
            name: "ğŸ¯ è©å½™æƒ¡é­”", 
            difficulty: "N2", 
            appearance: "ğŸ‘¿", 
            element: "fire",
            exam: [
                { q: "ã€Œå¦¥å”ã€çš„è®€éŸ³ï¼Ÿ", o: ["ã ãã‚‡ã†", "ã ãã‚…ã†", "ãŸãã‚‡ã†", "ãŸãã‚‡ã†"], a: 0, element: "none" },
                { q: "è¡¨ç¤ºã€Œå‰›åšå®ŒæŸäº‹ã€ï¼Ÿ", o: ["ãŸã°ã‹ã‚Š", "ãŸã¨ã“ã‚", "ãŸã°ã‹ã‚Š/ãŸã¨ã“ã‚", "ã¦ã„ã‚‹"], a: 2, element: "none" }
            ],
            loots: [{ id: "ear_01", chance: 0.05 }]
        },
        "N1": { 
            name: "ğŸ”¥ çµ‚ç„‰é­”ç‹", 
            difficulty: "N1", 
            appearance: "ğŸ²", 
            element: "fire",
            exam: [
                { q: "ã€Œå‚ã‚‰ã€çš„è®€éŸ³ï¼Ÿ", o: ["ã‹ãŸã‚ã‚‰", "ãã°ã‚‰", "ã‚ãã‚‰", "ã‹ã©ã‚ã‚‰"], a: 0, element: "none" },
                { q: "ã€Œï½ã‚’ã‚‚ã®ã¨ã‚‚ã›ãšã«ã€ï¼Ÿ", o: ["å„˜ç®¡", "ä¸é¡§/ä¸ç•", "å› ç‚º", "éš¨è‘—"], a: 1, element: "none" }
            ],
            loots: [{ id: "pen_02", chance: 0.01 }]
        }
    };
    return starters[level] || starters["N5"];
}


// --- ğŸ“¦ ç‰©ç†åˆå§‹åŒ–ï¼šå°‡åŸºç¤ StarterPacks æ³¨å…¥è³‡æ–™åº« ---
async function initDefaultLibrary() {
    try {
        // 1. ç‰©ç†æª¢æŸ¥ï¼šè³‡æ–™åº«ä¸­æ˜¯å¦å·²æœ‰ä»»ä½•ç‡ƒæ–™åŒ…
        const count = await db.fuelPacks.count();
        
        if (count === 0) {
            console.log("%cğŸš€ åµæ¸¬åˆ°è³‡æ–™åº«ç‚ºç©ºï¼Œæ­£åœ¨åˆå§‹åŒ–åŸºç¤é­”ç‰©åº«...", "color: #3498db; font-weight: bold;");
            
            const levels = ["N5", "N4", "N3", "N2", "N1"];
            const defaultPacks = levels.map(lv => {
                const pack = getStarterPack(lv);
                // ç‰©ç†æ‰“ä¸Šã€Œç³»çµ±é è¨­ã€æ¨™ç±¤ï¼Œæ–¹ä¾¿ä»¥å¾Œéæ¿¾
                return { ...pack, isSystemDefault: true };
            });

            // 2. ç‰©ç†æ‰¹æ¬¡å¯«å…¥
            await db.fuelPacks.bulkAdd(defaultPacks);
            
            // 3. åŒæ­¥å´é‚Šæ¬„
            if (typeof renderHistoryList === 'function') {
                await renderHistoryList();
            }
            
            console.log("%câœ… åŸºç¤é­”ç‰©åº«åˆå§‹åŒ–å®Œæˆï¼å‹‡è€…å¯ä»¥é–‹å§‹å‡ºå¾äº†ã€‚", "color: #27ae60;");
        } else {
            console.log("â„¹ï¸ è³‡æ–™åº«å·²æœ‰æ•¸æ“šï¼Œè·³éåˆå§‹åŒ–ã€‚");
        }
    } catch (e) {
        console.error("âŒ åˆå§‹åŒ–åŸºç¤åº«å¤±æ•—:", e);
    }
}


// --- ğŸ–ï¸ ç‰©ç†å‹³ç« æ¸²æŸ“å™¨ ---
function updateMapBadges() {
    const difficulties = ["N5", "N4", "N3", "N2", "N1"];
    
    difficulties.forEach(diff => {
        const statEl = document.getElementById(`stat-${diff}`);
        const badgeEl = document.getElementById(`badge-${diff}`);
        const btnEl = document.getElementById(`btn-${diff}`);
        
        if (!statEl || !badgeEl) return;

        // 1. å–å¾—ç©å®¶åœ¨è©²å€çš„ä½”é ˜æ•¸
        const count = (player.mapProgress && player.mapProgress[diff]) ? player.mapProgress[diff] : 0;
        statEl.innerText = count;

        // 2. ç‰©ç†åˆ¤å®šå‹³ç« ç­‰ç´š
        badgeEl.className = "map-badge"; // é‡ç½® Class
        if (btnEl) btnEl.classList.remove('btn-legend-completed');

        if (count >= 100) {
            badgeEl.innerText = "â­";
            badgeEl.classList.add('badge-legend');
            if (btnEl) btnEl.classList.add('btn-legend-completed');
        } else if (count >= 60) {
            badgeEl.innerText = "ğŸ¥ˆ";
        } else if (count >= 30) {
            badgeEl.innerText = "ğŸ¥‰";
        } else {
            badgeEl.innerText = ""; // å°šæœªç²å¾—æ¨™ç« 
        }
    });
}


// --- âš”ï¸ å•Ÿå‹•æˆ°é¬¥ï¼šåŸ·è¡Œç‰©ç†é‡å»º UIã€é–å®šèƒŒæ™¯ä¸¦ã€æ•´åˆç¥è©±è£å‚™èˆ‡ VIP ç‰¹æ¬Šã€‘ ---
async function startDQBattle(pack) {
    // 1. ğŸ”¥ ã€ç‰©ç†äº’æ–¥é–ã€‘è‹¥å·²åœ¨æˆ°é¬¥ä¸­ï¼Œç«‹å³æ””æˆªé˜²æ­¢é‡ç–Š
    if (battleData.isBattleActive) return;
    
    // ğŸ”¥ ã€é—œéµä¿®æ­£ Aã€‘ç‰©ç†é–å®šç¶²é æ»¾å‹•
    document.body.style.overflow = 'hidden';

    // ğŸ›¡ï¸ ã€ç‰©ç†å®‰å…¨æª¢æŸ¥ï¼šé˜²è­·åŠ å›ºã€‘
    const safePack = pack || {};
    const rawName = safePack.name || "æœªçŸ¥é­”ç‰©";
    const cleanName = String(rawName).replace(/<[^>]*>?/gm, '');

    // 2. ğŸ”¥ ã€ç‰©ç†æ¨™ç±¤ã€‘å”¯ä¸€ ID
    const thisBattleId = Date.now();
    window.currentBattleId = thisBattleId;
    battleData.isBattleActive = true;
    window.isBattleTransitioning = false; 

    // 3. ç‰©ç†æª¢æŸ¥ï¼šç²å–å ´æ™¯å®¹å™¨
    const scene = document.getElementById('battle-scene');
    if (!scene) return;

    // 4. ğŸ”¥ ã€é—œéµä¿®æ­£ Bã€‘ç‰©ç†å±¤ç´šç½®é ‚å¼·åŒ–
    scene.style.position = 'fixed';
    scene.style.zIndex = '99999'; 
    scene.style.display = 'flex';
    scene.style.pointerEvents = 'auto'; 
    scene.classList.add('battle-fade-in'); 

    scene.innerHTML = `
        <div id="battle-monster-zone" style="height:220px; display:flex; flex-direction:column; align-items:center; justify-content:center; position:relative; overflow:visible;">
            <div id="battle-monster-sprite" style="font-size:100px; transition:0.2s; cursor:default; filter: drop-shadow(0 10px 20px rgba(0,0,0,0.5));">ğŸ‘¾</div>
            <div style="width:200px; height:12px; border:2px solid #fff; margin-top:15px; background:#444; border-radius:6px; overflow:hidden; box-shadow:0 0 10px rgba(255,0,0,0.3);">
                <div id="monster-hp-bar" style="width:100%; height:100%; background:#f00; transition:0.4s cubic-bezier(0.1, 0.9, 0.2, 1);"></div>
            </div>
            <div id="enemy-name" style="font-size:16px; margin-top:8px; color:#fff; font-weight:bold; text-shadow:2px 2px 4px #000;">é­”ç‰©</div>
        </div>

        <div style="width:92%; max-width:550px; border:4px solid #fff; padding:18px; background:rgba(0,0,0,0.9); margin:25px 0; min-height:90px; box-shadow: 0 0 25px rgba(255,255,255,0.15); border-radius:8px;">
            <div id="battle-msg" style="font-size:19px; line-height:1.6; color:#fff; font-family:'Meiryo', sans-serif;"></div>
        </div>

        <div id="battle-footer" style="width:92%; max-width:550px; display:grid; grid-template-columns: 140px 1fr; gap:12px;">
            <div style="border:4px solid #fff; padding:12px; background:#111; border-radius:8px; display:flex; flex-direction:column; justify-content:center;">
                <div style="font-size:12px; color:#aaa; margin-bottom:4px;">HERO LV.<span id="battle-hero-lv"></span></div>
                <div style="font-size:20px; color:#0f0; font-weight:bold; letter-spacing:1px;">HP <span id="hero-hp-val"></span></div>
                <div style="width:100%; height:8px; background:#333; margin-top:8px; border-radius:4px; overflow:hidden; border:1px solid #555;">
                    <div id="hero-hp-bar" style="width:100%; height:100%; background:#0f0; transition:0.3s;"></div>
                </div>
            </div>
            <div id="battle-quiz-zone" style="border:4px solid #fff; padding:12px; background:rgba(20,20,20,0.8); position:relative; min-height:120px; border-radius:8px; overflow-y:auto; transition: box-shadow 0.3s;">
                </div>
        </div>
    `;

    // 5. ğŸ”¥ ã€æ•¸æ“šæ·±åº¦æ’ˆå–ã€‘
    let combinedExamPool = [];
    try {
        const difficultyPacks = await db.fuelPacks.where('difficulty').equals(currentMapDifficulty).toArray();
        if (difficultyPacks.length > 0) {
            difficultyPacks.forEach(p => {
                if (p.exam && Array.isArray(p.exam)) combinedExamPool = combinedExamPool.concat(p.exam);
            });
        }
    } catch (dbErr) { console.error("è³‡æ–™åº«æ’ˆå–å¤±æ•—:", dbErr); }

    // 6. ç‰©ç†ä¿åº•
    if (combinedExamPool.length === 0) {
        combinedExamPool = safePack.exam || getStarterPack(currentMapDifficulty).exam;
    }

    // 7. ğŸ”¥ ã€ç‰©ç†ç‹€æ…‹åŒæ­¥ã€‘
    const heroMaxHP = player.maxHp || 50;
    const heroCurrentHP = player.currentHp || 50;
    battleData.heroHP = (heroCurrentHP / heroMaxHP) * 100;

    const hpScale = { "N5": 100, "N4": 180, "N3": 350, "N2": 600, "N1": 1000, "N0": 2500 };
    battleData.monsterMaxHP = hpScale[currentMapDifficulty] || 100;
    battleData.monsterHP = battleData.monsterMaxHP;

    // 8. ç‰©ç†æ¸²æŸ“é­”ç‰©å½¢è±¡èˆ‡è³‡æ–™
    const enemySprite = document.getElementById('battle-monster-sprite');
    const enemyNameEl = document.getElementById('enemy-name');
    const msgEl = document.getElementById('battle-msg');

    const finalAppearance = safePack.appearance || getRandomEnemyAppearance(currentMapDifficulty);
    if (enemySprite) {
        enemySprite.innerText = finalAppearance;
        enemySprite.style.animation = "monster-bounce 0.8s infinite alternate";
    }

    // --- ğŸ§ª ç‰©ç†å¢å¼·å°å…¥ï¼šç¥è©±è£å‚™èˆ‡ç‰¹æ¬Šåˆ¤å®š ---
    const inv = player.inventory || [];
    const hasScepter = inv.includes("ğŸ’€ å¯©åˆ¤è€…çš„è¡€è…¥æ¬Šæ–");
    const hasGlasses = inv.includes("ğŸ‘“ é€è¦–çœ¼é¡");

    if (enemyNameEl) {
        let nameHTML = `${currentMapDifficulty} ç´šï¼š${cleanName}`;
        // ğŸ”¥ ã€ç‰©ç†çœ‹ç ´ï¼šçœ¼é¡å±¬æ€§é€£å‹•ã€‘
        if (hasGlasses) {
            const elementMap = { fire: "ğŸ”¥ç«", ice: "â„ï¸å†°", thunder: "âš¡é›·", earth: "â›°ï¸åœ°", none: "ğŸ”˜ä¸€èˆ¬" };
            const enemyElement = safePack.element || "none";
            nameHTML += ` <span style="font-size:10px; color:#f1c40f; border:1px solid #f1c40f; padding:0 4px; border-radius:3px; margin-left:5px;">å¼±é»:${elementMap[enemyElement]}</span>`;
        }
        enemyNameEl.innerHTML = nameHTML;
    }

    // 9. ğŸ”¥ ã€ç‰©ç†è¦–è¦ºï¼šå¸è¡€æ¨¡å¼èˆ‡ VIP ç‰¹æ¬Šã€‘
    if (hasScepter) {
        const quizZone = document.getElementById('battle-quiz-zone');
        if (quizZone) quizZone.style.boxShadow = "inset 0 0 15px rgba(155, 89, 182, 0.4)";
        showNotification("<b style='color:#9b59b6;'>ğŸ’€ å¯©åˆ¤æ¬Šæ–å…±é³´ä¸­ï¼šæ”»æ“Šå°‡å¸å–éˆé­‚ã€‚</b>");
    }

    if (player.hasVipCard) {
        if (msgEl) msgEl.innerHTML = `âš ï¸ é­”ç‰©ã€${finalAppearance}ã€‘ç™¼å‹•å¥‡è¥²ï¼<br><small style="color:#2ecc71;">[é»‘å¸‚è²´è³“å—é‚€è³½ï¼šç¶“é©—ç²å–æå‡ 10%]</small>`;
    } else {
        if (msgEl) msgEl.innerText = `âš ï¸ é­”ç‰©ã€${finalAppearance}ã€‘ç™¼å‹•äº†å¥‡è¥²ï¼è«‹æº–å‚™æ‡‰æˆ°ï¼`;
    }
    
    // åŒæ­¥ç©å®¶æ•¸æ“š
    document.getElementById('battle-hero-lv').innerText = player.lv;
    document.getElementById('hero-hp-val').innerText = Math.floor(player.currentHp);
    const hBar = document.getElementById('hero-hp-bar');
    if (hBar) hBar.style.width = `${(player.currentHp / player.maxHp) * 100}%`;

    // 10. ğŸ”¥ ã€å…¨å±€é–å®šèˆ‡æŠ½é¡Œã€‘
    window.currentExamPool = combinedExamPool; 
    
    setTimeout(() => {
        if (window.currentBattleId === thisBattleId) {
            nextBattleTurn(window.currentExamPool);
        }
    }, 150);
}

/**
 * âš”ï¸ ç‰©ç†å­ç¨‹åºï¼šæˆ°é¬¥å›åˆåˆ‡æ› (V5.9.26 å¤§ä¸€çµ±è£å‚™ç‰ˆ)
 * ä¿®æ­£ï¼šç§»é™¤ç¡¬ç·¨ç¢¼è—¥æ°´æŒ‰éˆ•ï¼Œå‹•æ…‹æ¸²æŸ“è‡ªå®šç¾©æˆ°è¡“è£å‚™æ¬„ä½ã€‚
 */
function nextBattleTurn(examPool) {
    // 1. ğŸ›¡ï¸ ç‰©ç†å®‰å…¨æª¢æŸ¥
    if (!examPool || examPool.length === 0) {
        console.error("âŒ é¡Œåº«ç‰©ç†æ€§ç©ºè™›ï¼Œç„¡æ³•ç¹¼çºŒæˆ°é¬¥ï¼");
        const msgEl = document.getElementById('battle-msg');
        if (msgEl) msgEl.innerText = "é­”ç‰©ç™¼å‘†äº†...ï¼ˆæ‰¾ä¸åˆ°é¡Œç›®æ•¸æ“šï¼‰";
        setTimeout(() => finishBattle(true), 2000);
        return;
    }

    // 2. âš–ï¸ ç‰©ç†å‹è² åˆ¤å®š
    if (battleData.heroHP <= 0 || battleData.monsterHP <= 0) {
        return finishBattle(battleData.monsterHP <= 0);
    }

    // 3. ğŸ² ã€ç‰©ç†éš¨æ©ŸæŠ½å–ã€‘
    const quiz = examPool[Math.floor(Math.random() * examPool.length)];
    battleData.currentQuiz = quiz;

    // 4. ç²å– UI å®¹å™¨
    const quizZone = document.getElementById('battle-quiz-zone');
    const msgEl = document.getElementById('battle-msg');
    if (!quizZone || !msgEl) return;

    // 5. æ¸²æŸ“é­”ç‰©æ”»æ“Šè¨Šæ¯
    const typeTag = quiz.type === 'grammar' ? '[æ–‡æ³•æ”»æ“Š]' : '[èªå½™è¡æ“Š]';
    msgEl.innerText = `${typeTag}\n${quiz.q}`;

    // 6. ğŸ”¥ ã€æ ¸å¿ƒä¿®æ­£ï¼šæ¸²æŸ“å¤§ä¸€çµ±æˆ°è¡“æŒ‡ä»¤é¸å–®ã€‘ [cite: 2026-02-06]
    // ç‰©ç†ä½ˆå±€ï¼šä¸Šæ–¹ç‚ºé¡Œç›®é¸é …ï¼Œä¸‹æ–¹é–å®šç‚ºè‡ªå®šç¾©æˆ°è¡“ç‰©å“æ¬„
    let html = `
        <div style="display: flex; flex-direction: column; height: 100%; min-height: 250px;">
            
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; border-bottom: 1px solid #444; padding-bottom: 8px;">
                <span style="font-size: 10px; color: #888; font-family: monospace; letter-spacing:1px;">FIELD: ${currentMapDifficulty}</span>
                <span style="font-size: 9px; color: #555;">TACTICAL_BELT_ACTIVE</span>
            </div>

            <div id="quiz-options-container" style="flex: 1; margin-bottom: 15px;">
                ${quiz.o.map((opt, i) => {
                    const fontSize = opt.length > 15 ? '13px' : '16px';
                    return `
                        <button onclick="handleBattleAction(${i})" 
                                style="display:block; width:100%; background:#000; color:#fff; border:1px solid #444; text-align:left; padding:12px; font-size:${fontSize}; cursor:pointer; margin-bottom: 8px; transition: 0.1s; border-radius: 8px;">
                            <span style="color: #f1c40f; margin-right: 8px;">â–¶</span> ${opt}
                        </button>
                    `;
                }).join('')}
            </div>

            <div style="border-top: 1px solid #333; padding-top: 12px; background: rgba(255,255,255,0.02); border-radius: 0 0 8px 8px; margin: 0 -12px -12px -12px; padding-bottom: 12px;">
                <div style="font-size: 9px; color: #444; text-align: center; margin-bottom: 8px; font-weight: bold; letter-spacing: 2px;">QUICK_USE_SLOTS</div>
                ${getSharedTacticalHTML(false)} 
            </div>
        </div>
    `;

    quizZone.innerHTML = html;

    // ğŸš€ ã€è¦–è¦ºå°æ­£ã€‘ç‰©ç†æ²å‹•å›é ‚éƒ¨ï¼Œç¢ºä¿é¸é …æ¸…æ™°
    quizZone.scrollTop = 0;
}


/**
 * ğŸ§¾ é¡¯ç¤ºè¡€è…¥å°å¸³å–® (ç‰©ç†å±¤ç´šåŠ å›ºï¼šæ–°å¢å‚³å¥‡æ‰è½èˆ‡ç´€éŒ„å°è¨˜)
 */
function showPokerLedger(winAmount, isRevolution = false, lootName = null) {
    const buyIn = 100; 
    const finalCoin = player.coin;
    
    // 1. ğŸ”¥ ã€ç‰©ç†é‹ç®—ã€‘æå–é€£èŠçå‹µæ•¸æ“š
    const currentStreak = player.kingStreak || 0;
    let streakBonus = 0;
    let baseLoot = winAmount;

    if (currentStreak > 1) {
        // åæ¨å…¬å¼ï¼šstreakBonus = (streak * 0.5) * base
        const bonusMultiplier = (currentStreak) * 0.5; 
        streakBonus = Math.floor(pokerGame.playerPot * bonusMultiplier);
        baseLoot = winAmount - streakBonus;
    }

    const netGain = winAmount - buyIn;

    // 2. ğŸ”¥ ã€ç‰©ç†æ›è¼‰é˜²ç¦¦ã€‘
    const existing = document.getElementById('poker-ledger');
    if (existing) existing.remove();

    const ledgerDiv = document.createElement('div');
    ledgerDiv.id = "poker-ledger";
    
    ledgerDiv.style = `
        position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
        width: 320px; background: #f4e4bc; border: 3px solid #8b4513;
        box-shadow: 0 0 0 100vw rgba(0,0,0,0.7), 0 15px 50px rgba(0,0,0,0.8), inset 0 0 30px rgba(139,69,19,0.2);
        padding: 30px; z-index: 150000; color: #4a2c16;
        font-family: 'serif', 'Noto Serif TC', serif; border-radius: 8px;
        animation: ledgerDrop 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        max-height: 90vh; overflow-y: auto;
    `;

    // 3. ç‰©ç†æ§‹å»ºå…§å®¹
    let ledgerHTML = `
        <div style="text-align:center; margin-bottom:20px; position:relative;">
            <div style="font-size:12px; color:#8b4513; letter-spacing:3px;">- OFFICIAL RECEIPT -</div>
            <h2 style="margin:5px 0; letter-spacing:2px; font-weight:900;">ğŸ“œ ç‹åœ‹ç¨…å‹™å­˜æ ¹</h2>
            <div style="font-size:10px; opacity:0.6; font-family:monospace;">STAMP: ${new Date().getTime().toString(16).toUpperCase()}</div>
            ${currentStreak === player.maxKingStreak && currentStreak > 1 ? 
                `<div style="position:absolute; top:20px; right:-10px; border:3px solid #c0392b; color:#c0392b; padding:2px 5px; font-weight:900; transform:rotate(15deg); border-radius:5px; animation: pulse 0.5s infinite;">ğŸ† NEW RECORD</div>` : ''}
        </div>
        
        <div style="display:flex; justify-content:space-between; padding:10px 0; border-bottom:1px dashed #8b4513;">
            <span>ğŸ”¹ å…¥å ´é–€ç¥¨ (Buy-in)</span>
            <span style="color:#c0392b; font-weight:bold; font-family:monospace;">- ${buyIn} G</span>
        </div>
        
        <div style="display:flex; justify-content:space-between; padding:10px 0; border-bottom:1px dashed #8b4513;">
            <span>ğŸ’° æˆ°å±€æ å¥ª (Basic)</span>
            <span style="color:#27ae60; font-weight:bold; font-family:monospace;">+ ${baseLoot} G</span>
        </div>
    `;

    // ğŸ”¥ ç‰©ç†ç´°ç›®ï¼šé€£èŠæ´¥è²¼ (é‡‘è‰²å€å¡Š)
    if (streakBonus > 0) {
        ledgerHTML += `
        <div style="display:flex; justify-content:space-between; padding:12px 10px; border-radius:4px; margin-top:5px; background:rgba(212,175,55,0.15); border:1px solid rgba(139,69,19,0.3);">
            <span style="font-weight:bold;">ğŸ”¥ é€£èŠæ´¥è²¼ (x${currentStreak})</span>
            <span style="color:#b7950b; font-weight:bold; font-family:monospace;">+ ${streakBonus} G</span>
        </div>`;
    }

    // ğŸ”¥ ç‰©ç†ç´°ç›®ï¼šå‚³å¥‡æ‰è½ (è–å…‰å€å¡Š)
    if (lootName) {
        ledgerHTML += `
        <div style="margin-top:10px; padding:15px; background:rgba(255,255,255,0.5); border:2px solid #f1c40f; border-radius:4px; text-align:center;">
            <div style="font-size:10px; color:#b7950b; font-weight:bold;">âœ¨ ç²å¾—å‚³å¥‡éºç‰© âœ¨</div>
            <b style="font-size:16px; color:#1a1a1a;">${lootName}</b>
        </div>`;
    }

    // ğŸ”¥ ç‰©ç†ç´°ç›®ï¼šé©å‘½ç´…åˆ©
    if (isRevolution) {
        ledgerHTML += `
        <div style="display:flex; justify-content:space-between; padding:12px 10px; border-radius:4px; margin-top:5px; background:rgba(192,57,43,0.15); border:1px solid #c0392b;">
            <span style="font-weight:bold;">ğŸ® é©å‘½çˆ†ç™¼ç´…åˆ©</span>
            <span style="color:#e67e22; font-weight:bold; font-family:monospace;">+ 50% åœ‹åº«</span>
        </div>`;
    }
    
    ledgerHTML += `
        <div style="margin-top:20px; text-align:right; border-top:2px solid #8b4513; padding-top:10px;">
            <small style="opacity:0.7;">æœ¬å±€æ·¨æç›Šï¼š</small>
            <span style="font-size:1.5em; font-weight:900; color:${netGain >= 0 ? '#27ae60' : '#c0392b'}; font-family:monospace;">
                ${netGain >= 0 ? '+' : ''}${netGain} G
            </span>
        </div>

        <div style="margin-top:25px; padding:15px; background:rgba(0,0,0,0.05); border:2px double #8b4513; border-radius:4px; text-align:center;">
            <small style="letter-spacing:1px;">çµç®—å¾Œç¸½è³‡ç”¢ (Total)</small><br>
            <b style="font-size:24px; color:#1a1a1a; font-family:monospace;">${finalCoin.toLocaleString()} G</b>
        </div>

        <button onclick="this.parentElement.remove(); resetGameLockAndStart();" style="width:100%; margin-top:25px; padding:15px; background:#4a2c16; color:#f4e4bc; border:none; cursor:pointer; font-weight:bold; border-radius:4px; font-size:18px; box-shadow: 0 4px 0 #2a180c; transition: 0.1s; letter-spacing:2px;">
            ğŸ–‹ï¸ ç°½ç½²å¥‘æ“šä¸¦é ˜å—éšç´š
        </button>
        <p style="text-align:center; font-size:9px; opacity:0.4; margin-top:10px;">ä¸€æ—¦ç°½ç½²ï¼Œéšç´šå‘½é‹å°‡ç‰©ç†æ€§é–å…¥æ™‚ç©º</p>
    `;

    ledgerDiv.innerHTML = ledgerHTML;
    document.body.appendChild(ledgerDiv);
    
    // ç‰©ç†éœ‡å‹•æ•ˆæ‡‰
    const table = document.getElementById('poker-table');
    if (table) table.style.animation = "dqShake 0.3s ease";
}

function closeLedger() {
    const ledger = document.getElementById('poker-ledger');
    if (ledger) {
        ledger.style.opacity = '0';
        ledger.style.transform = 'translate(-50%, -60%)'; // å‘ä¸Šç‰©ç†é£„å‹•
        setTimeout(() => ledger.remove(), 300);
    }
}

/**
 * âš”ï¸ è™•ç†ç©å®¶æˆ°é¬¥é¸æ“‡ (V4 ç‰©ç†å¹³è¡¡åŠ å›ºç‰ˆ)
 * ä¿®æ­£é»ï¼š
 * 1. æ•¸å€¼é€£å‹•ï¼šç§»é™¤ç¡¬ç·¨ç¢¼ 34ï¼Œæ”¹ç‚ºé€£å‹•è§’è‰²ç­‰ç´šèˆ‡è£å‚™ç¸½åˆæ”»æ“ŠåŠ›ã€‚
 * 2. ç‹€æ…‹æ„ŸçŸ¥ï¼šèµ·åºŠæ°£ (Grumpy) ç¾åœ¨æœƒç‰©ç†æ€§åœ°ä½¿æœ€çµ‚å‚·å®³ç¿»å€ (x2)ã€‚
 * 3. æ¬Šé™é˜²ç¦¦ï¼šç¢ºä¿åœ¨æ‰€æœ‰é‚è¼¯å‡ºå£ï¼ˆå«ç•°å¸¸ä¸­æ–·ï¼‰çš†èƒ½å›æ”¶ pointerEventsã€‚
 */
async function handleBattleAction(selectedIndex) {
    // 1. ğŸ”¥ ã€ç‰©ç†å¿«ç…§ã€‘è¨˜éŒ„é»æ“Šç¬é–“çš„æˆ°é¬¥ IDï¼Œé˜²æ­¢è·¨å±€é‚è¼¯æ±¡æŸ“
    const battleSnapshotId = window.currentBattleId;
    
    if (selectedIndex === 'potion') return await usePotionInBattle();

    const msgEl = document.getElementById('battle-msg');
    const monsterSprite = document.getElementById('battle-monster-sprite');
    const scene = document.getElementById('battle-scene');
    const quiz = battleData.currentQuiz;
    const quizZone = document.getElementById('battle-quiz-zone');

    // åŸºç¤å®‰å…¨æª¢æŸ¥
    if (!msgEl || !quiz || !scene || !quizZone) return;

    // 2. ğŸ”¥ ã€ç‰©ç†åŠ é–ã€‘é˜²æ­¢ç•°æ­¥æœŸé–“é‡è¤‡è§¸ç™¼
    quizZone.style.pointerEvents = 'none';

    const isCorrect = selectedIndex === quiz.a;

    try {
        if (isCorrect) {
            // --- ğŸŸ¢ æ­£ç¢ºï¼šåŸ·è¡Œç‰©ç†å‚·å®³æ¼”ç®— ---
            
            // A. æ“·å–ç‰©ç†æŒ‡æ¨™ï¼šå–å¾—ç­‰ç´šèˆ‡è£å‚™åŠ ç¸½æ•¸æ“š [cite: 2026-02-06]
            const stats = getFinalBattleStats(); 
            const baseAtk = 30 + (player.lv * 2); // éš¨ç­‰ç´šæˆé•·çš„åŸºç¤åŠ›
            
            // B. è¨ˆç®—æœ€çµ‚å‚·å®³å€¼
            let heroDmg = baseAtk + stats.totalAtk;

            // C. ç‰©ç†ç‹€æ…‹åŠ å£“ï¼šèµ·åºŠæ°£åˆ¤å®š (40% æ©Ÿç‡çˆ†ç™¼ x2 å‚·å®³)
            let isCrit = false;
            if (player.tempStatus === "grumpy" && Math.random() < 0.4) {
                heroDmg *= 2;
                isCrit = true;
            }

            // D. è¦–è¦ºæ¸²æŸ“èˆ‡æ—¥èªŒå¯«å…¥
            msgEl.innerHTML = `<span style="color:#2ecc71; font-weight:bold;">${isCrit ? 'ğŸ’¥ èµ·åºŠæ°£çˆ†æ“Šï¼ï¼' : 'âœ¨ æ­£ç¢ºï¼'}</span><br>å‹‡è€…ç™¼å‹•å¼·åŠ›ä¸€æ“Šï¼Œé€ æˆ ${heroDmg} é»å‚·å®³ï¼`;
            
            addBattleLog(`âš”ï¸ å‹‡è€…æ–½å±•æŠ€èƒ½ï¼Œå°é­”ç‰©ç‰©ç†æè¡€ <b style="color:#2ecc71;">${heroDmg}</b> é»ã€‚`);

            if (monsterSprite) {
                monsterSprite.style.animation = "none";
                void monsterSprite.offsetWidth; // ç‰©ç†é‡ç¹ªè§¸ç™¼éœ‡å‹•
                monsterSprite.style.animation = "screenShake 0.2s";
            }
            
            // åŸ·è¡Œç‰©ç†æ‰£é™¤
            battleData.monsterHP -= heroDmg;
            updateBattleUI();
            await sleep(1000); 

        } else {
            // --- ğŸ”´ éŒ¯èª¤ï¼šåŸ·è¡Œæ‡²ç½°æ¼”ç®— (ä¿æŒåŸæ¯”ä¾‹ç¸®æ”¾) ---
            const diffMultipliers = { "N5": 1, "N4": 1.5, "N3": 2.5, "N2": 4, "N1": 8, "N0": 12 };
            const scale = diffMultipliers[currentMapDifficulty] || 1;
            
            let finalDamage = Math.floor(15 * scale);
            if (player.tempStatus === "grumpy") finalDamage = Math.floor(finalDamage * 1.2);
            if (player.tempStatus === "dizzy") finalDamage = Math.floor(finalDamage * 2.0);
            if (player.isPraying) finalDamage = Math.floor(finalDamage * 0.5);
            
            battleData.heroHP -= finalDamage;
            // ç‰©ç†æ‰£é™¤ç”Ÿå‘½å€¼ä¸¦åŒæ­¥ Diablo ç”Ÿå‘½çƒ
            player.currentHp = Math.max(0, player.currentHp - (finalDamage * (player.maxHp / 100)));
            updateBattleUI();

            const correctAnswerText = quiz.o[quiz.a];
            msgEl.innerHTML = `
                <span style="color:#e74c3c; font-weight:bold;">âŒ éŒ¯èª¤ï¼å—åˆ°äº† ${finalDamage} é»å‚·å®³</span>
                <div style="font-size:14px; margin-top:8px; border-top:1px solid #444; padding-top:8px; line-height:1.5; color:#eee;">
                    <b style="color:#f1c40f;">æ­£ç¢ºç­”æ¡ˆï¼š${correctAnswerText}</b><br>
                    <span style="color:#aaa;">ğŸ’¡ è§£æï¼š${quiz.explain || 'è€ƒé©—ç•¶å‰ç­‰ç´šæ ¸å¿ƒæ¦‚å¿µ'}</span>
                </div>
            `;

            scene.classList.add('battle-shake');
            await sleep(3500); 
            scene.classList.remove('battle-shake');
        }

        // --- âš–ï¸ ç‰©ç†ç”Ÿå‘½é€±æœŸé˜²ç¦¦ ---
        if (window.currentBattleId !== battleSnapshotId || !battleData.isBattleActive) {
            quizZone.style.pointerEvents = 'auto'; // é‡‹æ”¾æ¬Šé™
            return; 
        }

        // 3. ç‰©ç†çµ‚å±€åˆ¤å®š
        if (battleData.monsterHP <= 0) {
            msgEl.innerText = "âœ¨ é­”ç‰©ç°é£›ç…™æ»…äº†ï¼";
            await sleep(800);
            if (window.currentBattleId === battleSnapshotId) await finishBattle(true);
        } else if (battleData.heroHP <= 0 || player.currentHp <= 0) {
            msgEl.innerText = "ğŸ’€ å‹‡è€…åŠ›ç›¡å€’ä¸‹...";
            await sleep(1000);
            if (window.currentBattleId === battleSnapshotId) await finishBattle(false);
        } else {
            // 4. æ¢å¾©äº¤äº’æ¬Šé™ä¸¦æŠ½å–ä¸‹ä¸€é¡Œ
            quizZone.style.pointerEvents = 'auto';
            const nextPool = (window.currentExamPool && window.currentExamPool.length > 0)
                             ? window.currentExamPool 
                             : getStarterPack(currentMapDifficulty).exam;
            nextBattleTurn(nextPool);
        }

    } catch (criticalErr) {
        console.error("ğŸš¨ æˆ°é¬¥é‚è¼¯ç‰©ç†å´©æ½°:", criticalErr);
        quizZone.style.pointerEvents = 'auto'; // ç·Šæ€¥é‡‹æ”¾æ¬Šé™
        if (typeof finishBattle === 'function') finishBattle(false);
    }
}

// --- æˆ°é¬¥ä¸­ç·Šæ€¥è£œè¡€ ---
async function usePotionInBattle() {
    const msgEl = document.getElementById('battle-msg');
    player.items = player.items || { potion: 0 };

    if (player.items.potion > 0) {
        player.items.potion--; // ç‰©ç†æ¶ˆè€—
        battleData.heroHP = Math.min(100, battleData.heroHP + 50); // æ¢å¾© 50 é»
        
        msgEl.innerText = "å‹‡è€…é£²ç”¨äº†è£œè¡€è—¥æ°´ï¼Œæ¢å¾©äº† 50 é» HPï¼";
        updateBattleUI();
        updatePlayerUI(); // åŒæ­¥æ›´æ–°èƒŒåŒ…æ•¸é‡
        
        await sleep(1200);
        // è£œè¡€å¾Œç›´æ¥é€²å…¥æ€ªç‰©çš„ä¸‹ä¸€é¡Œï¼Œä¸è·³éå›åˆ
        const nextPool = window.currentExamPool || getStarterPack(currentMapDifficulty).exam;
        nextBattleTurn(nextPool);
    } else {
        msgEl.innerText = "è—¥æ°´å·²ç”¨ç›¡ï¼ç„¡æ³•æ¢å¾©ï¼";
        await sleep(1000);
        const nextPool = window.currentExamPool || getStarterPack(currentMapDifficulty).exam;
        nextBattleTurn(nextPool);
    }
}

/**
 * ğŸ’¸ ç‰©ç†åŸ·è¡Œå¾µç¨…å‹•ç•«
 * @param {string} fromId è¼¸å®¶ DOM ID (ä¾‹å¦‚: 'pos-top')
 * @param {string} toId   è´å®¶ DOM ID
 * @param {number} count  é£›è¡Œå¼µæ•¸
 */
async function animateTaxExchange(fromId, toId, count) {
    const fromEl = document.getElementById(fromId);
    const toEl = document.getElementById(toId);
    if (!fromEl || !toEl) return;

    const fromRect = fromEl.getBoundingClientRect();
    const toRect = toEl.getBoundingClientRect();

    for (let i = 0; i < count; i++) {
        // 1. ç‰©ç†å‰µå»ºé£›è¡Œå¡ç‰‡
        const flyer = document.createElement('div');
        flyer.className = 'flying-tax-card';
        flyer.innerText = "ğŸ´";
        flyer.style.left = `${fromRect.left + 20}px`;
        flyer.style.top = `${fromRect.top + 20}px`;
        document.body.appendChild(flyer);

        // 2. ç‰©ç†å•Ÿå‹•é£›è¡Œ (éåŒæ­¥åç§»)
        setTimeout(() => {
            flyer.style.left = `${toRect.left + 20}px`;
            flyer.style.top = `${toRect.top + 20}px`;
            flyer.style.transform = `rotate(${Math.random() * 360}deg) scale(1.2)`;
        }, 50 * i); // å¾®å°é–“éš”ç”¢ç”Ÿé€£ç™¼æ„Ÿ

        // 3. æŠµé”å¾Œçš„ç‰©ç†æ¸…ç†èˆ‡ç‰¹æ•ˆ
        setTimeout(() => {
            toEl.classList.add('looting-active');
            flyer.remove();
            setTimeout(() => toEl.classList.remove('looting-active'), 500);
        }, 800 + (50 * i));
    }
    
    // ç­‰å¾…æ‰€æœ‰å¡ç‰‡é£›å®Œ
    await new Promise(r => setTimeout(r, 1000 + (count * 50)));
}

// --- ğŸ•µï¸ ç•°ç•Œèˆ‡çµ‚æ¥µåœ°åœ–è§£é–å¼•æ“ ---
function checkHiddenMapUnlocks() {
    const difficulties = ["N5", "N4", "N3", "N2", "N1"];
    let legendaryCount = 0;

    difficulties.forEach(diff => {
        const count = (player.mapProgress && player.mapProgress[diff]) ? player.mapProgress[diff] : 0;
        
        // 1. ç‰©ç†é–‹å•Ÿ EX ç•°ç•Œï¼šä½”é ˜é” 50 è™•
        const exBtn = document.getElementById(`btn-${diff}-EX`);
        if (exBtn) {
            exBtn.style.display = (count >= 50) ? "flex" : "none";
        }

        // çµ±è¨ˆå‚³å¥‡æ¨™ç« æ•¸é‡
        if (count >= 100) legendaryCount++;
    });

    // 2. ç‰©ç†é–‹å•Ÿ N0 çœ¾ç¥éºå€ï¼šæ“æœ‰ 3 å€‹ä»¥ä¸Šçš„å‚³å¥‡æ¨™ç« 
    const n0Btn = document.getElementById('btn-N0');
    if (n0Btn) {
        if (legendaryCount >= 3) {
            if (n0Btn.style.display === "none") {
                showNotification("ğŸŒŒ ç©ºé–“ç”¢ç”Ÿéœ‡å‹•...ã€N0 çœ¾ç¥éºå€ã€‘å·²ç¾ä¸–ï¼");
            }
            n0Btn.style.display = "flex";
        } else {
            n0Btn.style.display = "none";
        }
    }
}

// --- âš”ï¸ æˆ°é¬¥ä»‹é¢å³æ™‚åŒæ­¥ (å«å±¬æ€§åˆ¤å®šã€æ•µäººæ”»æ“Šèˆ‡è£å‚™é˜²ç¦¦ä¿®æ­£) ---
function updateBattleUI() {
    // 1. å–å¾—æˆ°é¬¥èˆ‡ç‰¹æ•ˆå…ƒä»¶
    const heroValEl = document.getElementById('hero-hp-val');
    const heroBarEl = document.getElementById('hero-hp-bar'); 
    const monsterBarEl = document.getElementById('monster-hp-bar');
    const monsterValEl = document.getElementById('monster-hp-val'); // æ–°å¢ï¼šé¡¯ç¤ºæ€ªç‰©æ•¸å€¼
    const dangerOverlay = document.getElementById('danger-overlay');

    // 2. ç‰©ç†æ•¸æ“šæ ¼å¼åŒ–ï¼šå¾æˆ°é¬¥æ•¸æ“šå–å¾—ç•¶å‰è¡€é‡
    // é€™è£¡æ”¹ç”¨ player.currentHp ç›´æ¥æ˜ å°„ï¼Œå› ç‚ºè£å‚™é˜²ç¦¦æœƒç›´æ¥å½±éŸ¿é€™å€‹æ•¸å€¼
    const currentHeroHP = Math.max(0, player.currentHp);
    const heroMaxHP = player.maxHp || 100;
    const heroPercent = (currentHeroHP / heroMaxHP) * 100;

    const currentMonsterHP = Math.max(0, battleData.monsterHP);
    const monsterMaxHP = battleData.monsterMaxHP || 100;
    const monsterPercent = (currentMonsterHP / monsterMaxHP) * 100;

    // 3. æ¸²æŸ“æˆ°é¬¥ä»‹é¢ (å‹‡è€…ç«¯)
    if (heroValEl) heroValEl.innerText = `${currentHeroHP} / ${heroMaxHP}`;
    
    if (heroBarEl) {
        heroBarEl.style.width = heroPercent + "%";
        // ğŸ©¸ ç‰©ç†è­¦ç¤ºè‰²ï¼š30% ä»¥ä¸‹é€²å…¥ç´…è¡€ï¼ˆç€•æ­»ï¼‰
        heroBarEl.style.backgroundColor = heroPercent <= 30 ? "#ff0000" : "#2ecc71";
    }

    // 4. æ¸²æŸ“æˆ°é¬¥ä»‹é¢ (æ€ªç‰©ç«¯)
    if (monsterValEl) monsterValEl.innerText = `${currentMonsterHP} / ${monsterMaxHP}`;
    if (monsterBarEl) {
        monsterBarEl.style.width = monsterPercent + "%";
        // ğŸ”¥ æ ¹æ“šæ€ªç‰©å±¬æ€§æ”¹è®Šè¡€æ¢é¡è‰² (è¦–è¦ºæç¤º)
        monsterBarEl.style.backgroundColor = getEnemyElementColor(battleData.currentEnemyAppearance);
    }

    // 5. ğŸ”¥ ã€ç€•æ­»ç´…é–ƒç‰©ç†é€£å‹•ã€‘
    if (dangerOverlay) {
        if (heroPercent <= 20 && currentHeroHP > 0 && battleData.isBattleActive) {
            if (!dangerOverlay.classList.contains('danger-active')) {
                dangerOverlay.classList.add('danger-active');
            }
        } else {
            dangerOverlay.classList.remove('danger-active');
        }
    }

    // 6. ğŸ”¥ ã€è£å‚™åŠŸç”¨æ˜ å°„ã€‘
    // è‹¥è£å‚™æœ‰é˜²ç¦¦åŠ æˆï¼ŒåŒæ­¥æ›´æ–°ä»‹é¢ä¸Šçš„é˜²ç¦¦åœ–ç¤º (å¦‚æœæœ‰é ç•™ä½ç½®)
    const defEl = document.getElementById('battle-hero-def');
    if (defEl) defEl.innerText = `ğŸ›¡ï¸ ${player.equips?.armor?.def || 0}`;

    // 7. ç‰©ç†åŒæ­¥è‡³ä¸» UI
    if (typeof updatePlayerUI === 'function') {
        updatePlayerUI();
    }
}

// è¼”åŠ©ï¼šæ ¹æ“šæ€ªç‰©åœ–æ¨™åˆ¤å®šè¡€æ¢é¡è‰²ï¼Œæç¤ºç©å®¶è©²ç”¨ä»€éº¼å±¬æ€§
function getEnemyElementColor(appearance) {
    const fireIcons = ["ğŸ”¥", "ğŸ‘¹", "ğŸ²"];
    const iceIcons = ["â„ï¸", "ğŸ§Š", "ğŸ¦"];
    if (fireIcons.includes(appearance)) return "#e74c3c"; // ç«å±¬æ€§
    if (iceIcons.includes(appearance)) return "#3498db"; // å†°å±¬æ€§
    return "#95a5a6"; // ä¸€èˆ¬/ç„¡å±¬æ€§
}

// --- ç‰©ç†æ”»æ“Šå¼•æ“ï¼šæ•µäººè¡Œå‹•èˆ‡è£å‚™æŠµéŠ· ---
function performEnemyAttack() {
    if (!battleData.isBattleActive) return;

    // 1. è¨ˆç®—åŸå§‹å‚·å®³
    const baseAtk = { "N5": 5, "N4": 15, "N3": 30, "N2": 60, "N1": 100, "N0": 200 }[currentMapDifficulty] || 10;
    
    // 2. ç‰©ç†é˜²ç¦¦æŠµæ¶ˆ (è£å‚™çš„æ ¸å¿ƒåŠŸç”¨)
    const armorDef = player.equips?.armor?.def || 0;
    const finalDamage = Math.max(1, baseAtk - armorDef);

    // 3. ç‰©ç†æ‰£é™¤
    player.currentHp -= finalDamage;
    showNotification(`ğŸ’¢ é­”ç‰©æ”»æ“Šï¼å—åˆ°äº† ${finalDamage} é»å‚·å®³ï¼`);

    // 4. æ›´æ–°ä»‹é¢
    updateBattleUI();

    // 5. åˆ¤å®šå‹‡è€…å€’ä¸‹
    if (player.currentHp <= 0) {
        player.currentHp = 0;
        finishBattle(false); 
    }
}

async function expandStarterPacks() {
    const packs = [
        {
            name: "ğŸŒ± æ–°æ‰‹è‰åŸ (N5)", difficulty: "N5",
            exam: [
                { q: "ã€ŒçŒ«ã€çš„è®€éŸ³æ˜¯ï¼Ÿ", o: ["ã„ã¬", "ã­ã“", "ã¨ã‚Š", "ã•ã‹ãª"], a: 1 },
                { q: "ã€ŒãŠã¯ã‚ˆã†ã€çš„æ„æ€æ˜¯ï¼Ÿ", o: ["ä½ å¥½", "æ—©å®‰", "æ™šå®‰", "è¬è¬"], a: 1 },
                { q: "ã€Œé£Ÿã¹ã‚‹ã€çš„è®€éŸ³æ˜¯ï¼Ÿ", o: ["ãŸã¹ã‚‹", "ã®ã‚ã‚‹", "ã„ãã‚‹", "ãã‚‹"], a: 0 }
            ]
        },
        {
            name: "ğŸŒ² è¿·éœ§æ£®æ— (N4)", difficulty: "N4",
            exam: [
                { q: "ã€Œå‹‰å¼·ã—ã¾ã™ã€çš„éå»å¼ï¼Ÿ", o: ["å‹‰å¼·ã—ãŸ", "å‹‰å¼·ã—ã¾ã—ãŸ", "å‹‰å¼·ã—ã¾ã™ãŸ", "å‹‰å¼·ã—ã¦"], a: 1 },
                { q: "ã€Œï½ã‚ˆã‚Šï½ã»ã†ãŒï½ã€ç”¨æ–¼ï¼Ÿ", o: ["åŸå› ", "æ¯”è¼ƒ", "æ™‚é–“", "ç›®çš„"], a: 1 }
            ]
        },
        {
            name: "â›°ï¸ å·¨äººä¹‹å³° (N3)", difficulty: "N3",
            exam: [
                { q: "ã€Œè¤‡é›‘ã€çš„è®€éŸ³ï¼Ÿ", o: ["ãµãã•ã¤", "ãµãã–ã¤", "ã¶ãã•ã¤", "ãµãã—ã‚ƒã¤"], a: 1 },
                { q: "ã€Œï½ãŸã¨ãŸã‚“ã€çš„æ„æ€æ˜¯ï¼Ÿ", o: ["å‰›...å°±...", "ä¸€é‚Š...ä¸€é‚Š", "å³ä½¿...", "å› ç‚º..."], a: 0 }
            ]
        },
        {
            name: "ğŸ¯ å‡œå†¬è¦å¡ (N2)", difficulty: "N2",
            exam: [
                { q: "ã€Œæ·±åˆ»ã€çš„è®€éŸ³ï¼Ÿ", o: ["ã—ã‚“ã“ã", "ã—ã‚“ã”ã", "ã˜ã‚“ã“ã", "ã—ã‚“ã‹ã£ã“"], a: 0 },
                { q: "ã€Œï½ã–ã‚‹ã‚’å¾—ãªã„ã€çš„æ„æ€ï¼Ÿ", o: ["ä¸å¾—ä¸", "æ²’å¿…è¦", "åšä¸åˆ°", "å¾ˆæƒ³åš"], a: 0 }
            ]
        },
        {
            name: "ğŸ”¥ ç†¾ç‚é­”åŸ (N1)", difficulty: "N1",
            exam: [
                { q: "ã€ŒåŸ·æ‹—ã€çš„è®€éŸ³ï¼Ÿ", o: ["ã—ã¤ã‚ˆã†", "ã—ã‚…ã†ã‚ˆã†", "ã˜ã‚…ã†ã‚ˆã†", "ã—ã¤ã‚†ã†"], a: 0 },
                { q: "ã€Œï½æ¥µã¾ã‚Šãªã„ã€çš„æ„æ€ï¼Ÿ", o: ["æ¥µå…¶...", "ä¸æ€éº¼...", "æ²’è¾¦æ³•...", "é›–ç„¶..."], a: 0 }
            ]
        }
    ];

    for (const p of packs) {
        const exists = await db.fuelPacks.where('difficulty').equals(p.difficulty).count();
        if (exists === 0) {
            await db.fuelPacks.add(p);
            console.log(`âœ… å·²ç‰©ç†å¡«å…… ${p.difficulty} åŸºç¤é¡Œåº«`);
        }
    }
}

// --- ğŸŒ é ç«¯é¡Œåº«ç‰©ç†åŒæ­¥æ ¸å¿ƒ (ä¿®æ­£å¤§å°å¯«èˆ‡æ€ªç‰©æ¨™è¨˜) ---
async function syncRemoteExams(difficulty) {
    // ç‰©ç†ä¿®æ­£ï¼šGitHub è·¯å¾‘é€šå¸¸å€åˆ†å¤§å°å¯«ï¼Œå°‡é›£åº¦å¼·åˆ¶è½‰ç‚ºå¤§å¯«ä»¥åŒ¹é…é ç«¯æª”å
    const diffTag = difficulty.toUpperCase(); 
    const baseUrl = "https://cdn.jsdelivr.net/gh/LibreJLPT/data/jlpt/";
    const targetUrl = `${baseUrl}${diffTag}.json`; 

    try {
        console.log(`ğŸ“¡ æ­£åœ¨å¾ GitHub åŒæ­¥ ${diffTag} ç´šé¡Œåº«...`);
        
        const response = await fetch(targetUrl);
        if (!response.ok) throw new Error(`ç¶²è·¯è«‹æ±‚å¤±æ•— (Status: ${response.status})`);
        
        const rawData = await response.json();
        
        // ç‰©ç†æ ¼å¼è½‰æ›
        const newPack = {
            name: `ğŸŒ é›²ç«¯ï¼š${diffTag} ç´šç²¾é¸é¡Œåº«`,
            difficulty: diffTag,
            monsterType: "phantom", // ğŸ”¥ åŠ å…¥å¹»å½±æ¨™è¨˜ï¼šç¢ºä¿æˆ°å‹å¾Œè§¸ç™¼ç´«è‰²ç‰¹æ•ˆ
            notes: "åŒæ­¥è‡ª GitHub é–‹æºé¡Œåº«",
            exam: rawData.map(item => ({
                q: item.question,
                o: item.options,
                a: item.answer_index
            }))
        };

        // ç‰©ç†å­˜å…¥æœ¬åœ°è³‡æ–™åº«
        await db.fuelPacks.add(newPack);
        
        // æª¢æŸ¥ showNotification æ˜¯å¦å­˜åœ¨å†å‘¼å«ï¼Œé˜²æ­¢å ±éŒ¯
        if (typeof showNotification === 'function') {
            showNotification(`âœ¨ åŒæ­¥æˆåŠŸï¼${diffTag} å€å·²æ–°å¢é ç«¯é¡Œåº«ã€‚`);
        }
        
        return newPack;

    } catch (e) {
        console.warn(`ğŸŒ é ç«¯åŒæ­¥å¤±æ•— (${targetUrl})ï¼Œå•Ÿå‹•å‹•æ…‹ä¿åº•ï¼š`, e);
        // å¦‚æœé ç«¯çœŸçš„æ²’æª”æ¡ˆï¼Œç‰©ç†å‘¼å«æœ¬åœ°ç”Ÿæˆå™¨
        return typeof generateDynamicExam === 'function' ? generateDynamicExam(difficulty) : null;
    }
}

// --- ğŸ¤– ç‰©ç†è‡ªå‹•ç”Ÿæˆå™¨ï¼šå¤šæ¨£åŒ–é¡Œå‹ç‰ˆ ---
function generateDynamicExam(difficulty) {
    const typePool = ['vocab', 'grammar', 'particle', 'tense'];
    const selectedType = typePool[Math.floor(Math.random() * typePool.length)];
    
    // 1. ç‰©ç†æ•¸æ“šåº«ï¼šé‡å°ä¸åŒé¡Œå‹æº–å‚™ç´ æ
    const resources = {
        N5: {
            vocab: [["æ°´", "ã¿ãš"], ["ç«", "ã²"], ["æœˆ", "ã¤ã"]],
            grammar: [["ï½ã¦ãã ã•ã„", "è«‹..."], ["ï½ã¾ã—ã‚‡ã†", "è®“æˆ‘å€‘..."]],
            particle: [["ç§ã¯å­¦ç”Ÿ__ã§ã™ã€‚", "ã¯", "ãŒ", "ã‚’", "ã«", 0]],
            tense: [["é£Ÿã¹ã¾ã™ï¼ˆéå»å¼ï¼‰", "é£Ÿã¹ã¾ã—ãŸ", "é£Ÿã¹ã‚‹", "é£Ÿã¹ãŸ", "é£Ÿã¹ã¾ã™ãŸ", 0]]
        },
        N4: {
            vocab: [["æº–å‚™", "ã˜ã‚…ã‚“ã³"], ["å ±å‘Š", "ã»ã†ã“ã"]],
            particle: [["æ—¥æœ¬__è¡Œãã¾ã™ã€‚", "ã¸", "ã‚’", "ãŒ", "ã¯", 0]],
            tense: [["è¦‹ã¾ã™ï¼ˆå¯èƒ½å‹•è©ï¼‰", "è¦‹ã‚‰ã‚Œã¾ã™", "è¦‹ãˆã¾ã™", "è¦‹ã¾ã™", "è¦‹ã•ã›ã¾ã™", 0]]
        }
    };

    const res = resources[difficulty] || resources["N5"];
    let quizData = { q: "", o: [], a: 0 };

    // 2. ç‰©ç†ç”Ÿæˆé‚è¼¯åˆ†æ”¯
    switch(selectedType) {
        case 'vocab': // å–®å­—è®€éŸ³
            const word = res.vocab[Math.floor(Math.random() * res.vocab.length)];
            quizData.q = `è«‹å•ã€Œ${word[0]}ã€çš„è®€éŸ³æ˜¯ï¼Ÿ`;
            quizData.o = shuffleArray([word[1], "ã¬ã“", "ãã­", "ã¯ãª"]);
            quizData.a = quizData.o.indexOf(word[1]);
            break;
        
        case 'particle': // åŠ©è©é™·é˜±
            const p = res.particle[Math.floor(Math.random() * res.particle.length)];
            quizData.q = `å¡«å…¥æ­£ç¢ºåŠ©è©ï¼š${p[0]}`;
            quizData.o = [p[1], p[2], p[3], p[4]];
            quizData.a = p[5];
            break;

        case 'tense': // æ™‚æ…‹è®Šæ›
            const t = res.tense[Math.floor(Math.random() * res.tense.length)];
            quizData.q = `å‹•è©è®Šå½¢ç¢ºèªï¼š${t[0]}`;
            quizData.o = [t[1], t[2], t[3], t[4]];
            quizData.a = t[5];
            break;
            
        default: // æ–‡æ³•
            const g = res.grammar[Math.floor(Math.random() * res.grammar.length)];
            quizData.q = `è«‹å•ã€Œ${g[0]}ã€çš„æ„æ€æ˜¯ï¼Ÿ`;
            quizData.o = shuffleArray([g[1], "ç¦æ­¢...", "æ­£åœ¨...", "å› ç‚º..."]);
            quizData.a = quizData.o.indexOf(g[1]);
    }

    // ç‰©ç†éš¨æ©Ÿæ€ªç‰©åç¨±
    const monsters = { vocab: "èªå½™æ€ª", particle: "åŠ©è©éˆ", tense: "æ™‚æ…‹é­”", grammar: "æ–‡æ³•é¬¼" };

    return {
        name: `ğŸ‘¾ ${difficulty} ${monsters[selectedType]}`,
        difficulty: difficulty,
        exam: [quizData]
    };
}

// è¼”åŠ©ï¼šç‰©ç†æ‰“äº‚é™£åˆ—
function shuffleArray(array) {
    return array.sort(() => Math.random() - 0.5);
}

// --- â›ª æ•™å ‚å¥‡è¹Ÿï¼šå¹»å½±ä¹‹å¡µå…Œæ›ç³»çµ± ---
// --- â›ª æ•™å ‚å¥‡è¹Ÿï¼šå¹»å½±ä¹‹å¡µå…Œæ›ç³»çµ± (è³‡æ–™åº«å°é½Šç‰ˆ) ---
function exchangeAtChurch() {
    // 1. ç‰©ç†æ¶ˆè€—
    player.phantomDust -= 10;
    
    // 2. å¾è³‡æ–™åº«æŒ‡å®š ID æŠ½å– (ç¢ºä¿åç¨±çµ•å°æ­£ç¢º)
    const rewards = [
        MASTER_COLLECTION.find(i => i.id === "misc_wood_sword"), // æ­¦å™¨
        MASTER_COLLECTION.find(i => i.id === "misc_old_shield"), // å‰¯æ‰‹
        MASTER_COLLECTION.find(i => i.id === "misc_apple")       // ç‰¹æ®Šé“å…·
    ].filter(i => i); // éæ¿¾æ‰å¯èƒ½çš„ undefined

    const gift = rewards[Math.floor(Math.random() * rewards.length)];
    
    // 3. ç‰©ç†æ•ˆæœå¯¦è£
    if (gift.id === "misc_apple") {
        // ç”Ÿå‘½ä¹‹æœï¼šæ°¸ä¹…æå‡æœ€å¤§è¡€é‡ 20 é»
        player.maxHp += 20;
        player.currentHp = player.maxHp; 
        showNotification(`â›ª æ•™å ‚å¥‡è¹Ÿï¼é£Ÿç”¨ã€${gift.name}ã€‘ï¼Œæœ€å¤§ HP æ°¸ä¹…æå‡ï¼`);
    } else {
        // è£å‚™é¡ï¼šç›´æ¥æ”¾å…¥èƒŒåŒ…
        player.inventory.push(gift.name);
        if (!player.collection.includes(gift.id)) player.collection.push(gift.id);
        
        showNotification(`â›ª æ•™å ‚å¥‡è¹Ÿï¼ç²å¾—äº†è£å‚™ï¼šã€${gift.name}ã€‘ï¼`);
    }

    // 4. åŒæ­¥è³‡æ–™åº«èˆ‡ UI
    savePlayerToDB();
    updatePlayerUI();
    
    // åˆ·æ–°åœ°åœ–ä¸Šçš„æ•¸å­—é¡¯ç¤º
    renderAdventureMap();
}


/**
 * ğŸ  å‹‡è€…çš„å®¶ï¼šå…§éƒ¨äº’å‹•æ ¸å¿ƒ (åäººå ‚èˆ‡è¨­æ–½è¯å‹•ä¿®æ­£ç‰ˆ)
 */
async function handleHomeAction(type) {
    if (currentMapDifficulty !== "Home") return;

    player.vault = player.vault || [];
    player.vaultGold = player.vaultGold || 0;

    switch (type) {
        case 'bed':
            // 1. ç‰©ç†é–å®šï¼šè¨­å®šä¼‘æ¯ç‹€æ…‹
            player.isResting = true;
            
            const heroBody = document.getElementById('hero-body');
            if (heroBody) {
                heroBody.innerText = "ğŸ’¤";
                showNotification("ğŸ’¤ å‹‡è€…é€²å…¥æ·±åº¦ç¡çœ ... é«”åŠ›ç‰©ç†æ¢å¾©ä¸­ï¼");
                
                // æ¢å¾©è¡€é‡å…¬å¼æ ¡æº–
                const healPercent = (player.homeUpgrades?.bed || 1) * 0.3 + 0.1;
                player.currentHp = Math.min(player.maxHp, player.currentHp + Math.floor(player.maxHp * healPercent));
                
                updatePlayerUI(); 

                // 2. æ¸…é™¤èˆŠçš„ç¡é†’è¨ˆæ™‚å™¨
                if (window.bedTimer) clearTimeout(window.bedTimer);

                window.bedTimer = setTimeout(() => {
                    player.isResting = false;
                    if (currentMapDifficulty === "Home" && heroBody) {
                        // æ ¹æ“šç­‰ç´šæ¢å¾©ç‰©ç†å½¢è±¡
                        heroBody.innerText = (player.lv >= 40) ? "ğŸ§™â€â™‚ï¸" : (player.lv >= 20 ? "âš”ï¸" : "ğŸš¶");
                        showNotification("â˜€ï¸ é†’ä¾†äº†ï¼é«”åŠ›å·²ç‰©ç†å……ç›ˆã€‚");
                    }
                    updatePlayerUI();
                }, 2000);
            }
            break;

        case 'bookshelf':
            // ğŸ”¥ ã€æ ¸å¿ƒä¿®æ­£ã€‘ç‰©ç†åˆ‡æ›ï¼šå¾è¤‡ç¿’æ”¹ç‚ºé–‹å•Ÿåäººå ‚
            if (typeof openHallOfFame === 'function') {
                showNotification("ğŸ“– æ­£åœ¨ç¿»é–±ã€Šç‹åœ‹è‹±é›„å‚³æ‰¿å²ã€‹...");
                openHallOfFame(); 
            } else {
                showNotification("âš ï¸ å²å†Šå°šæœªç‰©ç†æˆå‹... (å‡½å¼æœªå®šç¾©)");
            }
            break;

        case 'table':
            // é–‹å•Ÿç‰©ç†å‡ç´šé¸å–® (æ“šé»æ”¹é€ )
            if (typeof openUpgradeUI === 'function') openUpgradeUI();
            break;

        case 'storage':
            // é–‹å•Ÿçš‡å®¶ä¿éšªç®±
            if (typeof openVaultUI === 'function') openVaultUI();
            break;
    }
}

// --- ğŸ§³ ç‰©ç†åŠŸèƒ½ï¼šçš‡å®¶ä¿éšªç®±ä»‹é¢ ---
function openVaultUI() {
    // ç‰©ç†ç”Ÿæˆä¸€å€‹ç¨ç«‹çš„é»‘è‰²å¾©å¤å½ˆçª—
    const existing = document.getElementById('vault-modal');
    if (existing) existing.remove();

    const vaultWindow = document.createElement('div');
    vaultWindow.id = 'vault-modal';
    vaultWindow.style = `
        position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
        width: 280px; background: #000; border: 3px solid #fff; color: #fff;
        padding: 15px; z-index: 2000; font-family: 'Courier New', monospace;
        box-shadow: 0 0 20px rgba(0,0,0,0.8);
    `;

    // æ¸²æŸ“é‡‘å¹£èˆ‡å­˜æª”æ¸…å–®
    vaultWindow.innerHTML = `
        <div style="text-align:center; color:#f1c40f; margin-bottom:10px;">ğŸ§³ çš‡å®¶ä¿éšªç®±</div>
        <div style="font-size:12px; border:1px solid #333; padding:8px; margin-bottom:10px;">
            ğŸ’° éŠ€è¡Œå­˜æ¬¾: <span style="color:#f1c40f;">${player.vaultGold} G</span><br>
            ğŸ’ éš¨èº«é‡‘å¹£: <span style="color:#f1c40f;">${player.coin} G</span>
        </div>
        <div style="display:flex; gap:5px; margin-bottom:15px;">
            <button onclick="vaultAction('depositGold')" style="flex:1; font-size:10px;">å­˜ä¸€åŠ</button>
            <button onclick="vaultAction('withdrawGold')" style="flex:1; font-size:10px;">é ˜å…¨éƒ¨</button>
        </div>
        <div style="font-size:11px; color:#aaa; margin-bottom:5px;">è²´é‡ç‰©å“å¯„å­˜:</div>
        <div id="vault-items" style="max-height:80px; overflow-y:auto; background:#111; padding:5px; font-size:10px;">
            ${player.vault.length ? player.vault.map((item, i) => `<div>Â· ${item} <span onclick="vaultAction('get', ${i})" style="color:#f1c40f; cursor:pointer;">[å–å‡º]</span></div>`).join('') : 'ç›®å‰ç„¡å­˜æ”¾ç‰©å“'}
        </div>
        <button onclick="this.parentElement.remove()" style="width:100%; margin-top:15px; background:#444; color:#fff; border:none; padding:5px; cursor:pointer;">é›¢é–‹</button>
    `;
    document.body.appendChild(vaultWindow);
}

// --- âš™ï¸ ç‰©ç†æ“ä½œï¼šå­˜æ¬¾èˆ‡å–ç‰©é‚è¼¯ ---
function vaultAction(type, index) {
    if (type === 'depositGold') {
        const amount = Math.floor(player.coin / 2);
        player.coin -= amount;
        player.vaultGold += amount;
        showNotification(`ğŸ’° å­˜æ”¾äº† ${amount}Gï¼Œç¾åœ¨å¸³æˆ¶æ›´å®‰å…¨äº†ï¼`);
    } else if (type === 'withdrawGold') {
        player.coin += player.vaultGold;
        player.vaultGold = 0;
        showNotification("ğŸ’° é ˜å›äº†æ‰€æœ‰å­˜æ¬¾ï¼Œæº–å‚™å»å¤§æ¡è³¼ï¼");
    } else if (type === 'get') {
        const item = player.vault.splice(index, 1)[0];
        player.inventory.push(item);
        showNotification(`ğŸ“¦ å–å‡ºäº†ï¼š${item}`);
    }
    
    // ç‰©ç†åŒæ­¥
    savePlayerToDB();
    updatePlayerUI();
    openVaultUI(); // åˆ·æ–°ä¿éšªç®±è¦–çª—
}

function changeMap(mapId) {
    currentMapDifficulty = mapId;
    const hero = document.getElementById('hero-sprite');
    
    if (mapId === "Home") {
        // ç‰©ç†åˆ‡æ›èƒŒæ™¯ç‚ºæº«é¦¨çš„æˆ¿é–“é¡è‰²
        document.getElementById('adventure-screen').style.background = "linear-gradient(to bottom, #ffebcd 0%, #f5deb3 100%)";
        showNotification("ä½ å›åˆ°äº†æº«æš–çš„å®¶ï¼Œé€™è£¡éå¸¸å®‰å…¨ã€‚");
        // ç‰©ç†åœæ­¢é‡æ•µå®šæ™‚å™¨
        if (window.encounterTimer) {
            clearInterval(window.encounterTimer);
            window.encounterTimer = null;
        }
        hero.classList.remove('walking'); // å®¶è£¡å¯ä»¥åä¸‹ä¼‘æ¯
    } else {
        // é‡æ–°å•Ÿå‹•å†’éšªèƒŒæ™¯èˆ‡é‡æ•µç³»çµ±
        document.getElementById('adventure-screen').style.background = "linear-gradient(to bottom, #87ceeb 0%, #e0f6ff 100%)";
        startHeroAnimation(); 
    }
}

// --- ğŸ† æˆ°é¬¥çµç®—ç³»çµ± (ç‰©ç†éš”é›¢ã€æ¬Šé™è§£é–èˆ‡é˜²æ­»çµçµ‚æ¥µç‰ˆ) ---
async function finishBattle(isVictory) {
    // ğŸ”¥ ã€æ ¸å¿ƒä¿®æ­£ Aã€‘ç‰©ç†é‚„åŸç¶²é æ»¾å‹•æ¬Šé™ï¼Œç¢ºä¿ç©å®¶å¯ä»¥ç¹¼çºŒé–±è®€æ–‡ç« 
    document.body.style.overflow = 'auto';

    // 1. ğŸ”¥ ã€ç‰©ç†ç‹€æ…‹å¾¹åº•è§£é–ã€‘
    battleData.isBattleActive = false;
    window.isBattleTransitioning = false; 
    
    // 2. ğŸ”¥ ã€ç‰©ç†æ¨™ç±¤éŠ·æ¯€ã€‘æ®ºæ­»æ‰€æœ‰èƒŒæ™¯ç•°æ­¥å›èª¿
    window.currentBattleId = null;

    // 3. ğŸ”¥ ã€åœ–å±¤ç‰©ç†ä¸‹æ²ˆèˆ‡é»æ“Šå›æ”¶ã€‘
    const dangerOverlay = document.getElementById('danger-overlay');
    if (dangerOverlay) {
        dangerOverlay.classList.remove('danger-active');
        dangerOverlay.style.boxShadow = "none";
        // é—œéµï¼šç‰©ç†ç¦æ­¢æ””æˆªé»æ“Šï¼Œè®“ä¿¡è™Ÿç©¿é€åˆ°åº•å±¤
        dangerOverlay.style.pointerEvents = "none"; 
        dangerOverlay.style.display = "none"; 
    }

    // 4. ğŸ”¥ ã€å ´æ™¯ç‰©ç†æŠ¹é™¤èˆ‡å±¤ç´šæ­¸ä½ã€‘
    const scene = document.getElementById('battle-scene');
    if (scene) {
        scene.style.display = 'none';
        scene.style.zIndex = "-1"; // ç‰©ç†æ²ˆå…¥æœ€åº•å±¤
        scene.style.pointerEvents = "none"; // ç¦æ­¢æ””æˆªä¸€åˆ‡ä¿¡è™Ÿ
        scene.style.position = "absolute"; // é‡‹æ”¾ fixed ä½”ä½
        scene.innerHTML = ""; // ç‰©ç†æ¸…ç©ºå…§å®¹ï¼Œç¯€çœè¨˜æ†¶é«”
    }
    
    // 5. ğŸ”¥ ã€åœ°åœ–é‚è¼¯æ¸…ç†ã€‘
    if (typeof startHeroAnimation === 'function') {
        if (window.encounterTimer) clearInterval(window.encounterTimer);
        window.encounterTimer = null; 
        if (currentMapDifficulty !== "Home") {
            startHeroAnimation();
        }
    }

    // --- ä»¥ä¸‹ç‚ºçå‹µçµç®—é‚è¼¯ ---
    if (isVictory) {
        const now = Date.now();
        if (battleChain.count > 0 && (now - battleChain.lastVictoryTime <= battleChain.chainWindow)) {
            battleChain.count++;
        } else {
            battleChain.count = 1; 
        }
        battleChain.lastVictoryTime = now;

        // --- ğŸ’° çå‹µå€ç‡è¨ˆç®— ---
        const isMetal = battleData.isMetal === true; 
        const rewardScale = { "N5": 1, "N4": 2, "N3": 4, "N2": 7, "N1": 15, "N0": 25 }[currentMapDifficulty] || 1;
        const chainBonus = 1 + (battleChain.count * 0.1); 
        const finalScale = isMetal ? (rewardScale * 10) : (rewardScale * chainBonus);
        const bossName = isMetal ? "âœ¨ é‡‘å±¬å²èŠå§† (RARE)" : `${currentMapDifficulty} å€åŸŸé­”ç‰©`;
        
        if (typeof battleReward === 'function') {
            // é€™è£¡æœƒè§¸ç™¼ Victory Screen å½ˆçª—ï¼Œå½ˆçª—å…§éƒ¨æœ‰è‡ªå·±çš„ z-index é‚è¼¯
            battleReward(Math.floor(5 * finalScale), Math.floor(5 * finalScale), bossName);
        }

        // --- ğŸ æˆ°åˆ©å“æ‰è½æ ¸å¿ƒ ---
        let dropMsg = "";
        const dropChance = Math.random();
        if (isMetal) {
            player.inventory = player.inventory || [];
            player.inventory.push("ğŸ’ é‡‘å±¬ç¢ç‰‡");
            dropMsg = " ä¸¦ä¸”ç²å¾—äº†ç¨€æœ‰ç´ æï¼šé‡‘å±¬ç¢ç‰‡ï¼";
        } else if (currentMapDifficulty !== "N5" && dropChance > 0.6) {
            player.items = player.items || { potion: 0 };
            player.items.potion += (currentMapDifficulty === "N1" ? 2 : 1);
            dropMsg = ` æ’¿åˆ°äº† ğŸ§´ è£œè¡€è—¥æ°´ï¼`;
        }

        const comboText = battleChain.count > 1 ? ` (CHAIN ${battleChain.count}!)` : "";
        showNotification(`âš”ï¸ æˆ°é¬¥å‹åˆ©ï¼${comboText}${dropMsg}`);
        
    } else {
        // --- ğŸ’€ æˆ°é¬¥å¤±æ•—è™•ç† ---
        battleChain.count = 0; 
        showNotification("ğŸ’€ å‹‡è€…åŠ›ç›¡å€’ä¸‹... é€£æ“Šä¸­æ–·ä¸¦é€ƒå›ç‡Ÿåœ°ã€‚");
        
        // ç‰©ç†æ‰£é™¤ä»£åƒ¹
        player.coin = Math.max(-9999, player.coin - 20); 
        player.currentHp = Math.floor(player.maxHp * 0.15); 
        
        // å¤±æ•—æ™‚å¼·åˆ¶é‚„åŸæ‰€æœ‰æ¿¾é¡ï¼Œé˜²æ­¢ç•«é¢å¡æ­»åœ¨ç°è‰²
        const mainWrapper = document.querySelector('.main-wrapper');
        if (mainWrapper) mainWrapper.style.filter = "none";

        if (typeof travelTo === 'function') {
            await travelTo('N5'); 
        }
    }

    // 6. æ•¸æ“šç‰©ç†åŒæ­¥
    if (typeof updatePlayerUI === 'function') updatePlayerUI();
    if (typeof savePlayerToDB === 'function') await savePlayerToDB();
    
    // 7. æ¸…ç†æš«æ™‚æ¨™è¨˜
    battleData.isMetal = false;
    console.log(`%cğŸ ç³»çµ±æ¢å¾©è‡ªç”±ç‹€æ…‹ [é€£æ“Š: ${battleChain.count}]`, "color: #2ecc71; font-weight: bold;");
}


function checkEncounter() {
    // ğŸ”¥ å¦‚æœæˆ°é¬¥ä¸­ã€åˆ‡æ›ä¸­æˆ–æ­£åœ¨ä¼‘æ¯ï¼Œç‰©ç†æ””æˆªé‡æ•µ
    if (battleData.isBattleActive || window.isBattleTransitioning || player.isResting) return;

    if (Math.random() < encounterRate) {
        window.isBattleTransitioning = true; // é–å®šç‹€æ…‹
        startBattle(); 
    }
}

// --- ğŸ©¸ è¡€è…¥ç‹åœ‹ï¼šè´–ç½ªèˆ‡éµéˆç²‰ç¢å¼•æ“ ---
function checkAbsolutionMiracle(difficulty) {
    // ç‰©ç†æª¢æŸ¥ï¼šæ˜¯å¦è™•æ–¼è² å‚µä¸”æ“Šæ•—å¼·å¤§é­”ç‰©
    if (player.coin < 0 && (difficulty === "N1" || difficulty === "N0")) {
        // è§¸ç™¼æ©Ÿç‡ï¼šN1 ç‚º 30%ï¼ŒN0 ç‚º 100% (å‚³å¥‡å€åŸŸå¿…èµ¦å…)
        const chance = (difficulty === "N0") ? 1.0 : 0.3;
        
        if (Math.random() <= chance) {
            triggerAbsolutionEffect(); // è§¸ç™¼è¦–è¦ºç‰¹æ•ˆ
            return true;
        }
    }
    return false;
}

/**
 * ğŸ¨ ç‰©ç†è¦–è¦ºæ³¨å…¥ï¼šRoguelike æ©è³œç¨€æœ‰åº¦ç‰¹æ•ˆ
 */
function injectBoonStyles() {
    // ğŸ”¥ ã€ç‰©ç†é˜²ç¦¦ã€‘é˜²æ­¢é‡è¤‡æ³¨å…¥å°è‡´ CSS æ¬Šé‡æ··äº‚
    if (document.getElementById('boon-effects-css')) return;

    const style = document.createElement('style');
    style.id = 'boon-effects-css';
    style.innerHTML = `
        /* åŸºç¤å¡ç‰‡ç‰©ç†å±¬æ€§æ ¡æº– */
        .boon-card {
            position: relative;
            background: #0a0a0a !important;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) !important;
        }

        /* ğŸ† å‚³å¥‡ - é‡‘è‰²é–ƒçˆ (å‘¼å¸å…‰æ„Ÿ) */
        .boon-legend {
            border: 2px solid #f1c40f !important;
            box-shadow: 0 0 20px rgba(241, 196, 15, 0.4), inset 0 0 15px rgba(241, 196, 15, 0.2) !important;
            animation: goldPulse 2s infinite alternate ease-in-out;
        }
        @keyframes goldPulse {
            0% { filter: brightness(1) drop-shadow(0 0 5px gold); }
            100% { filter: brightness(1.3) drop-shadow(0 0 25px #f1c40f); transform: scale(1.02); }
        }

        /* âš¡ ç¨€æœ‰ - ç´…è‰²é–ƒé›» (é«˜é »éœ‡ç›ª) */
        .boon-rare {
            border: 2px solid #e74c3c !important;
            animation: redFlash 0.15s infinite;
        }
        @keyframes redFlash {
            0% { border-color: #e74c3c; box-shadow: 0 0 5px #e74c3c; }
            50% { border-color: #fff; box-shadow: 0 0 20px #e74c3c, inset 0 0 10px #e74c3c; }
            100% { border-color: #e74c3c; box-shadow: 0 0 5px #e74c3c; }
        }

        /* ğŸ”˜ ä¸€èˆ¬ - æ™®é€šç°é‚Š (ä½èª¿è³ªæ„Ÿ) */
        .boon-normal {
            border: 2px solid #444 !important;
            box-shadow: 0 4px 15px rgba(0,0,0,0.6) !important;
        }

        /* ğŸ’€ å„é‹ - é»‘éœ§é£„æ¸º (ç´«é»‘å¹½å…‰) */
        .boon-curse {
            border: 2px solid #4a148c !important;
            background: linear-gradient(145deg, #050505 0%, #1a0033 100%) !important;
            animation: blackSmoke 4s infinite ease-in-out;
        }
        @keyframes blackSmoke {
            0%, 100% { box-shadow: 0 0 10px #000; filter: grayscale(0.5); }
            50% { 
                box-shadow: 0 0 35px #4a148c, inset 0 0 25px #000; 
                filter: grayscale(0) contrast(1.3) brightness(0.7); 
                transform: translate(1px, 1px);
            }
        }

        /* ç‰©ç†æ‡¸åœå¢å¼·ï¼šç•¶é¸ä¸­å‘½é‹æ™‚çš„è¦–è¦ºç©¿é€ */
        .boon-card:hover {
            z-index: 100;
            cursor: pointer;
        }
    `;
    
    document.head.appendChild(style);
    console.log("%câœ¨ å‘½é‹ç‰¹æ•ˆåœ–å±¤å·²ç‰©ç†æ›è¼‰å®Œæˆã€‚", "color: #f1c40f; font-weight: bold;");
}

function triggerAbsolutionEffect() {
    // 1. ç‰©ç†æ¸…å„Ÿï¼šå‚µå‹™æ­¸é›¶
    player.coin = 0;
    
    // 2. ç‰©ç†ç²‰ç¢ï¼šç§»é™¤éµéˆè£å‚™
    player.inventory = player.inventory.filter(item => item !== "â›“ï¸ å‚µå‹™äººçš„éµéˆ");
    
    // 3. è¦–è¦ºç‰¹æ•ˆï¼šé‡‘å…‰é–ƒçˆèˆ‡ç‰©ç†é€šçŸ¥
    showNotification("âœ¨ ã€æ¸…å„Ÿå¥‡è¹Ÿã€‘ä½ çš„æ­¦å‹‡éœ‡é©šäº†ç‹åœ‹ï¼");
    showNotification("â›“ï¸ éµéˆå·²ç‰©ç†ç²‰ç¢ï¼Œåœ‹ç‹èµ¦å…äº†ä½ çš„ç½ªå­½ï¼");
    
    // è®“èƒŒæ™¯ç•«é¢é–ƒçˆä¸€æ¬¡ç´”ç™½å…‰ (Flashbang)
    const screen = document.getElementById('adventure-screen');
    if (screen) {
        screen.style.transition = "filter 0.1s";
        screen.style.filter = "brightness(5) contrast(0.5)";
        setTimeout(() => screen.style.filter = "none", 500);
    }
    
    // ç‰©ç†åŒæ­¥ä»‹é¢
    updatePlayerUI();
}


function sleep(ms) { return new Promise(resolve => setTimeout(resolve, ms)); }

// --- ğŸ† è¯éº—çµç®—ç³»çµ± (ç‰©ç†çµæ§‹åˆ†é›¢èˆ‡æ¸…æ™°åŒ–ä¿®æ­£ç‰ˆ) ---
function showVictoryScreen(boss, exp, coin, loot) {
    const screen = document.getElementById('victory-screen');
    const vicLoot = document.getElementById('vic-loot');
    if (!screen || !vicLoot) return;

    // 1. è¨­å®šæ–‡å­—å…§å®¹èˆ‡æ•¸å€¼å‹•ç•«
    const bossTitle = document.getElementById('vic-boss-name');
    if (bossTitle) bossTitle.innerText = `å·²æˆåŠŸè¨ä¼ï¼š${boss}`;
    animateNumber('vic-exp', 0, exp, 1000);
    animateNumber('vic-coin', 0, coin, 1000);
    
    // 2. è™•ç†æ‰è½ç‰©ç‰¹æ•ˆ Class
    const safeLoot = (loot && typeof loot === 'string') ? loot : "ç„¡";
    vicLoot.classList.remove('legendary-glow', 'phantom-victory-glow');

    if (safeLoot !== "ç„¡") {
        let lootHtml = `<div class="loot-card">ğŸ ç²å¾—ç‰©å“ï¼š<br><span class="loot-name">${safeLoot}</span></div>`;
        if (boss.includes("è™›ç©º") || boss.includes("å¹»å½±")) {
            vicLoot.classList.add('phantom-victory-glow');
            lootHtml += `<div style="color:#9b59b6; font-size:10px; margin-top:5px; font-weight:bold;">ğŸŸ£ ä¾†è‡ªç•°ç•Œçš„èƒ½é‡æ³¢å‹•...</div>`;
        } else if (["ğŸ”¥", "ğŸ‘‘", "ğŸ’"].some(icon => safeLoot.includes(icon))) {
            vicLoot.classList.add('legendary-glow');
        }
        vicLoot.innerHTML = lootHtml;
    } else {
        vicLoot.innerHTML = "<div style='color:#ccc; margin-top:10px; font-size:14px;'>æœ¬æ¬¡ç„¡æ‰è½ç‰©å“</div>";
    }

    // 3. ğŸ”¥ ã€ç‰©ç†éš”é›¢æ ¸å¿ƒï¼šé¡¯ç¤ºç«¯ã€‘
    screen.style.display = 'flex';
    screen.style.zIndex = "100000"; // ç‰©ç†æ¥µè‡´ç½®é ‚ï¼Œé«˜æ–¼ä¸€åˆ‡
    screen.style.filter = "none !important"; // ç¢ºä¿å½ˆçª—æœ¬é«”çµ•å°æ¸…æ™°
    screen.classList.add('fade-in-popup');

    // 4. ğŸ”¥ ã€èƒŒæ™¯ç‰©ç†é–å®šã€‘å°åœ°åœ–èˆ‡ä»‹é¢æ–½åŠ æ¿¾é¡
    const elementsToLock = [
        document.querySelector('.main-wrapper'),
        document.getElementById('game-sticky-header'),
        document.querySelector('header')
    ];

    elementsToLock.forEach(el => {
        if (el) {
            el.style.transition = "filter 0.4s ease, transform 0.4s ease";
            el.style.filter = "blur(12px) grayscale(0.5) brightness(0.6)";
            el.style.pointerEvents = "none"; // ç‰©ç†æ””æˆªï¼šé˜²æ­¢çµç®—æ™‚é»åˆ°èƒŒæ™¯
        }
    });
}


/**
 * è¼”åŠ©å‡½æ•¸ï¼šç‰©ç†æ•¸å€¼æ»¾å‹•å‹•ç•«
 */
function animateNumber(id, start, end, duration) {
    const obj = document.getElementById(id);
    if (!obj) return;
    let startTimestamp = null;
    const step = (timestamp) => {
        if (!startTimestamp) startTimestamp = timestamp;
        const progress = Math.min((timestamp - startTimestamp) / duration, 1);
        obj.innerText = Math.floor(progress * (end - start) + start);
        if (progress < 1) {
            window.requestAnimationFrame(step);
        }
    };
    window.requestAnimationFrame(step);
}
/**
 * ğŸ† çµç®—é—œé–‰ç³»çµ± (ç‰©ç†åº§æ¨™é‚„åŸã€å±¤ç´šé‡‹æ”¾èˆ‡å…¨æ¬Šé™å›æ”¶)
 * ä¿®æ­£é»ï¼š
 * 1. åº§æ¨™é˜²ç¦¦ï¼šå¼·åˆ¶å°‡ html, body çš„ transform/filter æ­¸é›¶ï¼Œç¢ºä¿ fixed å®šä½åŸºæº–é»å›åˆ° (0,0)ã€‚
 * 2. æ®˜ç•™æ¸…æ´—ï¼šå¾¹åº•æ‹”é™¤ main-wrapper ä¸Šçš„ blur ç‰¹æ•ˆï¼Œå®ƒæ˜¯å°è‡´ Header é£„ç§»åˆ° 259px çš„å…ƒå…‡ã€‚
 * 3. æ»¾å‹•å›æ­¸ï¼šç¢ºä¿æ¢å¾© body çš„ overflow æ¬Šé™ï¼Œæ¶ˆé™¤ã€Œç„¡æ³•æ‹‰å‹•ã€çš„æ‹–ç§»æ„Ÿã€‚
 */
function closeVictory() {
    console.log("%cğŸ§¹ åŸ·è¡Œå…¨ç³»çµ±ç‰©ç†åº§æ¨™ç³»èˆ‡å±¤ç´šé‚„åŸ...", "color: #e67e22; font-weight: bold;");

    // 0. ğŸ”¥ ã€ç‰©ç†åº§æ¨™åŸºæº–é‚„åŸã€‘
    // å¼·åˆ¶é‡ç½®æ ¹å®¹å™¨ï¼Œé˜²æ­¢ fixed å®šä½å› çˆ¶ç´š filter ç”¢ç”Ÿçš„å±€éƒ¨åº§æ¨™ç³»è€Œé£„ç§»
    const rootElements = [document.documentElement, document.body];
    rootElements.forEach(el => {
        el.style.filter = "none";
        el.style.transform = "none";
        el.style.overflow = 'auto'; // ç‰©ç†æ¢å¾©æ²è»¸æ¬Šé™
    });

    // 1. ğŸ”¥ ã€æœ¬é«”ç‰©ç†æ¶ˆå¤±ã€‘
    const screen = document.getElementById('victory-screen');
    if (screen) {
        screen.style.display = 'none';
        screen.classList.remove('fade-in-popup');
        screen.style.zIndex = "-1";
    }

    // 2. ğŸ”¥ ã€ç‰©ç†æ¸…æ´—èƒŒæ™¯ï¼šæ¶ˆé™¤ 259px åç§»çš„å…ƒå…‡ã€‘
    const elementsToUnlock = [
        document.querySelector('.main-wrapper'),
        document.getElementById('game-sticky-header'),
        document.querySelector('header'),
        document.querySelector('aside'),
        document.querySelector('main')
    ];

    elementsToUnlock.forEach(el => {
        if (el) {
            // ç‰©ç†é—œéµï¼šå¾¹åº•ç§»é™¤ filterã€‚å¦‚æœæ®˜ç•™ blur(12px)ï¼ŒHeader å°±æœƒé£„ç§»
            el.style.filter = "none";
            el.style.webkitFilter = "none";
            el.style.pointerEvents = "auto"; // æ¢å¾©ç‰©ç†é»æ“Šæ¬Š
            el.style.transform = "none";      // ç¢ºä¿æ²’æœ‰ä½ç§»æ®˜ç•™
            el.style.opacity = "1";
        }
    });

    // 3. ğŸ”¥ ã€æˆ°é¬¥ç‹€æ…‹ç‰©ç†æ¸…ç†ã€‘
    const battleScene = document.getElementById('battle-scene');
    if (battleScene) {
        battleScene.style.display = 'none';
        battleScene.style.zIndex = "-1";
        battleScene.style.pointerEvents = "none";
        battleScene.innerHTML = ""; 
    }

    // 4. ğŸ”¥ ã€ç³»çµ±é–å®šé‡‹æ”¾ã€‘
    window.isBattleTransitioning = false;
    battleData.isBattleActive = false;
    window.currentBattleId = null; // éŠ·æ¯€æˆ°é¬¥ ID éˆ
    
    // æ¸…é™¤ç€•æ­»ç´…å…‰
    const dangerOverlay = document.getElementById('danger-overlay');
    if (dangerOverlay) {
        dangerOverlay.style.display = "none";
        dangerOverlay.classList.remove('danger-active');
        dangerOverlay.style.pointerEvents = "none";
    }

    // 5. ğŸ”¥ ã€æ•¸æ“šç‰©ç†é–å®šèˆ‡å­˜æª”ã€‘
    if (typeof savePlayerToDB === 'function') savePlayerToDB();
    if (typeof updatePlayerUI === 'function') updatePlayerUI();
    
    // ğŸ”¥ ã€æ ¸å¿ƒæ ¡æº–ã€‘è‹¥æœ‰åœ°åœ–é¸å–®ï¼ŒåŒæ­¥åˆ·æ–°ä¸€æ¬¡
    if (typeof updateMapBadges === 'function') updateMapBadges();

    console.log("%câœ… ç‰©ç†åº§æ¨™ç³»å·²é‡ç½®ï¼Œå…¨åŸŸ fixed å®šä½æ¢å¾© Top:0 åŸºæº–é»", "color: #27ae60; font-weight: bold;");
}



/**
 * ğŸ’ å…¨é‡èƒŒåŒ…æ¸²æŸ“ï¼šåˆ†å±¤æ¶æ§‹ç‰ˆ (Tabs + Pagination)
 */
function refreshInventoryUI() {
    const scrollArea = document.querySelector('#inventory-popup .popup-content-scroll');
    if (!scrollArea) return;

    // 1. ç²å–æ•´ç†å¾Œçš„æ•¸æ“š
    const allData = aggregateInventoryData();
    const targetItems = allData[currentInvTab] || [];

    // 2. æ¸²æŸ“é ‚éƒ¨æ¨™ç±¤åˆ— (Tabs)
    const tabs = [
        { id: 'equipment', label: 'âš”ï¸ è£å‚™', count: allData.equipment.length },
        { id: 'artifact',  label: 'ğŸ“¦ ç¥å™¨', count: allData.artifact.length },
        { id: 'material',  label: 'ğŸ’ ç´ æ', count: allData.material.length },
        { id: 'potion',    label: 'ğŸ§ª æ¶ˆè€—', count: allData.potion.length }
    ];

    let html = `<div class="inv-tabs">`;
    tabs.forEach(t => {
        const isActive = (t.id === currentInvTab) ? 'active' : '';
        html += `<button class="inv-tab-btn ${isActive}" onclick="switchInvTab('${t.id}')">
                    ${t.label} <span style="font-size:10px; opacity:0.7;">(${t.count})</span>
                 </button>`;
    });
    html += `</div>`;

    // 3. è¨ˆç®—åˆ†é é‚è¼¯
    const totalPages = Math.max(1, Math.ceil(targetItems.length / INV_PER_PAGE));
    // é˜²å‘†æ ¡æº–
    if (invPageState[currentInvTab] > totalPages) invPageState[currentInvTab] = totalPages;
    const currentPage = invPageState[currentInvTab];

    // 4. æ•¸æ“šåˆ‡ç‰‡ (Slicing)
    const startIndex = (currentPage - 1) * INV_PER_PAGE;
    const pagedItems = targetItems.slice(startIndex, startIndex + INV_PER_PAGE);

    // 5. æ¸²æŸ“ç‰©å“ç¶²æ ¼ (Grid)
    html += `<div class="item-grid" style="min-height: 280px; align-content: start;">`;
    
    if (pagedItems.length === 0) {
        html += `<div class="inv-empty-msg">æ­¤åˆ†é¡å°šç„¡ç‰©å“</div>`;
    } else {
        pagedItems.forEach(item => {
            html += renderInvItemCard(item); // å‘¼å«å­å‡½æ•¸ç”Ÿæˆå¡ç‰‡
        });
    }
    html += `</div>`;

    // 6. æ¸²æŸ“åˆ†é æ§åˆ¶å™¨ (Pagination)
    html += `
        <div class="inv-pagination">
            <button onclick="changeInvPage(-1)" class="game-btn" ${currentPage === 1 ? 'disabled style="opacity:0.3"' : ''}>â—€</button>
            <span style="color:#f1c40f; font-family:monospace; font-weight:bold;">PAGE ${currentPage} / ${totalPages}</span>
            <button onclick="changeInvPage(1)" class="game-btn" ${currentPage === totalPages ? 'disabled style="opacity:0.3"' : ''}>â–¶</button>
        </div>
    `;

    // æ³¨å…¥ DOM
    scrollArea.innerHTML = html;
}

/**
 * ğŸ“Š å­å‡½æ•¸ï¼šèƒŒåŒ…æ•¸æ“šèšåˆå™¨
 * ä½œç”¨ï¼šå°‡æ•£è½åœ¨å„è™•çš„ç‰©å“æ•¸æ“šçµ±ä¸€ç‚ºæ¨™æº–æ ¼å¼ï¼Œä¸¦è‡ªå‹•åˆ†é¡
 */
function aggregateInventoryData() {
    const categorized = { equipment: [], artifact: [], material: [], potion: [] };
    const stackMap = {}; 

    // 1. è™•ç† inventory é™£åˆ— (è£å‚™ã€ç´ æã€ç¥å™¨)
    if (player.inventory && Array.isArray(player.inventory)) {
        player.inventory.forEach((itemName, originalIdx) => {
            if (!stackMap[itemName]) {
                const baseName = itemName.split(' (+')[0].trim();
                const itemData = MASTER_COLLECTION.find(m => baseName.includes(m.name)) || { type: 'misc' };
                
                // è‡ªå‹•åˆ†é¡é‚è¼¯
                let category = 'material';
                if (itemData.type === 'artifact') category = 'artifact';
                else if (['weapon','head','body','legs','boots','offhand','necklace','ring','rune'].includes(itemData.type)) category = 'equipment';
                else if (itemName.includes("ç²¾ç…‰çŸ³") || itemName.includes("ç²¾ç…‰ç¢å¡Š")) category = 'material';

                stackMap[itemName] = {
                    name: itemName,
                    count: 0,
                    firstIndex: originalIdx, // è¨˜éŒ„åŸå§‹ç´¢å¼•ä¾›æ“ä½œç”¨
                    data: itemData,
                    category: category,
                    source: 'inventory'
                };
            }
            stackMap[itemName].count++;
        });
    }

    // å°‡å †ç–Šå¥½çš„ç‰©å“æ”¾å…¥åˆ†é¡
    Object.values(stackMap).forEach(item => {
        if (categorized[item.category]) categorized[item.category].push(item);
    });

    // 2. è™•ç† potion ç‰¹æ®Šæ¬„ä½ (æ­¸é¡åˆ° potion)
    if (player.items) {
        if (player.items.potion > 0) categorized.potion.push({ name: "ğŸ§´ è£œè¡€è—¥æ°´", count: player.items.potion, data: { rarity: 'common' }, source: 'items', key: 'potion' });
        if (player.items.antidote > 0) categorized.potion.push({ name: "ğŸ§ª è§£æ¯’åŠ‘", count: player.items.antidote, data: { rarity: 'common' }, source: 'items', key: 'antidote' });
    }

    // 3. è™•ç† dust ç‰¹æ®Šæ¬„ä½ (æ­¸é¡åˆ° material)
    if (player.phantomDust > 0) {
        categorized.material.unshift({ name: "âœ¨ å¹»å½±ä¹‹å¡µ", count: player.phantomDust, data: { rarity: 'rare' }, source: 'dust' });
    }

    return categorized;
}

/**
 * ğŸ–¼ï¸ å­å‡½æ•¸ï¼šç”Ÿæˆå–®ä¸€ç‰©å“å¡ç‰‡ HTML
 */
function renderInvItemCard(item) {
    const parts = item.name.split(' ');
    const icon = parts[0] || "ğŸ“¦";
    const displayName = parts.slice(1).join(' ') || item.name;
    
    // ç¨€æœ‰åº¦ç‰¹æ•ˆ
    const rarity = item.data.rarity || 'common';
    let style = 'border-color: rgba(255,255,255,0.1);';
    if (rarity === 'legendary') style = 'border-color: #f1c40f; box-shadow: inset 0 0 10px rgba(241, 196, 15, 0.2);';
    if (rarity === 'mythic') style = 'border-color: #e74c3c; box-shadow: inset 0 0 15px rgba(231, 76, 60, 0.3);';

    // é»æ“Šäº‹ä»¶ï¼šå¦‚æœæ˜¯ inventory ä¾†æºï¼Œå‚³éç´¢å¼•ï¼›å¦‚æœæ˜¯ç‰¹æ®Šä¾†æºï¼Œä¸åšåæ‡‰(æˆ–å¯æ“´å……)
    let clickAction = '';
    if (item.source === 'inventory') {
        clickAction = `onclick="showItemDetails('${item.name}', 'inventory', ${item.firstIndex})" style="cursor:pointer; ${style}"`;
    } else {
        clickAction = `style="cursor:default; ${style}"`; // ç‰¹æ®Šç‰©å“æš«ä¸å¯é»æ“Šè©³æƒ…
    }

    return `
        <div class="inv-item-card" ${clickAction}>
            <div style="font-size:26px; margin-bottom:4px;">${icon}</div>
            <div style="font-size:11px; line-height:1.2;">${displayName}</div>
            ${item.count > 1 ? `<div class="item-count-badge">x${item.count}</div>` : ''}
        </div>
    `;
}

/**
 * ğŸ”„ äº’å‹•ï¼šåˆ‡æ›èƒŒåŒ…æ¨™ç±¤
 */
function switchInvTab(tabId) {
    currentInvTab = tabId;
    // é‡ç½®æ²è»¸ä½ç½®
    const scrollArea = document.querySelector('#inventory-popup .popup-content-scroll');
    if (scrollArea) scrollArea.scrollTop = 0;
    refreshInventoryUI(); 
}

/**
 * ğŸ“„ äº’å‹•ï¼šåˆ‡æ›èƒŒåŒ…é ç¢¼
 */
function changeInvPage(delta) {
    invPageState[currentInvTab] += delta;
    refreshInventoryUI(); // é‡æ–°æ¸²æŸ“ (å…§éƒ¨æœƒåšé‚Šç•Œæª¢æŸ¥)
    
    // ç‰©ç†å›å½ˆ
    const scrollArea = document.querySelector('#inventory-popup .popup-content-scroll');
    if (scrollArea) scrollArea.scrollTop = 0;
}


/**
 * ğŸ“œ ç‰©å“è©³æƒ…èˆ‡æ•¸å€¼åˆ†æè¦–çª— (è¦–è¦ºèˆ‡æ•¸å€¼ä¿®å¾©ç‰ˆ)
 * @param {string} itemStr ç‰©å“å®Œæ•´åç¨± (å«+n)
 * @param {string} source ä¾†æºé¡å‹ ('inventory' | 'equip')
 * @param {any} param ä¾†æºåƒæ•¸ (èƒŒåŒ…ç´¢å¼• æˆ– è£å‚™æ§½ä½ID)
 */
function showItemDetails(itemStr, source = 'inventory', param = null) {
    // 1. ç‰©ç†ç§»é™¤èˆŠè¦–çª—
    const existing = document.getElementById('item-detail-modal');
    if (existing) existing.remove();

    if (!itemStr) return;

    // 2. è§£ææ•¸æ“š
    const baseName = itemStr.split(' (+')[0].trim();
    const lv = getRefineLv(itemStr);
    const itemData = MASTER_COLLECTION.find(m => m.name === baseName);

    if (!itemData) {
        console.warn("ç„¡æ³•è­˜åˆ¥çš„ç‰©å“:", baseName);
        return; 
    }

    // 3. è¨ˆç®—ç²¾ç…‰å€ç‡ (ç‰©ç†å…¬å¼)
    let multiplier = 1.0;
    for(let i=1; i<=lv; i++) {
        if (i <= 6) multiplier += 0.10;
        else if (i <= 9) multiplier += 0.15;
        else multiplier += 0.25;
    }

    // 4. æ§‹å»ºæ•¸å€¼ HTML
    let statsHtml = '';
    if (itemData.stats) {
        Object.entries(itemData.stats).forEach(([key, val]) => {
            if (typeof val === 'number') { 
                let label = key.toUpperCase();
                // ç¿»è­¯æ¨™ç±¤
                const labelMap = { 
                    'atk':'âš”ï¸ æ”»æ“Š', 'def':'ğŸ›¡ï¸ é˜²ç¦¦', 'hp':'â¤ï¸ ç”Ÿå‘½', 
                    'crit':'âš¡ æš´æ“Š', 'dodge':'ğŸƒ é–ƒé¿', 'timer':'â³ æ™‚é–“', 
                    'coinMult':'ğŸ’° é‡‘å¹£', 'expMult':'ğŸ“š ç¶“é©—', 'pokerLuck':'ğŸƒ è³­é‹',
                    'drain':'ğŸ©¸ å¸è¡€', 'block':'ğŸ›¡ï¸ æ ¼æ“‹', 'reflect':'âœ¨ åå‚·'
                };
                label = labelMap[key] || label;
                
                let displayVal = "";
                let bonusHtml = "";

                // --- ğŸ”¥ æ•¸å€¼é¡å‹åˆ†æµè™•ç† ---
                
                // A. ç™¾åˆ†æ¯”é¡ (ä¸å–æ•´æ•¸ï¼Œé¡¯ç¤º %)
                if (['crit', 'dodge', 'drain', 'dropRate', 'block', 'reflect', 'pokerLuck'].includes(key)) {
                    // åŸå§‹å€¼ (ä¾‹å¦‚ 0.1)
                    let finalRaw = val; 
                    // å¦‚æœæ‚¨å¸Œæœ›ç²¾ç…‰èƒ½å¢åŠ æ ¼æ“‹/æš´æ“Šï¼Œè§£é–‹ä¸‹é¢é€™è¡Œï¼›å¦å‰‡ä¿æŒåŸå€¼
                    // finalRaw = val * multiplier; 

                    displayVal = (finalRaw * 100).toFixed(1).replace('.0', '') + '%';
                    
                    // ç™¾åˆ†æ¯”é¡æš«ä¸é¡¯ç¤º (+n) ç¶ å­—ï¼Œä»¥å…ç‰ˆé¢æ··äº‚
                    bonusHtml = ""; 
                } 
                // B. å€ç‡é¡ (é¡¯ç¤º x1.5)
                else if (['coinMult', 'expMult'].includes(key)) {
                    displayVal = 'x' + val.toFixed(2);
                    bonusHtml = "";
                } 
                // C. æ•´æ•¸é¡ (æ”»æ“Šã€é˜²ç¦¦ã€è¡€é‡ -> å–æ•´æ•¸)
                else {
                    const totalVal = Math.floor(val * multiplier);
                    const bonusVal = totalVal - val;
                    displayVal = totalVal;
                    
                    if (bonusVal > 0) {
                        bonusHtml = `<span class="refine-bonus">(+${bonusVal})</span>`;
                    }
                }

                statsHtml += `
                    <div class="stat-row">
                        <span class="stat-label">${label}</span>
                        <span class="stat-val">
                            ${displayVal} ${bonusHtml}
                        </span>
                    </div>
                `;
            }
        });
    }

    // 5. æ§‹å»ºæŒ‰éˆ•é‚è¼¯
    let actionBtnHtml = '';
    // A. ä¾†è‡ªèƒŒåŒ…
    if (source === 'inventory') {
        if (['weapon','head','body','legs','boots','offhand','necklace','ring','rune'].includes(itemData.type)) {
             actionBtnHtml = `<button class="detail-btn equip" onclick="autoEquipItem(${param})">âš”ï¸ ç©¿ä¸Š</button>`;
        } else if (itemData.type === 'artifact') {
             actionBtnHtml = `<button class="detail-btn alchemy" onclick="toggleMenu('alchemy')">ğŸ”® å»éŠé‡‘</button>`;
        } else {
             actionBtnHtml = `<button class="detail-btn" style="cursor:default; opacity:0.5;">ç‰©å“</button>`;
        }
    } 
    // B. ä¾†è‡ªè£å‚™æ¬„
    else if (source === 'equip') {
        actionBtnHtml = `<button class="detail-btn unequip" onclick="currentEquipSlotId='${param}'; unequipCurrentSlot(); closeItemDetailModal();">ğŸ“¦ å¸ä¸‹</button>`;
    }

    // 6. æ§‹å»ºå®Œæ•´ HTML
    const modal = document.createElement('div');
    modal.id = 'item-detail-modal';
    modal.className = `rarity-${itemData.rarity || 'common'}`;

    const icon = itemStr.split(' ')[0] || "ğŸ“¦";
    const typeName = translateType(itemData.type);

    modal.innerHTML = `
        <div class="detail-header">
            <div class="detail-icon">${icon}</div>
            <div class="detail-name" style="color:${getRarityColor(itemData.rarity)}">
                ${baseName} ${lv > 0 ? `<span style="color:#f1c40f">(+${lv})</span>` : ''}
            </div>
            <span class="detail-type">${typeName}</span>
        </div>
        <div class="detail-body">
            <div class="detail-stats">
                ${statsHtml || '<div style="text-align:center; color:#888;">ç„¡æˆ°é¬¥æ•¸å€¼</div>'}
            </div>
            <div class="detail-desc">
                ${itemData.desc}
            </div>
        </div>
        <div class="detail-actions">
            ${actionBtnHtml}
            <button class="detail-btn" onclick="closeItemDetailModal()">é—œé–‰</button>
        </div>
    `;

    document.body.appendChild(modal);
    requestAnimationFrame(() => modal.style.display = 'flex');
}

// --- è¼”åŠ©å‡½æ•¸ç¾¤ ---

function closeItemDetailModal() {
    const el = document.getElementById('item-detail-modal');
    if (el) el.remove();
}

// è‡ªå‹•ç©¿è£é‚è¼¯
function autoEquipItem(inventoryIdx) {
    const itemStr = player.inventory[inventoryIdx];
    const baseName = itemStr.split(' (+')[0].trim();
    const data = MASTER_COLLECTION.find(m => m.name === baseName);
    
    if (!data) return;

    let targetSlot = data.type;
    
    if (data.type === 'ring') {
        targetSlot = !player.equips.ring1 ? 'ring1' : (!player.equips.ring2 ? 'ring2' : 'ring1');
    }
    if (data.type === 'rune') {
        const slots = ['rune1', 'rune2', 'rune3', 'rune4', 'rune5'];
        targetSlot = slots.find(s => !player.equips[s]) || 'rune1';
    }
    
    currentEquipSlotId = targetSlot;
    doEquip(inventoryIdx);
    closeItemDetailModal();
}

function getRarityColor(r) { return ({mythic:'#e74c3c', legendary:'#f1c40f', rare:'#3498db'}[r] || '#fff'); }

function translateType(t) {
    const map = { 
        weapon:'ä¸»æ‰‹æ­¦å™¨', offhand:'å‰¯æ‰‹', head:'é ­éƒ¨', body:'ç›”ç”²', 
        legs:'è¤²ç”²', boots:'é‹å­', gloves:'æ‰‹å¥—', necklace:'é …éŠ', 
        ring:'æˆ’æŒ‡', rune:'ç¬¦æ–‡', artifact:'åˆæˆææ–™', consumable:'æ¶ˆè€—å“'
    };
    return map[t] || t.toUpperCase();
}

/**
 * ğŸ§® ç‰©ç†é‹ç®—ï¼šè¨ˆç®—å…¨åŸŸæ‰å¯¶ç‡åŠ æˆ (Total Drop Rate Bonus)
 * ä¾†æºï¼š
 * 1. èº«ä¸Šè£å‚™ (Equips) çš„ dropRate å±¬æ€§
 * 2. å·²è§£é–å‹³ç«  (Medals) çš„ bonus å±¬æ€§
 * 3. æ¯€æ»…å°ç¬¦ (Inventory) è¢«å‹•æ•ˆæœ
 * 4. Roguelike ç•°èƒ½ (Boons)
 */
function calculateDropRateBonus() {
    let totalBonus = 0;

    // 1. ğŸ›¡ï¸ è£å‚™åŠ æˆ (å«ç¬¦æ–‡)
    if (player.equips) {
        Object.values(player.equips).forEach(item => {
            if (item && item.stats && item.stats.dropRate) {
                totalBonus += item.stats.dropRate;
            }
        });
    }

    // 2. ğŸ–ï¸ å‹³ç« åŠ æˆ
    if (player.medals && Array.isArray(player.medals)) {
        MEDAL_MASTER.forEach(m => {
            if (player.medals.includes(m.id)) {
                totalBonus += (m.bonus || 0);
            }
        });
    }

    // 3. ğŸ”¥ æ¯€æ»…å°ç¬¦ (æ”¾åœ¨èƒŒåŒ…å°±ç”Ÿæ•ˆçš„ç‰¹æ®Šè¢«å‹•)
    // å‡è¨­åŸºå¾·çš„é‹æ°£ (charm_gheed) ä¹Ÿæ˜¯æ”¾åœ¨èƒŒåŒ…ç”Ÿæ•ˆ
    if (player.inventory) {
        if (player.inventory.includes("ğŸ’ æ¯€æ»…å°ç¬¦ (Annihilus)")) totalBonus += 0.1; // 10%
        // å¦‚æœæ‚¨æœ‰å¯¦è£åŸºå¾·çš„é‹æ°£
        const hasGheed = player.inventory.some(i => i.includes("åŸºå¾·çš„é‹æ°£"));
        if (hasGheed) totalBonus += 0.5; // 50%
    }

    // 4. ğŸ­ Roguelike ç•°èƒ½
    if (pokerGame && pokerGame.activeBoon === 'luck') { // å‡è¨­å¹¸é‹è‰ç•°èƒ½ä¹ŸåŠ æ‰å¯¶
        totalBonus += 0.2;
    }

    return totalBonus;
}




// --- ç‰©ç†é€£æ“Šç›£æ§å™¨ ---
function updateChainUI() {
    const displayEl = document.getElementById('chain-display');
    const countEl = document.getElementById('chain-count');
    if (!displayEl || !countEl) return;

    const now = Date.now();
    // åˆ¤å®šï¼šæ˜¯å¦æœ‰é€£æ“Š ä¸” æ˜¯å¦åœ¨ 30 ç§’çª—å£å…§
    const isChainActive = battleChain.count > 0 && (now - battleChain.lastVictoryTime <= battleChain.chainWindow);

    if (isChainActive) {
        displayEl.style.display = 'block';
        countEl.innerText = battleChain.count;
        
        // ç‰©ç†å‹•æ•ˆï¼šé€£æ“Šæ•¸è¶Šé«˜ï¼Œé–ƒçˆè¶Šå¿«
        const flashSpeed = Math.max(0.1, 0.5 - (battleChain.count * 0.05));
        displayEl.style.animation = `chainPulse ${flashSpeed}s infinite alternate`;
    } else {
        displayEl.style.display = 'none';
        // å¦‚æœè¶…æ™‚äº†ï¼Œç‰©ç†æ­¸é›¶
        if (battleChain.count > 0) battleChain.count = 0;
    }
}

// å•Ÿå‹• UI ç›£æ§è¼ªè©¢
setInterval(updateChainUI, 1000);

/**
 * æ ¸å¿ƒä¿®æ­£ï¼šå‹‡è€…å¤–è§€å¯¦è£ç³»çµ± (ä»¿å¤©å ‚åŸä¸»ç‹å† é€²åŒ–å®Œå…¨é«”)
 */
function updateHeroAppearance() {
    const weaponEl = document.getElementById('hero-weapon');
    const hatEl = document.getElementById('hero-hat');
    const accEl = document.getElementById('hero-accessory');
    const bodyEl = document.getElementById('hero-body');
    const avatarEl = document.getElementById('hero-avatar');

    // ç¢ºä¿æ•¸æ“šå­˜åœ¨
    const inv = player.inventory || [];
    const streak = player.kingStreak || 0;

    // --- ğŸ‘‘ 1. ç‰©ç†æ ¸å¿ƒï¼šå¤©å ‚åŸä¸»ç‹å† é€²åŒ–åˆ¤å®š ---
    // å„ªå…ˆæª¢æŸ¥æ˜¯å¦æœ‰ç¬¦åˆé€£å‹ä½éšçš„ç‹å† 
    const crownData = CROWN_EVOLUTION.find(c => streak >= c.streak);

    if (crownData) {
        // A. ç‰©ç†å¯¦è£ï¼šå‹•æ…‹æ›´æ›åœ–æ¨™èˆ‡ CSS ç‰¹æ•ˆé¡åˆ¥
        hatEl.innerText = crownData.icon;
        
        // ç§»é™¤æ‰€æœ‰èˆŠç‰¹æ•ˆ Classï¼Œåƒ…æ›è¼‰ç•¶å‰ä½éšç‰¹æ•ˆ
        const allVfxClasses = CROWN_EVOLUTION.map(c => c.effect);
        hatEl.classList.remove(...allVfxClasses, 'crown-spark'); 
        hatEl.classList.add(crownData.effect);
        
        hatEl.style.display = "block";

        // B. èº«é«”å…‰æšˆç‰©ç†åŒæ­¥ (50 é€£å‹ä»¥ä¸Šæ¿€ç™¼é«”è¡¨èƒ½é‡)
        if (bodyEl) {
            if (streak >= 100) {
                bodyEl.style.filter = "drop-shadow(0 0 15px #fff) drop-shadow(0 0 5px gold) brightness(1.2)";
            } else if (streak >= 50) {
                bodyEl.style.filter = "drop-shadow(0 0 12px #ff4d4d)";
            } else if (streak >= 30) {
                bodyEl.style.filter = "drop-shadow(0 0 8px #f1c40f)";
            } else {
                bodyEl.style.filter = "none";
            }
        }
    } else {
        // --- ç„¡é€£å‹ç‹€æ…‹ï¼šå›æ­¸è£å‚™åˆ¤å®š ---
        if (inv.includes("ğŸ‘‘ è³¢è€…ä¹‹å† ") || inv.includes("ğŸ‘‘ å§‹ç¥–ç‹çš„çœŸçš‡å† ")) {
            hatEl.innerText = "ğŸ‘‘";
            hatEl.classList.add('crown-spark'); // çµ¦äºˆåŸºç¤é–ƒçˆ
            hatEl.style.display = "block";
        } else {
            hatEl.style.display = "none";
        }
        if (bodyEl) bodyEl.style.filter = "none";
    }

    // --- âš”ï¸ 2. ç‰©ç†æª¢æŸ¥æ­¦å™¨ ---
    if (inv.includes("ğŸ”¥ è–åŠï¼šæ—¥æª¢ä¸€æ–‡å­—")) {
        weaponEl.innerText = "ğŸ”¥";
        weaponEl.style.display = "block";
    } else if (inv.includes("ğŸ–‹ï¸ æ™®é€šåŸå­ç­†") || inv.includes("ğŸ–‹ï¸ æ™®é€šçš„åŸå­ç­†")) {
        weaponEl.innerText = "ğŸ–‹ï¸";
        weaponEl.style.display = "block";
    } else {
        weaponEl.style.display = "none";
    }

    // --- ğŸ›¡ï¸ 3. ç‰©ç†æª¢æŸ¥å‰¯æ‰‹/ç›¾ç‰Œ ---
    if (inv.includes("ğŸ›¡ï¸ èªæ³•ä¹‹ç›¾")) {
        accEl.innerText = "ğŸ›¡ï¸";
        accEl.style.display = "block";
    } else {
        accEl.style.display = "none";
    }

    // --- ğŸš¶ 4. æ ¹æ“šç­‰ç´šæ›´æ›è·æ¥­èº«é«” ---
    let currentIcon = "ğŸš¶";
    if (player.lv >= 40) currentIcon = "ğŸ§™â€â™‚ï¸";
    else if (player.lv >= 20) currentIcon = "âš”ï¸";
    else currentIcon = "ğŸš¶";

    if (bodyEl) bodyEl.innerText = currentIcon;
    if (avatarEl) avatarEl.innerText = currentIcon;
}

// ä¿®æ”¹åŸæœ‰çš„ updatePlayerUIï¼Œåœ¨çµå°¾è™•å°å…¥
const originalUpdatePlayerUI = updatePlayerUI;
updatePlayerUI = function() {
    if (typeof originalUpdatePlayerUI === 'function') originalUpdatePlayerUI();
    updateHeroAppearance(); // ç‰©ç†æ›´æ–°å¤–è§€
};


/**
 * è¼”åŠ©å‡½æ•¸ï¼šç›£è½ Google API èˆ‡ GIS å…ƒä»¶ç‹€æ…‹ä¸¦åŸ·è¡ŒåŒæ­¥
 */
function waitForGapiAndCheckLogin() {
    let attempts = 0;
    const checkTimer = setInterval(async () => {
        attempts++;
        
        // --- æ ¸å¿ƒä¿®æ­£ï¼šç‰©ç†åˆ¤å®šæ¢ä»¶è®Šæ›´ ---
        // ä¸å†å°‹æ‰¾ auth2 å¯¦ä¾‹ï¼Œè€Œæ˜¯æª¢æŸ¥ GIS çš„ tokenClient èˆ‡ GAPI Client æ˜¯å¦éƒ½å·²å°±ç·’
        const isGisReady = (typeof google !== 'undefined' && window.tokenClient);
        const isGapiReady = (window.gapi && gapi.client && gapi.client.drive);

        if (isGisReady && isGapiReady) {
            clearInterval(checkTimer);
            console.log("%cğŸ‘¤ é›²ç«¯æœå‹™å…ƒä»¶ç‰©ç†å°±ç·’ï¼ŒåŸ·è¡Œ Session æ¢å¾©...", "color: #3498db; font-weight: bold;");

            // 1. ç‰©ç†å˜—è©¦å¾æœ¬åœ° LocalStorage æ¢å¾© Token
            const savedToken = localStorage.getItem('google_drive_token');
            if (savedToken) {
                try {
                    const { access_token, expires_at } = JSON.parse(savedToken);
                    
                    // æª¢æŸ¥ Token æ˜¯å¦æœ‰æ•ˆ (æœªéæœŸ)
                    if (Date.now() < expires_at) {
                        // ç‰©ç†æ³¨å…¥ Token åˆ° GAPI ç’°å¢ƒ
                        gapi.client.setToken({ access_token: access_token });
                        console.log("âœ… ç‹€æ…‹ï¼šSession å·²ç‰©ç†æ¢å¾©ã€‚");

                        // 2. æ›´æ–° UI ç‹€æ…‹
                        updateCloudUI(true);

                        // 3. åŸ·è¡Œæ•¸æ“šæµï¼šå¾é›²ç«¯è¼‰å…¥ä¸¦åŒæ­¥åˆ°è³‡æ–™åº«
                        await loadGameFromCloud(); 
                        if (typeof savePlayerToDB === 'function') await savePlayerToDB();
                        if (typeof updatePlayerUI === 'function') updatePlayerUI();
                        
                        return; // æˆåŠŸæ¢å¾©ï¼Œè·³å‡ºå‡½æ•¸
                    }
                } catch (e) {
                    console.warn("âš ï¸ Token æ¢å¾©å¤±æ•—ï¼Œéœ€é‡æ–°æ‰‹å‹•ç™»å…¥:", e);
                }
            }
            
            console.log("ğŸ‘‹ ç‹€æ…‹ï¼šç­‰å¾…ä½¿ç”¨è€…é»æ“Šç™»å…¥ã€‚");
            updateCloudUI(false);
            
        }

        // å»¶é•·åˆ¤å®šæ™‚é–“è‡³ 15 ç§’ (30 attempts * 500ms)
        if (attempts >= 30) {
            clearInterval(checkTimer);
            console.log("%câ„¹ï¸ é€²å…¥é›¢ç·šå†’éšªæ¨¡å¼ (é›²ç«¯å…ƒä»¶è¼‰å…¥è¶…æ™‚)", "color: #95a5a6;");
            const statusEl = document.getElementById('cloud-status');
            if (statusEl) statusEl.innerText = "â˜ï¸ é›²ç«¯æœå‹™é›¢ç·š";
        }
    }, 500);
}

/**
 * è¼”åŠ©ï¼šç‰©ç†æ›´æ–°é›²ç«¯ç›¸é—œ UI
 */
function updateCloudUI(isSynced) {
    const authBtn = document.getElementById('auth-btn');
    const syncBtn = document.getElementById('sync-btn');
    const statusEl = document.getElementById('cloud-status');
    const cloudManager = document.getElementById('cloud-manager');

    if (isSynced) {
        if (authBtn) authBtn.innerText = "âœ… å·²é€£ç·š";
        if (syncBtn) syncBtn.style.display = "inline-block";
        if (statusEl) statusEl.innerText = "â˜ï¸ é›²ç«¯åŒæ­¥ä¸­";
        if (cloudManager) cloudManager.style.display = "block";
    } else {
        if (authBtn) authBtn.innerText = "ğŸ”‘ ç™»å…¥ Google";
        if (syncBtn) syncBtn.style.display = "none";
        if (statusEl) statusEl.innerText = "é›²ç«¯æœªé€£ç·š";
    }
}

// è¼”åŠ©ï¼šæª¢æŸ¥æ—¥æœŸä¸¦ç”Ÿæˆæ¯æ—¥ä»»å‹™
function checkAndGenerateDailyQuest() {
    const today = new Date().toLocaleDateString();
    const lastDate = localStorage.getItem('tabi_quest_date');
    
    // å¦‚æœæ—¥æœŸè®Šäº†ï¼Œæˆ–è€…æ˜¯ç¬¬ä¸€æ¬¡ç©ï¼Œå°±ç”Ÿæˆæ–°ä»»å‹™
    if (lastDate !== today || !dailyQuest || dailyQuest.text === "æ­£åœ¨è¯çµ¡å…¬æœƒä¸­...") {
        generateDailyQuest();
        localStorage.setItem('tabi_quest_date', today);
        console.log("ğŸ“œ å…¬æœƒç™¼å¸ƒäº†æ–°çš„è³é‡‘ä»»å‹™ï¼");
    } else {
        updateQuestUI(); // å¦å‰‡åªæ›´æ–°ä»‹é¢
    }
}


// --- â›ª æ•™å ‚æœå‹™é‚è¼¯ ---
async function churchService(type) {
    if (type === 'heal') {
        if (player.coin < 20) return showNotification("ğŸ’° é‡‘å¹£ä¸è¶³ä»¥æ”¯ä»˜é†«ç™‚è²»");
        player.coin -= 20;
        battleData.heroHP = 100; // ç‰©ç†æ¢å¾©æ»¿è¡€
        updateBattleUI(); // æ›´æ–°æˆ°é¬¥ä»‹é¢è¡€æ¢
        showNotification("âœ¨ è–å…‰é™è‡¨ï¼HP å·²å®Œå…¨æ¢å¾©");
    } 
    
    else if (type === 'pray') {
        if (player.coin < 50) return showNotification("ğŸ’° é‡‘å¹£ä¸è¶³ä»¥é€²è¡Œå¤§å‹ç¦±å‘Š");
        player.coin -= 50;
        
        // ç‰©ç†æ•ˆæœï¼šæŒçºŒ 5 åˆ†é˜çš„ Buff
        player.isPraying = true;
        const originalRate = encounterRate;
        encounterRate = 0.15; // é‡æ•µç‡ç‰©ç†é™ä½
        
        showNotification("ğŸ™ ç¦±å‘ŠæˆåŠŸï¼è–å…‰åº‡è­·ä¸­ (é˜²ç¦¦æå‡ & é‡æ•µç‡é™ä½)");
        
        // 5 åˆ†é˜å¾Œç‰©ç†å¤±æ•ˆ
        setTimeout(() => {
            player.isPraying = false;
            encounterRate = originalRate;
            showNotification("â³ ç¦±å‘Šçš„åº‡è­·æ•ˆæœå·²æ¶ˆå¤±...");
        }, 300000);
    }
    
    if (typeof updatePlayerUI === 'function') updatePlayerUI();
    if (typeof savePlayerToDB === 'function') await savePlayerToDB();
}

// --- ğŸ§´ é“å…·è³¼è²·ç³»çµ± ---
function buyItem(itemType) {
    // ç‰©ç†åˆå§‹åŒ–èƒŒåŒ…
    player.items = player.items || { potion: 0, antidote: 0 };
    
    const costs = { potion: 10, antidote: 8 };
    if (player.coin >= costs[itemType]) {
        player.coin -= costs[itemType];
        player.items[itemType]++;
        showNotification(`ğŸ›’ è³¼è²·æˆåŠŸï¼ç²å¾—äº† ${itemType === 'potion' ? 'è£œè¡€è—¥æ°´' : 'è§£æ¯’åŠ‘'}`);
    } else {
        showNotification("ğŸ’° é‡‘å¹£ä¸è¶³ï¼");
    }
    
    if (typeof updatePlayerUI === 'function') updatePlayerUI();
}

// 2. ç‰©ç†åˆ¤å®šï¼šæª¢æŸ¥å‹³ç« è§£é–
function checkMedalUnlock() {
    let unlockedAnything = false;
    
    // è³é‡‘ä»»å‹™æ•¸é‡åˆ¤å®š (å‡è¨­ player.logs ç´€éŒ„äº† [è³é‡‘] æ¬¡æ•¸)
    const bountyCount = player.logs.filter(log => log.boss.includes("[è³é‡‘]")).length;
    
    MEDAL_MASTER.forEach(m => {
        if (!player.medals.includes(m.id)) {
            let condition = false;
            if (m.id === 'bounty_10' && bountyCount >= 10) condition = true;
            if (m.id === 'streak_7' && player.streak >= 7) condition = true;
            if (m.id === 'lv_50' && player.lv >= 50) condition = true;

            if (condition) {
                player.medals.push(m.id);
                unlockedAnything = true;
                showNotification(`ğŸ† ç²å¾—å‹³ç« ï¼šã€${m.name}ã€‘ï¼`);
            }
        }
    });

    if (unlockedAnything) {
        updateMedalUI();
        saveGameToCloud();
    }
}

// 3. æ¸²æŸ“å‹³ç« ç‰†èˆ‡ç‰¹æ•ˆ
function updateMedalUI() {
    const list = document.getElementById('medal-list');
    const dropInfo = document.getElementById('drop-rate-info');
    const flame = document.getElementById('streak-flame');
    
    let totalBonus = 0;
    list.innerHTML = MEDAL_MASTER.map(m => {
        const isUnlocked = player.medals.includes(m.id);
        if (isUnlocked) totalBonus += m.bonus;
        return `<div class="medal-icon ${isUnlocked ? 'medal-unlocked' : ''}" title="${m.name}: ${m.desc}">${m.icon}</div>`;
    }).join('');

    dropInfo.innerText = `ç›®å‰æ‰å¯¶ç‡åŠ æˆï¼š+${Math.round(totalBonus * 100)}%`;

    // æ›´æ–°ç«ç„°ç‰¹æ•ˆ
    flame.className = "flame-effect";
    if (player.streak >= 14) flame.classList.add('flame-high');
    else if (player.streak >= 7) flame.classList.add('flame-mid');
    else if (player.streak >= 1) flame.classList.add('flame-low');
}

// åˆ¤å®šé€£çºŒç™»å…¥èˆ‡ä»»å‹™å®Œæˆ
function updateStreak() {
    const today = new Date().toLocaleDateString();
    
    if (player.lastQuestDate === "") {
        player.streak = 1; // ç¬¬ä¸€æ¬¡å®Œæˆ
    } else {
        const last = new Date(player.lastQuestDate);
        const now = new Date(today);
        const diffTime = Math.abs(now - last);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

        if (diffDays === 1) {
            player.streak += 1; // é€£çºŒå®Œæˆ
        } else if (diffDays > 1) {
            player.streak = 1; // ä¸­æ–·ï¼Œé‡è¨ˆ
        }
    }
    player.lastQuestDate = today;
    updatePlayerUI(); // åˆ·æ–° UI èˆ‡ç«ç„°
}


// æ€ªç‰©éš¨æ©Ÿèµ°éèƒŒæ™¯çš„é‚è¼¯
function startEnemyLoop() {
    setInterval(() => {
        const enemy = document.getElementById('enemy-sprite');
        // åˆ¤å®šï¼šå¦‚æœæ€ªç‰©ç›®å‰ä¸åœ¨æˆ°é¬¥ä½ç½®ï¼ˆright: -50pxï¼‰ï¼Œä¸”æ©Ÿç‡é€šé
        if (enemy && (enemy.style.right === "-50px" || enemy.style.right === "") && Math.random() > 0.6) {
            enemy.innerText = ["ğŸ‘¾", "ğŸ‰", "ğŸ‘¹", "ğŸ‘»", "ğŸ¦Š"][Math.floor(Math.random()*5)];
            enemy.style.transition = "4s linear"; // ç·©æ…¢èµ°é
            enemy.style.right = "110%"; // å¾å³èµ°åˆ°å·¦æ¶ˆå¤±
            
            // èµ°å®Œå¾Œæ‚„æ‚„å›åˆ°åŸä½ç­‰å¾…ä¸‹æ¬¡å‡ºç¾
            setTimeout(() => {
                enemy.style.transition = "none";
                enemy.style.right = "-50px";
            }, 4100);
        }
    }, 8000); // æ¯ 8 ç§’åˆ¤å®šä¸€æ¬¡
}


// 2. éš¨æ©Ÿç”Ÿæˆä»Šæ—¥ä»»å‹™
function generateDailyQuest() {
    const questPool = [
        { type: "grammar", target: "å—èº«å½¢", text: "è¤‡ç¿’ 5 å€‹å¸¶æœ‰ã€å—èº«å½¢ã€çš„å–®å­—" },
        { type: "grammar", target: "ä½¿å½¹å½¢", text: "è¤‡ç¿’ 5 å€‹å¸¶æœ‰ã€ä½¿å½¹å½¢ã€çš„å–®å­—" },
        { type: "grammar", target: "æ•¬èª", text: "è¤‡ç¿’ 5 å€‹å¸¶æœ‰ã€æ•¬èªã€çš„ç‰‡èª" },
        { type: "count", target: "any", text: "åœ¨è¤‡ç¿’ä¸­å¿ƒç¿»é–‹ 15 å¼µå¡ç‰‡" }
    ];

    const picked = questPool[Math.floor(Math.random() * questPool.length)];
    dailyQuest = {
        ...picked,
        targetCount: picked.type === "count" ? 15 : 5,
        currentCount: 0,
        isCompleted: false,
        bonusActive: false
    };
    updateQuestUI();
}

// 3. ç‰©ç†åˆ¤å®šï¼šèˆ‡è¤‡ç¿’ä¸­å¿ƒé€£å‹•
// åœ¨ä½ çš„ loadFlashcards å…§çš„ card.onclick é‚è¼¯ä¸­åŠ å…¥æ­¤å‘¼å«
function trackQuestProgress(item) {
    if (dailyQuest.isCompleted) return;

    if (dailyQuest.type === "count") {
        dailyQuest.currentCount++;
    } else if (dailyQuest.type === "grammar") {
        // æª¢æŸ¥å–®å­—æˆ–ç‰‡èªå…§å®¹æ˜¯å¦åŒ…å«ç›®æ¨™é—œéµå­—
        if (item.jp.includes(dailyQuest.target) || item.ch.includes(dailyQuest.target)) {
            dailyQuest.currentCount++;
        }
    }

    if (dailyQuest.currentCount >= dailyQuest.targetCount) {
        completeQuest();
    }
    updateQuestUI();
}

function completeQuest() {
    dailyQuest.isCompleted = true;
    dailyQuest.bonusActive = true;
    showNotification("ğŸ† ä»»å‹™å®Œæˆï¼ç²å¾—é›™å€ EXP åŠ æˆï¼");
}

function updateQuestUI() {
    // 1. å–å¾—æ‰€æœ‰ä»»å‹™ UI å…ƒä»¶
    const descEl = document.getElementById('quest-description');
    const barEl = document.getElementById('quest-progress-bar');
    const statusEl = document.getElementById('quest-status');
    const rewardEl = document.getElementById('quest-reward');

    // 2. ğŸ”¥ ã€ç‰©ç†å®‰å…¨æª¢æŸ¥ã€‘
    if (!descEl || !barEl || !statusEl || !rewardEl) {
        console.warn("âš ï¸ æ¯æ—¥ä»»å‹™ UI å…ƒä»¶å°šæœªå®Œå…¨è¼‰å…¥æˆ– ID éŒ¯èª¤ï¼Œè·³éæ›´æ–°ã€‚");
        return; 
    }

    // 3. ğŸ”¥ ã€æ ¸å¿ƒæ–°å¢ï¼šç‰©ç†è¶…é€£çµåŒ–ã€‘
    // è®“æ–‡å­—çœ‹èµ·ä¾†å¯é»æ“Šï¼Œä¸¦ç¶å®šè·³è½‰åŠŸèƒ½
    descEl.innerText = dailyQuest.text || "æ­£åœ¨è¯çµ¡å…¬æœƒä¸­...";
    descEl.style.cursor = "pointer";
    descEl.style.textDecoration = "underline dotted"; // å¢åŠ è¦–è¦ºæç¤º
    
    descEl.onclick = () => {
        if (dailyQuest.isCompleted) {
            showNotification("âœ… ä»»å‹™å·²å®Œæˆï¼Œå‹‡è€…è¾›è‹¦äº†ï¼");
            return;
        }
        // åŸ·è¡Œç‰©ç†è·³è½‰èˆ‡ç¯©é¸å¼•æ“
        executeQuestJump(); 
    };

    // 4. åŸ·è¡Œé€²åº¦æ¸²æŸ“
    const progress = Math.min((dailyQuest.currentCount / dailyQuest.targetCount) * 100, 100);
    barEl.style.width = progress + "%";
    
    statusEl.innerText = `${dailyQuest.currentCount} / ${dailyQuest.targetCount}`;
    rewardEl.style.display = dailyQuest.bonusActive ? "block" : "none";

    // 5. å®Œæˆç‹€æ…‹è¦–è¦ºå›é¥‹
    if (dailyQuest.isCompleted) {
        barEl.style.backgroundColor = "#27ae60"; // æˆåŠŸç¶ 
        descEl.style.textDecoration = "none";
    } else {
        barEl.style.backgroundColor = "#e67e22"; // é€²è¡Œä¸­æ©˜
    }
}

/**
 * ğŸ”¥ ã€ç‰©ç†ç‡ƒæ–™æ¢æ¸¬å¼•æ“ã€‘è‡ªå‹•å°èˆªã€çµæ§‹è¦ç¯„æŒ‡ä»¤è¤‡è£½ç‰ˆ
 */
async function executeQuestJump() {
    const targetTerm = dailyQuest.target || "";
    const descEl = document.getElementById('quest-description');
    
    // 0. ç‰©ç†æ’é™¤é€šç”¨ä»»å‹™
    if (!targetTerm || targetTerm === "any") {
        showNotification("ğŸš€ æ­£åœ¨é–‹å•Ÿè¤‡ç¿’ä¸­å¿ƒ...");
        openFlashcards();
        return;
    }

    // 1. ğŸ”¥ ã€ç‰©ç†æƒæã€‘æª¢æŸ¥ IndexedDB
    const allPacks = await db.fuelPacks.toArray();
    let localMatchCount = 0;
    
    allPacks.forEach(pack => {
        const vocabMatches = (pack.vocab || []).filter(v => v.w.includes(targetTerm) || v.m.includes(targetTerm));
        const phraseMatches = (pack.phrases || []).filter(p => p.jp.includes(targetTerm) || p.ch.includes(targetTerm));
        localMatchCount += (vocabMatches.length + phraseMatches.length);
    });

    // 2. ğŸ”¥ ã€è­¦å ±åˆ¤å®šèˆ‡ç¯„ä¾‹æŒ‡ä»¤è¤‡è£½ã€‘
    if (localMatchCount === 0) {
        if (descEl) descEl.classList.add('fuel-alert-active');
        
        const level = currentMapDifficulty.replace("-EX", "") || "N3";

        // æ ¸å¿ƒä¿®æ­£ï¼šå°‡ã€Œç‰©ç†æ ¼å¼ç¯„ä¾‹ã€ç›´æ¥å¯«å…¥ Promptï¼Œé˜²æ­¢ AI äº‚æ”¹çµæ§‹
        const autoPrompt = `ä»»å‹™ï¼šå°‡ä»¥ä¸‹å…§å®¹è½‰ç‚º Tabi-Satori V3 æ¨™æº– JSONã€‚
ç›®æ¨™ï¼šåŒ…å«è‡³å°‘ 5 å€‹å¸¶æœ‰ã€${targetTerm}ã€çš„èªæ³•å…§å®¹ã€‚
ç­‰ç´šï¼š${level}

[åš´æ ¼éµå®ˆä»¥ä¸‹ JSON çµæ§‹]ï¼š
{
  "name": "é—œæ–¼ ${targetTerm} çš„æ–‡ç« æ¨™é¡Œ",
  "difficulty": "${level}",
  "notes": "æ–‡ç« å…§æ–‡ï¼Œæ¼¢å­—éœ€æ¨™è¨» <ruby>æ¼¢<rt>ã‹ã‚“</rt>å­—<rt>ã˜</rt></ruby>",
  "vocab": [
    { "w": "å–®å­—<ruby>æ¼¢<rt>ã‹ã‚“</rt>å­—<rt>ã˜</rt></ruby>", "m": "æ„ç¾©", "e1": "ä¾‹å¥ä¸€", "e2": "ä¾‹å¥äºŒ" }
  ],
  "phrases": [
    { "jp": "${targetTerm}ç›¸é—œç‰‡èª", "ch": "ä¸­æ–‡è§£é‡‹" }
  ],
  "exam": [
    { "q": "å•é¡Œï¼Ÿ", "o": ["é¸é …0", "é¸é …1", "é¸é …2", "é¸é …3"], "a": 0, "type": "grammar" }
  ]
}`;

        navigator.clipboard.writeText(autoPrompt);

        const goToAI = confirm(`ğŸš¨ ç‡ƒæ–™åº«å­˜ä¸è¶³ï¼\n\nç›®å‰æ‰¾ä¸åˆ°ã€${targetTerm}ã€çš„å…§å®¹ã€‚\nç³»çµ±å·²è‡ªå‹•è¤‡è£½ã€Œæ¨™æº–æ ¼å¼ã€AI æŒ‡ä»¤ï¼Œæ˜¯å¦å‰å¾€ AI è£œçµ¦ç«™ï¼Ÿ`);
        
        if (goToAI) {
            window.open('https://gemini.google.com/', '_blank');
            showNotification("ğŸ›°ï¸ è«‹ç›´æ¥è²¼ä¸ŠæŒ‡ä»¤ï¼ŒAI å°‡ç”¢å‡ºæ¨™æº–æ ¼å¼ç‡ƒæ–™ï¼");
        }
        
        setTimeout(() => { if (descEl) descEl.classList.remove('fuel-alert-active'); }, 5000);
        return;
    }

    // 3. âœ… ã€å°èˆªæµç¨‹ã€‘(ç•¥ï¼Œä¿æŒæ‚¨åŸæœ‰çš„éæ¿¾é‚è¼¯)
    showNotification(`ğŸ” æ¢æ¸¬åˆ°åº«å­˜ï¼æ­£åœ¨éæ¿¾ã€${targetTerm}ã€å…§å®¹...`);
    await openFlashcards();
    const limitEl = document.getElementById('card-limit');
    if (limitEl) { limitEl.value = "0"; await loadFlashcards(); }
    setTimeout(() => {
        const cards = document.querySelectorAll('.flip-card');
        cards.forEach(card => {
            if (card.innerText.includes(targetTerm)) {
                card.style.display = "block";
                card.querySelector('.flip-card-inner').style.boxShadow = "0 0 20px #f1c40f";
            } else { card.style.display = "none"; }
        });
    }, 400);
}

// --- âš”ï¸ å‹‡è€…æ”»æ“Šå‹•ç•« (ç´™å¨ƒå¨ƒèˆ‡è£å‚™ç‰¹æ•ˆé€£å‹•ç‰ˆ) ---
function triggerHeroAttack() {
    const hero = document.getElementById('hero-sprite');
    const enemy = document.getElementById('enemy-sprite');
    const heroBody = document.getElementById('hero-body');
    const heroWeapon = document.getElementById('hero-weapon');
    
    if (!hero || !enemy || !heroBody) return;

    // A. æ€ªç‰©å‡ºç¾åœ¨æˆ°é¬¥ä½ç½®
    const monsterPool = ["ğŸ‘¾", "ğŸ‰", "ğŸ‘¹", "ğŸ‘»", "ğŸ¦‡", "ğŸ§›"];
    enemy.innerText = monsterPool[Math.floor(Math.random() * monsterPool.length)];
    enemy.style.transition = "0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275)"; // å½ˆå…¥æ•ˆæœ
    enemy.style.right = "25%";

    setTimeout(() => {
        // B. å‹‡è€…çªé€² (ç‰©ç†ä½ç§»)
        hero.style.transition = "0.2s cubic-bezier(0.6, -0.28, 0.735, 0.045)";
        hero.style.transform = "translateX(100px) rotate(10deg)";
        
        // åˆ‡æ›èº«é«”è¡¨æƒ…ç‚ºæˆ°é¬¥æ…‹
        const originalBody = heroBody.innerText;
        heroBody.innerText = "âš¡"; 

        // æª¢æŸ¥è£å‚™ï¼šå¦‚æœæœ‰è–åŠï¼Œå¢åŠ é–ƒçˆç‰¹æ•ˆ
        const hasHolySword = (player.inventory || []).includes("ğŸ”¥ è–åŠï¼šæ—¥æª¢ä¸€æ–‡å­—");
        if (hasHolySword && heroWeapon) {
            heroWeapon.style.filter = "drop-shadow(0 0 15px orange) brightness(2)";
        }

        setTimeout(() => {
            // C. ç‰©ç†æ“Šä¸­æ„Ÿï¼šæ€ªç‰©éœ‡å‹•èˆ‡çˆ†ç‚¸
            enemy.innerText = "ğŸ’¥";
            enemy.style.transform = "scale(1.8) rotate(15deg)";
            
            // éœ‡å‹•èƒŒæ™¯ç•«é¢ (è¢å¹•æŠ–å‹•ç‰©ç†æ•ˆæœ)
            const screen = document.getElementById('adventure-screen');
            if (screen) {
                screen.style.animation = "screenShake 0.2s";
                setTimeout(() => screen.style.animation = "", 200);
            }

            setTimeout(() => {
                // D. æˆ°å¾Œå¾©åŸèˆ‡æ’¤é€€
                hero.style.transition = "0.5s ease-out";
                hero.style.transform = "translateX(0px) rotate(0deg)";
                
                enemy.style.transition = "0.4s ease-in";
                enemy.style.right = "-120px";
                enemy.style.transform = "scale(1) rotate(0deg)";
                
                // é‚„åŸèº«é«”è¡¨æƒ…
                heroBody.innerText = originalBody;
                if (hasHolySword && heroWeapon) {
                    heroWeapon.style.filter = "drop-shadow(2px 2px 2px rgba(0,0,0,0.3))";
                }
            }, 300);
        }, 150);
    }, 500);
}


/**
 * ğŸ—ºï¸ åœ°åœ–å‚³é€ç¸½æ§ä¸­å¿ƒ (Master Travel Controller)
 * è² è²¬èª¿åº¦æ¬Šé™æª¢æŸ¥ã€å ´æ™¯åˆ‡æ›èˆ‡å­ç³»çµ±å•Ÿå‹•
 */
async function travelTo(difficulty) {
    console.log(`ğŸ—ºï¸ å˜—è©¦å‰å¾€å€åŸŸ: ${difficulty}`);

    // 1. ğŸ›¡ï¸ æ¬Šé™èˆ‡é–€æª»æª¢æŸ¥ (Gatekeeper)
    if (!checkTravelPermission(difficulty)) return;

    // 2. â™»ï¸ ç‹€æ…‹ç‰©ç†é‡ç½® (Physical Reset)
    resetPlayerState();
    
    // 3. ğŸŒ å ´æ™¯åˆ‡æ›èˆ‡æ ¸å¿ƒå•Ÿå‹• (Scene Dispatch)
    // æ ¹æ“šç›®çš„åœ°åˆ†æµåˆ°å°ˆå±¬å­ç¨‹åº
    if (difficulty === "Home") {
        setupHomeScene();
    } else if (difficulty === "BloodyKingdom") {
        setupPokerScene();
    } else {
        setupAdventureScene(difficulty);
    }

    // 4. ğŸ’¾ æ•¸æ“šåŒæ­¥ (Data Sync)
    currentMapDifficulty = difficulty;
    syncMapUI(difficulty);
    
    if (typeof savePlayerToDB === 'function') await savePlayerToDB();
    if (typeof updatePlayerUI === 'function') updatePlayerUI();
}

// =========================================
// ğŸ›¡ï¸ å­å‡½æ•¸ Aï¼šæ¬Šé™é–€è¡› (Permission Check)
// =========================================
function checkTravelPermission(difficulty) {
    // è¡€è…¥ç‹åœ‹é–€æª»ï¼š100G (å¥´éš¸é™¤å¤–)
    if (difficulty === "BloodyKingdom") {
        const heroRank = (pokerGame.players && pokerGame.players.find(p => p.id === 'player')) ? 
                         pokerGame.players.find(p => p.id === 'player').rank : "citizen";
                         
        if (player.coin < 100 && heroRank !== "slave") {
            showNotification("ğŸ©¸ å®ˆé–€äººï¼šé–€ç¥¨è¦ 100Gï¼Œèº«ç„¡åˆ†æ–‡çš„çª®é¬¼æ»¾å›å»ï¼");
            return false;
        }
    }
    return true;
}

// =========================================
// â™»ï¸ å­å‡½æ•¸ Bï¼šç‹€æ…‹é‡ç½® (State Reset)
// =========================================
function resetPlayerState() {
    // å–šé†’ä¼‘æ¯ä¸­çš„ç©å®¶
    if (player.isResting) {
        player.isResting = false;
        if (window.bedTimer) {
            clearTimeout(window.bedTimer);
            window.bedTimer = null;
            if (typeof applyWakeUpEffect === 'function') applyWakeUpEffect();
        }
    }

    // æ¸…ç†è¨ˆæ™‚å™¨
    if (window.homeRestTimer) clearInterval(window.homeRestTimer);
    if (window.encounterTimer) clearInterval(window.encounterTimer);
}

// =========================================
// ğŸ  å­å‡½æ•¸ Cï¼šè¨­ç½®å®¶åœ’å ´æ™¯ (Home Setup)
// =========================================
function setupHomeScene() {
    updateSceneMode('HOME');
    encounterRate = 0;
    
    const hero = document.getElementById('hero-sprite');
    if (hero) {
        // ç‰©ç†ä½ç½®æ ¡æº–
        hero.style.left = "45%";
        hero.classList.remove('walking'); // åœæ­¢èµ°è·¯
    }
    
    showNotification("ğŸ  å›å®¶äº†ã€‚");
}

// =========================================
// ğŸƒ å­å‡½æ•¸ Dï¼šè¨­ç½®è³­å ´å ´æ™¯ (Poker Setup)
// =========================================
function setupPokerScene() {
    updateSceneMode('POKER');
    encounterRate = 0;
    
    const heroBody = document.getElementById('hero-body');
    if (heroBody) heroBody.innerText = "ğŸƒ"; 

    // åˆå§‹åŒ–æ’²å…‹æ¡Œ (å¦‚æœé‚„ä¸å­˜åœ¨)
    let pokerTable = document.getElementById('poker-table');
    if (!pokerTable) {
        pokerTable = document.createElement('div');
        pokerTable.id = 'poker-table';
        pokerTable.style = "position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index:11000; display:flex; flex-direction:column; align-items:center; justify-content:center; color:white; font-family:monospace;";
        document.body.appendChild(pokerTable);
    }
    
    pokerTable.style.display = 'flex';
    pokerTable.innerHTML = `<div style="text-align:center;"><div class="loading-spinner"></div><h2 style="color:#ff4d4d;">ğŸ©¸ è¡€è…¥ç‹åœ‹ï¼šéšç´šè½‰ç›¤å•Ÿå‹•ä¸­...</h2><p>æ­£åœ¨æ ¸å°èº«ä»½èˆ‡è³‡ç”¢...</p></div>`;

    // å»¶é²é€²å…¥ (æ¨¡æ“¬è®€å–)
    setTimeout(() => {
        if (typeof enterPokerArena === 'function') {
            enterPokerArena();
        } else {
            console.error("âŒ ç³»çµ±ç‰©ç†ç¼ºå¤±ï¼šæ‰¾ä¸åˆ° enterPokerArena");
            if (typeof startPokerGame === 'function') startPokerGame();
        }
    }, 1000);
}

/**
 * âš”ï¸ å­å‡½æ•¸ Eï¼šè¨­ç½®å†’éšªå ´æ™¯ (Adventure Setup)
 * ä¿®æ­£ï¼šç‚ºä¸åŒé›£åº¦è³¦äºˆç¨ç‰¹çš„èƒŒæ™¯è¦–è¦º
 */
function setupAdventureScene(difficulty) {
    // 1. åˆ‡æ›æ¨¡å¼ (é€™æœƒéš±è—å®¶å…·)
    updateSceneMode('ADVENTURE');
    
    // 2. è¨­å®šé‡æ•µç‡
    encounterRate = (difficulty === "N0") ? 0.8 : 0.5;
    
    // 3. ğŸ”¥ ã€ç‰©ç†èƒŒæ™¯æ˜ å°„ã€‘
    const bgStyles = {
        // N5 åˆå¿ƒè€…ä¹‹æ£®ï¼šæ¸…æ–°çš„æ£®æ—ç¶ æ¼¸å±¤
        "N5": "linear-gradient(to bottom, #87ceeb 0%, #2ecc71 100%)",
        
        // N4 è¿·éœ§æ£®æ—ï¼šæ·±é‚ƒçš„è—ç¶ è‰²
        "N4": "linear-gradient(to bottom, #3498db 0%, #16a085 100%)",
        
        // N3 å·¨äººä¹‹å³°ï¼šè’æ¶¼çš„åœŸé»ƒè‰²
        "N3": "linear-gradient(to bottom, #f1c40f 0%, #d35400 100%)",
        
        // N2 å‡œå†¬è¦å¡ï¼šå¯’å†·çš„å†°è—è‰²
        "N2": "linear-gradient(to bottom, #bdc3c7 0%, #2c3e50 100%)",
        
        // N1 ç†¾ç‚é­”åŸï¼šå±éšªçš„ç´…é»‘è‰²
        "N1": "linear-gradient(to bottom, #e74c3c 0%, #c0392b 100%)",
        
        // N0 çœ¾ç¥éºå€ï¼šç¥ç§˜çš„æ˜Ÿç©ºé»‘
        "N0": "linear-gradient(to bottom, #000000 0%, #434343 100%)"
    };

    const screen = document.getElementById('adventure-screen');
    if (screen) {
        // å¥—ç”¨å°æ‡‰èƒŒæ™¯ï¼Œè‹¥ç„¡å‰‡ç”¨é è¨­å¤©è—è‰²
        screen.style.background = bgStyles[difficulty] || "#87ceeb";
        screen.style.animation = "none"; // æ¸…é™¤ä»»ä½•æ®˜ç•™å‹•ç•«
    }

    // 4. æ›´æ–°å‹‡è€…ç‹€æ…‹ (è¡¨æƒ…èˆ‡å‹•ä½œ)
    const heroBody = document.getElementById('hero-body');
    const hero = document.getElementById('hero-sprite');
    
    if (heroBody) {
        if (player.tempStatus === "grumpy") heroBody.innerText = "ğŸ’¢";
        else if (player.tempStatus === "dizzy") heroBody.innerText = "ğŸ˜µ";
        else heroBody.innerText = (player.lv >= 40) ? "ğŸ§™â€â™‚ï¸" : (player.lv >= 20 ? "âš”ï¸" : "ğŸš¶");
    }
    
    if (hero) {
        hero.style.left = "10%";
        hero.classList.add('walking'); // é–‹å§‹èµ°è·¯
    }

    showNotification(`ğŸ§­ æŠµé” ${difficulty} å€åŸŸï¼`);
    if (typeof startHeroAnimation === 'function') startHeroAnimation();
}

// =========================================
// ğŸ”„ å­å‡½æ•¸ Fï¼šUI åŒæ­¥ (UI Sync)
// =========================================
function syncMapUI(difficulty) {
    // åŒæ­¥ä¸‹æ‹‰é¸å–® (å¦‚æœæœ‰)
    const mapSelector = document.getElementById('map-selector');
    if (mapSelector) mapSelector.value = difficulty;
    
    // å¦‚æœåœ°åœ–å½ˆçª—æ˜¯é–‹è‘—çš„ï¼Œé‡æ–°æ¸²æŸ“å…§å®¹ä»¥æ›´æ–°ä½ç½®
    const mapPopup = document.getElementById('adventure-map-popup');
    if (mapPopup && window.getComputedStyle(mapPopup).display !== 'none') {
        if (typeof renderAdventureMap === 'function') renderAdventureMap();
    }
}


/**
 * ğŸƒ å•Ÿå‹•è¡€è…¥ç‰Œå±€ï¼šåŒ…åœç¶²æª„æ–‡ã€è‡ªå‹•é»ç«èˆ‡æƒ…å ±åŒæ­¥
 * ä¿®æ­£ï¼šå°å…¥ã€Œæª„æ–‡å¾è¨ã€è¦–è¦ºäº‹ä»¶ã€è§£æ±ºéåŒæ­¥æ•¸æ“šä¸åŒæ­¥å°è‡´åŒ…åœç¶²ä¸å•Ÿå‹•çš„ Bug
 */
async function startPokerGame() {
    console.log("%cğŸš© ç‰©ç†å¼•æ“ï¼šåˆå§‹åŒ–æ¬ŠåŠ›éŠæˆ²...", "color: #2ecc71; font-weight: bold;");

    // 0. ğŸ”¥ ã€ç‰©ç†ç’°å¢ƒæ·¨åŒ–ã€‘
    window.isGameEnding = false;
    pokerGame.gameActive = true; 
    window.pendingRevolution = false; 
    
    // æ•¸æ“šå…¨ç‰©ç†é‡ç½®
    pokerGame.currentTable = [];
    pokerGame.lastMoveCards = [];
    pokerGame.lastMovePattern = null;
    pokerGame.lastPlayerName = "NONE"; 
    pokerGame.passCount = 0;
    pokerGame.activeBoon = null;  
    pokerGame.isChaosStart = false; 
    window.selectedCards = []; 
    
    pokerGame.players.forEach(p => {
        p.hasGiftedThisRound = false; 
        p.cards = []; 
        p.isPassed = false; 
        p.lastTalk = ""; 
    });

    // ğŸ”¥ ã€é—œéµä¿®æ­£ã€‘å¼·åˆ¶éåŒæ­¥ç­‰å¾…ï¼Œç¢ºä¿ä¸Šä¸€å±€çš„ kingStreak æ•¸æ“šå·²å®Œå…¨å¯«å…¥ IndexedDB/player ç‰©ä»¶
    await new Promise(resolve => setTimeout(resolve, 80));

    // --- ğŸ©¸ 1. ã€ç‰©ç†æ ¸å¿ƒï¼šç‹æ¬ŠåŒ…åœç¶²èˆ‡æª„æ–‡è§¸ç™¼ã€‘ ---
    // ç‰©ç†å°é½Šï¼šåˆä½µå¤šå€‹æ•¸æ“šæºç¢ºä¿é€£èŠæ•¸ 100% æº–ç¢º
    const actualStreak = Math.max(player.kingStreak || 0, pokerGame.playerKingStreak || 0);
    const hero = pokerGame.players.find(p => p.id === 'player');
    
    // åˆ¤å®šæ¢ä»¶ï¼šå‹‡è€…æ˜¯åœ‹ç‹ ä¸” (é€£èŠ >= 3 æˆ– å…·å‚™å¼·åˆ¶æ——æ¨™)
    if (hero && hero.rank === 'king' && (actualStreak >= 3 || pokerGame.forceSiege)) {
        pokerGame.isKingSiege = true;
        
        // ğŸ“œ ç‰©ç†é»ç«ï¼šå•Ÿå‹•ã€Œæª„æ–‡å¾è¨ã€è¦–è¦ºäº‹ä»¶
        if (typeof window.triggerSiegeAnnouncement === 'function') {
            window.triggerSiegeAnnouncement();
        } else {
            addBattleLog(`ğŸš¨ <b style="color:#ff4d4d;">[æª„æ–‡] åœ‹ç‹åŒ…åœç¶²æˆç«‹</b>ï¼šé€£èŠ ${actualStreak} å±€ï¼ŒåæŠ—è»é›†çµï¼`);
            showNotification("âš–ï¸ ã€åœ‹ç‹åŒ…åœç¶²ã€‘æª„æ–‡å·²ä¸‹é”ï¼");
        }
    } else {
        pokerGame.isKingSiege = false;
    }

    // --- ğŸƒ 2. ç‰©ç†æ´—ç‰Œèˆ‡ç™¼ç‰Œç›£æ§ ---
    initPokerDeck(); 
    console.group("%cğŸ“¦ ç‰©ç†ç™¼ç‰Œç›£æ§ï¼šåŸå§‹åˆ†ç™¼", "color: #3498db; font-weight: bold;");

    for (let i = 0; i < 13; i++) {
        pokerGame.players.forEach(p => {
            if (pokerGame.deck.length > 0) p.cards.push(pokerGame.deck.pop());
        });
    }

    // ğŸ”¥ ã€è³‡æºè£œçµ¦ã€‘åŒ…åœç¶²æœŸé–“ï¼ŒåæŠ—è»ç‰©ç†ç²å– Joker åŠ©æˆ° (ç›Ÿç´„è³‡æº)
    if (pokerGame.isKingSiege) {
        pokerGame.players.forEach(p => {
            if (p.rank !== 'king') {
                const currentJokers = p.cards.filter(c => c.value === 'JOKER').length;
                if (currentJokers === 0) {
                    // è³¦äºˆ fromSiege å±¬æ€§ä»¥è§¸ç™¼æ¸²æŸ“ç‰¹æ•ˆ
                    p.cards.push({ suit: 'ğŸƒ', value: 'JOKER', power: 150, label: 'JOKER', fromSiege: true });
                    console.log(`ğŸ¤ [è¡€ç›Ÿ] ç§˜å¯†æŠ•éç‰©è³‡çµ¦ ${p.name}`);
                }
            }
        });
    }

    pokerGame.players.forEach(p => p.cards.sort((a, b) => a.power - b.power));
    console.groupEnd();

    // 3. ğŸ”¥ ã€ç‰©ç†åŒæ­¥æ¸²æŸ“ã€‘
    const table = document.getElementById('poker-table');
    if (table) renderPokerTable(table);

    // 4. ğŸ”¥ ã€æ ¸å¿ƒï¼šéšç´šå¾µç¨…å„€å¼ã€‘
    if (!pokerGame.isFirstRound) {
        showNotification("âš–ï¸ åŸ·è¡Œç‹åœ‹æ³•å¾‹ï¼šéšç´šå¾µç¨…å„€å¼å•Ÿå‹•...");
        await runTaxCeremony(); 
        pokerGame.players.forEach(p => p.cards.sort((a, b) => a.power - b.power));
        if (table) renderPokerTable(table);
    } else {
        showNotification("ğŸš© é¦–å±€é–‹æˆ°ï¼šæœ¬å±€å…ç¨…...");
        addBattleLog("ğŸš© æˆ°äº‹é–‹å§‹ï¼šé¦–å±€å…ç¨…ã€‚");
    }

    // 5. ğŸš¨ ã€å‘½é‹æŠ‰æ“‡èˆ‡æƒ…å ±åµå¯Ÿã€‘
    setTimeout(() => {
        if (!pokerGame.gameActive) return;
        
        // ç‰©ç†æ–·è·¯ï¼šè‹¥æŒæœ‰ scout ç•°èƒ½ï¼Œè‡ªå‹•å•Ÿå‹•å…¨å ´æƒæ
        if (pokerGame.activeBoon === 'scout' && typeof window.triggerScoutEffect === 'function') {
            window.triggerScoutEffect();
        }

        addBattleLog("ğŸ² æ­£åœ¨é€²è¡Œå‘½é‹æŠ‰æ“‡...");
        if (typeof showRankBoonSelection === 'function') {
            showRankBoonSelection(); 
        } else {
            finalizeStartingTurn();
        }
    }, 1200); 
}

/**
 * ğŸ‘‘ ç‰©ç†å­ç¨‹åºï¼šç¢ºå®šç™¼çƒæ¬Šèˆ‡ã€âš–ï¸ åæŠ—è»åŒå¿—è‡´æ„ã€‘å¯¦è£ç‰ˆ
 */
function finalizeStartingTurn() {
    const table = document.getElementById('poker-table');
    if (!pokerGame.gameActive) return;

    // ğŸ”¥ ã€Roguelike ç‰©ç†å¹²æ¶‰å±¤ã€‘
    const boon = pokerGame.activeBoon;
    const hero = pokerGame.players.find(p => p.id === 'player');
    const isSiege = pokerGame.isKingSiege;

    setTimeout(() => {
        // 1. ğŸŒ€ [ç‰¹æ®Šç•°èƒ½ï¼šæ··æ²Œåºå¹•] å„ªå…ˆç´šæª¢æŸ¥
        if (boon === 'chaos' && hero.rank === 'slave') {
            const slaveIdx = pokerGame.players.findIndex(p => p.id === 'player');
            pokerGame.turn = slaveIdx;
            showNotification("ğŸŒ€ æ··æ²Œåºå¹•ï¼šç„¡è¦–éšç´šæ³•è¦ï¼Œç”±å¥´éš¸å…ˆè¡Œç™¼é›£ï¼");
            pokerGame.lastMovePattern = null; 
            if (table) renderPokerTable(table);
            return; 
        }

        // 2. ğŸ¤ ã€æ ¸å¿ƒæ–°å¢ï¼šåœ‹ç‹åŒ…åœç¶² - åŒå¿—è‡´æ„é‚è¼¯ã€‘
        // åªæœ‰åœ¨ç©å®¶ä¸æ˜¯åœ‹ç‹ä¸”åŒ…åœç¶²å•Ÿå‹•æ™‚è§¸ç™¼
        if (isSiege && hero.rank !== 'king') {
            pokerGame.players.forEach((p, idx) => {
                if (p.id === 'player' || p.rank === 'king') return;

                const greetings = {
                    noble: "æš—å½±ä¸­çš„åŒå¿—ï¼Œæˆ‘çš„åŠèˆ‡è²¡ç”¢æ­¤åˆ»èˆ‡ä½ å…±é³´ã€‚",
                    citizen: "çµ‚æ–¼ç­‰åˆ°é€™ä¸€å¤©äº†...è®“æˆ‘å€‘æŠŠé‚£é ‚çš‡å† ç‰©ç†æ€§åœ°æ‹½ä¸‹ä¾†ï¼",
                    slave: "é€™æ¢éµéˆï¼Œä»Šå¤©å°±è¦ç‰©ç†æ€§åœ°å¥—åœ¨æš´å›çš„è„–å­ä¸Šã€‚"
                };
                
                const talk = greetings[p.rank] || "æš—å½±ä¸­çš„åŒå¿—ï¼Œå‘ä½ è‡´æ„ã€‚";
                
                // ç‰©ç†æ§é »ï¼šè®“å°è©ä¾åºå½ˆå‡ºï¼Œç‡Ÿé€ é›†çµæ„Ÿ
                setTimeout(() => {
                    if (typeof triggerAISpeech === 'function') triggerAISpeech(idx, talk);
                }, 400 + (idx * 500));
            });
        }

        // 3. æ¨™æº–ç™¼çƒåˆ¤å®šé‚è¼¯
        if (pokerGame.isFirstRound) {
            findFirstTurn(); 
        } else {
            let starterIdx = pokerGame.players.findIndex(p => p.rank === 'king');
            if (starterIdx === -1) starterIdx = 0; 

            pokerGame.turn = starterIdx;
            const starter = pokerGame.players[pokerGame.turn];

            // ğŸ“¢ è¦–è¦ºæ’­å ±ï¼šåŒ…åœç¶²ç’°å¢ƒç‰¹åŒ–å°è©
            if (isSiege && starter.rank === 'king') {
                showNotification(`âš–ï¸ <b style="color:#ff4d4d;">å›°ç¸ä¹‹é¬¥</b>ï¼šçµ±æ²»è€… ã€${starter.name}ã€‘ åœ¨åŒ…åœç¶²ä¸­è©¦åœ–å¼·è¡Œé–‹å±€ï¼`);
            } else if (boon === 'destiny' && starter.id === 'player') {
                showNotification("âœ¨ å‘½é‹ç¿»è½‰ï¼šä½ æ˜¯æ–°çš„ç‹ï¼ŒåŸ·è¡Œä½ çš„ç¬¬ä¸€æ¬¡å¯©åˆ¤ï¼");
            } else {
                showNotification(`ğŸ‘‘ çµ±æ²»è€… ã€${starter.name}ã€‘ å•Ÿå‹•äº†æœ¬è¼ªçµ±æ²»ï¼`);
            }
            
            if (table) renderPokerTable(table);

            // 4. å•Ÿå‹• AI è¡Œå‹•è¨ˆæ™‚
            // è‹¥è™•æ–¼è‡´æ„éšæ®µï¼Œå¾®èª¿å»¶é²ç¢ºä¿ç©å®¶èƒ½çœ‹å®Œå°è©±
            const startDelay = isSiege ? 3000 : 1500;

            if (starter.id !== 'player') {
                const aiDelay = (boon === 'decree') ? 2500 : startDelay; 
                
                if (window.pokerAITimer) clearTimeout(window.pokerAITimer);
                window.pokerAITimer = setTimeout(() => aiPlayTurn(pokerGame.turn), aiDelay);
            } else {
                selectedCards = [];
                showNotification("ğŸ‘‰ ä½ çš„ç™¼çƒæ¬Šï¼Œè«‹å‡ºç‰Œï¼");
            }
        }
    }, 1000);
}

/**
 * ğŸ”„ ç‰©ç†å­ç¨‹åºï¼šé—œé–‰é»‘å¸‚äº¤æ˜“ä¸¦éŠœæ¥æˆ°çˆ­å¼•æ“
 * ä¿®æ­£ï¼š
 * 1. ç‰©ç†äº’æ–¥é–ï¼šé˜²æ­¢é‡è¤‡è§¸ç™¼ close å°è‡´ DOM æ¸²æŸ“è¡çªã€‚
 * 2. æ•¸æ“šå°é½Šï¼šå¼·åˆ¶æ¸…ç†äº¤æ˜“ç·©è¡èˆ‡ Pass æ¨™ç±¤ã€‚
 * 3. éˆè·¯å®‰å…¨ï¼šç§»é™¤å†—é¤˜èª¿ç”¨ï¼Œç¢ºä¿ç™¼çƒæ¬Šç‰©ç†å°æ­£ã€‚
 */
function closeBlackMarket() {
    // ğŸ”¥ ã€ç‰©ç†å®‰å…¨é–€è¡›ã€‘é˜²æ­¢é‡è¤‡èª¿ç”¨å°è‡´ 10030 è¡Œå ±éŒ¯
    if (window.isClosingMarket) return;
    window.isClosingMarket = true;

    console.log("%cğŸ”Œ åŸ·è¡Œé»‘å¸‚é€šè¨Šåˆ‡æ–·èˆ‡æ¬Šé™å›æ”¶...", "color: #9b59b6;");
    
    // 1. ğŸ”¥ ã€ç‰©ç†æ¸…ç†ã€‘ç§»é™¤é»‘å¸‚äº¤æ˜“åœ–å±¤
    const el = document.getElementById('black-market-overlay');
    if (el) {
        el.style.opacity = '0'; // ç‰©ç†æ¼¸éš±
        el.style.transition = 'opacity 0.3s ease';
        setTimeout(() => {
            if (el.parentNode) el.remove();
        }, 300);
    }

    // 2. ğŸ”¥ ã€æ•¸æ“šåŒæ­¥ã€‘é‡ç½®é¸æ“‡ç·©è¡èˆ‡å…¨å ´ Pass ç‹€æ…‹
    window.selectedCards = [];
    window.marketSelection = []; // æ¸…ç†é»‘å¸‚å°ˆç”¨ç·©è¡
    
    pokerGame.players.forEach(p => {
        p.isPassed = false;
        p.lastMove = [];
    });

    // 3. ğŸ”¥ ã€ç‰©ç† UI é‡ç¹ªã€‘ç¢ºä¿æˆ°å€ä¸­å¤®æ·¨ç©º
    const tableContainer = document.getElementById('poker-table');
    if (tableContainer) {
        // ä½¿ç”¨ç‰©ç†é‡ç¹ªç¢ºä¿ UI ä¹¾æ·¨
        renderPokerTable(tableContainer);
        if (typeof renderTableCenter === 'function') renderTableCenter();
    }

    // 4. ğŸ”¥ ã€éŠœæ¥ç™¼çƒé‚è¼¯ã€‘
    showNotification("ğŸ“¢ äº¤æ˜“çµæŸã€‚æš—å½±å¥‘æ“šå·²é–å®šï¼Œæˆ°çˆ­æ­£å¼é–‹å§‹ï¼");
    
    // å»¶é² 500ms åŸ·è¡Œï¼Œçµ¦äºˆç©å®¶è¦–è¦ºç·©è¡æ™‚é–“
    setTimeout(() => {
        if (typeof finalizeStartingTurn === 'function') {
            finalizeStartingTurn();
            
            // ç‰©ç†é€£å‹•ï¼šå¦‚æœæ˜¯ç©å®¶ç™¼çƒï¼Œå¼·åˆ¶é–ƒçˆæç¤ºç‡ˆ
            const heroIdx = pokerGame.players.findIndex(p => p.id === 'player');
            if (pokerGame.turn === heroIdx) {
                const hint = document.getElementById('latest-log-hint');
                if (hint) {
                    hint.innerHTML = `<span style="color:#f1c40f; animation: labelFlicker 0.5s infinite;">ğŸ‘‰ ä½ æ“æœ‰ä¸»å‹•æ¬Šï¼Œè«‹é–‹ç‰Œï¼</span>`;
                }
            }
        }
        
        // ç‰©ç†é–å®šè§£é™¤ï¼šå…è¨±ä¸‹ä¸€æ¬¡é»‘å¸‚é–‹å•Ÿ
        window.isClosingMarket = false;
    }, 600);
}


/**
 * âš–ï¸ éšç´šå„€å¼ï¼šç‰©ç†å¾µç¨…èˆ‡ã€åœ‹ç‹åŒ…åœç¶²ã€‘å¤šç¶­è³‡æºç®¡æ§ç‰ˆ
 * ä¿®æ­£ï¼š
 * 1. å¼·åŒ–åæŠ—è»ã€Œç§˜å¯†å”è­°ã€ï¼šç‰©ç†ç¢ºä¿ç›Ÿå‹é–“äº¤æ›çš„æ˜¯çœŸæ­£çš„ç²¾éŠ³ç‰Œã€‚
 * 2. ä¿®æ­£é¬¼ç‰Œç¸½é‡å®‰å®šå™¨ï¼šåš´æ ¼é™åˆ¶å…¨å ´é¬¼ç‰Œä¸Šé™ï¼Œé˜²æ­¢æ•¸æ“šæº¢å‡ºå°è‡´åˆ¤å®šå´©æ½°ã€‚
 * 3. ç‰©ç†åŒæ­¥ï¼šæ•´åˆé£›è¡Œç‰¹æ•ˆå‹•ç•«ï¼Œæå‡å¾µç¨…å„€å¼çš„å„€å¼æ„Ÿã€‚
 */
async function runTaxCeremony() {
    if (window.isTaxing) return;
    window.isTaxing = true;

    addBattleLog(`âš–ï¸ <b style="color:#f1c40f;">ç‹åœ‹æ³•å¾‹</b>ï¼šåŸ·è¡Œéšç´šé‡çµ„èˆ‡è³‡ç”¢è½‰ç§»...`);
    
    const players = pokerGame.players;
    const getPos = (rank) => {
        const idx = players.findIndex(p => p.rank === rank);
        return idx !== -1 ? ['pos-bottom', 'pos-left', 'pos-top', 'pos-right'][idx] : null;
    };

    const king = players.find(p => p.rank === "king");
    const slave = players.find(p => p.rank === "slave");
    const noble = players.find(p => p.rank === "noble");
    const citizen = players.find(p => p.rank === "citizen");

    // 1. ğŸ‘‘ ã€ç‹æ¬Šå¾µç¨…ï¼šç‰©ç†åŸ·è¡Œã€‘
    if (king && slave) {
        addBattleLog(`ğŸ‘‘ åœ‹ç‹å°å¥´éš¸åŸ·è¡Œè³‡ç”¢æ å¥ª (2å¼µ)ã€‚`);
        // è§¸ç™¼ç‰©ç†é£›è¡Œç‰¹æ•ˆ
        await animateTaxExchange(getPos("slave"), getPos("king"), 2);
        // åŸ·è¡ŒèƒŒå¾Œæ•¸æ“šäº¤æ› (è‡ªå‹•ç¯©é¸æœ€å¼·/æœ€å¼±)
        await performTaxTransfer(king, slave, 2, "ğŸ‘‘ åœ‹ç‹å¾µç¨…");
    }

    await new Promise(r => setTimeout(r, 400));

    // 2. ğŸ’ ã€è²´æ—ç‰¹æ¬Šï¼šç‰©ç†åŸ·è¡Œã€‘
    if (noble && citizen) {
        addBattleLog(`ğŸ’ è²´æ—å•Ÿå‹•éšç´šéæ¿¾ (1å¼µ)ã€‚`);
        await animateTaxExchange(getPos("citizen"), getPos("noble"), 1);
        await performTaxTransfer(noble, citizen, 1, "ğŸ’ è²´æ—ç‰¹æ¬Š");
    }

    // --- ğŸ©¸ 3. ã€ç‰©ç†æ ¸å¿ƒï¼šåœ‹ç‹åŒ…åœç¶² - è³‡æºå‹•æ…‹è£œçµ¦å¼•æ“ã€‘ ---
    if (pokerGame.isKingSiege) {
        await new Promise(r => setTimeout(r, 600)); 
        addBattleLog(`ğŸ¤ <b style="color:#9b59b6;">[è¡€ç›Ÿå”è­°]</b> åæŠ—è»æ­£åœ¨è½‰ç§»æˆ°ç•¥è³‡æºä»¥å°æŠ—æš´å›...`);
        
        const rebels = pokerGame.players.filter(p => p.rank !== 'king');
        
        // A. ã€åœ°ä¸‹ç²¾éŠ³äº¤æ›ã€‘ç‰©ç†é‚è¼¯ï¼š
        // æ¯å€‹åæŠ—è»æˆå“¡é¸å‡ºæ‰‹ä¸­æœ€å¼·çš„ 3 å¼µç‰Œé€çµ¦ä¸‹ä¸€ä½ç›Ÿå‹
        const rebelGiftPiles = rebels.map(p => {
            p.cards.sort((a, b) => b.power - a.power); // ç”±å¤§åˆ°å°æ’
            return p.cards.splice(0, 3); 
        });

        for (let i = 0; i < rebels.length; i++) {
            const fromIdx = players.findIndex(pl => pl.id === rebels[i].id);
            const targetRebel = rebels[(i + 1) % rebels.length];
            const toIdx = players.findIndex(pl => pl.id === targetRebel.id);
            
            // ç‰©ç†å‹•ç•«ï¼šç›Ÿå‹é–“çš„ç‰©è³‡æ”¯æ´
            if (typeof triggerCardTransferVfx === 'function') {
                triggerCardTransferVfx(fromIdx, toIdx); 
            }
            
            targetRebel.cards.push(...rebelGiftPiles[i]);
            addBattleLog(`ğŸ“¡ ${rebels[i].name} å‘ç›Ÿå‹æŠ•éäº† 3 å¼µæ ¸å¿ƒæˆ°åŠ›ã€‚`);
        }

        // B. ğŸ”¥ ã€å‹•æ…‹é¬¼ç‰Œå®‰å®šå™¨ã€‘
        // ç‰©ç†è¦å‰‡ï¼šå…¨å ´é¬¼ç‰Œä¸Šé™ 10 å¼µï¼ŒåŒ…åœç¶²åªè£œçµ¦ã€Œå½ˆè—¥åŒ±ä¹ã€çš„ç›Ÿå‹
        const getGlobalJokerCount = () => {
            return pokerGame.players.reduce((sum, pl) => 
                sum + pl.cards.filter(c => c.value === 'JOKER').length, 0);
        };

        rebels.forEach(p => {
            const globalCount = getGlobalJokerCount();
            if (globalCount < 10 && !p.cards.some(c => c.value === 'JOKER')) {
                p.cards.push({ 
                    suit: 'ğŸƒ', value: 'JOKER', power: 150 + Math.random(), 
                    label: 'JOKER', fromSiege: true 
                });
                addBattleLog(`ğŸŒ‘ <b style="color:#9b59b6;">[è£œçµ¦]</b> ${p.name} é ˜å—åæŠ—è»å¯†æ´ JOKERã€‚`);
            }
        });

        // è¦–è¦ºï¼šç´«è‰²å¨å£“é–ƒçˆ
        const table = document.getElementById('poker-table');
        if (table) {
            table.style.boxShadow = "inset 0 0 120px rgba(155, 89, 182, 0.5)";
            setTimeout(() => table.style.boxShadow = "inset 0 0 60px #000", 1000);
        }
    }

    // 4. ğŸ”¥ ã€ç‰©ç†é‡æ•´ã€‘ç¢ºä¿æ‰€æœ‰äººåœ¨å¾µç¨…/äº¤æ›å¾Œæ‰‹ç‰Œé»æ•¸æ­£ç¢ºæ’åº
    pokerGame.players.forEach(p => {
        p.cards.sort((a, b) => a.power - b.power);
    });

    // 5. ğŸ”¥ ã€UI åŒæ­¥ã€‘
    renderPokerTable(document.getElementById('poker-table'));

    window.isTaxing = false;
    addBattleLog(`âœ… <b style="color:#2ecc71;">å‘½é‹é‡çµ„å®Œæˆ</b>ã€‚è«‹é ˜å—æ–°çš„é–‹å±€å±€é¢ã€‚`);
    return true; 
}

/**
 * âš–ï¸ ç­–ç•¥æ€§å¾µç¨…ï¼šç‰©ç†åµæ¸¬å°å¼·è€…æœ€æœ‰åˆ©çš„ç‰Œçµ„
 * @param {Object} stronger å¼·è€… (åœ‹ç‹/è²´æ—)
 * @param {Object} weaker å¼±è€… (å¥´éš¸/å¹³æ°‘)
 * @param {number} count å¾µæ”¶å¼µæ•¸
 * @param {string} msg é€šçŸ¥è¨Šæ¯
 */
async function performTaxTransfer(stronger, weaker, count, msg) {
    // 1. ğŸ”¥ ã€ç‰©ç†æƒæã€‘è©•ä¼°å¼±è€…æ‰‹ä¸­æœ€æœ‰åƒ¹å€¼çš„è³‡ç”¢
    // æ¬Šé‡ï¼šå¤§è€äºŒ(2) > ç‚¸å½ˆ/éµæ”¯çµ„æˆ > é †å­é—œéµç‰Œ > A > é»æ•¸å¤§
    const evaluateValue = (card, targetHand) => {
        let score = card.power; // åŸºç¤åˆ†ç‚ºé»æ•¸
        
        // ç‰©ç†åŠ æˆï¼šå¤§è€äºŒ (2) æ“æœ‰æœ€é«˜æˆ°ç•¥åƒ¹å€¼
        if (card.value === '2') score += 1000;
        
        // ç‰©ç†åŠ æˆï¼šè‹¥èƒ½å¹«å¼·è€…æ¹Šæˆã€Œç‚¸å½ˆ/éµæ”¯ã€ (åŸæœ¬å·²æœ‰ 2-3 å¼µåŒé»æ•¸)
        const sameValueCount = targetHand.filter(c => c.value === card.value).length;
        if (sameValueCount === 3) score += 500; // æ¹Šæˆéµæ”¯
        if (sameValueCount === 2) score += 200; // æ¹Šæˆä¸‰æ¢
        
        return score;
    };

    // 2. ç‰©ç†æ’åºï¼šå¼±è€…æ‰‹ç‰Œä¾ã€Œå°å¼·è€…çš„åƒ¹å€¼ã€é™åºæ’åˆ—
    weaker.cards.sort((a, b) => evaluateValue(b, stronger.cards) - evaluateValue(a, stronger.cards));
    
    // 3. ç‰©ç†æ’åºï¼šå¼·è€…æ‰‹ç‰Œä¾ã€ŒåŸºç¤æˆ°åŠ›ã€å‡åºæ’åˆ— (æŒ‘é¸æœ€çˆ›çš„ç‰Œçµ¦å›å»)
    stronger.cards.sort((a, b) => a.power - b.power);

    // 4. åŸ·è¡Œç‰©ç†äº¤æ›
    const tax = weaker.cards.splice(0, count); // å¥ªå–æœ€æœ‰åˆ©çš„ç‰Œ
    const gift = stronger.cards.splice(0, count); // è´ˆé€æœ€åƒåœ¾çš„ç‰Œ

    stronger.cards.push(...tax);
    weaker.cards.push(...gift);

    // 5. æ¬ŠåŠ›çµæœé€šçŸ¥
    showNotification(`${msg}: æ å¥ªäº† ${tax.map(c => c.label).join(', ')}`);
    
    // ç‰©ç†åœé “ï¼Œç¢ºä¿è¦–è¦ºåŒæ­¥
    await new Promise(r => setTimeout(r, 1000));
}


/**
 * ğŸ‘‘ åœ‹ç‹çµ±æ²»çå‹µï¼šç‰©ç†çµç®—å€ç‡èˆ‡å‚³å¥‡æ‰è½
 */
function applyKingBonus() {
    // ç¢ºä¿åªåœ¨ç©å®¶æ˜¯åœ‹ç‹æ™‚è§¸ç™¼
    const playerHero = pokerGame.players.find(p => p.id === 'player');
    if (playerHero.rank !== 'king') {
        pokerGame.kingStreak = 0;
        return;
    }

    // 1. ç‰©ç†ç´¯è¨ˆé€£èŠæ•¸
    pokerGame.kingStreak = (pokerGame.kingStreak || 0) + 1;
    
    // 2. ğŸ’° è³‡é‡‘å€å¢ï¼šåŸºç¤ 1.5xï¼Œæ¯é€£èŠä¸€æ¬¡å¢åŠ  0.5x
    const multiplier = 1 + (pokerGame.kingStreak * 0.5);
    const baseWin = 100 * 3; // å‡è¨­é–€ç¥¨ 100ï¼Œè´ä¸‰å®¶
    const bonus = Math.floor(baseWin * multiplier);
    player.coin += bonus;

    // 3. ğŸ’ å‚³å¥‡æ‰è½åˆ¤å®š (é€£èŠ 3 æ¬¡ä»¥ä¸Šå•Ÿå‹•)
    let dropMsg = "";
    if (pokerGame.kingStreak >= 3) {
        const dropChance = 0.15 + (pokerGame.kingStreak * 0.05); // éš¨æ¬¡æ•¸æå‡æ©Ÿç‡
        if (Math.random() < dropChance) {
            const fragments = ["ğŸ‘‘ è¡€è…¥ç‹æ¬Šç¢ç‰‡", "ğŸ—¡ï¸ çµ±æ²»è€…ä¹‹é‹’", "ğŸ“œ ç¦å¿Œç¨…å¾‹å–®"];
            const item = fragments[Math.floor(Math.random() * fragments.length)];
            player.inventory.push(item);
            dropMsg = ` ä¸¦ç²å¾—ã€${item}ã€‘ï¼`;
        }
    }

    showNotification(`ğŸ”¥ åœ‹ç‹é€£èŠ x${pokerGame.kingStreak}ï¼è³é‡‘é¡å¤–å¢åŠ  ${bonus} G${dropMsg}`);
}

function triggerRevolutionVisuals() {
    const screen = document.getElementById('adventure-screen');
    if (screen) {
        screen.style.animation = "revolutionShake 0.5s 3";
        setTimeout(() => screen.style.animation = "", 1500);
    }
    // ç‰©ç†ç²‰ç¢éµéˆ
    player.inventory = player.inventory.filter(i => !i.includes("éµéˆ"));
}
/**
 * ğŸ’° ç‰©ç†é‡‘å¹£è½‰æ›ï¼šè¬é‡‘é–€ç¥¨èˆ‡ç¶“æ¿Ÿå•Ÿå‹•ç‰ˆ
 */
function enterPokerArena() {
    // 1. ğŸ”¥ ã€ç‰©ç†æ ¸å¿ƒï¼šç¥å™¨èˆ‡é–€ç¥¨æ ¡æº–ã€‘
    const inv = player.inventory || [];
    const hasTaxScroll = inv.includes("ğŸ“œ ç¦å¿Œç¨…å¾‹å–®");
    const hasKingFragment = inv.includes("ğŸ‘‘ è¡€è…¥ç‹æ¬Šç¢ç‰‡");

    // ç‰©ç†è¨­å®šï¼šåŸºæº–é–€ç¥¨ 10,000Gï¼ŒæŒæœ‰ç¨…å¾‹å–® 5,000G
    const buyIn = hasTaxScroll ? 5000 : 10000; 

    // 2. ğŸ”¥ ã€ç‰©ç†ä¿éšªï¼šé«˜é¡å‚µå‹™ç³»çµ±ã€‘
    const hero = pokerGame.players.find(p => p.id === 'player');
    const heroRank = hero ? hero.rank : "citizen";

    if (player.coin < buyIn && heroRank === "slave") {
        showNotification("â›“ï¸ å…¸ç„é•·ï¼šå€å€ä¸€è¬éƒ½æ‹¿ä¸å‡ºä¾†ï¼Ÿé€™ç­†è¡€å‚µä½ ç°½äº†ï¼Œé€²å»è³­å‘½å§ï¼");
        const loanNeeded = buyIn - player.coin;
        player.debt = (player.debt || 0) + Math.floor(loanNeeded * 2.0); // å¥´éš¸å€Ÿè²¸åˆ©æ¯èª¿é«˜è‡³ 200%
        player.coin = buyIn; 
        if (typeof updatePlayerUI === 'function') updatePlayerUI();
    }

    // 3. ğŸš¨ ã€å…¥å ´æ””æˆªã€‘
    if (player.coin < buyIn) {
        showNotification(`ğŸ’€ å®ˆé–€äººï¼šé–€ç¥¨è¦ ${buyIn.toLocaleString()}Gï¼Œçª®é¬¼æ»¾å›å»ï¼`);
        if (typeof travelTo === 'function') travelTo('N5');
        return;
    }

    // 4. ğŸ”¥ ã€æ‰£æ¬¾èˆ‡ AI ç±Œç¢¼é…ç™¼ã€‘
    player.coin -= buyIn;
    pokerGame.playerPot = buyIn; 
    pokerGame.bonusMultiplier = hasKingFragment ? 1.15 : 1.0;

    // ç‚º AI ç©å®¶åˆå§‹åŒ–ç±Œç¢¼ (è‹¥å°šæœªæŒæœ‰)
    pokerGame.players.forEach(p => {
        if (p.id !== 'player') {
            p.coins = p.coins || (50000 + Math.floor(Math.random() * 50000));
        }
    });

    showNotification(`ğŸ° å·²ç¹³ç´é–€ç¥¨ ${buyIn.toLocaleString()}Gï¼Œèº«åˆ†å¯©åˆ¤é–‹å§‹ï¼`);
    
    // 5. ğŸ”¥ ã€å ´æ™¯ç‰©ç†åˆ‡æ›ã€‘
    const advScreen = document.getElementById('adventure-screen');
    const pokTable = document.getElementById('poker-table');
    if (advScreen) advScreen.style.display = 'none';
    if (pokTable) {
        pokTable.style.display = 'flex';
        pokTable.style.zIndex = "11000";
        pokTable.style.animation = "battleSceneOpen 0.5s ease-out";
    }
    
    if (typeof startPokerGame === 'function') startPokerGame(); 
}



// --- ğŸƒ ç‰©ç†ç‰Œå‹åˆ¤å®šï¼šå¼·åŒ–äº”å¼µç‰Œå‹é‚è¼¯ ---
function getPokerPattern(cards) {
    const len = cards.length;
    // ç‰©ç†æ’åºï¼Œç¢ºä¿å¾ŒçºŒé‚è¼¯ç©©å®š
    const sorted = [...cards].sort((a, b) => a.power - b.power);

    if (len === 1) return { type: 'single', power: sorted[0].power };
    if (len === 2 && sorted[0].rank === sorted[1].rank) 
        return { type: 'pair', power: sorted[1].power };

    if (len === 5) {
        const counts = {};
        sorted.forEach(c => counts[c.rank] = (counts[c.rank] || 0) + 1);
        const valCount = Object.values(counts);

        // ğŸ”¥ ã€æ ¸å¿ƒä¿®æ­£ã€‘éµæ”¯åˆ¤å®šï¼šå¿…é ˆæ˜¯ 4+1 çµæ§‹
        if (valCount.includes(4)) {
            // æ‰¾å‡ºå››å¼µé‚£çµ„çš„é»æ•¸ä½œç‚ºç‰©ç†å¼·åº¦åŸºæº–
            const quadRank = Object.keys(counts).find(k => counts[k] === 4);
            const quadPower = sorted.find(c => c.rank === quadRank).power;
            return { type: 'quads', power: quadPower }; 
        }

        // è‘«è˜†åˆ¤å®šï¼š3+2 çµæ§‹
        if (valCount.includes(3) && valCount.includes(2)) {
            const tripleRank = Object.keys(counts).find(k => counts[k] === 3);
            const triplePower = sorted.find(c => c.rank === tripleRank).power;
            return { type: 'fullhouse', power: triplePower };
        }

        // æ­¤è™•å¯æ“´å……é †å­ (straight) æˆ–åŒèŠ± (flush) é‚è¼¯...
    }

    return null; // ç‰©ç†ä¸åˆæ³•ç‰Œå‹
}

async function playSelectedCards() {
    const pattern = getPokerPattern(selectedCards);
    
    // æé†’ï¼šéµæ”¯å¿…é ˆå¸¶ä¸€å¼µé›œç‰Œ
    const counts = {};
    selectedCards.forEach(c => counts[c.rank] = (counts[c.rank] || 0) + 1);
    if (Object.values(counts).includes(4) && selectedCards.length === 4) {
        showNotification("âš ï¸ éµæ”¯å¿…é ˆæ­é…ä¸€å¼µé›œç‰Œï¼ˆå…±äº”å¼µï¼‰æ‰èƒ½å‡ºç‰Œï¼");
        return;
    }

    if (canPlayCards(selectedCards, pokerGame.lastMoveCards, pokerGame.lastMovePattern)) {
        // åŸ·è¡Œå‡ºç‰Œç‰©ç†ä½ç§»...
        pokerGame.lastMoveCards = [...selectedCards];
        pokerGame.lastMovePattern = pattern;
        // ...å¾ŒçºŒé‚è¼¯
    } else {
        showNotification("âŒ ç‰Œå‹ä¸ç¬¦æˆ–å¼·åº¦ä¸è¶³ï¼Œç„¡æ³•å£“ç‰Œ");
    }
}

// --- âš–ï¸ ç‰©ç†æ¯”ç‰Œå¼•æ“ï¼šè¶Šç´šå£“åˆ¶é‚è¼¯ ---
function canPlayCards(newCards, lastCards, lastPattern) {
    const newPattern = getPokerPattern(newCards);
    if (!newPattern) return false;

    // 1. é¦–ç™¼æ¬Šï¼šç›´æ¥é€šé
    if (!lastPattern) return true;

    // 2. ğŸ”¥ ã€éµæ”¯ç‰¹æ®Šç‰©ç†è¦å‰‡ã€‘
    // å¦‚æœä¸Šä¸€æ‰‹ä¸æ˜¯éµæ”¯ï¼Œä¸”é€™ä¸€æ‰‹æ˜¯éµæ”¯ï¼šå¼·åˆ¶ç‰©ç†å£“åˆ¶
    if (lastPattern.type !== 'quads' && newPattern.type === 'quads') {
        showNotification("ğŸ’¥ éµæ”¯ç‚¸å½ˆï¼ç‰©ç†æ€§å¼·åˆ¶å£“åˆ¶ï¼");
        return true;
    }

    // 3. åŒé¡å‹æ¯”ç‰Œï¼šå¼µæ•¸å¿…é ˆç›¸åŒ
    if (newPattern.type === lastPattern.type && newCards.length === lastCards.length) {
        return newPattern.power > lastPattern.power;
    }

    return false;
}

/**
 * ğŸƒ ç‰©ç†æ’¤é€€ï¼šå®‰å…¨è„«é›¢æˆ°å ´ã€é–å®šå‚³å¥‡æˆå°±èˆ‡å…¨åº§æ¨™ç³»é‚„åŸ
 * ä¿®æ­£ï¼šå¾¹åº•ç§»é™¤ victory-screen æ®˜ç•™ä¸¦é‡ç½®ç‰©ç†åº§æ¨™ç³»åŸºæº–é»
 */
async function exitKingdom() {
    console.log("%cğŸƒ æ’¤é€€å”è­°å•Ÿå‹•ï¼šæ­£åœ¨åŸ·è¡Œå…¨ç³»çµ±ç‰©ç†å±¤ç´šå›æ­¸...", "color: #e67e22; font-weight: bold;");

    // 1. ğŸ”¥ ã€ç‰©ç†åˆ¶å‹•ã€‘åœæ­¢éŠæˆ²å¼•æ“
    pokerGame.gameActive = false; 
    window.isGameEnding = false;
    window.isTaxing = false;
    pokerGame.activeBoon = null;

    if (window.pokerAITimer) {
        clearTimeout(window.pokerAITimer);
        window.pokerAITimer = null;
    }

    // 2. ğŸ’° ã€è³‡ç”¢å›æ”¶ã€‘å°‡ç‰Œæ¡Œç±Œç¢¼æ­¸é‚„éŒ¢åŒ…
    if (pokerGame.playerPot > 0) {
        showNotification(`ğŸ“¦ è²¡å¯Œæ¸…ç®—ï¼é ˜å›ç±Œç¢¼: ${pokerGame.playerPot.toLocaleString()} G`);
        player.coin += pokerGame.playerPot;
        pokerGame.playerPot = 0;
    }

    // 3. ğŸ›ï¸ ã€ç´€éŒ„å°è¨˜ã€‘åäººå ‚ç¢‘æ–‡å¯«å…¥
    try {
        if (typeof recordToHallOfFame === 'function') {
            const cause = (player.kingStreak >= 12) ? "å‚³å¥‡æ–°çš‡é€€å½¹" : (pokerGame.playerTotalWins > 0 ? "å‡±æ—‹å›æ­¸" : "åƒ¥å€–é€ƒç”Ÿ");
            await recordToHallOfFame(cause);
            pokerGame.playerTotalWins = 0; // é‡ç½®æœ¬è¶Ÿå‹å ´è¨ˆæ•¸
        }
    } catch (hofError) {
        console.warn("âš ï¸ åäººå ‚ç´€éŒ„ç‰©ç†è·³é:", hofError);
    }

    // 4. ğŸ’¾ ã€æ•¸æ“šå°é–ã€‘åŸ·è¡Œå…¨é‡å­˜æª” (å«è‚¡å¸‚ã€è¨­æ–½)
    if (typeof savePlayerToDB === 'function') {
        await savePlayerToDB();
    }

    // 5. ğŸ”¥ ã€æ ¸å¿ƒé»ç«ï¼šæ•¸æ“šå›ä½ä¸­æ¨ã€‘
    // ç‰©ç†æ„ç¾©ï¼šç¢ºä¿ Home ä»‹é¢çš„å»ºè¨­é€²åº¦æ¢ã€é‡‘å¹£ã€é ­éŠœèˆ‡æœ€æ–°å­˜æª”ä¸€è‡´
    if (typeof initKingdomEconomy === 'function') {
        await initKingdomEconomy();
    }

    // 6. ğŸ›¡ï¸ ã€åœ°æ¯¯å¼ UI æ¸…ç†ã€‘ç§»é™¤æ‰€æœ‰è³­å ´åœ–å±¤èˆ‡ã€Œçµç®—é®ç½©ã€
    const uiOperations = [
        { id: 'poker-table', action: 'hide' },
        { id: 'poker-screen', action: 'hide' },
        { id: 'victory-screen', action: 'hide' }, // ğŸ”¥ æ ¸å¿ƒä¿®æ­£ï¼šéš±è—çµç®—é®ç½©
        { id: 'boon-overlay', action: 'remove' },
        { id: 'boon-detail-overlay', action: 'remove' },
        { id: 'poker-ledger', action: 'remove' },
        { id: 'tyranny-overlay', action: 'remove' },
        { id: 'adventure-screen', action: 'show' }
    ];

    uiOperations.forEach(op => {
        const el = document.getElementById(op.id);
        if (el) {
            try {
                if (op.action === 'hide') {
                    el.style.display = 'none';
                    el.style.zIndex = "-1"; // ç‰©ç†æ²ˆé™
                }
                else if (op.action === 'show') el.style.display = 'block';
                else if (op.action === 'remove') el.remove();
            } catch (err) { console.warn(`ç‰©ç†æ“ä½œ DOM [${op.id}] ç•°å¸¸`); }
        }
    });

    // 7. ğŸŒ ã€åœ°ç†é‡ç½®ã€‘å›æ­¸ Home
    currentMapDifficulty = "Home";
    const mapSelector = document.getElementById('map-selector');
    if (mapSelector) mapSelector.value = "Home";

    const screen = document.getElementById('adventure-screen');
    if (screen) {
        screen.style.background = "linear-gradient(to bottom, #ffebcd 0%, #f5deb3 100%)";
        screen.style.animation = "none";
        screen.style.filter = "none"; // ç¢ºä¿å†’éšªèƒŒæ™¯ç„¡æ®˜ç•™æ¿¾é¡
    }
    
    const heroSprite = document.getElementById('hero-sprite');
    if (heroSprite) {
        heroSprite.style.left = "45%";
        heroSprite.classList.remove('walking');
        const body = document.getElementById('hero-body');
        if (body) body.innerText = (player.lv >= 40) ? "ğŸ§™â€â™‚ï¸" : (player.lv >= 20 ? "âš”ï¸" : "ğŸš¶");
    }
    
    const homeUI = document.getElementById('home-interactions');
    if (homeUI) homeUI.style.display = 'flex';

    // 8. âœ¨ ã€æ¬Šé™è§£é–ï¼šæ ¸å¿ƒä¿®æ­£ã€‘å¾¹åº•æƒé™¤å°è‡´åº§æ¨™åç§»èˆ‡ç•«é¢æ¨¡ç³Šçš„å…ƒå…‡
    // ç‰©ç†æ„ç¾©ï¼šå¼·åˆ¶é‚„åŸ HTML æ ¹ç¯€é»çš„å®šä½åŸºæº–
    const selectors = ['html', 'body', '.main-wrapper', 'header', '#game-sticky-header', 'aside', 'main'];
    selectors.forEach(selector => {
        const els = document.querySelectorAll(selector);
        els.forEach(el => {
            el.style.filter = "none";
            el.style.webkitFilter = "none";
            el.style.pointerEvents = "auto"; 
            el.style.transform = "none";
            el.style.opacity = "1";
            el.style.overflow = "auto"; // æ¢å¾©æ²è»¸æ¬Šé™
        });
    });

    showNotification("ğŸ  å‹‡è€…å·²ç‰©ç†è„«é›¢è¡€è…¥ç‹åœ‹ï¼Œå›åˆ°å®‰å…¨å€ã€‚");
    console.log(`%câœ… åŒæ­¥å›æ­¸å®Œæˆã€‚åº§æ¨™ç³»å·²é‡ç½®ï¼Œç•«é¢æ¢å¾©æ¸…æ™°ã€‚`, "color: #27ae60; font-weight: bold;");
}

/**
 * ğŸ“œ ç‰©ç†å­ç¨‹åºï¼šæˆ°è¡“æ—¥èªŒä¸­æ¨ (V5.9.9 é˜²æ´—é »åŠ å›ºç‰ˆ)
 * ä¿®æ­£é»ï¼š
 * 1. ğŸ”¥ ç‰©ç†å»é‡é–ï¼š1 ç§’å…§ç¦æ­¢ç™¼é€å®Œå…¨ç›¸åŒçš„è¨Šæ¯ï¼Œå¾¹åº•çµ‚çµçµ„åˆçª®èˆ‰æ™‚çš„æ´—é »ç¾è±¡ã€‚
 * 2. æ•ˆèƒ½å„ªåŒ–ï¼šä½¿ç”¨ insertAdjacentHTML é…åˆå»é‡ï¼Œå¤§å¹…é™ä½ DOM æ“ä½œè² æ“”ã€‚
 * 3. è¦–è¦ºæŸ“è‰²ï¼šæ“´å……ã€Œæ¬Šå¨å£“åˆ¶ã€ã€ã€Œè™•æ±ºã€ç­‰æˆ°è¡“é—œéµå­—ä¹‹ç‰©ç†ç™¼å…‰æ•ˆæœã€‚
 */
function addBattleLog(msg) {
    // 0. ğŸ”¥ ã€ç‰©ç†å»é‡é˜²è­·é–ã€‘
    const now = Date.now();
    // ç‰©ç†æ„ç¾©ï¼šè‹¥è¨Šæ¯å…§å®¹èˆ‡ä¸Šä¸€ç­†ç›¸åŒï¼Œä¸”é–“éš”å°æ–¼ 1000msï¼Œå‰‡åˆ¤å®šç‚ºç„¡æ•ˆé‡è¤‡æµä¸¦æ””æˆª
    if (window.lastLogContent === msg && (now - (window.lastLogTime || 0) < 1000)) {
        return; 
    }
    
    // æ›´æ–°ç‰©ç†å¿«ç…§æŒ‡ç´‹
    window.lastLogContent = msg;
    window.lastLogTime = now;

    const stream = document.getElementById('log-content-stream');
    const hint = document.getElementById('latest-log-hint');
    const time = new Date().toLocaleTimeString([], { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });
    
    // 1. ğŸ”¥ ã€ç‰©ç†æ ¸å¿ƒï¼šæ“´å……å‹é—œéµå­—æŸ“è‰²å¼•æ“ã€‘
    let styledMsg = msg
        .replace(/JOKER|é¬¼ç‰Œ/g, '<b style="color:#9b59b6; text-shadow: 0 0 5px #9b59b6;">$&</b>')
        .replace(/åœ‹ç‹åŒ…åœç¶²|è¡€ç›Ÿ|ç§˜å¯†å”è­°|åŒå¿—/g, '<b style="color:#ff4d4d; text-shadow: 0 0 8px #f00;">$&</b>')
        .replace(/ç‚¸å½ˆ|éµæ”¯|åŒèŠ±é †|äº”é¬¼/g, '<b style="color:#f1c40f; text-shadow: 0 0 10px gold;">$&</b>')
        .replace(/æ¬Šå¨å£“åˆ¶|ç¢¾å£“/g, '<b style="color:#f1c40f; text-shadow: 0 0 5px orange;">$&</b>') // æ–°å¢
        .replace(/å‹‡è€…|ç©å®¶/g, '<b style="color:#f1c40f;">$&</b>')
        .replace(/å¾µç¨…|æ å¥ª|è³‡ç”¢|ç¨…æ”¶/g, '<b style="color:#b7950b;">$&</b>')
        .replace(/è´—å“|æ‰æ¼†|è€åƒ/g, '<b style="color:#a569bd;">$&</b>')
        .replace(/é©å‘½|è™•æ±º/g, '<b style="color:#e67e22; text-shadow: 0 0 5px #e67e22;">$&</b>');

    // 2. ğŸ”¥ ã€ç‰©ç†å°è£ã€‘åŠ å…¥çµ‚ç«¯æ©Ÿé¢¨æ ¼çš„è¡Œé¦–ç¬¦è™Ÿ
    const logEntry = `<div style="margin-bottom:6px; border-left:2px solid rgba(46,204,113,0.2); padding-left:8px; animation: logSlideIn 0.2s ease-out;">
        <span style="color:rgba(46,204,113,0.5); font-family:monospace; font-size:10px;">[${time}] $ </span>${styledMsg}
    </div>`;
    
    // 3. ğŸ”¥ ã€ç‰©ç†æŒä¹…åŒ–ã€‘
    window.battleLogBuffer = window.battleLogBuffer || [];
    window.battleLogBuffer.push(logEntry);
    if (window.battleLogBuffer.length > 100) window.battleLogBuffer.shift();

    // 4. ğŸ”¥ ã€æç¤ºç‡ˆåŒæ­¥ã€‘
    if (hint) {
        const tempDiv = document.createElement("div");
        tempDiv.innerHTML = msg;
        const cleanText = tempDiv.innerText || tempDiv.textContent;
        hint.innerText = `>> ${cleanText}`;
        
        hint.style.transition = "none";
        hint.style.opacity = "1";
        hint.style.color = "#f1c40f"; 
        void hint.offsetWidth; // ç‰©ç†è§¸ç™¼é‡ç¹ª (Reflow)
        hint.style.transition = "opacity 1.5s, color 1.5s";
        hint.style.opacity = "0.7";
        hint.style.color = "#2ecc71"; 
    }

    // 5. ğŸ”¥ ã€çµ‚ç«¯æ•¸æ“šæµåŒæ­¥ã€‘
    if (stream) {
        // æ¡ç”¨ insertAdjacentHTML æå‡ç‰©ç†å¯«å…¥æ•ˆèƒ½ï¼Œé¿å…æ•´å€‹å…§å®¹é‡ç¹ª
        stream.insertAdjacentHTML('beforeend', logEntry);

        // ç‰©ç†ç½®åº•ï¼šåªæœ‰ç•¶æ—¥èªŒé–‹å•Ÿæ™‚æ‰é€²è¡Œæ˜‚è²´çš„æ»¾å‹•è¨ˆç®—
        if (window.isLogDrawerOpen) {
            requestAnimationFrame(() => {
                stream.scrollTop = stream.scrollHeight;
            });
        }
    }
}

/**
 * â™»ï¸ ç‰©ç†è¼”åŠ©ï¼šé‚„åŸæ—¥èªŒæµ (ç”¨æ–¼ render é‡ç¹ªå¾Œ)
 */
function restoreLogStream() {
    const stream = document.getElementById('log-content-stream');
    if (stream && window.battleLogBuffer) {
        stream.innerHTML = window.battleLogBuffer.join('');
        const monitor = document.getElementById('battle-log-monitor');
        if (monitor) monitor.scrollTop = monitor.scrollHeight;
    }
}

/**
 * ğŸ¨ ç‰©ç†å­ç¨‹åºï¼šæ³¨å…¥åœ‹ç‹åŒ…åœç¶²å°ˆå±¬è¦–è¦ºæ¨£å¼ (ç‹‚æš´ç´… vs è¡€ç›Ÿç´«)
 */
function injectSiegeStyles() {
    // ğŸ”¥ ã€ç‰©ç†é˜²ç¦¦ã€‘é¿å…é‡è¤‡æ³¨å…¥
    if (document.getElementById('siege-vfx-style')) return;

    const style = document.createElement('style');
    style.id = 'siege-vfx-style';
    style.innerHTML = `
        /* 1. ğŸ‘‘ ç‹‚æš´åœ‹ç‹ï¼šé«˜é »éœ‡å‹•èˆ‡è¡€ç´…å…‰æšˆ */
        .king-berserk-active {
            border-color: #ff0000 !important;
            box-shadow: 0 0 30px rgba(255, 0, 0, 0.8), inset 0 0 15px rgba(255, 0, 0, 0.5) !important;
            animation: berserkVibration 0.15s infinite alternate;
            z-index: 10;
        }
        @keyframes berserkVibration {
            from { transform: translate(1px, 1px) rotate(0.5deg); }
            to { transform: translate(-1px, -1px) rotate(-0.5deg); }
        }

        /* 2. ğŸ¤ åæŠ—è»ç›Ÿå‹ï¼šæ·±é‚ƒçš„ç´«è‰²è¡€ç›Ÿå…±é³´ */
        .rebel-ally-active {
            border-color: #9b59b6 !important;
            box-shadow: 0 0 20px rgba(155, 89, 182, 0.6), inset 0 0 10px rgba(155, 89, 182, 0.3) !important;
            background: linear-gradient(180deg, rgba(25, 0, 50, 0.9) 0%, rgba(10, 10, 10, 0.95) 100%) !important;
            animation: allianceGlow 2s infinite alternate;
        }
        @keyframes allianceGlow {
            from { filter: brightness(0.8); }
            to { filter: brightness(1.2); }
        }

        /* 3. æƒæç·šæ•ˆæœ (ç”¨æ–¼æ—¥èªŒ) */
        .monitor-scanline::after {
            content: " "; display: block; position: absolute; top: 0; left: 0; bottom: 0; right: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.03), rgba(0, 255, 0, 0.01), rgba(0, 0, 255, 0.03));
            z-index: 100; background-size: 100% 3px, 3px 100%; pointer-events: none; opacity: 0.4;
        }
    `;
    document.head.appendChild(style);
    console.log("%cğŸ“¡ åŒ…åœç¶²ç‰©ç†è¦–è¦ºè¦æ ¼å·²åŠ è¼‰å®Œæˆã€‚", "color: #ff4d4d; font-weight: bold;");
}

/**
 * ğŸƒ ç‰©ç†æ¸²æŸ“ï¼šä¸­å¤®æ¡Œé¢å¡ç‰‡ (æ‰‡å½¢å±•é–‹ã€å¹»å½±é©é…èˆ‡è´—å“åµæ¸¬ç‰ˆ)
 * ä¿®æ­£ï¼š
 * 1. ç‰¹æ•ˆæ›è¼‰ï¼šæ•´åˆ CSS phantom-card-vfx é¡åˆ¥ï¼Œå¯¦ç¾ç´«è‰²å‘¼å¸å…‰æšˆã€‚
 * 2. è´—å“è­˜åˆ¥ï¼šç‰©ç†åµæ¸¬ isFake å±¬æ€§ä¸¦æ›è¼‰ç´…è‰²æ¨™ç±¤ã€‚
 * 3. æ€§èƒ½é˜²ç¦¦ï¼šç²¾ç¢ºåˆ¤æ–· isPhantom ä¾†æº (Joker/åŒ…åœç¶²/é»‘å¸‚)ã€‚
 */
function renderCurrentTableCards() {
    // 1. ğŸ”¥ ã€ç‰©ç†æ ¸å¿ƒé˜²ç¦¦ã€‘ç¢ºä¿æ•¸æ“šéˆè·¯å®Œæ•´
    if (!pokerGame || !pokerGame.lastMoveCards || pokerGame.lastMoveCards.length === 0 || !pokerGame.lastMovePattern) {
        return `<small style="color:rgba(255,255,255,0.1); letter-spacing:3px; font-family:monospace;">- FIELD_STATUS: VOID -</small>`;
    }
    
    // 2. ğŸ”¥ ã€æ•¸æ“šç‰©ç†æå–ã€‘
    const pattern = pokerGame.lastMovePattern;
    const patternType = (pattern.type || "unknown").toUpperCase();
    const subType = pattern.sub ? ` (${pattern.sub.toUpperCase()})` : "";
    const cards = pokerGame.lastMoveCards;

    // 3. ğŸ”¥ ã€ç‰©ç†æ‰‡å½¢æ¼”ç®—ã€‘
    const total = cards.length;
    const centerIdx = (total - 1) / 2; 
    const angleStep = total > 1 ? 8 : 0; 
    const horizontalStep = total > 5 ? 35 : 45; 

    const cardHtml = cards.map((c, idx) => {
        // åˆ¤å®šé¡è‰²
        const isRed = (c.suit === 'â™¥' || c.suit === 'â™¦');
        
        // ğŸ”¥ ã€æ ¸å¿ƒä¿®æ­£ Aã€‘å®šç¾©å¹»å½±å±¬æ€§ (ä¸‰ä½ä¸€é«”åˆ¤å®š)
        const isPhantom = (c.value === 'JOKER' || c.fromSiege || c.fromBlackMarket || c.isPhantom);
        
        // ğŸ”¥ ã€æ ¸å¿ƒä¿®æ­£ Bã€‘æŒ‡æ´¾ CSS ç‰¹æ•ˆé¡åˆ¥
        const vfxClass = isPhantom ? 'phantom-card-vfx' : '';

        // --- ç‰©ç†åº§æ¨™è¨ˆç®— ---
        const rotate = (idx - centerIdx) * angleStep;
        const translateX = (idx - centerIdx) * horizontalStep;
        const translateY = Math.abs(idx - centerIdx) * 6;

        return `
            <div class="table-card-vfx ${vfxClass}" style="
                position: absolute;
                background: white;
                color: ${isRed ? '#c0392b' : (isPhantom ? '#8e44ad' : '#2c3e50')}; 
                padding: 15px 10px;
                border-radius: 8px;
                font-weight: 900;
                font-size: 26px; 
                box-shadow: -5px 5px 15px rgba(0,0,0,0.5);
                min-width: 48px;
                text-align: center;
                transform: translate(${translateX}px, ${translateY}px) rotate(${rotate}deg);
                transform-origin: bottom center;
                z-index: ${100 + idx};
                transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
                user-select: none;
                border: ${isPhantom ? 'none' : '1px solid #ccc'}; /* å¹»å½±ç‰Œé‚Šæ¡†äº¤çµ¦ CSS æ§åˆ¶ */
            ">
                ${c.isFake ? '<div class="fake-tag">è´—</div>' : ''}
                
                ${c.label}
                
                ${isPhantom ? `<div style="position:absolute; bottom:2px; right:2px; font-size:8px; opacity:0.5;">âœ¨</div>` : ''}
            </div>
        `;
    }).join('');

    return `
        <div style="color:#f1c40f; font-size:11px; position:absolute; top:15px; opacity:0.8; font-family:monospace; letter-spacing:2px; z-index:200; text-shadow:0 0 5px #000;">
            LAST_ACTOR: <span style="color:#fff; background:rgba(255,255,255,0.1); padding:2px 6px; border-radius:3px;">${pokerGame.lastPlayerName || 'NONE'}</span>
        </div>

        <div style="position:relative; width:100%; height:120px; display:flex; align-items:center; justify-content:center; transform: translateY(-10px);">
            ${cardHtml}
        </div>

        <div style="position:absolute; bottom:15px; color:#2ecc71; font-size:14px; font-weight:bold; letter-spacing:3px; font-family:monospace; text-shadow: 0 0 12px rgba(46,204,113,0.5); z-index:200; background:rgba(0,0,0,0.4); padding:4px 15px; border-radius:20px; border:1px solid rgba(46,204,113,0.2);">
            ã€ ${patternType}${subType} ã€‘
        </div>
    `;
}


/**
 * ğŸƒ æ¸²æŸ“ç‰Œæ¡Œ UIï¼šå…¨å¹…é‚Šéš›è§£æ”¾èˆ‡æ“ä½œå¼•åŠ›é–å®š (V5.5 è·äººåŠ å›ºç‰ˆ)
 * ä¿®æ­£ï¼š
 * 1. å…¨å¹…åŒ–ï¼šwidth 100vwï¼Œåˆ©ç”¨æ‰€æœ‰é‚Šéš›ç©ºé–“ã€‚
 * 2. é›¶è·é›¢ï¼šæŒ‰éˆ•ç¾¤é€éç‰©ç†åç§»ç›´æ¥ã€Œå£“ã€åœ¨æ‰‹ç‰Œä¸Šã€‚
 * 3. è¦–èªå¼·åŒ–ï¼šå´é‚Šæ¬„èˆ‡æ°£æ³¡æ¡†ç‰©ç†è¦æ ¼åŒæ­¥å¢å¤§ã€‚
 */
function renderPokerTable(container) {
    if (!container) return;

    // ğŸ›¡ï¸ ç‰©ç†æª¢æŸ¥ï¼šç¢ºä¿ç³»çµ±æ•¸æ“šéˆè·¯å°±ç·’ [cite: 2026-01-21]
    if (typeof ensureKingdomSystem === 'function') ensureKingdomSystem();
    if (typeof ensureBattleLogMonitor === 'function') ensureBattleLogMonitor();

    const hero = pokerGame.players.find(p => p.id === 'player');
    const heroIdx = pokerGame.players.findIndex(p => p.id === 'player');
    const isMyTurn = (pokerGame.turn === heroIdx);

    // 1. ğŸ”¥ ã€ç‰©ç†è¦–è¦ºæ³¨å…¥ã€‘å…¨åŸŸè¦–åœ–é˜²ç¦¦ (é˜²æ­¢æŒ‰éˆ•é£„ç§»èˆ‡èèŸ»å­—é«”)
    const styleId = 'v5-layout-enforcer';
    if (!document.getElementById(styleId)) {
        const style = document.createElement('style');
        style.id = styleId;
        style.innerHTML = `
            /* ğŸ’¬ è·äººç™½æ°£æ³¡ï¼šé«˜å°æ¯”å’Œè«§ç‰ˆ */
            .speech-bubble {
                position: absolute; bottom: 105% !important; left: 60% !important;
                background: #ffffff !important; color: #000 !important;
                padding: 12px 18px !important; border-radius: 18px 18px 18px 2px !important;
                border: 3px solid #2c3e50 !important; font-size: 15px !important; font-weight: 900 !important;
                min-width: 150px; z-index: 50000 !important; display: none; opacity: 0;
                box-shadow: 8px 8px 0px rgba(0,0,0,0.2) !important; transition: 0.3s;
            }
            .speech-bubble::after {
                content: ''; position: absolute; bottom: -15px; left: -3px;
                border-width: 15px 15px 0 0; border-style: solid; border-color: #2c3e50 transparent transparent transparent;
            }
            .speech-bubble.active { display: block !important; opacity: 1 !important; transform: translateY(-5px); }

            /* å´é‚Šæ¬„é«˜å¼·åº¦ç›£æ§è¦æ ¼ */
            #poker-kingdom-sidebar b { font-size: 17px !important; }
            #poker-kingdom-sidebar span { font-size: 14px !important; }
            #poker-kingdom-sidebar button { font-size: 15px !important; font-weight: bold !important; height: 48px !important; }
        `;
        document.head.appendChild(style);
    }

    // 2. ğŸ”¥ ã€æ ¸å¿ƒç”Ÿæˆã€‘åŸ·è¡Œåº§æ¨™ç‰©ç†æ ¡æº–
    // ä½ˆå±€é‚è¼¯ï¼šæˆ°å ´å…¨å±•é–‹ï¼Œæ“ä½œä¸­æ¨ç›´æ¥å¸é™„æ–¼æ‰‹ç‰Œ [cite: 2026-01-19]
    container.innerHTML = `
        <div id="poker-layout-wrapper" style="display:flex; width:100vw; height:95vh; margin:0; padding:0; box-sizing:border-box; gap:0; align-items:stretch; overflow:hidden; background:#0a0a0a;">
            
            <div id="battle-main-section" style="flex: 1; display:flex; flex-direction:column; align-items:center; position:relative; padding:10px;">
                
                <div style="width:100%; max-width:1200px; margin-bottom: 5px;">
                    ${renderBattleHeader(hero)}
                </div>
                
                <div id="ai-section-wrapper" style="width: 100%; max-width: 1300px; display: flex; justify-content: space-around; margin-bottom: 30px; padding: 10px 40px 0 40px; position:relative; z-index:1000;">
                    ${renderAIPlayerSection()}
                </div>
                
                <div id="table-center" style="flex: 1; width:100%; max-width:1200px; min-height:220px; border:2px solid #333; background:radial-gradient(circle, #1a1a1a 0%, #000 100%); border-radius:25px; display:flex; align-items:center; justify-content:center; position:relative; box-shadow: 0 20px 80px rgba(0,0,0,1); z-index:500;">
                    ${renderCurrentTableCards()}
                </div>

                <div id="player-command-dock" style="width: 100%; max-width: 1100px; display: flex; flex-direction: column; align-items: center; margin-top: 5px; position:relative; z-index:2000;">
                    
                    <div id="poker-button-cluster" style="display:flex; flex-direction:column; align-items:center; transform: translateY(12px); z-index: 10;">
                        <div id="poker-helper-bar" style="display:flex; gap:4px; flex-wrap:wrap; justify-content:center; min-height:30px; margin-bottom: 2px;"></div>
                        ${renderPlayerControls(isMyTurn)}
                    </div>

                    <div id="player-interaction-wrapper" style="display: flex; align-items: flex-end; justify-content: center; gap: 10px; width: 100%; background:rgba(255,255,255,0.03); padding: 25px 15px 5px 15px; border-radius: 30px 30px 0 0; border:1px solid rgba(255,255,255,0.05); border-bottom:none;">
                        <div style="flex-shrink: 0; transform: scale(1.05); transform-origin: bottom; margin-right: 15px;">
                            ${renderTacticalHUD()}
                        </div>
                        
                        <div id="player-hand-container" style="flex: 1; min-width: 0;">
                            ${renderPlayerHand(hero)}
                        </div>
                    </div>
                </div>
            </div>

            <div id="poker-kingdom-sidebar" style="width:280px; flex-shrink:0; background:rgba(15,15,15,0.95); border-left:1px solid #333; padding:15px; overflow-y:auto; scrollbar-width: thin;">
                ${renderSidebarModules()}
            </div>
        </div>
    `;

    // 3. ğŸ”¥ ã€ç‰©ç†æ›è¼‰é–ã€‘
    setTimeout(() => {
        // æˆ°è¡“è¼”åŠ©é»ç« (ç‰©ä»¶æŒ‡æ¨™æ¯”å°)
        if (isMyTurn && typeof window.updateTacticalHelper === 'function') {
            window.updateTacticalHelper(false);
        }

        // æ ¸å¿ƒæŒ‰éˆ•ç‰©ç†é‡ç¶
        const actBtn = document.getElementById('btn-poker-act');
        if (actBtn) actBtn.onclick = () => window.confirmPlayerMove();
        const passBtn = document.getElementById('btn-poker-pass');
        if (passBtn) passBtn.onclick = () => window.playerPass();
        const logBtn = document.getElementById('btn-poker-log');
        if (logBtn) logBtn.onclick = () => window.toggleBattleLog();

        // ç‹€æ…‹é‚„åŸ
        if (window.isLogDrawerOpen) { 
            const monitor = document.getElementById('battle-log-monitor'); 
            if (monitor) monitor.style.display = 'flex'; 
        }

        console.log("%cğŸ å…¨å¹…ç©ºé–“æ ¡æº–é”æˆï¼šå¼•åŠ›å·²é–å®šï¼Œåº§æ¨™ç„¡åå·®ã€‚", "color: #2ecc71; font-weight: bold;");
    }, 80);
}

/**
 * ğŸº ç‰©ç†å­ç¨‹åºï¼šå·¨å¤§è£œè¡€ç½å†ç”Ÿå¼•æ“ (V5.9.22 å¾©ç”¦å¢å¼·ç‰ˆ)
 * ä¿®æ­£é»ï¼š
 * 1. ç§»é™¤ 0 HP æ””æˆªï¼šå…è¨±å¾æ­»äº¡é‚Šç·£å•Ÿå‹•æ¶²é¢å›å‡ï¼Œè§£æ±ºã€Œè—¥ç“¶ç„¡æ•ˆã€ä¹‹ç‰©ç† Bugã€‚ [cite: 2026-02-06]
 * 2. æ ¼å¼åŒæ­¥ï¼šæ¯ç§’æ›´æ–°æ•¸å€¼ç‚ºã€ŒHP99 / HP999ã€æ ¼å¼ï¼Œä¸¦ç½®é ‚é¡¯ç¤ºã€‚
 * 3. è¦–è¦ºæŸ“è‰²ï¼šå†ç”ŸæœŸé–“æ¶²é¢å…·å‚™ç¶ è‰²å‘¼å¸è„ˆè¡ï¼Œå¼·åŒ–å­˜åœ¨æ„Ÿã€‚
 */
async function useHpPot() {
    // 1. ğŸ›¡ï¸ ç‰©ç†æª¢æŸ¥ï¼šç¢ºä¿ç‰©å“æ¬„æœ‰è²¨
    if (!player.items || (player.items.hp_pot || 0) <= 0) {
        showNotification("âŒ å·¨å¤§è£œè¡€ç½å·²ç”¨ç›¡ï¼");
        return;
    }

    // 2. ğŸ’¸ ç‰©ç†æ¶ˆè€—èˆ‡æ—¥èªŒå¯«å…¥
    player.items.hp_pot--;
    addBattleLog(`ğŸº <b style="color:#2ecc71;">[ç‰©ç†å¾©ç”¦]</b> å•Ÿå‹•å·¨å¤§è£œè¡€ç½ï¼Œç”Ÿå‘½èƒ½é‡ç ´é™¤æ­»ç·šé–‹å§‹æµå‹•...`);
    showNotification("âœ¨ å†ç”Ÿç‹€æ…‹å•Ÿå‹•ï¼šæ­£åœ¨å¼·è¡ŒçºŒå‘½...");

    // 3. ğŸ”¥ ã€è¨ˆæ™‚å™¨å®‰å…¨é–¥ã€‘
    if (window.hpRegenTimer) {
        clearInterval(window.hpRegenTimer);
        window.hpRegenTimer = null;
    }

    let remainingTicks = 60; // ç‰©ç†æŒçºŒæ™‚é–“ï¼š60 ç§’

    // 4. ğŸ¬ é»ç‡ƒå†ç”Ÿå¾ªç’°
    window.hpRegenTimer = setInterval(() => {
        // ğŸ”¥ ã€æ ¸å¿ƒä¿®æ­£ Aã€‘ç§»é™¤ player.currentHp <= 0 çš„çµ‚æ­¢æ¢ä»¶
        // ç‰©ç†æ„ç¾©ï¼šå³ä¾¿ HP ç‚º 0ï¼Œåªè¦å°å±€é‚„åœ¨ï¼Œå†ç”Ÿå°±ä¸æœƒä¸­æ–·ã€‚ [cite: 2026-02-06]
        if (remainingTicks <= 0 || !pokerGame.gameActive) {
            clearInterval(window.hpRegenTimer);
            window.hpRegenTimer = null;
            if (remainingTicks <= 0) addBattleLog("â³ å†ç”Ÿç¨‹åºå·²ç‰©ç†å®Œæˆã€‚");
            return;
        }

        // åŸ·è¡Œæ¢å¾©ï¼šæ¯ç§’ç‰©ç†æ³¨å…¥ 20 HP
        player.currentHp = Math.min(player.maxHp, player.currentHp + 20);
        remainingTicks--;

        // 5. ğŸ¨ ç‰©ç†æ¸²æŸ“åŒæ­¥
        if (typeof updatePlayerUI === 'function') updatePlayerUI();
        
        // é‡å°ç‰Œæ¡Œå…§çš„ç”Ÿå‘½çƒé€²è¡Œæ‰‹è¡“å¼æ›´æ–°
        const liquid = document.querySelector('.hp-liquid');
        const hudHpText = document.getElementById('hud-hp-number');
        
        if (hudHpText) {
            // å¼·åˆ¶å°é½Šæ ¼å¼ï¼šHP99 / HP999 [cite: 2026-02-06]
            hudHpText.innerText = `HP${Math.floor(player.currentHp)} / HP${player.maxHp}`;
        }

        if (liquid) {
            const hpPercent = Math.max(0, (player.currentHp / player.maxHp) * 100);
            liquid.style.height = `${hpPercent}%`;
            // ğŸ§ª å†ç”Ÿç‹€æ…‹å°ˆå±¬ï¼šè³¦äºˆé«˜é£½å’Œåº¦çš„ç¿ ç¶ å¾®å…‰
            liquid.style.boxShadow = "0 0 30px rgba(46, 204, 113, 0.8), inset 0 0 10px #fff";
            liquid.style.filter = "hue-rotate(90deg) brightness(1.2)";
        }

    }, 1000); // ç‰©ç†é »ç‡ï¼š1Hz (æ¯ç§’ä¸€æ¬¡)

    // 6. ğŸ’¾ æ•¸æ“šé–å®šèˆ‡é‡ç¹ª [cite: 2026-01-21]
    if (typeof savePlayerToDB === 'function') await savePlayerToDB();
    
    // åˆ·æ–°ç•¶å‰ç‰Œæ¡Œ HUDï¼Œç¢ºä¿è—¥ç“¶æ•¸é‡å³æ™‚æ‰£é™¤
    if (typeof renderPokerTable === 'function') {
        renderPokerTable(document.getElementById('poker-table'));
    }
}


/**
 * ğŸ§ª ç‰©ç†å­ç¨‹åºï¼šè§£é™¤ç•°å¸¸ç‹€æ…‹
 */
async function cureStatus(targetStatus) {
    const items = player.items || {};
    const itemMap = {
        'poison': { id: 'antidote', name: 'ç‰¹æ•ˆè§£æ¯’è—¥' },
        'bleed': { id: 'hemostat', name: 'æ­¢è¡€åŠ‘' },
        'paralyze': { id: 'stimulant', name: 'èˆˆå¥®åŠ‘' }
    };

    const cure = itemMap[targetStatus];
    if (!cure || (items[cure.id] || 0) <= 0) {
        showNotification(`âŒ ç¼ºå°‘ ${cure ? cure.name : 'è—¥åŠ‘'}ï¼`);
        return;
    }

    // ç‰©ç†æ¶ˆè€—èˆ‡ç‹€æ…‹æ¸…é™¤
    player.items[cure.id]--;
    player.status = null; // ç‰©ç†æ·¨åŒ–ç‹€æ…‹æ¬„

    addBattleLog(`ğŸ§ª <b style="color:#3498db;">[æ·¨åŒ–]</b> ä½¿ç”¨ ${cure.name}ï¼Œç‰©ç†æ¸…é™¤äº†ã€${targetStatus.toUpperCase()}ã€‘ï¼`);
    showNotification(`âœ¨ ç‹€æ…‹å·²æ¢å¾©æ­£å¸¸`);

    // åŒæ­¥é‡ç¹ª
    updatePlayerUI();
    renderPokerTable(document.getElementById('poker-table'));
    if (typeof savePlayerToDB === 'function') await savePlayerToDB();
}

/**
 * ğŸ©¸ æ”»æ“Šç•°å¸¸è§¸ç™¼å”è­°
 * åœ‹ç‹(ä¸­æ¯’)ã€è²´æ—(å‡ºè¡€)ã€å¥´éš¸(éº»ç—º)
 */
function checkStatusAttack(attacker) {
    const roll = Math.random() * 100;
    let effect = null;
    const chance = pokerGame.isBerserkKingActive ? 10 : 3;

    if (roll < chance) {
        if (attacker.rank === 'king') effect = 'poison';
        if (attacker.rank === 'noble') effect = 'bleed';
        if (attacker.rank === 'slave') effect = 'paralyze';
    }

    if (effect) {
        player.status = effect;
        showNotification(`ğŸ’€ é­åˆ°ç‰©ç†å¨å£“ï¼šé™·å…¥ã€${effect.toUpperCase()}ã€‘ç‹€æ…‹ï¼`);
    }
}


/**
 * ğŸ’‰ ç‰©ç†é‡æ§‹ï¼šDiablo é¢¨æ ¼æˆ°è¡“ HUD (V5.9.27 æœ€çµ‚æ ¡æº–ç‰ˆ)
 * ä¿®æ­£é»ï¼š
 * 1. åœ–å±¤å°é½Šï¼šæ•¸å€¼å®¹å™¨ç½®æ–¼ Z-Index 10ï¼Œç¢ºä¿ç‰©ç†ç½®é ‚æ–¼æ¶²é«”èˆ‡é«˜å…‰ä¹‹ä¸Šã€‚
 * 2. æ ¼å¼è¦ç¯„ï¼šHP${cur} / HP${max} ç‰©ç†æ ¼å¼ï¼Œå­—ç´šç¸®æ”¾é–å®šä»¥é˜²æº¢å‡ºã€‚ [cite: 2026-02-06]
 * 3. ç‰©è³‡é–˜é–€ï¼šç•¶å‹‡è€…ã€Œç„¡æ™ã€æ™‚é»æ“ŠæŒ‰éˆ•ç„¡æ•ˆï¼Œä¸¦ç™¼é€æˆ°è¡“æç¤ºã€‚ [cite: 2026-02-06]
 */
function renderTacticalHUD() {
    const currentHP = Math.floor(player.currentHp || 0);
    const maxHP = player.maxHp || 50;
    const hpPercent = Math.max(0, Math.min(100, (currentHP / maxHP) * 100));
    const heroIcon = (player.lv >= 40) ? "ğŸ§™â€â™‚ï¸" : (player.lv >= 20 ? "âš”ï¸" : "ğŸš¶");
    const items = player.items || {};
    
    // ç‰©ç†è‡ªå®šç¾©æ§½ä½ (Slot 1~3)
    const slots = player.tacticalSlots || ['hp_pot', 'antidote', 'stimulant'];

    const itemMeta = {
        'hp_pot':    { icon: 'ğŸº', act: 'useHpPot()', name: 'å†é€ ç½' },
        'potion':    { icon: 'ğŸ§´', act: 'usePotionInPoker()', name: 'è—¥æ°´' },
        'antidote':  { icon: 'ğŸ§ª', act: "cureStatus('poison')", name: 'è§£æ¯’' },
        'hemostat':  { icon: 'ğŸ©¹', act: "cureStatus('bleed')", name: 'æ­¢è¡€' },
        'stimulant': { icon: 'ğŸ’‰', act: "cureStatus('paralyze')", name: 'èˆˆå¥®åŠ‘' },
        'none':      { icon: 'ğŸš«', act: '', name: 'ç©º' }
    };

    // ğŸ”¥ ã€æ ¸å¿ƒé‚è¼¯ï¼šç‰©ç†ç„¡æ™é–å®šåˆ¤å®šã€‘ [cite: 2026-02-06]
    // è¦å‰‡ï¼šHP å·²æ»¿ ä¸” æ²’æœ‰ä»»ä½•è² é¢ç‹€æ…‹ (ä¸­æ¯’/å‡ºè¡€/éº»ç—º)
    const isPerfectState = (currentHP >= maxHP && !player.status);

    return `
        <div id="tactical-hud" style="display:flex; flex-direction:column; align-items:center; margin-right:20px; position:relative; user-select:none;">
            <div id="bubble-player" class="speech-bubble"></div>

            <div style="width:50px; height:50px; border-radius:50%; border:2px solid #f1c40f; background:#111; display:flex; align-items:center; justify-content:center; font-size:28px; margin-bottom:10px; box-shadow: 0 0 15px rgba(0,0,0,0.5);">
                ${heroIcon}
            </div>

            <div class="hp-orb-container" style="position:relative; width:90px; height:90px; overflow:hidden; border-radius:50%; border:3px solid #222; background:#000;">
                <div class="hp-liquid" style="position:absolute; bottom:0; width:100%; height:${hpPercent}%; z-index: 1; transition: height 0.6s cubic-bezier(0.1, 0.9, 0.2, 1); background: linear-gradient(to top, #600 0%, #c0392b 70%, #ff4d4d 100%);"></div>
                
                <div class="hp-orb-glare" style="position:absolute; top:15%; left:20%; width:25%; height:25%; background:rgba(255,255,255,0.1); border-radius:50%; filter:blur(3px); z-index: 2; pointer-events:none;"></div>

                <div id="hud-hp-number" style="
                    position:absolute; width:100%; height:100%; top:0; left:0;
                    display:flex; align-items:center; justify-content:center;
                    z-index: 10; 
                    font-weight: 900; font-family: 'monospace'; font-size: 10px; 
                    color: #fff; text-shadow: 1px 1px 3px #000, 0 0 5px #000;
                    pointer-events: none; letter-spacing: -0.2px;
                ">
                    HP${currentHP} / HP${maxHP}
                </div>
            </div>

            <div class="inventory-slots-v4" style="display:grid; grid-template-columns: repeat(3, 1fr); gap:6px; margin-top:10px; padding:5px; background:rgba(0,0,0,0.4); border-radius:8px; border:1px solid #333;">
                ${slots.map(id => {
                    const info = itemMeta[id] || itemMeta['none'];
                    const count = items[id] || 0;
                    const hasStock = count > 0;
                    
                    // é–˜é–€æŒ‡ä»¤ï¼šè‹¥ç„¡æ™å‰‡ç‰©ç†æ””æˆª [cite: 2026-02-06]
                    const clickAct = isPerfectState 
                        ? `showNotification('âœ¨ ç›®å‰èº«å¿ƒç„¡æ™ï¼Œç„¡éœ€ä½¿ç”¨è—¥åŠ‘ã€‚')`
                        : (hasStock ? info.act : `showNotification('âŒ æ­¤ç‰©è³‡å·²å‘Šç½„')`);

                    return `
                        <div class="item-slot-v4 ${hasStock ? 'has-item' : ''}" 
                             onclick="${clickAct}"
                             style="width:32px; height:32px; background:rgba(10,10,10,0.9); border:1.5px solid ${hasStock ? (isPerfectState ? '#444' : '#2ecc71') : '#333'}; border-radius:4px; display:flex; align-items:center; justify-content:center; position:relative; cursor:${hasStock ? 'pointer' : 'not-allowed'}; transition:0.2s; opacity: ${isPerfectState && hasStock ? '0.6' : '1'};">
                            <span style="font-size:18px; filter:${hasStock ? 'none' : 'grayscale(1) opacity(0.3)'};">${info.icon}</span>
                            ${hasStock ? `<div class="slot-badge-v4" style="position:absolute; bottom:-2px; right:-2px; background:#2ecc71; color:#000; font-size:8px; padding:0 3px; border-radius:3px; font-weight:900;">${count}</div>` : ''}
                        </div>
                    `;
                }).join('')}
            </div>
        </div>
    `;
}

/**
 * ğŸ’“ ç‰©ç†å­ç¨‹åºï¼šç”Ÿå­˜é«”å¾µæ¯ç§’çµç®— (V5.9.18 æ–‡å­—å°æ­£ç‰ˆ)
 * æ•´åˆï¼šç²¾ç¢ºæ ¼å¼æ¸²æŸ“ (HP99 / HP999)ã€å†ç”Ÿçµç®—ã€æ¯’ç´ æ³¢ç´‹èˆ‡ç‰©ç†é˜²ä½ç§»ç‰¹æ•ˆã€‚
 */
function handleSurvivalTicks() {
    // 0. ğŸ”¥ ã€ç‰©ç†åˆ¶å‹•ã€‘ç¢ºä¿æˆ°å ´æ´»èºä¸”å‹‡è€…å­˜æ´»
    if (!pokerGame.gameActive || player.currentHp <= 0) return;

    // 1. ğŸ†™ ã€ç­‰ç´šéš¨å‹•å†ç”Ÿã€‘
    // ç‰©ç†å…¬å¼ï¼šæ¯ç§’æ¢å¾© (ç­‰ç´š / 10) + 1 é»ç”Ÿå‘½å€¼
    const regenAmount = Math.floor(player.lv / 10) + 1;
    
    // ç‰©ç†é™åˆ¶ï¼šè‹¥è™•æ–¼ã€Œéº»ç—ºã€æˆ–ã€Œå‡ºè¡€ã€ï¼Œå†ç”Ÿæ•ˆèƒ½è¡°æ¸› 50% [cite: 2026-02-06]
    const finalRegen = (player.status === 'paralyze' || player.status === 'bleed') 
                       ? Math.floor(regenAmount / 2) : regenAmount;

    // å‡ºè¡€ç‹€æ…‹ä¸‹ç‰©ç†ç¦æ­¢è‡ªå‹•å›è¡€ï¼Œå…¶é¤˜ç‹€æ…‹åŸ·è¡Œå†ç”Ÿ
    if (player.currentHp < player.maxHp && player.status !== 'bleed') {
        player.currentHp = Math.min(player.maxHp, player.currentHp + finalRegen);
    }

    // 2. ğŸ’€ ã€ç•°å¸¸ç‹€æ…‹ç‰©ç†ä¾µè•ã€‘
    if (player.status === 'poison') {
        // ä¸­æ¯’ï¼šç‰©ç†æ‰£é™¤ 1% æœ€å¤§ç”Ÿå‘½
        player.currentHp = Math.max(1, player.currentHp - (player.maxHp * 0.01));
        if (typeof triggerPoisonParticles === 'function') triggerPoisonParticles();
    } else if (player.status === 'bleed') {
        // å‡ºè¡€ï¼šç‰©ç†æ‰£é™¤å›ºå®š 20 é»ç”Ÿå‘½
        player.currentHp = Math.max(1, player.currentHp - 20);
    }

    // 3. ğŸ¨ ã€ç‰©ç†åŒæ­¥æ¸²æŸ“ï¼šæ ¼å¼æ ¡æº–å±¤ã€‘
    const liquid = document.querySelector('.hp-liquid');
    const hudHpText = document.getElementById('hud-hp-number');
    
    // å–å¾—ç•¶å‰æ•´æ•¸å€¼
    const curHP = Math.floor(player.currentHp);
    const maxHP = player.maxHp || 50;

    // ğŸ”¥ ã€æ ¸å¿ƒä¿®æ­£ï¼šç‰©ç†æ ¼å¼å°é½Šã€‘ [cite: 2026-02-06]
    // æ ¼å¼è¦ç¯„ï¼šHP99 / HP999 (ç½®ä¸­é¡¯ç¤ºæ–¼ç”Ÿå‘½çƒæœ€é ‚å±¤)
    if (hudHpText) {
        hudHpText.innerText = `HP${curHP} / HP${maxHP}`;
    }
    
    // ç‰©ç†æ¶²é¢é«˜åº¦æ›´æ–°
    if (liquid) {
        const hpPercent = Math.max(0, (curHP / maxHP) * 100);
        liquid.style.height = `${hpPercent}%`;
        
        // ç‹€æ…‹é¡è‰²è¼”åŠ©åˆ¤å®š
        if (player.status === 'poison') {
            liquid.style.filter = "hue-rotate(90deg) brightness(0.8)"; // ç¶ è‰²
        } else if (player.status === 'bleed') {
            liquid.style.filter = "brightness(1.5) contrast(1.2)"; // é®®ç´…è„ˆè¡
        } else {
            liquid.style.filter = "none";
        }
    }

    // 4. ğŸ›¡ï¸ ã€åº§æ¨™åç§»é˜²ç¦¦ã€‘ä½è¡€é‡ç„¡è¦–è¦ºä½ç§»ç‰¹æ•ˆ
    const hpRatio = curHP / maxHP;
    const wrapper = document.querySelector('.main-wrapper');
    if (wrapper) {
        if (hpRatio <= 0.3 && (player.status === 'bleed' || player.status === 'poison')) {
            if (!wrapper.classList.contains('low-hp-pulsing')) {
                wrapper.classList.add('low-hp-pulsing');
            }
        } else {
            wrapper.classList.remove('low-hp-pulsing');
        }
    }

    // 5. ğŸ’¾ ã€å…¨åŸŸ UI åŒæ­¥ã€‘æ›´æ–°ç‹€æ…‹åˆ—
    if (typeof updatePlayerUI === 'function') updatePlayerUI();
}

/**
 * ğŸ¬ ç‰©ç†å­ç¨‹åºï¼šç”Ÿæˆæ¯’ç´ æ°£æ³¡ç²’å­
 * ä½œç”¨ï¼šåœ¨ç”Ÿå‘½ä¹‹çƒå®¹å™¨å…§ç‰©ç†æ³¨å…¥éš¨æ©Ÿé£„ç§»çš„æ°£æ³¡ç‰©ä»¶
 */
function triggerPoisonParticles() {
    const orbContainer = document.querySelector('.hp-orb-container');
    if (!orbContainer) return;

    // A. ğŸ”¥ ã€å®¹å™¨å®‰å…¨æ€§æª¢æŸ¥ã€‘ç¢ºä¿æ›è¼‰å±¤å­˜åœ¨
    let bubbleLayer = orbContainer.querySelector('.poison-bubbles-container');
    if (!bubbleLayer) {
        bubbleLayer = document.createElement('div');
        bubbleLayer.className = 'poison-bubbles-container';
        orbContainer.appendChild(bubbleLayer);
    }

    // B. ğŸ”¥ ã€ç‰©ç†ç”Ÿæˆã€‘éš¨æ©Ÿç”¢ç”Ÿ 3-5 å€‹æ°£æ³¡
    const count = Math.floor(Math.random() * 3) + 2;
    for (let i = 0; i < count; i++) {
        setTimeout(() => {
            const bubble = document.createElement('div');
            bubble.className = 'poison-bubble';
            
            // ç‰©ç†åƒæ•¸é…ç½®ï¼šéš¨æ©Ÿå¤§å°ã€èµ·å§‹ä½ç½®èˆ‡é£„ç§»å¹…åº¦
            const size = Math.random() * 7 + 4; // 4px - 11px
            const startX = Math.random() * 80 + 10; // 10% - 90%
            const drift = (Math.random() - 0.5) * 45; // -22.5px to 22.5px
            
            bubble.style.width = `${size}px`;
            bubble.style.height = `${size}px`;
            bubble.style.left = `${startX}%`;
            bubble.style.setProperty('--drift', `${drift}px`);
            
            bubbleLayer.appendChild(bubble);

            // C. ç‰©ç†å›æ”¶ï¼šå‹•ç•«çµæŸå¾Œè‡ªå‹•å¾ DOM æ¨¹ç§»é™¤
            setTimeout(() => bubble.remove(), 2500);
        }, i * 200); // åŸ·è¡Œæ™‚é–“éŒ¯é–‹ï¼Œç‡Ÿé€ ç‰©ç†å±¤æ¬¡æ„Ÿ
    }
}

// å•Ÿå‹•å…¨åŸŸç”Ÿå­˜æ™‚é˜
setInterval(handleSurvivalTicks, 1000);


function renderBattleHeader(hero) {
    const vipThemeColor = player.hasVipCard ? "#9b59b6" : "#f1c40f";
    return `
        <div style="display:flex; justify-content:space-between; align-items:flex-end; margin-bottom:10px; width:100%; max-width:850px; padding:0 5px; position:relative;">
            <div style="text-align:left;">
                <div style="color:#fff; font-size:16px; font-weight:900;">${getPlayerRankName()}</div>
                <div style="margin-top:2px; padding:1px 10px; background:rgba(0,0,0,0.6); border:1px solid ${vipThemeColor}; border-radius:15px; color:${vipThemeColor}; font-weight:bold; font-size:12px; box-shadow:0 0 10px ${vipThemeColor}33;">
                    ğŸ’° ${(player.coin || 0).toLocaleString()} G
                </div>
            </div>
            ${pokerGame.isKingSiege ? `
                <div class="siege-warning-pulse" style="position:absolute; top:-10px; left:50%; transform:translateX(-50%); background:#600; color:#ff4d4d; border:1px solid #f00; padding:4px 15px; border-radius:20px; font-size:11px; font-weight:bold; letter-spacing:2px; box-shadow:0 0 15px #f00; z-index:1000;">
                    âš–ï¸ åœ‹ç‹åŒ…åœç¶² ACTIVE
                </div>
            ` : ''}
            <div style="text-align:right;">
                <div style="color:#aaa; font-size:9px; font-family:monospace; letter-spacing:1px;">ğŸ† POT</div>
                <div style="color:#2ecc71; font-size:14px; font-weight:bold; font-family:monospace;">$${(pokerGame.playerPot || 10000).toLocaleString()}</div>
            </div>
        </div>`;
}

/**
 * ğŸ•¹ï¸ å­æ¨¡çµ„ï¼šæ¸²æŸ“ AI ç©å®¶å€åŸŸ (ç©ºé–“å»£åŸŸç‰ˆ)
 * ä¿®æ­£ï¼šå°‡ justify-content æ”¹ç‚º space-around ä¸¦å¢åŠ  max-widthï¼Œå¾¹åº•æ‹‰é–‹é–“è·
 */
function renderAIPlayerSection() {
    const hasScoutBoon = (pokerGame.activeBoon === 'scout');
    
    return `
        <div id="ai-players" style="display:flex; justify-content:space-around; width:100%; max-width:1000px; margin-bottom:10px; padding:0 30px; position:relative; z-index:1000;">
            ${pokerGame.players.map((p, idx) => p.id === 'player' ? '' : `
                <div class="card-player ${pokerGame.isKingSiege && p.rank !== 'king' ? 'rebel-ally-active' : ''} ${pokerGame.isBerserkKingActive && p.rank === 'king' ? 'king-berserk-active' : ''}" 
                     style="position:relative; border: 1px solid ${pokerGame.turn === idx ? '#f1c40f' : '#333'}; 
                            background:rgba(15,15,15,0.9); padding:8px; border-radius:12px; width:125px; 
                            text-align:center; transition:0.3s; flex-shrink:0; 
                            overflow:visible !important;">
                    
                    <div id="bubble-${idx}" class="speech-bubble" style="display:none; position:absolute; bottom:115%; left:50%; transform:translateX(-50%); width:130px; z-index:5000;"></div>
                    
                    <div class="${getRankClass(p.rank)}" style="font-weight:bold; font-size:11px; text-shadow: 0 0 5px rgba(0,0,0,0.5);">
                        ${p.name}
                        <div style="color:#f1c40f; font-size:10px; margin-top:1px;">ğŸ’° ${(p.coins || 0).toLocaleString()}</div>
                    </div>

                    <div style="display:flex; justify-content:center; margin-top:5px; height:35px; position:relative;">
                        ${p.cards.slice(0, 5).map((card, cIdx) => `
                            <div style="position:absolute; left:calc(15% + ${cIdx * 6}px); width:20px; height:30px; 
                                        background:${hasScoutBoon ? 'rgba(255,255,255,0.95)' : '#c0392b'}; 
                                        border:1px solid #fff; border-radius:3px; box-shadow: 1px 1px 3px rgba(0,0,0,0.3);">
                            </div>
                        `).join('')}
                        <div style="position:absolute; right:2px; top:-2px; background:#e74c3c; color:#fff; font-size:9px; padding:0 4px; border-radius:8px; font-weight:900; z-index:100; box-shadow:0 0 5px rgba(0,0,0,0.5);">
                            ${p.cards.length}
                        </div>
                    </div>

                    ${p.isPassed ? `
                        <div style="position:absolute; top:0; left:0; width:100%; height:100%; 
                                    background:rgba(0,0,0,0.75); border-radius:12px; display:flex; 
                                    align-items:center; justify-content:center; color:#e74c3c; 
                                    font-weight:bold; font-size:12px; z-index:200; backdrop-filter: blur(1px);">
                            PASS
                        </div>
                    ` : ''}
                </div>`).join('')}
        </div>`;
}

/**
 * ğŸƒ æ¸²æŸ“ç©å®¶æ‰‹ç‰Œï¼šç‰©ç†ç©ºé–“è§£æ”¾ç‰ˆ (V5.7)
 * ä¿®æ­£ï¼šæ”¾å¯¬èƒŒæ™¯å®¹å™¨ã€å¢åŠ é ‚éƒ¨å½ˆèµ·ç·©è¡ã€ç§»é™¤æ“æ“ æ„Ÿ
 */
function renderPlayerHand(hero) {
    // ğŸ”¥ ç‰©ç†åƒæ•¸æ ¡æº–
    // å¢åŠ  padding-top (35px) ä»¥å®¹ç´å½ˆèµ·çš„ç‰Œå¡
    // æ‹“å¯¬ max-width (1000px) è®“ç‰Œçµ„å±•é–‹æ›´è‡ªç„¶
    return `
        <div id="player-hand" style="
            display: flex; 
            flex-wrap: wrap; 
            justify-content: center; 
            gap: 8px; 
            width: 100%;
            max-width: 1000px; 
            min-height: 110px;
            padding: 35px 20px 15px 20px; 
            background: rgba(0, 0, 0, 0.5); 
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px; 
            box-shadow: inset 0 0 20px rgba(0,0,0,0.6);
            overflow: visible;
        ">
            ${hero.cards.map((c, idx) => {
                const isSelected = (window.selectedCards || []).includes(idx);
                const isPhantom = (c.value === 'JOKER' || c.fromSiege || c.fromBlackMarket || c.isPhantom);
                const vfxClass = isPhantom ? 'phantom-card-vfx' : '';
                
                // ç‰©ç†é–“è·ï¼šæ‰‹ç‰Œå¤šæ™‚è‡ªå‹•ç¸®å°è² é‚Šè·ï¼Œç¶­æŒç¾æ„Ÿ
                const margin = hero.cards.length > 13 ? '-10px' : '4px';
                
                return `
                    <div onclick="window.toggleCardSelection(${idx})" 
                         class="${vfxClass}" 
                         style="
                            width: 50px; 
                            height: 75px; 
                            background: #fff; 
                            color: ${(c.suit === 'â™¥' || c.suit === 'â™¦') ? '#c0392b' : (isPhantom ? '#8e44ad' : '#2c3e50')}; 
                            border-radius: 6px; 
                            cursor: pointer; 
                            font-weight: 900; 
                            font-size: 24px; 
                            border: 2px solid ${isSelected ? '#f1c40f' : (isPhantom ? '#9b59b6' : '#ddd')}; 
                            transform: translateY(${isSelected ? '-25px' : '0px'}) rotate(${isSelected ? '2deg' : '0deg'}); 
                            transition: all 0.15s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
                            box-shadow: ${isSelected ? '0 10px 25px rgba(0,0,0,0.6)' : '0 4px 10px rgba(0,0,0,0.4)'}; 
                            display: flex; 
                            align-items: center; 
                            justify-content: center; 
                            position: relative; 
                            margin-right: ${margin};
                            z-index: ${isSelected ? '100' : '10'};
                    ">
                        ${c.isFake ? '<div class="fake-tag" style="font-size:10px;">è´—</div>' : ''}
                        ${c.label}
                    </div>`;
            }).join('')}
        </div>`;
}

/**
 * ğŸ“Š ç‰©ç†å­ç¨‹åºï¼šå´é‚Šæ¬„æ¨¡çµ„å­—ä¸²ç”Ÿæˆå™¨ (V4.7 ç´”æ·¨ç‰ˆ)
 * ä¿®æ­£ï¼šç§»é™¤ DOM æ‰‹å‹•è³¦å€¼é‚è¼¯ï¼Œæ”¹ç‚ºç´”å­—ä¸²å›å‚³ï¼Œè§£æ±º image_4b0b43.png ä¹‹é‡è¤‡ç¾è±¡
 */
function renderSidebarModules() {
    // 1. ç‰©ç†æå–å„å­æ¨¡çµ„å­—ä¸² (ç¢ºä¿ä¸åœ¨æ­¤è™•æ“ä½œ DOM)
    const dashHtml = typeof renderKingdomDashboard === 'function' ? renderKingdomDashboard() : '';
    const tickerHtml = typeof renderStockTicker === 'function' ? renderStockTicker() : '';

    // 2. å°è£é‡‘èçµ±è¨ˆæ¨¡çµ„ (ç‰©ç†å°é½Š V4 åœ“è§’é¢¨æ ¼)
    const finStatsHtml = `
        <div style="background:rgba(15,15,15,0.95); border:1px solid #444; border-radius:12px; padding:12px; font-family:monospace; font-size:10px; margin-top:10px; box-shadow: 0 4px 10px rgba(0,0,0,0.3);">
            <div style="color:#f1c40f; border-bottom:1px solid #333; padding-bottom:5px; margin-bottom:8px; font-weight:bold; letter-spacing:1px;">ğŸ¦ FIN_STATS</div>
            <div style="display:flex; justify-content:space-between; margin-bottom:4px;">
                <span>ç´…åˆ©ç™¼æ”¾:</span> <b style="color:#2ecc71;">$${(window.kingdomSystem?.totalDividendsIssued || 0).toLocaleString()}</b>
            </div>
            <div style="display:flex; justify-content:space-between;">
                <span>æŠ•è³‡ç¸½é¡:</span> <b style="color:#fff;">$${(window.kingdomSystem?.playerInvestmentTotal || 0).toLocaleString()}</b>
            </div>
        </div>
    `;

    // 3. ğŸš€ ã€å¤§ä¸€çµ±å›å‚³ã€‘å°‡æ‰€æœ‰å´é‚Šå…ƒä»¶æ•´åˆç‚ºå–®ä¸€ç‡ƒæ–™åŒ…å­—ä¸²
    return `
        <div id="sidebar-scroll-container" style="transform: scale(0.95); transform-origin: top right; display: flex; flex-direction: column; gap: 10px;">
            ${dashHtml}
            ${tickerHtml}
            
            <button onclick="showFinancialCenter()" style="width:100%; background:linear-gradient(45deg, #b7950b, #f1c40f); color:#000; border:none; padding:12px; border-radius:10px; font-weight:bold; cursor:pointer; font-size:12px; box-shadow:0 4px 15px rgba(241,196,15,0.4); border:1px solid #fff; transition: 0.2s;">
                ğŸ›ï¸ é€²å…¥é‡‘èä¸­å¿ƒ
            </button>

            ${finStatsHtml}

            <button id="btn-poker-log" style="width:100%; background:#145a32; color:#2ecc71; border:1px solid #2ecc71; padding:10px; border-radius:8px; font-size:11px; cursor:pointer; font-weight:bold; margin-top:5px; transition: 0.2s;">
                ğŸ“Š æˆ°è¡“ç›£æ§æ—¥èªŒ
            </button>
        </div>
    `;
}


/**
 * ğŸ° ç‹åœ‹ç³»çµ±ï¼šç‰©ç†å®‰å®šå™¨ (ç¯€æµèˆ‡æ¢å¾©å¼·åŒ–ç‰ˆ)
 * ä¿®æ­£ï¼š
 * 1. ç¯€æµé–ï¼š2ç§’å…§ç¦æ­¢é‡è¦†åŸ·è¡Œï¼Œé˜²æ­¢æ´—ç‰ˆå¼åˆ·æ–°å°è‡´æ°£æ³¡æ¶ˆå¤±ã€‚
 * 2. å­˜æª”æ¢å¾©ï¼šå„ªå…ˆæª¢ç´¢ IndexedDB ä¸¦é–å®š candles æ­·å²æ•¸æ“šã€‚
 */
async function ensureKingdomSystem() {
    // ğŸ”¥ ã€ç‰©ç†ç¯€æµé–ã€‘é é˜²æ­»å¾ªç’°åˆ·æ–°
    if (window.lastEconomyInit && Date.now() - window.lastEconomyInit < 2000) return;
    window.lastEconomyInit = Date.now();

    // 0. ğŸ”¥ ã€ç‰©ç†å­˜æª”æª¢ç´¢ã€‘
    let savedData = null;
    try {
        savedData = await db.playerStats.get('hero');
    } catch (e) {
        console.warn("ğŸ“¡ è³‡æ–™åº«å°šæœªå°±ç·’ï¼Œå°‡ä½¿ç”¨å…§å­˜åˆå§‹åŒ–ã€‚");
    }

    // 1. ğŸ”¥ ã€ç‹åœ‹è¨­æ–½æ¢å¾©ã€‘
    if (!window.kingdomSystem) {
        if (savedData && savedData.kingdomSystem) {
            window.kingdomSystem = savedData.kingdomSystem;
            console.log("%cğŸ›ï¸ ç‹åœ‹å»ºè¨­æ•¸æ“šå·²ç‰©ç†æ¢å¾©ã€‚", "color: #f1c40f;");
        } else {
            window.kingdomSystem = {
                playerInvestmentTotal: 0, totalDividendsIssued: 0, treasury: 1000000,
                investmentCost: 2000, siphonCount: 0, lastSiphonedAmount: 0,
                upgrades: {
                    vault: { name: "ä¸­å¤®é‡‘åº«", lv: 0, max: 1000 },
                    mint:  { name: "çš‡å®¶é€ å¹£å» ", lv: 0, max: 1000 },
                    intel: { name: "åœ°ä¸‹æƒ…å ±å±€", lv: 0, max: 1000 },
                    trade: { name: "è¡€ç›Ÿè²¿æ˜“ç«™", lv: 0, max: 1000 },
                    arena: { name: "å¤§ç«¶æŠ€å ´", lv: 0, max: 1000 }
                }
            };
        }
    }

    // 2. ğŸ”¥ ã€è‚¡å¸‚å¯¦é«”éˆè·¯æ¢å¾©ã€‘
    if (!window.kingdomStocks || window.kingdomStocks.length === 0) {
        if (savedData && savedData.kingdomStocks && savedData.kingdomStocks.length > 0) {
            window.kingdomStocks = savedData.kingdomStocks;
            console.log("%cğŸ“ˆ è‚¡å¸‚æ­·å²è»Œè·¡èˆ‡ K ç·šå·²ç‰©ç†é‚„åŸã€‚", "color: #3498db;");
        } else if (typeof STOCK_LIST !== 'undefined') {
            window.kingdomStocks = STOCK_LIST.map(s => ({
                ...s, owned: 0, avgCost: 0, lastChange: 0,
                history: [s.price, s.price],
                candles: [{ o: s.price, h: s.price, l: s.price, c: s.price, t: Date.now() }]
            }));
        }
    }

    // 3. ğŸ”¥ ã€æ•¸æ“šè£œå®Œèˆ‡é˜²ç¦¦ã€‘
    window.kingdomStocks.forEach(s => {
        if (!s.history || s.history.length === 0) s.history = [s.price, s.price];
        if (!s.candles || s.candles.length === 0) {
            s.candles = [{ o: s.price, h: s.price, l: s.price, c: s.price, t: Date.now() }];
        }
        if (s.avgCost === undefined) s.avgCost = 0;
        if (s.owned === undefined) s.owned = 0;
    });

    console.log("%câœ… ç¶“æ¿Ÿå®‰å®šå™¨ï¼šç‰©ç†æ•¸æ“šå·²åŒæ­¥ï¼ˆé€²å…¥ 2s ç¯€æµå†·å»æœŸï¼‰ã€‚", "color: #27ae60; font-weight: bold;");
}

/**
 * ğŸ“Š ç‰©ç†å­ç¨‹åºï¼šç¢ºä¿æˆ°è¡“ç›£æ§å®¹å™¨å­˜åœ¨ (V5.9.14 ä¿®æ­£ç‰ˆ)
 * ä¿®æ­£ï¼šç‚º CLOSE æŒ‰éˆ•ç¶å®šç‰©ç†é»ç«æŒ‡ä»¤ï¼Œè§£æ±ºé»é¸ç„¡åæ‡‰ä¹‹ Bugã€‚
 */
function ensureBattleLogMonitor() {
    if (!document.getElementById('battle-log-monitor')) {
        const monitor = document.createElement('div');
        monitor.id = 'battle-log-monitor';
        
        // ç‰©ç†ä½ˆå±€ï¼šå›ºå®šå®šä½æ–¼å³ä¸‹è§’ï¼Œç¢ºä¿å±¤ç´šç½®é ‚
        monitor.style = `
            position: fixed; 
            bottom: 110px; 
            right: 30px; 
            width: 420px; 
            height: 550px; 
            background: rgba(5, 5, 5, 0.98); 
            border: 2px solid #2ecc71; 
            z-index: 150000; 
            display: none; 
            flex-direction: column; 
            border-radius: 12px; 
            box-shadow: 0 25px 80px rgba(0,0,0,1); 
            font-family: 'Consolas', monospace; 
            overflow: hidden; 
            backdrop-filter: blur(15px);
        `;

        // ğŸ”¥ ã€æ ¸å¿ƒä¿®æ­£ï¼šæ³¨å…¥ onclick å±¬æ€§ã€‘
        monitor.innerHTML = `
            <div style="background:#145a32; color:#2ecc71; padding:12px 18px; font-weight:bold; font-size:14px; display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #2ecc71;">
                <span>ğŸŸ¢ TACTICAL_MONITOR_STREAM</span>
                <button id="CLOSE_LOG_BTN" 
                        onclick="toggleBattleLog()" 
                        style="background:rgba(0,0,0,0.4); border:1px solid #2ecc71; color:#2ecc71; cursor:pointer; padding:4px 12px; border-radius:4px; font-size:11px; font-weight:bold; transition: 0.2s;"
                        onmouseover="this.style.background='#2ecc71'; this.style.color='#000';"
                        onmouseout="this.style.background='rgba(0,0,0,0.4)'; this.style.color='#2ecc71';">
                    CLOSE [X]
                </button>
            </div>
            <div id="log-content-stream" style="flex:1; overflow-y:auto; padding:20px; color:#2ecc71; font-size:13px; line-height:1.9; scrollbar-width: thin;"></div>
        `;
        
        document.body.appendChild(monitor);
        console.log("%cğŸ“Š æˆ°è¡“çµ‚ç«¯å·²åœ¨ç‰©ç†ç©ºé–“ç”Ÿæˆï¼Œé—œé–‰éˆè·¯å·²æ¿€æ´»ã€‚", "color: #2ecc71;");
    }
}

/**
 * ğŸ•¹ï¸ å­æ¨¡çµ„ï¼šæ¸²æŸ“ç©å®¶æ“ä½œæŒ‰éˆ•å€
 * @param {boolean} isMyTurn æ˜¯å¦ç‚ºç©å®¶å›åˆ
 */
function renderPlayerControls(isMyTurn) {
    // ç‰©ç†é–‹é—œï¼šæ ¹æ“šå›åˆç‹€æ…‹åˆ‡æ› HTML å…§å®¹
    if (isMyTurn) {
        return `
            <div style="display:flex; justify-content:center; gap:20px; height:45px; margin-bottom:10px;">
                <button id="btn-poker-act" class="btn-nhk" style="background:#1e8449; color:white; border:none; padding:0 40px; font-size:15px; font-weight:bold; border-radius:4px; cursor:pointer; box-shadow:0 4px 0 #145a32;">
                    ğŸ‘Š ACT
                </button>
                <button id="btn-poker-pass" class="btn-nhk" style="background:#2c3e50; color:#bdc3c7; border:none; padding:0 25px; font-size:13px; border-radius:4px; cursor:pointer; box-shadow:0 4px 0 #1a252f;">
                    ğŸ§¤ PASS
                </button>
            </div>
        `;
    } else {
        return `
            <div style="display:flex; justify-content:center; height:45px; margin-bottom:10px;">
                <div style="color:#f1c40f; font-weight:bold; font-size:18px; line-height:45px; animation: pulse 1.5s infinite; letter-spacing:2px; font-family:monospace;">
                    AI_DECIDING...
                </div>
            </div>
        `;
    }
}

/**
 * ğŸ’° ç‰©ç†æ“ä½œï¼šæ‰‹å‹•ä¸»å‹•æŠ•è³‡è¨­æ–½
 * @param {string} key è¨­æ–½ ID (vault, mint, intel, trade, arena)
 * ä¿®æ­£é»ï¼š
 * 1. æ•¸æ“šå¤§ä¸€çµ±ï¼šæ›´æ–° playerInvestmentTotal è§£æ±ºçœ‹æ¿æ•¸æ“šå ±éŒ¯é¢¨éšªã€‚
 * 2. åœ‹åº«å…±é³´ï¼šæ‰‹å‹•æŠ•è³‡çš„ 10% å°‡ç‰©ç†æµå…¥åœ‹åº«ï¼Œå¢åŠ çµ±æ²»è³‡æœ¬ã€‚
 * 3. å¤šé‡ UI é–å®šï¼šåŒæ™‚åˆ·æ–°æŠ•è³‡å¤§å»³èˆ‡æˆ°å ´å´é‚Šæ¬„çœ‹æ¿ã€‚
 */
function manualInvest(key) {
    const sys = window.kingdomSystem;
    
    // ğŸ›¡ï¸ ç‰©ç†å®‰å…¨æ€§æª¢æŸ¥ï¼šé˜²æ­¢å› åˆå§‹åŒ–é †åºå°è‡´çš„ç‰©ä»¶ç¼ºå¤±
    if (!sys || !sys.upgrades || !sys.upgrades[key]) {
        console.error(`âŒ ç‰©ç†è·¯å¾‘æ–·è£‚ï¼šæ‰¾ä¸åˆ°è¨­æ–½ ID [${key}]`);
        return;
    }

    const up = sys.upgrades[key];
    const cost = 5000; 

    // 1. ğŸ”¥ ã€ç‰©ç†æ¬Šé™é–€è¡›ã€‘
    if (player.coin < cost) {
        showNotification("ğŸ’€ è³‡é‡‘ä¸è¶³ï¼æ‰‹å‹•æŠ•è³‡éœ€è¦ $5,000 G");
        return;
    }
    if (up.lv >= 1000) {
        showNotification("â­ è©²è¨­æ–½å·²é”å‚³å¥‡æ¥µé™ï¼Œç„¡æ³•å†å¼·åŒ–ï¼");
        return;
    }

    // 2. ğŸ’¸ ã€åŸ·è¡Œç‰©ç†é‡‘æµã€‘
    player.coin -= cost;
    up.lv++;
    
    // ğŸ§± æ•¸æ“šå¯«å…¥ï¼šæ›´æ–°å…¨åŸŸçµ±è¨ˆå€¼ï¼Œè§£æ±º 1938 å ±éŒ¯æ ¸å¿ƒ
    sys.playerInvestmentTotal = (sys.playerInvestmentTotal || 0) + cost;

    // ğŸ¦ åœ‹åº«å…±é³´ï¼šæ‰‹å‹•æŠ•è³‡å…·å‚™ã€Œæº¢å‡ºæ•ˆæ‡‰ã€ï¼Œ10% çš„è³‡é‡‘æœƒç‰©ç†æ³¨å…¥åœ‹åº«å„²å‚™
    const treasuryBonus = Math.floor(cost * 0.1);
    sys.treasury = (sys.treasury || 0) + treasuryBonus;

    // 3. ğŸ“Š ã€æˆ°è¡“è¨˜éŒ„èˆ‡åé¥‹ã€‘
    addBattleLog(`ğŸ—ï¸ <b style="color:#f1c40f;">[ä¸»å‹•æŠ•è³‡]</b> æ‚¨æŠ•å…¥äº† $5,000G å¼·åŒ–äº†ã€${up.name}ã€‘ï¼`);
    addBattleLog(`ğŸ¦ <b style="color:#2ecc71;">[åœ‹åº«è£œçµ¦]</b> æŠ•è³‡ç”¢ç”Ÿçš„ç¨…æº¢è®“åœ‹åº«å¢åŠ äº† $${treasuryBonus}Gã€‚`);
    
    // 4. âœ¨ ã€ç‰©ç†è¦–è¦ºé»ç«ã€‘è§¸ç™¼ç•«é¢å¾®éœ‡å‹•
    const pokerTable = document.getElementById('poker-table');
    if (pokerTable) {
        pokerTable.style.transition = "none";
        pokerTable.style.animation = "dqShake 0.2s ease-out";
        setTimeout(() => pokerTable.style.animation = "", 200);
    }

    // 5. ğŸ¨ ã€å…¨ç’°å¢ƒåŒæ­¥ã€‘
    // åˆ·æ–°æŠ•è³‡å¤§å»³å…§éƒ¨æ•¸æ“š (åŒ…å«åŠŸèƒ½æè¿°èˆ‡é€²åº¦æ¢)
    if (typeof showInvestmentUI === 'function') showInvestmentUI(); 
    
    // åˆ·æ–°æˆ°å ´å´é‚Šçœ‹æ¿ (åŒ…å«ç¸½è²¢ç»é¡èˆ‡è¨­æ–½ç­‰ç´š)
    if (typeof renderPokerTable === 'function') {
        renderPokerTable(document.getElementById('poker-table')); 
    }
    
    // åŒæ­¥ IndexedDB å­˜æª”èˆ‡é ‚éƒ¨ç‹€æ…‹åˆ—
    if (typeof updatePlayerUI === 'function') updatePlayerUI();
    if (typeof savePlayerToDB === 'function') savePlayerToDB();

    showNotification(`âœ¨ å»ºè¨­é”æˆï¼šã€${up.name}ã€‘å·²ç‰©ç†æ™‰å‡è‡³ Lv.${up.lv}ï¼`);
}

/**
 * ğŸ” ç‰©ç†è¼”åŠ©ï¼šç²å–è¨­æ–½çš„åŠŸèƒ½æ•¸å€¼æè¿°
 */
function getUpgradeEffectDesc(key, lv) {
    const nextLv = lv + 1;
    switch(key) {
        case 'vault':
            return {
                label: "åœ‹åº«åˆ©æ¯",
                now: `æ¯å±€ç”Ÿæ¯ +${(0.5 + lv * 0.005).toFixed(2)}%`,
                next: `å‡ç´šè‡³ +${(0.5 + nextLv * 0.005).toFixed(2)}%`
            };
        case 'mint':
            return {
                label: "è´å®¶åŠ æˆ",
                now: `å½©é‡‘çµç®—é¡å¤– +${(lv * 0.1).toFixed(1)}%`,
                next: `å‡ç´šè‡³ +${(nextLv * 0.1).toFixed(1)}%`
            };
        case 'intel':
            return {
                label: "å½è£å¼·åº¦",
                now: `AI è­˜ç ´è´—å“ç‡é™ä½ ${(lv * 0.1).toFixed(1)}%`,
                next: `å‡ç´šè‡³é™ä½ ${(nextLv * 0.1).toFixed(1)}%`
            };
        case 'trade':
            return {
                label: "é—œç¨…æ¸›å…",
                now: `å…¥å ´è¦è²»æ¸›å… ${(lv * 0.1).toFixed(1)}%`,
                next: `å‡ç´šè‡³æ¸›å… ${(nextLv * 0.1).toFixed(1)}%`
            };
        case 'arena':
            return {
                label: "ç«¶æŠ€æ‡²ç½°",
                now: `è¼¸å®¶ç½°é‡‘åŸºæ•¸ +${(lv * 0.02).toFixed(2)}`,
                next: `å‡ç´šè‡³ +${(nextLv * 0.02).toFixed(2)}`
            };
        default: return { label: "æœªçŸ¥", now: "-", next: "-" };
    }
}

/**
 * ğŸ›ï¸ ç‰©ç†æ¸²æŸ“ï¼šç‹åœ‹æŠ•è³‡å¤§å»³ (å«åŠŸèƒ½è©³è§£)
 */
function showInvestmentUI() {
    const existing = document.getElementById('investment-modal');
    if (existing) existing.remove();

    const sys = window.kingdomSystem;
    const modal = document.createElement('div');
    modal.id = 'investment-modal';
    
    // ç‰©ç†ä½ˆå±€å¾®èª¿ï¼šå¯¬åº¦å¢åŠ è‡³ 420px ä»¥å®¹ç´æ–‡å­—ï¼Œä¸¦åŠ å…¥ç£¨ç ‚ç»ç’ƒæ•ˆæœ
    modal.style = `
        position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); 
        width:420px; background:rgba(10, 10, 10, 0.98); border:2px solid #f1c40f; 
        padding:25px; z-index:200000; border-radius:15px; color:#eee; 
        font-family:monospace; box-shadow:0 0 80px #000; backdrop-filter: blur(10px);
    `;

    const upgradesHtml = Object.keys(sys.upgrades).map(k => {
        const up = sys.upgrades[k];
        const effects = getUpgradeEffectDesc(k, up.lv);
        const percent = (up.lv / 10).toFixed(1);

        return `
        <div style="background:rgba(255,255,255,0.03); padding:15px; border-radius:10px; margin-bottom:12px; border:1px solid #333; transition: 0.3s;">
            <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:8px;">
                <div>
                    <b style="color:#f1c40f; font-size:15px; letter-spacing:1px;">${up.name}</b>
                    <span style="font-size:10px; color:#666; margin-left:8px;">LV.${up.lv}</span>
                </div>
                <button onclick="manualInvest('${k}')" 
                    style="background:#f1c40f; color:#000; border:none; padding:4px 12px; border-radius:4px; font-weight:bold; cursor:pointer; font-size:11px; box-shadow:0 2px 0 #b7950b;">
                    æŠ•è³‡ $5,000
                </button>
            </div>
            
            <div style="font-size:11px; color:#2ecc71; line-height:1.6; margin-bottom:10px;">
                <span style="color:#888;">[${effects.label}]</span> ${effects.now} 
                <br>
                <span style="color:#aaa; font-style:italic;">NEXT: ${effects.next}</span>
            </div>

            <div style="width:100%; height:5px; background:#222; border-radius:3px; overflow:hidden;">
                <div style="width:${percent}%; height:100%; background:#f1c40f; box-shadow:0 0 10px #f1c40f;"></div>
            </div>
        </div>`;
    }).join('');

    modal.innerHTML = `
        <div style="text-align:center; margin-bottom:20px; border-bottom:1px solid #333; padding-bottom:15px;">
            <b style="color:#f1c40f; font-size:20px; letter-spacing:4px; text-shadow: 0 0 10px #f1c40f;">ç‹åœ‹æŠ•è³‡å¤§å»³</b>
            <div style="font-size:11px; color:#888; margin-top:8px;">
                å¯ç”¨è³‡é‡‘ï¼š<span style="color:#fff;">$${player.coin.toLocaleString()} G</span>
            </div>
        </div>
        <div style="max-height:480px; overflow-y:auto; padding-right:8px;">
            ${upgradesHtml}
        </div>
        <button onclick="this.parentElement.remove()" 
            style="width:100%; margin-top:20px; background:#222; color:#888; border:1px solid #444; padding:12px; cursor:pointer; border-radius:8px; font-weight:bold; transition:0.2s;"
            onmouseover="this.style.color='#fff'; this.style.borderColor='#888';">
            ç‰©ç†æ€§é›¢é–‹å¤§å»³
        </button>
    `;

    document.body.appendChild(modal);
}


/**
 * ğŸƒ ç‰©ç†å­ç¨‹åºï¼šé¡¯ç¤ºç•°èƒ½å¡å…¨å±è¯éº—è©³è§£ (æ•´åˆå„ªåŒ– + é»‘å¸‚è¿·éœ§ç‰ˆ)
 */
function showBoonDetail() {
    const hero = pokerGame.players.find(p => p.id === 'player');
    const boonId = pokerGame.activeBoon;
    if (!boonId || !hero) return;

    const rank = hero.rank || 'citizen';
    const boon = RANK_BOON_DATA[rank]?.find(b => b.id === boonId);
    if (!boon) return;

    // 1. ğŸ”¥ ã€ç‰©ç†é˜²ç¦¦ã€‘ç§»é™¤èˆŠè©³è§£åœ–å±¤
    const existing = document.getElementById('boon-detail-overlay');
    if (existing) existing.remove();

    const detailOverlay = document.createElement('div');
    detailOverlay.id = "boon-detail-overlay";
    
    // 2. ç‰©ç†æ˜ å°„è¦–è¦ºå±¬æ€§
    const rarityInfo = {
        legend: { label: 'å‚³å¥‡å¥‘ç´„', color: '#f1c40f', particle: 'âœ¨' },
        rare:   { label: 'ç¨€æœ‰å¥‘ç´„', color: '#e74c3c', particle: 'âš¡' },
        normal: { label: 'ä¸€èˆ¬å¥‘ç´„', color: '#888',    particle: 'ğŸ”˜' },
        curse:  { label: 'å„é‹å¥‘ç´„', color: '#9b59b6', particle: 'ğŸ’€' }
    };
    const style = rarityInfo[boon.rarity] || rarityInfo.normal;

    // ğŸ•µï¸ é»‘å¸‚å°ˆå±¬åˆ¤æ–·
    const isBlackMarket = (boonId === 'black_market' || boonId === 'market');

    detailOverlay.style = `
        position:fixed; top:0; left:0; width:100%; height:100%; 
        background:rgba(0,0,0,0.92); z-index:110000; 
        display:flex; align-items:center; justify-content:center;
        backdrop-filter: blur(15px); cursor: pointer;
        animation: fadeIn 0.4s forwards;
        overflow: hidden;
    `;

    detailOverlay.onclick = () => {
        detailOverlay.style.opacity = '0';
        setTimeout(() => detailOverlay.remove(), 300);
    };

    // 3. ç‰©ç†æ§‹å»ºå…§éƒ¨å…§å®¹ (åŠ å…¥è¿·éœ§å±¤)
    let innerHTML = `
        ${isBlackMarket ? `
            <div class="black-market-smoke"></div>
            <div class="black-market-smoke smoke-delay"></div>
        ` : ''}

        <div class="boon-${boon.rarity} ${isBlackMarket ? 'black-market-glow' : ''}" style="
            width:350px; background:#050505; border:2px solid ${isBlackMarket ? '#9b59b6' : style.color}; 
            border-radius:24px; padding:50px 30px; text-align:center; 
            cursor:default; position:relative; box-shadow:0 0 60px rgba(0,0,0,1);
            z-index: 10;
            animation: cardSlideUp 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;" 
            onclick="event.stopPropagation()">
            
            <div style="position:absolute; top:20px; left:20px; opacity:0.3; font-size:20px;">${isBlackMarket ? 'ğŸ”„' : style.particle}</div>
            <div style="position:absolute; top:20px; right:20px; opacity:0.3; font-size:20px;">${isBlackMarket ? 'ğŸ”„' : style.particle}</div>

            <div style="color:${isBlackMarket ? '#9b59b6' : style.color}; font-size:11px; letter-spacing:5px; font-weight:bold; margin-bottom:25px; opacity:0.8;">
                â— ${isBlackMarket ? 'éæ³•äº¤æ˜“' : style.label.toUpperCase()} â—
            </div>

            <div style="color:white; font-size:36px; font-weight:bold; margin-bottom:30px; text-shadow:0 0 20px ${isBlackMarket ? '#9b59b6' : style.color};">
                ${boon.name}
            </div>

            <div style="width:80px; height:2px; background:${isBlackMarket ? '#9b59b6' : style.color}; margin:0 auto 30px auto; opacity:0.4;"></div>

            <div style="color:#ddd; font-size:18px; line-height:1.8; letter-spacing:1px; margin-bottom:50px; font-family: 'Hiragino Sans', serif;">
                ${boon.desc}
            </div>

            <div style="color:${isBlackMarket ? '#6a1b9a' : '#444'}; font-size:10px; letter-spacing:3px; font-style:italic; border-top:1px solid #222; padding-top:20px;">
                ${isBlackMarket ? 'BORN IN THE SHADOWS' : 'FATE BOUND TO SOUL'}
            </div>

            <div style="position:absolute; bottom:-70px; left:50%; transform:translateX(-50%); color:#666; font-size:12px; white-space:nowrap; letter-spacing:1px;">
                é»æ“Šç©ºç™½å€åŸŸç‰©ç†å›æ­¸ç‰Œå±€
            </div>
        </div>

        <style>
            @keyframes cardSlideUp {
                from { opacity:0; transform: translateY(100px) scale(0.8); }
                to { opacity:1; transform: translateY(0) scale(1); }
            }
            #boon-detail-overlay { transition: opacity 0.3s ease; }
            
            /* ğŸŒ«ï¸ é»‘å¸‚å°ˆå±¬è¿·éœ§ç‰©ç†å‹•ç•« */
            .black-market-smoke {
                position: absolute;
                width: 200%; height: 200%;
                background: radial-gradient(circle, rgba(155, 89, 182, 0.15) 0%, transparent 70%);
                filter: blur(50px);
                animation: smokeRotate 10s linear infinite;
                z-index: 1;
            }
            .smoke-delay { animation-duration: 15s; animation-direction: reverse; opacity: 0.5; }
            
            @keyframes smokeRotate {
                from { transform: translate(-50%, -50%) rotate(0deg); }
                to { transform: translate(-50%, -50%) rotate(360deg); }
            }

            .black-market-glow {
                box-shadow: 0 0 40px rgba(155, 89, 182, 0.3) !important;
            }
        </style>
    `;

    detailOverlay.innerHTML = innerHTML;
    document.body.appendChild(detailOverlay);
}

/**
 * ğŸ’¬ ç‰©ç†æ°£æ³¡æ§åˆ¶ä¸­å¿ƒï¼šæ–¹ä½å®šå‘èˆ‡è·äººç™½é‡çµ„ç‰ˆ (V5.6)
 * ä¿®æ­£ï¼š
 * 1. æ ¹æ“šç©å®¶ä½ç½® (1, 2 = å·¦, 3 = å³) åŸ·è¡Œæ–¹ä½åˆ†æµã€‚
 * 2. æ¡ç”¨è·äººç™½é«˜å°æ¯”è¦–è¦ºï¼Œç§»é™¤çªç ´å¤©éš›çš„å‚ç›´å®šä½å•é¡Œã€‚
 */
function triggerAISpeech(playerIdx, talkInput) {
    const targetPlayer = pokerGame.players[playerIdx];
    const bubble = document.getElementById(`bubble-${playerIdx}`);
    
    // 0. ğŸ”¥ ã€ç‰©ç†æ””æˆªã€‘ç¢ºä¿å°è±¡å­˜åœ¨
    if (!targetPlayer || !bubble) return;

    // 1. ğŸ”¥ ã€ç‰©ç†æ–¹ä½åˆ†æµå”è­°ã€‘
    // æ ¹æ“šæ‚¨çš„æŒ‡ä»¤ï¼šå·¦(1) -> å·¦, ä¸­(2) -> å·¦, å³(3) -> å³
    bubble.classList.remove('bubble-left-side', 'bubble-right-side');
    
    if (playerIdx === 1 || playerIdx === 2) {
        bubble.classList.add('bubble-left-side');
    } else if (playerIdx === 3) {
        bubble.classList.add('bubble-right-side');
    }

    // 2. ğŸ”¥ ã€ç‰©ç†æ•¸æ“šè§£æã€‘
    let text = "";
    let vfxType = "none";
    if (typeof talkInput === 'object' && talkInput !== null) {
        text = talkInput.text || "";
        vfxType = talkInput.vfx || "none";
    } else {
        text = String(talkInput);
    }

    // 3. ğŸ”¥ ã€ç‰©ç†é »ç‡æ§åˆ¶ã€‘
    const now = Date.now();
    const cooldown = 2500; 
    if (targetPlayer.lastTalkTime && (now - targetPlayer.lastTalkTime < cooldown)) return;

    // 4. ğŸ”¥ ã€æ ¸å¿ƒæ¸²æŸ“å¼•æ“ï¼šç‹€æ…‹é–å®šã€‘
    targetPlayer.lastTalk = text;
    targetPlayer.lastTalkTime = now;
    bubble.className = `speech-bubble vfx-${vfxType} ${playerIdx === 3 ? 'bubble-right-side' : 'bubble-left-side'}`;
    
    // --- ğŸ¨ ç’°å¢ƒæŸ“è‰²å¢å¼· (åœ¨ç™½è‰²æ°£æ³¡åŸºç¤ä¸Šæ–½åŠ é‚Šæ¡†è‰²) ---
    if (pokerGame.isBerserkKingActive && targetPlayer.rank === 'king') {
        bubble.style.borderColor = "#ff0000";
        bubble.style.boxShadow = "8px 8px 0px rgba(255,0,0,0.2), 0 0 15px rgba(255,0,0,0.4) !important";
    } else if (pokerGame.isKingSiege) {
        bubble.style.borderColor = (targetPlayer.rank === 'king') ? "#e67e22" : "#9b59b6";
    } else {
        const isDivine = (text.includes("ç¥çš‡") || text.includes("é™›ä¸‹"));
        bubble.style.borderColor = isDivine ? "#9b59b6" : "#2c3e50";
    }

    // ğŸ¬ é»ç‡ƒé¡¯ç¤ºéˆè·¯
    bubble.innerHTML = text;
    bubble.style.setProperty('display', 'block', 'important');
    
    setTimeout(() => {
        bubble.classList.add('active');
    }, 10);

    // 5. â³ ã€ç‰©ç†å›æ”¶æ™‚é˜ã€‘
    if (window[`bubbleTimer_${playerIdx}`]) clearTimeout(window[`bubbleTimer_${playerIdx}`]);
    window[`bubbleTimer_${playerIdx}`] = setTimeout(() => {
        bubble.classList.remove('active');
        setTimeout(() => {
            if (!bubble.classList.contains('active')) {
                bubble.style.setProperty('display', 'none', 'important');
            }
        }, 300);
        targetPlayer.lastTalk = "";
    }, 3500);
}


/**
 * ğŸ”„ é»‘å¸‚äº¤æ˜“ï¼šç‰©ç†æ›¿æ›æ‰‹ç‰Œ
 * å•Ÿå‹•æ¢ä»¶ï¼šactiveBoon === 'black_market'
 */
function openBlackMarketUI() {
    const hero = pokerGame.players.find(p => p.id === 'player');
    const table = document.getElementById('poker-table');
    if (!hero || !table) return;

    // 1. ç‰©ç†æª¢æŸ¥ï¼šç¢ºä¿ç©å®¶é‚„æœ‰æ‰‹ç‰Œï¼Œä¸”æ²’å‡ºç‰Œ
    if (hero.cards.length === 0) return;

    // 2. ç‰©ç†æ§‹å»º UI é®ç½©
    const marketDiv = document.createElement('div');
    marketDiv.id = "black-market-overlay";
    marketDiv.style = `
        position:fixed; top:0; left:0; width:100%; height:100%; 
        background:rgba(20, 0, 0, 0.9); z-index:25000; 
        display:flex; flex-direction:column; align-items:center; justify-content:center;
        border: 4px solid #8b0000; box-shadow: inset 0 0 50px #000;
    `;

    marketDiv.innerHTML = `
        <h2 style="color:#e74c3c; letter-spacing:3px; text-shadow:0 0 10px #f00;">ğŸ”„ é»‘å¸‚äº¤æ˜“ï¼šæ®˜é…·æ´—ç‰Œ</h2>
        <p style="color:#bbb;">è«‹å¾ä¸‹æ–¹é¸ä¸­æœ€å¤š 3 å¼µã€Œå»¢ç‰Œã€ï¼Œæˆ‘å€‘å°‡ç‰©ç†æ€§åœ°å¾ç‰Œå †æ·±è™•ç‚ºä½ æ›å›æ–°è¡€ã€‚</p>
        <div id="market-hand-display" style="display:flex; flex-wrap:wrap; gap:10px; justify-content:center; max-width:600px; margin:30px 0;">
            ${hero.cards.map((c, idx) => `
                <div onclick="toggleMarketSelection(this, ${idx})" class="market-card" style="
                    background:white; color:${c.suit === 'â™¥' || c.suit === 'â™¦' ? 'red' : 'black'};
                    padding:10px 8px; border-radius:5px; font-weight:bold; cursor:pointer;
                    border: 2px solid #ccc; transition:0.2s; min-width:35px; text-align:center;">
                    ${c.label}
                </div>
            `).join('')}
        </div>
        <div style="display:flex; gap:20px;">
            <button onclick="executeBlackMarketExchange()" style="padding:12px 30px; background:#e74c3c; color:white; border:none; border-radius:5px; cursor:pointer; font-weight:bold; box-shadow:0 4px 0 #8b0000;">åŸ·è¡Œäº¤æ˜“ (Exchange)</button>
            <button onclick="closeBlackMarket()" style="padding:12px 30px; background:#444; color:white; border:none; border-radius:5px; cursor:pointer;">å–æ¶ˆä¸¦é–‹å±€</button>
        </div>
    `;

    document.body.appendChild(marketDiv);
    window.marketSelection = []; // ç‰©ç†è¨˜éŒ„é»‘å¸‚é¸ä¸­çš„ç´¢å¼•
}

// ç‰©ç†è¡Œç‚ºï¼šé¸å–å¡ç‰‡ï¼ˆé«˜äº®è¦–è¦ºï¼‰
function toggleMarketSelection(el, idx) {
    const pos = window.marketSelection.indexOf(idx);
    if (pos > -1) {
        window.marketSelection.splice(pos, 1);
        el.style.transform = "translateY(0)";
        el.style.borderColor = "#ccc";
        el.style.boxShadow = "none";
    } else {
        if (window.marketSelection.length < 3) {
            window.marketSelection.push(idx);
            el.style.transform = "translateY(-15px)";
            el.style.borderColor = "#e74c3c";
            el.style.boxShadow = "0 0 15px #f00";
        } else {
            showNotification("âš ï¸ é»‘å¸‚æœ‰é™åˆ¶ï¼šå–®æ¬¡åªèƒ½äº¤æ˜“ 3 å¼µç‰Œï¼");
        }
    }
}


/**
 * ğŸ”„ é»‘å¸‚äº¤æ˜“ï¼šç‰©ç†è€åƒç›´ç™¼ (ä¿®æ­£ï¼šå¹»å½±å±¬æ€§ä¸‰ä½ä¸€é«”åŒ–)
 * ç¢ºä¿é¬¼ç‰Œå±¬æ€§ç´”æ·¨ï¼Œå¾¹åº•æœçµ• ğŸƒQâ™  é€™ç¨®æ‚–è«–å­˜åœ¨
 */
async function executeBlackMarketExchange() {
    if (!window.marketSelection || window.marketSelection.length === 0) return closeBlackMarket();
    const hero = pokerGame.players.find(p => p.id === 'player');
    if (!hero) return closeBlackMarket();

    const count = window.marketSelection.length;
    
    // 1. ğŸ”¥ ã€ç‰©ç†åˆ‡é™¤ã€‘
    const targetIndices = [...window.marketSelection].sort((a, b) => b - a);
    targetIndices.forEach(idx => hero.cards.splice(idx, 1));

    // 2. ğŸ”¥ ã€è€åƒç”Ÿæˆå”è­°ã€‘
    const suits = ['â™£', 'â™¦', 'â™¥', 'â™ '];
    const highValues = ['10', 'J', 'Q', 'K', 'A', '2']; 
    
    for (let i = 0; i < count; i++) {
        let newCard;
        const roll = Math.random();

        // --- âš–ï¸ åˆ†æµ Aï¼šç”¢ç”Ÿã€åˆæ³•çš„å¹»å½±é¬¼ç‰Œã€‘ (25% æ©Ÿç‡) ---
        if (roll < 0.25) {
            const subRoll = Math.random();
            newCard = { 
                value: 'JOKER', 
                power: 200, 
                fromBlackMarket: true,
                isPhantom: true 
            };

            if (subRoll < 0.4) {
                // é¡å‹ 1ï¼šã€å¹»å½±é»æ•¸ã€‘é–å®šé»æ•¸ï¼ŒèŠ±è‰²ä¿æŒå…¨è®Šå¹»
                newCard.phantomValue = highValues[Math.floor(Math.random() * highValues.length)];
                newCard.suit = 'ğŸƒ'; 
                newCard.label = `ğŸƒ${newCard.phantomValue}`;
            } else if (subRoll < 0.8) {
                // é¡å‹ 2ï¼šã€å¹»å½±èŠ±è‰²ã€‘é–å®šèŠ±è‰²ï¼Œé»æ•¸ä¿æŒå…¨è®Šå¹»
                newCard.suit = suits[Math.floor(Math.random() * suits.length)];
                newCard.phantomValue = 'JOKER';
                newCard.label = `ğŸƒ${newCard.suit}`;
            } else {
                // é¡å‹ 3ï¼šã€ç´”ç²¹é¬¼ç‰Œã€‘å®Œå…¨è‡ªç”±
                newCard.suit = 'ğŸƒ';
                newCard.phantomValue = 'JOKER';
                newCard.label = 'JOKER';
            }
        } 
        // --- ğŸŒŠ åˆ†æµ Bï¼šç”¢ç”Ÿæ¨™æº–è€åƒå¤§ç‰Œ (75% æ©Ÿç‡) ---
        else {
            const v = highValues[Math.floor(Math.random() * highValues.length)];
            const s = suits[Math.floor(Math.random() * suits.length)];
            newCard = { 
                suit: s, value: v, 
                power: POKER_AI.getValueIndex(v) * 10 + suits.indexOf(s),
                label: s + v,
                fromBlackMarket: true 
            };
        }

        // è´—å“æ¨™è¨˜ (18% æ©Ÿç‡)
        if (Math.random() < 0.18) newCard.isFake = true;

        hero.cards.push(newCard);
    }

    // 3. ğŸ”¥ ã€æ•¸æ“šç‰©ç†åŒæ­¥èˆ‡çµç®—ã€‘
    hero.cards.sort((a, b) => a.power - b.power);
    window.marketSelection = [];
    selectedCards = [];
    
    const tableContainer = document.getElementById('poker-table');
    if (tableContainer) renderPokerTable(tableContainer);
    showNotification(`ğŸ§ª äº¤æ˜“å®Œæˆï¼æ–°è²¨å·²å…¥è¢‹...`);

    // 4. ğŸ”¥ ã€æ‰æ¼†ç¢è£‚é‚è¼¯ã€‘
    setTimeout(() => {
        let fakeFound = false;
        hero.cards.forEach(c => {
            if (c.isFake) {
                fakeFound = true;
                if (typeof triggerCheatShatterEffect === 'function') triggerCheatShatterEffect();
                const junkValues = ['3', '4', '5'];
                const newValue = junkValues[Math.floor(Math.random() * junkValues.length)];
                const oldLabel = c.label;
                
                c.value = newValue;
                c.label = (c.suit === 'ğŸƒ' ? suits[Math.floor(Math.random()*4)] : c.suit) + newValue;
                c.power = POKER_AI.getValueIndex(newValue) * 10 + 1;
                c.isFake = false; 
                c.isPhantom = false;
                c.fromBlackMarket = false; 
                showNotification(`<b style="color:#9b59b6;">ğŸ’¢ è´—å“ç¾å½¢ï¼ã€${oldLabel}ã€‘ç¢è£‚ç‚º ${c.label}</b>`);
            }
        });

        if (fakeFound) {
            hero.cards.sort((a, b) => a.power - b.power);
            renderPokerTable(tableContainer); 
        }
        
        pokerGame.players.forEach(p => p.isPassed = false);
        setTimeout(() => closeBlackMarket(), 800);
    }, 1500); 
}


/**
 * ğŸƒ ç‰©ç†ç‰¹æ•ˆï¼šé»‘å¸‚æ‰æ¼†/è€åƒç¢è£‚æ•ˆæœ
 */
function triggerCheatShatterEffect() {
    // 1. ğŸ”¥ ã€ç‰©ç†æ³¨å…¥ CSSã€‘ç¢ºä¿ç‰¹æ•ˆæ¨£å¼å­˜åœ¨
    if (!document.getElementById('black-market-cheat-css')) {
        const style = document.createElement('style');
        style.id = 'black-market-cheat-css';
        style.innerHTML = `
            /* ç´«è‰²æƒ¡æ„é–ƒçˆå±¤ */
            @keyframes purpleFlash {
                0% { background: rgba(155, 89, 182, 0); }
                20% { background: rgba(155, 89, 182, 0.7); }
                100% { background: rgba(0, 0, 0, 0); }
            }
            /* è¢å¹•ç‰©ç†ç¢è£‚éœ‡å‹• */
            @keyframes glitchShatter {
                0% { transform: translate(0,0) scale(1); filter: hue-rotate(0deg); }
                10% { transform: translate(-12px, 12px) scale(1.03); filter: hue-rotate(90deg); }
                30% { transform: translate(12px, -12px) scale(1.06); }
                50% { transform: translate(-18px, -6px) scale(1.03); filter: contrast(2.5) brightness(1.5); }
                70% { transform: translate(18px, 6px) scale(1); }
                100% { transform: translate(0,0) scale(1); filter: hue-rotate(0deg); }
            }
            .cheat-shatter-active {
                animation: glitchShatter 0.45s cubic-bezier(.36,.07,.19,.97) both;
            }
            .purple-overlay {
                position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
                z-index: 200000; pointer-events: none;
                animation: purpleFlash 0.7s ease-out forwards;
            }
        `;
        document.head.appendChild(style);
    }

    // 2. ğŸ”¥ ã€ç‰©ç†è§¸ç™¼ã€‘åŸ·è¡Œè¢å¹•éœ‡æ’¼
    const table = document.getElementById('poker-table');
    if (table) {
        table.classList.add('cheat-shatter-active');
        setTimeout(() => table.classList.remove('cheat-shatter-active'), 500);
    }

    // 3. ç‰©ç†è¦†è“‹å±¤é–ƒçˆ
    const flash = document.createElement('div');
    flash.className = 'purple-overlay';
    document.body.appendChild(flash);
    setTimeout(() => flash.remove(), 700);

    console.log("%cğŸ’¥ å“å•·ï¼è´—å“ç¾å½¢ï¼Œé»‘å¸‚è€åƒå°ä½ éœ²å‡ºæ…˜ç™½ç¬‘å®¹...", "color: #9b59b6; font-weight: bold;");
}

/**
 * â™»ï¸ ç‰©ç†å­ç¨‹åºï¼šæˆ°å ´æ·¨åŒ–èˆ‡ç™¼çƒæ¬Šç‰©ç†é–å®š
 * ä¿®æ­£ï¼š
 * 1. ç‰©ç†æŠ¹é™¤ï¼šç¢ºä¿ lastPlayerName è®Šæ›´ç‚º NONE çš„å‹•ä½œå„ªå…ˆæ–¼æ‰€æœ‰æ¸²æŸ“ã€‚
 * 2. ç‹€æ…‹çœŸç©ºï¼šå¾¹åº•æ¸…é™¤èˆŠç‰Œå‹èˆ‡å¡ç‰‡æŒ‡ç´‹ï¼Œè§£æ±ºã€Œè‡ªå·±æ‰“è‡ªå·±ã€çš„é‚è¼¯æ­»é–ã€‚
 * 3. æˆ°è¡“è§£é–ï¼šå¼·åˆ¶è§¸ç™¼ updateTacticalHelper ä»¥åŒæ­¥ JOKER è®Šå¹»æ¬Šé™ã€‚
 */
function resetTableForNewLead() {
    console.log("%câ™»ï¸ åŸ·è¡Œæˆ°å ´ç‰©ç†æ·¨åŒ–ï¼Œå•Ÿå‹•æ¬ŠåŠ›å›æº¯èˆ‡çœŸç©ºåŒ–ç¨‹åº...", "color: #3498db; font-weight: bold;");
    
    // 0. ğŸ”¥ ã€ç‰©ç†å®‰å…¨æª¢æŸ¥ã€‘
    if (window.isGameEnding || !pokerGame.gameActive) return;

    // 1. ğŸ”¥ ã€æ ¸å¿ƒå°æ­£ï¼šé ˜å…ˆè€…æ¬Šé™éŒ¨å®šã€‘
    // å–å¾—ä¸Šä¸€å€‹æˆåŠŸå‡ºç‰Œè€…çš„ç´¢å¼• (å³ç¾åœ¨ç²å–ç™¼çƒæ¬Šçš„äºº)
    let leaderIdx = pokerGame.players.findIndex(p => p.name === pokerGame.lastPlayerName);
    
    // ğŸš¨ ç‰©ç†è£œæ•‘ï¼šè‹¥é ˜å…ˆè€…åç¨±ç•°å¸¸ï¼Œé è¨­ç”±åœ‹ç‹æˆ–ç•¶å‰æŒ‡é‡ç©å®¶é ˜å…ˆ
    if (leaderIdx === -1) {
        leaderIdx = pokerGame.players.findIndex(p => p.rank === 'king');
        if (leaderIdx === -1) leaderIdx = 0;
    }

    // 2. ğŸ”¥ ã€æ•¸æ“šç‰©ç†çœŸç©ºåŒ–ã€‘(æ ¸å¿ƒä¿®æ­£é»)
    // é—œéµï¼šå¿…é ˆå…ˆæ¸…ç©ºæ•¸æ“šï¼Œæ‰èƒ½é€²è¡Œ UI é‡ç¹ªï¼Œå¦å‰‡ render å‡½æ•¸æœƒæŠ“åˆ°èˆŠæ•¸æ“š
    pokerGame.lastMovePattern = null;  // ç‰©ç†æ·¨ç©ºï¼šç§»é™¤å¼·åº¦å°æ¯”ç›®æ¨™
    pokerGame.lastMoveCards = [];      // æ¸…é™¤æ¡Œé¢å¡ç‰‡æ®˜å½±
    pokerGame.lastPlayerName = "NONE"; // ç‰©ç†æ¨™è¨˜ï¼šæˆ°å ´å·²é€²å…¥ç™¼çƒæ¬Šéšæ®µ
    pokerGame.passCount = 0;           // é‡ç½®æ£„æ¬Šè¨ˆæ•¸

    // ç‰©ç†å–šé†’å…¨å“¡ä¸¦æ¸…é™¤èˆŠæœ‰æ°£æ³¡æ•¸æ“š
    pokerGame.players.forEach(p => {
        p.lastMove = []; 
        p.isPassed = false;
        p.lastTalk = ""; 
    });

    // ç§»äº¤å›åˆæŒ‡é‡çµ¦ç²å‹è€…
    pokerGame.turn = leaderIdx;

    addBattleLog(`ğŸ§¤ <b style="color:#fff; text-shadow:0 0 10px #fff;">[ç³»çµ±] æˆ°å ´å·²é€²å…¥çœŸç©ºæ…‹ã€‚</b> ç²å–ç™¼çƒæ¬Šï¼š<b style="color:#f1c40f;">${pokerGame.players[leaderIdx].name}</b>`);
    
    // 3. ğŸ”¥ ã€ç‰©ç† UI åŒæ­¥èˆ‡æˆ°è¡“é»ç«ã€‘
    const tableContainer = document.getElementById('poker-table');
    
    // A. æˆ°å€é‡ç¹ªï¼šæ­¤æ™‚ lastPlayerName å·²ç‚º NONEï¼ŒUI å°‡æ­£ç¢ºé¡¯ç¤º
    if (tableContainer) {
        renderPokerTable(tableContainer);
        if (typeof renderTableCenter === 'function') renderTableCenter();
    }

    // 4. ğŸ”¥ ã€æ ¸å¿ƒé»ç«åˆ†æµã€‘
    const currentPlayer = pokerGame.players[pokerGame.turn];
    
    if (currentPlayer.id === 'player') {
        // --- ğŸ‘¤ å‹‡è€…ç™¼çƒæ¨¡å¼ ---
        showNotification("ğŸ‘‰ æˆ°å ´å·²ç‰©ç†æ·¨åŒ–ï¼Œä½ æ“æœ‰ä¸€åˆ‡å‡ºç‰Œæ¬Šï¼");
        
        // é—œéµï¼šé‡å•Ÿæˆ°è¡“è¼”åŠ©ï¼Œå› ç‚º lastMovePattern è®Šæˆäº† nullï¼Œç¾åœ¨å¯ä»¥å‡ºå–®å¼µã€å°å­æˆ–ä»»ä½•çµ„åˆ
        if (typeof window.updateTacticalHelper === 'function') {
            window.updateTacticalHelper(false);
        }
        
        // å†æ¬¡å¼·åˆ¶æ¸²æŸ“ï¼Œç¢ºä¿ ACT æŒ‰éˆ•åœ¨ã€Œé ˜å…ˆæ¨¡å¼ã€ä¸‹å…·å‚™æ­£ç¢ºçš„ç‰©ç†å±¬æ€§
        if (tableContainer) renderPokerTable(tableContainer);

    } else {
        // --- ğŸ¤– AI ç™¼çƒæ¨¡å¼ ---
        console.log(`ğŸ¤– é»ç«ï¼šé ˜å…ˆè€… ${currentPlayer.name} å·²é–å®šç‰©ç†ç›®æ¨™ã€‚`);
        
        if (window.pokerAITimer) clearTimeout(window.pokerAITimer);
        window.pokerAITimer = setTimeout(() => {
            if (pokerGame.gameActive && !window.isGameEnding) {
                aiPlayTurn(pokerGame.turn);
            }
        }, 1300); 
    }
}

function getPlayerRankName() {
    const r = pokerGame.players.find(p => p.id === 'player').rank;
    const names = { king: "åœ‹ç‹ ğŸ‘‘", noble: "è²´æ— ğŸ’", citizen: "å¹³æ°‘ ğŸŒ¿", slave: "å¥´éš¸ â›“ï¸" };
    return names[r];
}

function getRankClass(rank) {
    return `rank-${rank}`;
}


// --- ğŸ˜µâ€ğŸ’« å¼·åˆ¶å–šé†’ç‹€æ…‹å¼•æ“ ---
function applyWakeUpEffect() {
    const r = Math.random();
    
    if (r > 0.5) {
        // ç‹€æ…‹ Aï¼šèµ·åºŠæ°£ (Grumpy)
        player.tempStatus = "grumpy";
        player.statusTimer = 30; // æŒçºŒ 30 ç§’
        showNotification("ğŸ’¢ èµ·åºŠæ°£ï¼å‹‡è€…æ„Ÿåˆ°éå¸¸æ†¤æ€’ï¼(æš´æ“Šç‡å¤§å¹…æå‡ï¼Œä½†é˜²ç¦¦åŠ›ä¸‹é™)");
    } else {
        // ç‹€æ…‹ Bï¼šè¿·ç³Š (Dizzy)
        player.tempStatus = "dizzy";
        player.statusTimer = 30; // æŒçºŒ 30 ç§’
        showNotification("ğŸ˜µâ€ğŸ’« è¿·ç³Šç‹€æ…‹... å‹‡è€…é‚„æƒ³ç¡ã€‚(ç­”éŒ¯æ‰£è¡€åŠ å€ï¼Œä½†ç¶“é©—å€¼å¾®å¢)");
    }

    // å•Ÿå‹•ç‰©ç†å€’æ•¸è¨ˆæ™‚å™¨
    if (window.statusCountdown) clearInterval(window.statusCountdown);
    window.statusCountdown = setInterval(() => {
        if (player.statusTimer > 0) {
            player.statusTimer--;
        } else {
            player.tempStatus = null;
            clearInterval(window.statusCountdown);
            showNotification("âœ¨ å‹‡è€…çµ‚æ–¼æ¸…é†’äº†ã€‚");
            if (typeof updatePlayerUI === 'function') updatePlayerUI();
        }
    }, 1000);
}

// --- æ ¸å¿ƒæ›´æ–°ï¼šæ™ºæ…§åŒæ­¥èˆ‡éš¨æ©Ÿé‡æ•µç³»çµ± (ç‰©ç†åŠ å›º + å¤šæ¨£æ•µäººç‰ˆ) ---
function startHeroAnimation() {
    const hero = document.getElementById('hero-sprite');
    if (!hero) return;

    // 1. ç‰©ç†å•Ÿå‹•ï¼šèµ°è·¯å‹•ç•«
    hero.classList.add('walking');

    // 2. ç‰©ç†æ¸…ç†ï¼šç¢ºä¿è¨ˆæ™‚å™¨å”¯ä¸€æ€§
    if (window.encounterTimer) {
        clearInterval(window.encounterTimer);
        window.encounterTimer = null;
    }
    
    // ğŸ”¥ ã€é—œéµä¿®æ­£ã€‘ç‰©ç†æ¨™è¨˜ï¼šé‡ç½®åˆ‡æ›é–å®š
    window.isBattleTransitioning = false;

    window.encounterTimer = setInterval(async () => {
        // å–å¾— UI ç‹€æ…‹ç‰©ç†æ¨™è¨˜
        const flashcardHub = document.getElementById('flashcard-hub');
        const battleScene = document.getElementById('battle-scene');
        const isReviewing = flashcardHub && flashcardHub.style.display === 'block';
        const isInBattle = (battleScene && battleScene.style.display === 'flex') || battleData.isBattleActive;
        
        // --- ç‰©ç†åˆ¤å®šé–‹é—œ ---
        // A. ä¸åœ¨å®¶ B. æ²’åœ¨è¤‡ç¿’ C. æ²’åœ¨æˆ°é¬¥ D. æ²’åœ¨åˆ‡æ›ä¸­
        if (currentMapDifficulty !== "Home" && !isReviewing && !isInBattle && !window.isBattleTransitioning) {
            
            const roll = Math.random();
            if (roll < encounterRate) {
                // ğŸ”¥ ã€ç‹€æ…‹é–å®šã€‘ç«‹å³æ””æˆªå¾ŒçºŒ setInterval è§¸ç™¼
                window.isBattleTransitioning = true; 

                try {
                    let packs = await db.fuelPacks.where('difficulty').equals(currentMapDifficulty).toArray();
                    let battlePack = null;
                    
                    if (packs.length < 3) {
                        const remotePack = await syncRemoteExams(currentMapDifficulty);
                        if (remotePack) packs.push(remotePack); 
                    }

                    // --- âš”ï¸ å¤šæ¨£é­”ç‰©æ±ºç­–æ¨¹ ---
                    if (battleChain && battleChain.count >= 3 && battleChain.count % 3 === 0) {
                        battlePack = {
                            name: "âœ¨ é‡‘å±¬å²èŠå§†",
                            appearance: "ğŸ”˜", // ç¨€æœ‰é‡‘å±¬å¤–è§€
                            difficulty: currentMapDifficulty,
                            exam: getStarterPack("N1").exam 
                        };
                        battleData.isMetal = true;
                    } 
                    else if (packs.length > 0) {
                        battlePack = packs[Math.floor(Math.random() * packs.length)];
                        // ğŸ”¥ ç‰©ç†æ˜ å°„ï¼šæ ¹æ“šé›£åº¦è³¦äºˆéš¨æ©Ÿå¤–è§€
                        battlePack.appearance = getRandomEnemyAppearance(currentMapDifficulty);
                        battleData.isMetal = false;
                    }
                    else {
                        battlePack = generateDynamicExam(currentMapDifficulty);
                        battlePack.appearance = "ğŸ‘»";
                        battleData.isMetal = false;
                    }
                    
                    if (battlePack) {
                        hero.classList.remove('walking');
                        window.currentExamPool = battlePack.exam; 
                        
                        if (typeof startDQBattle === 'function') {
                            // ç‰©ç†å‚³éé­”ç‰©æ•¸æ“šï¼ŒåŒ…å«å¤–è§€
                            startDQBattle(battlePack);
                        }
                    }
                } catch (e) {
                    console.error("âŒ é‡æ•µç³»çµ±æ•…éšœï¼š", e);
                    window.isBattleTransitioning = false; // å‡ºéŒ¯æ™‚ç‰©ç†é‡‹æ”¾é–å®š
                }
            }
        }
    }, 4000); 
}


function getRandomEnemyAppearance(difficulty) {
    const enemyLibrary = {
        "N5": ["ğŸŒ¿", "ğŸŒ", "ğŸ›", "ğŸ¦", "ğŸ„"], // åˆå¿ƒè€…ä¹‹æ£®ï¼šæ˜†èŸ²èˆ‡å°ç”Ÿç‰©
        "N4": ["ğŸŒ²", "ğŸº", "ğŸ—", "ğŸ¦‡", "ğŸ"], // è¿·éœ§æ£®æ—ï¼šé‡ç¸
        "N3": ["â›°ï¸", "ğŸ‘º", "ğŸ¦…", "ğŸ—¿", "ğŸ‚"], // å·¨äººä¹‹å³°ï¼šå±±åœ°é­”ç‰©
        "N2": ["ğŸ¯", "â„ï¸", "ğŸ‘»", "ğŸ§Ÿ", "ğŸº"], // å‡œå†¬è¦å¡ï¼šäº¡éˆèˆ‡å†°å†·ç”Ÿç‰©
        "N1": ["ğŸ”¥", "ğŸ‘¿", "ğŸ²", "ğŸ‘¹", "ğŸ’€"], // ç†¾ç‚é­”åŸï¼šæƒ¡é­”èˆ‡é¾
        "N0": ["ğŸŒŒ", "ğŸ‘ï¸", "âš”ï¸", "ğŸ‰", "ğŸ”±"]  // çœ¾ç¥éºå€ï¼šå‚³èªªç´šå­˜åœ¨
    };
    
    const pool = enemyLibrary[difficulty] || ["ğŸ‘¾"];
    return pool[Math.floor(Math.random() * pool.length)];
}

// ä¿®æ”¹ checkQuiz ä»¥è§¸ç™¼æ”»æ“Š
const originalCheckQuiz = checkQuiz;
checkQuiz = function() {
    // å‘¼å«åŸæœ¬çš„åˆ¤å®šé‚è¼¯ (å‡è¨­åŸæœ¬çš„é‚è¼¯å…§æœƒè¨ˆç®— score)
    // é€™è£¡æˆ‘å€‘ç›´æ¥åœ¨è£¡é¢åŠ å…¥æ”»æ“Šè§¸ç™¼
    originalCheckQuiz();
    // ç²å–ç›®å‰çš„å¾—åˆ†ç‹€æ³ (å»ºè­°åœ¨ checkQuiz çµå°¾åŠ å…¥ triggerHeroAttack)
};


/**
 * ğŸ’ å‚³èªªåœ–é‘‘æ¸²æŸ“ï¼šç‰©ç†åˆ†é ç‰ˆ (10ç­†/é )
 */
function renderCollection() {
    const grid = document.getElementById('collection-grid');
    const progressEl = document.getElementById('collect-progress');
    
    // ç‰©ç†æª¢æŸ¥ Aï¼šå®¹å™¨å®‰å…¨æ€§æ””æˆª
    if (!grid) {
        console.error("æ‰¾ä¸åˆ° ID ç‚º 'collection-grid' çš„åœ–é‘‘å®¹å™¨");
        return;
    }

    // 1. æ•¸æ“šå°é½Šï¼šç¢ºä¿è§£é–è³‡æ–™æ ¼å¼æ­£ç¢º
    const collectionData = Array.isArray(player.collection) ? player.collection : [];
    const inventoryData = Array.isArray(player.inventory) ? player.inventory : [];

    // 2. ğŸ”¥ ã€ç‰©ç†åˆ†é æ¼”ç®—ã€‘
    const totalItems = MASTER_COLLECTION.length;
    const totalPages = Math.ceil(totalItems / COLLECTION_ITEMS_PER_PAGE);
    
    // é˜²å‘†ï¼šç¢ºä¿é ç¢¼ä¸è¶Šç•Œ
    if (currentCollectionPage < 1) currentCollectionPage = 1;
    if (currentCollectionPage > totalPages && totalPages > 0) currentCollectionPage = totalPages;

    const startIndex = (currentCollectionPage - 1) * COLLECTION_ITEMS_PER_PAGE;
    const endIndex = Math.min(startIndex + COLLECTION_ITEMS_PER_PAGE, totalItems);
    
    // åˆ‡ç‰‡ï¼šåªå–ç•¶å‰é é¢çš„è³‡æ–™
    const pageItems = MASTER_COLLECTION.slice(startIndex, endIndex);

    // 3. æ¸²æŸ“åœ–é‘‘æ¸…å–® (åªæ¸²æŸ“åˆ‡ç‰‡å¾Œçš„ pageItems)
    let gridHTML = pageItems.map(item => {
        // ç‰©ç†é›™å‘åˆ¤å®šï¼šID æ˜¯å¦åœ¨åœ–é‘‘ä¸­ OR åç¨±æ˜¯å¦åœ¨èƒŒåŒ…ä¸­
        const isUnlocked = collectionData.includes(item.id) || inventoryData.includes(item.name);
        
        // åˆ¤å®šæ˜¯å¦ç‚ºã€Œç¥å™¨ã€ç³»åˆ—
        const isArtifact = item.id.startsWith('artifact_');
        
        // ç‰©ç†å¤–è§€è§£æ
        const itemParts = item.name.split(' ');
        const icon = isUnlocked ? (itemParts[0] || 'âœ¨') : 'â“';
        const name = isUnlocked ? (itemParts.slice(1).join(' ') || item.name) : 'æœªè§£é–';

        // ğŸ¨ ç‰©ç†æ¨£å¼é…ç½®
        let borderStyle = isUnlocked ? (isArtifact ? '2px solid #f1c40f' : '1px solid #f1c40f') : '1px solid #ddd';
        let bgStyle = isUnlocked ? (isArtifact ? 'rgba(241,196,15,0.1)' : '#fffcf0') : 'transparent';
        let shadowStyle = (isUnlocked && isArtifact) ? 'box-shadow: 0 0 15px rgba(241,196,15,0.4);' : '';

        return `
            <div class="collect-item ${isUnlocked ? 'unlocked' : ''} ${isArtifact ? 'artifact-item' : ''}" 
                 title="${isUnlocked ? item.desc : 'æ¢ç´¢ç‹åœ‹æ·±è™•ä»¥è§£é–...'}"
                 style="border: ${borderStyle}; border-radius: 8px; padding: 12px; text-align: center; 
                        transition: 0.3s; position: relative; ${bgStyle}; ${shadowStyle}
                        ${isUnlocked ? '' : 'filter: grayscale(1); opacity: 0.4;'}">
                
                ${isUnlocked && isArtifact ? `
                    <div style="position:absolute; top:-2px; right:-2px; background:#f1c40f; color:#000; font-size:8px; padding:1px 4px; border-radius:4px; font-weight:900;">ARTIFACT</div>
                ` : ''}

                <div style="font-size: 32px; margin-bottom: 8px;">${icon}</div>
                <div style="font-size: 11px; font-weight: 900; color: ${isUnlocked ? '#4a2c16' : '#999'};">${name}</div>
                
                ${isUnlocked ? `
                    <div style="font-size: 9px; color: #7f8c8d; margin-top: 6px; line-height: 1.3; font-style: italic;">
                        ${item.desc}
                    </div>` : ''}
            </div>
        `;
    }).join('');

    // 4. ğŸ”¥ ã€ç‰©ç†æ³¨å…¥åˆ†é æ§åˆ¶å™¨ã€‘
    // ä½¿ç”¨ grid-column: 1 / -1 è®“åˆ†é åˆ—æ©«è·¨æ•´å€‹ç¶²æ ¼åº•éƒ¨
    const paginationHTML = `
        <div id="collection-pagination" style="grid-column: 1 / -1; display: flex; justify-content: center; align-items: center; gap: 15px; margin-top: 15px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.1);">
            <button onclick="changeCollectionPage(-1)" 
                    style="background: #333; border: 1px solid #555; color: #fff; padding: 5px 15px; border-radius: 4px; cursor: pointer; font-family: monospace; ${currentCollectionPage === 1 ? 'opacity: 0.3; cursor: not-allowed;' : ''}"
                    ${currentCollectionPage === 1 ? 'disabled' : ''}>
                â—€ PREV
            </button>
            
            <span style="color: #f1c40f; font-family: monospace; font-weight: bold; font-size: 14px;">
                PAGE ${currentCollectionPage} / ${totalPages || 1}
            </span>
            
            <button onclick="changeCollectionPage(1)" 
                    style="background: #333; border: 1px solid #555; color: #fff; padding: 5px 15px; border-radius: 4px; cursor: pointer; font-family: monospace; ${currentCollectionPage >= totalPages ? 'opacity: 0.3; cursor: not-allowed;' : ''}"
                    ${currentCollectionPage >= totalPages ? 'disabled' : ''}>
                NEXT â–¶
            </button>
        </div>
    `;

    // çµ„åˆå…§å®¹
    grid.innerHTML = gridHTML + paginationHTML;

    // 5. ç‰©ç†æª¢æŸ¥ Bï¼šæ›´æ–°å…¨åŸŸé€²åº¦æ–‡å­— (è¨ˆç®—çš„æ˜¯ç¸½é‡ï¼Œä¸æ˜¯ç•¶å‰é é¢é‡)
    if (progressEl) {
        const unlockedCount = MASTER_COLLECTION.filter(item => 
            collectionData.includes(item.id) || inventoryData.includes(item.name)
        ).length;
        progressEl.innerText = `${unlockedCount} / ${totalItems}`;
    }
    
    // ç‰©ç†å›å½ˆï¼šè®“æ²è»¸å›åˆ°é ‚éƒ¨ (é«”é©—å„ªåŒ–)
    const scrollArea = document.querySelector('#collection-popup .popup-content-scroll');
    if (scrollArea) scrollArea.scrollTop = 0;
}

/**
 * ğŸ”„ åœ–é‘‘ç¿»é æ§åˆ¶å™¨
 * @param {number} delta -1 ä»£è¡¨ä¸Šä¸€é ï¼Œ+1 ä»£è¡¨ä¸‹ä¸€é 
 */
function changeCollectionPage(delta) {
    const totalItems = MASTER_COLLECTION.length;
    const totalPages = Math.ceil(totalItems / COLLECTION_ITEMS_PER_PAGE);
    
    const newPage = currentCollectionPage + delta;
    
    // ç‰©ç†é˜²å‘†ï¼šåªæœ‰åœ¨åˆæ³•ç¯„åœå…§æ‰ç¿»é 
    if (newPage >= 1 && newPage <= totalPages) {
        currentCollectionPage = newPage;
        renderCollection(); // è§¸ç™¼ç‰©ç†é‡ç¹ª
    }
}

// 4. ç²å¾—è£å‚™æ™‚è§¸ç™¼è§£é– (ç‰©ç†è³‡æ–™åº«é€£å‹•ç‰ˆ)
function dropEquipment(quality) {
    let pool = [];

    if (quality === "high") {
        // é«˜ç´šæ± ï¼šç¨€æœ‰åº¦ç‚º rare, legend, mythic çš„è£å‚™
        pool = MASTER_COLLECTION.filter(i => 
            i.type !== 'artifact' && 
            ['rare', 'legendary', 'mythic'].includes(i.rarity)
        );
    } else {
        // æ™®é€šæ± ï¼šæ²’æœ‰æ¨™è¨»ç¨€æœ‰åº¦ï¼Œæˆ–æ˜¯ normal çš„è£å‚™
        pool = MASTER_COLLECTION.filter(i => 
            i.type !== 'artifact' && 
            (!i.rarity || i.rarity === 'normal')
        );
    }

    // ç‰©ç†é˜²å‘†ï¼šå¦‚æœæ± å­ç©ºçš„ï¼Œå›é€€åˆ°å…¨æ± éš¨æ©Ÿ
    if (pool.length === 0) pool = MASTER_COLLECTION.filter(i => i.type !== 'artifact');

    // éš¨æ©ŸæŠ½å–
    const loot = pool[Math.floor(Math.random() * pool.length)];

    // å­˜å…¥èƒŒåŒ…
    player.inventory.push(loot.name);
    
    // ğŸ’¡ åœ–é‘‘è§£é–é‚è¼¯
    if (!player.collection.includes(loot.id)) {
        player.collection.push(loot.id);
        // å¦‚æœæœ‰é–‹åœ–é‘‘è¦–çª—ï¼Œå³æ™‚åˆ·æ–°
        const popup = document.getElementById('collection-popup');
        if (popup && popup.style.display === 'flex') renderCollection();
    }

    // è¦–è¦ºé€šçŸ¥
    const dropMsg = document.createElement('div');
    dropMsg.className = "game-notify drop-item";
    dropMsg.style = "position:fixed; top:30%; left:50%; transform:translateX(-50%); background:rgba(0,0,0,0.9); border:2px solid #2ecc71; color:#fff; padding:15px; border-radius:30px; z-index:10000; animation:floatUp 2s forwards; pointer-events:none;";
    dropMsg.innerHTML = `ğŸ ç²å¾—è£å‚™ï¼š<b style="color:#2ecc71;">${loot.name}</b>`;
    document.body.appendChild(dropMsg);
    setTimeout(() => dropMsg.remove(), 2500);

    updatePlayerUI();
    return loot.name;
}


// 5. åˆ‡æ›å½ˆçª—æ§åˆ¶
function toggleCollection() {
    const p = document.getElementById('collection-popup');
    p.style.display = p.style.display === 'none' ? 'block' : 'none';
    if (p.style.display === 'block') renderCollection();
}

function toggleLog() {
    const popup = document.getElementById('adventure-log-popup');
    
    // ç‰©ç†æª¢æŸ¥ï¼šå¦‚æœæ‰¾ä¸åˆ°å…ƒç´ ï¼Œå°±åœ¨æ§åˆ¶å°å ±éŒ¯ä¸¦åœæ­¢åŸ·è¡Œï¼Œé˜²æ­¢ç•¶æ©Ÿ
    if (!popup) {
        console.error("æ‰¾ä¸åˆ° ID ç‚º 'adventure-log-popup' çš„å…ƒç´ ï¼Œè«‹æª¢æŸ¥ HTML çµæ§‹ã€‚");
        return;
    }

    const isVisible = popup.style.display === 'block';
    popup.style.display = isVisible ? 'none' : 'block';

    // å¦‚æœæ‰“é–‹æ—¥èªŒï¼Œå‰‡åŸ·è¡Œæ¸²æŸ“
    if (!isVisible) {
        if (typeof renderAdventureLog === 'function') {
            renderAdventureLog();
        }
    }
}

function toggleInventory() {
    const p = document.getElementById('inventory-popup');
    p.style.display = p.style.display === 'none' ? 'block' : 'none';
    if (p.style.display === 'block') {
        document.getElementById('equipment-list').innerHTML = player.inventory.map(item => `<div style="padding:5px; border-bottom:1px solid #eee;">${item}</div>`).join('');
    }
}


let alchemyStaging = []; // æš«æ”¾è¦åˆæˆçš„è£å‚™

function toggleAlchemy() {
    const p = document.getElementById('alchemy-popup');
    p.style.display = p.style.display === 'none' ? 'block' : 'none';
    if(p.style.display === 'block') {
        alchemyStaging = [];
        refreshAlchemyUI();
    }
}

/**
 * ğŸ”® éŠé‡‘ä»‹é¢åˆ·æ–°ï¼šç¶²æ ¼ + å †ç–Š (Final Fix)
 */
function refreshAlchemyUI() {
    // 1. æ›´æ–°ä¸Šæ–¹ä¸‰å€‹åˆæˆæ§½ (Slots)
    for (let i = 0; i < 3; i++) {
        const slot = document.getElementById(`slot-${i}`);
        if (slot) {
            if (alchemyStaging[i]) {
                const icon = alchemyStaging[i].split(' ')[0] || "ğŸ“¦";
                slot.innerText = icon;
                slot.style.background = "rgba(241, 196, 15, 0.1)"; // é‡‘è‰²å¾®å…‰
                slot.style.borderColor = "#f1c40f";
                slot.style.color = "#fff";
                slot.style.boxShadow = "0 0 10px rgba(241, 196, 15, 0.3)";
            } else {
                // ç©ºæ§½ç‹€æ…‹
                slot.innerText = "?";
                slot.style.background = "rgba(255, 255, 255, 0.05)";
                slot.style.borderColor = "#444";
                slot.style.color = "#666";
                slot.style.boxShadow = "none";
            }
        }
    }

    // 2. æ›´æ–°ä¸‹æ–¹å¯é¸ç´ ææ¸…å–® (Grid System + Grouping)
    const invDiv = document.getElementById('alchemy-inventory');
    if (invDiv) {
        // å¥—ç”¨ç¶²æ ¼ Class
        invDiv.className = 'alchemy-grid';
        
        if (player.inventory.length === 0) {
            invDiv.innerHTML = `<div class="alchemy-empty" style="grid-column: 1 / -1; text-align: center; padding: 20px; color: #888;">èƒŒåŒ…ç©ºç©ºå¦‚ä¹Ÿï¼Œå¿«å»å†’éšªå§ï¼</div>`;
        } else {
            // ğŸ”¥ æ ¸å¿ƒä¿®æ­£ï¼šè³‡æ–™åˆ†çµ„é‚è¼¯ (å †ç–Šé‡è¤‡ç‰©å“)
            const groupedItems = {};

            // éæ­·èƒŒåŒ…ï¼Œçµ±è¨ˆæ•¸é‡ä¸¦è¨˜éŒ„è©²ç‰©å“çš„ã€Œç¬¬ä¸€å€‹ç´¢å¼•ã€
            // æˆ‘å€‘éœ€è¦ç´¢å¼•ä¾†å‚³çµ¦ addToAlchemy å‡½æ•¸
            player.inventory.forEach((item, originalIndex) => {
                if (!groupedItems[item]) {
                    groupedItems[item] = { 
                        count: 0, 
                        firstIndex: originalIndex 
                    };
                }
                groupedItems[item].count++;
            });

            // æ¸²æŸ“ä¸é‡è¤‡çš„å¡ç‰‡
            invDiv.innerHTML = Object.keys(groupedItems).map(itemName => {
                const data = groupedItems[itemName];

                // ç‰©ç†æ¸…æ´—ï¼šåˆ†é›¢åœ–æ¨™èˆ‡åç¨±
                const parts = itemName.split(' ');
                const icon = parts[0] || "ğŸ“¦";
                const name = parts.slice(1).join(' ') || itemName; // è™•ç†æ²’æœ‰ç©ºç™½çš„æƒ…æ³

                // åˆ¤æ–·æ˜¯å¦ç‚ºå‚³å¥‡ç‰©å“ (çµ¦äºˆé¡å¤–å…‰æšˆ)
                const isLegend = itemName.includes("ğŸ‘‘") || itemName.includes("ğŸ’") || itemName.includes("ğŸ’€");
                const legendStyle = isLegend ? 'border-color: #9b59b6; box-shadow: inset 0 0 10px rgba(155, 89, 182, 0.2);' : '';

                return `
                    <div class="alchemy-item-card" onclick="addToAlchemy(${data.firstIndex})" style="${legendStyle}">
                        <div class="al-count-badge">x${data.count}</div>

                        <div class="al-icon">${icon}</div>
                        <div class="al-name">${name}</div>
                        <div class="plus-sign">âœš</div>
                    </div>
                `;
            }).join('');
        }
    }

    // 3. æª¢æŸ¥æŒ‰éˆ•ç‹€æ…‹ (é€£å‹• CSS é€æ˜åº¦èˆ‡é»æ“Š)
    const btn = document.getElementById('mix-btn');
    if (btn) {
        if (alchemyStaging.length === 3) {
            btn.disabled = false;
            btn.classList.add('active'); // è§¸ç™¼ CSS ç™¼å…‰
            btn.innerHTML = "ğŸ”¥ é–‹å§‹ç…‰æˆ ğŸ”¥";
        } else {
            btn.disabled = true;
            btn.classList.remove('active');
            btn.innerHTML = `æŠ•å…¥ç´ æ (${alchemyStaging.length}/3)`;
        }
    }
}

function addToAlchemy(idx) {
    if(alchemyStaging.length < 3) {
        const item = player.inventory.splice(idx, 1)[0]; // å¾èƒŒåŒ…ç§»å‡º
        alchemyStaging.push(item);
        refreshAlchemyUI();
    }
}

function removeFromAlchemy(i) {
    if(alchemyStaging[i]) {
        player.inventory.push(alchemyStaging.splice(i, 1)[0]); // ç§»å›èƒŒåŒ…
        refreshAlchemyUI();
    }
}

// 1. åˆ†é åˆ‡æ›
function switchAlchemyTab(tab) {
    currentAlchemyTab = tab;
    
    // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
    document.querySelectorAll('.al-tab-btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');

    // åˆ‡æ›è¦–åœ–
    document.getElementById('view-synthesis').style.display = tab === 'synthesis' ? 'block' : 'none';
    document.getElementById('view-refine').style.display = tab === 'refine' ? 'block' : 'none';
    
    // åˆ·æ–°ä¸‹æ–¹åˆ—è¡¨
    if (tab === 'synthesis') {
        refreshAlchemyUI(); // å‘¼å«åŸæœ¬çš„åˆæˆåˆ—è¡¨åˆ·æ–°
    } else {
        refreshRefineList(); // å‘¼å«æ–°çš„ç²¾ç…‰åˆ—è¡¨åˆ·æ–°
    }
}

// 2. åˆ·æ–°ç²¾ç…‰åˆ—è¡¨ (åªé¡¯ç¤ºè£å‚™èˆ‡çŸ³é ­)
function refreshRefineList() {
    const invDiv = document.getElementById('alchemy-inventory');
    document.getElementById('alchemy-list-title').innerText = "ğŸ“¦ èƒŒåŒ…ä¸­çš„è£å‚™èˆ‡ç²¾ç…‰çŸ³";
    
    if (invDiv) {
        invDiv.innerHTML = player.inventory.map((item, idx) => {
            // è§£æé“å…·é¡å‹
            const isStone = item.includes("ç²¾ç…‰çŸ³");
            const isEquip = isEquipment(item);
            
            if (!isStone && !isEquip) return ''; // éæ¿¾ç„¡é—œç‰©å“

            // è§£æé¡¯ç¤ºåç¨±
            const parts = item.split(' ');
            const icon = parts[0];
            const name = parts.slice(1).join(' ');
            
            // é¸ä¸­ç‹€æ…‹æ¨£å¼
            const isSelected = (idx === refineTargetIdx) || (idx === refineStoneIdx);
            const borderStyle = isSelected ? 'border-color: #f1c40f; background: rgba(241,196,15,0.1);' : '';

            return `
                <div class="alchemy-item-card" onclick="selectForRefine(${idx}, '${isStone ? 'stone' : 'equip'}')" style="${borderStyle}">
                    <div class="al-icon">${icon}</div>
                    <div class="al-name">${name}</div>
                    ${isSelected ? '<div style="position:absolute; top:2px; right:2px; color:#f1c40f;">âœ”</div>' : ''}
                </div>
            `;
        }).join('');
    }
    updateRefineWorkbench();
}

// è¼”åŠ©ï¼šåˆ¤æ–·æ˜¯å¦ç‚ºè£å‚™
function isEquipment(name) {
    // æª¢æŸ¥æ˜¯å¦åœ¨åœ–é‘‘çš„è£å‚™åˆ—è¡¨ä¸­ (æ’é™¤ç¢ç‰‡ã€è—¥æ°´ç­‰)
    const baseName = name.split(' (+')[0]; // ç§»é™¤ (+n) å¾Œç¶´ä¾†æ¯”å°
    const itemData = MASTER_COLLECTION.find(m => baseName.includes(m.name));
    return itemData && (itemData.type === 'weapon' || itemData.type === 'head' || itemData.type === 'body' || itemData.type === 'accessory');
}

// 3. é¸æ“‡ç²¾ç…‰ç‰©ä»¶
function selectForRefine(idx, type) {
    if (type === 'equip') {
        refineTargetIdx = (refineTargetIdx === idx) ? null : idx;
    } else {
        refineStoneIdx = (refineStoneIdx === idx) ? null : idx;
    }
    refreshRefineList();
}

function clearRefineTarget() { refineTargetIdx = null; refreshRefineList(); }
function clearRefineStone() { refineStoneIdx = null; refreshRefineList(); }

// 4. æ›´æ–°å·¥ä½œå°é è¦½
function updateRefineWorkbench() {
    const targetSlot = document.getElementById('refine-target-slot');
    const stoneSlot = document.getElementById('refine-stone-slot');
    const btn = document.getElementById('refine-btn');
    const rateText = document.getElementById('refine-rate-text');
    const rateBar = document.getElementById('refine-rate-bar');
    const riskText = document.getElementById('refine-risk-text');
    const previewText = document.getElementById('refine-preview-text');

    // æ¸²æŸ“è£å‚™æ§½
    if (refineTargetIdx !== null) {
        const item = player.inventory[refineTargetIdx];
        targetSlot.innerHTML = `<span style="font-size:24px;">${item.split(' ')[0]}</span><span style="font-size:10px;">${getRefineLv(item)}</span>`;
        targetSlot.classList.add('filled');
    } else {
        targetSlot.innerHTML = `<span style="font-size:24px; opacity:0.3;">âš”ï¸</span>`;
        targetSlot.classList.remove('filled');
    }

    // æ¸²æŸ“çŸ³é ­æ§½
    if (refineStoneIdx !== null) {
        const item = player.inventory[refineStoneIdx];
        stoneSlot.innerHTML = `<span style="font-size:24px;">${item.split(' ')[0]}</span>`;
        stoneSlot.classList.add('filled');
    } else {
        stoneSlot.innerHTML = `<span style="font-size:24px; opacity:0.3;">ğŸ’</span>`;
        stoneSlot.classList.remove('filled');
    }

    // è¨ˆç®—æ©Ÿç‡èˆ‡é¢¨éšª
    if (refineTargetIdx !== null && refineStoneIdx !== null) {
        const equipName = player.inventory[refineTargetIdx];
        const stoneName = player.inventory[refineStoneIdx];
        const currentLv = getRefineLv(equipName);
        
        // --- æ©Ÿç‡è¨ˆç®—å…¬å¼ ---
        let baseRate = 0;
        if (currentLv < 6) baseRate = 100;       // +0~+5 -> +6 (100%)
        else if (currentLv < 9) baseRate = 50;   // +6~+8 -> +9 (50%)
        else baseRate = 30;                      // +9ä»¥ä¸Š (30%)

        // çŸ³é ­åŠ æˆ
        let bonus = 0;
        if (stoneName.includes("å¼·åŒ–")) bonus = 15;
        if (stoneName.includes("è¯éº—")) bonus = 50;
        
        let finalRate = Math.min(100, baseRate + bonus);

        // --- é¢¨éšªè¨ˆç®— ---
        let riskMsg = "";
        if (currentLv < 6) riskMsg = "âœ¨ å®‰å®šå€¼ (ç„¡é¢¨éšª)";
        else if (currentLv < 9) riskMsg = "âš ï¸ å¤±æ•—å¯èƒ½å€’é€€";
        else riskMsg = "ğŸ’€ å¤±æ•—å¯èƒ½ç ´ç¢";

        rateText.innerText = `${finalRate}%`;
        rateBar.style.width = `${finalRate}%`;
        rateBar.style.background = finalRate >= 80 ? '#2ecc71' : (finalRate >= 50 ? '#f1c40f' : '#e74c3c');
        riskText.innerText = riskMsg;
        previewText.innerHTML = `é è¦½ï¼š${equipName.split(' (+')[0]} <b style="color:#2ecc71;">(+${currentLv + 1})</b>`;
        
        btn.disabled = false;
        btn.style.opacity = "1";
        btn.style.pointerEvents = "auto";
    } else {
        rateText.innerText = "--%";
        rateBar.style.width = "0%";
        riskText.innerText = "";
        previewText.innerText = "è«‹æ”¾å…¥ç´ æ";
        btn.disabled = true;
        btn.style.opacity = "0.5";
        btn.style.pointerEvents = "none";
    }
}

// è¼”åŠ©ï¼šå¾åç¨±å­—ä¸²æå–ç­‰ç´š
function getRefineLv(name) {
    const match = name.match(/\(\+(\d+)\)/);
    return match ? parseInt(match[1]) : 0;
}

// 5. åŸ·è¡Œç²¾ç…‰ (æ ¸å¿ƒé‚è¼¯)
function executeRefine() {
    if (refineTargetIdx === null || refineStoneIdx === null) return;

    const equipName = player.inventory[refineTargetIdx];
    const stoneName = player.inventory[refineStoneIdx];
    const currentLv = getRefineLv(equipName);
    const baseName = equipName.split(' (+')[0].trim(); // ç§»é™¤èˆŠå¾Œç¶´

    // è¨ˆç®—æˆåŠŸç‡ (èˆ‡é è¦½é‚è¼¯ä¸€è‡´)
    let baseRate = (currentLv < 6) ? 100 : (currentLv < 9 ? 50 : 30);
    let bonus = 0;
    if (stoneName.includes("å¼·åŒ–")) bonus = 15;
    if (stoneName.includes("è¯éº—")) bonus = 50;
    let finalRate = baseRate + bonus;

    // æ¶ˆè€—ç²¾ç…‰çŸ³
    // æ³¨æ„ï¼šå…ˆåˆªé™¤å¾Œé¢çš„ç´¢å¼•ï¼Œä»¥å…å½±éŸ¿å‰é¢çš„ç´¢å¼•
    const idxToDelete = [refineTargetIdx, refineStoneIdx].sort((a, b) => b - a);
    
    // å¦‚æœè£å‚™æ²’çˆ†ï¼Œæˆ‘å€‘åªæ˜¯æ”¹åï¼Œæ‰€ä»¥å…ˆä¸åˆªè£å‚™ï¼ŒåªåˆªçŸ³é ­
    // ä½†ç‚ºäº†é‚è¼¯ç°¡å–®ï¼Œæˆ‘å€‘å…ˆæŠŠå…©è€…éƒ½æ¨™è¨˜ã€‚å¦‚æœæ˜¯ä¿®æ”¹ï¼Œæˆ‘å€‘ç›´æ¥æ”¹ array[idx]
    
    // æ¶ˆè€—çŸ³é ­
    player.inventory.splice(refineStoneIdx, 1);
    
    // ç”±æ–¼çŸ³é ­ç§»é™¤äº†ï¼Œå¦‚æœè£å‚™ç´¢å¼•å¤§æ–¼çŸ³é ­ç´¢å¼•ï¼Œè£å‚™ç´¢å¼•è¦ -1
    let actualEquipIdx = refineTargetIdx;
    if (refineTargetIdx > refineStoneIdx) actualEquipIdx--;

    const roll = Math.random() * 100;
    let resultMsg = "";

    // --- åˆ¤å®šçµæœ ---
    if (roll < finalRate) {
        // A. æˆåŠŸ
        const newLv = currentLv + 1;
        player.inventory[actualEquipIdx] = `${baseName} (+${newLv})`;
        resultMsg = `âœ¨ ç²¾ç…‰æˆåŠŸï¼è£å‚™å‡ç´šç‚º (+${newLv})`;
        triggerLevelUpEffect(); // é‡ç”¨å‡ç´šç‰¹æ•ˆ
    } else {
        // B. å¤±æ•—
        if (currentLv < 6) {
            // ç†è«–ä¸Š 100% ä¸æœƒé€²ä¾†ï¼Œä½†é˜²å‘†
            resultMsg = "âš ï¸ ç²¾ç…‰å¤±æ•— (å®‰å®šå€¼ç„¡æå¤±)";
        } else if (currentLv < 9) {
            // C. å¤±æ•—å€’é€€ (å®‰å®šå€¼å€é–“)
            const newLv = Math.max(6, currentLv - 1); // æœ€ä½è·Œå› +6
            player.inventory[actualEquipIdx] = `${baseName} (+${newLv})`;
            resultMsg = `ğŸ“‰ ç²¾ç…‰å¤±æ•—... è£å‚™å€’é€€è‡³ (+${newLv})`;
        } else {
            // D. å¤±æ•—ç ´ç¢ (+10ä»¥ä¸Š)
            player.inventory.splice(actualEquipIdx, 1); // ç§»é™¤è£å‚™
            resultMsg = `ğŸ’€ ç²¾ç…‰å¤±æ•—... è£å‚™æ‰¿å—ä¸ä½åŠ›é‡è€Œç²‰ç¢äº†ï¼`;
            if (typeof triggerCheatShatterEffect === 'function') triggerCheatShatterEffect();
        }
    }

    // å­˜æª”èˆ‡åˆ·æ–°
    showNotification(resultMsg);
    savePlayerToDB();
    updatePlayerUI();
    
    // é‡ç½®é¸å–
    refineTargetIdx = null;
    refineStoneIdx = null;
    refreshRefineList();
}

// 6. æ•¸å€¼æˆé•·è¨ˆç®— (Update Stats)
// è«‹å°‡æ­¤å‡½æ•¸è¦†è“‹èˆŠçš„ getFinalBattleStats
function getFinalBattleStats() {
    let totalAtk = player.lv; 
    let totalDef = 0;
    let timeBonus = 0;

    Object.values(player.equips).forEach(item => {
        if (!item) return;

        // æª¢æŸ¥èƒŒåŒ…ä¸­æ˜¯å¦é‚„æœ‰é€™ä»¶è£å‚™ (å¦‚æœè¢«ç²¾ç…‰çˆ†äº†ï¼Œé€™è£¡è¦é˜²å‘†)
        // é€™è£¡å‡è¨­ player.equips å­˜çš„æ˜¯ç‰©ä»¶åƒè€ƒã€‚
        // ä½†æˆ‘å€‘çš„ç²¾ç…‰æ˜¯ä¿®æ”¹èƒŒåŒ…å­—ä¸²ã€‚
        // *é—œéµ*ï¼šç•¶ç©å®¶è£å‚™æ™‚ï¼Œæˆ‘å€‘æ‡‰è©²å­˜ã€Œåç¨±ã€è€Œä¸æ˜¯ç‰©ä»¶ï¼Œæˆ–è€…æ¯æ¬¡æˆ°é¬¥å‰é‡æ–°è§£æåç¨±ã€‚
        // ç‚ºäº†ç›¸å®¹ï¼Œæˆ‘å€‘è§£æ item.name (å‡è¨­ item æ˜¯å¾èƒŒåŒ…å­—ä¸² find å‡ºä¾†çš„ç‰©ä»¶)
        
        // é€™è£¡æˆ‘å€‘éœ€è¦ä¸€å€‹å‹•æ…‹è¨ˆç®—å™¨
        const currentNameInBag = player.inventory.find(n => n.startsWith(item.name.split(' (+')[0]));
        const lv = currentNameInBag ? getRefineLv(currentNameInBag) : 0;
        
        // --- æ•¸å€¼æˆé•·å…¬å¼ ---
        // +1~+6: 10% per lv
        // +7~+9: 15% per lv
        // +10+:  25% per lv
        let multiplier = 1.0;
        for(let i=1; i<=lv; i++) {
            if (i <= 6) multiplier += 0.10;
            else if (i <= 9) multiplier += 0.15;
            else multiplier += 0.25;
        }

        if (item.stats.atk) totalAtk += Math.floor(item.stats.atk * multiplier);
        if (item.stats.def) totalDef += Math.floor(item.stats.def * multiplier);
        if (item.stats.timer) timeBonus += item.stats.timer; // æ™‚é–“é€šå¸¸ä¸åŠ æˆ
    });

    return { totalAtk, totalDef, timeBonus };
}


/**
 * ğŸ”® éŠé‡‘åˆæˆç¸½æ§ä¸­å¿ƒ
 * è·è²¬ï¼šèª¿åº¦é…æ–¹æª¢æŸ¥ã€éš¨æ©Ÿä¿åº•èˆ‡çå‹µç™¼æ”¾
 */
function executeAlchemy() {
    // 1. åŸºç¤æª¢æŸ¥
    if (alchemyStaging.length !== 3) {
        return showNotification("âš ï¸ åˆæˆéœ€è¦æ”¾å…¥ 3 ä»¶ææ–™å–”ï¼");
    }

    // 2. å˜—è©¦åŒ¹é…é…æ–¹ (å„ªå…ˆç´šï¼šç²¾ç…‰çŸ³ > ç¥è©± > éš¨æ©Ÿ)
    let reward = tryGetStoneRecipe(alchemyStaging) || 
                 tryGetMythicRecipe(alchemyStaging) || 
                 getGachaReward();

    // 3. ç™¼æ”¾çå‹µ
    if (reward) {
        grantAlchemyReward(reward);
    }

    // 4. æ¸…ç†ç¾å ´
    cleanupAlchemy();
}

/**
 * ğŸ§ª é…æ–¹æª¢æŸ¥ Aï¼šç²¾ç…‰çŸ³åˆæˆ
 * è¦å‰‡ï¼š3 å€‹ç›¸åŒçš„ç¢å¡Š -> 1 å€‹é«˜éšçŸ³é ­
 */
function tryGetStoneRecipe(materials) {
    // æª¢æŸ¥æ˜¯å¦ä¸‰å€‹ç´ æå®Œå…¨ç›¸åŒ
    if (materials[0] !== materials[1] || materials[1] !== materials[2]) {
        return null;
    }

    const matName = materials[0].trim(); // å»é™¤ç©ºç™½

    // å®šç¾©è½‰æ›è¡¨
    const recipeMap = {
        "ğŸ’ ç²¾ç…‰ç¢å¡Š": "ğŸ’ ç²¾ç…‰çŸ³",
        "ğŸ’ å¼·åŒ–ç²¾ç…‰ç¢å¡Š": "ğŸ’ å¼·åŒ–ç²¾ç…‰çŸ³",
        "ğŸ’ è¯éº—ç²¾ç…‰ç¢å¡Š": "ğŸ’ è¯éº—ç²¾ç…‰çŸ³"
    };

    // æ¨¡ç³ŠåŒ¹é… (å› ç‚ºèƒŒåŒ…ä¸­çš„åç¨±å¯èƒ½å¸¶æœ‰å…¶ä»–ç¬¦è™Ÿ)
    for (const [shard, stone] of Object.entries(recipeMap)) {
        if (matName.includes(shard)) {
            // å›å‚³æ¨™æº–çå‹µç‰©ä»¶æ ¼å¼
            return { name: stone, id: null, isSpecial: true };
        }
    }

    return null;
}

/**
 * ğŸ§ª é…æ–¹æª¢æŸ¥ Bï¼šç¥è©±è£å‚™åˆæˆ
 * è¦å‰‡ï¼šç‰¹å®šçš„ç¥å™¨çµ„ä»¶çµ„åˆ
 */
function tryGetMythicRecipe(materials) {
    // 1. åµæ¸¬çµ„ä»¶
    const hasFragment = materials.includes("ğŸ‘‘ è¡€è…¥ç‹æ¬Šç¢ç‰‡");
    const hasTaxBill = materials.includes("ğŸ“œ ç¦å¿Œç¨…å¾‹å–®");
    const hasDagger = materials.includes("ğŸ—¡ï¸ çµ±æ²»è€…ä¹‹é‹’");
    const hasHeart = materials.includes("ğŸ’ åœ‹ç‹çš„è²ªå©ªä¹‹å¿ƒ");
    const fragmentCount = materials.filter(m => m === "ğŸ‘‘ è¡€è…¥ç‹æ¬Šç¢ç‰‡").length;

    let targetId = null;

    // 2. åˆ¤å®šå…¬å¼
    // ã€å…¬å¼ Aã€‘å§‹ç¥–ç‹çš„çœŸçš‡å†  (ç¢ç‰‡ + ç¨…å¾‹å–® æˆ– 3ç‰‡ç¢ç‰‡)
    if ((hasFragment && hasTaxBill) || fragmentCount === 3) {
        targetId = "ultimate_crown";
    } 
    // ã€å…¬å¼ Bã€‘å¯©åˆ¤è€…çš„è¡€è…¥æ¬Šæ– (åˆ©åˆƒ + è²ªå©ªä¹‹å¿ƒ)
    else if (hasDagger && hasHeart) {
        targetId = "artifact_scepter";
    }

    // 3. æª¢ç´¢ä¸¦å›å‚³ç‰©å“æ•¸æ“š
    if (targetId) {
        const item = MASTER_COLLECTION.find(i => i.id === targetId);
        if (item) {
            return { ...item, isMythic: true }; // æ¨™è¨˜ç‚ºç¥è©±ç´š
        }
    }

    return null;
}

/**
 * ğŸ² éš¨æ©Ÿä¿åº•æ©Ÿåˆ¶
 * è¦å‰‡ï¼šå„ªå…ˆæŠ½å–æœªè§£é–ç‰©å“ (30% æ©Ÿç‡)ï¼Œå¦å‰‡å…¨æ± éš¨æ©Ÿ
 */
function getGachaReward() {
    // æ‰¾å‡ºæœªè§£é–çš„åœ–é‘‘ç‰©å“
    const lockedItems = MASTER_COLLECTION.filter(item => !player.collection.includes(item.id));
    
    let rewardItem;

    // 30% æ©Ÿç‡ä¸”æœ‰æœªè§£é–ç‰©å“æ™‚ï¼Œå„ªå…ˆçµ¦æ–°è²¨
    if (lockedItems.length > 0 && Math.random() > 0.3) {
        rewardItem = lockedItems[Math.floor(Math.random() * lockedItems.length)];
    } else {
        // å¦å‰‡å…¨æ± éš¨æ©Ÿ
        rewardItem = MASTER_COLLECTION[Math.floor(Math.random() * MASTER_COLLECTION.length)];
    }

    return rewardItem;
}

/**
 * ğŸ çå‹µç™¼æ”¾è™•ç†å™¨
 * è·è²¬ï¼šæ›´æ–°èƒŒåŒ…ã€åœ–é‘‘ã€è§¸ç™¼ç‰¹æ•ˆèˆ‡é€šçŸ¥
 */
function grantAlchemyReward(reward) {
    // 1. æ”¾å…¥èƒŒåŒ…
    player.inventory.push(reward.name);

    // 2. è§£é–åœ–é‘‘ (å¦‚æœæœ‰ ID)
    if (reward.id && !player.collection.includes(reward.id)) {
        player.collection.push(reward.id);
    }

    // 3. è§¸ç™¼ç¥è©±ç‰¹æ•ˆ
    if (reward.isMythic) {
        showNotification("ğŸŒŒ ç©ºé–“ç”¢ç”ŸåŠ‡çƒˆéœ‡å‹•... ç¥è©±ç´šè£å‚™èª•ç”Ÿï¼");
        if (typeof triggerLevelUpEffect === 'function') triggerLevelUpEffect();
        if (typeof triggerCheatShatterEffect === 'function') triggerCheatShatterEffect();
    }

    // 4. é¡¯ç¤ºçµæœ
    showNotification(`ğŸ”® åˆæˆæˆåŠŸï¼ç²å¾—ï¼šã€${reward.name}ã€‘`);
}

/**
 * ğŸ§¹ ç‹€æ…‹æ¸…ç†å™¨
 * è·è²¬ï¼šé‡ç½®ä»‹é¢ã€åŒæ­¥æ•¸æ“šã€åŸ·è¡Œå­˜æª”
 */
function cleanupAlchemy() {
    // 1. æ¸…ç©ºæš«å­˜å€
    alchemyStaging = [];

    // 2. ç‰©ç†åŒæ­¥ UI
    refreshAlchemyUI();
    updatePlayerUI();

    // 3. åŸ·è¡Œé›™ç«¯å­˜æª”
    if (typeof savePlayerToDB === 'function') savePlayerToDB();
    if (typeof saveGameToCloud === 'function') saveGameToCloud();
}

/**
 * ğŸ’ é€šç”¨æˆ°è¡“ç‰©å“æ¬„ç”Ÿæˆå™¨ (V5.9.25)
 * ä½œç”¨ï¼šçµ±ä¸€åœ°åœ–æˆ°é¬¥èˆ‡ç‰Œæ¡Œå°å±€çš„ç‰©å“æ¸²æŸ“é‚è¼¯
 */
function getSharedTacticalHTML(isPokerMode = false) {
    const items = player.items || {};
    const slots = player.tacticalSlots || ['hp_pot', 'antidote', 'stimulant'];
    const isPerfect = (player.currentHp >= player.maxHp && !player.status);

    const itemMeta = {
        'hp_pot':    { icon: 'ğŸº', act: 'useHpPot()', name: 'å†é€ ç½' },
        'potion':    { icon: 'ğŸ§´', act: 'usePotionInPoker()', name: 'è—¥æ°´' },
        'antidote':  { icon: 'ğŸ§ª', act: "cureStatus('poison')", name: 'è§£æ¯’' },
        'hemostat':  { icon: 'ğŸ©¹', act: "cureStatus('bleed')", name: 'æ­¢è¡€' },
        'stimulant': { icon: 'ğŸ’‰', act: "cureStatus('paralyze')", name: 'èˆˆå¥®åŠ‘' },
        'none':      { icon: 'ğŸš«', act: '', name: 'ç©º' }
    };

    // ğŸ¨ ç‰©ç†ä½ˆå±€ï¼šå°é½Šã€Œå¾¡é¢¨éš¨è¡Œã€æ¥µç°¡åœ“è§’é¢¨æ ¼ [cite: 2026-01-19]
    return `
        <div class="tactical-item-belt" style="display: flex; gap: 8px; justify-content: center; margin-top: 10px;">
            ${slots.map(id => {
                const info = itemMeta[id] || itemMeta['none'];
                const count = items[id] || 0;
                const hasStock = count > 0;
                
                // ç‰©ç†ç„¡æ™é–å®š
                const clickAction = isPerfect 
                    ? `showNotification('âœ¨ ç›®å‰èº«å¿ƒç„¡æ™ï¼Œç„¡éœ€ä½¿ç”¨ã€‚')` 
                    : (hasStock ? info.act : `showNotification('âŒ ç‰©è³‡å‘Šç½„')`);

                return `
                    <div class="item-slot-v4 ${hasStock ? 'has-item' : ''}" 
                         onclick="${clickAction}"
                         style="
                            width: ${isPokerMode ? '32px' : '45px'}; 
                            height: ${isPokerMode ? '32px' : '45px'}; 
                            background: rgba(10, 10, 10, 0.9);
                            border: 1.5px solid ${hasStock ? '#2ecc71' : '#444'};
                            border-radius: 8px; display: flex; align-items: center; justify-content: center;
                            position: relative; cursor: pointer; transition: 0.2s;
                            opacity: ${isPerfect && hasStock ? '0.7' : '1'};
                         ">
                        <span style="font-size: ${isPokerMode ? '18px' : '24px'}; filter:${hasStock ? 'none' : 'grayscale(1) opacity(0.3)'};">${info.icon}</span>
                        ${hasStock ? `<div class="slot-badge-v4" style="position: absolute; bottom: -2px; right: -2px; background: #2ecc71; color: #000; font-size: 9px; padding: 0 4px; border-radius: 4px; font-weight: 900;">${count}</div>` : ''}
                    </div>
                `;
            }).join('')}
        </div>
    `;
}

/**
 * ğŸ—ºï¸ ç‰©ç†æ¸²æŸ“ï¼šå†’éšªåœ°åœ–å‚³é€é–€ (å‰ç·šè£œçµ¦ç«™å…¥å£å›æ­¸ç‰ˆ)
 * ä¿®æ­£ï¼šåœ¨è¡€è…¥ç‹åœ‹å…¥å£å‰æ³¨å…¥è£œçµ¦ç«™ï¼Œæ”¯æ´é–‹æ‹“èˆ‡ç‰©è³‡æ•´å‚™
 */
async function renderAdventureMap() {
    const listContainer = document.getElementById('map-portal-list');
    const posBar = document.getElementById('map-hero-pos-bar');
    
    if (!listContainer) return;

    // 1. ç‰©ç†çµ±è¨ˆï¼šå¾è³‡æ–™åº«ç²å–é€²åº¦
    let allPacks = [];
    try { 
        allPacks = await db.fuelPacks.toArray(); 
    } catch (e) { 
        console.error("åœ°åœ–æ•¸æ“šè®€å–å¤±æ•—", e); 
    }
    
    const stats = { N1: 0, N2: 0, N3: 0, N4: 0, N5: 0 };
    allPacks.forEach(pack => {
        const diff = (pack.difficulty || "").toUpperCase();
        if (stats.hasOwnProperty(diff)) stats[diff]++;
    });

    // 2. å®šç¾©åœ°åœ–æ•¸æ“šçµæ§‹
    const mapZones = [
        { type: 'header', label: 'ğŸ  å®‰å…¨å€åŸŸ' },
        { id: 'Home', name: 'å‹‡è€…çš„å®¶', icon: 'ğŸ›Œ', color: '#f39c12', desc: 'ä¼‘æ¯ã€æ¢å¾©é«”åŠ›ã€æ•´ç†è£å‚™' },
        { type: 'header', label: 'âš”ï¸ å†’éšªå€åŸŸ' },
        { id: 'N5', name: 'åˆå¿ƒè€…ä¹‹æ£® (N5)', icon: 'ğŸŒ¿', color: '#2ecc71', desc: `å·²ä½”é ˜: ${player.mapProgress?.N5 || 0} è™•` },
        { id: 'N4', name: 'è¿·éœ§æ£®æ— (N4)', icon: 'ğŸŒ²', color: '#3498db', desc: `å·²ä½”é ˜: ${player.mapProgress?.N4 || 0} è™•` },
        { id: 'N3', name: 'å·¨äººä¹‹å³° (N3)', icon: 'â›°ï¸', color: '#f1c40f', desc: `å·²ä½”é ˜: ${player.mapProgress?.N3 || 0} è™•` },
        { id: 'N2', name: 'å‡œå†¬è¦å¡ (N2)', icon: 'ğŸ¯', color: '#e67e22', desc: `å·²ä½”é ˜: ${player.mapProgress?.N2 || 0} è™•` },
        { id: 'N1', name: 'ç†¾ç‚é­”åŸ (N1)', icon: 'ğŸ”¥', color: '#e74c3c', desc: `å·²ä½”é ˜: ${player.mapProgress?.N1 || 0} è™•` },
        { type: 'header', label: 'ğŸ©¸ ç¦å¿Œå€åŸŸ' },
        { id: 'BloodyKingdom', name: 'è¡€è…¥ç‹åœ‹', icon: 'ğŸ©¸', color: '#ff0000', desc: 'âš ï¸ å…¥å ´è²»: 10,000 G (é«˜é¢¨éšªè³­åš)', specialStyle: 'background: linear-gradient(90deg, #440000 0%, #000 100%); border-color: #8b0000;' }
    ];

    // 3. åˆ¤æ–· N0 çœ¾ç¥éºå€æ˜¯å¦è§£é–
    const legendaryCount = Object.values(player.mapProgress || {}).filter(v => v >= 100).length;
    if (legendaryCount >= 3) {
        mapZones.push({ 
            id: 'N0', name: 'çœ¾ç¥éºå€ (N0)', icon: 'ğŸŒŒ', color: '#fff', 
            desc: 'æœ€çµ‚è©¦ç…‰ (Legendary)', 
            specialStyle: 'background: linear-gradient(90deg, #000 0%, #222 100%); border: 1px double #fff;'
        });
    }

    // 4. ğŸ”¥ ç”Ÿæˆ HTML
    let html = '';
    
    // A. æ’å…¥æ•™å ‚åŠŸèƒ½å€å¡Š
    const currentDust = player.phantomDust || 0;
    html += `
        <div id="church-section" style="margin-bottom: 20px; background: rgba(241, 196, 15, 0.05); padding: 15px; border-radius: 8px; border: 1px solid rgba(241, 196, 15, 0.2);">
            <div style="display:flex; justify-content:space-between; margin-bottom: 10px; align-items: center;">
                <b style="color: #f1c40f; font-size: 14px;">â›ª è–å…‰æ•™å ‚</b>
                <small style="color: #aaa;">å¹»å½±ä¹‹å¡µ: <span style="color:#fff; font-weight:bold;">${currentDust}</span></small>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                <button class="game-btn" onclick="churchService('heal')">â¤ï¸ æ¢å¾© (20G)</button>
                <button class="game-btn" onclick="churchService('pray')">ğŸ™ ç¦±å‘Š (50G)</button>
                <button class="game-btn" onclick="buyItem('potion')">ğŸ§´ è²·è—¥ (10G)</button>
                <button class="game-btn" onclick="tryChurchExchange()" style="border-color: #9b59b6; color: #d5a6bd;">ğŸ”® å¥‡è¹Ÿå…Œæ›</button>
            </div>
        </div>
    `;

    // B. æ’å…¥åœ°åœ–æŒ‰éˆ•èˆ‡è£œçµ¦ç«™å…¥å£
    mapZones.forEach(zone => {
        if (zone.type === 'header') {
            html += `<div class="section-title" style="margin-top:15px; margin-bottom:8px; border-bottom:1px solid #444; color:#aaa; font-size:12px; font-weight:bold;">${zone.label}</div>`;
        } else {
            
            // --- ğŸ”¥ æ ¸å¿ƒæ–°å¢ï¼šå‰ç·šè£œçµ¦ç«™ (ç‰©ç†ä½ç½®é–å®šåœ¨è¡€è…¥ç‹åœ‹ä¸Šæ–¹) ---
            if (zone.id === 'BloodyKingdom') {
                html += `
                    <div class="portal-card" onclick="openKingdomShop()" 
                         style="--p-color: #9b59b6; background: rgba(155, 89, 182, 0.1); border: 2px dashed #9b59b6; margin-bottom: 12px; animation: portalPulse 2s infinite ease-in-out;">
                        <div class="portal-icon">ğŸª</div>
                        <div class="portal-info">
                            <div class="portal-title" style="color:#d5a6bd !important;">å‰ç·šè£œçµ¦ç«™ (Merchant Post)</div>
                            <div class="portal-desc">æˆ°å‰æœ€å¾Œæ•´å‚™ï¼šè³¼è²·å·è»¸èˆ‡ç¦å¿Œé“å…·</div>
                        </div>
                        <div class="portal-tag" style="border-color:#9b59b6; color:#9b59b6;">SUPPLY</div>
                    </div>
                `;
            }

            const isActive = (currentMapDifficulty === zone.id);
            const activeClass = isActive ? 'active-portal' : '';
            const activeTag = isActive ? `<div class="current-loc-tag">ğŸ“ ç•¶å‰ä½ç½®</div>` : '';
            
            let badgeHtml = '';
            if (['N5','N4','N3','N2','N1'].includes(zone.id)) {
                const count = player.mapProgress?.[zone.id] || 0;
                if (count >= 100) badgeHtml = '<span class="map-badge badge-legend">â­</span>';
                else if (count >= 60) badgeHtml = '<span class="map-badge">ğŸ¥ˆ</span>';
                else if (count >= 30) badgeHtml = '<span class="map-badge">ğŸ¥‰</span>';
            }

            const customStyle = zone.specialStyle || ``;
            
            if (zone.id === 'BloodyKingdom' && player.coin < 0) {
                 html += `
                    <div class="portal-card ${activeClass}" onclick="travelTo('${zone.id}')" 
                         style="--p-color: ${zone.color}; ${customStyle} position:relative; box-shadow: inset 0 0 10px #f00;">
                        <div class="portal-icon">â›“ï¸</div>
                        <div class="portal-info">
                            <div class="portal-title" style="color:#ff4d4d !important;">å¼·åˆ¶å‹å½¹ä¸­</div>
                            <div class="portal-desc">æ¬ å‚µï¼š${Math.abs(player.coin)}G | éœ€æ¸…å„Ÿæ‰èƒ½é›¢é–‹</div>
                        </div>
                        ${activeTag}
                    </div>
                `;
            } else {
                html += `
                    <div class="portal-card ${activeClass}" onclick="travelTo('${zone.id}')" 
                         style="--p-color: ${zone.color}; ${customStyle} position:relative;">
                        <div class="portal-icon">${zone.icon}</div>
                        <div class="portal-info">
                            <div class="portal-title" style="color:${zone.color} !important;">
                                ${zone.name} ${badgeHtml}
                            </div>
                            <div class="portal-desc">${zone.desc}</div>
                        </div>
                        ${activeTag}
                    </div>
                `;
            }
        }
    });

    listContainer.innerHTML = html;

    // 5. æ›´æ–°é ‚éƒ¨é€²åº¦æ¢
    const offsets = { "Home":0, "N5":20, "N4":35, "N3":50, "N2":65, "N1":80, "BloodyKingdom":90, "N0":100 };
    const targetPercent = offsets[currentMapDifficulty.replace("-EX", "")] || 0;
    if(posBar) posBar.style.width = `${targetPercent}%`;
}

// --- ğŸ©¸ è¡€è…¥ç‹åœ‹ï¼šç‰©ç†ç ´ç”¢æ‡²ç½°ç³»çµ± ---
function applyBankruptcyPenalty() {
    showNotification("ğŸ’€ æ…˜æ•—ï¼è¡€è…¥ç‹åœ‹æ²’æ”¶äº†ä½ çš„éˆé­‚...");

    // 1. ç‰©ç†è¨ˆç®—å…¨ç¶“é©—å€¼ (Level + Exp)
    // å‡è¨­æ¯ç´šå›ºå®š 100 é»ç¶“é©—
    let totalXp = (player.lv * 100) + player.exp;
    let penalty = Math.floor(totalXp * 0.15); // å€’æ‰£ 15%
    let newTotalXp = totalXp - penalty;

    // 2. ç‰©ç†é™ç´šé‚„åŸ
    player.lv = Math.floor(newTotalXp / 100);
    player.exp = newTotalXp % 100;
    if (player.lv < 1) { player.lv = 1; player.exp = 0; }

    // 3. ç‰©ç†è² å‚µèˆ‡è² é¢ç‹€æ…‹
    player.coin = -500; // å¼·åˆ¶è² å‚µ (å‡è¨­åŸºæœ¬æ¬ æ¬¾ 500G)
    player.inventory.push("â›“ï¸ å‚µå‹™äººçš„éµéˆ"); // ç‰©ç†æ¨™è¨˜è£å‚™

    // 4. æ›´æ–° UI
    updatePlayerUI();
    showNotification(`ğŸ“‰ è™•åˆ‘å®Œæˆï¼šç­‰ç´šé™è‡³ LV.${player.lv}ï¼Œä¸”èƒŒè² å‚µå‹™ï¼`);
}

function tryChurchExchange() {
    const currentDust = player.phantomDust || 0;

    if (currentDust >= 10) {
        // ç‰©ç†åŸ·è¡Œå…Œæ›
        if (typeof exchangeAtChurch === 'function') {
            exchangeAtChurch();
            // å…Œæ›å¾Œç«‹å³åˆ·æ–°åœ°åœ– UI ä»¥æ›´æ–°æ•¸å­—
            renderAdventureMap(); 
        }
    } else {
        showNotification("â›ª ç¥­å¸ï¼šå­©å­ï¼Œä½ çš„ã€å¹»å½±ä¹‹å¡µã€‘é‚„ä¸å¤ ï¼Œç„¡æ³•å‡èšå¥‡è¹Ÿ...");
    }
}

// --- ğŸ“£ ç‰©ç†é€šçŸ¥ç³»çµ±ï¼šé¡¯ç¤ºéŠæˆ²è¨Šæ¯ ---
function showNotification(msg) {
    console.log(`ğŸ“¢ éŠæˆ²é€šçŸ¥: ${msg}`);

    // 1. å»ºç«‹é€šçŸ¥å®¹å™¨ (å¦‚æœä¸å­˜åœ¨å‰‡å»ºç«‹)
    let container = document.getElementById('game-notification-container');
    if (!container) {
        container = document.createElement('div');
        container.id = 'game-notification-container';
        container.style = `
            position: fixed; top: 100px; left: 50%; transform: translateX(-50%);
            z-index: 10000; pointer-events: none; width: 80%; max-width: 300px;
        `;
        document.body.appendChild(container);
    }

    // 2. å»ºç«‹è¨Šæ¯å…ƒç´ 
    const toast = document.createElement('div');
    toast.style = `
        background: rgba(0, 0, 0, 0.85); color: white; border: 2px solid #fff;
        padding: 10px 15px; margin-bottom: 8px; border-radius: 4px;
        font-family: 'Courier New', monospace; font-size: 12px;
        text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        animation: toastFadeIn 0.3s ease-out;
    `;
    toast.innerHTML = msg;

    container.appendChild(toast);

    // 3. ç‰©ç†ç§»é™¤ï¼š2.5 ç§’å¾Œæ¶ˆå¤±
    setTimeout(() => {
        toast.style.transition = "opacity 0.5s ease";
        toast.style.opacity = "0";
        setTimeout(() => toast.remove(), 500);
    }, 2500);
}

// 4. åŠ å…¥å‹•ç•« CSS (ç‰©ç†æ³¨å…¥)
if (!document.getElementById('toast-style')) {
    const style = document.createElement('style');
    style.id = 'toast-style';
    style.innerHTML = `
        @keyframes toastFadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    `;
    document.head.appendChild(style);
}


/**
 * æ ¸å¿ƒï¼šç‹€æ…‹èˆ‡è¦–è¦ºåŒæ­¥å®Œå…¨é«” (V4.5)
 * æ•´åˆï¼šå±æ€¥ç”Ÿå­˜ç‰¹æ•ˆã€ç™¾é€£å‹é€²åŒ–ã€VIP èº«ä»½èˆ‡ç‰©ç†æˆé•·
 */
function updatePlayerUI() {
    if (!player) return;

    // --- 1. ğŸ”¥ ã€ç‰©ç†è¡€é‡é‹ç®—ï¼šå‹•æ…‹æˆé•·èˆ‡è£å‚™åŠ æˆã€‘ ---
    const baseMaxHp = 50 + (player.lv * 10);
    // ç‰©ç†æ˜ å°„è£å‚™æä¾›çš„ HP åŠ æˆ
    const headHp = (player.equips?.head?.stats?.hp || 0);
    const bodyHp = (player.equips?.body?.stats?.hp || 0);
    
    player.maxHp = baseMaxHp + headHp + bodyHp;
    
    // æº¢å‡ºé˜²è­·ï¼šç¢ºä¿ç•¶å‰è¡€é‡ä¸è¶…éå‹•æ…‹ä¸Šé™
    if (player.currentHp > player.maxHp) player.currentHp = player.maxHp;
    
    const curHp = player.currentHp || 0;
    const hpPercent = Math.max(0, Math.min(100, (curHp / player.maxHp) * 100));

    // UI å¯¦é«”é€£å‹•
    const hpBar = document.getElementById('hero-hp-bar');
    const hpText = document.getElementById('hero-hp-text');
    
    if (hpBar) {
        hpBar.style.width = hpPercent + '%';
        // ç‰©ç†è­¦ç¤ºè‰²åˆ†ç´š
        if (hpPercent <= 25) hpBar.style.backgroundColor = "#ff4d4d"; 
        else if (hpPercent <= 50) hpBar.style.backgroundColor = "#f1c40f"; 
        else hpBar.style.backgroundColor = "#2ecc71"; 
    }
    if (hpText) {
        hpText.innerText = `${Math.floor(curHp)} / ${player.maxHp}`;
        hpText.style.color = hpPercent <= 25 ? "#ff4d4d" : "#2ecc71";
    }

    // --- 2. ğŸš¨ ã€ç‰©ç†é€£å‹•ï¼šå±æ€¥ç”Ÿå­˜è¦–è¦ºé»ç«ã€‘ ---
    // é€™è£¡æ˜¯æ‚¨å‰›å‰›å°å…¥çš„ç”Ÿå­˜ç‰¹æ•ˆå…¥å£ï¼Œç¢ºä¿ HP è®Šå‹•æ™‚ç«‹å³æª¢æ ¸
    if (typeof updateSurvivalVfx === 'function') {
        updateSurvivalVfx(); 
    }

    // --- 3. ğŸ›¡ï¸ ã€ç‰©ç†æ ¸å¿ƒï¼šç‹æ¬Šå‡æ ¼åˆ¤å®šå±¤ã€‘ ---
    const currentStreak = player.kingStreak || 0;
    // ç‰©ç†æª¢ç´¢ä¾†è‡ªå…¨åŸŸå¸¸æ•¸çš„ç¨±è™Ÿæ•¸æ“š
    const kTitle = typeof getKingTitleData === 'function' ? getKingTitleData(currentStreak) : { name: "", color: "#f1c40f", glow: "none" };

    // --- 4. åˆ¤å®šåŸºç¤å†’éšªé ­éŠœ ---
    const upgrades = player.homeUpgrades || { bed: 1, vault: 1, bookshelf: 1 };
    const totalHomeLv = (upgrades.bed || 0) + (upgrades.vault || 0) + (upgrades.bookshelf || 0);

    const baseTitles = [
        { condition: () => totalHomeLv >= 30, name: "ğŸ‘‘ é»ƒé‡‘å±‹å»ºç¯‰å¸«" },
        { condition: () => player.lv >= 50, name: "ğŸ“œ æ—¥æ–‡å¤§è³¢è€…" },
        { condition: () => player.lv >= 30, name: "ğŸ—¡ï¸ èªè¨€å¤§å°å¸«" },
        { condition: () => player.lv >= 1, name: "ğŸŒ± åˆç´šå†’éšªè€…" }
    ];
    const matchedBase = baseTitles.find(t => t.condition());
    player.title = matchedBase ? matchedBase.name : "ğŸŒ± åˆç´šå†’éšªè€…";

    const titleEl = document.getElementById('player-title');
    if (titleEl) {
        let titleHTML = `<span style="opacity: 0.9;">${player.title}</span>`;
        if (currentStreak >= 2) {
            // ç‰©ç†è¦–è¦ºé‡çµ„ï¼šå¥—ç”¨é€£å‹å…‰è­œ
            titleEl.style.color = kTitle.color;
            titleEl.style.textShadow = kTitle.glow;
            titleHTML += ` <span style="font-size: 11px; margin-left: 5px; border-left: 1px solid #444; padding-left: 5px;">${kTitle.name}</span>`;
            titleHTML += ` <span style="color:#f1c40f; font-size:12px; font-weight: bold;"> ğŸ”¥ x${currentStreak}</span>`;
            titleEl.classList.add('title-legend-glow');
        } else {
            titleEl.style.color = "#f1c40f";
            titleEl.style.textShadow = "none";
            titleEl.classList.remove('title-legend-glow');
        }
        titleEl.innerHTML = titleHTML;
    }

    // --- 5. ç‰©ç†æ›´æ–°æ•¸å€¼èˆ‡ VIP ç‰¹æ¬Šç‰¹æ•ˆ ---
    const lvEl = document.getElementById('player-lv');
    const coinEl = document.getElementById('player-coin');
    const coinContainer = coinEl ? coinEl.parentElement : null;

    if (lvEl) lvEl.innerText = player.lv;
    if (coinEl) coinEl.innerText = player.coin.toLocaleString();

    if (player.hasVipCard && coinContainer) {
        coinContainer.style.textShadow = "0 0 10px #9b59b6";
        coinContainer.style.color = "#d5a6bd";
    }

    // --- 6. å®¶å…·å…±é³´èˆ‡è¦–è¦ºåŒæ­¥ (åƒ…åœ¨å®¶ä¸­å•Ÿå‹•) ---
    const isResonating = (upgrades.bed >= 5 && upgrades.vault >= 5 && upgrades.bookshelf >= 5);
    const screen = document.getElementById('adventure-screen');
    if (typeof currentMapDifficulty !== 'undefined' && currentMapDifficulty === "Home" && screen) {
        screen.style.animation = isResonating ? "holyGlow 3s infinite alternate" : "";
    }

    // å®¶å…·ç­‰ç´š UI æ›´æ–°
    if (typeof UPGRADE_MATH !== 'undefined') {
        ['bed', 'vault', 'bookshelf'].forEach(key => {
            const lv = upgrades[key] || 1;
            const info = UPGRADE_MATH.getInfo(key, lv);
            const iconEl = document.getElementById(`${key}-icon`);
            const tagEl = document.getElementById(`${key}-level-tag`);
            if (iconEl) iconEl.innerText = info.icon;
            if (tagEl) tagEl.innerText = `LV.${lv} ${key.toUpperCase()}`;
        });
    }

    // --- 7. ğŸ”¥ ã€æ•¸æ“šæŒä¹…åŒ–èˆ‡å¤–è§€é–å®šã€‘ ---
    if (typeof updateHeroAppearance === 'function') updateHeroAppearance();
    
    // ç‰©ç†å­˜æª”ï¼šé˜²æ­¢åœ¨éæˆ°é¬¥åˆ‡æ›ç‹€æ…‹ä¸‹éºå¤±é€²åº¦
    if (typeof savePlayerToDB === 'function' && !window.isBattleTransitioning) {
        savePlayerToDB(); 
    }
    
    // æœ¬åœ°å‚™ä»½å‚™æ´
    localStorage.setItem('tabi_rpg_backup', JSON.stringify(player));
}


/**
 * ğŸš¨ ç‰©ç†å­ç¨‹åºï¼šå±æ€¥ç”Ÿå­˜è¦–è¦ºé»ç«å™¨
 * ä½œç”¨ï¼šåµæ¸¬ HP æ˜¯å¦ä½æ–¼ 15% è‡¨ç•Œé»ä¸¦å•Ÿå‹•ç‰¹æ•ˆ
 */
function updateSurvivalVfx() {
    const hpRatio = player.currentHp / player.maxHp;
    const isCritical = hpRatio < 0.15 && player.currentHp > 0;
    
    // 1. ğŸ”¥ ã€ç‰©ç†æ›è¼‰ï¼šå…¨å±é®ç½©ã€‘
    let vignette = document.getElementById('critical-vignette-overlay');
    if (!vignette) {
        vignette = document.createElement('div');
        vignette.id = 'critical-vignette-overlay';
        vignette.className = 'critical-health-vignette';
        document.body.appendChild(vignette);
    }

    // 2. ğŸ”¥ ã€ç‰©ç†ç‹€æ…‹åˆ‡æ›ã€‘
    const layoutWrapper = document.getElementById('poker-layout-wrapper') || document.body;

    if (isCritical) {
        vignette.classList.add('vignette-active');
        layoutWrapper.classList.add('heartbeat-shake');
        
        // æˆ°è¡“æ—¥èªŒç´€éŒ„ä¸€æ¬¡æ€§è­¦å ±
        if (!window.hasSentCriticalAlert) {
            addBattleLog(`ğŸš¨ <b style="color:#ff4d4d;">[è­¦å‘Š]</b> é«”åŠ›å·²é”è‡¨ç•Œé» (15%)ï¼Œç”Ÿå‘½è·¡è±¡ä¸ç©©ï¼`);
            window.hasSentCriticalAlert = true;
        }
    } else {
        vignette.classList.remove('vignette-active');
        layoutWrapper.classList.remove('heartbeat-shake');
        window.hasSentCriticalAlert = false;
    }
}

function confirmUpgrade(key) {
    const currentLv = player.homeUpgrades[key] || 1;
    const costs = UPGRADE_MATH.calculate(key, currentLv + 1);

    if (player.coin >= costs.coin && (player.phantomDust || 0) >= costs.dust) {
        // ç‰©ç†æ‰£é™¤è³‡æº
        player.coin -= costs.coin;
        player.phantomDust -= costs.dust;
        player.homeUpgrades[key]++;
        
        // ç‰©ç†åŒæ­¥ç•«é¢åœ–æ¨™
        const info = UPGRADE_MATH.getInfo(key, player.homeUpgrades[key]);
        const iconEl = document.getElementById(`${key}-icon`);
        const tagEl = document.getElementById(`${key}-level-tag`);
        
        if (iconEl) iconEl.innerText = info.icon;
        if (tagEl) tagEl.innerText = `LV.${player.homeUpgrades[key]} ${key.toUpperCase()}`;
        
        showNotification(`ğŸŠ æ­å–œï¼${key} å‡ç´šåˆ°äº† LV.${player.homeUpgrades[key]}ï¼`);
        savePlayerToDB();
        updatePlayerUI();
        
        // åˆ·æ–°é¸å–®
        const modal = document.getElementById('upgrade-modal');
        if (modal) modal.remove();
        openUpgradeUI(); 
    } else {
        showNotification("âš ï¸ è³‡æºä¸è¶³ï¼ä½ éœ€è¦æ›´å¤šé‡‘å¹£æˆ–å¹»å½±ä¹‹å¡µã€‚");
    }
}

// --- ğŸ  å®¶å…·å‡ç´šä»‹é¢ (ç‰©ç†é˜²æ¨¡ç³Šèˆ‡è³‡æºæª¢æŸ¥ç‰ˆ) ---
function openUpgradeUI() {
    // 1. ç‰©ç†é˜²æ­¢é‡è¤‡é–‹å•Ÿ
    const existing = document.getElementById('upgrade-modal');
    if (existing) existing.remove();

    // 2. æ ¸å¿ƒä¿®æ­£ï¼šç²¾ç¢ºéš”é›¢æ¨¡ç³Š
    // æˆ‘å€‘åªé‡å°èƒŒæ™¯å…§å®¹æ–½åŠ æ¿¾é¡ï¼Œç¢ºä¿å½ˆçª—è‡ªèº«çµ•å°æ¸…æ™°
    const mainWrapper = document.querySelector('.main-wrapper');
    const stickyHeader = document.getElementById('game-sticky-header');
    
    if (mainWrapper) {
        mainWrapper.style.transition = "filter 0.4s ease";
        mainWrapper.style.filter = "blur(10px) brightness(0.5)";
        mainWrapper.style.pointerEvents = "none"; // ç‰©ç†ç¦ç”¨èƒŒæ™¯é»æ“Š
    }
    if (stickyHeader) {
        stickyHeader.style.transition = "filter 0.4s ease";
        stickyHeader.style.filter = "blur(10px) brightness(0.5)";
    }

    const modal = document.createElement('div');
    modal.id = "upgrade-modal";
    
    // 3. ç‰©ç†å¤–è§€å®šç¾©ï¼šå¼·åˆ¶ filter:none ä»¥é˜²ç¹¼æ‰¿
    modal.style = `
        position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
        width: 310px; background: #1a1a1a; border: 3px solid #f1c40f; color: white;
        padding: 20px; z-index: 100000; font-family: 'Courier New', monospace;
        border-radius: 12px; box-shadow: 0 0 50px rgba(0,0,0,1);
        filter: none !important; backdrop-filter: none !important;
    `;
    
    let html = `<h3 style="text-align:center; color:#f1c40f; margin:0 0 20px 0; letter-spacing:2px; text-shadow:0 0 10px #f1c40f;">ğŸ”¨ æ“šé»è¨­æ–½æ”¹é€ </h3>`;
    
    // 4. æ•¸æ“šçµæ§‹ä¿è­·ï¼šç¢ºä¿ player.homeUpgrades å­˜åœ¨
    if (!player.homeUpgrades) player.homeUpgrades = { bed: 1, vault: 1, bookshelf: 1 };

    ['bed', 'vault', 'bookshelf'].forEach(key => {
        const lv = player.homeUpgrades[key] || 1;
        const info = UPGRADE_MATH.getInfo(key, lv);
        const nextCosts = UPGRADE_MATH.calculate(key, lv + 1);
        
        // ç‰©ç†è¨ˆç®—è³‡æºæ˜¯å¦è¶³å¤ 
        const canAfford = player.coin >= nextCosts.coin && (player.phantomDust || 0) >= nextCosts.dust;
        
        html += `
            <div style="border:1px solid #444; padding:12px; margin-bottom:12px; background:rgba(255,255,255,0.05); border-radius:8px; filter:none;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <span style="font-size:28px;">${info.icon}</span>
                    <div style="text-align:right;">
                        <b style="color:#f1c40f; font-size:14px;">${key.toUpperCase()} LV.${lv}</b><br>
                        <small style="color:#2ecc71;">${info.desc}</small>
                    </div>
                </div>`;
        
        if (lv < UPGRADE_MATH.maxLv) {
            html += `
                <button onclick="confirmUpgrade('${key}')" 
                    style="width:100%; margin-top:10px; background:${canAfford ? '#f1c40f' : '#555'}; 
                    color:${canAfford ? '#000' : '#888'}; border:none; padding:10px; cursor:${canAfford ? 'pointer' : 'not-allowed'}; 
                    font-weight:bold; border-radius:6px; transition:0.2s;">
                    æ”¹é€ è‡³ LV.${lv+1}<br>
                    <span style="font-size:10px;">ğŸ’° ${nextCosts.coin} | âœ¨ ${nextCosts.dust}</span>
                </button>`;
        } else {
            html += `<div style="text-align:center; color:#f1c40f; font-size:11px; margin-top:10px; border:1px solid #f1c40f; padding:5px; border-radius:4px; font-weight:bold;">â­ å·²é”å‚³å¥‡æ¥µé™ â­</div>`;
        }
        html += `</div>`;
    });

    // 5. é›¢é–‹æŒ‰éˆ•ï¼šç‰©ç†æ¢å¾©æ¸…æ™°
    html += `<button onclick="closeUpgradeUI()" style="width:100%; background:#444; color:white; border:none; padding:12px; cursor:pointer; border-radius:6px; margin-top:10px; font-weight:bold;">è¿”å›å®¶å®¤</button>`;
    
    modal.innerHTML = html;
    document.body.appendChild(modal);
}

// --- ğŸ  ç‰©ç†æ¢å¾©ï¼šé—œé–‰å‡ç´šä»‹é¢ä¸¦é‚„åŸèƒŒæ™¯ ---
function closeUpgradeUI() {
    const modal = document.getElementById('upgrade-modal');
    if (modal) modal.remove();
    
    const mainWrapper = document.querySelector('.main-wrapper');
    const stickyHeader = document.getElementById('game-sticky-header');
    
    if (mainWrapper) {
        mainWrapper.style.filter = "none";
        mainWrapper.style.pointerEvents = "auto";
    }
    if (stickyHeader) {
        stickyHeader.style.filter = "none";
    }
}

// --- ğŸ›¡ï¸ å…§éƒ¨å‡½æ•¸ï¼šç€•æ­»è‡ªå‹•å›åŸ ---
function checkEmergencyEscape() {
    // ç‰©ç†é–¥å€¼ï¼šè¡€é‡ä½æ–¼ 15% ä¸”ä¸åœ¨å®¶
    const healthThreshold = player.maxHp * 0.15;
    if (player.currentHp <= healthThreshold && currentMapDifficulty !== "Home") {
        showNotification("ğŸš¨ é«”åŠ›ä¸æ”¯ï¼å¼·åˆ¶å‚³é€å›æ­¸å®‰å…¨å€ï¼");
        if (typeof travelTo === 'function') {
            travelTo("Home"); 
        }
    }
}


// è§£æ±º Refresh ç™»å…¥æ¶ˆå¤±ï¼šåœ¨ gapi åˆå§‹åŒ–å¾Œè‡ªå‹•æª¢æŸ¥ç‹€æ…‹
async function checkLoginStatus() {
    const authInstance = gapi.auth2.getAuthInstance();
    if (authInstance.isSignedIn.get()) {
        console.log("â˜ï¸ é›²ç«¯å·²é€£ç·šï¼Œæ­£åœ¨æå–å‹‡è€…å­˜æª”...");
        await loadGameFromCloud(); // è®€å–é›²ç«¯ JSON ä¸¦è¦†è“‹æœ¬åœ° player ç‰©ä»¶
        updatePlayerUI();
    }
}



// --- 1. çµ±ä¸€åˆå§‹åŒ–å…¥å£ ---
async function onGapiLoaded() {
    console.log("ğŸš€ Google API å·²å°±ç·’ï¼Œå•Ÿå‹•å‹‡è€…ç³»çµ±...");
    
    // æª¢æŸ¥ç™»å…¥ç‹€æ…‹
    const authInstance = gapi.auth2.getAuthInstance();
    
    if (authInstance.isSignedIn.get()) {
        console.log("ğŸ‘¤ æª¢æ¸¬åˆ°ç™»å…¥ï¼Œæ­£åœ¨å¾é›²ç«¯è¼‰å…¥é€²åº¦...");
        await loadGameFromCloud(); // ç‰©ç†è®€å–é›²ç«¯å­˜æª”
    } else {
        console.log("ğŸ‘‹ æœªç™»å…¥ï¼Œå˜—è©¦å¾æœ¬åœ°ç·©å­˜æ¢å¾©...");
        const localData = localStorage.getItem('tabi_rpg_backup');
        if (localData) {
            player = JSON.parse(localData);
            updatePlayerUI();
        }
    }
    
    // å•Ÿå‹•è¦–è¦ºç³»çµ±
    startHeroAnimation(); 
    updatePlayerUI();
}


/**
 * â˜ï¸ é›²ç«¯é˜²ç¦¦æ¨¡çµ„ï¼šå…¨é‡ç‰©ç†å‚™ä»½ (V5.9.42 å®Œæ•´ç‰ˆ)
 * ä½œç”¨ï¼šå°‡æœ¬åœ°æ‰€æœ‰æ•¸æ“š (å«åäººå ‚) ä¸Šå‚³è‡³ Google Drive
 */
async function saveGameToCloud() {
    // 0. ç‰©ç†å®‰å…¨é–€è¡›
    if (!window.gapi || !gapi.client || !gapi.client.drive) {
        console.warn("â˜ï¸ é›²ç«¯ API ç‰©ç†éˆè·¯æœªå°±ç·’ï¼Œå–æ¶ˆåŒæ­¥ã€‚");
        return;
    }

    const fileName = 'TabiSatori_RPG_Save.json';
    
    // 1. ğŸ”¥ ã€æ’ˆå–åäººå ‚ã€‘å¾ IndexedDB ç¨ç«‹è¡¨æ ¼è®€å–
    // é€™æ˜¯é›²ç«¯å‚™ä»½ç‰¹æœ‰çš„æ­¥é©Ÿ
    let hallOfFameData = [];
    try {
        hallOfFameData = await db.hallOfFame.toArray();
    } catch (e) {
        console.warn("åäººå ‚è®€å–å¤±æ•—ï¼Œå°‡ç•¥éæ­¤éƒ¨åˆ†å‚™ä»½", e);
    }

    // 2. ğŸ”¥ ã€ç‰©ç†æ•¸æ“šå°è£ã€‘å‘¼å«å¤§ä¸€çµ±å¼•æ“ç²å–æ ¸å¿ƒæ•¸æ“š
    const coreData = getUnifiedSavePayload();
    
    // 3. ğŸ“¦ åˆä½µæ•¸æ“šï¼šæ ¸å¿ƒæ•¸æ“š + åäººå ‚å‚™ä»½
    const fullPayload = {
        ...coreData,
        hallOfFameBackup: hallOfFameData
    };

    // åºåˆ—åŒ–
    const content = JSON.stringify(fullPayload);
    
    try {
        // 4. ç‰©ç†æª¢ç´¢ï¼šå®šä½é›²ç«¯æª”æ¡ˆ
        const list = await gapi.client.drive.files.list({
            q: `name = '${fileName}' and trashed = false`,
            fields: 'files(id)'
        });
        
        const fileId = (list.result.files && list.result.files.length > 0) ? list.result.files[0].id : null;
        
        // 5. ç‰©ç†å‚³è¼¸ï¼šæ§‹å»º Multipart è«‹æ±‚
        const boundary = '-------TabiSatoriSyncBound';
        const delimiter = "\r\n--" + boundary + "\r\n";
        const close_delim = "\r\n--" + boundary + "--";
        const metadata = { 'name': fileName, 'mimeType': 'application/json' };
        
        const multipartRequestBody =
            delimiter + 'Content-Type: application/json\r\n\r\n' + JSON.stringify(metadata) +
            delimiter + 'Content-Type: application/json\r\n\r\n' + content + close_delim;

        let requestPath = '/upload/drive/v3/files';
        let requestMethod = 'POST'; // é è¨­æ–°å¢

        if (fileId) {
            requestPath += '/' + fileId;
            requestMethod = 'PATCH'; // è‹¥å­˜åœ¨å‰‡æ›´æ–°
        }

        await gapi.client.request({
            'path': requestPath,
            'method': requestMethod,
            'params': {'uploadType': 'multipart'},
            'headers': {'Content-Type': 'multipart/related; boundary=' + boundary},
            'body': multipartRequestBody
        });

        // 6. è¦–è¦ºå›é¥‹ (è—è‰²é›²æœµ)
        const indicator = document.getElementById('save-indicator');
        if (indicator) {
            indicator.classList.remove('save-active');
            indicator.style.background = "#2980b9"; 
            indicator.innerText = "â˜ï¸";
            void indicator.offsetWidth; 
            indicator.classList.add('save-active');
        }

        console.log(`%câ˜ï¸ é›²ç«¯åŒæ­¥æˆåŠŸï¼šå«åäººå ‚ (${hallOfFameData.length} ç­†) èˆ‡ æ–°å±¬æ€§çµæ§‹ã€‚`, "color: #3498db; font-weight: bold;");

    } catch (err) {
        console.error("âŒ é›²ç«¯å­˜æª”ç‰©ç†å¤±æ•—:", err);
        // éŒ¯èª¤å›é¥‹ (ç°è‰²ç¦æ­¢)
        const indicator = document.getElementById('save-indicator');
        if (indicator) {
            indicator.style.background = "#95a5a6";
            indicator.innerText = "ğŸš«";
            indicator.classList.add('save-active');
        }
    }
}


/**
 * â˜ï¸ é›²ç«¯é˜²ç¦¦æ¨¡çµ„ï¼šå…¨é‡é‚„åŸ (å«åäººå ‚ã€è‚¡å¸‚èˆ‡æ–°æ©Ÿåˆ¶è£œå®Œ)
 * ä¿®æ­£ï¼š
 * 1. æ•¸æ“šè§£åŒ…ï¼šæå– hallOfFameBackup ä¸¦å¯«å› IndexedDB ç¨ç«‹è¡¨æ ¼ã€‚
 * 2. çµæ§‹é·ç§»ï¼šè‡ªå‹•ä¿®è£œ attributes èˆ‡ tacticalSlotsï¼Œé˜²æ­¢é‚„åŸå¾Œå´©æ½°ã€‚ [cite: 2026-02-06]
 * 3. ç‰©ç†åº§æ¨™ï¼šé‚„åŸå¾Œç«‹å³åŒæ­¥å…¨ç³»çµ± UIï¼Œç¢ºä¿é¡¯ç¤ºæ•¸æ“šå³æ™‚å°é½Šã€‚
 */
async function loadGameFromCloud() {
    // 0. ğŸ”¥ ã€ç‰©ç†å®‰å…¨é–€è¡›ã€‘
    if (!window.gapi || !gapi.client || !gapi.client.drive) {
        console.warn("â˜ï¸ GAPI Client æœªå°±ç·’ï¼Œå–æ¶ˆé‚„åŸã€‚");
        return;
    }
    
    try {
        const fileName = 'TabiSatori_RPG_Save.json';
        const list = await gapi.client.drive.files.list({
            q: `name = '${fileName}' and trashed = false`,
            fields: 'files(id)'
        });
        
        if (!list || !list.result.files || list.result.files.length === 0) {
            console.log("â„¹ï¸ é›²ç«¯ç„¡å­˜æª”ã€‚");
            return;
        }
        
        const fileId = list.result.files[0].id;
        const res = await gapi.client.drive.files.get({ fileId: fileId, alt: 'media' });
        
        let cloudData = res.result;
        if (typeof cloudData === 'string') {
            try { cloudData = JSON.parse(cloudData); } catch(e) { return; }
        }

        if (!cloudData || typeof cloudData !== 'object') return;

        // --- 1. ç‰©ç†ç‰ˆæœ¬æ¯”å° ---
        const localLastSave = Number(player.lastSave || 0);
        const cloudLastSave = Number(cloudData.lastSave || 0);
        const localLv = Number(player.lv || 1);
        const cloudLv = Number(cloudData.lv || 1);

        // é‚è¼¯ï¼šé›²ç«¯ç­‰ç´šæ›´é«˜ï¼Œæˆ–è€…ç­‰ç´šç›¸åŒä½†å­˜æª”æ™‚é–“æ›´æ™š
        const isCloudNewer = (cloudLv > localLv) || (cloudLv === localLv && cloudLastSave > localLastSave);

        if (isCloudNewer) {
            console.log(`%cğŸ”„ é›²ç«¯æ•¸æ“šè¼ƒæ–° (${new Date(cloudLastSave).toLocaleString()})ï¼Œå•Ÿå‹•å…¨é‡ç‰©ç†é‚„åŸ...`, "color: #f1c40f; font-weight: bold;");
            
            // A. ğŸ”¥ ã€æ ¸å¿ƒå±¬æ€§èˆ‡çµæ§‹é‚„åŸã€‘ [cite: 2026-02-06]
            // ç›´æ¥è¦†è“‹ Player æœ¬é«”ï¼Œä¸¦é‡å°ç¼ºå¤±æ¬„ä½åŸ·è¡Œç‰©ç†è£œå®Œ
            player = {
                ...player,
                ...cloudData,
                lastSave: cloudLastSave
            };

            // ğŸ”¥ ã€Schema ç‰©ç†ä¿®æ­£ã€‘é˜²æ­¢é‚„åŸèˆŠç‰ˆæ•¸æ“šåŒ…å°è‡´æ–°æ©Ÿåˆ¶å ±éŒ¯
            if (!player.attributes) player.attributes = { str: 0, sta: 0, agi: 0, int: 0, block: 0, eva: 0, p_eva: 0 };
            if (!player.tacticalSlots) player.tacticalSlots = ['hp_pot', 'antidote', 'stimulant'];
            if (!player.equips) player.equips = {};

            // B. æ¢å¾©è£å‚™æ§½ (é˜²å‘†åˆå§‹åŒ–)
            const defaultSlots = ['head','body','legs','boots','gloves','necklace','weapon','offhand','ring1','ring2','rune1','rune2','rune3','rune4','rune5'];
            defaultSlots.forEach(s => {
                if (typeof player.equips[s] === 'undefined') player.equips[s] = null;
            });

            // C. æ¢å¾©ç‹åœ‹å»ºè¨­ (è¨­æ–½ç­‰ç´š)
            if (cloudData.kingdomSystem) {
                window.kingdomSystem = JSON.parse(JSON.stringify(cloudData.kingdomSystem));
            }

            // D. æ¢å¾©è‚¡å¸‚ (é‚„åŸ K ç·šæ­·å²)
            if (cloudData.kingdomStocks && Array.isArray(cloudData.kingdomStocks)) {
                window.kingdomStocks = JSON.parse(JSON.stringify(cloudData.kingdomStocks));
                console.log("âœ… è‚¡å¸‚ç‰©ç†éˆè·¯å·²é‚„åŸ");
            }

            // E. ğŸ”¥ ã€é—œéµä¿®æ­£ï¼šæ¢å¾©åäººå ‚ (Hall of Fame)ã€‘
            if (cloudData.hallOfFameBackup && Array.isArray(cloudData.hallOfFameBackup)) {
                try {
                    await db.hallOfFame.clear(); // æ¸…ç†æœ¬åœ°èˆŠè¡¨
                    await db.hallOfFame.bulkAdd(cloudData.hallOfFameBackup); // å¯«å…¥é›²ç«¯åŒ…
                    console.log(`âœ… åäººå ‚ç´€éŒ„å·²ç‰©ç†åŒæ­¥ (${cloudData.hallOfFameBackup.length} ç­†)`);
                } catch (hofErr) { console.error("åäººå ‚é‚„åŸå¤±æ•—:", hofErr); }
            }

            // F. ç‰©ç†é«”å¾µæ ¡æº– [cite: 2026-01-21]
            player.maxHp = 50 + (player.lv * 10);
            if (typeof player.currentHp !== 'number' || player.currentHp > player.maxHp) {
                player.currentHp = player.maxHp;
            }

            // G. ğŸ”¥ ã€å…¨ç³»çµ±ç‰©ç†å­˜æª”èˆ‡é‡ç¹ªã€‘
            // ç«‹å³å¯«å…¥ IndexedDBï¼Œç¢ºä¿é‚„åŸå¾Œé‡æ•´ç¶²é è³‡æ–™ä¾ç„¶å­˜åœ¨
            if (typeof savePlayerToDB === 'function') await savePlayerToDB();
            
            // åŒæ­¥å…¨ç’°å¢ƒ UI [cite: 2026-01-19]
            if (typeof updatePlayerUI === 'function') updatePlayerUI();
            if (typeof renderSidebarModules === 'function') renderSidebarModules();
            if (typeof renderAdventureLog === 'function') renderAdventureLog();
            
            // æ›´æ–°è¦–çª— (è‹¥é–‹å•Ÿä¸­)
            if (document.getElementById('adventure-map-popup')?.style.display === 'flex') {
                if (typeof renderAdventureMap === 'function') renderAdventureMap();
            }
            if (document.getElementById('financial-modal')) {
                if (typeof renderStockContent === 'function') renderStockContent();
            }

            console.log("%câœ… å…¨ç³»çµ±ç‰©ç†é‚„åŸé”æˆã€‚", "color: #2ecc71; font-weight: bold;");
            if (typeof showNotification === 'function') showNotification("â˜ï¸ é›²ç«¯æ•¸æ“šå·²æˆåŠŸè¦†è“‹æœ¬åœ°å­˜æª”ï¼");

        } else {
            console.log(`%câ„¹ï¸ æœ¬åœ°å­˜æª”è¼ƒæ–°ï¼Œç¶­æŒç•¶å‰é€²åº¦ã€‚`, "color: #3498db;");
            // åå‘å‚™ä»½ï¼šè‹¥æœ¬åœ°æ˜é¡¯è¼ƒæ–°ï¼Œè‡ªå‹•æ¨é€åˆ°é›²ç«¯åŸ·è¡Œç‰©ç†å‚™ä»½
            if (localLastSave > cloudLastSave + 5000) {
                if (typeof saveGameToCloud === 'function') saveGameToCloud();
            }
        }
    } catch (e) {
        console.error("âŒ é›²ç«¯é‚„åŸç™¼ç”Ÿç‰©ç†æ•…éšœ:", e);
        if (typeof showNotification === 'function') showNotification("âš ï¸ é›²ç«¯è®€å–å¤±æ•—ï¼Œç¶­æŒæœ¬åœ°æ¨¡å¼ã€‚");
    }
}

function startAdventureAnimation() {
    const hero = document.getElementById('hero-sprite');
    const enemy = document.getElementById('enemy-sprite');

    setInterval(() => {
        if (Math.random() > 0.7) { // 30% æ©Ÿç‡é‡æ•µ
            // æ€ªç‰©å‡ºç¾
            enemy.style.transition = "2s linear";
            enemy.style.right = "25%";
            
            setTimeout(() => {
                // é€²å…¥æˆ°é¬¥ç‹€æ…‹
                hero.innerText = "âš”ï¸";
                hero.classList.add('battle-shake');
                enemy.classList.add('battle-shake');
                
                setTimeout(() => {
                    // æˆ°é¬¥å‹åˆ©
                    hero.classList.remove('battle-shake');
                    enemy.classList.remove('battle-shake');
                    enemy.innerText = "ğŸ’¥";
                    setTimeout(() => {
                        enemy.style.transition = "none";
                        enemy.style.right = "-50px";
                        enemy.innerText = ["ğŸ‘¾", "ğŸ‰", "ğŸ‘¹", "ğŸ‘»"][Math.floor(Math.random()*4)];
                        hero.innerText = "ğŸš¶";
                    }, 500);
                }, 1500);
            }, 2000);
        }
    }, 10000);
}

// æ‰è½è£å‚™é‚è¼¯
function dropEquipment(quality) {
    const normalLoot = ["ğŸ–‹ï¸ æ™®é€šçš„åŸå­ç­†", "ğŸ“” ä¹¾æ·¨çš„ç­†è¨˜æœ¬", "ğŸ©¹ ç²¾ç¥è† å¸¶"];
    const highLoot = ["ğŸ”¥ è–åŠï¼šæ—¥æª¢ä¸€æ–‡å­—", "ğŸ‘‘ è³¢è€…ä¹‹å† ", "ğŸ’ éˆé­‚ç¿»è­¯æ©Ÿ"];
    
    const pool = (quality === "high") ? highLoot : normalLoot;
    const lootName = pool[Math.floor(Math.random() * pool.length)];
    
    player.inventory.push(lootName);
    
    const dropMsg = document.createElement('div');
    dropMsg.className = "game-notify drop-item";
    dropMsg.innerHTML = `ğŸ ç²å¾—è£å‚™ï¼šã€${lootName}ã€‘ï¼`;
    document.body.appendChild(dropMsg);
    setTimeout(() => dropMsg.remove(), 2500);
}

// åœ¨ç‹€æ…‹åˆ—å¢åŠ ä¸€å€‹æŒ‰éˆ•ä¾†é–‹å•Ÿæ—¥èªŒ
    function addLogBtn() {
        const btn = document.createElement('div');
        btn.innerHTML = "ğŸ“œ æ—¥èªŒ";
        btn.onclick = toggleLog;
        btn.style = "cursor:pointer; background:#34495e; padding:5px 10px; border-radius:4px; font-size:12px; margin-left:5px;";
        document.getElementById('player-status-bar').appendChild(btn);
    }

/**
 * ğŸ¨ æ ¸å¿ƒæ¸²æŸ“å¼•æ“ï¼šä¸»æ§å° (åˆ†æµè™•ç†)
 */
function displayContent(target) {
    if (!target) return;

    // 1. æ¸²æŸ“æ–‡ç« é ­éƒ¨èˆ‡å…§æ–‡
    renderArticle(target);

    // 2. æ¸²æŸ“å–®å­—å¡ (Vocab)
    renderVocabulary(target);

    // 3. æ¸²æŸ“ç‰‡èªåˆ— (Phrases)
    renderPhrases(target);

    // 4. æ¸²æŸ“æ¸¬é©—å€ (Exam) - V4 æŒ‰éˆ•äº’å‹•ç‰ˆ
    renderQuizSection(target);

    // 5. ç‰©ç†å¹³æ»‘ç½®é ‚
    window.scrollTo({ top: 0, behavior: 'smooth' });
}


function renderVocabulary(target) {
    const vDisplay = document.getElementById('vocab-display');
    if (!vDisplay) return;

    vDisplay.innerHTML = '';
    
    if (target.vocab && target.vocab.length > 0) {
        target.vocab.forEach(v => {
            const card = document.createElement('div');
            card.className = 'vocab-card';
            card.style.lineHeight = "2.4";
            card.style.overflow = "visible"; 

            card.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:center; border-bottom: 1px solid #eee; padding-bottom: 5px; margin-bottom: 8px;">
                    <strong style="font-size: 1.2em;">${v.w}</strong> 
                    <span style="font-size:12px; color:var(--nhk-green); cursor:pointer;">é»æ“Šç™¼éŸ³ ğŸ”Š</span>
                </div>
                <div style="font-size:14px; color:#333; margin:8px 0; background: #fcfcfc; padding: 4px;">${v.m}</div>
                <div class="example-text" style="line-height: 2.2;">â‘  ${v.e1}</div>
                <div class="example-text" style="line-height: 2.2;">â‘¡ ${v.e2}</div>
            `;
            
            card.onclick = () => {
                // ç‰©ç†æ¸…æ´—ï¼šç§»é™¤ Ruby æ¨™ç±¤ä»¥ä¾›æœ—è®€
                const cleanHTML = (str) => {
                    const temp = document.createElement("div");
                    temp.innerHTML = str;
                    temp.querySelectorAll("rt").forEach(rt => rt.remove());
                    return temp.innerText;
                };
                speakRawText(`${cleanHTML(v.w)}ã€‚æ„å‘³ï¼š${v.m}ã€‚ä¾‹å¥ä¸€ï¼š${cleanHTML(v.e1)}ã€‚ä¾‹å¥äºŒï¼š${cleanHTML(v.e2)}`);
            };
            vDisplay.appendChild(card);
        });
    }
}


function renderPhrases(target) {
    const pDisplay = document.getElementById('phrase-display');
    const pList = document.getElementById('phrase-list');
    
    if (!pList || !pDisplay) return;

    if (target.phrases && target.phrases.length > 0) {
        pDisplay.style.display = 'block';
        pList.innerHTML = target.phrases.map(p => {
            const cleanJP = p.jp.replace(/<rt>.*?<\/rt>|<[^>]+>/g, "");
            return `
                <div class="phrase-item" onclick="speakRawText('${cleanJP}')" style="cursor:pointer; padding: 8px 0; border-bottom: 1px dotted #ccc; line-height: 2.4;">
                    <strong>â— ${p.jp}</strong>ï¼š${p.ch} <span style="font-size:12px;">ğŸ”Š</span>
                </div>
            `;
        }).join('');
    } else {
        pDisplay.style.display = 'none';
    }
}


function renderQuizSection(target) {
    const quizSection = document.getElementById('quiz-section');
    const quizContainer = document.getElementById('quiz-container');
    const submitBtn = document.getElementById('submit-quiz');

    if (!quizContainer) return;

    // 1. åˆå§‹åŒ–å…¨åŸŸæ¸¬é©—ç‹€æ…‹
    window.currentQuizState = {
        answers: [],    // æ­£ç¢ºç­”æ¡ˆç´¢å¼•
        userSelect: {}  // ä½¿ç”¨è€…é¸æ“‡ { é¡Œç›®Index: é¸é …Index }
    };

    if (target.exam && target.exam.length > 0) {
        quizSection.style.display = 'block';
        submitBtn.style.display = 'block';
        
        // é‡ç½®æŒ‰éˆ•ç‹€æ…‹
        submitBtn.disabled = false;
        submitBtn.innerText = "æäº¤ç­”æ¡ˆ (ç­”ãˆã‚’å‡ºã™)";
        submitBtn.style.opacity = "1";
        submitBtn.style.cursor = "pointer";
        submitBtn.style.background = "var(--accent-orange)"; // æ¢å¾©æ©˜è‰²

        quizContainer.innerHTML = ''; 

        target.exam.forEach((item, index) => {
            const qDiv = document.createElement('div');
            // ä½¿ç”¨å…§è¯æ¨£å¼æ¨¡æ“¬ .quiz-card-v4 (äº¦å¯ç›´æ¥ç”¨ class)
            qDiv.style = "background: #fff; border: 1px solid #e0e0e0; border-radius: 12px; padding: 20px; margin-bottom: 25px; box-shadow: 0 4px 10px rgba(0,0,0,0.03); position: relative; overflow: hidden;";
            qDiv.id = `quiz-block-${index}`;
            
            const typeLabel = { 'vocab': 'ã€èªå½™ã€‘', 'grammar': 'ã€æ–‡æ³•ã€‘', 'reading': 'ã€è®€è§£ã€‘' };
            
            qDiv.innerHTML = `
                <div style="font-size: 18px; font-weight: bold; color: #2c3e50; margin-bottom: 15px; line-height: 1.6; border-left: 4px solid #f39800; padding-left: 12px;">
                    ${typeLabel[item.type] || ''} Q${index + 1}. ${item.q}
                </div>
                <div id="options-group-${index}" style="display: grid; gap: 10px;">
                    ${item.o.map((opt, i) => `
                        <button class="quiz-opt-btn" onclick="selectQuizOption(${index}, ${i})" 
                                style="width: 100%; text-align: left; background: #fcfcfc; border: 2px solid #eee; padding: 12px 15px; border-radius: 8px; font-size: 16px; color: #555; cursor: pointer; transition: 0.2s; position: relative;">
                            <span style="margin-right:8px; opacity:0.6;">${['A','B','C','D'][i]}.</span>
                            ${opt}
                        </button>
                    `).join('')}
                </div>
                <div id="explain-${index}" style="margin-top: 15px; padding: 15px; background: #f0f7ff; border-left: 4px solid #3498db; border-radius: 4px; font-size: 14px; color: #2c3e50; line-height: 1.6; display: none;">
                    <strong style="color:#2980b9;">ğŸ’¡ ç‰©ç†è§£æï¼š</strong><br>${item.explain || 'æœ¬é¡Œè€ƒé©—èªæ³•é‚è¼¯èˆ‡è©å½™é‹ç”¨ã€‚'}
                </div>
            `;
            quizContainer.appendChild(qDiv);
        });

        // ç‰©ç†é–å®šï¼šå°‡æ­£ç¢ºç­”æ¡ˆå­˜å…¥è¨˜æ†¶é«”
        window.currentQuizState.answers = target.exam.map(item => Number(item.a)); 
    } else {
        quizSection.style.display = 'none';
    }
}



/**
 * ğŸ–±ï¸ æ¸¬é©—äº’å‹•ï¼šé¸æ“‡é¸é … (è¦–è¦ºåˆ‡æ›)
 * ä¿®æ­£ï¼šç¢ºä¿ currentQuizState å­˜åœ¨ï¼Œä¸¦æ­£ç¢ºåˆ‡æ› CSS class
 */
function selectQuizOption(qIdx, optIdx) {
    // 1. åˆå§‹åŒ–ç‹€æ…‹ (é˜²æ­¢å ±éŒ¯)
    if (!window.currentQuizState) {
        window.currentQuizState = { userSelect: {}, answers: [] };
    }
    
    // 2. è¨˜éŒ„é¸æ“‡
    window.currentQuizState.userSelect[qIdx] = optIdx;

    // 3. æ›´æ–°è¦–è¦º (å–®é¸é‚è¼¯)
    const group = document.getElementById(`options-group-${qIdx}`);
    if (group) {
        const btns = group.querySelectorAll('.quiz-opt-btn');
        btns.forEach((btn, idx) => {
            // ç§»é™¤èˆŠç‹€æ…‹
            btn.classList.remove('selected');
            
            // ç‚ºç•¶å‰é»æ“Šçš„æŒ‰éˆ•åŠ ä¸Šé¸ä¸­ç‹€æ…‹
            if (idx === optIdx) {
                btn.classList.add('selected');
            }
        });
    }
}

/**
 * âš”ï¸ æ ¸å¿ƒï¼šæ¸¬é©—æ ¸å°èˆ‡çå‹µå›æµç³»çµ±
 * ä¿®æ­£ï¼šå°å…¥è‡ªå‹•å€åŸŸåŒæ­¥ã€é€£æ“ŠåŠ æˆèˆ‡æ•¸æ“šæºé–å®š
 */
function checkQuiz() {
    // 1. ğŸ”¥ ã€ç‰©ç†æºé–å®šã€‘
    const state = window.currentQuizState;
    const pack = window.currentActivePack; // å„ªå…ˆä½¿ç”¨è¨˜æ†¶é«”ä¸­çš„æ•¸æ“šåŒ…
    if (!state || !state.answers) {
        showNotification("âš ï¸ æ¸¬é©—æ•¸æ“šå°šæœªå°±ç·’");
        return;
    }

    let score = 0;
    const total = state.answers.length;
    const submitBtn = document.getElementById('submit-quiz');
    
    // ç‰©ç†æå– Boss åç¨± (ç§»é™¤æ¨™ç±¤å¹²æ“¾)
    const bossName = pack ? pack.name.replace(/<[^>]+>/g, '') : "æœªçŸ¥è©¦ç…‰";

    // 2. ğŸ”¥ ã€ç‰©ç†å†·å»ã€‘é˜²æ­¢é‡è¤‡é»ç«
    if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.classList.add('btn-locked');
        submitBtn.innerText = "ğŸ“œ æˆ°æœçµ±è¨ˆä¸­...";
    }

    const inv = (typeof player !== 'undefined' && player.inventory) ? player.inventory : [];
    const hasScepter = inv.includes("ğŸ’€ å¯©åˆ¤è€…çš„è¡€è…¥æ¬Šæ–");
    const hasBlade = inv.includes("ğŸ—¡ï¸ çµ±æ²»è€…ä¹‹é‹’");

    // 3. ğŸ”¥ ã€ä¸¦è¡Œåˆ¤å®šã€‘è¦–è¦ºæ¨™è¨»èˆ‡æ•¸å€¼è¨ˆç®—
    state.answers.forEach((correctIdx, qIdx) => {
        const userIdx = state.userSelect[qIdx];
        const group = document.getElementById(`options-group-${qIdx}`);
        const explainDiv = document.getElementById(`explain-${qIdx}`);
        
        if (explainDiv) explainDiv.style.display = "block";

        if (group) {
            const btns = group.querySelectorAll('.quiz-opt-btn');
            
            // æ¨™è¨»æ­£ç¢ºé …
            if (btns[correctIdx]) {
                btns[correctIdx].classList.add('correct');
                if (!btns[correctIdx].innerHTML.includes('âœ…')) btns[correctIdx].innerHTML += ' âœ…';
            }

            // æ¨™è¨»éŒ¯èª¤é …èˆ‡æ•¸å€¼ç´¯åŠ 
            if (userIdx !== undefined && userIdx !== null) {
                if (Number(userIdx) === Number(correctIdx)) {
                    score++;
                    // ğŸ©¸ æ¬Šæ–ç‰©ç†å¸è¡€
                    if (hasScepter && typeof player !== 'undefined') {
                        const heal = Math.floor(player.maxHp * 0.05);
                        player.currentHp = Math.min(player.maxHp, player.currentHp + heal);
                    }
                } else {
                    if (btns[userIdx]) {
                        btns[userIdx].classList.add('wrong');
                        if (!btns[userIdx].innerHTML.includes('âŒ')) btns[userIdx].innerHTML += ' âŒ';
                    }
                }
            }

            // ç‰©ç†å›æ”¶ï¼šé–å®šäº¤äº’
            btns.forEach(btn => {
                btn.onclick = null;
                btn.style.pointerEvents = "none";
            });
        }
    });

    // --- 4. ğŸ® ç‰©ç†äº‹ä»¶éˆï¼šçå‹µèˆ‡é€²åº¦å›æµ ---
    
    // A. è§¸ç™¼æ”»æ“Šå‹•ç•«
    if (score > 0 && typeof triggerHeroAttack === 'function') triggerHeroAttack();

    // B. ğŸ”¥ ã€è™•æ±ºåˆ¤å®šã€‘
    if (hasBlade && Math.random() < 0.10) {
        score = total;
        showNotification("ğŸ—¡ï¸ <b>ã€è™•æ±ºã€‘</b> çµ±æ²»è€…ä¹‹é‹’ç‰©ç†å…¨æ•¸æ“Šç ´ï¼");
    }

    // C. ğŸ”¥ ã€æ•¸æ“šå›æµã€‘RPG ç¶“æ¿Ÿçµç®—
    if (typeof battleReward === 'function') {
        // æ­¤è™•æ‡‰å‚³å…¥ score, total ä»¥ä¾¿ battleReward è¨ˆç®—ç¶“é©—èˆ‡é‡‘å¹£
        battleReward(score, total, bossName);
    }

    // D. ğŸ”¥ ã€é€²åº¦æ­¸ä¸€åŒ–ã€‘å€åŸŸæ¢ç´¢åº¦åŒæ­¥
    // å‡è¨­æ¯å€‹ Pack éƒ½æœ‰å°æ‡‰çš„åœ°ç† IDï¼Œåœ¨æ­¤è™•æ›´æ–°åœ°åœ–å®Œæˆåº¦
    if (pack && pack.difficulty && typeof updateRegionProgress === 'function') {
        updateRegionProgress(pack.difficulty, score / total);
    }

    // 5. æ•¸æ“šå­˜æª”é–å®š
    if (typeof updatePlayerUI === 'function') updatePlayerUI();
    if (typeof savePlayerToDB === 'function') savePlayerToDB();
    
    // 6. ç‰©ç†æ²å‹•èˆ‡é€šçŸ¥
    const quizSection = document.getElementById('quiz-section');
    if (quizSection) quizSection.scrollIntoView({ behavior: 'smooth', block: 'start' });

    showNotification(`ğŸ“Š æˆ°å ±ï¼š${bossName}<br>æ“Šç ´ç‡ï¼š${Math.floor((score/total)*100)}%`);
}

/**
 * ğŸ’œ ç‰©ç†ç‰¹æ•ˆï¼šæ¬Šæ–å°ˆå±¬æ‰“æ“Šæ¿¾é¡
 */
function triggerScepterVfx() {
    const screen = document.getElementById('adventure-screen');
    if (screen) {
        screen.style.transition = "none";
        // ç‰©ç†æ‰­è½‰è‰²èª¿è‡³ç´«è‰²ï¼Œå‘ˆç¾ã€Œå¯©åˆ¤ã€æ„Ÿ
        screen.style.filter = "hue-rotate(280deg) saturate(2) brightness(1.2)";
        setTimeout(() => {
            screen.style.transition = "filter 0.6s ease-out";
            screen.style.filter = "none";
        }, 400);
    }
}

/**
 * ğŸ® RPG çµç®—æ ¸å¿ƒé‚è¼¯ (Tabi-Satori V4 ç‰©ç†åŠ å›ºç‰ˆ)
 * ä¿®æ­£ï¼šå¼·åŒ–æ•¸å€¼æº¢å‡ºé˜²è­·ã€è‡ªå‹•å…Œæ›é‚è¼¯èˆ‡å†·ç†±å­˜æª”åŒæ­¥
 */
async function battleReward(score, total, bossName) {
    if (score === 0) return; 

    // 0. ğŸ”¥ ã€ç‰©ç†æºå®‰å…¨é–å®šã€‘
    const pack = window.currentActivePack || {};
    const effectiveBossName = bossName || pack.name || "æœªçŸ¥è©¦ç…‰";

    // --- ğŸ† 1. çå‹µå€ç‡èˆ‡ç‹€æ…‹æ ¡æº– ---
    let multiplier = 1;
    
    // A. æ¯æ—¥è³é‡‘åŠ æˆ [cite: 2026-01-19]
    if (typeof dailyQuest !== 'undefined' && dailyQuest.bonusActive) {
        multiplier *= 2;
        dailyQuest.bonusActive = false;
        if (typeof updateQuestUI === 'function') updateQuestUI();
    }

    // B. ç‰©ç†ç‹€æ…‹é€£å‹•ï¼šè¿·ç³Šç‹€æ…‹ (Dizzy) åŠ æˆ
    if (player.tempStatus === "dizzy") {
        multiplier *= 1.1;
        console.log("%cğŸ˜µâ€ğŸ’« æ½›æ„è­˜å…±é³´ï¼šEXP ç²å¾—é‡ x1.1", "color: #f1c40f;");
    }

    // --- ğŸ’° 2. ç¶“é©—å€¼èˆ‡é‡‘å¹£ç‰©ç†çµç®— ---
    let gainedExp = Math.floor(score * 20 * multiplier);
    let gainedCoin = score * 10;
    
    player.exp += gainedExp;
    player.coin += gainedCoin;

    // --- ğŸ†™ 3. å‡ç´šèˆ‡ç‰©ç†æˆé•·æ©Ÿåˆ¶ ---
    let levelUpCount = 0;
    // ç‰©ç†å¾ªç’°ï¼šè™•ç†è·¨ç­‰ç´šæå‡
    while (player.exp >= 100) {
        player.lv++;
        player.exp -= 100;
        levelUpCount++;
        
        // ã€ç‰©ç†æˆé•·ã€‘MaxHP éš¨ç­‰ç´šæ“´å¼µï¼Œä¸¦åŸ·è¡Œç‰©ç†æ»¿è¡€å›æ­¸ [cite: 2026-01-21]
        player.maxHp = 50 + (player.lv * 10);
        player.currentHp = player.maxHp; 
    }
    
    if (levelUpCount > 0) {
        if (typeof triggerLevelUpEffect === 'function') triggerLevelUpEffect();
        showNotification(`ğŸŠ <b style="color:#e67e22;">LEVEL UP!</b> ç›®å‰ LV.${player.lv}ï¼Œç‰©ç†æœ€å¤§ç”Ÿå‘½æå‡è‡³ ${player.maxHp}ï¼`);
    }

    // --- âœ¨ 4. å¹»å½±æ€ªèˆ‡å¹»å½±ä¹‹å¡µåˆ¤å®š ---
    let droppedLoot = "ç„¡";
    const isPhantom = effectiveBossName.includes("å¹»å½±") || 
                      effectiveBossName.includes("è™›ç©º") || 
                      (typeof battleData !== 'undefined' && battleData.monsterType === "phantom");

    if (isPhantom) {
        if (Math.random() < 0.7) {
            player.phantomDust = (player.phantomDust || 0) + 1;
            droppedLoot = "âœ¨ å¹»å½±ä¹‹å¡µ";
            
            // ç‰©ç†è‡ªå‹•å…Œæ›ï¼šæ¯ 10 å€‹ç²‰å¡µé‡é‘„ç‚ºé«˜ç´šæ­¦è£
            if (player.phantomDust >= 10) {
                player.phantomDust -= 10;
                const bonusGift = typeof dropEquipment === 'function' ? dropEquipment("high") : "å‚³èªªç´šè£å‚™";
                droppedLoot = `âœ¨ å¹»å½±ä¹‹å¡µ (10æšå…±é³´ï¼šç²å¾— ${bonusGift})`;
            }
        }
    }

    // --- ğŸ 5. ä¸€èˆ¬è£å‚™æ‰è½ç³»çµ± (ç‰©ç†å…¬å¼ç‰ˆ) ---
    if (droppedLoot === "ç„¡") {
        // A. è¨ˆç®—çµ‚æ¥µæ‰å¯¶ç‡ï¼šåŸºç¤ 30% + æ¥­è€…æŒ‡ç´‹åŠ æˆ [cite: 2026-01-21]
        const baseRate = 0.3;
        const bonusRate = typeof calculateDropRateBonus === 'function' ? calculateDropRateBonus() : 0;
        const finalRate = baseRate + bonusRate;

        if (score === total) {
            // å®Œç¾æ“Šç ´ï¼š100% ç‰©ç†æ‰è½é«˜å“è³ªæˆ°åˆ©å“
            droppedLoot = typeof dropEquipment === 'function' ? dropEquipment("high") : "å²è©©æ­¦è£"; 
        } 
        else if (score >= total / 2) {
            // åŠæ ¼åˆ¤å®šï¼šåŸ·è¡Œç‰©ç† Roll é»
            console.log(`ğŸ² RPGæ‰å¯¶ï¼šç›®æ¨™ < ${(finalRate*100).toFixed(1)}% (å«åŠ æˆ ${(bonusRate*100).toFixed(1)}%)`);
            if (Math.random() < finalRate) {
                droppedLoot = typeof dropEquipment === 'function' ? dropEquipment("normal") : "æ¨™æº–è£å‚™";
            }
        }
    }

    // --- ğŸ›¡ï¸ 6. ç‰©ç†å­˜æª”é–å®šèˆ‡å†·ç†±åˆ†é›¢ ---
    // å¼·åˆ¶æ³¨å…¥æœ€å¾Œå­˜æª”æŒ‡ç´‹ï¼Œé˜²æ­¢ F5 ç‰©ç†å›æº¯ [cite: 2026-01-21]
    player.lastSave = Date.now();

    if (typeof savePlayerToDB === 'function') {
        // ç‰©ç†é–å®šåˆ°æœ¬åœ° dbManager [cite: 2026-01-21]
        await savePlayerToDB(); 
    }
    
    // åŒæ­¥ç©å®¶ UI ç‹€æ…‹ [cite: 2026-01-19]
    if (typeof updatePlayerUI === 'function') updatePlayerUI();
    
    // --- ğŸ 7. å‹åˆ©å±•ç¤ºèˆ‡ç‹€æ…‹å›æ”¶ ---
    if (typeof showVictoryScreen === 'function') {
        showVictoryScreen(effectiveBossName, gainedExp, gainedCoin, droppedLoot);
    }

    // ç‰©ç†å›æ”¶éæœŸç‹€æ…‹ [cite: 2026-01-19]
    if (player.statusTimer !== undefined) {
        player.statusTimer--;
        if (player.statusTimer <= 0) {
            player.tempStatus = null;
        }
    }

    // --- â˜ï¸ 8. å…¨åŸŸåŒæ­¥ï¼šéåŒæ­¥é›²ç«¯å‚™ä»½ ---
    if (typeof saveGameToCloud === 'function') {
        saveGameToCloud(); // æ–¼èƒŒæ™¯åŸ·è¡Œï¼Œä¸å½±éŸ¿è·äººç´šæµæš¢é«”é©— [cite: 2026-01-19]
    }
}


/**
 * ğŸ ç‰©ç†å­ç¨‹åºï¼šå°å¼ˆçµæŸæ‰è½æ©Ÿåˆ¶ (V5.9.40 ä¿åº•é‡æ§‹ç‰ˆ)
 * ä¿®æ­£ï¼š
 * 1. ç‰©ç†ä¿åº•ï¼šç§»é™¤ç©ºæ‰‹å›æ­¸é‚è¼¯ï¼Œç¢ºä¿æ¯æ¬¡æˆ°é¬¥ 100% ç²å¾—ç‰©è³‡ã€‚
 * 2. é›™è»Œåˆ¤å®šï¼šæ‰å¯¶ç‡ç¾åœ¨æ±ºå®šçš„æ˜¯ã€Œç‰©è³‡çš„å“è³ªã€è€Œéã€Œæœ‰ç„¡ã€ã€‚
 * @param {boolean} isBerserk æ˜¯å¦è™•æ–¼ç‹‚æš´åœ‹ç‹æ¨¡å¼
 */
function triggerPokerLoot(isBerserk) {
    // 1. ğŸ”¥ ã€ç‰©ç†æ©Ÿç‡æ¼”ç®—ã€‘
    const bonusRate = typeof calculateDropRateBonus === 'function' ? calculateDropRateBonus() : 0;
    
    // åŸºç¤ã€Œé«˜å“è³ªã€æ©Ÿç‡ï¼šä¸€èˆ¬å±€ 15% / ç‹‚æš´å±€ 30% + è£å‚™åŠ æˆ
    const highTierBaseChance = isBerserk ? 0.30 : 0.15; 
    const highTierThreshold = highTierBaseChance + bonusRate;

    let lootName = "";
    const roll = Math.random(); // 0.0 ~ 1.0

    // --- âš–ï¸ æ©Ÿç‡åˆ†æµï¼šæ±ºå®šæ‰è½å±¤ç´š ---

    // A. ğŸŒŸ ã€é«˜éšæ‰è½è»Œé“ã€‘ (ç¥å™¨ / å·¨å¤§è£œè¡€ç½)
    if (roll < highTierThreshold) {
        // ç‹‚æš´æ¨¡å¼ä¸‹ï¼Œæœ‰é¡å¤– 25% æ©Ÿç‡éœ‡è½ç¥å™¨
        if (isBerserk && Math.random() < 0.25) { 
            const artifacts = ["ğŸ‘‘ è¡€è…¥ç‹æ¬Šç¢ç‰‡", "ğŸ’ åœ‹ç‹çš„è²ªå©ªä¹‹å¿ƒ", "ğŸ—¡ï¸ çµ±æ²»è€…ä¹‹é‹’", "ğŸ“œ ç¦å¿Œç¨…å¾‹å–®"];
            lootName = artifacts[Math.floor(Math.random() * artifacts.length)];
            
            // ç‰©ç†å…¥åº«ï¼šç¥å™¨é¡é€²å…¥ inventory
            if (!player.inventory.includes(lootName)) player.inventory.push(lootName);
            
            addBattleLog(`âœ¨ <b style="color:#9b59b6;">[å‚³å¥‡éœ‡ç›ª]</b> ç‹‚æš´çš„é¤˜æ³¢ä¸­ï¼Œä¸€ä»¶ç¥å™¨æ‰äº†å‡ºä¾†ï¼`);
        } else {
            // é«˜éšé†«ç™‚æœåˆ® (High Quality)
            lootName = executeMedicalScavenge(true);
            addBattleLog(`ğŸ <b style="color:#f1c40f;">[å¹¸é‹æœåˆ®]</b> é‹æ°£ä¸éŒ¯ï¼Œç™¼ç¾äº†é«˜å“è³ªç‰©è³‡ï¼`);
        }
    } 
    // B. ğŸ›¡ï¸ ã€ç‰©ç†ä¿åº•è»Œé“ã€‘ (æ™®é€šè—¥æ°´ / ç‹€æ…‹è—¥åŠ‘)
    else {
        // æ¨™æº–é†«ç™‚æœåˆ® (Standard Quality)
        lootName = executeMedicalScavenge(false);
        // åªæœ‰åœ¨éé€£çºŒæˆ°é¬¥æ™‚æ‰é¡¯ç¤ºä¿åº•è¨Šæ¯ï¼Œé¿å…æ´—é »
        // addBattleLog(`ğŸ“¦ <b style="color:#aaa;">[æˆ°å ´è£œçµ¦]</b> æ’¿åˆ°äº†åŸºç¤ç”Ÿå­˜ç‰©è³‡ã€‚`);
    }

    /**
     * å…§éƒ¨å­ç¨‹åºï¼šåŸ·è¡Œé†«ç™‚ç‰©è³‡åˆ†é… (æ¬Šé‡å‹•æ…‹èª¿æ•´ç‰ˆ)
     * ç‰©ç†æ˜ å°„è‡³ HUD ç‰©å“æ§½ä½ ID
     */
    function executeMedicalScavenge(isHighQuality) {
        const table = [
            // é«˜å“è³ªæ¨¡å¼ä¸‹ï¼Œå·¨å¤§è£œè¡€ç½æ¬Šé‡å¤§å¹…æå‡
            { id: 'hp_pot',    name: 'ğŸº å·¨å¤§è£œè¡€ç½', weight: isHighQuality ? 50 : 5 },
            // ä¿åº•æ¨¡å¼ä¸‹ï¼Œæ™®é€šè—¥æ°´æ¬Šé‡æœ€é«˜
            { id: 'potion',    name: 'ğŸ§´ è£œè¡€è—¥æ°´',   weight: isHighQuality ? 20 : 60 },
            // åŠŸèƒ½æ€§è—¥åŠ‘æ¬Šé‡
            { id: 'antidote',  name: 'ğŸ§ª ç‰¹æ•ˆè§£æ¯’è—¥', weight: isHighQuality ? 10 : 15 },
            { id: 'hemostat',  name: 'ğŸ©¹ æ­¢è¡€åŠ‘',     weight: isHighQuality ? 10 : 15 },
            { id: 'stimulant', name: 'ğŸ’‰ èˆˆå¥®åŠ‘',     weight: isHighQuality ? 10 : 5 }
        ];

        // æ¬Šé‡éš¨æ©Ÿæ¼”ç®—
        const totalWeight = table.reduce((sum, item) => sum + item.weight, 0);
        let randomWeight = Math.random() * totalWeight;
        
        let picked = table[0];
        for (const item of table) {
            if (randomWeight < item.weight) {
                picked = item;
                break;
            }
            randomWeight -= item.weight;
        }

        // ğŸ§ª ã€æ•¸æ“šç‰©ç†å¯«å…¥ã€‘å¯«å…¥ player.items ä»¥ä¾› HUD é¡¯ç¤ºæ•¸é‡
        player.items = player.items || {};
        player.items[picked.id] = (Number(player.items[picked.id]) || 0) + 1;
        
        return picked.name;
    }

    // ğŸ“¢ ç‰©ç†é€£å‹•ï¼šæ›´æ–°æ—¥èªŒèˆ‡è¦–è¦ºç‰¹æ•ˆ [cite: 2026-01-19]
    if (lootName) {
        // è‹¥ä¸æ˜¯ç¥å™¨(å‰é¢å·²log)ï¼Œå‰‡é¡¯ç¤ºé€šç”¨æœåˆ®è¨Šæ¯
        if (!lootName.includes("ç¢ç‰‡") && !lootName.includes("ä¹‹å¿ƒ") && !lootName.includes("ä¹‹é‹’") && !lootName.includes("ç¨…å¾‹å–®")) {
            // é€™è£¡å¯ä»¥é¸æ“‡æ˜¯å¦è¦é¡¯ç¤ºæ—¥èªŒï¼Œæˆ–è€…åªä¾è³´é€šçŸ¥
             addBattleLog(`ğŸ <b style="color:#2ecc71;">[æœåˆ®]</b> ç²å¾—æˆ°åˆ©å“ï¼šã€${lootName}ã€‘`);
        }

        // è§¸ç™¼ HUD ç‰©ç†ç¸®æ”¾ç‰¹æ•ˆ (è¦–è¦ºå›é¥‹)
        if (typeof triggerItemGetVfx === 'function') triggerItemGetVfx();
    }
    
    return lootName;
}


// ğŸŠ å‡ç´šç‰¹æ•ˆ
function triggerLevelUpEffect() {
    const lvUpMsg = document.createElement('div');
    lvUpMsg.className = "game-notify level-up";
    lvUpMsg.style = "position:fixed; top:20%; left:50%; transform:translateX(-50%); background:#f1c40f; color:#000; padding:20px; border-radius:10px; z-index:9999; font-weight:bold; box-shadow:0 0 20px gold;";
    lvUpMsg.innerHTML = `ğŸŠ LEVEL UP! ç›®å‰ç­‰ç´š: LV.${player.lv}`;
    document.body.appendChild(lvUpMsg);
    setTimeout(() => lvUpMsg.remove(), 3000);
}

// è¼”åŠ©å‡½å¼ï¼šå„ªåŒ–è®Šè‰²æ¨£å¼
function questionBlockStyle(el, border, bg) {
    el.style.borderColor = border;
    el.style.background = bg;
    el.style.borderWidth = "2px";
    el.style.borderStyle = "solid";
}

/**
 * ğŸ“œ ç‰©ç†å­ç¨‹åºï¼šæ¸²æŸ“å‹‡è€…å†’éšªæ—¥èªŒ (é˜²ç¦¦å¼·åŒ–èˆ‡å±¬æ€§æ ¡æº–ç‰ˆ)
 * ä¿®æ­£ï¼šè§£æ±º boss æˆ– loot å±¬æ€§ç¼ºå¤±å°è‡´çš„ includes å´©æ½°å•é¡Œ
 */
function renderAdventureLog() {
    const logContainer = document.getElementById('log-list');
    if (!logContainer) return;

    // 1. ğŸ”¥ ã€ç‰©ç†é ‚æ¬„ã€‘é¡¯ç¤ºæ­·å²å·”å³°æ•¸æ“š
    const headerHTML = `
        <div style="background: rgba(241,196,15,0.1); border: 1px solid #f1c40f; padding: 12px; border-radius: 8px; margin-bottom: 20px; text-align: center;">
            <span style="color: #8b4513; font-size: 11px; font-weight: bold; letter-spacing: 2px;">ğŸ… å‚³å¥‡æˆå°±ç¢‘æ–‡</span><br>
            <b style="color: #f1c40f; font-size: 18px; text-shadow: 0 0 5px orange;">æ­·å²æœ€é«˜ï¼š${player.maxKingStreak || 0} é€£èŠ</b>
        </div>
    `;

    // 2. ğŸ”¥ ã€ç‰©ç†æ¸…å–®ã€‘éæ­·æ—¥èªŒæ•¸æ“šä¸¦åŸ·è¡Œå‹•æ…‹æ¸²æŸ“
    // ğŸ’¡ ä¿®æ­£é»ï¼šåŠ ä¸Š player.logs çš„ null åˆ¤å®š
    const listHTML = (player.logs && player.logs.length > 0) ? player.logs.map(log => {
        
        // ğŸ›¡ï¸ ã€é—œéµé˜²ç¦¦ã€‘ç‰©ç†æª¢ç´¢å±¬æ€§æ˜¯å¦å­˜åœ¨ï¼Œè‹¥ç„¡å‰‡è³¦äºˆå®‰å…¨é è¨­å€¼
        const safeBoss = log.boss || "æœªçŸ¥å†’éšª";
        const safeLoot = log.loot || "ç„¡æ‰è½ç‰©";
        const safeScore = log.score || "N/A";
        const safeDate = log.date || "---";
        const safeLv = log.currentLv || player.lv;

        // åµæ¸¬æ˜¯å¦ç‚ºåœ‹ç‹æˆ°æœ (ä½¿ç”¨å®‰å…¨è®Šæ•¸åŸ·è¡Œåˆ¤å®š)
        const isLegendary = safeBoss.includes("é€£èŠ") || safeLoot.includes("ğŸ‘‘") || safeLoot.includes("ğŸ’€");
        const logBg = isLegendary ? 'linear-gradient(90deg, #fffcf0 0%, #fff 100%)' : '#fff';
        const borderColor = isLegendary ? '#f1c40f' : '#eee';

        // è™•ç†çµæœæ¨™ç±¤ç‰©ç†åŒ–
        const scoreColor = (safeScore.includes("100%") || safeScore.includes("å‹åˆ©")) ? "#27ae60" : "#c0392b";

        return `
            <div style="border-bottom: 2px solid ${borderColor}; padding: 15px 10px; background: ${logBg}; transition: 0.3s; position: relative; overflow: hidden; margin-bottom: 5px; border-radius: 4px;">
                ${isLegendary ? `<div style="position:absolute; top:5px; right:-20px; background:#f1c40f; color:#000; font-size:9px; padding:2px 25px; transform:rotate(45deg); font-weight:bold; box-shadow:0 0 10px rgba(0,0,0,0.1);">LEGEND</div>` : ''}
                
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                    <div style="color: #95a5a6; font-size: 11px; font-family: monospace;">ğŸ“… ${safeDate} | <span style="color:#3498db;">LV.${safeLv}</span></div>
                </div>

                <div style="font-weight: bold; color: #2c3e50; font-size: 15px; margin-bottom: 8px;">
                    âš”ï¸ è¨ä¼ï¼š<span style="${isLegendary ? 'color:#d35400; text-shadow: 0 0 1px #f1c40f;' : ''}">${safeBoss}</span>
                </div>

                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <span style="background: #f8f9fa; border: 1px solid #ddd; padding: 2px 8px; border-radius: 4px; font-size: 11px; color: ${scoreColor};">
                        ğŸ“Š çµæœï¼š<b>${safeScore}</b>
                    </span>
                    <span style="background: #fdfaf0; border: 1px solid #f1c40f; padding: 2px 8px; border-radius: 4px; font-size: 11px; color: #b7950b;">
                        ğŸ ç²å¾—ï¼š<b>${safeLoot}</b>
                    </span>
                </div>
                
                ${log.details ? `<div style="margin-top:8px; font-size:11px; color:#7f8c8d; font-style:italic;">ğŸ“ å‚™è¨»ï¼š${log.details}</div>` : ''}
            </div>
        `;
    }).reverse().join('') : '<p style="text-align:center; color:#ccc; padding:30px;">å°šç„¡ä»»ä½•å†’éšªè¶³è·¡...</p>';

    logContainer.innerHTML = headerHTML + `<div style="max-height: 400px; overflow-y: auto; scrollbar-width: thin;">${listHTML}</div>`;
}


// é–‹å•Ÿ/é—œé–‰æ—¥èªŒå½ˆçª—
function toggleLog() {
    const popup = document.getElementById('adventure-log-popup');
    const isVisible = popup.style.display === 'block';
    popup.style.display = isVisible ? 'none' : 'block';
    if (!isVisible) renderAdventureLog();
}


// --- 3. æ¸²æŸ“å´é‚Šæ¬„æ–‡ç« åˆ—è¡¨ (ç‰©ç†åŠ å›ºç‰ˆï¼šé˜²æ­¢ name ç‚ºç©ºå°è‡´å´©æ½°) ---
async function renderHistoryList() {
    const listContainer = document.getElementById('history-list');
    if (!listContainer) return;

    try {
        // å¾è³‡æ–™åº«æŠ“å–æ‰€æœ‰ç‡ƒæ–™åŒ…
        const allPacks = await db.fuelPacks.reverse().toArray();
        
        if (allPacks.length === 0) {
            listContainer.innerHTML = '<p style="color:#999; font-size:12px; padding:10px;">å°šç„¡å„²å­˜çš„æ–‡ç« </p>';
            return;
        }

        listContainer.innerHTML = allPacks.map(p => {
            // ğŸ”¥ ã€é—œéµä¿®æ­£ã€‘ç‰©ç†æª¢æŸ¥ name æ˜¯å¦å­˜åœ¨ã€‚è‹¥ç‚ºç©ºï¼Œå‰‡é¡¯ç¤ºã€Œæœªå‘½åç‡ƒæ–™åŒ…ã€
            const safeName = p.name ? String(p.name) : "æœªå‘½åçš„å†’éšªç« ç¯€";
            
            // ç‰©ç†éæ¿¾æ¨™ç±¤ï¼Œç¢ºä¿é¡¯ç¤ºç°¡æ½”
            const cleanName = safeName.replace(/<[^>]*>?/gm, '');
            const diffLabel = p.difficulty ? `[${p.difficulty}] ` : "";

            return `
                <div class="side-item" onclick="loadHistory(${p.id})" 
                     style="padding:10px; border-bottom:1px solid #eee; cursor:pointer; font-size:14px; transition: background 0.2s;">
                    ğŸ“– <small style="color:#888;">${diffLabel}</small>${cleanName}
                </div>
            `;
        }).join('');
        
        console.log("ğŸ“œ æ–‡ç« åˆ—è¡¨æ¸²æŸ“å®Œç•¢ (å·²éæ¿¾æ½›åœ¨éŒ¯èª¤è³‡æ–™)");

    } catch (err) {
        console.error("âŒ æ¸²æŸ“åˆ—è¡¨æ™‚ç™¼ç”Ÿç‰©ç†å´©æ½°:", err);
        listContainer.innerHTML = '<p style="color:#e74c3c; font-size:11px;">âš ï¸ åˆ—è¡¨è¼‰å…¥å¤±æ•— (è³‡æ–™æ ¼å¼ç•°å¸¸)</p>';
    }
}


// --- 4. é»æ“Šæ­·å²ç´€éŒ„è¼‰å…¥èˆ‡æƒ…å ±æ›´æ–° (æ¨¡çµ„åŒ–ä¿®æ­£ç‰ˆ) ---
async function loadHistory(id) {
    // 1. ç‰©ç†è®€å–ï¼šå¾è³‡æ–™åº«ç²å–å®Œæ•´ç‡ƒæ–™åŒ…
    const data = await db.fuelPacks.get(id);
    if (!data) return;

    // 2. ğŸ”¥ ã€æ ¸å¿ƒå‘¼å«ã€‘ä½¿ç”¨æ–°ç‰ˆå‹•æ…‹æ¸²æŸ“å¼•æ“é¡¯ç¤ºå…§å®¹ (æ–‡ç« ã€å–®å­—ã€æ¸¬é©—)
    // é€™æœƒè‡ªå‹•ç”Ÿæˆä¸­é–“ç™½è‰²å€åŸŸçš„æ‰€æœ‰ HTML
    if (typeof renderLearningDetail === 'function') {
        renderLearningDetail(data);
    } else {
        console.error("âŒ æ‰¾ä¸åˆ° renderLearningDetailï¼Œç„¡æ³•æ¸²æŸ“å­¸ç¿’å…§å®¹ï¼");
    }
    
    // 3. æ›´æ–°æƒ…å ±é¢æ¿ (Intel Panel) & ç‰©ç†é–å®šç›®æ¨™
    // é€™æœƒæ›´æ–°å´é‚Šæ¬„çš„æ€ªç‰©æ•¸å€¼èˆ‡æ‰è½ç‰©é è¦½
    if (typeof updateIntelPanel === 'function') {
        updateIntelPanel(data);
    } else {
        console.warn("âš ï¸ updateIntelPanel å°šæœªå®šç¾©ï¼Œå´é‚Šæ¬„æƒ…å ±å¯èƒ½æœªæ›´æ–°");
    }

    // 4. ç‰©ç†å¹³æ»‘ç½®é ‚ (UX å„ªåŒ–)
    // å„ªå…ˆæ²å‹•ã€Œå­¸ç¿’å…§å®¹å®¹å™¨ã€ï¼Œç¢ºä¿é•·æ–‡ç« åˆ‡æ›æ™‚å›åˆ°é ‚éƒ¨
    const contentArea = document.getElementById('learning-content-area');
    if (contentArea) {
        contentArea.scrollTop = 0;
    }
    // å‚™ç”¨ï¼šæ²å‹•æ•´å€‹è¦–çª—
    window.scrollTo({ top: 0, behavior: 'smooth' });
    
    console.log(`ğŸ“– å·²è¼‰å…¥æ­·å²ç« ç¯€ï¼š${data.name}`);
}


// ç‰©ç†è¼”åŠ©ï¼šå¾æƒ…å ±é¢æ¿ç›´æ¥ç™¼èµ·æˆ°é¬¥
function triggerEncounterFromIntel() {
    if (window.currentActivePack) {
        // å…ˆè·³è½‰åˆ°å°æ‡‰åœ°åœ–é›£åº¦ï¼Œç¢ºä¿èƒŒæ™¯èˆ‡æ•¸å€¼æ­£ç¢º
        travelTo(window.currentActivePack.difficulty);
        
        // ç‰©ç†å¼·åˆ¶å•Ÿå‹•æˆ°é¬¥
        setTimeout(() => {
            startDQBattle(window.currentActivePack);
        }, 500);
    }
}

// --- 6. èªéŸ³èˆ‡ UI æ§åˆ¶é‚è¼¯ (é˜²é‡è®€ä¿®æ­£ç‰ˆ) ---

/**
 * ğŸ“– 1. æ•¸æ“šæ¸…æ´—å±¤ï¼šé«˜éšèªç¾©éæ¿¾å™¨
 * è·è²¬ï¼šå°‡ HTML (å« Ruby) æ‰‹è¡“å¼é‡çµ„ç‚ºé©åˆ TTS æœ—è®€çš„ç´”å¹³å‡åå­—ä¸²
 */
function speakText(htmlContent) {
    if (!htmlContent) return;

    // ç‰©ç†ä¸­æ–·ï¼šåœæ­¢ç•¶å‰æ‰€æœ‰èªéŸ³
    window.speechSynthesis.cancel();

    // å»ºç«‹æš«å­˜å®¹å™¨é€²è¡Œ DOM æ‰‹è¡“ [cite: 2026-01-21]
    const temp = document.createElement('div');
    temp.innerHTML = htmlContent;

    // ğŸ”¥ ã€ç‰©ç†é‡çµ„ã€‘å¤–ç§‘æ‰‹è¡“å¼æ›¿æ›é‚è¼¯
    // ä½œç”¨ï¼šå°‡ <ruby> æ¨™ç±¤æ›¿æ›ç‚º rt å…§å®¹ï¼ŒåŒæ™‚ä¿ç•™æ¨™ç±¤å¤–çš„é€å‡å
    temp.querySelectorAll('ruby').forEach(ruby => {
        const rt = ruby.querySelector('rt');
        if (rt) {
            // ç‰©ç†æ›¿æ›ï¼š<ruby>æ‰•<rt>ã¯ã‚‰</rt></ruby>ã„ -> è®Šæˆ "ã¯ã‚‰" + "ã„" [cite: 2026-01-21]
            const readingNode = document.createTextNode(rt.innerText);
            ruby.parentNode.replaceChild(readingNode, ruby);
        }
    });

    // æå–æ¸…æ´—å¾Œçš„ç´”æ·¨å¹³å‡åï¼Œä¸¦ç§»é™¤æ‰€æœ‰ç‰©ç†ç©ºç™½
    const cleanText = temp.innerText.trim().replace(/\s+/g, '');
    
    if (!cleanText) return;

    // ç‰©ç†äº¤æ£’çµ¦ç‰©ç†ç™¼è²å¼•æ“ [cite: 2026-01-21]
    speakRawText(cleanText);
}



/**
 * ğŸ“– 2. æœ—è®€èª¿åº¦å™¨ (ç›®æ¨™åŠ å›ºèˆ‡ç‰©ç†è£œå„Ÿç‰ˆ)
 * ä½œç”¨ï¼šç¢ºä¿ç›®æ¨™ ID éºå¤±æ™‚èƒ½è‡ªå‹•å°å¼•è‡³é€šç”¨æ–‡ç« é¡åˆ¥
 */
function speakTextFromId(id) {
    const el = document.getElementById(id);
    
    if (!el) {
        // ç‰©ç†è£œå„Ÿï¼šæƒæ .article-body ä½œç‚º Fallback ç›®æ¨™ [cite: 2026-01-19]
        const fallback = document.querySelector('.article-body');
        if (fallback) {
            console.log("ğŸ“¡ ç‰©ç†ç›®æ¨™é‡å°å‘ï¼šæ­£åœ¨å¾ .article-body æå–å…§å®¹");
            speakText(fallback.innerHTML);
        } else {
            console.error("âŒ ç‰©ç†æ–·è£‚ï¼šæ‰¾ä¸åˆ°æœ—è®€ç›®æ¨™å€åŸŸ");
            if (typeof showNotification === 'function') {
                showNotification("âš ï¸ æ‰¾ä¸åˆ°å¯æœ—è®€çš„æ–‡ç« å…§å®¹");
            }
        }
        return;
    }
    
    console.log(`ğŸ¤ ç‰©ç†é–å®šæˆåŠŸï¼Œç›®æ¨™æ¨™ç±¤ï¼š${id}`);
    speakText(el.innerHTML);
}


/**
 * ğŸ—£ï¸ ç‰©ç†ç™¼è²å¼•æ“ (V4 æ•´åˆå®Œå…¨é«”)
 * è·è²¬ï¼šè™•ç†è²å„ªé¸å–ã€èªé€Ÿæ ¡æº–èˆ‡ç‰©ç†æ’­æ”¾
 * ä¿®æ­£ï¼šæ•´åˆå…ƒä»¶å®‰å…¨æª¢ç´¢èˆ‡é«˜éšè²éŸ³çµäººé‚è¼¯
 */
function speakRawText(text) {
    if (!text) return;

    // 1. ç‰©ç†é‡ç½®ï¼šç«‹å³åˆ‡æ–·ç•¶å‰æ­£åœ¨æ’­æ”¾çš„è²éŸ³ï¼Œé˜²æ­¢è®€éŸ³é‡ç–Š
    window.speechSynthesis.cancel();

    const utter = new SpeechSynthesisUtterance(text);
    utter.lang = 'ja-JP';

    // 2. ç‰©ç†å®‰å…¨æª¢ç´¢ï¼šç¢ºä¿ speed-range å…ƒä»¶å­˜åœ¨ï¼Œå¦å‰‡ä¿åº•ç‚º 1.0 å€é€Ÿ
    const speedEl = document.getElementById('speed-range');
    utter.rate = speedEl ? parseFloat(speedEl.value) : 1.0;

    // 3. è·äººç´šéŸ³èª¿èª¿æ•™ï¼šè¨­å®šç‚º 1.2 é”æˆæ›´å¹´è¼•ã€è¼•å¿«çš„è½æ„Ÿ
    utter.pitch = 1.2;

    // 4. è²éŸ³çµäººï¼šæŒ‰å„ªå…ˆé †åºæœå°‹æœ€ä½³æ—¥ç³»è²å„ª
    const voices = window.speechSynthesis.getVoices();
    const preferredVoices = [
        "Google æ—¥æœ¬èª",      
        "Microsoft Haruka",   
        "Microsoft Ayumi",    
        "Kyoko",              
        "O-Ren"               
    ];

    let selectedVoice = null;
    for (const name of preferredVoices) {
        selectedVoice = voices.find(v => v.name.includes(name));
        if (selectedVoice) break;
    }

    // è‹¥ç„¡é¦–é¸è²å„ªï¼Œå‰‡ç‰©ç†ä¿åº•ä½¿ç”¨æ—¥èªå¼•æ“
    if (!selectedVoice) selectedVoice = voices.find(v => v.lang === 'ja-JP');

    if (selectedVoice) {
        utter.voice = selectedVoice;
    }

    // 5. æˆ°è¡“æ—¥èªŒï¼šæ–¼ Debug Console è¼¸å‡ºé»ç«ç‹€æ…‹
    console.log(`ğŸ¤ ç‰©ç†é»ç«æˆåŠŸ | è²å„ª: ${selectedVoice ? selectedVoice.name : 'ç³»çµ±é è¨­'} | å…§å®¹: ${text}`);

    // 6. åŸ·è¡Œç‰©ç†ç™¼è²
    window.speechSynthesis.speak(utter);
}


function toggleRuby() {
    // é—œéµåœ¨æ–¼å° body æˆ– article-view åˆ‡æ› class
    document.getElementById('article-view').classList.toggle('hide-furigana');
    
    // æ›´æ–°æŒ‰éˆ•æ–‡å­—
    const isHidden = document.getElementById('article-view').classList.contains('hide-furigana');
    document.getElementById('toggle-ruby').innerText = isHidden ? "æ¼¢å­—ã®èª­ã¿æ–¹ã‚’å‡ºã™" : "æ¼¢å­—ã®èª­ã¿æ–¹ã‚’æ¶ˆã™";
}



// åˆå§‹åŒ–æª¢æŸ¥
function gapiLoaded() { gapi.load('client', async () => { await gapi.client.init({ }); gapiInited = true; }); }
function gisLoaded() { tokenClient = google.accounts.oauth2.initTokenClient({ client_id: CLIENT_ID, scope: SCOPES, callback: '', }); gisInited = true; }

// =========================================
// â˜ï¸ Google Cloud ç‰©ç†é€£æ¥æ ¸å¿ƒ (Cloud Core)
// =========================================

/**
 * ğŸ“¡ 1. GAPI æª”æ¡ˆæ¨¡çµ„åˆå§‹åŒ–
 * èªªæ˜ï¼šè² è²¬è¼‰å…¥ Drive APIï¼Œç”¨æ–¼æª”æ¡ˆè®€å¯«ã€‚
 */
window.gapiLoaded = function() {
    // ç‰©ç†é˜²ç¦¦ï¼šå¦‚æœ gapi å°šæœªæ›è¼‰ï¼Œé€²è¡ŒçŸ­æš«é‡è©¦
    if (typeof gapi === 'undefined') {
        console.warn("âš ï¸ GAPI æœªå°±ç·’ï¼ŒåŸ·è¡Œ 100ms é‡è©¦...");
        setTimeout(window.gapiLoaded, 100);
        return;
    }

    console.log("%cğŸ“¡ GAPI è¨Šè™Ÿæ•æ‰ï¼Œæ­£åœ¨æ³¨å…¥ Client...", "color: #4285F4; font-weight: bold;");

    gapi.load('client', async () => {
        try {
            // åˆå§‹åŒ– Drive V3
            await gapi.client.init({
                discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'],
            });

            window.gapiInited = true;
            console.log("âœ… GAPI æª”æ¡ˆæ¨¡çµ„å·²å°±ç·’ (DRIVE_V3)");

            // æ›´æ–° UI
            const statusEl = document.getElementById('cloud-status');
            if (statusEl) statusEl.innerText = "â˜ï¸ é›²ç«¯æ¨¡çµ„å¾…å‘½";

            // è§¸ç™¼äº’é–æª¢æŸ¥
            if (typeof checkReady === 'function') checkReady();
            
            // å˜—è©¦è‡ªå‹•æ¢å¾©ç™»å…¥
            if (typeof tryToResumeSession === 'function') tryToResumeSession();

        } catch (err) {
            console.error("âŒ GAPI åˆå§‹åŒ–å¤±æ•—:", err);
            if (typeof showNotification === 'function') {
                showNotification("âš ï¸ é›²ç«¯æœå‹™é€£æ¥å¤±æ•—");
            }
        }
    });
};

/**
 * ğŸ”‘ 2. GIS æˆæ¬Šæ¨¡çµ„åˆå§‹åŒ–
 * èªªæ˜ï¼šè² è²¬ OAuth 2.0 å½ˆçª—æˆæ¬Šã€‚
 */
window.gisLoaded = function() {
    // ç‰©ç†é˜²ç¦¦ï¼šç¢ºä¿ google.accounts å·²è¼‰å…¥
    if (typeof google === 'undefined' || !google.accounts) {
        console.warn("âš ï¸ GIS æœªå°±ç·’ï¼ŒåŸ·è¡Œ 100ms é‡è©¦...");
        setTimeout(window.gisLoaded, 100);
        return;
    }

    console.log("%cğŸ”‘ GIS è¨Šè™Ÿæ•æ‰ï¼Œæ­£åœ¨é…ç½® TokenClient...", "color: #FBBC05; font-weight: bold;");

    try {
        // å®‰å…¨æª¢æŸ¥ï¼šç¢ºä¿è¨­å®šæª” (config.js) å·²è¼‰å…¥
        if (typeof CLIENT_ID === 'undefined' || typeof SCOPES === 'undefined') {
            throw new Error("CLIENT_ID æˆ– SCOPES æœªå®šç¾©ï¼Œè«‹æª¢æŸ¥ config.js");
        }

        // åˆå§‹åŒ– TokenClient
        window.tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: CLIENT_ID,
            scope: SCOPES,
            callback: (response) => {
                // é€™è£¡çš„ callback æœƒè¢« handleAuthClick è¦†è“‹ï¼Œä¿ç•™ç©ºå‡½æ•¸é˜²æ­¢å ±éŒ¯
                if (response.error) {
                    console.error("âŒ æˆæ¬ŠéŒ¯èª¤:", response);
                }
            },
        });

        window.gisInited = true;
        console.log("âœ… GIS æˆæ¬Šæ¨¡çµ„å·²å°±ç·’ (OAUTH_2.0)");

        // è§¸ç™¼äº’é–æª¢æŸ¥
        if (typeof checkReady === 'function') checkReady();

    } catch (err) {
        console.error("âŒ GIS åˆå§‹åŒ–å¤±æ•—:", err);
    }
};

/**
 * ğŸ”— 3. é›™æ¨¡çµ„äº’é–æª¢æŸ¥ (Interlock Check - ç‰©ç†æ•´åˆç‰ˆ)
 * èªªæ˜ï¼šç•¶ GAPI å’Œ GIS éƒ½æº–å‚™å¥½æ™‚ï¼Œå•Ÿå‹•æŒ‰éˆ•ã€ç¶å®šäº‹ä»¶ä¸¦å˜—è©¦è‡ªå‹•æ¢å¾©ã€‚
 */
function checkReady() {
    // 1. ğŸ”¥ ã€ç‰©ç†ç‹€æ…‹æ“·å–ã€‘
    const isGapiOk = window.gapiInited === true;
    const isGisOk = window.gisInited === true;

    console.log(`ğŸ” é›²ç«¯éˆè·¯æƒæï¼šGAPI[${isGapiOk ? 'OK' : 'WAIT'}] GIS[${isGisOk ? 'OK' : 'WAIT'}]`);

    // åªæœ‰ç•¶é›™éˆè·¯éƒ½é€šæ™‚æ‰åŸ·è¡Œ
    if (isGapiOk && isGisOk) {
        
        // 2. ğŸ”¥ ã€UI ç‰©ç†æ´»åŒ–ã€‘
        const btn = document.getElementById('auth-btn');
        const statusEl = document.getElementById('cloud-status');

        if (statusEl) {
            statusEl.innerText = "â˜ï¸ é›²ç«¯æœå‹™å·²ç‰©ç†å°±ç·’";
            statusEl.style.color = "#2ecc71"; // æˆåŠŸç¶ 
            statusEl.style.textShadow = "0 0 5px rgba(46, 204, 113, 0.5)";
        }

        if (btn) {
            // A. è§£é–æŒ‰éˆ•èˆ‡é¡¯ç¤º
            btn.style.display = 'block';
            btn.disabled = false;
            
            // B. ç¶å®šç‰©ç†é»æ“Šäº‹ä»¶ (é€™æ˜¯æœ€é‡è¦çš„ä¸€æ­¥ï¼)
            // ç¢ºä¿ handleAuthClick å‡½æ•¸å­˜åœ¨æ‰ç¶å®š
            if (typeof handleAuthClick === 'function') {
                btn.onclick = handleAuthClick;
            } else {
                console.error("âŒ ç‰©ç†æ–·è£‚ï¼šæ‰¾ä¸åˆ° handleAuthClick å‡½æ•¸ï¼ŒæŒ‰éˆ•ç„¡æ³•é‹ä½œ");
            }

            // C. è¦–è¦ºå¼·åŒ– (ç™¼å…‰ç‰¹æ•ˆ)
            btn.style.boxShadow = "0 0 10px rgba(46, 204, 113, 0.4)";
            btn.style.borderColor = "#2ecc71";
            
            // D. æ™ºæ…§æ–‡æ¡ˆåˆ¤å®š (åµæ¸¬æœ¬åœ°æ˜¯å¦æœ‰èˆŠ Token)
            if (localStorage.getItem('google_drive_token')) {
                btn.innerText = "ğŸ”‘ æ¢å¾©é›²ç«¯é€£ç·š";
            } else {
                btn.innerText = "ğŸ”‘ ç™»å…¥é›²ç«¯å­˜æª”";
            }
        }

        // 3. ğŸ”¥ ã€ç‰©ç†æ¬Šé™è‡ªå‹•æ¢å¾©ã€‘
        // å˜—è©¦åŸ·è¡Œéœé»˜é‡é€£ï¼Œè§£æ±º F5 æ‰ç·šå•é¡Œ
        // åŠ ä¸Šé˜²æ­¢é‡è¤‡åŸ·è¡Œçš„æª¢æŸ¥ (å¯é¸)
        if (typeof tryToResumeSession === 'function') {
            console.log("â™»ï¸ éˆè·¯å…¨é€šï¼Œå˜—è©¦ç‰©ç†æ¢å¾©æœƒè©±...");
            tryToResumeSession();
        }
    }
}


/**
 * ğŸ”‘ ç‰©ç†å­ç¨‹åºï¼šå•Ÿå‹• Google æˆæ¬Šæµç¨‹
 * è™•ç† tokenClient æª¢ç´¢ã€Token æŒä¹…åŒ–èˆ‡ GAPI æ³¨å…¥
 */
function handleAuthClick() {
    // 1. ğŸ”¥ ã€ç‰©ç†ç‹€æ…‹æª¢æŸ¥ã€‘ç²¾ç¢ºå®šä½å…¨åŸŸå¯¦ä¾‹
    // ç¢ºä¿ä½¿ç”¨ window.tokenClient ä»¥è§£æ±º ReferenceError
    const client = window.tokenClient;

    if (!client) {
        console.error("âŒ ç‰©ç†å´©æ½°ï¼štokenClient å°šæœªåˆå§‹åŒ–ï¼Œå˜—è©¦ç·Šæ€¥æ¢å¾©...");
        // è‹¥ window.gisLoaded å­˜åœ¨ï¼Œå˜—è©¦æ‰‹å‹•è§¸ç™¼ä¸€æ¬¡åˆå§‹åŒ–
        if (typeof window.gisLoaded === 'function') {
            window.gisLoaded();
        }
        showNotification("âš ï¸ Google æœå‹™ç‰©ç†é€£ç·šä¸­ï¼Œè«‹ç¨å€™ 3 ç§’å†è©¦ã€‚");
        return;
    }

    // 2. ğŸ”¥ ã€ç‰©ç†å›èª¿é–å®šã€‘å®šç¾©ç•¶ç©å®¶é¸å®Œå¸³è™Ÿå¾Œè¦åšçš„äº‹æƒ…
    client.callback = async (resp) => {
        if (resp.error !== undefined) {
            console.error("âŒ æˆæ¬Šå›å‚³éŒ¯èª¤:", resp);
            showNotification("ğŸ’€ æˆæ¬Šé­æ‹’ï¼šç„¡æ³•å»ºç«‹é›²ç«¯é€£ç·šã€‚");
            return;
        }

        // ğŸŸ¢ ç‰©ç†å­˜æª” Token (å­˜å„² 1 å°æ™‚æ•ˆæœŸ)
        const tokenData = {
            access_token: resp.access_token,
            // Google é è¨­ expires_in ç‚º 3600 ç§’
            expires_at: Date.now() + (parseInt(resp.expires_in || 3600) * 1000)
        };
        localStorage.setItem('google_drive_token', JSON.stringify(tokenData));
        
        // ğŸŸ¢ ç‰©ç†æ³¨å…¥ Token åˆ° GAPI Client
        // é€™æ­¥æ˜¯ç¢ºä¿å¾ŒçºŒ gapi.client.drive å‘¼å«å…·å‚™ç‰©ç†æ¬Šé™çš„é—œéµ
        if (window.gapi && gapi.client) {
            gapi.client.setToken({ access_token: resp.access_token });
        }
        
        // ğŸŸ¢ æ›´æ–° UI ç‹€æ…‹
        const authBtn = document.getElementById('auth-btn');
        const syncBtn = document.getElementById('sync-btn');
        const cloudStatus = document.getElementById('cloud-status');
        const cloudManager = document.getElementById('cloud-manager');

        if (authBtn) authBtn.innerText = "âœ… å·²æˆæ¬Š";
        if (syncBtn) syncBtn.style.display = "inline-block";
        if (cloudStatus) cloudStatus.innerText = "é€£ç·šæˆåŠŸï¼Œæ•¸æ“šåŒæ­¥ä¸­...";
        if (cloudManager) cloudManager.style.display = "block";

        // ğŸŸ¢ åŸ·è¡Œæ•¸æ“šæµåŠ è¼‰
        console.log("âš¡ æˆæ¬ŠæˆåŠŸï¼Œå•Ÿå‹•é›²ç«¯æ•¸æ“šé‚„åŸ...");
        try {
            await loadGameFromCloud(); // å„ªå…ˆè¼‰å…¥å­˜æª”
            await listCloudFiles();    // æ¸²æŸ“æ¸…å–®
            showNotification("âœ… é›²ç«¯åŒæ­¥é”æˆï¼");
        } catch (syncErr) {
            console.error("âŒ æ•¸æ“šé‚„åŸå¤±æ•—:", syncErr);
            showNotification("âš ï¸ é›²ç«¯è®€å–ç•°å¸¸ï¼Œè«‹é‡æ•´ç¶²é ã€‚");
        }
    };

    // 3. ğŸ”¥ ã€ç‰©ç†è§¸ç™¼ã€‘å½ˆå‡º Google ç™»å…¥è¦–çª—
    // prompt: '' ä»£è¡¨ã€Œå˜—è©¦éœé»˜æˆæ¬Šã€ï¼Œè‹¥å¤±æ•—æœƒç‰©ç†å¼•å°è‡³é¸å–å¸³è™Ÿä»‹é¢
    try {
        client.requestAccessToken({ prompt: '' });
    } catch (reqErr) {
        console.warn("âš ï¸ éœé»˜æˆæ¬Šå¤±æ•—ï¼Œåˆ‡æ›è‡³å¼·åˆ¶é¸å–æ¨¡å¼");
        client.requestAccessToken({ prompt: 'select_account' });
    }
}

async function tryToResumeSession() {
    const savedToken = localStorage.getItem('google_drive_token');
    if (!savedToken) return;

    try {
        const { access_token, expires_at } = JSON.parse(savedToken);
        
        // ç‰©ç†æª¢æŸ¥ï¼šå¦‚æœ Token é‚„æ²’éæœŸ (é ç•™ 5 åˆ†é˜ç·©è¡)
        if (Date.now() < expires_at - 300000) {
            console.log("â™»ï¸ åµæ¸¬åˆ°æœ‰æ•ˆ Sessionï¼ŒåŸ·è¡Œè‡ªå‹•é‡é€£...");
            
            // é‡è¦ï¼šç‰©ç†æ³¨å…¥ Token
            gapi.client.setToken({ access_token: access_token });
            
            // æ›´æ–° UI
            document.getElementById('auth-btn').innerText = "âœ… å·²æˆæ¬Š";
            document.getElementById('sync-btn').style.display = "inline-block";
            
            // è‡ªå‹•åŸ·è¡Œä¸€æ¬¡æ•¸æ“šåŒæ­¥ï¼Œè§£æ±ºã€Œé‡æ•´ç­‰ç´šæ­¸é›¶ã€
            await loadGameFromCloud();
            updatePlayerUI();
        } else {
            console.log("â³ Token å·²éæœŸï¼Œæ¸…é™¤èˆŠæ•¸æ“š");
            localStorage.removeItem('google_drive_token');
        }
    } catch (e) {
        console.error("Token æ¢å¾©å¤±æ•—", e);
    }
}


// --- â˜ï¸ é›²ç«¯åˆ—è¡¨æ¸²æŸ“ï¼šç‰©ç†é¡¯ç¤ºèˆ‡æ•¸æ“šå¡«å…… ---
async function listCloudFiles() {
    // ç‰©ç†æª¢æŸ¥ï¼šç²å–å®¹å™¨èˆ‡ç‹€æ…‹æ¬„
    const listContainer = document.getElementById('cloud-file-list');
    const statusEl = document.getElementById('cloud-status');
    const cloudManager = document.getElementById('cloud-manager'); 

    // 1. ã€é¡¯ç¤ºåŠ å›ºã€‘åªè¦åŸ·è¡Œæ­¤å‡½æ•¸ï¼Œä»£è¡¨å·²æˆæ¬Šï¼Œå¼·åˆ¶é¡¯ç¤ºå´é‚Šæ¬„å®¹å™¨
    if (cloudManager) {
        cloudManager.style.display = "block";
    }

    if (!listContainer) {
        console.error("âŒ æ‰¾ä¸åˆ° ID ç‚º 'cloud-file-list' çš„å®¹å™¨");
        return;
    }
    
    try {
        if (statusEl) statusEl.innerText = "æ­£åœ¨æƒæé›²ç«¯å‚™ä»½...";
        listContainer.innerHTML = '<div style="text-align:center; padding:20px;"><div class="loading-spinner"></div><p style="font-size:12px; color:#666;">ğŸ” æ­£åœ¨è§£æå‚™ä»½è©³æƒ…...</p></div>';

        // 2. å‘¼å« Google Drive API ç²å–ç¬¦åˆå‘½åçš„ JSON æª”æ¡ˆ
        const response = await gapi.client.drive.files.list({
            // ä¿®æ­£ï¼šç¢ºä¿æœå°‹æ¢ä»¶åŒ…å« TabiSatori ä¸”æ’é™¤å›æ”¶ç«™
            'q': "name contains 'TabiSatori' and trashed = false",
            'fields': 'files(id, name, modifiedTime)',
            'orderBy': 'modifiedTime desc'
        });

        const files = response.result.files;
        if (!files || files.length === 0) {
            listContainer.innerHTML = '<p style="color:#999; font-size:12px; padding:20px; text-align:center;">â˜ï¸ é›²ç«¯ç›®å‰æ²’æœ‰ä»»ä½•å‚™ä»½å­˜æª”</p>';
            if (statusEl) statusEl.innerText = "é›²ç«¯ç„¡å‚™ä»½";
            return;
        }

        listContainer.innerHTML = ''; // æ¸…ç©ºåŠ è¼‰ä¸­ç‹€æ…‹

        // 3. é€ä¸€è™•ç†æª”æ¡ˆï¼šä½¿ç”¨åŒæ­¥è¿´åœˆç¢ºä¿é †åºï¼Œä¸¦åŠ å…¥é˜²éŒ¯æ©Ÿåˆ¶
        for (const file of files) {
            let stats = { count: '?', lastTitle: 'æœªçŸ¥å…§å®¹' };
            
            // ç‰©ç†å®‰å…¨æª¢æŸ¥ï¼šç²å–è©²å‚™ä»½æª”æ¡ˆå…§éƒ¨çš„å…·é«”æ•¸æ“š (å¦‚æ–‡ç« æ•¸)
            if (typeof getCloudFileStats === 'function') {
                try {
                    // é€™æœƒç™¼èµ·å¦ä¸€å€‹ fetch è«‹æ±‚å»è®€å–æª”æ¡ˆå…§å®¹
                    stats = await getCloudFileStats(file.id);
                } catch (e) {
                    console.warn(`ç„¡æ³•è®€å–æª”æ¡ˆ ${file.name} (${file.id}) çš„å…§å®¹æ•¸æ“š`);
                }
            }
            
            // 4. ç‰©ç†ç”Ÿæˆ DOM å…ƒç´ 
            const fileItem = document.createElement('div');
            fileItem.className = "cloud-save-item";
            fileItem.style = "padding:15px; border-bottom:1px solid #edf2f7; background:#fff; margin-bottom:10px; border-radius:8px; box-shadow:0 2px 4px rgba(0,0,0,0.05); transition: 0.3s;";
            
            // æ»‘é¼ æ‡¸åœæ•ˆæœ (CSS æ¨¡æ“¬)
            fileItem.onmouseover = () => fileItem.style.backgroundColor = "#f8fafc";
            fileItem.onmouseout = () => fileItem.style.backgroundColor = "#fff";

            fileItem.innerHTML = `
                <div style="font-weight:bold; color:#2d3748; margin-bottom:6px; font-size:13px; display:flex; align-items:center;">
                    <span style="margin-right:8px;">ğŸ“„</span> ${file.name}
                </div>
                <div style="font-size:11px; color:#718096; line-height:1.8; background:#f7fafc; padding:8px; border-radius:4px;">
                    ğŸ“… å­˜æª”æ™‚é–“ï¼š${new Date(file.modifiedTime).toLocaleString()}<br>
                    ğŸ“š åŒ…å«ç« ç¯€ï¼š<span style="color:var(--nhk-green); font-weight:bold;">${stats.count}</span> ç¯‡<br>
                    ğŸ“Œ æœ€å¾Œæ”»ç•¥ï¼š<span style="color:#4a5568; font-style:italic;">"${stats.lastTitle}"</span>
                </div>
                <div style="display:flex; gap:8px; margin-top:10px;">
                    <button style="flex:2; font-size:11px; cursor:pointer; padding:8px; border:1px solid #cbd5e0; background:white; border-radius:5px; font-weight:bold; color:#4a5568;" 
                            onclick="restoreFromCloud('${file.id}')">ğŸ“¥ è¼‰å…¥æ­¤å‚™ä»½</button>
                    <button style="flex:1; font-size:11px; cursor:pointer; padding:8px; color:#e53e3e; border:1px solid #fed7d7; background:#fff5f5; border-radius:5px;" 
                            onclick="deleteCloudFile('${file.id}', '${file.name}')">ğŸ—‘ï¸ åˆªé™¤</button>
                </div>
            `;
            listContainer.appendChild(fileItem);
        }
        
        if (statusEl) statusEl.innerText = "é›²ç«¯æ¸…å–®åŒæ­¥å®Œæˆ";
        console.log("âœ… é›²ç«¯å‚™ä»½æ¸…å–®ç‰©ç†æ¸²æŸ“å®Œç•¢");
        
    } catch (err) {
        console.error("âŒ listCloudFiles æ¸²æŸ“éšæ®µç‰©ç†å¤±æ•—:", err);
        listContainer.innerHTML = `
            <div style="color:#e53e3e; font-size:12px; padding:20px; text-align:center; border:1px dashed #feb2b2; border-radius:8px;">
                âš ï¸ è®€å–å¤±æ•—ï¼šGoogle API å›å‚³éŒ¯èª¤<br>
                <button onclick="listCloudFiles()" style="margin-top:10px; font-size:10px; padding:5px 10px;">é»æ­¤é‡è©¦</button>
            </div>`;
    }
}

// --- â˜ï¸ é›²ç«¯æª”æ¡ˆè©³æƒ…è§£æ (ç‰©ç†åŠ å›ºèˆ‡çµæ§‹ç›¸å®¹ç‰ˆ) ---
async function getCloudFileStats(fileId) {
    try {
        const accessToken = gapi.auth.getToken().access_token;
        const response = await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`, {
            headers: { 'Authorization': 'Bearer ' + accessToken }
        });

        if (!response.ok) throw new Error("Google Drive è®€å–å¤±æ•—");

        const data = await response.json();
        
        let count = 0;
        let lastTitle = "ç„¡æ¨™é¡Œæ•¸æ“š";

        // ğŸ›¡ï¸ ç‰©ç†é˜²ç¦¦è¼”åŠ©å‡½æ•¸ï¼šç¢ºä¿ replace ä¸æœƒä½œç”¨æ–¼ undefined
        const cleanStr = (str) => {
            if (!str || typeof str !== 'string') return "æœªçŸ¥å…§å®¹";
            return str.replace(/<[^>]*>?/gm, '');
        };

        // --- ğŸ” ç‰©ç†åˆ¤å®šæ•¸æ“šçµæ§‹ ---
        
        // æ¨¡å¼ Aï¼šèˆŠç‰ˆåŒæ­¥é™£åˆ— [ {name:...}, {name:...} ]
        if (Array.isArray(data)) {
            count = data.length;
            if (count > 0) {
                const lastItem = data[data.length - 1];
                lastTitle = cleanStr(lastItem.name || lastItem.title || "æœªå‘½åç« ç¯€");
            }
        } 
        // æ¨¡å¼ Bï¼šæ–°ç‰ˆå‹‡è€…ç‰©ä»¶ { lv: 1, mapProgress: {...}, logs: [...] }
        else if (data && typeof data === 'object') {
            if (data.lv !== undefined) {
                // å¦‚æœæ˜¯å‹‡è€…å­˜æª”ï¼Œå°‡ count è¨­ç‚ºç­‰ç´šï¼Œæ¨™é¡Œè¨­ç‚ºç¸½é€²åº¦
                count = data.lv; 
                
                // ç‰©ç†è¨ˆç®—ç¸½ä½”é ˜é€²åº¦
                let totalProgress = 0;
                if (data.mapProgress) {
                    totalProgress = Object.values(data.mapProgress).reduce((a, b) => (Number(a) || 0) + (Number(b) || 0), 0);
                }
                
                lastTitle = `å‹‡è€…ç­‰ç´š: LV.${count} | ç¸½ä½”é ˜: ${totalProgress} è™•`;
            } else {
                // å…¶ä»–ä¸æ˜ç‰©ä»¶æ ¼å¼
                count = 1;
                lastTitle = cleanStr(data.name || data.title || "å‚™ä»½æª”æ¡ˆ");
            }
        }

        return { count: count, lastTitle: lastTitle };

    } catch (e) {
        console.warn(`âš ï¸ æª”æ¡ˆ [${fileId}] è§£æå¤±æ•—:`, e.message);
        // ç‰©ç†ä¿åº•å›å‚³ï¼Œé˜²æ­¢ listCloudFiles å´©æ½°
        return { count: '?', lastTitle: 'æ ¼å¼ä¸ç›¸å®¹æˆ–ææ¯€' };
    }
}

// 3. åˆªé™¤é›²ç«¯æª”æ¡ˆ
async function deleteCloudFile(fileId, fileName) {
    if (!confirm(`ç¢ºå®šè¦åˆªé™¤é›²ç«¯æª”æ¡ˆã€Œ${fileName}ã€å—ï¼Ÿ\næ­¤å‹•ä½œå°‡ç‰©ç†æ€§ç§»é™¤ Google Drive ä¸Šçš„å‚™ä»½ã€‚`)) return;

    try {
        document.getElementById('cloud-status').innerText = "æ­£åœ¨åˆªé™¤...";
        await gapi.client.drive.files.delete({
            'fileId': fileId
        });
        alert("å·²æˆåŠŸåˆªé™¤é›²ç«¯å‚™ä»½ã€‚");
        // é‡æ–°æ•´ç†æ¸…å–®
        await listCloudFiles();
    } catch (err) {
        console.error(err);
        alert("åˆªé™¤å¤±æ•—ï¼Œè«‹æª¢æŸ¥ API æ¬Šé™æˆ–ç¶²è·¯ç‹€æ³ã€‚");
        document.getElementById('cloud-status').innerText = "åˆªé™¤å¤±æ•—";
    }
}

// 4. å¾é›²ç«¯é‚„åŸè³‡æ–™
async function restoreFromCloud(fileId) {
    if (!confirm("ç¢ºå®šè¦å¾æ­¤å‚™ä»½é‚„åŸå—ï¼Ÿé€™å°‡æœƒèˆ‡æ‚¨ç›®å‰çš„æœ¬æ©Ÿæ–‡ç« åº«åˆä½µã€‚")) return;

    try {
        document.getElementById('cloud-status').innerText = "ä¸‹è¼‰é‚„åŸä¸­...";
        
        const accessToken = gapi.auth.getToken().access_token;
        const response = await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`, {
            headers: { 'Authorization': 'Bearer ' + accessToken }
        });

        const cloudData = await response.json();
        
        // å¯«å…¥æœ¬æ©Ÿè³‡æ–™åº«
        if (Array.isArray(cloudData)) {
            await db.fuelPacks.bulkPut(cloudData);
        } else {
            await db.fuelPacks.put(cloudData);
        }

        alert("âœ… é‚„åŸæˆåŠŸï¼");
        await renderHistoryList(); // æ›´æ–°æ–‡ç« åº«æ¸…å–®
        document.getElementById('cloud-status').innerText = "é‚„åŸå®Œæˆ";
    } catch (err) {
        console.error(err);
        alert("é‚„åŸå¤±æ•—ã€‚");
    }
}


// å¯¦ä½œï¼šåŒæ­¥ï¼ˆä¸Šå‚³ï¼‰åˆ°é›²ç«¯
async function syncToCloud() {
    const allData = await db.fuelPacks.toArray();
    if (allData.length === 0) return alert("ç›®å‰æ²’æœ‰è³‡æ–™å¯åŒæ­¥");

    document.getElementById('cloud-status').innerText = "åŒæ­¥ä¸Šå‚³ä¸­...";
    const fileName = 'TabiSatori_Sync.json';
    const content = JSON.stringify(allData);

    // å»ºç«‹æª”æ¡ˆçš„ Metadata èˆ‡ å…§å®¹
    const boundary = 'foo_bar_baz';
    const delimiter = "\r\n--" + boundary + "\r\n";
    const close_delim = "\r\n--" + boundary + "--";

    const contentType = 'application/json';
    const metadata = {
        'name': fileName,
        'mimeType': contentType
    };

    // å¦‚æœå·²ç¶“æœ‰æª”æ¡ˆ IDï¼Œå°±ç”¨ PATCH (æ›´æ–°)ï¼›å¦å‰‡ç”¨ POST (æ–°å»º)
    const url = cloudFileId 
        ? `https://www.googleapis.com/upload/drive/v3/files/${cloudFileId}?uploadType=multipart`
        : 'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart';
    
    const method = cloudFileId ? 'PATCH' : 'POST';

    const multipartRequestBody =
        delimiter +
        'Content-Type: application/json; charset=UTF-8\r\n\r\n' +
        JSON.stringify(metadata) +
        delimiter +
        'Content-Type: ' + contentType + '\r\n\r\n' +
        content +
        close_delim;

    try {
        await gapi.client.request({
            'path': url,
            'method': method,
            'params': {'uploadType': 'multipart'},
            'headers': { 'Content-Type': 'multipart/related; boundary=' + boundary },
            'body': multipartRequestBody
        });
        
        alert("åŒæ­¥æˆåŠŸï¼è³‡æ–™å·²å„²å­˜è‡³æ‚¨çš„ Google Driveã€‚");
        await listCloudFiles(); // é‡æ–°æ•´ç†ç‹€æ…‹
    } catch (err) {
        console.error(err);
        alert("åŒæ­¥å¤±æ•—");
    }
}


async function checkInitialAuth() {
    const authInstance = gapi.auth2.getAuthInstance();
    
    // ç‰©ç†ç›£è½ï¼šç•¶ç™»å…¥ç‹€æ…‹æ”¹è®Šæ™‚è‡ªå‹•åŒæ­¥
    authInstance.isSignedIn.listen(updateSigninStatus);

    // ç«‹å³åŸ·è¡Œä¸€æ¬¡ç¾æœ‰ç‹€æ…‹æª¢æŸ¥
    if (authInstance.isSignedIn.get()) {
        console.log("ğŸ‘¤ æª¢æ¸¬åˆ°å·²ç™»å…¥ Sessionï¼ŒåŸ·è¡Œè‡ªå‹•åŒæ­¥...");
        await updateSigninStatus(true);
    } else {
        console.log("ğŸ‘‹ ç„¡ç¾å­˜ Sessionï¼Œç­‰å¾…ä½¿ç”¨è€…ç™»å…¥");
    }
}

async function updateSigninStatus(isSignedIn) {
    const authBtn = document.getElementById('auth-btn');
    const syncBtn = document.getElementById('sync-btn');
    const statusEl = document.getElementById('cloud-status');
    const cloudManager = document.getElementById('cloud-manager');

    if (isSignedIn) {
        console.log("ğŸ”“ ç‹€æ…‹æª¢æŸ¥ï¼šä½¿ç”¨è€…å·²ç™»å…¥");

        // 1. ã€å„ªå…ˆç‰©ç†é¡¯ç¤ºã€‘å…ˆè®“ UI å‡ºç¾ï¼Œé¿å…å› ç‚ºå¾ŒçºŒ await å»¶é²å°è‡´æ¬„ä½ä¸è¦‹
        if (authBtn) authBtn.innerText = "âœ… å·²æˆæ¬Š";
        if (syncBtn) syncBtn.style.display = "inline-block";
        if (statusEl) statusEl.innerText = "â˜ï¸ é›²ç«¯æœå‹™å·²å°±ç·’";
        if (cloudManager) {
            cloudManager.style.display = "block"; // å¼·åˆ¶é–‹å•Ÿå´é‚Šæ¬„å®¹å™¨
        }
        
        console.log("ğŸ“‚ åŸ·è¡Œé›²ç«¯æ•¸æ“šé‚„åŸæµ...");
        
        try {
            // 2. ç‰©ç†è¼‰å…¥é›²ç«¯å­˜æª” (é€™æ­¥è‹¥å¤±æ•—æœƒè·³å…¥ catchï¼Œä½† UI å·²ç¶“é¡¯ç¤ºäº†)
            await loadGameFromCloud(); 
            
            // 3. ç‰©ç†é–å®šï¼šå°‡è³‡æ–™åŒæ­¥è‡³ IndexedDB
            if (typeof savePlayerToDB === 'function') {
                await savePlayerToDB(); 
            }
            
            // 4. UI èˆ‡ æ•¸æ“šåˆ—è¡¨åˆ·æ–°
            if (typeof updatePlayerUI === 'function') {
                updatePlayerUI();
            }
            
            // 5. ç‰©ç†åŒæ­¥é›²ç«¯å‚™ä»½æ¸…å–® (å³åˆ»æ¸²æŸ“å´é‚Šæ¬„å…§å®¹)
            if (typeof listCloudFiles === 'function') {
                console.log("ğŸ”„ æ­£åœ¨æ›´æ–°å´é‚Šæ¬„æ¸…å–®...");
                // ä¸éœ€è¦åŠ ä¸Š awaitï¼Œè®“å®ƒèƒŒæ™¯æ¸²æŸ“ï¼Œä¸é˜»å¡ä¸»æµç¨‹
                listCloudFiles();
            }
            
        } catch (e) {
            console.error("âŒ ç™»å…¥åŒæ­¥éšæ®µç™¼ç”ŸéŒ¯èª¤:", e);
            if (statusEl) statusEl.innerText = "âš ï¸ æ•¸æ“šåŒæ­¥ç•°å¸¸";
        }
        
    } else {
        console.log("ğŸ”’ ç‹€æ…‹æª¢æŸ¥ï¼šä½¿ç”¨è€…æœªç™»å…¥");

        // ç‰©ç†æ¢å¾©ç™»å…¥å‰ç‹€æ…‹
        if (authBtn) authBtn.innerText = "ğŸ”‘ ç™»å…¥ Google";
        if (syncBtn) syncBtn.style.display = "none";
        if (statusEl) statusEl.innerText = "é›²ç«¯æœªé€£ç·š";
        
        // ç¢ºä¿ç®¡ç†æ¬„ä½åœ¨ç™»å‡ºæ™‚ç‰©ç†éš±è—
        if (cloudManager) {
            cloudManager.style.display = "none"; 
        }
        
        // ç‰©ç†æ¸…é™¤æœ¬åœ° Token å¿«å–
        localStorage.removeItem('google_drive_token');
    }
}


function renderQuiz(examData) {
    const container = document.getElementById('quiz-container');
    const section = document.getElementById('quiz-section');
    const submitBtn = document.getElementById('submit-quiz');
    
    if (!examData || examData.length === 0) {
        section.style.display = 'none';
        return;
    }

    section.style.display = 'block';
    submitBtn.style.display = 'block';
    container.innerHTML = '';

    examData.forEach((item, index) => {
        const qDiv = document.createElement('div');
        qDiv.style = "margin-bottom: 20px; padding: 10px; border-bottom: 1px dashed #ddd;";
        
        // é¡¯ç¤ºé¡Œå‹æ¨™ç±¤
        const typeLabel = { 'vocab': 'ã€èªå½™ã€‘', 'grammar': 'ã€æ–‡æ³•ã€‘', 'reading': 'ã€è®€è§£ã€‘' };
        
        qDiv.innerHTML = `
            <div style="font-weight:bold; margin-bottom:8px;">Q${index + 1}. ${typeLabel[item.type]} ${item.q}</div>
            <div class="quiz-options" style="display:grid; gap:8px;">
                ${item.o.map((opt, i) => `
                    <label style="cursor:pointer; display:flex; align-items:center; gap:8px; font-size:15px;">
                        <input type="radio" name="q${index}" value="${i}"> ${opt}
                    </label>
                `).join('')}
            </div>
        `;
        container.appendChild(qDiv);
    });

    // å„²å­˜ç­”æ¡ˆä¾›æ¯”å°
    window.currentAnswers = examData.map(item => item.a);
}

// A. è¦–åœ–åˆ‡æ›ï¼šé–‹å•Ÿè¤‡ç¿’ä¸­å¿ƒæ™‚éš±è—ä¸»å…§å®¹ (ç‰©ç†å°æ­£ç‰ˆ)
async function openFlashcards() {
    const hub = document.getElementById('flashcard-hub');
    const learningArea = document.getElementById('learning-content-area');
    const titleDisplay = document.getElementById('article-title-display');

    if (!hub || !learningArea) return;

    // 1. ç‰©ç†é–å®šï¼šéš±è—æ¨™é¡Œã€æ•´å€‹å­¸ç¿’å€åŸŸèˆ‡æ“ä½œæŒ‰éˆ•
    if (titleDisplay) titleDisplay.style.display = 'none';
    learningArea.style.display = 'none';
    
    // éš±è— NHK æ¨£å¼åŠŸèƒ½æŒ‰éˆ•èˆ‡èˆŠæœ‰ study-box å…ƒç´ 
    document.querySelectorAll('.btn-nhk').forEach(el => el.style.display = 'none');
    document.querySelectorAll('.study-box').forEach(el => el.style.display = 'none');

    // 2. ç‰©ç†é¡¯ç¤ºï¼šè¤‡ç¿’ä¸­å¿ƒä»‹é¢
    hub.style.display = 'flex'; // V4 çµæ§‹æ¡ç”¨ flex ç½®ä¸­ä½ˆå±€
    
    // åŸ·è¡Œæ•¸æ“šè¼‰å…¥
    await loadFlashcards();
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

// B. è¦–åœ–æ¢å¾©ï¼šé—œé–‰è¤‡ç¿’ä¸­å¿ƒ
function closeFlashcards() {
    const hub = document.getElementById('flashcard-hub');
    const learningArea = document.getElementById('learning-content-area');
    const titleDisplay = document.getElementById('article-title-display');

    // 1. ç‰©ç†åˆ‡æ–·ï¼šéš±è—è¤‡ç¿’ä¸­å¿ƒ
    if (hub) hub.style.display = 'none';
    
    // 2. ç‰©ç†é‚„åŸï¼šé¡¯ç¤ºåŸæœ¬çš„æ–‡ç« å€å¡Šã€æ¨™é¡Œèˆ‡æ“ä½œæŒ‰éˆ•
    if (titleDisplay) titleDisplay.style.display = 'block';
    if (learningArea) learningArea.style.display = 'block';
    
    document.querySelectorAll('.btn-nhk').forEach(el => el.style.display = 'inline-block');
    document.querySelectorAll('.study-box').forEach(el => el.style.display = 'block');
}


// C. åŠ è¼‰èˆ‡é€²åº¦è¨ˆç®— (V4 ç‰©ç†è¦æ ¼æ¨™æº–åŒ– + å¤–ç§‘æ‰‹è¡“å¼èªéŸ³æå–ç‰ˆ)
async function loadFlashcards() {
    const vContainer = document.getElementById('vocab-flashcard-container');
    const pContainer = document.getElementById('phrase-flashcard-container');
    
    const modeEl = document.getElementById('card-mode');
    const limitEl = document.getElementById('card-limit');
    const mode = modeEl ? modeEl.value : 'jp';
    const limit = limitEl ? parseInt(limitEl.value) : 10;
    
    try {
        const allPacks = await db.fuelPacks.toArray();
        let vocabItems = [];
        let phraseItems = [];

        // ç‰©ç†éæ¿¾ï¼šç¢ºä¿è³‡æ–™å®Œæ•´æ€§ [cite: 2026-01-21]
        allPacks.forEach(pack => {
            if (pack.vocab) {
                pack.vocab.forEach(v => {
                    if (v.w && v.m && v.w.trim() !== "") {
                        vocabItems.push({ jp: v.w, ch: v.m, type: 'V' });
                    }
                });
            }
            if (pack.phrases) {
                pack.phrases.forEach(p => {
                    if (p.jp && p.ch && p.jp.trim() !== "") {
                        phraseItems.push({ jp: p.jp, ch: p.ch, type: 'P' });
                    }
                });
            }
        });

        const shuffle = (list) => list.sort(() => Math.random() - 0.5);
        const selectedVocabs = shuffle(vocabItems).slice(0, limit === 0 ? undefined : Math.ceil(limit / 2));
        const selectedPhrases = shuffle(phraseItems).slice(0, limit === 0 ? undefined : Math.floor(limit / 2));
        
        const totalToShow = selectedVocabs.length + selectedPhrases.length;
        let flippedCount = 0;

        if (typeof updateProgress === 'function') updateProgress(0, totalToShow);

        const render = (items, container) => {
            if (!container) return;
            container.innerHTML = '';
            
            items.forEach(item => {
                const card = document.createElement('div');
                card.className = 'flip-card';
                
                // 1. åŸ·è¡Œå¤–ç§‘æ‰‹è¡“å¼ Ruby é‡é‘„
                const rawJP = autoRubyFilter(item.jp || "");
                const rawCH = item.ch || "";

                // 2. ğŸ”¥ ã€æ ¸å¿ƒä¿®æ­£ã€‘å¤–ç§‘æ‰‹è¡“å¼èªéŸ³æå–å¼•æ“
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = rawJP;

                // ç‰©ç†é‡çµ„ï¼šå°‡æ‰€æœ‰çš„ <ruby> æ¨™ç±¤æ›¿æ›ç‚ºå…¶å…§éƒ¨çš„ <rt> è®€éŸ³
                // æ­¤èˆ‰èƒ½å®Œæ•´ä¿ç•™å¤¾åœ¨æ¨™ç±¤ä¸­é–“çš„å¹³å‡å (é€å‡å) [cite: 2026-01-21]
                tempDiv.querySelectorAll('ruby').forEach(ruby => {
                    const rt = ruby.querySelector('rt');
                    if (rt) {
                        // ä¾‹å¦‚ï¼š<ruby>æ‰•<rt>ã¯ã‚‰</rt></ruby> æœƒè¢«æ›æˆ "ã¯ã‚‰"
                        ruby.parentNode.replaceChild(document.createTextNode(rt.innerText), ruby);
                    }
                });
                
                // æ­¤æ™‚ innerText å·²é‚„åŸç‚ºç´”å¹³å‡åå­—ä¸²
                const speakTarget = tempDiv.innerText.replace(/\s+/g, '');

                card.innerHTML = `
                    <div class="flip-card-inner" style="height: 100%;">
                        <div class="flip-card-front">
                            <div style="font-size: 1.25rem; margin-bottom: 15px; width: 100%; word-break: break-all;">
                                ${mode === 'jp' ? rawJP : rawCH}
                            </div>
                            <button type="button" class="card-audio-btn" 
                                    onclick="event.stopPropagation(); speakRawText('${speakTarget}')"
                                    style="background:rgba(0,0,0,0.05); border:none; border-radius:50%; width:35px; height:35px; cursor:pointer;">
                                ğŸ”Š
                            </button>
                        </div>
                        <div class="flip-card-back" style="background:var(--nhk-green); color:white;">
                            <div style="font-size: 1.1rem; width: 100%; word-break: break-all;">
                                ${mode === 'jp' ? rawCH : rawJP}
                            </div>
                        </div>
                    </div>
                `;

                card.onclick = function() {
                    const inner = this.querySelector('.flip-card-inner');
                    if (inner && !inner.classList.contains('flipped')) {
                        inner.classList.add('flipped');
                        flippedCount++;
                        if (typeof updateProgress === 'function') updateProgress(flippedCount, totalToShow);
                        if (typeof trackQuestProgress === 'function') trackQuestProgress(item); 
                    } else if (inner) {
                        inner.classList.remove('flipped');
                    }
                };
                container.appendChild(card);
            });
        };

        render(selectedVocabs, vContainer);
        render(selectedPhrases, pContainer);

    } catch (err) { 
        console.error("âŒ è¤‡ç¿’ä¸­å¿ƒç‰©ç†åŠ è¼‰å¤±æ•—:", err); 
    }
}


/**
 * ğŸ§ª ç‰©ç†éæ¿¾å™¨ï¼šå¤–ç§‘æ‰‹è¡“å¼ Ruby é‡çµ„
 * ä¿®æ­£ï¼šè§£æ±ºã€Œå‡åæ¨™å‡åã€å•é¡Œï¼Œç¢ºä¿é€å‡å (Okurigana) ä¸Šæ–¹ç‰©ç†ç©ºç™½
 * ç¯„ä¾‹ï¼šæ‰•ã„æˆ»ã™ (ã¯ã‚‰ã„ã‚‚ã©ã™) -> <ruby>æ‰•<rt>ã¯ã‚‰</rt></ruby>ã„<ruby>æˆ»<rt>ã‚‚ã©</rt></ruby>ã™
 */
function autoRubyFilter(str) {
    if (!str) return "";
    
    const regex = /([^\sï¼ˆ\(]+)\s*[ï¼ˆ\(]([ã-ã‚“ã‚¡-ãƒ¶ãƒ¼]+)[ï¼‰\)]/g;
    
    return str.replace(regex, (match, base, reading) => {
        let result = "";
        let baseIdx = 0;
        let readIdx = 0;

        // éæ­·å–®å­—é€²è¡Œç‰©ç†æ‹†è§£èˆ‡éŒ¨é»åŒ¹é…
        while (baseIdx < base.length) {
            const char = base[baseIdx];
            
            // åˆ¤æ–·æ˜¯å¦ç‚ºæ¼¢å­— (å«ã€…)
            if (/[ä¸€-é¾ ã€…]/.test(char)) {
                let kanjiBlock = char;
                let nextHira = "";
                
                // å°‹æ‰¾ä¸‹ä¸€å€‹å‡åä½œç‚ºç‰©ç†éŒ¨é»
                let j = baseIdx + 1;
                while (j < base.length && !/[ä¸€-é¾ ã€…]/.test(base[j])) {
                    nextHira += base[j];
                    j++;
                }

                // åœ¨è®€éŸ³ä¸­å°‹æ‰¾éŒ¨é»ä½ç½®
                let targetReadIdx = reading.indexOf(nextHira, readIdx);
                
                if (nextHira && targetReadIdx !== -1) {
                    // æ¼¢å­—å€å¡Šèˆ‡è®€éŸ³å€å¡Šç‰©ç†å°é½Š
                    const kanjiReading = reading.substring(readIdx, targetReadIdx);
                    result += `<ruby>${kanjiBlock}<rt>${kanjiReading}</rt></ruby>`;
                    readIdx = targetReadIdx;
                } else {
                    // å¦‚æœå¾Œæ–¹ç„¡å‡å(çµå°¾æ˜¯æ¼¢å­—)ï¼Œå‰‡æŠ“å–å‰©ä¸‹æ‰€æœ‰è®€éŸ³
                    const kanjiReading = reading.substring(readIdx);
                    result += `<ruby>${base.substring(baseIdx)}<rt>${kanjiReading}</rt></ruby>`;
                    break;
                }
                baseIdx = j - nextHira.length; // å›æ­¸æ¼¢å­—å¾Œçš„ç´¢å¼•
            } else {
                // ç‰©ç†è·³è½‰ï¼šå¦‚æœæ˜¯å‡åï¼Œç›´æ¥è¼¸å‡ºä¸å¸¶æ¨™ç±¤
                result += char;
                readIdx++;
            }
            baseIdx++;
        }
        return result;
    });
}

// åˆ·æ–°ä»»å‹™ (æ¶ˆè€— 300 é‡‘å¹£)
function refreshDailyQuest() {
    if (player.coin < 300) return alert("é‡‘å¹£ä¸è¶³ï¼Œç„¡æ³•è¯çµ¡å…¬æœƒï¼");
    
    player.coin -= 300;
    generateDailyQuest(); // é‡æ–°éš¨æ©Ÿç”Ÿæˆ
    updatePlayerUI();
    saveGameToCloud();
    alert("ğŸ”„ å·²æ¶ˆè€— 300 ğŸ’° åˆ·æ–°ä½ˆå‘Šæ¬„ï¼");
}

// D. é€²åº¦æ¢æ›´æ–°å‡½æ•¸
function updateProgress(current, total) {
    const percent = total === 0 ? 0 : Math.round((current / total) * 100);
    document.getElementById('review-progress-bar').style.width = percent + '%';
    document.getElementById('review-status-text').innerText = `å·²è¤‡ç¿’ï¼š${current} / ${total} (${percent}%)`;
    
    if (percent === 100 && total > 0) {
        document.getElementById('review-status-text').innerHTML = `ğŸ‰ æ­å–œå®Œæˆæœ¬æ¬¡è¤‡ç¿’ç›®æ¨™ï¼`;
    }
}

/**
 * ğŸš€ å…¨ç³»çµ±å”¯ä¸€ç‰©ç†å•Ÿå‹•éˆï¼šæ•´åˆè³‡æ–™åº«ã€ç‹åœ‹ç¶“æ¿Ÿã€å±¬æ€§çŸ©é™£èˆ‡é›²ç«¯åŒæ­¥
 * ä¿®æ­£ï¼š
 * 1. çµæ§‹å…ˆè¡Œï¼šåœ¨åŸ·è¡Œ loadPlayerFromDB å‰é åŸ‹å±¬æ€§èˆ‡è…°å¸¶çµæ§‹ï¼Œé˜²æ­¢æ¸²æŸ“ç©ºå€¼ã€‚ [cite: 2026-02-06]
 * 2. ç¶“æ¿Ÿé»ç«ï¼šæ•´åˆ initKingdomEconomy()ï¼Œç¢ºä¿è‚¡å¸‚èˆ‡è¨­æ–½æ•¸æ“šç‰©ç†å°é½Šã€‚ [cite: 2026-01-21]
 * 3. è¦–è¦ºä¸€è‡´ï¼šé–å®šå•Ÿå‹•é †åºï¼Œç¢ºä¿ç­‰ç´šã€é‡‘å¹£èˆ‡ç¨±è™Ÿåœ¨ç¬¬ä¸€å¹€å³æ­£ç¢ºé¡¯ç¤ºã€‚ [cite: 2026-01-19]
 */
window.onload = async function() {
    console.log("%cğŸ›¡ï¸ ç³»çµ±ç‰©ç†æª¢æŸ¥é–‹å§‹...", "color: #e67e22; font-weight: bold;");

    try {
        // 0. ğŸ”¥ ã€ç‰©ç†åŠ é–ã€‘ç¢ºä¿ Dexie è³‡æ–™åº«é€£çµå·²é–‹å•Ÿ
        if (!db.isOpen()) {
            await db.open();
        }

        // 1. ğŸ§± ã€çµæ§‹åˆå§‹åŒ–ã€‘é é˜²æ€§é åŸ‹æ•¸æ“šçµæ§‹ï¼Œé˜²æ­¢å› è¼‰å…¥å¤±æ•—å°è‡´çš„ undefined å´©æ½° [cite: 2026-02-06]
        player.attributes = player.attributes || { str: 0, sta: 0, agi: 0, int: 0, block: 0, eva: 0, p_eva: 0 };
        player.tacticalSlots = player.tacticalSlots || ['hp_pot', 'antidote', 'stimulant'];
        player.equips = player.equips || {};

        // 2. ğŸ”¥ ã€åŸºç¤åº«æ³¨å…¥ã€‘ç¢ºä¿æœ¬åœ°é­”ç‰©/æ–‡ç« è³‡æ–™åº«å…·å‚™åˆå§‹ç‡ƒæ–™
        if (typeof initDefaultLibrary === 'function') {
            await initDefaultLibrary();
        }

        // 3. ğŸ”¥ ã€è³‡æ–™æµæ¢å¾©ã€‘å¾ IndexedDB æ¢å¾©å‹‡è€…è³‡ç”¢ (å«å±¬æ€§ã€è£å‚™ã€å»ºè¨­)
        let dbSuccess = false;
        if (typeof loadPlayerFromDB === 'function') {
            dbSuccess = await loadPlayerFromDB();
        }

        // 4. ğŸšš ã€æ•¸æ“šé·ç§»ã€‘è‹¥ IndexedDB ç‚ºç©ºï¼Œç‰©ç†æ¬ç§»èˆŠç‰ˆ LocalStorage æ•¸æ“š
        if (!dbSuccess) {
            const legacySaved = localStorage.getItem('tabi_rpg_backup');
            if (legacySaved) {
                try {
                    const legacyData = JSON.parse(legacySaved);
                    // æ·±åº¦åˆä½µèˆŠæ•¸æ“š
                    player = { ...player, ...legacyData };
                    if (typeof savePlayerToDB === 'function') await savePlayerToDB();
                    console.log("ğŸšš èˆŠå­˜æª”ç‰©ç†é·ç§»å®Œæˆï¼šLV." + (player.lv || 1));
                } catch (e) {
                    console.error("âŒ èˆŠå­˜æª”é·ç§»ç•°å¸¸:", e);
                }
            }
        }

        // 5. ğŸ›¡ï¸ ã€çµæ§‹çµ‚æ¥µåŠ å›ºã€‘ç¢ºä¿æ‰€æœ‰å…¨åŸŸç‰©ä»¶å…·å‚™ç‰©ç†åˆå€¼ï¼Œé˜²æ­¢æ¸²æŸ“éˆä¸­æ–· [cite: 2026-02-06]
        player.medals = Array.isArray(player.medals) ? player.medals : [];
        player.collection = Array.isArray(player.collection) ? player.collection : [];
        player.inventory = Array.isArray(player.inventory) ? player.inventory : [];
        player.logs = Array.isArray(player.logs) ? player.logs : [];
        player.streak = typeof player.streak === 'number' ? player.streak : 0;
        player.kingStreak = typeof player.kingStreak === 'number' ? player.kingStreak : 0;
        player.mapProgress = player.mapProgress || { N5: 0, N4: 0, N3: 0, N2: 0, N1: 0 };
        // ç¢ºä¿è£å‚™æ§½ä½ä¸ç‚ºç©º (é˜²æ­¢ F5 è£¸é«”å•é¡Œ) [cite: 2026-02-05]
        const baseSlots = ['weapon', 'head', 'body', 'offhand', 'necklace', 'ring1', 'ring2', 'gloves', 'legs', 'boots'];
        baseSlots.forEach(slot => { if (!player.equips[slot]) player.equips[slot] = null; });

        // 6. ğŸ”¥ ã€æ ¸å¿ƒé»ç«ï¼šç‹åœ‹ç¶“æ¿Ÿä¸­æ¨ã€‘
        // ç‰©ç†å°é½Šï¼šæ¢å¾©è‚¡å¸‚ K ç·šã€æŒå€‰ã€è¨­æ–½ Lv èˆ‡åœ‹åº«å„²å‚™ [cite: 2026-01-21]
        if (typeof initKingdomEconomy === 'function') {
            await initKingdomEconomy();
        } else if (typeof ensureKingdomSystem === 'function') {
            await ensureKingdomSystem();
        }

        // 7. ğŸ“œ ã€æ¨¡çµ„åˆå§‹åŒ–ã€‘æ¸²æŸ“æ–‡ç« æ­·å²æ¸…å–®èˆ‡æ—¥èªŒ
        if (typeof renderHistoryList === 'function') {
            await renderHistoryList(); 
        }

        // 8. ğŸ¬ ã€è¦–è¦ºèˆ‡é‚è¼¯å»¶é²å•Ÿå‹•ã€‘é˜²æ­¢ DOM æœªåˆ°ä½å°è‡´ null å ±éŒ¯
        setTimeout(() => {
            // A. åˆå§‹åŒ–æ¯æ—¥ä»»å‹™
            if (typeof checkAndGenerateDailyQuest === 'function') {
                checkAndGenerateDailyQuest();
            }

            // B. å•Ÿå‹•èƒŒæ™¯è¦–è¦ºå‹•ç•«èˆ‡æ€ªç‰©èµ°å‹•å¾ªç’° [cite: 2026-01-19]
            if (typeof startHeroAnimation === 'function') startHeroAnimation();
            if (typeof startEnemyLoop === 'function') startEnemyLoop();
            
            // C. ğŸ”¥ ã€ç‰©ç†åŒæ­¥ã€‘æœ€å¾Œ UI ç‹€æ…‹æ ¡æº– (ç¨±è™Ÿã€è¡€é‡çƒã€é‡‘å¹£ã€å¤–è§€) [cite: 2026-02-06]
            if (typeof updatePlayerUI === 'function') updatePlayerUI();

            // D. ğŸ¯ å•Ÿå‹•è³é‡‘çµäººé›·é” (æƒæéš¨æ©Ÿæ‡¸è³)
            if (typeof BountyManager !== 'undefined' && typeof BountyManager.init === 'function') {
                BountyManager.init(); 
            }

            console.log("%câœ… ç³»çµ±å•Ÿå‹•å®Œç•¢ï¼Œå‹‡è€…æº–å‚™å°±ç·’ï¼", "color: #27ae60; font-weight: bold;");
        }, 150); // ç‰©ç†ç·©è¡æ™‚é–“ç¨å¾®æ‹‰é•·è‡³ 150msï¼Œç¢ºä¿ DOM è§£æå®Œå…¨

        // 9. â˜ï¸ ã€é›²ç«¯é€£å‹•ã€‘å˜—è©¦æ¢å¾© Google Session (æ–¼èƒŒæ™¯éœé»˜åŸ·è¡Œ)
        setTimeout(() => {
            if (typeof gapi !== 'undefined') {
                if (typeof waitForGapiAndCheckLogin === 'function') {
                    waitForGapiAndCheckLogin();
                } else if (typeof checkLoginStatus === 'function') {
                    checkLoginStatus();
                }
            } else {
                console.log("â„¹ï¸ Google API è…³æœ¬æœªåµæ¸¬åˆ°ï¼Œç¶­æŒæœ¬åœ°å†’éšªæ¨¡å¼ã€‚");
            }
        }, 1200);

    } catch (criticalError) {
        console.error("ğŸš¨ ç³»çµ±å•Ÿå‹•ç™¼ç”Ÿè‡´å‘½ç‰©ç†éŒ¯èª¤:", criticalError);
        if (typeof showNotification === 'function') {
            showNotification("âŒ å•Ÿå‹•å¤±æ•—ï¼Œè«‹æª¢æŸ¥è³‡æ–™åº«é€£çµæˆ–é‡æ•´ç¶²é ");
        }
    }
};

</script>
<script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
<script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
<div id="victory-screen" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:9999; color:white; flex-direction:column; align-items:center; justify-content:center; text-align:center;">
    <h1 style="font-size: 60px; color: #f1c40f; margin-bottom: 0; text-shadow: 0 0 20px gold;">VICTORY</h1>
    <p id="vic-boss-name" style="font-size: 20px; color: #eee;"></p>
    <div style="background:rgba(255,255,255,0.1); padding:20px; border-radius:15px; min-width:300px; margin:20px 0;">
        <div style="font-size:24px; margin:10px 0;">ç²å¾— EXP +<span id="vic-exp" style="color:gold;">0</span></div>
        <div style="font-size:24px; margin:10px 0;">ç²å¾— ğŸ’° +<span id="vic-coin" style="color:gold;">0</span></div>
        <div id="vic-loot" style="font-size:18px; color:#2ecc71; margin-top:10px;"></div>
    </div>
    <button class="btn-nhk" style="background:#f1c40f; color:#000; border:none; padding:10px 40px; border-radius:30px;" onclick="closeVictory()">ç¢ºèª (OK)</button>
</div>

</body>
</html>